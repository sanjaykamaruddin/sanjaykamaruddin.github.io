<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" title="" type="text/css" />
  <style type="text/css" media="all">
canvas {
  background-color: #fff;
  outline: 5px solid #fff;
  -webkit-box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 1);
  -moz-box-shadow:    0px 0px 5px 0px rgba(0, 0, 0, 1);
  box-shadow:         0px 0px 5px 0px rgba(0, 0, 0, 1);
}
.row {
  margin-bottom: 30px;
}

body {
  background-color: #f7f5eb;
}
@media (max-width: 767px) {
  [class*="span"] {
    margin-bottom: 30px;
  }
  .row {
    margin-bottom: 0;
  }
}
  </style>
  <title>Pie</title>
</head>
<body>
<div class="navbar navbar-inverse">
  <div class="navbar-inner">
    <a class="brand" href="/">Client-Side PIE Prototype</a>
  </div>
</div>
<div class="container">
  <div class="row">
    <canvas
      data-background-image="http://aka.media.jibjab.com/assets/27/48/73/81/06S6frFSdGRPeuheIiZrK4qQ.png"
      data-mask-background="http://aka.media.jibjab.com/assets/27/48/73/81/04nGAEwsbeRL2cCVQAuySIBQ.png"
      data-head-config='[{"x": 226, "y": 189, "rotation": 5.711, "scale": 0.264}]'
      width="460"
      height="345"
      class="span4">
    </canvas>

    <canvas
      data-background-image="http://aka.media.jibjab.com/assets/18/32/33/54/08s955.png"
      data-mask-background="http://aka.media.jibjab.com/assets/18/32/33/54/09dcw4.png"
      data-head-config='[{"x": 236, "y": 116, "rotation": 0.0, "scale": 0.1755}, {"x": 314, "y": 123, "rotation": 0.0, "scale": 0.1755}, {"x": 149, "y": 123, "rotation": 0.0, "scale": 0.1742}, {"x": 64, "y": 122, "rotation": -10.0, "scale": 0.1742}, {"x": 399, "y": 125, "rotation": 9.58, "scale": 0.1776}]'
      width="460"
      height="345"
      class="span4">
    </canvas>

    <canvas
      data-background-image="http://aka.media.jibjab.com/assets/27/39/40/01/50SpJAgHroTy28NIeK6SMDmw.png"
      data-mask-background="http://aka.media.jibjab.com/assets/27/39/40/00/90s0ltqFgOSLe9joNImx6cdQ.png"
      data-head-config='[{"x": 229, "y": 199, "rotation": 0.0, "scale": 0.189}, {"x": 325, "y": 199, "rotation": 0.0, "scale": 0.193}, {"x": 416, "y": 201, "rotation": 0.0, "scale": 0.196}, {"x": 137, "y": 200, "rotation": 0.0, "scale": 0.192}, {"x": 45, "y": 199, "rotation": 0.0, "scale": 0.199}]'
      width="460"
      height="345"
      class="span4">
    </canvas>

  </div>

  <div class="row">
    <canvas
      data-background-image="http://aka.media.jibjab.com/assets/22/68/41/64/3651l9.png"
      data-mask-background="http://aka.media.jibjab.com/assets/22/68/41/64/37au6z.png"
      data-head-config='[{"x": 184, "y": 180, "rotation": -7.125, "scale": 0.273}, {"x": 306, "y": 194, "rotation": 11.459, "scale": 0.264}]'
      width="460"
      height="345"
      class="span4">
    </canvas>

    <canvas
      data-background-image="http://aka.media.jibjab.com/assets/27/15/58/92/88MnvT4vtuQqyxs9HwvAsz7A.png"
      data-mask-background="http://aka.media.jibjab.com/assets/22/92/36/23/527ihi.png"
      data-head-config='[{"x": 216, "y": 173, "rotation": 4.22, "scale": 0.28}]'
      width="460"
      height="345"
      class="span4">
    </canvas>

    <canvas
      data-background-image="http://aka.media.jibjab.com/assets/18/32/34/31/582ro1.png"
      data-mask-background="http://aka.media.jibjab.com/assets/18/32/34/31/59kq7o.png"
      data-head-config='[{"x": 220, "y": 149, "rotation": -4.0, "scale": 0.26}, {"x": 88, "y": 130, "rotation": 9.951, "scale": 0.252}, {"x": 326, "y": 145, "rotation": 4.97, "scale": 0.246}]'
      width="460"
      height="345"
      class="span4">
    </canvas>

  </div>
  <div class="row">
    <div class="span12">
      <a class="btn btn-large btn-block btn-primary" id="reload-btn">Reload Page</a>
    </div>
  </div>
</div>
  <script type="text/javascript" charset="utf-8" src="http://code.createjs.com/createjs-2013.12.12.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="http://code.createjs.com/preloadjs-0.4.1.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
  <script type="text/javascript" charset="utf-8">
  $('#reload-btn').click(function () {
    document.location.reload(true);
  });
  Array.prototype.shuffle = function () {
    var currentIndex = this.length
      , temporaryValue
      , randomIndex
      ;

    // While there remain elements to shuffle...
    while (0 !== currentIndex) {

      // Pick a remaining element...
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex -= 1;

      // And swap it with the current element.
      temporaryValue = this[currentIndex];
      this[currentIndex] = this[randomIndex];
      this[randomIndex] = temporaryValue;
    }

    return this;
  }

  $(function () {
    var Pie = function (elem) {
      this.stage    = new createjs.Stage(elem);
      this.$canvas  = $(elem);
      this.queue    = new createjs.LoadQueue(false);
      this.init();
    };

    Pie.prototype.init = function () {
      this.queue.loadManifest([{
        id: 'background',
        src: this.$canvas.data('backgroundImage')
      }, {
        id: 'maskBackground',
        src: this.$canvas.data('maskBackground')
      }, {
        id: 'head1',
        src: 'http://aka.media.jibjab.com/sendables/heads/med/27/50/90/73/69x5W5Ti86SzWuhxRRF7Fy-w.png'
      }, {
        id: 'head2',
        src: 'http://aka.media.jibjab.com/sendables/heads/med/27/50/90/82/10gDu_pqaaTpGz8HKbmOGQAg.png'
      }, {
        id: 'head3',
        src: 'http://aka.media.jibjab.com/sendables/heads/med/27/50/90/96/74mIlNVutFRxm3ixVxmA-0xw.png'
      }, {
        id: 'head4',
        src: 'http://aka.media.jibjab.com/sendables/heads/med/27/50/90/78/98SQYMvCSlRXSMfUDeVPp3Jg.png'
      }, {
        id: 'head5',
        src: 'http://aka.media.jibjab.com/sendables/heads/med/27/50/90/93/00tDy2cfcCS8u-S8lGgVMa1g.png'
      }, {
        id: 'head6',
        src: 'http://aka.media.jibjab.com/sendables/heads/med/27/50/95/55/38ysvH1uA7SvuYZazAAjlSpg.png'
      }, {
        id: 'head7',
        src: 'http://aka.media.jibjab.com/sendables/heads/med/27/50/95/63/422ccC4FtzStGB0rfz0TsK3A.png'
      }]);
      this.queue.addEventListener('complete', $.proxy(this.composite, this));
    };

    Pie.prototype.composite = function () {
      var backgroundImage = new createjs.Bitmap(this.queue.getResult('background')),
          heads           = [this.queue.getResult('head1'), this.queue.getResult('head2'), this.queue.getResult('head3'), this.queue.getResult('head4'), this.queue.getResult('head5'), this.queue.getResult('head6'), this.queue.getResult('head7')],
          headConfig      = this.$canvas.data('headConfig'),
          scaleFactor     = (400/134);

      heads.shuffle();

      this.stage.addChild(new createjs.Bitmap(this.queue.getResult('maskBackground')));

      for (var i = 0; i < headConfig.length; i++) {
        var head = new createjs.Bitmap(heads.pop());
        head.set({
          regX: 68,
          regY: 149,
          x: headConfig[i].x,
          y: headConfig[i].y,
          rotation: headConfig[i].rotation,
          scaleX: headConfig[i].scale * 3,
          scaleY: headConfig[i].scale * 3
        });
        this.stage.addChild(head);
      }
      this.stage.addChild(backgroundImage);
      this.stage.update();
    };

    $('canvas').each(function () {
      new Pie(this);
    })
  });
  </script>
</body>
</html>
