<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link href="style.css" rel="stylesheet" type="text/css" /><title>SQL Antipatterns: Avoiding the Pitfalls of Database Programming</title></head><body><div class="calibre" id="calibre_link-209">
<div id="calibre_link-321" class="calibre1"><h1 class="calibre_" id="calibre_link-322">SQL Antipatterns</h1><h3 class="calibre2"> Avoiding the Pitfalls of Database Programming </h3><div class="calibre_1"><div class="calibre1"><div class="calibre1"><div class="calibre1">Bill Karwin</div></div></div></div><div class="calibre_2"><small class="calibre3">Version: P1.0 (May 2010)</small></div><hr class="calibre_3" /><div class="calibre4"><small class="calibre3"><small class="calibre5"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf. This book is licensed to the individual who purchased it. We don't copy-protect it because that would limit your ability to use it for your own purposes. Please don't break this trust--don't allow others to use your copy of the book. Thanks. <br class="calibre1" />-- Dave &amp; Andy.</em></small></small><hr class="calibre7" /></div></div><pagebreak><div id="calibre_link-323" class="calibre1"><a id="calibre_link-324"><h3 class="calibre2">Table of Contents</h3><ul class="calibre8"><li class="calibre9"><a href="#calibre_link-210">Introduction</a></li><li class="calibre9"><a href="#calibre_link-211"><strong class="calibre10">Logical Database Design Antipatterns</strong></a><ul class="calibre11"><li class="calibre9"><a href="#calibre_link-140">Jaywalking</a></li><li class="calibre9"><a href="#calibre_link-212">Naive Trees</a></li><li class="calibre9"><a href="#calibre_link-213">ID Required</a></li><li class="calibre9"><a href="#calibre_link-130">Keyless Entry</a></li><li class="calibre9"><a href="#calibre_link-102">Entity-Attribute-Value</a></li><li class="calibre9"><a href="#calibre_link-185">Polymorphic Associations</a></li><li class="calibre9"><a href="#calibre_link-139">Multicolumn Attributes</a></li><li class="calibre9"><a href="#calibre_link-214">Metadata Tribbles</a></li></ul></li><li class="calibre9"><a href="#calibre_link-215"><strong class="calibre10">Physical Database Design Antipatterns</strong></a><ul class="calibre11"><li class="calibre9"><a href="#calibre_link-216">Rounding Errors</a></li><li class="calibre9"><a href="#calibre_link-217">31 Flavors</a></li><li class="calibre9"><a href="#calibre_link-218">Phantom Files</a></li><li class="calibre9"><a href="#calibre_link-164">Index Shotgun</a></li></ul></li><li class="calibre9"><a href="#calibre_link-219"><strong class="calibre10">Query Antipatterns</strong></a><ul class="calibre11"><li class="calibre9"><a href="#calibre_link-220">Fear of the Unknown</a></li><li class="calibre9"><a href="#calibre_link-221">Ambiguous Groups</a></li><li class="calibre9"><a href="#calibre_link-222">Random Selection</a></li><li class="calibre9"><a href="#calibre_link-38">Poor Man's Search Engine</a></li><li class="calibre9"><a href="#calibre_link-223">Spaghetti Query</a></li><li class="calibre9"><a href="#calibre_link-184">Implicit Columns</a></li></ul></li><li class="calibre9"><a href="#calibre_link-224"><strong class="calibre10">Application Development Antipatterns</strong></a><ul class="calibre11"><li class="calibre9"><a href="#calibre_link-225">Readable Passwords</a></li><li class="calibre9"><a href="#calibre_link-226">SQL Injection</a></li><li class="calibre9"><a href="#calibre_link-186">Pseudokey Neat-Freak</a></li><li class="calibre9"><a href="#calibre_link-227">See No Evil</a></li><li class="calibre9"><a href="#calibre_link-228">Diplomatic Immunity</a></li><li class="calibre9"><a href="#calibre_link-229">Magic Beans</a></li></ul></li><li class="calibre9"><a href="#calibre_link-230"><strong class="calibre10">Appendixes</strong></a><ul class="calibre11"><li class="calibre9"><a href="#calibre_link-167">Rules of Normalization</a></li><li class="calibre9"><a href="#calibre_link-231">Bibliography</a></li></ul></li></ul></a></div><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><a id="calibre_link-325">
<pagebreak><div class="calibre1" id="calibre_link-326"></div>
</pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-289">
<pagebreak>
<a id="calibre_link-327">
<pagebreak>
<h1 id="calibre_link-210" class="calibre12"><small class="calibre13">Chapter 1</small><br class="calibre14" />Introduction</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> An expert is a person who has made all the mistakes that can be made in a very narrow field. </em></p></div><div class="calibre1"><div class="calibre4"><span>Niels Bohr</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> I turned down my first SQL job. </p><p class="calibre_6"> Shortly after I finished my college degree in computer and information science at the University of California, I was approached by a manager who worked at the university and knew me through campus activities. He had his own software startup company on the side that was developing a database management system portable between various <em class="calibre6">UNIX</em> platforms using shell scripts and related tools such as <code class="calibre15">awk</code> (at this time, modern dynamic languages like Ruby, Python, PHP, and even Perl weren't popular yet). The manager approached me because he needed a programmer to write the code to recognize and execute a limited version of the SQL language. </p><p class="calibre_6"> He said, "I don't need to support the full language---that would be too much work. I need only one SQL statement: <code class="calibre15">SELECT</code>." </p><p class="calibre_6"> I hadn't been taught SQL in school. Databases weren't as ubiquitous as they are today, and open source brands like MySQL and PostgreSQL didn't exist yet. But I had developed complete applications in shell, and I knew something about parsers, having done projects in classes like compiler design and computational linguistics. So, I thought about taking the job. How hard could it be to parse a single statement of a specialized language like SQL? </p><p class="calibre_6"> I found a reference for SQL and noticed immediately that this was a different sort of language from those that support statements like <code class="calibre15">if</code> and <code class="calibre15">while</code>, variable assignments and expressions, and perhaps functions. To call <code class="calibre15">SELECT</code> only one statement in that language is like calling an engine only one part of an automobile. Both sentences are literally true, but they certainly belie the complexity and depth of their subjects. To support execution of that single SQL statement, I realized I would have to develop all the code for a fully functional relational database management system and query engine. </p><p class="calibre_6"> I declined this opportunity to code an SQL parser and RDBMS engine in shell script. The manager underrepresented the scope of his project, perhaps because he didn't understand what an RDBMS does. </p><p class="calibre_6"> My early experience with SQL seems to be a common one for software developers, even those who have a college degree in computer science. Most people are self-taught in SQL, learning it out of self-defense when they find themselves working on a project that requires it, instead of studying it explicitly as they would most programming languages. Regardless of whether the person is a hobbyist or a professional programmer or an accomplished researcher with a PhD, SQL seems to be a software skill that programmers learn without training. </p><p class="calibre_6"> Once I learned something about SQL, I was surprised how different it is from procedural programming languages such as C, Pascal, and shell, or object-oriented languages like C++, Java, Ruby, or Python. SQL is a <span>declarative programming language</span> like LISP, Haskell, or XSLT. SQL uses <span>sets</span> as a fundamental data structure, while object-oriented languages use objects. Traditionally trained software developers are turned off by this so-called <span>impedance mismatch</span>, so many programmers are drawn to object-oriented libraries to avoid learning how to use SQL effectively. </p><p class="calibre_6"> Since 1992, I've worked with SQL a lot. I've used it when developing applications, I've provided technical support and developed training and documentation for the InterBase RDBMS product, and I've developed libraries for SQL programming in Perl and PHP. I've answered thousands of questions on Internet mailing lists and newsgroups. I see a lot of repeat business---frequently asked questions that show that software developers make the same mistakes over and over again. </p><div class="calibre1" id="calibre_link-328"></div>
</pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-13">
<pagebreak>
<a id="calibre_link-329">
<pagebreak>
<h2 class="calibre_7" id="calibre_link-330">Who This Book Is For</h2><p class="calibre_6"> I'm writing <em class="calibre6">SQL Antipatterns</em> for software developers who need to use SQL so I can help you use the language more effectively. It doesn't matter whether you're a beginner or a seasoned professional. I've talked to people of all levels of experience who would benefit from the subjects in this book. </p><p class="calibre_6"> You may have read a reference on SQL syntax. Now you know all the clauses of a <code class="calibre15">SELECT</code> statement, and you can get some work done. Gradually, you may increase your SQL skills by inspecting other applications and reading articles. But how can you tell good examples from bad examples? How can you be sure you're learning best practices, instead of yet another way to paint yourself into a corner? </p><p class="calibre_6"> You may find some topics in <em class="calibre6">SQL Antipatterns</em> that are well-known to you. You'll see new ways of looking at the problems, even if you're already aware of the solutions. It's good to confirm and reinforce your good practices by reviewing widespread programmer misconceptions. Other topics may be new to you. I hope you can improve your SQL programming habits by reading them. </p><p class="calibre_6"> If you are a trained database administrator, you may already know the best ways to avoid the SQL pitfalls described in this book. This book can help you by introducing you to the perspective of software developers. It's not uncommon for the relationship between developers and DBAs to be contentious, but mutual respect and teamwork can help us to work together more effectively. Use <em class="calibre6">SQL Antipatterns</em> to help explain good practices to the software developers you work with and the consequences of straying from that path. </p></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-67">
<pagebreak>
<a id="calibre_link-331">
<pagebreak>
<h2 class="calibre_7" id="calibre_link-332">What's in This Book</h2><p class="calibre_6"> What is an antipattern? An <span>antipattern</span> is a technique that is intended to solve a problem but that often leads to other problems. An antipattern is practiced widely in different ways, but with a thread of commonality. People may come up with an idea that fits an antipattern independently or with help from a colleague, a book, or an article. Many antipatterns of object-oriented software design and project management are documented at the Portland Pattern Repository,<a href="#calibre_link-68" id="calibre_link-1">[1]</a> as well as in the 1998 book <em class="calibre6">AntiPatterns</em><a href="#calibre_link-43">[A]</a> by William J. Brown et al. </p><p class="calibre_6"><em class="calibre6">SQL Antipatterns</em> describes the most frequently made missteps I've seen people naively make while using SQL as I've talked to them in technical support and training sessions, worked alongside them developing software, and answered their questions on Internet forums. Many of these blunders I've made myself; there's no better teacher than spending many hours late at night making up for one's own errors. </p><h3 class="calibre_8">Parts of This Book</h3><p class="calibre_6"> This book has four parts for the following categories of antipatterns: </p><dl class="calibre16"><p class="calibre_6">Logical Database Design Antipatterns</p><blockquote class="calibre_9"> Before you start coding, you should decide what information you need to keep in your database and the best way to organize and interconnect your data. This includes planning your database tables, columns, and relationships. <br class="calibre1" /></blockquote><p class="calibre_6">Physical Database Design Antipatterns</p><blockquote class="calibre_9"> After you know what data you need to store, you implement the data management as efficiently as you can using the features of your RDBMS technology. This includes defining tables and indexes and choosing data types. You use SQL's <span>data definition language</span>---statements such as <code class="calibre15">CREATE&nbsp;TABLE</code>. <br class="calibre1" /></blockquote><p class="calibre_6">Query Antipatterns</p><blockquote class="calibre_9"> You need to add data to your database and then retrieve data. SQL queries are made with <span>data manipulation language</span>---statements such as <code class="calibre15">SELECT</code>, <code class="calibre15">UPDATE</code>, and <code class="calibre15">DELETE</code>. <br class="calibre1" /></blockquote><p class="calibre_6">Application Development Antipatterns</p><blockquote class="calibre_9"> SQL is supposed to be used in the context of applications written in another language, such as C++, Java, PHP, Python, or Ruby. There are right ways and wrong ways to employ SQL in an application, and this part of the book describes some common blunders. <br class="calibre1" /></blockquote></dl><p class="calibre_6"> Many of the antipattern chapters have humorous or evocative titles, such as <span>Golden Hammer</span>, <span>Reinventing the Wheel</span>, or <span>Design by Committee</span>. It's traditional to give both positive design patterns and antipatterns names that serve as a metaphor or mnemonic. </p><p class="calibre_6"> The appendix provides practical descriptions of some relational database theory. Many of the antipatterns this book covers are the result of misunderstanding database theory. </p><h3 class="calibre_8">Anatomy of an Antipattern</h3><p class="calibre_6"> Each antipattern chapter contains the following subheadings: </p><dl class="calibre16"><p class="calibre_6">Objective</p><blockquote class="calibre_9"> This is the task that you may be trying to solve. Antipatterns are used with an intention to provide that solution but end up causing more problems than they solve. <br class="calibre1" /></blockquote><p class="calibre_6">The Antipattern</p><blockquote class="calibre_9"> This section describes the nature of the common solution and illustrates the unforeseen consequences that make it an anti-pattern. <br class="calibre1" /></blockquote><p class="calibre_6">How to Recognize the Antipattern</p><blockquote class="calibre_9"> There may be certain clues that help you identify when an antipattern is being used in your project. Certain types of barriers you encounter, or quotes you may hear yourself or others saying, can tip you off to the presence of an antipattern. <br class="calibre1" /></blockquote><p class="calibre_6">Legitimate Uses of the Antipattern</p><blockquote class="calibre_9"> Rules usually have exceptions. There may be circumstances in which an approach normally considered an antipattern is nevertheless appropriate, or at least the lesser of all evils. <br class="calibre1" /></blockquote><p class="calibre_6">Solution</p><blockquote class="calibre_9"> This section describes the preferred solutions, which solve the original objective without running into the problems caused by the antipattern. <br class="calibre1" /></blockquote></dl></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-113">
<pagebreak>
<a id="calibre_link-333">
<pagebreak>
<h2 class="calibre_7" id="calibre_link-334">What's Not in This Book</h2><p class="calibre_6"> I'm not going to give lessons on SQL syntax or terminology. There are plenty of books and Internet references for the basics. I assume you have already learned enough SQL syntax to use the language and get some work done. </p><p class="calibre_6"> Performance, scalability, and optimization are important for many people who develop database-driven applications, especially on the Web. There are books specifically about performance issues related to database programming. I recommend <em class="calibre6">SQL Performance Tuning</em><a href="#calibre_link-47">[SPT]</a> and <em class="calibre6">High Performance MySQL, Second Edition</em><a href="#calibre_link-114">[HPM]</a> . Some of the topics in <em class="calibre6">SQL Antipatterns</em> are relevant to performance, but it's not the main focus of the book. </p><p class="calibre_6"> I try to present issues that apply to all database brands and also solutions that should work with all brands. The SQL language is specified as an ANSI and ISO standard. All brands of databases support these standards, so I describe vendor-neutral use of SQL whenever possible, and I try to be clear when describing vendor extensions to SQL. </p><p class="calibre_6"> Data access frameworks and object-relational mapping libraries are helpful tools, but these aren't the focus of this book. I've written most code examples in PHP, in the plainest way I can. The examples are simple enough that they're equally relevant to most programming languages. </p><p class="calibre_6"> Database administration and operation tasks such as server sizing, installation and configuration, monitoring, backups, log analysis, and security are important and deserve a book of their own, but I'm targeting this book to developers using the SQL language more than database administrators. </p><p class="calibre_6"> This book is about SQL and relational databases, not alternative technology such as object-oriented databases, key/value stores, column-oriented databases, document-oriented databases, hierarchical databases, network databases, map/reduce frameworks, or semantic data stores. Comparing the strengths and weaknesses and appropriate uses of these alternative solutions for data management would be interesting but is a matter for other books. </p></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-188">
<pagebreak>
<a id="calibre_link-335">
<pagebreak>
<h2 class="calibre_7" id="calibre_link-336">Conventions</h2><p class="calibre_6"> The following sections describe some conventions I use in this book. </p><h3 class="calibre_8">Typography</h3><p class="calibre_6"> SQL keywords are formatted in all-capitals and in a monospaced font to make them stand out from the text, as in <code class="calibre15">SELECT</code>. </p><p class="calibre_6"> SQL tables, also in a monospaced font, are spelled with a capital for the initial letter of each word in the table name, as in <code class="calibre15">Accounts</code> or <code class="calibre15">BugsProducts</code>. SQL columns, also in a monospaced font, are spelled in lowercase, and words are separated by underscores, as in <code class="calibre15">account_name</code>. </p><p class="calibre_6"> Literal strings are formatted in italics, as in <code class="calibre15">bill@example.com</code>. </p><h3 class="calibre_8">Terminology</h3><p class="calibre_6"> SQL is correctly pronounced "ess-cue-ell," not "see-quell." Though I have no objection to the latter being used colloquially, I try to use the former, so in this book you will read phrases like "<em class="calibre6">an</em> SQL query," not "<em class="calibre6">a</em> SQL query." </p><p class="calibre_6"> In the context of database-related usage, the word <em class="calibre6">index</em> refers to an ordered collection of information. The preferred plural of this word is <em class="calibre6">indexes</em>. In other contexts, an index may mean an <em class="calibre6">indicator</em> and is typically pluralized as <em class="calibre6">indices</em>. Both are correct according to most dictionaries, and this causes some confusion among writers. In this book, I spell the plural as <em class="calibre6">indexes</em>. </p><p class="calibre_6"> In SQL, the terms <em class="calibre6">query</em> and <em class="calibre6">statement</em> are somewhat interchangeable, being any complete SQL command that you can execute. For the sake of clarity, I use <em class="calibre6">query</em> to refer to <code class="calibre15">SELECT</code> statements and <em class="calibre6">statement</em> for all others, including <code class="calibre15">INSERT</code>, <code class="calibre15">UPDATE</code>, and <code class="calibre15">DELETE</code> statements, as well as data definition statements. </p><h3 class="calibre_8">Entity-Relationship Diagrams</h3><p class="calibre_6"> The most common way to diagram relational databases is with <span>entity-relationship diagrams</span>. Tables are shown as boxes, and relationships are shown as lines connecting the boxes, with symbols at either end of the lines describing the cardinality of the relationship. For examples, see Figure <a href="#calibre_link-189"><em class="calibre6">Examples of entity-relationship diagrams</em></a>. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Introduction/erd-examples.jpg" src="images/000011.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-189" class="calibre10">Figure 1. Examples of entity-relationship diagrams</span></td></tr></table></div><br class="calibre1" /></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-272">
<pagebreak>
<a id="calibre_link-337">
<pagebreak>
<h2 class="calibre_7" id="calibre_link-338">Example Database</h2><p class="calibre_6"> I illustrate most of the topics in <em class="calibre6">SQL Antipatterns</em> using a database for a hypothetical bug-tracking application. The entity-relationship diagram for this database is shown in Figure <a href="#calibre_link-273"><em class="calibre6">Diagram for example bug database</em></a>. Notice the three connections between the <code class="calibre15">Bugs</code> table and the <code class="calibre15">Accounts</code> table, representing three separate foreign keys. </p><p class="calibre_6"> The following data definition language shows how I define the tables. In some cases, choices are made for the sake of examples later in the book, so they might not always be the choices one would make in a real-world application. I try to use only standard SQL so the example is applicable to any brand of database, but some MySQL data types also appear, such as <code class="calibre15">SERIAL</code> and <code class="calibre15">BIGINT</code>. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Introduction/bugs-database.jpg" src="images/000018.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-273" class="calibre10">Figure 2. Diagram for example bug database</span></td></tr></table></div><br class="calibre1" /><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Introduction/setup.sql">Introduction/setup.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Accounts&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;first_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;last_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(100),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;password_hash&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHAR(64),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;portrait_image&nbsp;&nbsp;&nbsp;&nbsp;BLOB,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;hourly_rate&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUMERIC(9,2)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugStatus&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20)&nbsp;PRIMARY&nbsp;KEY</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;date_reported&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DATE&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;summary&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(80),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;description&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(1000),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;resolution&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(1000),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;assigned_to&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;verified_by&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20)&nbsp;NOT&nbsp;NULL&nbsp;DEFAULT&nbsp;<em class="calibre6">'NEW'</em>,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;priority&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;hours&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUMERIC(9,2),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(reported_by)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(assigned_to)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(verified_by)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(status)&nbsp;REFERENCES&nbsp;BugStatus(status)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Comments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;author&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DATETIME&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(author)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Screenshots&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;image_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;screenshot_image&nbsp;&nbsp;BLOB,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;caption&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(100),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(bug_id,&nbsp;image_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Tags&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;tag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(bug_id,&nbsp;tag),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Products&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(50)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsProducts(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(bug_id,&nbsp;product_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> In some chapters, especially those in Logical Database Design Antipatterns, I show different database definitions, either to exhibit the antipattern or to show an alternative solution that avoids the antipattern. </p></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-0">
<pagebreak>
<a id="calibre_link-339">
<pagebreak>
<h2 class="calibre_7" id="calibre_link-340">Acknowledgments</h2><p class="calibre_6"> First and foremost, I owe my gratitude to my wife Jan. I could not have written this book without the inspiration, love, and support you give me, not to mention the occasional kick in the pants. </p><p class="calibre_6"> I also want to express thanks to my reviewers for giving me a lot of their time. Their suggestions improved the book greatly. Marcus Adams, Jeff Bean, Frederic Daoud, Darby Felton, Arjen Lentz, Andy Lester, Chris Levesque, Mike Naberezny, Liz Nealy, Daev Roehr, Marco Romanini, Maik Schmidt, Gale Straney, and Danny Thorpe. </p><p class="calibre_6"> Thanks to my editor Jacquelyn Carter and the publishers of Pragmatic Bookshelf, who believed in the mission of this book. <br class="calibre1" /></p><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-1" id="calibre_link-68">[1]</a>
<small class="calibre3"> Portland Pattern Repository: <a href="http://c2.com/cgi-bin/wiki?AntiPattern">http://c2.com/cgi-bin/wiki?AntiPattern</a>
</small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-341"></div>
</pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-53">
<pagebreak>
<a id="calibre_link-342">
<pagebreak>
<pagebreak>
<h1 class="calibre12" id="calibre_link-211"><small class="calibre13">Part 1</small><br class="calibre14" />Logical Database Design Antipatterns</h1><pagebreak><div class="calibre1" id="calibre_link-343"></div>
</pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-99">
<pagebreak>
<a id="calibre_link-344">
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-140" class="calibre12"><small class="calibre13">Chapter 2</small><br class="calibre14" />Jaywalking</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> A Netscape engineer who shan't be named once passed a pointer to JavaScript, stored it as a string, and later passed it back to C, killing 30. </em></p></div><div class="calibre1"><div class="calibre4"><span>Blake Ross</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> You're developing a feature in the bug-tracking application to designate a user as the primary contact for a product. Your original design allowed only one user to be the contact for each product. However, it was no surprise when you were requested to support assigning multiple users as contacts for a given product. </p><p class="calibre_6"> At the time, it seemed simple to change the database to store a list of user account identifiers separated by commas, instead of the single identifier it used before. </p><p class="calibre_6"> Soon your boss approaches you with a problem. "The engineering department has been adding associate staff to their projects. They tell me they can add five people only. If they try to add more, they get an error. What's going on?" </p><p class="calibre_6"> You nod, "Yeah, you can only list so many people on a project," as though this is completely ordinary. </p><p class="calibre_6"> Sensing that your boss needs a more precise explanation, "Well, five to ten---maybe a few more. It depends on how old each person's account is." Now your boss raises his eyebrows. You continue, "I store the account IDs for a project in a comma-separated list. But the list of IDs has to fit in a string with a maximum length. If the account IDs are short, I can fit more in the list. So, people who created the earlier accounts have an ID of 99 or less, and those are shorter." </p><p class="calibre_6"> Your boss frowns. You have a feeling you're going to be staying late. </p><p class="calibre_6"> Programmers commonly use comma-separated lists to avoid creating an intersection table for a many-to-many relationship. I call this antipattern <span>Jaywalking</span>, because jaywalking is also an act of avoiding an intersection. </p></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-165">
<pagebreak>
<a id="calibre_link-345">
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-346">Objective: Store Multivalue Attributes</h2><p class="calibre_6"> When a column in a table has a single value, the design is straightforward: you can choose an SQL data type to represent a single instance of that value, for example an integer, date, or string. But how do you store a collection of related values in a column? </p><p class="calibre_6"> In the example bug-tracking database, we might associate a product with a contact using an integer column in the <code class="calibre15">Products</code> table. Each account may have many products, and each product references one contact, so we have a <span>many-to-one</span> relationship between products and accounts. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/obj/create.sql">Jaywalking/obj/create.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Products&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_name&nbsp;VARCHAR(1000),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_id&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;.&nbsp;.&nbsp;.</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(account_id)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Products&nbsp;(product_id,&nbsp;product_name,&nbsp;account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">VALUES&nbsp;(DEFAULT,&nbsp;<em class="calibre6">'Visual&nbsp;TurboBuilder'</em>,&nbsp;12);</code></span><br class="calibre1" /></div><p class="calibre_6"> As your project matures, you realize that a product might have multiple contacts. In addition to the many-to-one relationship, we also need to support a one-to-many relationship from products to accounts. One row in the <code class="calibre15">Products</code> table must be able to have more than one contact. </p></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-249">
<pagebreak>
<a id="calibre_link-347">
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-348">Antipattern: Format Comma-Separated Lists</h2><p class="calibre_6"> To minimize changes to the database structure, you decide to redefine the <code class="calibre15">account_id</code> column as a <code class="calibre15">VARCHAR</code> so you can list multiple account IDs in that column, separated by commas. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/anti/create.sql">Jaywalking/anti/create.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Products&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_name&nbsp;VARCHAR(1000),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_id&nbsp;&nbsp;&nbsp;VARCHAR(100),&nbsp;<em class="calibre6">--&nbsp;comma-separated&nbsp;list</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;.&nbsp;.&nbsp;.</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Products&nbsp;(product_id,&nbsp;product_name,&nbsp;account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">VALUES&nbsp;(DEFAULT,&nbsp;<em class="calibre6">'Visual&nbsp;TurboBuilder'</em>,&nbsp;<em class="calibre6">'12,34'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> This seems like a win, because you've created no additional tables or columns; you've changed the data type of only one column. However, let's look at the performance problems and data integrity problems this table design suffers from. </p><h3 class="calibre_8">Querying Products for a Specific Account</h3><p class="calibre_6"> Queries are difficult if all the foreign keys are combined into a single field. You can no longer use equality; instead, you have to use a test against some kind of pattern. For example, MySQL lets you write something like&nbsp;the following to find all the products for account <code class="calibre15">12</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/anti/regexp.sql">Jaywalking/anti/regexp.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Products&nbsp;WHERE&nbsp;account_id&nbsp;REGEXP&nbsp;<em class="calibre6">'[[:&lt;:]]12[[:&gt;:]]'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> Pattern-matching expressions may return false matches and can't benefit from indexes. Since pattern-matching syntax is different in each database brand, your SQL code isn't vendor-neutral. </p><h3 class="calibre_8">Querying Accounts for a Given Product</h3><p class="calibre_6"> Likewise, it's awkward and costly to join a comma-separated list to matching rows in the referenced table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/anti/regexp.sql">Jaywalking/anti/regexp.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Products&nbsp;AS&nbsp;p&nbsp;JOIN&nbsp;Accounts&nbsp;AS&nbsp;a</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;p.account_id&nbsp;REGEXP&nbsp;<em class="calibre6">'[[:&lt;:]]'</em>&nbsp;||&nbsp;a.account_id&nbsp;||&nbsp;<em class="calibre6">'[[:&gt;:]]'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;p.product_id&nbsp;=&nbsp;123;</code></span><br class="calibre1" /></div><p class="calibre_6"> Joining two tables using an expression like this one spoils any chance of using indexes. The query must scan through both tables, generate a cross product, and evaluate the regular expression for every combination of rows. </p><h3 class="calibre_8">Making Aggregate Queries</h3><p class="calibre_6"> Aggregate queries use functions like <code class="calibre15">COUNT</code>, <code class="calibre15">SUM</code>, and <code class="calibre15">AVG</code>. However, these functions are designed to be used over groups of rows, not comma-separated lists. You have to resort to tricks like the following: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/anti/count.sql">Jaywalking/anti/count.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;product_id,&nbsp;LENGTH(account_id)&nbsp;-&nbsp;LENGTH(REPLACE(account_id,&nbsp;<em class="calibre6">','</em>,&nbsp;<em class="calibre6">''</em>))&nbsp;+&nbsp;1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;AS&nbsp;contacts_per_product</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Products;</code></span><br class="calibre1" /></div><p class="calibre_6"> Tricks like this can be clever but never clear. These kinds of solutions are time-consuming to develop and hard to debug. Some aggregate queries can't be accomplished with tricks at all. </p><h3 class="calibre_8">Updating Accounts for a Specific Product</h3><p class="calibre_6"> You can add a new ID to the end of the list with string concatenation, but this might not leave the list in sorted order. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/anti/update.sql">Jaywalking/anti/update.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Products</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SET&nbsp;account_id&nbsp;=&nbsp;account_id&nbsp;||&nbsp;<em class="calibre6">','</em>&nbsp;||&nbsp;56</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;product_id&nbsp;=&nbsp;123;</code></span><br class="calibre1" /></div><p class="calibre_6"> To remove an item from the list, you have to run two SQL queries: one to fetch the old list and a second to save the updated list. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/anti/remove.php">Jaywalking/anti/remove.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;"SELECT&nbsp;account_id&nbsp;FROM&nbsp;Products&nbsp;WHERE&nbsp;product_id&nbsp;=&nbsp;123");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$row&nbsp;=&nbsp;$stmt-&gt;fetch();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$contact_list&nbsp;=&nbsp;$row[<em class="calibre6">'account_id'</em>];</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">//&nbsp;change&nbsp;<span class="calibre10">list</span>&nbsp;in&nbsp;PHP&nbsp;code</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$value_to_remove&nbsp;=&nbsp;"34";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$contact_list&nbsp;=&nbsp;split(",",&nbsp;$contact_list);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$key_to_remove&nbsp;=&nbsp;array_search($value_to_remove,&nbsp;$contact_list);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">unset</span>($contact_list[$key_to_remove]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$contact_list&nbsp;=&nbsp;join(",",&nbsp;$contact_list);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;"UPDATE&nbsp;Products&nbsp;SET&nbsp;account_id&nbsp;=&nbsp;?</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;WHERE&nbsp;product_id&nbsp;=&nbsp;123");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt-&gt;execute(<span class="calibre10">array</span>($contact_list));</code></span><br class="calibre1" /></div><p class="calibre_6"> That's quite a lot of code just to remove an entry from a list. </p><h3 class="calibre_8">Validating Product IDs</h3><p class="calibre_6"> What prevents a user from entering invalid entries like <code class="calibre15">banana</code>? </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/anti/banana.sql">Jaywalking/anti/banana.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Products&nbsp;(product_id,&nbsp;product_name,&nbsp;account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">VALUES&nbsp;(DEFAULT,&nbsp;<em class="calibre6">'Visual&nbsp;TurboBuilder'</em>,&nbsp;<em class="calibre6">'12,34,banana'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> Users will find a way to enter any and all variations, and your database will turn to mush. There won't necessarily be database errors, but the data will be nonsense. </p><h3 class="calibre_8">Choosing a Separator Character</h3><p class="calibre_6"> If you store a list of string values instead of integers, some list entries may contain your separator character. Using a comma as the separator between entries may become ambiguous. You can choose a different character as the separator, but can you guarantee that this new separator will never appear in an entry? </p><h3 class="calibre_8">List Length Limitations</h3><p class="calibre_6"> How many list entries can you store in a <code class="calibre15">VARCHAR(30)</code> column? It depends on the length of each entry. If each entry is two characters long, then you can store ten (including the commas). But if each entry is six characters, then you can store only four entries: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/anti/length.sql">Jaywalking/anti/length.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Products&nbsp;SET&nbsp;account_id&nbsp;=&nbsp;<em class="calibre6">'10,14,18,22,26,30,34,38,42,46'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;product_id&nbsp;=&nbsp;123;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Products&nbsp;SET&nbsp;account_id&nbsp;=&nbsp;<em class="calibre6">'101418,222630,343842,467790'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;product_id&nbsp;=&nbsp;123;</code></span><br class="calibre1" /></div><p class="calibre_6"> How can you know that <code class="calibre15">VARCHAR(30)</code> supports the longest list you will need in the future? How long is long enough? Try explaining the reason for this length limit to your boss or to your customers. </p></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-308">
<pagebreak>
<a id="calibre_link-349">
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-350">How to Recognize the Antipattern</h2><p class="calibre_6"> If you hear phrases like the following spoken by your project team, treat it as a clue that the Jaywalking antipattern is being employed: </p><ul class="calibre_14"><li class="calibre_15"> "What is the greatest number of entries this list must support?" <br class="calibre_16" /> This question comes up when you're trying to choose the maximum length of the <code class="calibre15">VARCHAR</code> column. </li><li class="calibre_15"> "Do you know how to match a word boundary in SQL?" <br class="calibre_16" /> If you use regular expressions to pick out parts of a string, this could be a clue that you should store those parts separately. </li><li class="calibre_15"> "What character will never appear in any list entry?" <br class="calibre_16" /> You want to use an unambiguous separator character, but you should expect that any character might someday appear in a value in the list. </li></ul></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-150">
<pagebreak>
<a id="calibre_link-351">
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-352">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> You might improve performance for some kinds of queries by applying <span>denormalization</span> to your database organization. Storing lists as a comma-separated string is an example of denormalization. </p><p class="calibre_6"> Your application may need the data in a comma-separated format and have no need to access individual items in the list. Likewise, if your application receives a comma-separated format from another source and you simply need to store the full list in a database and retrieve it later in exactly the same format, there's no need to separate the values. </p><p class="calibre_6"> Be conservative if you decide to employ denormalization. Start by using a normalized database organization, because it permits your application code to be more flexible, and it allows your database to help preserve data integrity. </p><div class="calibre1" id="calibre_link-353"></div>
</pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-232">
<pagebreak>
<a id="calibre_link-354">
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-355">Solution: Create an Intersection Table</h2><p class="calibre_6"> Instead of storing the <code class="calibre15">account_id</code> in the <code class="calibre15">Products</code> table, store it in a separate table, so each individual value of that attribute occupies a separate row. This new table <code class="calibre15">Contacts</code> implements a <span>many-to-many</span> relationship between <code class="calibre15">Products</code> and <code class="calibre15">Accounts</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/soln/create.sql">Jaywalking/soln/create.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Contacts&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_id&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(product_id,&nbsp;account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(account_id)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Contacts&nbsp;(product_id,&nbsp;accont_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">VALUES&nbsp;(123,&nbsp;12),&nbsp;(123,&nbsp;34),&nbsp;(345,&nbsp;23),&nbsp;(567,&nbsp;12),&nbsp;(567,&nbsp;34);</code></span><br class="calibre1" /></div><p class="calibre_6"> When the table has foreign keys referencing two tables, it's called an <span>intersection table</span>.<a href="#calibre_link-233" id="calibre_link-235">[2]</a> This implements a <span>many-to-many</span> relationship between the two referenced tables. That is, each product may be associated through the intersection table to multiple accounts, and likewise each account may be associated to multiple products. See the entity-relationship diagram in Figure <a href="#calibre_link-234"><em class="calibre6">Intersection table entity-relationship diagram</em></a>. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Jaywalking/intersection-table.jpg" src="images/000026.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-234" class="calibre10">Figure 1. Intersection table entity-relationship diagram</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> Let's see how using an intersection table resolves all the problems we saw in the "Antipattern" section. </p><h3 class="calibre_8">Querying Products by Account and the Other Way Around</h3><p class="calibre_6"> To query the attributes of all products for a given account, it's more straightforward to join the <code class="calibre15">Products</code> table with the <code class="calibre15">Contacts</code> table: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/soln/join.sql">Jaywalking/soln/join.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;p.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;&nbsp;Products&nbsp;AS&nbsp;p&nbsp;JOIN&nbsp;Contacts&nbsp;AS&nbsp;c&nbsp;ON&nbsp;(p.account_id&nbsp;=&nbsp;c.account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;c.account_id&nbsp;=&nbsp;34;</code></span><br class="calibre1" /></div><p class="calibre_6"> Some people resist queries that contain a join, thinking that they perform poorly. However, this query uses indexes much better than the solution shown earlier in the "Antipattern" section. </p><p class="calibre_6"> Querying account details is likewise easy to read and easy to optimize. It uses indexes for the join efficiently, instead of an esoteric use of regular expressions: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/soln/join.sql">Jaywalking/soln/join.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;a.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;&nbsp;&nbsp;Accounts&nbsp;AS&nbsp;a&nbsp;JOIN&nbsp;Contacts&nbsp;AS&nbsp;c&nbsp;ON&nbsp;(a.account_id&nbsp;=&nbsp;c.account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;c.product_id&nbsp;=&nbsp;123;</code></span><br class="calibre1" /></div><h3 class="calibre_8">Making Aggregate Queries</h3><p class="calibre_6"> The following example returns the number of accounts per product: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/soln/group.sql">Jaywalking/soln/group.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;product_id,&nbsp;COUNT(*)&nbsp;AS&nbsp;accounts_per_product</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Contacts</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;product_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> The number of products per account is just as simple: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/soln/group.sql">Jaywalking/soln/group.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;account_id,&nbsp;COUNT(*)&nbsp;AS&nbsp;products_per_account</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Contacts</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;account_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> Other more sophisticated reports are possible too, such as the product with the greatest number of accounts: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/soln/group.sql">Jaywalking/soln/group.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;c.product_id,&nbsp;c.accounts_per_product</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;product_id,&nbsp;COUNT(*)&nbsp;AS&nbsp;accounts_per_product</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FROM&nbsp;Contacts</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;GROUP&nbsp;BY&nbsp;product_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">)&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">HAVING&nbsp;c.accounts_per_product&nbsp;=&nbsp;MAX(c.accounts_per_product)</code></span><br class="calibre1" /></div><h3 class="calibre_8">Updating Contacts for a Specific Product</h3><p class="calibre_6"> You can add or remove entries in the list by inserting or deleting rows in the intersection table. Each product reference is stored in a separate row in the <code class="calibre15">Contacts</code> table, so you can add or remove them one at a time. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Jaywalking/soln/remove.sql">Jaywalking/soln/remove.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Contacts&nbsp;(product_id,&nbsp;account_id)&nbsp;VALUES&nbsp;(456,&nbsp;34);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;Contacts&nbsp;WHERE&nbsp;product_id&nbsp;=&nbsp;456&nbsp;AND&nbsp;account_id&nbsp;=&nbsp;34;</code></span><br class="calibre1" /></div><h3 class="calibre_8">Validating Product IDs</h3><p class="calibre_6"> You can use a foreign key to validate the entries against a set of legitimate values in another table. You declare that <code class="calibre15">Contacts.account_id</code> references <code class="calibre15">Accounts.account_id</code>, and therefore you rely on the database to enforce referential integrity. Now you can be sure that the intersection table contains only account IDs that exist. </p><p class="calibre_6"> You can also use SQL data types to restrict entries. For example, if the entries in the list should be valid <code class="calibre15">INTEGER</code> or <code class="calibre15">DATE</code> values and you declare the column using those data types, you can be sure all entries are legal values of that type (not nonsense entries like <code class="calibre15">banana</code>). </p><h3 class="calibre_8">Choosing a Separator Character</h3><p class="calibre_6"> You use no separator character, since you store each entry on a separate row. There's no ambiguity if the entries contain commas or other characters you might have used as a separator. </p><h3 class="calibre_8">List Length Limitations</h3><p class="calibre_6"> Since each entry is in a separate row in the intersection table, the list is limited only by the number of rows that can physically exist in one table. If it's appropriate to limit the number of entries, you should enforce the policy in your application using the count of entries rather than the collective length of the list. </p><h3 class="calibre_8">Other Advantages of the Intersection Table</h3><p class="calibre_6"> An index on <code class="calibre15">Contacts.account_id</code> makes performance better than matching a substring in a comma-separated list. Declaring a foreign key on a column implicitly creates an index on that column in many database brands (but check your documentation). </p><p class="calibre_6"> You can also create additional attributes for each entry by adding columns to the intersection table. For example, you could record the date a contact was added for a given product or an attribute noting who is the primary contact vs. the secondary contacts. You can't do this in a comma-separated list. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Store each value in its own column and row.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-235" id="calibre_link-233">[2]</a>
<small class="calibre3"> Some people use a join table, a many-to-many table, a mapping table, or other terms to describe this table. The name doesn't matter; the concept is the same. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-356"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-290">
<pagebreak>
<a id="calibre_link-357">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-212" class="calibre12"><small class="calibre13">Chapter 3</small><br class="calibre14" />Naive Trees</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> A tree is a tree---how many more do you need to look at? </em></p></div><div class="calibre1"><div class="calibre4"><span>Ronald Reagan</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> Suppose you work as a software developer for a famous website for science and technology news. </p><p class="calibre_6"> This is a modern website, so readers can contribute comments and even reply to each other, forming threads of discussion that branch and extend deeply. You choose a simple solution to track these reply chains: each comment references the comment to which it replies. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/intro/parent.sql">Trees/intro/parent.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Comments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;parent_id&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(parent_id)&nbsp;REFERENCES&nbsp;Comments(comment_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> It soon becomes clear, however, that it's hard to retrieve a long chain of replies in a single SQL query. You can get only the immediate children or perhaps join with the grandchildren, to a fixed depth. But the threads can have an <em class="calibre6">unlimited</em> depth. You would need to run many SQL queries to get all the comments in a given thread. </p><p class="calibre_6"> The other idea you have is to retrieve <em class="calibre6">all</em> the comments and assemble them into tree data structures in application memory, using traditional tree algorithms you learned in school. But the publishers of the website have told you that they publish dozens of articles every day, and each article can have hundreds of comments. Sorting through millions of comments every time someone views the website is impractical. </p><p class="calibre_6"> There must be a better way to store the threads of comments so you can retrieve a whole discussion thread simply and efficiently. </p></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-14">
<pagebreak>
<a id="calibre_link-358">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-359">Objective: Store and Query Hierarchies</h2><p class="calibre_6"> It's common for data to have recursive relationships. Data may be organized in a treelike or hierarchical way. In a tree data structure, each entry is called a <span>node</span>. A node may have a number of children and one parent. The top node, which has no parent, is called the <span>root</span>. The nodes at the bottom, which have no children, are called <span>leaves</span>. The nodes in the middle are simply <span>nonleaf nodes</span>. </p><p class="calibre_6"> In the previous hierarchical data, you may need to query individual items, related subsets of the collection, or the whole collection. Examples of tree-oriented data structures include the following: </p><dl class="calibre16"><p class="calibre_6"><em class="calibre6">Organization chart:</em></p><blockquote class="calibre_9"> The relationship of employees to managers is the textbook example of tree-structured data. It appears in countless books and articles on SQL. In an organizational chart, each employee has a manager, who represents the employee's <span>parent</span> in a tree structure. The manager is also an employee. <br class="calibre1" /></blockquote><p class="calibre_6"><em class="calibre6">Threaded discussion:</em></p><blockquote class="calibre_9"> As seen in the introduction, a tree structure may be used for the chain of comments in reply to other comments. In the tree, the children of a comment node are its replies. <br class="calibre1" /></blockquote></dl><p class="calibre_6"> In this chapter, we'll use the threaded discussion example to show the antipattern and its solutions. </p></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-69">
<pagebreak>
<a id="calibre_link-360">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-361">Antipattern: Always Depend on One's Parent</h2><p class="calibre_6"> The naive solution commonly shown in books and articles is to add a column <code class="calibre15">parent_id</code>. This column references another comment in the same table, and you can create a foreign key constraint to enforce this relationship. The SQL to define this table is shown next, and the entity-relationship diagram is shown in Figure <a href="#calibre_link-70"><em class="calibre6">Adjacency list entity-relationship diagram</em></a>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/anti/adjacency-list.sql">Trees/anti/adjacency-list.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Comments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;parent_id&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;author&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_date&nbsp;DATETIME&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(parent_id)&nbsp;REFERENCES&nbsp;Comments(comment_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(author)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Trees/adjacency-list.jpg" src="images/000029.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-70" class="calibre10">Figure 1. Adjacency list entity-relationship diagram</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> This design is called <span>Adjacency List</span>. It's probably the most common design software developers use to store hierarchical data. The following is some sample data to show a hierarchy of comments, and an illustration of the tree is shown in Figure <a href="#calibre_link-71"><em class="calibre6">Threaded comments illustration</em></a>. </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">comment_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">parent_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">author</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">comment</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6">Fran</p></td><td class="calibre19"><p class="calibre_6">What's the cause of this bug?</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">Ollie</p></td><td class="calibre19"><p class="calibre_6">I think it's a null pointer.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">Fran</p></td><td class="calibre19"><p class="calibre_6">No, I checked for that.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">Kukla</p></td><td class="calibre19"><p class="calibre_6">We need to check for invalid input.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">5</p></td><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6">Ollie</p></td><td class="calibre19"><p class="calibre_6">Yes, that's a bug.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">6</p></td><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6">Fran</p></td><td class="calibre19"><p class="calibre_6">Yes, please add a check.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">7</p></td><td class="calibre19"><p class="calibre_6">6</p></td><td class="calibre19"><p class="calibre_6">Kukla</p></td><td class="calibre19"><p class="calibre_6">That fixed it.</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Trees/comment-thread.jpg" src="images/000025.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-71" class="calibre10">Figure 2. Threaded comments illustration</span></td></tr></table></div><br class="calibre1" /><h3 class="calibre_8">Querying a Tree with Adjacency List</h3><p class="calibre_6"> Adjacency List can be an antipattern when it's the default choice of so many developers yet it fails to be a solution for one of the most common tasks you need to do with a tree: query all descendants. </p><p class="calibre_6"> You can retrieve a comment and its immediate children using a relatively simple query: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/anti/parent.sql">Trees/anti/parent.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;c1.*,&nbsp;c2.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;c1&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Comments&nbsp;c2</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ON&nbsp;c2.parent_id&nbsp;=&nbsp;c1.comment_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> However, this queries only two levels of the tree. One characteristic of a tree is that it can extend to any depth, so you need to be able to query the descendents without regard to the number of levels. For example, you may need to compute the <code class="calibre15">COUNT</code> of comments in the thread or the <code class="calibre15">SUM</code> of the cost of parts in a mechanical assembly. </p><p class="calibre_6"> This kind of query is awkward when you use Adjacency List, because each level of the tree corresponds to another join, and the number of joins in an SQL query must be fixed. The following query retrieves a tree of depth up to four but cannot retrieve the tree beyond that depth: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/anti/ancestors.sql">Trees/anti/ancestors.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;c1.*,&nbsp;c2.*,&nbsp;c3.*,&nbsp;c4.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;c1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">--&nbsp;1st&nbsp;level</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Comments&nbsp;c2</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;c2.parent_id&nbsp;=&nbsp;c1.comment_id&nbsp;&nbsp;<em class="calibre6">--&nbsp;2nd&nbsp;level</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Comments&nbsp;c3</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;c3.parent_id&nbsp;=&nbsp;c2.comment_id&nbsp;&nbsp;<em class="calibre6">--&nbsp;3rd&nbsp;level</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Comments&nbsp;c4</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;c4.parent_id&nbsp;=&nbsp;c3.comment_id;&nbsp;<em class="calibre6">--&nbsp;4th&nbsp;level</em></code></span><br class="calibre1" /></div><p class="calibre_6"> This query is also awkward because it includes descendants from progressively deeper levels by adding more columns. This makes it hard to compute an aggregate such as <code class="calibre15">COUNT</code>. </p><p class="calibre_6"> Another way to query a tree structure from Adjacency List is to retrieve all the rows in the collection and instead reconstruct the hierarchy in the application before you can use it like a tree. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/anti/all-comments.sql">Trees/anti/all-comments.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Comments&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234;</code></span><br class="calibre1" /></div><p class="calibre_6"> Copying a large volume of data from the database to the application before you can analyze it is grossly inefficient. You might need only a subtree, not the whole tree from its top. You might require only aggregate information about the data, such as the <code class="calibre15">COUNT</code> of comments. </p><h3 class="calibre_8">Maintaining a Tree with Adjacency List</h3><p class="calibre_6"> Admittedly, some operations are simple to accomplish with Adjacency List, such as adding a new leaf node: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/anti/insert.sql">Trees/anti/insert.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Comments&nbsp;(bug_id,&nbsp;parent_id,&nbsp;author,&nbsp;comment)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(1234,&nbsp;7,&nbsp;<em class="calibre6">'Kukla'</em>,&nbsp;<em class="calibre6">'Thanks!'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> Relocating a single node or a subtree is also easy: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/anti/update.sql">Trees/anti/update.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Comments&nbsp;SET&nbsp;parent_id&nbsp;=&nbsp;3&nbsp;WHERE&nbsp;comment_id&nbsp;=&nbsp;6;</code></span><br class="calibre1" /></div><p class="calibre_6"> However, deleting a node from a tree is more complex. If you want to delete an entire subtree, you have to issue multiple queries to find all descendants. Then remove the descendants from the lowest level up to satisfy the foreign key integrity. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/anti/delete-subtree.sql">Trees/anti/delete-subtree.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;comment_id&nbsp;FROM&nbsp;Comments&nbsp;WHERE&nbsp;parent_id&nbsp;=&nbsp;4;&nbsp;<em class="calibre6">--&nbsp;returns&nbsp;5&nbsp;and&nbsp;6</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;comment_id&nbsp;FROM&nbsp;Comments&nbsp;WHERE&nbsp;parent_id&nbsp;=&nbsp;5;&nbsp;<em class="calibre6">--&nbsp;returns&nbsp;none</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;comment_id&nbsp;FROM&nbsp;Comments&nbsp;WHERE&nbsp;parent_id&nbsp;=&nbsp;6;&nbsp;<em class="calibre6">--&nbsp;returns&nbsp;7</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;comment_id&nbsp;FROM&nbsp;Comments&nbsp;WHERE&nbsp;parent_id&nbsp;=&nbsp;7;&nbsp;<em class="calibre6">--&nbsp;returns&nbsp;none</em></code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;Comments&nbsp;WHERE&nbsp;comment_id&nbsp;IN&nbsp;(&nbsp;7&nbsp;);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;Comments&nbsp;WHERE&nbsp;comment_id&nbsp;IN&nbsp;(&nbsp;5,&nbsp;6&nbsp;);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;Comments&nbsp;WHERE&nbsp;comment_id&nbsp;=&nbsp;4;</code></span><br class="calibre1" /></div><p class="calibre_6"> You can use a foreign key with the <code class="calibre15">ON&nbsp;DELETE CASCADE</code> modifier to automate this, as long as you know you always want to delete the descendants instead of promoting or relocating them. </p><p class="calibre_6"> If you instead want to delete a nonleaf node and promote its children or move them to another place in the tree, you first need to change the <code class="calibre15">parent_id</code> of children and then delete the desired node. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/anti/delete-non-leaf.sql">Trees/anti/delete-non-leaf.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;parent_id&nbsp;FROM&nbsp;Comments&nbsp;WHERE&nbsp;comment_id&nbsp;=&nbsp;6;&nbsp;<em class="calibre6">--&nbsp;returns&nbsp;4</em></code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Comments&nbsp;SET&nbsp;parent_id&nbsp;=&nbsp;4&nbsp;WHERE&nbsp;parent_id&nbsp;=&nbsp;6;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;Comments&nbsp;WHERE&nbsp;comment_id&nbsp;=&nbsp;6;</code></span><br class="calibre1" /></div><p class="calibre_6"> These are examples of operations that require multiple steps when you use the Adjacency List design. That's a lot of code you have to write for tasks that a database should make simpler and more efficient. </p></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-115">
<pagebreak>
<a id="calibre_link-362">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-363">How to Recognize the Antipattern</h2><p class="calibre_6"> If you hear a question like the following, it's a clue that the Naive Trees antipattern is being employed: </p><ul class="calibre_14"><li class="calibre_15"> "How many levels do we need to support in trees?" <br class="calibre_16" /> You're struggling to get all descendants or all ancestors of a node, without using a recursive query. You could compromise by supporting only trees of a limited depth, but the next natural question is, how deep is deep enough? </li><li class="calibre_15"> "I dread ever having to touch the code that manages the tree data structures." <br class="calibre_16" /> You've adopted one of the more sophisticated solutions of managing hierarchies, but you're using the wrong one. Each technique makes some tasks easier, but usually at the cost of other tasks that become harder. You may have chosen a solution that isn't the best choice for the way you need to use hierarchies in your application. </li><li class="calibre_15"> "I need to run a script periodically to clean up the orphaned rows in the trees." <br class="calibre_16" /> Your application creates disconnected nodes in the tree as it deletes nonleaf nodes. When you store complex data structures in a database, you need to keep the structure in a consistent, valid state after any change. You can use one of the solutions presented later in this chapter, along with triggers and cascading foreign key constraints, to store data structures that are resilient instead of fragile. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-190">
<pagebreak>
<a id="calibre_link-364">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-365">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> The Adjacency List design might be just fine to support the work you need to do in your application. The strength of the Adjacency List design is retrieving the direct parent or child of a given node. It's also easy to insert rows. If those operations are all you need to do with your hierarchical data, then Adjacency List can work well for you. </p><blockquote class="calibre_9"><div class="calibre1">Don't Over-Engineer</div><div class="calibre1"><p class="calibre_6"> I wrote an inventory-tracking application for a computer data center. Some equipment was installed inside computers; for example, a caching disk controller was installed in a rackmount server, and extra memory modules were installed on the disk controller. </p><p class="calibre_6"> I needed an SQL solution to track the usage of hierarchical collections easily. But I also needed to track each individual piece of equipment to produce accounting reports of equipment utilization, amortization, and return on investment. </p><p class="calibre_6"> The manager said the collections could have subcollections, and thus the tree could in theory descend to any depth. It took quite a few weeks to perfect the code for manipulating trees in the database storage, user interface, administration, and reporting. </p><p class="calibre_6"> In practice, however, the inventory application never needed to create a grouping of equipment with a tree deeper than a single parent-child relationship. If my client had acknowledged that this would be enough to model his inventory requirements, we could have saved a lot of work. </p></div></blockquote><p class="calibre_6"> Some brands of RDBMS support extensions to SQL to support hierarchies stored in the Adjacency List format. The SQL-99 standard defines recursive query syntax using the <code class="calibre15">WITH</code> keyword followed by a <span>common table expression</span>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/legit/cte.sql">Trees/legit/cte.sql</a></span></span></div><span class="calibre3"><code class="calibre15">WITH&nbsp;CommentTree</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;(comment_id,&nbsp;bug_id,&nbsp;parent_id,&nbsp;author,&nbsp;comment,&nbsp;depth)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">AS&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*,&nbsp;0&nbsp;AS&nbsp;depth&nbsp;FROM&nbsp;Comments</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;parent_id&nbsp;IS&nbsp;NULL</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;UNION&nbsp;ALL</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;c.*,&nbsp;ct.depth+1&nbsp;AS&nbsp;depth&nbsp;FROM&nbsp;CommentTree&nbsp;ct</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;JOIN&nbsp;Comments&nbsp;c&nbsp;ON&nbsp;(ct.comment_id&nbsp;=&nbsp;c.parent_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;CommentTree&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234;</code></span><br class="calibre1" /></div><p class="calibre_6"> Microsoft SQL Server 2005, Oracle 11g, IBM DB2, and PostgreSQL 8.4 support recursive queries using common table expressions, as shown earlier. </p><p class="calibre_6"> MySQL, SQLite, and Informix are examples of database brands that don't support this syntax yet. It's the same for Oracle 10g, which is still widely used. In the future, we might assume recursive query syntax will become available across all popular brands, and then using Adjacency List won't be so limiting. </p><p class="calibre_6"> Oracle 9i and 10g support the <code class="calibre15">WITH</code> clause, but not for recursive queries. Instead, there is proprietary syntax: <code class="calibre15">START&nbsp;WITH</code> and <code class="calibre15">CONNECT&nbsp;BY&nbsp;PRIOR</code>. You can use this syntax to perform recursive queries: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/legit/connect-by.sql">Trees/legit/connect-by.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Comments</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">START&nbsp;WITH&nbsp;comment_id&nbsp;=&nbsp;9876</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">CONNECT&nbsp;BY&nbsp;PRIOR&nbsp;parent_id&nbsp;=&nbsp;comment_id;</code></span><br class="calibre1" /></div></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-274">
<pagebreak>
<a id="calibre_link-366">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-367">Solution: Use Alternative Tree Models</h2><p class="calibre_6"> There are several alternatives to the Adjacency List model of storing hierarchical data, including <span>Path Enumeration</span>, <span>Nested Sets</span>, and <span>Closure Table</span>. The following three sections show examples using these designs to solve the scenario in the "Antipattern" section, storing and querying a tree-like collection of comments. </p><p class="calibre_6"> These solutions take some getting used to. They may seem more complex than Adjacency List at first, but they make some tree operations easier that were very difficult or inefficient using the Adjacency List design. If your application needs to perform those operations, then these designs are a better choice than the simple Adjacency List. </p><h3 class="calibre_8">Path Enumeration</h3><p class="calibre_6"> One weakness of Adjacency List is that it's expensive to retrieve ancestors of a given node in the tree. In Path Enumeration, this is solved by storing the string of ancestors as an attribute of each node. </p><p class="calibre_6"> You can see a form of Path Enumeration in directory hierarchies. A <em class="calibre6">UNIX</em> path like <code class="calibre15">/usr/local/lib/</code> is a Path Enumeration of the filesystem, where <code class="calibre15">usr</code> is the parent of <code class="calibre15">local</code>, which in turn is the parent of <code class="calibre15">lib</code>. </p><p class="calibre_6"> In the <code class="calibre15">Comments</code> table, instead of the <code class="calibre15">parent_id</code> column, define a column called <code class="calibre15">path</code> as a long <code class="calibre15">VARCHAR</code>. The string stored in this column is the sequence of ancestors of the current row in order from the top of the tree down, just like a <em class="calibre6">UNIX</em> path. You can even choose <code class="calibre15">/</code> as a separator character. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/path-enum/create-table.sql">Trees/soln/path-enum/create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Comments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(1000),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;author&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_date&nbsp;DATETIME&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(author)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">comment_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">path</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">author</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">comment</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">1/</p></td><td class="calibre19"><p class="calibre_6">Fran</p></td><td class="calibre19"><p class="calibre_6">What's the cause of this bug?</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">1/2/</p></td><td class="calibre19"><p class="calibre_6">Ollie</p></td><td class="calibre19"><p class="calibre_6">I think it's a null pointer.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6">1/2/3/</p></td><td class="calibre19"><p class="calibre_6">Fran</p></td><td class="calibre19"><p class="calibre_6">No, I checked for that.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6">1/4/</p></td><td class="calibre19"><p class="calibre_6">Kukla</p></td><td class="calibre19"><p class="calibre_6">We need to check for invalid input.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">5</p></td><td class="calibre19"><p class="calibre_6">1/4/5/</p></td><td class="calibre19"><p class="calibre_6">Ollie</p></td><td class="calibre19"><p class="calibre_6">Yes, that's a bug.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">6</p></td><td class="calibre19"><p class="calibre_6">1/4/6/</p></td><td class="calibre19"><p class="calibre_6">Fran</p></td><td class="calibre19"><p class="calibre_6">Yes, please add a check.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">7</p></td><td class="calibre19"><p class="calibre_6">1/4/6/7/</p></td><td class="calibre19"><p class="calibre_6">Kukla</p></td><td class="calibre19"><p class="calibre_6">That fixed it.</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> You can query ancestors by comparing the current row's path to a pattern formed from the path of another row. For example, to find ancestors of comment #7, whose path is <code class="calibre15">1/4/6/7/</code>, do this: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/path-enum/ancestors.sql">Trees/soln/path-enum/ancestors.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;<em class="calibre6">'1/4/6/7/'</em>&nbsp;LIKE&nbsp;c.path&nbsp;||&nbsp;<em class="calibre6">'%'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> This matches the patterns formed from paths of ancestors <code class="calibre15">1/4/6/%</code>, <code class="calibre15">1/4/%</code>, and <code class="calibre15">1/%</code>. </p><p class="calibre_6"> You can query descendants by reversing the arguments of the <code class="calibre15">LIKE</code> predicate. To find the descendants of comment #4 whose path is <code class="calibre15">1/4/</code>, use this: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/path-enum/descendants.sql">Trees/soln/path-enum/descendants.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;c.path&nbsp;LIKE&nbsp;<em class="calibre6">'1/4/'</em>&nbsp;||&nbsp;<em class="calibre6">'%'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> The pattern <code class="calibre15">1/4/%</code> matches the paths of descendants <code class="calibre15">1/4/5/</code>, and <code class="calibre15">1/4/6/</code>, and <code class="calibre15">1/4/6/7/</code>. </p><p class="calibre_6"> Once you can easily select a subset of the tree or the chain of ancestors to the top of the tree, you can perform many other queries easily, such as computing the <code class="calibre15">SUM</code> of costs of nodes in a subtree or simply counting the number of nodes. For example, to count the comments per author in the subtree starting at comment #4, do this: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/path-enum/count.sql">Trees/soln/path-enum/count.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;COUNT(*)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;c.path&nbsp;LIKE&nbsp;<em class="calibre6">'1/4/'</em>&nbsp;||&nbsp;<em class="calibre6">'%'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;c.author;</code></span><br class="calibre1" /></div><p class="calibre_6"> Inserting a node is similar to inserting in the Adjacency List model. You can insert a nonleaf node without needing to modify any other row. Copy the <code class="calibre15">path</code> from the new node's parent, and append the ID of the new node to this string. If your primary key generates its value automatically during the insert, you may need to insert the row and then update the <code class="calibre15">path</code> once you know the ID value for the new row. For example, if you use MySQL, the built-in function <code class="calibre15">LAST_INSERT_ID</code> returns the most recent ID value generated for an inserted row in the current session. Get the rest of the path from the parent of your new node. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/path-enum/insert.sql">Trees/soln/path-enum/insert.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Comments&nbsp;(author,&nbsp;comment)&nbsp;VALUES&nbsp;(<em class="calibre6">'Ollie'</em>,&nbsp;<em class="calibre6">'Good&nbsp;job!'</em>);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Comments</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SET&nbsp;path&nbsp;=&nbsp;(SELECT&nbsp;path&nbsp;FROM&nbsp;Comments&nbsp;WHERE&nbsp;comment_id&nbsp;=&nbsp;7)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;LAST_INSERT_ID()&nbsp;||&nbsp;<em class="calibre6">'/'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;comment_id&nbsp;=&nbsp;LAST_INSERT_ID();</code></span><br class="calibre1" /></div><p class="calibre_6"> Path Enumeration has some drawbacks similar to those shown in the Chapter <a href="#calibre_link-140"><em class="calibre6">Jaywalking</em></a>. The database can't enforce that the path is formed correctly or that values in the path correspond to existing nodes. Maintaining the path string depends on application code, and verifying it is costly. No matter how long you make the <code class="calibre15">VARCHAR</code> column, it still has a length limit, so it doesn't strictly support trees of unlimited depth. </p><p class="calibre_6"> Path Enumeration allows you to sort a set of rows easily by their hierarchy, as long as the elements between the separator are of consistent length.<a href="#calibre_link-275" id="calibre_link-279">[3]</a></p><h3 class="calibre_8">Nested Sets</h3><p class="calibre_6"> The Nested Sets solution stores information with each node that pertains to the set of its descendants, rather than the node's immediate parent. This information can be represented by encoding each node in the tree with two numbers, which you can call <code class="calibre15">nsleft</code> and <code class="calibre15">nsright</code>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/nested-sets/create-table.sql">Trees/soln/nested-sets/create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Comments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;nsleft&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTEGER&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;nsright&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTEGER&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;author&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_date&nbsp;DATETIME&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs&nbsp;(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(author)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Each node is given <code class="calibre15">nsleft</code> and <code class="calibre15">nsright</code> numbers in the following way: the <code class="calibre15">nsleft</code> number is less than the numbers of all the node's children, whereas the <code class="calibre15">nsright</code> number is greater than the numbers of all the node's children. These numbers have no relation to the <code class="calibre15">comment_id</code> values. </p><p class="calibre_6"> An easy way to assign these values is by following a depth-first traversal of the tree, assigning <code class="calibre15">nsleft</code> numbers incrementally as you descend a branch of the tree and assigning <code class="calibre15">nsright</code> numbers as you ascend back up the branch. </p><p class="calibre_6"> It may be easier to visualize the pattern from Figure <a href="#calibre_link-276"><em class="calibre6">Nested Sets illustration</em></a> than from this description. </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">comment_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">nsleft</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">nsright</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">author</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">comment</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">14</p></td><td class="calibre19"><p class="calibre_6">Fran</p></td><td class="calibre19"><p class="calibre_6">What's the cause of this bug?</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">5</p></td><td class="calibre19"><p class="calibre_6">Ollie</p></td><td class="calibre19"><p class="calibre_6">I think it's a null pointer.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6">Fran</p></td><td class="calibre19"><p class="calibre_6">No, I checked for that.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6">6</p></td><td class="calibre19"><p class="calibre_6">13</p></td><td class="calibre19"><p class="calibre_6">Kukla</p></td><td class="calibre19"><p class="calibre_6">We need to check for invalid input.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">5</p></td><td class="calibre19"><p class="calibre_6">7</p></td><td class="calibre19"><p class="calibre_6">8</p></td><td class="calibre19"><p class="calibre_6">Ollie</p></td><td class="calibre19"><p class="calibre_6">Yes, that's a bug.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">6</p></td><td class="calibre19"><p class="calibre_6">9</p></td><td class="calibre19"><p class="calibre_6">12</p></td><td class="calibre19"><p class="calibre_6">Fran</p></td><td class="calibre19"><p class="calibre_6">Yes, please add a check.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">7</p></td><td class="calibre19"><p class="calibre_6">10</p></td><td class="calibre19"><p class="calibre_6">11</p></td><td class="calibre19"><p class="calibre_6">Kukla</p></td><td class="calibre19"><p class="calibre_6">That fixed it.</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Trees/nested-sets.jpg" src="images/000023.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-276" class="calibre10">Figure 3. Nested Sets illustration</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> Once you have assigned each node with these numbers, you can use them to find ancestors and descendants of any given node. For example, you can retrieve comment #4 and its descendants by searching for nodes whose numbers are between the current node's <code class="calibre15">nsleft</code> and <code class="calibre15">nsright</code>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/nested-sets/descendants.sql">Trees/soln/nested-sets/descendants.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;c2.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;AS&nbsp;c1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;Comments&nbsp;as&nbsp;c2</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;c2.nsleft&nbsp;BETWEEN&nbsp;c1.nsleft&nbsp;AND&nbsp;c1.nsright</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;c1.comment_id&nbsp;=&nbsp;4;</code></span><br class="calibre1" /></div><p class="calibre_6"> You can retrieve comment #6 and its ancestors by searching for nodes whose numbers span the current node's numbers. For example: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/nested-sets/ancestors.sql">Trees/soln/nested-sets/ancestors.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;c2.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;AS&nbsp;c1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;Comment&nbsp;AS&nbsp;c2</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;c1.nsleft&nbsp;BETWEEN&nbsp;c2.nsleft&nbsp;AND&nbsp;c2.nsright</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;c1.comment_id&nbsp;=&nbsp;6;</code></span><br class="calibre1" /></div><p class="calibre_6"> One chief strength of the Nested Sets design is that when you delete a nonleaf node, its descendants are automatically considered direct children of the deleted node's parents. Although the right and left numbers of each node shown in the illustration have values forming a continuous series and the difference is always one compared to adjacent siblings and parents, this is not necessary for the Nested Sets design to preserve the hierarchy. So when gaps in the values result from deleting a node, there is no interruption to the tree structure. </p><p class="calibre_6"> For example, you can count the depth of a given node and delete its parent, and then when you count the depth of the node again, it seems to have decreased depth by one level. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/nested-sets/depth.sql">Trees/soln/nested-sets/depth.sql</a></span></span></div><span class="calibre3"><code class="calibre15"><em class="calibre6">--&nbsp;Reports&nbsp;depth&nbsp;=&nbsp;3</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;c1.comment_id,&nbsp;COUNT(c2.comment_id)&nbsp;AS&nbsp;depth</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comment&nbsp;AS&nbsp;c1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;Comment&nbsp;AS&nbsp;c2</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;c1.nsleft&nbsp;BETWEEN&nbsp;c2.nsleft&nbsp;AND&nbsp;c2.nsright</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;c1.comment_id&nbsp;=&nbsp;7</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;c1.comment_id;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;Comment&nbsp;WHERE&nbsp;comment_id&nbsp;=&nbsp;6;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><em class="calibre6">--&nbsp;Reports&nbsp;depth&nbsp;=&nbsp;2</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;c1.comment_id,&nbsp;COUNT(c2.comment_id)&nbsp;AS&nbsp;depth</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comment&nbsp;AS&nbsp;c1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;Comment&nbsp;AS&nbsp;c2</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;c1.nsleft&nbsp;BETWEEN&nbsp;c2.nsleft&nbsp;AND&nbsp;c2.nsright</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;c1.comment_id&nbsp;=&nbsp;7</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;c1.comment_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> However, some queries that are simple in the Adjacency List design, such as retrieving the immediate child or immediate parent, are more complex in the Nested Sets design. The direct parent of a given node <code class="calibre15">c1</code> is an ancestor of that node, but no other node can exist in between them. So, you can use an additional outer join to search for a node that is both an ancestor of <code class="calibre15">c1</code> and a descendant of the parent. Only if no such node is found (that is, the result of the outer join is null) is the ancestor truly the direct parent of <code class="calibre15">c1</code>. </p><p class="calibre_6"> For example, to find the immediate parent of comment #6, do this: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/nested-sets/parent.sql">Trees/soln/nested-sets/parent.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;parent.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comment&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;Comment&nbsp;AS&nbsp;parent</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;c.nsleft&nbsp;BETWEEN&nbsp;parent.nsleft&nbsp;AND&nbsp;parent.nsright</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Comment&nbsp;AS&nbsp;in_between</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;c.nsleft&nbsp;BETWEEN&nbsp;in_between.nsleft&nbsp;AND&nbsp;in_between.nsright</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;in_between.nsleft&nbsp;BETWEEN&nbsp;parent.nsleft&nbsp;AND&nbsp;parent.nsright</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;c.comment_id&nbsp;=&nbsp;6</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;AND&nbsp;in_between.comment_id&nbsp;IS&nbsp;NULL;</code></span><br class="calibre1" /></div><p class="calibre_6"> Manipulations of the tree, inserting and moving nodes, are generally more complex in the Nested Sets design than they are in other models. When you insert a new node, you need to recalculate all the left and right values greater than the left value of the new node. </p><p class="calibre_6"> This includes the new node's right siblings, its ancestors, and the right siblings of its ancestors. It also includes descendants, if the new node is inserted as a nonleaf node. Assuming the new node is a leaf node, the following statement should update everything necessary: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/nested-sets/insert.sql">Trees/soln/nested-sets/insert.sql</a></span></span></div><span class="calibre3"><code class="calibre15"><em class="calibre6">--&nbsp;make&nbsp;space&nbsp;for&nbsp;NS&nbsp;values&nbsp;8&nbsp;and&nbsp;9</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Comment</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SET&nbsp;nsleft&nbsp;=&nbsp;CASE&nbsp;WHEN&nbsp;nsleft&nbsp;&gt;=&nbsp;8&nbsp;THEN&nbsp;nsleft+2&nbsp;ELSE&nbsp;nsleft&nbsp;END,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nsright&nbsp;=&nbsp;nsright+2</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;nsright&nbsp;&gt;=&nbsp;7;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><em class="calibre6">--&nbsp;create&nbsp;new&nbsp;child&nbsp;of&nbsp;comment&nbsp;#5,&nbsp;occupying&nbsp;NS&nbsp;values&nbsp;8&nbsp;and&nbsp;9</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Comment&nbsp;(nsleft,&nbsp;nsright,&nbsp;author,&nbsp;comment)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(8,&nbsp;9,&nbsp;<em class="calibre6">'Fran'</em>,&nbsp;<em class="calibre6">'Me&nbsp;too!'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> The Nested Sets model is best when it's more important to perform queries for subtrees quickly and easily, rather than operations on individual nodes. Inserting and moving nodes is complex, because of the requirement to renumber the left and right values. If your usage of the tree involves frequent insertions, Nested Sets isn't the best choice. </p><h3 class="calibre_8">Closure Table</h3><p class="calibre_6"> The Closure Table solution is a simple and elegant way of storing hierarchies. It involves storing all paths through the tree, not just those with a direct parent-child relationship. </p><p class="calibre_6"> In addition to a plain <code class="calibre15">Comments</code> table, create another table <code class="calibre15">TreePaths</code>, with two columns, each of which is a foreign key to the <code class="calibre15">Comments</code> table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/closure-table/create-table.sql">Trees/soln/closure-table/create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Comments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;author&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_date&nbsp;DATETIME&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(author)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;TreePaths&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ancestor&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;descendant&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY(ancestor,&nbsp;descendant),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(ancestor)&nbsp;REFERENCES&nbsp;Comments(comment_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(descendant)&nbsp;REFERENCES&nbsp;Comments(comment_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Instead of using the <code class="calibre15">Comments</code> table to store information about the tree structure, use the <code class="calibre15">TreePaths</code> table. Store one row in this table for each pair of nodes in the tree that shares an ancestor/descendant relationship, even if they are separated by multiple levels in the tree. Also add a row for each node to reference itself. For an illustration of how the nodes are paired, see Figure <a href="#calibre_link-277"><em class="calibre6">Closure Table illustration</em></a>. </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">ancestor</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">descendant</code></p></td><td class="calibre19"><p class="calibre_6">&nbsp;</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">ancestor</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">descendant</code></p></td><td class="calibre19"><p class="calibre_6">&nbsp;</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">ancestor</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">descendant</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6"></p></td><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">7</p></td><td class="calibre19"><p class="calibre_6"></p></td><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6">6</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6"></p></td><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6"></p></td><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6">7</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6"></p></td><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6"></p></td><td class="calibre19"><p class="calibre_6">5</p></td><td class="calibre19"><p class="calibre_6">5</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6"></p></td><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6"></p></td><td class="calibre19"><p class="calibre_6">6</p></td><td class="calibre19"><p class="calibre_6">6</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">5</p></td><td class="calibre19"><p class="calibre_6"></p></td><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6"></p></td><td class="calibre19"><p class="calibre_6">6</p></td><td class="calibre19"><p class="calibre_6">7</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">6</p></td><td class="calibre19"><p class="calibre_6"></p></td><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6">5</p></td><td class="calibre19"><p class="calibre_6"></p></td><td class="calibre19"><p class="calibre_6">7</p></td><td class="calibre19"><p class="calibre_6">7</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Trees/closure-table.jpg" src="images/000020.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-277" class="calibre10">Figure 4. Closure Table illustration</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> The queries to retrieve ancestors and descendants from this table are even more straightforward than those in the Nested Sets solution. To retrieve descendants of comment #4, match rows in <code class="calibre15">TreePaths</code> where the <code class="calibre15">ancestor</code> is 4: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/closure-table/descendants.sql">Trees/soln/closure-table/descendants.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;c.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;TreePaths&nbsp;AS&nbsp;t&nbsp;ON&nbsp;c.comment_id&nbsp;=&nbsp;t.descendant</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;t.ancestor&nbsp;=&nbsp;4;</code></span><br class="calibre1" /></div><p class="calibre_6"> To retrieve ancestors of comment #6, match rows in <code class="calibre15">TreePaths</code> where the <code class="calibre15">descendant</code> is 6: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/closure-table/ancestors.sql">Trees/soln/closure-table/ancestors.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;c.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;TreePaths&nbsp;AS&nbsp;t&nbsp;ON&nbsp;c.comment_id&nbsp;=&nbsp;t.ancestor</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;t.descendant&nbsp;=&nbsp;6;</code></span><br class="calibre1" /></div><p class="calibre_6"> To insert a new leaf node, for instance a new child of comment #5, first insert the self-referencing row. Then add a copy of the set of rows in <code class="calibre15">TreePaths</code> that reference comment #5 as a <code class="calibre15">descendant</code> (including the row in which comment #5 references itself), replacing the <code class="calibre15">descendant</code> with the number of the new comment: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/closure-table/insert.sql">Trees/soln/closure-table/insert.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;TreePaths&nbsp;(ancestor,&nbsp;descendant)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;t.ancestor,&nbsp;8</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FROM&nbsp;TreePaths&nbsp;AS&nbsp;t</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;WHERE&nbsp;t.descendant&nbsp;=&nbsp;5</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;UNION&nbsp;ALL</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;8,&nbsp;8;</code></span><br class="calibre1" /></div><p class="calibre_6"> To delete a leaf node, for instance comment #7, delete all rows in <code class="calibre15">TreePaths</code> that reference comment #7 as a <code class="calibre15">descendant</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/closure-table/delete-leaf.sql">Trees/soln/closure-table/delete-leaf.sql</a></span></span></div><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;TreePaths&nbsp;WHERE&nbsp;descendant&nbsp;=&nbsp;7;</code></span><br class="calibre1" /></div><p class="calibre_6"> To delete a complete subtree, for instance comment #4 and its descendants, delete all rows in <code class="calibre15">TreePaths</code> that reference comment #4 as a <code class="calibre15">descendant</code>, as well as all rows that reference any of comment #4's descendants as descendants: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/closure-table/delete-subtree.sql">Trees/soln/closure-table/delete-subtree.sql</a></span></span></div><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;TreePaths</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;descendant&nbsp;IN&nbsp;(SELECT&nbsp;descendant</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;TreePaths</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ancestor&nbsp;=&nbsp;4);</code></span><br class="calibre1" /></div><p class="calibre_6"> Notice that if you delete rows in <code class="calibre15">TreePaths</code>, this doesn't delete the comments themselves. This seems odd for this example of <code class="calibre15">Comments</code>, but it makes more sense if you're working with other kinds of trees, for instance categories in a product catalog or employees in an org chart. You don't necessarily want to delete a node when you change its relationship to other nodes. When you store paths in a separate table, it helps make this more flexible. </p><p class="calibre_6"> To move a subtree from one location in the tree to another, first disconnect the subtree from its ancestors by deleting rows that reference the ancestors of the top node in the subtree and the descendants of that node. For instance, to move comment #6 from its position as a child of comment #4 to a child of comment #3, start with the following deletion. Make sure not to delete comment #6's self-reference. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/closure-table/move-subtree.sql">Trees/soln/closure-table/move-subtree.sql</a></span></span></div><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;TreePaths</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;descendant&nbsp;IN&nbsp;(SELECT&nbsp;descendant</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;TreePaths</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ancestor&nbsp;=&nbsp;6)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;AND&nbsp;ancestor&nbsp;IN&nbsp;(SELECT&nbsp;ancestor</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;TreePaths</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;descendant&nbsp;=&nbsp;6</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ancestor&nbsp;!=&nbsp;descendant);</code></span><br class="calibre1" /></div><p class="calibre_6"> By selecting ancestors of #6, but not #6 itself, and descendants of #6, including #6, this correctly removes all the paths from #6's ancestors to #6 and its descendants. In other words, this deletes the paths (1, 6), (1,7), (4, 6), and (4, 7). It does not delete (6, 6) or (6, 7). </p><p class="calibre_6"> Then add the orphaned subtree by inserting rows matching the ancestors of the new location and the descendants of the subtree. You can use the <code class="calibre15">CROSS&nbsp;JOIN</code> syntax to create a Cartesian product, generating the rows needed to match ancestors of the new location to all the nodes in the subtree you need to move. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/closure-table/move-subtree.sql">Trees/soln/closure-table/move-subtree.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;TreePaths&nbsp;(ancestor,&nbsp;descendant)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;supertree.ancestor,&nbsp;subtree.descendant</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FROM&nbsp;TreePaths&nbsp;AS&nbsp;supertree</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;CROSS&nbsp;JOIN&nbsp;TreePaths&nbsp;AS&nbsp;subtree</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;WHERE&nbsp;supertree.descendant&nbsp;=&nbsp;3</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;subtree.ancestor&nbsp;=&nbsp;6;</code></span><br class="calibre1" /></div><p class="calibre_6"> This creates new paths using the ancestors of #3, including #3, and the descendants of #6, including #6. So, the new paths are (1, 6), (2, 6), (3, 6), (1, 7), (2, 7), (3, 7). The result is that the subtree starting with comment #6 is relocated as a child of comment #3. The cross join creates all the needed paths, even if the subtree is moved to a higher or lower level in the tree. </p><p class="calibre_6"> The Closure Table design is more straightforward than the Nested Sets design. Both have quick and easy methods for querying ancestors and descendants, but the Closure Table is easier to maintain the hierarchy information. In both designs, it's more convenient to query immediate child or parent nodes than in the Adjacency List or Path Enumeration designs. </p><p class="calibre_6"> However, you can improve the Closure Table to make queries for immediate parent or child nodes easier. Add a <code class="calibre15">TreePaths.path_length</code> attribute to the Closure Table design. The <code class="calibre15">path_length</code> of a node's self-reference is zero, the <code class="calibre15">path_length</code> of its immediate child is 1, the <code class="calibre15">path_length</code> of its grandchild is 2, and so on. Finding the children of comment #4 is now straightforward: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Trees/soln/closure-table/child.sql">Trees/soln/closure-table/child.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;TreePaths</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;ancestor&nbsp;=&nbsp;4&nbsp;AND&nbsp;path_length&nbsp;=&nbsp;1;</code></span><br class="calibre1" /></div><h3 class="calibre_8">Which Design Should You Use?</h3><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Trees/comparison-table.jpg" src="images/000008.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-278" class="calibre10">Figure 5. Comparing hierarchical data designs</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> Each of the designs has its own strengths and weaknesses. Choose the design depending on which operations you need to be most efficient. In Figure <a href="#calibre_link-278"><em class="calibre6">Comparing hierarchical data designs</em></a>, some operations are marked as easy or hard with each respective tree design. You can also consider the following strengths and weaknesses of each design: </p><ul class="calibre_14"><li class="calibre_15"><em class="calibre6">Adjacency List</em> is the most conventional design, and many software developers recognize it. </li><li class="calibre_15"><em class="calibre6">Recursive Queries</em> using <code class="calibre15">WITH</code> or <code class="calibre15">CONNECT BY&nbsp;PRIOR</code> make it more efficient to use the Adjacency List design, provided you use one of the database brands that supports the syntax. </li><li class="calibre_15"><em class="calibre6">Path Enumeration</em> is good for breadcrumbs in user interfaces, but it's fragile because it fails to enforce referential integrity and stores information redundantly. </li><li class="calibre_15"><em class="calibre6">Nested Sets</em> is a clever solution---maybe too clever. It also fails to support referential integrity. It's best used when you need to query a tree more frequently than you need to modify the tree. </li><li class="calibre_15"><em class="calibre6">Closure Table</em> is the most versatile design and the only design in this chapter that could allow a node to belong to multiple trees. It requires an additional table to store the relationships. This design also uses a lot of rows when encoding deep hierarchies, increasing space consumption as a trade-off for reducing computing. </li></ul><p class="calibre_6"> There's more to learn about storing and manipulating hierarchical data in SQL. A good book that covers hierarchical queries is <em class="calibre6">Joe Celko's Trees and Hierarchies in SQL for Smarties</em><a href="#calibre_link-43">[JCTAHISFS]</a> . Another book that covers trees and even graphs is <em class="calibre6">SQL Design Patterns</em><a href="#calibre_link-47">[SDP]</a> by Vadim Tropashko. The latter book has a more formal, academic style. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">A hierarchy consists of entries and relationships.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Model both of these to suit your work.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-279" id="calibre_link-275">[3]</a>
<small class="calibre3"> On the other hand, this may smell too much like the Jaywalking antipattern. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-368"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-2">
<pagebreak>
<a id="calibre_link-369">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-213" class="calibre12"><small class="calibre13">Chapter 4</small><br class="calibre14" />ID Required</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> The creatures outside looked from pig to man, and from man to pig, and from pig to man again; but already it was impossible to say which was which. </em></p></div><div class="calibre1"><div class="calibre4"><span>George Orwell, Animal Farm</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> Recently I answered a question that I see frequently, from a software developer trying to prevent duplicate rows. At first I thought he must lack a primary key. But that wasn't his problem. </p><p class="calibre_6"> In his content management database, he stored articles for publishing on a website. He used an intersection table for a many-to-many association between a table of articles and a table of tags. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/intro/articletags.sql">ID-Required/intro/articletags.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;ArticleTags&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;article_id&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;tag_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(article_id)&nbsp;REFERENCES&nbsp;Articles&nbsp;(id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(tag_id)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REFERENCES&nbsp;Tags&nbsp;(id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> He was getting incorrect results from queries when counting the number of articles with a given tag. He knew that there were only five articles with the "economy" tag, but the query was telling him there were seven. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/intro/articletags.sql">ID-Required/intro/articletags.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;tag_id,&nbsp;COUNT(*)&nbsp;AS&nbsp;articles_per_tag&nbsp;FROM&nbsp;ArticleTags&nbsp;WHERE&nbsp;tag_id&nbsp;=&nbsp;327;</code></span><br class="calibre1" /></div><p class="calibre_6"> When he queried all the rows matching that <code class="calibre15">tag_id</code>, he saw that the tag was associated with one particular article in triplicate; three rows showed the same association, although they had different values for <code class="calibre15">id</code>. </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">tag_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">article_id</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">22</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">327</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">1234</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">23</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">327</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">1234</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">24</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">327</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">1234</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> This table had a primary key, but that primary key wasn't preventing duplicates in the columns that mattered. One remedy might be to create a <code class="calibre15">UNIQUE</code> constraint over the other two columns, but given that, why is the <code class="calibre15">id</code> column needed at all? </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-54">
<pagebreak>
<a id="calibre_link-370">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-371">Objective: Establish Primary Key Conventions</h2><p class="calibre_6"> The objective is to make sure every table has a primary key, but confusion about the nature of a primary key has resulted in an antipattern. </p><p class="calibre_6"> Everyone who has been introduced to database design knows that a primary key is an important, even mandatory, part of a table. This is true; primary keys are integral to good database design. A primary key is guaranteed to be unique over all rows in the table, so this is the logical mechanism to address individual rows and to prevent duplicate rows from being stored. A primary key is also referenced by foreign keys to create table associations. </p><p class="calibre_6"> The tricky part is choosing a column to serve as the primary key. The value of any attribute in most tables has the potential to belong on more than one row. Textbook examples such as a person's first name and last name are clearly subject to having duplication. Even an email address or administrative identification numbers such as a United States Social Security number or taxpayer ID number aren't strictly unique. </p><p class="calibre_6"> A new column is needed in such tables to store an artificial value that has no meaning in the domain modeled by the table. This column is used as the primary key, so you can address rows uniquely while allowing any other attribute column to contain duplicates, if that's appropriate. This type of primary key column is sometimes called a <span>pseudokey</span> or a <span>surrogate key</span>. </p><p class="calibre_6"> To ensure rows can be given unique pseudokey values even when concurrent clients are inserting new rows, most databases provide a mechanism to generate unique integer values serially, outside the scope of transaction isolation. </p><p class="calibre_6"> Pseudokeys weren't standardized until SQL:2003, so each database uses its own extension to SQL to implement them. Even the terminology for pseudokeys is vendor-dependent, as shown by the following table: </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Feature</p></td><td class="calibre19"><p class="calibre_6">Supported by Database Brands</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">AUTO_INCREMENT</code></p></td><td class="calibre19"><p class="calibre_6">MySQL</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">GENERATOR</code></p></td><td class="calibre19"><p class="calibre_6">Firebird, InterBase</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">IDENTITY</code></p></td><td class="calibre19"><p class="calibre_6">DB2, Derby, Microsoft SQL Server, Sybase</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">ROWID</code></p></td><td class="calibre19"><p class="calibre_6">SQLite</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">SEQUENCE</code></p></td><td class="calibre19"><p class="calibre_6">DB2, Firebird, Informix, Ingres, Oracle, PostgreSQL</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">SERIAL</code></p></td><td class="calibre19"><p class="calibre_6">MySQL, PostgreSQL</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> Pseudokeys are a useful feature, but they aren't the only solution for declaring a primary key. </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Do I Really Need a Primary Key?</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> I've heard some software developers claim that their table doesn't need a primary key. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Sometimes these programmers want to avoid the imagined overhead of maintaining a unique index, or else they have tables with no columns they can use for this purpose. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> A primary key constraint is important when you need to do the following: </blockquote></small></p><ul class="calibre_14"><li class="calibre_15"> Prevent a table from containing duplicate rows </li><li class="calibre_15"> Reference individual rows in queries </li><li class="calibre_15"> Support foreign key references </li></ul><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> If you don't use primary key constraints, you create a chore for yourself: checking for duplicate rows. </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15">SELECT&nbsp;bug_id&nbsp;FROM&nbsp;Bugs&nbsp;GROUP&nbsp;BY&nbsp;bug_id&nbsp;HAVING&nbsp;COUNT(*)&nbsp;&gt;&nbsp;1;</code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> How frequently should you run this check? What should you do with a duplicate when you find one? </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> A table without a primary key is like organizing your MP3 collection with no song titles. You can still listen to the music, but you can't find the one you want or keep duplicates out of your collection. </blockquote></small></p></div><hr class="calibre7" /></div></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-100">
<pagebreak>
<a id="calibre_link-372">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-373">Antipattern: One Size Fits All</h2><p class="calibre_6"> Books, articles, and programming frameworks have established a cultural convention that every database table must have a primary key column with the following characteristics: </p><ul class="calibre_14"><li class="calibre_15">The primary key's column name is <code class="calibre15">id</code>.</li><li class="calibre_15">Its data type is a 32-bit or 64-bit integer.</li><li class="calibre_15">Unique values are generated automatically.</li></ul><p class="calibre_6"> The presence of a column named <code class="calibre15">id</code> in every table is so common that this has become synonymous with a primary key. Programmers learning SQL get the false idea that a primary key always means a column defined in this manner. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/anti/id-ubiquitous.sql">ID-Required/anti/id-ubiquitous.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;description&nbsp;VARCHAR(1000),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;.&nbsp;.&nbsp;.</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Adding an <code class="calibre15">id</code> column to every table causes several effects that make its use seem arbitrary. </p><h3 class="calibre_8">Making a Redundant Key</h3><p class="calibre_6"> You might see an <code class="calibre15">id</code> column defined as the primary key simply for the sake of tradition, even when another column in the same table could be used as the natural primary key. The other column may even be defined with a <code class="calibre15">UNIQUE</code> constraint. For example, in the <code class="calibre15">Bugs</code> table, the application might label bugs using a string with a mnemonic for the project the bug belongs to, or other identifying information. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/anti/id-redundant.sql">ID-Required/anti/id-redundant.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(10)&nbsp;UNIQUE,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;description&nbsp;VARCHAR(1000),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;.&nbsp;.&nbsp;.</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Bugs&nbsp;(bug_id,&nbsp;description,&nbsp;...)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(<em class="calibre6">'VIS-078'</em>,&nbsp;<em class="calibre6">'crashes&nbsp;on&nbsp;save'</em>,&nbsp;...);</code></span><br class="calibre1" /></div><p class="calibre_6"> The <code class="calibre15">bug_id</code> column in the previous example has similar usage to the <code class="calibre15">id</code>, in that it serves to identify each row uniquely. </p><h3 class="calibre_8">Allowing Duplicate Rows</h3><p class="calibre_6"> A compound key consists of multiple columns. One typical use for a compound key is in an intersection table like <code class="calibre15">BugsProducts</code>. The primary key should ensure that a given combination of values for <code class="calibre15">bug_id</code> and <code class="calibre15">product_id</code> appears only once in the table, even though each value may appear many times in different pairings. </p><p class="calibre_6"> However, when you use the mandatory <code class="calibre15">id</code> column as the primary key, the constraint no longer applies to two columns that should be unique. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/anti/superfluous.sql">ID-Required/anti/superfluous.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsProducts&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;BugsProducts&nbsp;(bug_id,&nbsp;product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(1234,&nbsp;1),&nbsp;(1234,&nbsp;1),&nbsp;(1234,&nbsp;1);&nbsp;<em class="calibre6">--&nbsp;duplicates&nbsp;are&nbsp;permitted</em></code></span><br class="calibre1" /></div><p class="calibre_6"> Duplicates in this intersection table cause unintended results when you use the table to match <code class="calibre15">Bugs</code> to <code class="calibre15">Products</code>. To prevent duplicates, you could declare a <code class="calibre15">UNIQUE</code> constraint over the two columns besides <code class="calibre15">id</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/anti/superfluous.sql">ID-Required/anti/superfluous.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsProducts&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;UNIQUE&nbsp;KEY&nbsp;(bug_id,&nbsp;product_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> But if you need a unique constraint over those two columns anyway, the <code class="calibre15">id</code> column is superfluous. </p><h3 class="calibre_8">Obscuring the Meaning of the Key</h3><p class="calibre_6"> The word <em class="calibre6">code</em> has a number of definitions, one of which is a way to communicate a message with brevity or secrecy. In programming, we should have the opposite goal---to make meaning clearer. </p><p class="calibre_6"> The name <code class="calibre15">id</code> is so generic that it holds no meaning. This is especially important when you join two tables and they have the same primary key column name. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/anti/ambiguous.sql">ID-Required/anti/ambiguous.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;b.id,&nbsp;a.id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;b</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">JOIN&nbsp;Accounts&nbsp;a&nbsp;ON&nbsp;(b.assigned_to&nbsp;=&nbsp;a.id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;b.status&nbsp;=&nbsp;<em class="calibre6">'OPEN'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> How do you tell the bug <code class="calibre15">id</code> from the account <code class="calibre15">id</code> in your application code if you reference columns by name instead of by ordinal position? This is a problem especially in dynamic languages like PHP, when a query result is an associative array: one column overwrites the other unless you specify column aliases in your query. </p><p class="calibre_6"> The name of the <code class="calibre15">id</code> column doesn't help make the query any clearer. But if the columns were named <code class="calibre15">bug_id</code> and <code class="calibre15">account_id</code>, the reader would have a much easier time reading the query results. We use a primary key to address individual rows of a table, so the column's name should give a clue about the type of entity in that table. </p><h3 class="calibre_8">Using USING</h3><p class="calibre_6"> You're probably familiar with the SQL syntax for a join, using the keywords <code class="calibre15">JOIN</code> and <code class="calibre15">ON</code> preceding an expression to evaluate matching rows in the two tables. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/anti/join.sql">ID-Required/anti/join.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;AS&nbsp;b&nbsp;JOIN&nbsp;BugsProducts&nbsp;AS&nbsp;bp&nbsp;ON&nbsp;(b.bug_id&nbsp;=&nbsp;bp.bug_id);</code></span><br class="calibre1" /></div><p class="calibre_6"> SQL also supports a more concise syntax for expressing a join between two tables. You can rewrite the previous query in the following way if the columns have the same name in both tables: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/anti/join.sql">ID-Required/anti/join.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;JOIN&nbsp;BugsProducts&nbsp;USING&nbsp;(bug_id);</code></span><br class="calibre1" /></div><p class="calibre_6"> However, if all tables are required to define a pseudokey primary key named <code class="calibre15">id</code>, then a foreign key column in a dependent table can never use the same name as the primary key it references. Instead, you must always use the more verbose <code class="calibre15">ON</code> syntax: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/anti/join.sql">ID-Required/anti/join.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;AS&nbsp;b&nbsp;JOIN&nbsp;BugsProducts&nbsp;AS&nbsp;bp&nbsp;ON&nbsp;(b.id&nbsp;=&nbsp;bp.bug_id);</code></span><br class="calibre1" /></div><div class="sidebar" id="calibre_link-95"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Special Scope for Sequences</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Some people allocate a value for a new row by taking the greatest value currently in use and adding one. </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15">SELECT&nbsp;MAX(bug_id)&nbsp;+&nbsp;1&nbsp;AS&nbsp;next_bug_id&nbsp;FROM&nbsp;Bugs;</code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> This isn't reliable when you have concurrent clients both querying for the next value to use. The same value could be used by both clients. This is called a <span>race condition</span>. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> To avoid the race condition, you have to block concurrent inserts while you read the current maximum value and then use it in a new row. To do this, you have to lock the whole table---row-level locking isn't enough. Table locks create a bottleneck because they cause concurrent clients to queue up for access. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Sequences solve this by operating outside of transaction scope. They never allocate the same value to multiple clients and therefore never roll back allocation of a value, whether or not you commit that value in a row. Because sequences work this way, multiple clients can generate unique values concurrently and be assured they won't try to use the same value. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Most databases support some function to return the last value a sequence generated. For example, MySQL calls this function <code class="calibre15">LAST_INSERT_ID</code>, Microsoft SQL Server uses <code class="calibre15">SCOPE_IDENTITY</code>, and Oracle uses <code class="calibre15"><em class="calibre6">SequenceName</em></code>.<code class="calibre15">CURRVAL</code>. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> These functions return the value generated during the current session, even if other clients generate their own values concurrently. No race condition exists. </blockquote></small></p></div><hr class="calibre7" /></div><h3 class="calibre_8">Compound Keys Are Hard</h3><p class="calibre_6"> Some developers refuse to use compound keys because they say these keys are too hard to use. Any expression that compares a key to another must compare all columns. A foreign key that references a compound primary key must itself be a compound foreign key. It requires more typing to use compound keys. </p><p class="calibre_6"> This refusal is like a mathematician refusing to use two-dimensional or three-dimensional coordinates, instead performing all calculations as though objects exist within a one-dimensional, linear space. It's true that this would make a lot of geometry and trigonometry much simpler, but it fails to describe real-world objects that we need to work with. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-166">
<pagebreak>
<a id="calibre_link-374">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-375">How to Recognize the Antipattern</h2><p class="calibre_6"> The symptom of this antipattern is easy to recognize: tables use the overly generic name <code class="calibre15">id</code> for the primary key. There's virtually no reason to prefer this column name over one that is more descriptive. </p><p class="calibre_6"> The following can also be evidence of the antipattern: </p><ul class="calibre_14"><li class="calibre_15"> "I don't think I need a primary key in this table." <br class="calibre_16" /> The developer who says this is confusing the term <em class="calibre6">primary key</em> with <em class="calibre6">pseudokey</em>. Every table must have a primary key <em class="calibre6">constraint</em> to prevent duplicate rows and identify individual rows. They might want to use a natural key or a compound key instead. </li><li class="calibre_15"> "How did I get duplicate many-to-many associations?" <br class="calibre_16" /> An intersection table for a many-to-many relationship should declare a primary key constraint, or at least a <span>unique key</span> constraint, over the set of foreign key columns. </li><li class="calibre_15"> "I read that database theory says I should move values to a lookup table and refer to them by ID. But I don't want to do that because I have to do a join every time I want the actual values." <br class="calibre_16" /> This is a common misunderstanding of database design theory called <span>normalization</span>, which has nothing to do with pseudokeys in reality. For more on this, see the Appendix <a href="#calibre_link-167"><em class="calibre6">Rules of Normalization</em></a>. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-250">
<pagebreak>
<a id="calibre_link-376">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-377">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> Some object-relational frameworks simplify development by assuming <span>convention over configuration</span>. They expect every table to define its primary key in the same way: as an integer pseudokey column named <code class="calibre15">id</code>. If you use such a framework, you may want to conform to its conventions, because this gives you access to other desirable features of the framework. </p><p class="calibre_6"> There's also nothing wrong with using a pseudokey, or assigning values from an auto-incrementing integer mechanism. But not every table needs a pseudokey, and it's not necessary to name every pseudokey <code class="calibre15">id</code>. </p><p class="calibre_6"> A pseudokey is a good choice as a surrogate for a natural key that's too long to be practical. For example, for a table that records attributes of a file on the filesystem, the path of the file might be a good natural key, but it would be costly to index a string column that long. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-309">
<pagebreak>
<a id="calibre_link-378">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-379">Solution: Tailored to Fit</h2><p class="calibre_6"> A primary key is a constraint, not a data type. You can declare a primary key on any column or set of columns, as long as the data types support indexing. You should also be able to define a column as an auto-incrementing integer without making it the primary key of the table. The two concepts are independent. </p><p class="calibre_6"> Don't let inflexible conventions get in the way of good design. </p><h3 class="calibre_8">Tell It Like It Is</h3><p class="calibre_6"> Choose sensible names for your primary key. The name should convey the type of entity that the primary key identifies. For example, the primary key of the <code class="calibre15">Bugs</code> table should be <code class="calibre15">bug_id</code>. </p><p class="calibre_6"> Use the same column name in foreign keys where possible. This often means that the name of a primary key should be unique within your schema; no two tables should use the same name for their primary key, unless one is also a foreign key referencing the other. However, there are exceptions: sometimes it is appropriate for a foreign key to be named differently from the primary key it references, for instance to be descriptive of the nature of the association. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/soln/foreignkey-name.sql">ID-Required/soln/foreignkey-name.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;.&nbsp;.&nbsp;.</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(reported_by)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> An industry standard exists to describe naming conventions for metadata. The standard, called ISO/IEC&nbsp;11179,<a href="#calibre_link-310" id="calibre_link-312">[4]</a> is a guideline for "managing classification schemes" in information technology systems. In other words, this is how you should name your tables and columns sensibly. Like most ISO standards, this document is nearly impenetrable, but Joe Celko applies it practically to SQL in his book <em class="calibre6">SQL Programming Style</em><a href="#calibre_link-43">[JCSPS]</a> . </p><h3 class="calibre_8">Be Unconventional</h3><p class="calibre_6"> Object-relational frameworks expect you to use a pseudokey named <code class="calibre15">id</code>, but they also allow you to override this and declare a different name instead. The following example uses Ruby on Rails:<a href="#calibre_link-311" id="calibre_link-313">[5]</a></p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/soln/custom-primarykey.rb">ID-Required/soln/custom-primarykey.rb</a></span></span></div><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;Bug&nbsp;&lt;&nbsp;ActiveRecord::Base</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;set_primary_key&nbsp;<em class="calibre6">"bug_id"</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">end</span></code></span><br class="calibre1" /></div><p class="calibre_6"> Some developers think that specifying the primary key column is necessary only when supporting <span>legacy</span> databases where they can't use their preferred conventions. In fact, supporting sensible column names is also important in new projects. </p><h3 class="calibre_8">Embrace Natural Keys and Compound Keys</h3><p class="calibre_6"> If your table contains an attribute that's guaranteed to be unique, is non-null, and can serve to identify the row, don't feel obligated to add a pseudokey solely for the sake of tradition. </p><p class="calibre_6"> Practically speaking, it's not uncommon for every attribute in a table to be subject to change or to be nonunique. Databases tend to evolve during the lifetime of a project, and decision makers may not respect the sanctity of a natural key. Sometimes a column that at first seemed like it would be a good natural key turns out to have legitimate duplicates. In those cases, a pseudokey is the only solution. </p><p class="calibre_6"> Use compound keys when they're appropriate. When a row is best identified by the combination of multiple attribute columns, as in the <code class="calibre15">BugsProducts</code> table, use those columns in a compound primary key. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/ID-Required/soln/compound.sql">ID-Required/soln/compound.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsProducts&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(bug_id,&nbsp;product_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;BugsProducts&nbsp;(bug_id,&nbsp;product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(1234,&nbsp;1),&nbsp;(1234,&nbsp;2),&nbsp;(1234,&nbsp;3);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;BugsProducts&nbsp;(bug_id,&nbsp;product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(1234,&nbsp;1);&nbsp;<em class="calibre6">--&nbsp;error:&nbsp;duplicate&nbsp;entry</em></code></span><br class="calibre1" /></div><p class="calibre_6"> Note that foreign keys that reference a compound primary key also need to be compound. This may seem clumsy to duplicate these columns in dependent tables, but they can have advantages too: you might simplify a query that would have required a join to fetch attributes of the referenced row. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Conventions are good only if they are helpful.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-312" id="calibre_link-310">[4]</a>
<small class="calibre3">
<a href="http://metadata-standards.org/11179/">http://metadata-standards.org/11179/</a>
</small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-313" id="calibre_link-311">[5]</a>
<small class="calibre3"> "Rails" and "Ruby on Rails" are trademarks of David Heinemeier Hansson. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-380"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-29">
<pagebreak>
<a id="calibre_link-381">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-130" class="calibre12"><small class="calibre13">Chapter 5</small><br class="calibre14" />Keyless Entry</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> Victorious warriors win first and then go to war, while defeated warriors go to war first and then seek to win. </em></p></div><div class="calibre1"><div class="calibre4"><span> Sun Tzu </span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> "Bill, it looks like two managers have reserved the same server in our lab for the same days---how can this happen?" the testing lab manager burst into my cube. "Can you take a look into this and get it fixed? They're screaming at me that they both need the equipment and that I'm holding up their project schedule." </p><p class="calibre_6"> I designed an equipment-tracking application some years ago using MySQL. The default storage engine for MySQL was MyISAM, which doesn't support foreign key constraints. The database had many logical relationships but could not enforce referential integrity. </p><p class="calibre_6"> As the project evolved and the application manipulated data in new ways, we developed a problem: when referential integrity wasn't satisfied, discrepancies showed up in reports, subtotals didn't add up, and schedules became double-booked. </p><p class="calibre_6"> The project manager asked me to write quality control scripts that we could run periodically to let us know when discrepancies occurred. These scripts examined the state of the database, found mistakes such as orphaned rows in child tables, and sent an email to report them. </p><p class="calibre_6"> Every table relationship had to be checked by these scripts. As the volume of data grew larger and the number of tables increased, the number of quality control queries also grew, and the scripts took longer to run. The email reports became longer too. Sound familiar? </p><p class="calibre_6"> The script solution worked, of course, but it was a costly reinvention of the wheel. What I needed was a way to make the application <span>fail early</span> whenever a user submitted invalid data. Guess what foreign key constraints do? </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-82">
<pagebreak>
<a id="calibre_link-382">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-383">Objective: Simplify Database Architecture</h2><p class="calibre_6"> Relational database design is almost as much about relationships between tables as it is about the individual tables themselves. <span>Referential integrity</span> is an important part of proper database design and operation. When you declare a foreign key constraint for a column or set of columns, the values in these columns must exist in the primary key or unique key columns of the parent table. This seems simple enough. </p><p class="calibre_6"> However, some software developers recommend avoiding referential integrity constraints. The reasons you might hear to ignore foreign keys include the following: </p><ul class="calibre_14"><li class="calibre_15"> Your data updates can conflict with the constraints. </li><li class="calibre_15"> You're using a database design that's so flexible it can't support referential integrity constraints. </li><li class="calibre_15"> You believe that the index the database creates for the foreign key will impact performance. </li><li class="calibre_15"> You use a database brand that doesn't support foreign keys. </li><li class="calibre_15"> You have to look up the syntax for declaring foreign keys. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-151">
<pagebreak>
<a id="calibre_link-384">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-385">Antipattern: Leave Out the Constraints</h2><p class="calibre_6"> Even though it seems at first that skipping foreign key constraints makes your database design simpler, more flexible, or speedier, you pay for this in other ways. It becomes your responsibility to write code to ensure referential integrity manually. </p><h3 class="calibre_8">Assuming Flawless Code</h3><p class="calibre_6"> Many people's solution for referential integrity is to write application code so that data relationships are always satisfied. Every time you insert a row, make sure that values in foreign key columns reference existing values in the referenced table. Every time you delete a row, make sure that any child tables are also updated appropriately. In other words, the popular answer is simply to <em class="calibre6">make no mistakes.</em></p><p class="calibre_6"> To avoid making referential integrity mistakes when you have no foreign key constraints, you'd have to run extra <code class="calibre15">SELECT</code> queries before you apply changes to confirm the change won't result in broken references. For instance, to insert a new row, you'd check that the parent row exists: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Keyless-Entry/anti/insert.sql">Keyless-Entry/anti/insert.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;account_id&nbsp;FROM&nbsp;Accounts&nbsp;WHERE&nbsp;account_id&nbsp;=&nbsp;1;</code></span><br class="calibre1" /></div><p class="calibre_6"> Then you could add a bug that references it: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Keyless-Entry/anti/insert.sql">Keyless-Entry/anti/insert.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Bugs&nbsp;(reported_by)&nbsp;VALUES&nbsp;(1);</code></span><br class="calibre1" /></div><p class="calibre_6"> To delete a row, you'd have to make sure no child rows exist: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Keyless-Entry/anti/delete.sql">Keyless-Entry/anti/delete.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;bug_id&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;reported_by&nbsp;=&nbsp;1;</code></span><br class="calibre1" /></div><p class="calibre_6"> Then you could delete the account: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Keyless-Entry/anti/delete.sql">Keyless-Entry/anti/delete.sql</a></span></span></div><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;Accounts&nbsp;WHERE&nbsp;account_id&nbsp;=&nbsp;1;</code></span><br class="calibre1" /></div><p class="calibre_6"> What if the user with <code class="calibre15">account_id</code>&nbsp;<code class="calibre15">1</code> sneaks in and enters a new bug in the moment after your query and before you delete that account? This may seem unlikely, but as Gordon Letwin, architect of DOS&nbsp;4, famously said, "One in a million is next Tuesday." That still leaves a broken reference---a bug reported by an account that no longer exists. </p><p class="calibre_6"> The only remedy is for you to explicitly lock the <code class="calibre15">Bugs</code> table while you're checking it and unlock it after you have finished deleting the account. Any architecture that requires that kind of locking is never going to do well when high concurrency and scalability are required. </p><h3 class="calibre_8">Checking for Mistakes</h3><p class="calibre_6"> The antisolution described in the story in this chapter uses developer-written scripts to report corrupted data. </p><p class="calibre_6"> For example, in our bugs database, the <code class="calibre15">Bugs.status</code> column references the lookup table <code class="calibre15">BugStatus</code>. To find bugs with an invalid status value, you could use a query like the following: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Keyless-Entry/anti/find-orphans.sql">Keyless-Entry/anti/find-orphans.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;b.bug_id,&nbsp;b.status</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;b&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;BugStatus&nbsp;s</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ON&nbsp;(b.status&nbsp;=&nbsp;s.status)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;s.status&nbsp;IS&nbsp;NULL;</code></span><br class="calibre1" /></div><p class="calibre_6"> You can imagine that you'd have to write a similar query for every referential relationship in your database. </p><p class="calibre_6"> If you find yourself in the habit of checking for broken references like this, your next question is, how often do you need to run these checks? Running hundreds of checks every day, or even more frequently, becomes quite a chore. </p><p class="calibre_6"> What happens when you do find a broken reference? Can you correct it? You can---sometimes. For instance, you might change an invalid bug status value to a sensible default.<a href="#calibre_link-152" id="calibre_link-17">[6]</a></p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Keyless-Entry/anti/set-default.sql">Keyless-Entry/anti/set-default.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Bugs&nbsp;SET&nbsp;status&nbsp;=&nbsp;DEFAULT&nbsp;WHERE&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'BANANA'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> Inevitably, there are other cases where you can't synthesize data to correct these kinds of mistakes. For example, the <code class="calibre15">Bugs.reported_by</code> column should reference the account of the user who reported the given bug, but if this value is invalid, which user's account should you use as a replacement? </p><h3 class="calibre_8">"It's Not My Fault!"</h3><p class="calibre_6"> It's pretty unlikely that all your code touching the database is perfect. You could easily perform similar database updates in several functions in your application. When you have to change the code, how can you be sure you've applied compatible changes to every case in your application? </p><p class="calibre_6"> You may also have users applying changes directly to the database, using an SQL query tool or through private scripts. It's easy to introduce broken references through ad hoc SQL statements. You should assume this will happen at some point in the life of your application. </p><p class="calibre_6"> You need the database to be <span>consistent</span>---that is, you need to be able to depend on references in the database being satisfied at all times. But you can't be certain that all applications and scripts that have accessed your database have made their changes correctly. </p><h3 class="calibre_8">Catch-22 Updates</h3><p class="calibre_6"> Many developers avoid foreign key constraints because the constraints make it inconvenient to update related columns in multiple tables. For instance, if you need to delete a row that other rows depend on, you have to delete the child rows first to avoid violating foreign key constraints: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Keyless-Entry/anti/delete-child.sql">Keyless-Entry/anti/delete-child.sql</a></span></span></div><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;BugStatus&nbsp;WHERE&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'BOGUS'</em>;&nbsp;<em class="calibre6">--&nbsp;ERROR!</em></code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'BOGUS'</em>;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;BugStatus&nbsp;WHERE&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'BOGUS'</em>;&nbsp;<em class="calibre6">--&nbsp;retry&nbsp;succeeds</em></code></span><br class="calibre1" /></div><p class="calibre_6"> You have to execute multiple statements manually, one for each child table. If you add another child table in a future enhancement to your database, you have to fix your code to delete from the new table too. But this problem is solvable. </p><p class="calibre_6"> The unsolvable problem is when you <code class="calibre15">UPDATE</code> a column that child rows depend on. You can't update the child rows before you update the parent, and you can't update the parent before you update the child values that reference it. You need to make both changes simultaneously, but that's impossible using two separate updates. It's a catch-22 scenario. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Keyless-Entry/anti/update-catch22.sql">Keyless-Entry/anti/update-catch22.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;BugStatus&nbsp;SET&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'INVALID'</em>&nbsp;WHERE&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'BOGUS'</em>;&nbsp;<em class="calibre6">--&nbsp;ERROR!</em></code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Bugs&nbsp;SET&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'INVALID'</em>&nbsp;WHERE&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'BOGUS'</em>;&nbsp;<em class="calibre6">--&nbsp;ERROR!</em></code></span><br class="calibre1" /></div><p class="calibre_6"> Some developers find these scenarios difficult to manage, so they decide not to use foreign keys at all. We'll see later how foreign keys address multitable updates and deletes in a simple and effective way. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-236">
<pagebreak>
<a id="calibre_link-386">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-387">How to Recognize the Antipattern</h2><p class="calibre_6"> If you hear people use phrases like the following, they're probably practicing the Keyless Entry antipattern: </p><ul class="calibre_14"><li class="calibre_15"> "How do I query to check for a value that exists in one table and not the other table?" <br class="calibre_16" /> Usually this is to find orphan child rows whose parent has been updated or deleted. </li><li class="calibre_15"> "Is there a quick way to check that a value exists in one table as part of my insert to a second table?" <br class="calibre_16" /> This is to ensure that the parent row exists. A foreign key does this for you automatically and uses any index on the parent table to make the check as efficient as possible. </li><li class="calibre_15"> "Foreign keys? I was told not to use them because they slow down the database." <br class="calibre_16" /> Performance is often used as a justification for cutting corners, but it usually creates more problems than it solves---including performance problems. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-291">
<pagebreak>
<a id="calibre_link-388">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-389">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> Sometimes you're forced to use a database brand that doesn't support foreign key constraints (for example MySQL's MyISAM storage engine or SQLite prior to version 3.6.19). If that's the case, then you have to find a way to compensate, like the quality control scripts described in this chapter's story. </p><p class="calibre_6"> There are also some ultra-flexible database designs where foreign keys can't model the relationships. It should be a strong clue that you're using another SQL antipattern if you can't use traditional referential integrity constraints. For more detail, you may want to look at the Chapter <a href="#calibre_link-102"><em class="calibre6">Entity-Attribute-Value</em></a> and the Chapter <a href="#calibre_link-185"><em class="calibre6">Polymorphic Associations</em></a>. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-15">
<pagebreak>
<a id="calibre_link-390">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-391">Solution: Declare Constraints</h2><p class="calibre_6"> The Japanese phrase <span>poka-yoke</span> means "mistake-proofing."<a href="#calibre_link-16" id="calibre_link-18">[7]</a> This term refers to a manufacturing process that helps eliminate product defects by preventing, correcting, or drawing attention to errors as they occur. This practice improves quality and decreases the need for correction, which more than makes up for the cost of its use. </p><p class="calibre_6"> You can apply the poka-yoke principle to your database design by using foreign key constraints to enforce referential integrity. Instead of searching for and correcting data integrity mistakes, you can prevent these mistakes from entering your database in the first place. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Keyless-Entry/soln/foreign-keys.sql">Keyless-Entry/soln/foreign-keys.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;.&nbsp;.&nbsp;.</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20)&nbsp;NOT&nbsp;NULL&nbsp;DEFAULT&nbsp;<em class="calibre6">'NEW'</em>,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(reported_by)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(status)&nbsp;REFERENCES&nbsp;BugStatus(status)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Your existing code and also ad hoc queries obey the same constraints, so there's no way for any forgotten code or back doors to bypass enforcement. The database rejects any improper change, no matter where the change comes from. </p><p class="calibre_6"> Using foreign keys saves you from writing unnecessary code and ensures that all your code works the same way if you change the database. This reduces the time to develop the code and also many hours of debugging and maintenance. The software industry average is 15 to 50 bugs per 1,000 lines of code. All other things being equal, if you have fewer lines of code, you have fewer bugs. </p><h3 class="calibre_8">Supporting Multitable Changes</h3><p class="calibre_6"> Foreign keys have another feature you can't mimic using application code: <span>cascading updates</span>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Keyless-Entry/soln/cascade.sql">Keyless-Entry/soln/cascade.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;.&nbsp;.&nbsp;.</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20)&nbsp;NOT&nbsp;NULL&nbsp;DEFAULT&nbsp;<em class="calibre6">'NEW'</em>,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(reported_by)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;UPDATE&nbsp;CASCADE</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;DELETE&nbsp;RESTRICT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(status)&nbsp;REFERENCES&nbsp;BugStatus(status)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;UPDATE&nbsp;CASCADE</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;DELETE&nbsp;SET&nbsp;DEFAULT</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> This solution allows you to update or delete the parent row and lets the database takes care of any child rows that reference it. Updates to the parent tables <code class="calibre15">BugStatus</code> and <code class="calibre15">Accounts</code> propagate automatically to child rows in <code class="calibre15">Bugs</code>. There's no longer a catch-22 problem. </p><p class="calibre_6"> The way you declare the <code class="calibre15">ON&nbsp;UPDATE</code> or <code class="calibre15">ON&nbsp;DELETE</code> clauses in the foreign key constraint allow you to control the result of a cascading operation. For example, <code class="calibre15">RESTRICT</code> for the foreign key on <code class="calibre15">reported_by</code> means that you can't delete an account if some rows in <code class="calibre15">Bugs</code> reference it. The constraint blocks the delete and raises an error. Whereas if you delete a <code class="calibre15">status</code> value, any bugs with that status are automatically reset to the default status value. </p><p class="calibre_6"> In either case, the database changes both tables atomically. The foreign key references remain satisfied both before and after the changes. </p><p class="calibre_6"> If you add a new child table to the database, the foreign keys in the child table dictate the cascading behavior. You don't need to change your application code. Neither do you need to change anything about the parent table, no matter how many child tables reference it. </p><h3 class="calibre_8">Overhead? Not Really</h3><p class="calibre_6"> It's true that foreign key constraints have a bit of overhead. But compared to the alternative, foreign keys prove to be a lot more efficient. </p><ul class="calibre_14"><li class="calibre_15"> You don't need to run <code class="calibre15">SELECT</code> queries to check before you insert or update or delete. </li><li class="calibre_15"> You don't need to lock tables to protect multitable changes. </li><li class="calibre_15"> You don't need to run periodic quality control scripts to correct the inevitable orphans. </li></ul><p class="calibre_6"> Foreign keys are easy to use, improve performance, and help you maintain consistent referential integrity during any data change, both simple and complex. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Make your database mistake-proof with constraints.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-17" id="calibre_link-152">[6]</a>
<small class="calibre3"> SQL supports using the keyword <code class="calibre15">DEFAULT</code> as shown. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-18" id="calibre_link-16">[7]</a>
<small class="calibre3"> Poka-yoke was coined by industrial engineer Dr. Shigeo Shingo in his study of the Toyota Production System. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-392"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-72">
<pagebreak>
<a id="calibre_link-393">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-102" class="calibre12"><small class="calibre13">Chapter 6</small><br class="calibre14" />Entity-Attribute-Value</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> If you try and take a cat apart to see how it works, the first thing you have in your hands is a non-working cat. </em></p></div><div class="calibre1"><div class="calibre4"><span> Douglas Adams </span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> "How do I count the number of rows by date?" This is an example of a simple task for a database programmer. This solution is covered in any introductory tutorial on SQL. It involves basic SQL syntax: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/intro/count.sql">EAV/intro/count.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;date_reported,&nbsp;COUNT(*)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;date_reported;</code></span><br class="calibre1" /></div><p class="calibre_6"> However, the simple solution assumes two things: </p><ul class="calibre_14"><li class="calibre_15"> Values are stored in the same column, as in <code class="calibre15">Bugs.date_reported</code>. </li><li class="calibre_15"> Values can be compared to one another so that <code class="calibre15">GROUP&nbsp;BY</code> can accurately group dates with equal values together. </li></ul><p class="calibre_6"> What if you can't rely on those assumptions? What if the date is stored in the <code class="calibre15">date_reported</code> or <code class="calibre15">report_date</code> column or in any other column name that may be different on each row? What if dates can take a variety of different formats and the computer can't easily compare two dates? </p><p class="calibre_6"> You may encounter these problems and others when you employ the antipattern known as Entity-Attribute-Value. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-116">
<pagebreak>
<a id="calibre_link-394">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-395">Objective: Support Variable Attributes</h2><p class="calibre_6"> Extensibility is frequently a goal of software projects. We would like to design software that can adapt fluidly to future usage with little or no additional programming. </p><p class="calibre_6"> This is not a new problem; similar arguments against the inflexibility of relational database metadata have been made almost continuously since 1970, when the relational model was first proposed in <em class="calibre6">A Relational Model of Data for Large Shared Data Banks</em><a href="#calibre_link-43">[ARMODFLSDB]</a> by E.&nbsp;F.&nbsp;Codd. </p><p class="calibre_6"> A conventional table consists of attribute columns that are relevant for every row in the table, since every row represents an instance of a similar object. A different set of attributes represents a different type of object, so it belongs in a different table. </p><p class="calibre_6"> In modern object-oriented programming models, however, different object types can be related, for instance, by extending the same base type. In object-oriented design, these objects are considered instances of the same base type, as well as instances of their respective subtypes. We would like to store objects as rows in a single database table to simplify comparisons and calculations over multiple objects. But we also need to allow objects of each subtype to store their respective attribute columns, which may not apply to the base type or to other subtypes. </p><p class="calibre_6"> Let's use an example from our bugs database. In Figure <a href="#calibre_link-117"><em class="calibre6">Object-oriented class diagram for bug types</em></a>, we can see that a <code class="calibre15">Bug</code> and a <code class="calibre15">Feature Request</code> share some attributes in common, seen in the <code class="calibre15">Issue</code> base type. Every issue is associated with a person who reported it. It's also associated with a product, and it has a priority for completion. However, a <code class="calibre15">Bug</code> has some distinct attributes: the version of the product in which the bug occurs and the severity or impact of the bug. Likewise, a <code class="calibre15">FeatureRequest</code> may have its own attributes as well. For this example, suppose a feature is associated with a sponsor whose budget supports that feature's development. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="EAV/bug-types.jpg" src="images/000016.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-117" class="calibre10">Figure 1. Object-oriented class diagram for bug types</span></td></tr></table></div><br class="calibre1" /></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-191">
<pagebreak>
<a id="calibre_link-396">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-397">Antipattern: Use a Generic Attribute Table</h2><p class="calibre_6"> The solution that appeals to some programmers when they need to support variable attributes is to create a second table, storing attributes as rows. See the diagram showing the two tables in Figure <a href="#calibre_link-192"><em class="calibre6">EAV entity relationship</em></a>. Each row in this attribute table has three columns: </p><ul class="calibre_14"><li class="calibre_15"> The <span>Entity</span>. Typically this is a foreign key to a parent table that has one row per entity. </li><li class="calibre_15"> The <span>Attribute</span>. This is simply the name of a column in a conventional table, but in this new design, we have to identify the attribute on each given row. </li><li class="calibre_15"> The <span>Value</span>. Each entity has a value for each of its attributes. <br class="calibre_16" /> For example, a given bug is an entity we identify by its primary key value 1234. It has an attribute called <code class="calibre15">status</code>. The value of that attribute for bug 1234 is <code class="calibre15">NEW</code>. </li></ul><p class="calibre_6"> This design is called Entity-Attribute-Value, or <span>EAV</span> for short. It's also sometimes called <span>open schema</span>, <span>schemaless</span>, or <span>name-value pairs</span>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/anti/create-eav-table.sql">EAV/anti/create-eav-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Issues&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Issues&nbsp;(issue_id)&nbsp;VALUES&nbsp;(1234);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;IssueAttributes&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;attr_name&nbsp;&nbsp;&nbsp;VARCHAR(100)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;attr_value&nbsp;&nbsp;VARCHAR(100),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(issue_id,&nbsp;attr_name),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(issue_id)&nbsp;REFERENCES&nbsp;Issues(issue_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;IssueAttributes&nbsp;(issue_id,&nbsp;attr_name,&nbsp;attr_value)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;(1234,&nbsp;<em class="calibre6">'product'</em>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">'1'</em>),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;(1234,&nbsp;<em class="calibre6">'date_reported'</em>,&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">'2009-06-01'</em>),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;(1234,&nbsp;<em class="calibre6">'status'</em>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">'NEW'</em>),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;(1234,&nbsp;<em class="calibre6">'description'</em>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">'Saving&nbsp;does&nbsp;not&nbsp;work'</em>),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;(1234,&nbsp;<em class="calibre6">'reported_by'</em>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">'Bill'</em>),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;(1234,&nbsp;<em class="calibre6">'version_affected'</em>,&nbsp;<em class="calibre6">'1.0'</em>),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;(1234,&nbsp;<em class="calibre6">'severity'</em>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">'loss&nbsp;of&nbsp;functionality'</em>),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;(1234,&nbsp;<em class="calibre6">'priority'</em>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">'high'</em>);</code></span><br class="calibre1" /></div><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="EAV/eav-table.jpg" src="images/000014.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-192" class="calibre10">Figure 2. EAV entity relationship</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> By adding one additional table, you seem to gain the following benefits: </p><ul class="calibre_14"><li class="calibre_15"> Both tables have few columns. </li><li class="calibre_15"> The number of columns doesn't need to grow to support new attributes. </li><li class="calibre_15"> You avoid a clutter of columns that contain null in rows where the attribute is inapplicable. </li></ul><p class="calibre_6"> This appears to be an improved design. However, the simple database structure doesn't make up for the difficulty of using it. </p><h3 class="calibre_8">Querying an Attribute</h3><p class="calibre_6"> Your boss needs to run a report of the bugs reported per day. In a conventional table design, the <code class="calibre15">Issues</code> table would have a simple attribute column such as <code class="calibre15">date_reported</code>. To query all bugs with their report dates, your boss could use a simple query like this: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/anti/query-plain.sql">EAV/anti/query-plain.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;issue_id,&nbsp;date_reported&nbsp;FROM&nbsp;Issues;</code></span><br class="calibre1" /></div><p class="calibre_6"> To get the same information as the previous query using the EAV design, your boss needs to fetch rows from the <code class="calibre15">IssueAttributes</code> table that stores an attribute named by the string <code class="calibre15">date_reported</code>. This query is more verbose but less clear. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/anti/query-eav.sql">EAV/anti/query-eav.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;issue_id,&nbsp;attr_value&nbsp;AS&nbsp;<em class="calibre6">"date_reported"</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;IssueAttributes</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;attr_name&nbsp;=&nbsp;<em class="calibre6">'date_reported'</em>;</code></span><br class="calibre1" /></div><h3 class="calibre_8">Supporting Data Integrity</h3><p class="calibre_6"> When you use EAV, you sacrifice many advantages that a conventional database design would have given you. </p><h4 class="calibre_18">You Can't Make Mandatory Attributes</h4><p class="calibre_6"> To help your boss generate accurate project reports, you should also require that the <code class="calibre15">date_reported</code> attribute has a value. In a conventional database design, it would be simple to enforce a mandatory column by declaring the column <code class="calibre15">NOT&nbsp;NULL</code>. </p><p class="calibre_6"> In the EAV design, each attribute corresponds to a row in the <code class="calibre15">IssueAttributes</code> table, not a column. You would need a constraint that checks that a row exists for each <code class="calibre15">issue_id</code> value, and the row must have the string <code class="calibre15">date_reported</code> in its <code class="calibre15">attr_name</code> column. </p><p class="calibre_6"> However, SQL doesn't support a constraint that can do this. So, you must write application code to enforce it. If you do find a bug with no reported date, should you add a value for this attribute? What value should you give it? If you make a guess or use some default value for a missing attribute, how does that affect the accuracy of your boss's reports? </p><h4 class="calibre_18">You Can't Use SQL Data Types</h4><p class="calibre_6"> Your boss tells you he is having trouble running his report because people have entered dates in different formats or sometimes even a string that isn't a date. In a conventional database, you can prevent this if you declared the column with the <code class="calibre15">DATE</code> data type. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/anti/insert-plain.sql">EAV/anti/insert-plain.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Issues&nbsp;(date_reported)&nbsp;VALUES&nbsp;(<em class="calibre6">'banana'</em>);&nbsp;<em class="calibre6">--&nbsp;ERROR!</em></code></span><br class="calibre1" /></div><p class="calibre_6"> In the EAV design, the data type of the <code class="calibre15">IssueAttributes.attr_value</code> column is typically a string to accommodate all possible attributes in a single column. So, it has no way of rejecting invalid data. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/anti/insert-eav.sql">EAV/anti/insert-eav.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;IssueAttributes&nbsp;(issue_id,&nbsp;attr_name,&nbsp;attr_value)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(1234,&nbsp;<em class="calibre6">'date_reported'</em>,&nbsp;<em class="calibre6">'banana'</em>);&nbsp;&nbsp;<em class="calibre6">--&nbsp;Not&nbsp;an&nbsp;error!</em></code></span><br class="calibre1" /></div><p class="calibre_6"> Some people try to extend the EAV design by defining a separate <code class="calibre15">attr_</code><code class="calibre15">value</code> column for each SQL data type, leaving null in the unused columns. This allows you to use data types but makes queries even worse: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/anti/data-types.sql">EAV/anti/data-types.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;issue_id,&nbsp;COALESCE(attr_value_date,&nbsp;attr_value_datetime,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;attr_value_integer,&nbsp;attr_value_numeric,&nbsp;attr_value_float,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;attr_value_string,&nbsp;attr_value_text)&nbsp;AS&nbsp;<em class="calibre6">"date_reported"</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;IssueAttributes</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;attr_name&nbsp;=&nbsp;<em class="calibre6">'date_reported'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> You would need to add even more columns to support user-defined data types or domains. </p><h4 class="calibre_18">You Can't Enforce Referential Integrity</h4><p class="calibre_6"> In a conventional database, you can restrict the range of some attributes by defining a foreign key to a lookup table. For example, the <code class="calibre15">status</code> attribute of a bug or issue should be one of a short list of values stored in the <code class="calibre15">BugStatus</code> table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/anti/foreign-key-plain.sql">EAV/anti/foreign-key-plain.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Issues&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;other&nbsp;columns</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20)&nbsp;NOT&nbsp;NULL&nbsp;DEFAULT&nbsp;<em class="calibre6">'NEW'</em>,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(status)&nbsp;REFERENCES&nbsp;BugStatus(status)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> In the EAV design, you can't apply this kind of constraint on the <code class="calibre15">attr_</code><code class="calibre15">value</code> column. A referential integrity constraint applies to every row in the table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/anti/foreign-key-eav.sql">EAV/anti/foreign-key-eav.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;IssueAttributes&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;attr_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(100)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;attr_value&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(100),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(attr_value)&nbsp;REFERENCES&nbsp;BugStatus(status)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> If you define this constraint, it would force <em class="calibre6">every</em> attribute to match a value in <code class="calibre15">BugStatus</code>, not just the <code class="calibre15">status</code> attribute. </p><h4 class="calibre_18">You Can't Make Up Attribute Names</h4><p class="calibre_6"> Your boss' reports are still not reliable. You find that attributes are not being named consistently. One bug uses an attribute named by the string <code class="calibre15">date_reported</code>, but another bug names the attribute by the string <code class="calibre15">report_date</code>. Both are clearly intended to represent the same information. </p><p class="calibre_6"> How would you count bugs per date? </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/anti/count.sql">EAV/anti/count.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;date_reported,&nbsp;COUNT(*)&nbsp;AS&nbsp;bugs_per_date</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;(SELECT&nbsp;DISTINCT&nbsp;issue_id,&nbsp;attr_value&nbsp;AS&nbsp;date_reported</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;IssueAttributes</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;attr_name&nbsp;IN&nbsp;(<em class="calibre6">'date_reported'</em>,&nbsp;<em class="calibre6">'report_date'</em>))</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;date_reported;</code></span><br class="calibre1" /></div><p class="calibre_6"> How would you know if a given bug has stored an attribute by yet another name? How would you know if a given bug has stored a given attribute twice, by two different names? How can you prevent such mistakes? </p><p class="calibre_6"> One remedy might be to declare a foreign key on the <code class="calibre15">attr_name</code> column to a lookup table that contains your approved attribute names. However, this doesn't support attributes you define on the fly for each entity. That's a common use of the EAV design. </p><h3 class="calibre_8">Reconstructing a Row</h3><p class="calibre_6"> It's natural to retrieve a row from the <code class="calibre15">Issues</code> table with all its attributes in columns. You want to fetch an issue in a single row as though it were stored in a conventional table. </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">issue_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">date_reported</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">status</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">priority</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">description</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1234</p></td><td class="calibre19"><p class="calibre_6">2009-06-01</p></td><td class="calibre19"><p class="calibre_6">NEW</p></td><td class="calibre19"><p class="calibre_6">HIGH</p></td><td class="calibre19"><p class="calibre_6">Saving does not work</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> Because each attribute is stored on a separate row of the <code class="calibre15">IssueAttributes</code> table, retrieving them all as part of a single row requires a join for each attribute. You must know all attributes at the time you write this query. The following query reconstructs the row shown earlier: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/anti/reconstruct.sql">EAV/anti/reconstruct.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;i.issue_id,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;i1.attr_value&nbsp;AS&nbsp;<em class="calibre6">"date_reported"</em>,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;i2.attr_value&nbsp;AS&nbsp;<em class="calibre6">"status"</em>,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;i3.attr_value&nbsp;AS&nbsp;<em class="calibre6">"priority"</em>,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;i4.attr_value&nbsp;AS&nbsp;<em class="calibre6">"description"</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Issues&nbsp;AS&nbsp;i</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;IssueAttributes&nbsp;AS&nbsp;i1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;i.issue_id&nbsp;=&nbsp;i1.issue_id&nbsp;AND&nbsp;i1.attr_name&nbsp;=&nbsp;<em class="calibre6">'date_reported'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;IssueAttributes&nbsp;AS&nbsp;i2</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;i.issue_id&nbsp;=&nbsp;i2.issue_id&nbsp;AND&nbsp;i2.attr_name&nbsp;=&nbsp;<em class="calibre6">'status'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;IssueAttributes&nbsp;AS&nbsp;i3</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;i.issue_id&nbsp;=&nbsp;i3.issue_id&nbsp;AND&nbsp;i3.attr_name&nbsp;=&nbsp;<em class="calibre6">'priority'</em>;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;IssueAttributes&nbsp;AS&nbsp;i4</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;i.issue_id&nbsp;=&nbsp;i4.issue_id&nbsp;AND&nbsp;i4.attr_name&nbsp;=&nbsp;<em class="calibre6">'description'</em>;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;i.issue_id&nbsp;=&nbsp;1234;</code></span><br class="calibre1" /></div><p class="calibre_6"> You must use outer joins because inner joins would cause the query to return no rows if any one of the attributes were not present in the <code class="calibre15">IssueAttributes</code> table. As the number of attributes increases, so does the number of joins, and the cost of this query increases exponentially. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-280">
<pagebreak>
<a id="calibre_link-398">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-399">How to Recognize the Antipattern</h2><p class="calibre_6"> If you hear phrases like the following spoken by your project team, it's a clue that someone is employing the EAV antipattern: </p><ul class="calibre_14"><li class="calibre_15"> "This database is totally extensible without metadata changes. You can define new attributes at runtime." <br class="calibre_16" /> Relational databases don't support that degree of flexibility. When someone claims to have designed an arbitrarily extensible database, they're probably using the EAV design. </li><li class="calibre_15"> "What's the maximum number of joins I can do in a query?" <br class="calibre_16" /> If you need a query to support such a high number of joins that you're concerned about exceeding the database's limits, you may have a problem in your database design. It's common for an EAV design to lead to this problem. </li><li class="calibre_15"> "I can't figure out how to write a report for our e-commerce platform. We need to hire a consultant to do it for us." <br class="calibre_16" /> It seems that many turnkey database-driven software packages designed for customizability use the EAV design. This makes most common reporting queries very complex or even impractical. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-30">
<pagebreak>
<a id="calibre_link-400">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-401">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> It's hard to justify using the EAV antipattern in a relational database. You have to compromise too many features that are strengths of the relational paradigm. But that doesn't address the legitimate need in some applications to support dynamic attributes. </p><p class="calibre_6"> Most applications that need schemaless data really need it for only a few tables or even just one table. The rest of your data requirements conform to standard table designs. If you account for the extra work and risk of EAV in your project plan, it may be the lesser evil to use it sparingly. But keep in mind that experienced database consultants report that systems using EAV become unwieldy within a year. </p><p class="calibre_6"> If you have nonrelational data management needs, the best answer is to use a <span>nonrelational</span> technology. This is a book about SQL, not about SQL alternatives, so I'll list only a sampling of these technologies: </p><ul class="calibre_14"><li class="calibre_15"><span>Berkeley DB</span> is a popular key-value store that's easy to embed in a variety of applications. <br class="calibre_16" /><a href="http://www.oracle.com/technology/products/berkeley-db/">http://www.oracle.com/technology/products/berkeley-db/</a></li><li class="calibre_15"><span>Cassandra</span> is a distributed column-oriented database developed at Facebook and contributed to the Apache project. <br class="calibre_16" /><a href="http://incubator.apache.org/cassandra/">http://incubator.apache.org/cassandra/</a></li><li class="calibre_15"><span>CouchDB</span> is a document-oriented database---a distributed key-value store that encodes values in JSON. <br class="calibre_16" /><a href="http://couchdb.apache.org/">http://couchdb.apache.org/</a></li><li class="calibre_15"><span>Hadoop</span> and <span>HBase</span> make up an open source DBMS inspired by Google's MapReduce algorithm for distributing queries against very large-scale semistructured data stores. <br class="calibre_16" /><a href="http://hadoop.apache.org/">http://hadoop.apache.org/</a></li><li class="calibre_15"><span>MongoDB</span> is a document-oriented database like CouchDB. <br class="calibre_16" /><a href="http://www.mongodb.org/">http://www.mongodb.org/</a></li><li class="calibre_15"><span>Redis</span> is a document-oriented in-memory database. <br class="calibre_16" /><a href="http://code.google.com/p/redis/">http://code.google.com/p/redis/</a></li><li class="calibre_15"><span>Tokyo Cabinet</span> is a key-value store, designed in the vein of POSIX DBM, GNU GDBM, or Berkeley DB. <br class="calibre_16" /><a href="http://1978th.net/">http://1978th.net/</a></li></ul><p class="calibre_6"> Many other nonrelational projects are also emerging. However, the weaknesses of EAV relative to relational databases also apply to these alternatives. When metadata is fluid, it's harder to formulate simple queries. Applications spend a lot of energy discovering the structure of data and adapting to it. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-83">
<pagebreak>
<a id="calibre_link-402">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-403">Solution: Model the Subtypes</h2><p class="calibre_6"> If EAV seems like the right design, you should take a second look before you implement it. If you do some good old-fashioned analysis, you will probably find that your project's data can be modeled in a traditional table design more easily and with greater assurance of data integrity. </p><p class="calibre_6"> There are several ways to store such data without using EAV. Most solutions work best when you have a finite number of subtypes and you know the attribute of each subtype. Which solution is best to use depends on how you intend to query the data, so you should decide on a design on a case-by-case basis. </p><h3 id="calibre_link-120" class="calibre_8">Single Table Inheritance</h3><p class="calibre_6"> The simplest design is to store all related types in one table, with distinct columns for every attribute that exists in any type. Use one attribute to define the subtype of a given row. In this example, this attribute is called <code class="calibre15">issue_type</code>. Some attributes are common to all subtypes. Many attributes are subtype-specific, and these columns must be given a null value on any row storing an object for which the attribute does not apply; the columns with non-null values become sparse. </p><p class="calibre_6"> The name of this design comes from Martin Fowler's book <em class="calibre6">Patterns of Enterprise Application Architecture</em><a href="#calibre_link-47">[POEAA]</a> . </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/soln/create-sti-table.sql">EAV/soln/create-sti-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Issues&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;priority&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;version_resolved&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(10),&nbsp;&nbsp;<em class="calibre6">--&nbsp;BUG&nbsp;or&nbsp;FEATURE</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;severity&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),&nbsp;&nbsp;<em class="calibre6">--&nbsp;only&nbsp;for&nbsp;bugs</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;version_affected&nbsp;VARCHAR(20),&nbsp;&nbsp;<em class="calibre6">--&nbsp;only&nbsp;for&nbsp;bugs</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;sponsor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(50),&nbsp;&nbsp;<em class="calibre6">--&nbsp;only&nbsp;for&nbsp;feature&nbsp;requests</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(reported_by)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> As new object types are introduced, the database must accommodate the attributes that describe these new object types. You must alter the table to add more columns as you add distinct attributes for the new object types. You may encounter a practical limit on the number of columns per table. </p><p class="calibre_6"> Another limitation of Single Table Inheritance is that there is no metadata to define which attributes belong to which subtypes. In your application, you can ignore some attributes if you know they don't apply to the object subtype on a given row. But you must track manually which attributes are applicable to each subtype. It would be better if you could use metadata to define this in the database. </p><p class="calibre_6"> Single Table Inheritance is best when you have few subtypes and few subtype-specific attributes, and you need to use a single-table database access pattern like Active Record. </p><h3 id="calibre_link-86" class="calibre_8">Concrete Table Inheritance</h3><p class="calibre_6"> Another solution is to create a separate table for each subtype. Every table contains the same attributes that are common to the base type, as well as the respective subtype-specific attribute. The name of this design also comes from Martin Fowler's book. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/soln/create-concrete-tables.sql">EAV/soln/create-concrete-tables.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;priority&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;version_resolved&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;severity&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),&nbsp;<em class="calibre6">--&nbsp;only&nbsp;for&nbsp;bugs</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;version_affected&nbsp;VARCHAR(20),&nbsp;<em class="calibre6">--&nbsp;only&nbsp;for&nbsp;bugs</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(reported_by)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;FeatureRequests&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;priority&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;version_resolved&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;sponsor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(50),&nbsp;&nbsp;<em class="calibre6">--&nbsp;only&nbsp;for&nbsp;feature&nbsp;requests</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(reported_by)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> An advantage of Concrete Table Inheritance over Single Table Inheritance is that you are prevented from storing a row containing values for attributes that don't apply to that row's subtype. If you reference an attribute column that doesn't exist in that table, the database informs you of the error automatically. For example, the <code class="calibre15">severity</code> column does not appear in the <code class="calibre15">FeatureRequests</code> table: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/soln/insert-concrete.sql">EAV/soln/insert-concrete.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;FeatureRequests&nbsp;(issue_id,&nbsp;severity)&nbsp;VALUES&nbsp;(&nbsp;...&nbsp;);&nbsp;<em class="calibre6">--&nbsp;ERROR!</em></code></span><br class="calibre1" /></div><p class="calibre_6"> Another advantage of Concrete Table Inheritance is that you don't need an extra attribute to define the subtype on each row, as you do in the Single Table Inheritance design. </p><p class="calibre_6"> However, it's hard to tell the common attributes from subtype-specific attributes. Also, if you add a new attribute to the set of common attributes, you must alter every subtype table. </p><p class="calibre_6"> No metadata shows that the data stored in these subtype tables belong to related objects. That is, if a programmer new to your project looks at the table definitions, he would see that some columns are common to all these subtype tables, but the metadata does not tell him whether any logical relationship exists or whether the tables have similarities merely by coincidence. </p><p class="calibre_6"> If you want to search all objects regardless of their subtypes, this is complicated if each subtype is stored in a separate table. To make this query easier, define a view that is the union of the tables, selecting only common attributes. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/soln/view-concrete.sql">EAV/soln/view-concrete.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;VIEW&nbsp;Issues&nbsp;AS</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;b.*,&nbsp;<em class="calibre6">'bug'</em>&nbsp;AS&nbsp;issue_type</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FROM&nbsp;Bugs&nbsp;AS&nbsp;b</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;UNION&nbsp;ALL</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;f.*,&nbsp;<em class="calibre6">'feature'</em>&nbsp;AS&nbsp;issue_type</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FROM&nbsp;FeatureRequests&nbsp;AS&nbsp;f;</code></span><br class="calibre1" /></div><p class="calibre_6"> The Concrete Table Inheritance design is best used when you seldom need to query against all subtypes at once. </p><h3 id="calibre_link-121" class="calibre_8">Class Table Inheritance</h3><p class="calibre_6"> A third solution mimics inheritance, as though tables were object-oriented classes. Create a single table for the base type, containing attributes common to all subtypes. Then for each subtype, create another table, with a primary key that also serves as a foreign key to the base table. The name of this design also comes from Martin Fowler's book. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/soln/create-class-tables.sql">EAV/soln/create-class-tables.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Issues&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;priority&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;version_resolved&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(reported_by)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;severity&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;version_affected&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(issue_id)&nbsp;REFERENCES&nbsp;Issues(issue_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;FeatureRequests&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;sponsor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(50),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(issue_id)&nbsp;REFERENCES&nbsp;Issues(issue_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> The one-to-one relationship is enforced by the metadata, since the dependent table's foreign key is also a primary key and thus must be unique. This solution provides an efficient way to search against all subtypes, as long as your search references only the base type's attributes. Once you've found the entries that match your search, you can get the subtype-specific attributes by querying against the respective subtype tables. </p><p class="calibre_6"> You don't need to know from the row in the base table what subtype the row represents; as long as you have a small number of subtypes, you can write a join against all of them at once, producing a sparse result set like in the Single Table Inheritance table. Attributes are null where the attribute doesn't apply in the subtype for a given row. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/soln/select-class.sql">EAV/soln/select-class.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;i.*,&nbsp;b.*,&nbsp;f.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Issues&nbsp;AS&nbsp;i</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Bugs&nbsp;AS&nbsp;b&nbsp;USING&nbsp;(issue_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;FeatureRequests&nbsp;AS&nbsp;f&nbsp;USING&nbsp;(issue_id);</code></span><br class="calibre1" /></div><p class="calibre_6"> This is also a good candidate for defining a <code class="calibre15">VIEW</code>. </p><p class="calibre_6"> This design is best when you often need to query across all subtypes, referencing the columns they have in common. </p><h3 class="calibre_8">Semistructured Data</h3><p class="calibre_6"> If you have many subtypes or if you must support new attributes frequently, you can add a <code class="calibre15">BLOB</code> column to store data in a format such as XML or JSON, which encodes both the attribute names and their values. Martin Fowler calls this pattern the <span>Serialized&nbsp;LOB</span>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/soln/create-blob-tables.sql">EAV/soln/create-blob-tables.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Issues&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;priority&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;version_resolved&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(10),&nbsp;&nbsp;&nbsp;<em class="calibre6">--&nbsp;BUG&nbsp;or&nbsp;FEATURE</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;attributes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT&nbsp;NOT&nbsp;NULL,&nbsp;<em class="calibre6">--&nbsp;all&nbsp;dynamic&nbsp;attributes&nbsp;for&nbsp;the&nbsp;row</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(reported_by)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> The advantage of this design is that it's completely extensible. You can store new attributes in the blob at any time. Every row stores a potentially distinct set of attributes, so you have as many subtypes as you have rows. </p><p class="calibre_6"> The disadvantage is that SQL has little support for accessing specific attributes in such a structure. You can't easily select individual attributes within the blob for row-based restriction, aggregate calculation, sorting, or other operations. You must fetch the whole blob of attributes as a single value and write application code to decode and interpret the attributes. </p><p class="calibre_6"> This design is best when you can't limit yourself to a finite set of subtypes and when you need complete flexibility to define new attributes at any time. </p><h3 class="calibre_8">Post-Processing</h3><p class="calibre_6"> Unfortunately, sometimes you're stuck with the EAV design, such as if you inherited a project and can't change it or if your company acquired a third-party software platform that uses EAV. If this is the case, familiarize yourself with the trouble areas in the "Antipattern" section so you can anticipate and plan for the extra work it takes to work with this design. </p><p class="calibre_6"> Above all, don't try to write queries that fetch entities as a single row as though data were stored in a conventional table. Instead, query the attributes associated with the entity and fetch them as a set of rows, like they are stored. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/soln/post-process.sql">EAV/soln/post-process.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;issue_id,&nbsp;attr_name,&nbsp;attr_value</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;IssueAttributes</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;issue_id&nbsp;=&nbsp;1234;</code></span><br class="calibre1" /></div><p class="calibre_6"> The result of this query might look like the following: </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">issue_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">attr_name</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">attr_value</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1234</p></td><td class="calibre19"><p class="calibre_6">date_reported</p></td><td class="calibre19"><p class="calibre_6">2009-06-01</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1234</p></td><td class="calibre19"><p class="calibre_6">description</p></td><td class="calibre19"><p class="calibre_6">Saving does not work</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1234</p></td><td class="calibre19"><p class="calibre_6">priority</p></td><td class="calibre19"><p class="calibre_6">HIGH</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1234</p></td><td class="calibre19"><p class="calibre_6">product</p></td><td class="calibre19"><p class="calibre_6">Open RoundFile</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1234</p></td><td class="calibre19"><p class="calibre_6">reported_by</p></td><td class="calibre19"><p class="calibre_6">Bill</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1234</p></td><td class="calibre19"><p class="calibre_6">severity</p></td><td class="calibre19"><p class="calibre_6">loss of functionality</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1234</p></td><td class="calibre19"><p class="calibre_6">status</p></td><td class="calibre19"><p class="calibre_6">NEW</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> This query is easier for you to write, and it's easier for the database to process. It returns all the attributes associated with the issue, even if you don't know how many there are when you write the query. </p><p class="calibre_6"> To use a result in this format, you need to write application code to loop over the rows of the result set and set properties of an object in your application. See the following PHP code for an example: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/EAV/soln/post-process.php">EAV/soln/post-process.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$objects&nbsp;=&nbsp;<span class="calibre10">array</span>();</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;"SELECT&nbsp;issue_id,&nbsp;attr_name,&nbsp;attr_value</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;IssueAttributes</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;issue_id&nbsp;=&nbsp;1234");</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">while</span>&nbsp;($row&nbsp;=&nbsp;$stmt-&gt;fetch())&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;$id&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$row[<em class="calibre6">'issue_id'</em>];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;$field&nbsp;=&nbsp;$row[<em class="calibre6">'attr_name'</em>];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;$value&nbsp;=&nbsp;$row[<em class="calibre6">'attr_value'</em>];</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">if</span>&nbsp;(!array_key_exists($id,&nbsp;$objects))&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$objects[$id]&nbsp;=&nbsp;<span class="calibre10">new</span>&nbsp;stdClass();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;$objects[$id]-&gt;$field&nbsp;=&nbsp;$value;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /></div><p class="calibre_6"> This might seem like too much work, but it's the consequence of a system-within-a-system like EAV. SQL already offers a way to identify distinct attributes---in distinct columns. By using EAV, you're layering onto SQL a new way to identify attributes, so it should be no surprise that SQL supports this awkwardly and inefficiently. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Use metadata for metadata.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-404"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-84">
<pagebreak>
<a id="calibre_link-405">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-185" class="calibre12"><small class="calibre13">Chapter 7</small><br class="calibre14" />Polymorphic Associations</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> Of course, some people do go both ways. </em></p></div><div class="calibre1"><div class="calibre4"><span> The Scarecrow, The Wizard of Oz </span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> Let's allow users to make <span>comments</span> on bugs. A given bug may have many comments, but any given comment must pertain to a single bug. So, there's a one-to-many relationship between <code class="calibre15">Bugs</code> and <code class="calibre15">Comments</code>. The entity-relationship diagram for this kind of simple association is shown in Figure <a href="#calibre_link-85"><em class="calibre6">Simple association</em></a>, and the following SQL shows how you would create this table: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/intro/comments.sql">Polymorphic/intro/comments.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Comments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;author_id&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_date&nbsp;DATETIME&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(author_id)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> However, you might have two tables you can comment on. <code class="calibre15">Bugs</code> and <code class="calibre15">FeatureRequests</code> are similar entities, although you might store them as separate tables (see the section <a href="#calibre_link-86"><em class="calibre6">Concrete Table Inheritance</em></a>). You'd like to store <code class="calibre15">Comments</code> in a single table regardless of whether they pertain to either type of issue---a bug or a feature---but you can't declare a foreign key that references multiple parent tables. The following declaration is nonsense: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/intro/nonsense.sql">Polymorphic/intro/nonsense.sql</a></span></span></div><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;...</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(issue_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REFERENCES&nbsp;Bugs(issue_id)&nbsp;OR&nbsp;FeatureRequests(issue_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Developers also try to write invalid SQL to query multiple tables, such as the following: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/intro/nonsense.sql">Polymorphic/intro/nonsense.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;c.*,&nbsp;i.summary,&nbsp;i.status</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">JOIN&nbsp;c.issue_type&nbsp;AS&nbsp;i&nbsp;USING&nbsp;(issue_id);</code></span><br class="calibre1" /></div><p class="calibre_6"> But you can't join to a different table per row in SQL. SQL syntax requires that you name all the tables literally at the time you submit the query. The tables cannot vary during the query. What's wrong with this picture, and how do we solve it? </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Polymorphic/simple-diagram.jpg" src="images/000012.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-85" class="calibre10">Figure 1. Simple association</span></td></tr></table></div><br class="calibre1" /></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-237">
<pagebreak>
<a id="calibre_link-406">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-407">Objective: Reference Multiple Parents</h2><p class="calibre_6"> The Scarecrow in <em class="calibre6">The Wizard of Oz</em> gives Dorothy uncertain directions when she asks which fork in the road she should take to get to the Emerald City. What should be a clear answer to Dorothy's simple question just confuses her when the Scarecrow tries to give her two answers at once. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Polymorphic/polymorphic-association.jpg" src="images/000009.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-238" class="calibre10">Figure 2. Polymorphic association</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> This kind of association is illustrated in the entity-relationship diagram in Figure <a href="#calibre_link-238"><em class="calibre6">Polymorphic association</em></a>. The foreign key in the child table "forks," so a row in the <code class="calibre15">Comments</code> table matches either a row in the <code class="calibre15">Bugs</code> table or a row in the <code class="calibre15">FeatureRequests</code> table. The curved arc in the diagram indicates an exclusive choice: a given comment must reference either one bug or one feature request. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-292">
<pagebreak>
<a id="calibre_link-408">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-409">Antipattern: Use Dual-Purpose Foreign Key</h2><p class="calibre_6"> A solution for these cases has become popular enough to be given a name, <span>Polymorphic Associations</span>. This is also sometimes called a <span>promiscuous</span> association, because it can reference multiple tables. </p><h3 class="calibre_8">Defining a Polymorphic Association</h3><p class="calibre_6"> To make Polymorphic Associations work, you must add an extra string column alongside the foreign key on <code class="calibre15">issue_id</code>. The extra column contains the name of the parent table referenced by the current row. In this example, the new column is called <code class="calibre15">issue_type</code>, and it contains either <code class="calibre15">Bugs</code> or <code class="calibre15">FeatureRequests</code>, corresponding to the names of the two possible parent tables in this association. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/anti/comments.sql">Polymorphic/anti/comments.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Comments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_type&nbsp;&nbsp;&nbsp;VARCHAR(20),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">--&nbsp;"Bugs"&nbsp;or&nbsp;"FeatureRequests"</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;author&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_date&nbsp;DATETIME,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(author)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> You can see one difference immediately: the foreign key declaration for <code class="calibre15">issue_id</code> is missing. In fact, since a foreign key must specify exactly one table, using a Polymorphic Association means that you can't declare this association in metadata. As a result, there is no enforcement of data integrity to ensure that the value in <code class="calibre15">Comments.issue_id</code> matches a value in the parent table. </p><p class="calibre_6"> Likewise, no metadata ensures that the string in <code class="calibre15">Comments.issue_type</code> corresponds to a table that exists in this database. </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Mixing Data with Metadata</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> You might have noticed a similar characteristic between the Polymorphic Associations antipattern and the Entity-Attribute-Value antipattern described in the previous chapter. In both antipatterns, the name of a metadata object is stored as a string value. In EAV, the name of an attribute column is stored as a string in the <code class="calibre15">attr_name</code> column. In Polymorphic Associations, the names of the parent tables are stored in the <code class="calibre15">issue_type</code> column. This is sometimes called <span>mixing data with metadata</span>. This concept appears in another form in the Chapter <a href="#calibre_link-139"><em class="calibre6">Multicolumn Attributes</em></a>. </blockquote></small></p></div><hr class="calibre7" /></div><h3 class="calibre_8">Querying a Polymorphic Association</h3><p class="calibre_6"> The <code class="calibre15">issue_id</code> value in the <code class="calibre15">Comments</code> table may occur in the primary key column of both parent tables, <code class="calibre15">Bugs</code> and <code class="calibre15">FeatureRequests</code>. Or the value may occur in one parent table but be missing in the other parent table. It's therefore crucial to use the <code class="calibre15">issue_type</code> correctly when joining the child table to the parent table. You must not match an <code class="calibre15">issue_id</code> value to the <code class="calibre15">FeatureRequests</code> table if it was intended to be matched to the <code class="calibre15">Bugs</code> table. </p><p class="calibre_6"> For example, this will retrieve comments for a given bug by its primary key value 1234: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/anti/select.sql">Polymorphic/anti/select.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;AS&nbsp;b&nbsp;JOIN&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ON&nbsp;(b.issue_id&nbsp;=&nbsp;c.issue_id&nbsp;AND&nbsp;c.issue_type&nbsp;=&nbsp;<em class="calibre6">'Bugs'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;b.issue_id&nbsp;=&nbsp;1234;</code></span><br class="calibre1" /></div><p class="calibre_6"> Although the previous query works if bugs are stored in the single table <code class="calibre15">Bugs</code>, you run into a problem when <code class="calibre15">Comments</code> is associated with both tables <code class="calibre15">Bugs</code> and <code class="calibre15">FeatureRequests</code>. In SQL, you must specify all tables in a join; you cannot join <code class="calibre15">Comments</code> to two separate tables, switching between them row by row, depending on the value in the <code class="calibre15">Comments.issue_type</code> column. </p><p class="calibre_6"> To retrieve either a bug or a feature given a specific comment, you need to run a query with an outer join to both parent tables. Only one of the parent tables will satisfy its join, since part of the join condition relies on the value in the <code class="calibre15">Comment.issue_type</code> column. Using an outer join means that fields from the table that does not match contain null in the result set. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/anti/select.sql">Polymorphic/anti/select.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Bugs&nbsp;AS&nbsp;b</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;(b.issue_id&nbsp;=&nbsp;c.issue_id&nbsp;AND&nbsp;c.issue_type&nbsp;=&nbsp;<em class="calibre6">'Bugs'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;FeatureRequests&nbsp;AS&nbsp;f</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;(f.issue_id&nbsp;=&nbsp;c.issue_id&nbsp;AND&nbsp;c.issue_type&nbsp;=&nbsp;<em class="calibre6">'FeatureRequests'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> The result may look something like this: </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">c.comment_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">c.issue_type</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">c.issue_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">c.comment</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">b.issue_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">f.issue_id</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">6789</p></td><td class="calibre19"><p class="calibre_6">Bugs</p></td><td class="calibre19"><p class="calibre_6">1234</p></td><td class="calibre19"><p class="calibre_6">It crashes!</p></td><td class="calibre19"><p class="calibre_6">1234</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">9876</p></td><td class="calibre19"><p class="calibre_6">Feature…</p></td><td class="calibre19"><p class="calibre_6">2345</p></td><td class="calibre19"><p class="calibre_6">Great idea!</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6">2345</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><h3 class="calibre_8">Non-Object-Oriented Example</h3><p class="calibre_6"> In the example of <code class="calibre15">Bugs</code> and <code class="calibre15">FeatureRequests</code>, these two parent tables are meant to model related subtypes. Polymorphic Associations may also be used when the parent tables are completely unrelated to each other. For example, in an ecommerce database, both tables <code class="calibre15">Users</code> and <code class="calibre15">Orders</code> may be associated with <code class="calibre15">Addresses</code>, as illustrated in Figure <a href="#calibre_link-293"><em class="calibre6">Polymorphic Associations for addresses</em></a>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/anti/addresses.sql">Polymorphic/anti/addresses.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Addresses&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;address_id&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;parent&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">--&nbsp;"Users"&nbsp;or&nbsp;"Orders"</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;parent_id&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;address&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> In this case, the <code class="calibre15">Addresses</code> table contains a polymorphic column that names either <code class="calibre15">Users</code> or <code class="calibre15">Orders</code> as the parent table for a given address. Notice that you have to choose one or the other. You can't associate a given address with both a user and an order, even an order placed by that user, to ship merchandise to himself. </p><p class="calibre_6"> Also, if a user has a shipping address as well as a billing address, you need some way to make this distinction in the <code class="calibre15">Addresses</code> table; likewise, any other parents need to note the special usage of addresses in the <code class="calibre15">Addresses</code> table. These notes can propagate like weeds. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/anti/addresses.sql">Polymorphic/anti/addresses.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Addresses&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;address_id&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;parent&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">--&nbsp;"Users"&nbsp;or&nbsp;"Orders"</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;parent_id&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;users_usage&nbsp;&nbsp;VARCHAR(20),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">--&nbsp;"billing"&nbsp;or&nbsp;"shipping"</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;orders_usage&nbsp;VARCHAR(20),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">--&nbsp;"billing"&nbsp;or&nbsp;"shipping"</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;address&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Polymorphic/order-addresses.jpg" src="images/000007.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-293" class="calibre10">Figure 3. Polymorphic Associations for addresses</span></td></tr></table></div><br class="calibre1" /></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-19">
<pagebreak>
<a id="calibre_link-410">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-411">How to Recognize the Antipattern</h2><p class="calibre_6"> If you hear statements like the following, it's a clue that the Polymorphic Associations antipattern is being employed: </p><ul class="calibre_14"><li class="calibre_15"> "This tagging schema allows you to associate a tag (or other attribute) with <em class="calibre6">any</em> other resource in the database." <br class="calibre_16" /> Like in EAV, you should be suspicious of any claims of unlimited flexibility. </li><li class="calibre_15"> "You can't declare foreign keys in our database design." <br class="calibre_16" /> This is another red flag. Foreign keys are a fundamental feature of relational databases, and a design that can't work with proper referential integrity has a lot of problems. </li><li class="calibre_15"> "What's the <code class="calibre15">entity_type</code> column for? Oh, that tells you which thing this other column points to." <br class="calibre_16" /> Any foreign key must reference the same table on all rows. </li></ul><p class="calibre_6"> The Ruby on Rails framework supports Polymorphic Associations by declaring Active Record classes with the <code class="calibre15">:polymorphic</code> attribute. For example, you could associate <code class="calibre15">Comments</code> to <code class="calibre15">Bugs</code> and <code class="calibre15">FeatureRequests</code> as follows: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/recog/commentable.rb">Polymorphic/recog/commentable.rb</a></span></span></div><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;Comment&nbsp;&lt;&nbsp;ActiveRecord::Base</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;belongs_to&nbsp;:commentable,&nbsp;:polymorphic&nbsp;=&gt;&nbsp;<span class="calibre10">true</span></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">end</span></code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;Bug&nbsp;&lt;&nbsp;ActiveRecord::Base</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;has_many&nbsp;:comments,&nbsp;:as&nbsp;=&gt;&nbsp;:commentable</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">end</span></code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;FeatureRequest&nbsp;&lt;&nbsp;ActiveRecord::Base</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;has_many&nbsp;:comments,&nbsp;:as&nbsp;=&gt;&nbsp;:commentable</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">end</span></code></span><br class="calibre1" /></div><p class="calibre_6"> The Hibernate framework for Java supports Polymorphic Associations using a variety of schema declarations.<a href="#calibre_link-20" id="calibre_link-123">[8]</a></p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-73">
<pagebreak>
<a id="calibre_link-412">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-413">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> You should avoid the Polymorphic Associations antipattern---use constraints like foreign keys to ensure referential integrity. Polymorphic Associations often relies too much on application code instead of metadata. </p><p class="calibre_6"> You may find that this antipattern is unavoidable if you use an object-relational programming framework such as Hibernate. Such a framework may mitigate the risks introduced by Polymorphic Associations by encapsulating application logic to maintain referential integrity. If you choose a mature and reputable framework, then you have some confidence that its designers have written the code to implement the association without error. However, if you are implementing Polymorphic Associations from scratch without the aid of a framework, you're reinventing the wheel. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-118">
<pagebreak>
<a id="calibre_link-414">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-415">Solution: Simplify the Relationship</h2><p class="calibre_6"> It's better to redesign your database to avoid the weaknesses of Polymorphic Associations but still support the data modeling you need. The following sections describe a few solutions that accommodate the data relationship but make better use of metadata to enforce integrity. </p><h3 class="calibre_8">Reverse the Reference</h3><p class="calibre_6"> One solution to this antipattern is simple once you see the nature of the problem: <em class="calibre6">Polymorphic Associations are backward.</em></p><h4 class="calibre_18">Creating Intersection Tables</h4><p class="calibre_6"> A foreign key in the child table <code class="calibre15">Comments</code> can't reference multiple parent tables, so instead, use multiple foreign keys to reference the <code class="calibre15">Comments</code> table. Create a separate intersection table for each parent table, and in each intersection table include a foreign key to <code class="calibre15">Comments</code>, as well as a foreign key to the respective parent table. This design is illustrated in the entity-relationship diagram in Figure <a href="#calibre_link-119"><em class="calibre6">Reversing a polymorphic association</em></a>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/soln/reverse-reference.sql">Polymorphic/soln/reverse-reference.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsComments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(issue_id,&nbsp;comment_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(issue_id)&nbsp;REFERENCES&nbsp;Bugs(issue_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(comment_id)&nbsp;REFERENCES&nbsp;Comments(comment_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;FeaturesComments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(issue_id,&nbsp;comment_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(issue_id)&nbsp;REFERENCES&nbsp;FeatureRequests(issue_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(comment_id)&nbsp;REFERENCES&nbsp;Comments(comment_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> This solution removes the need for the <code class="calibre15">Comments.issue_type</code> column. Now the metadata can enforce data integrity, instead of relying on application code to manage the associations without error. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Polymorphic/reverse-reference.jpg" src="images/000000.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-119" class="calibre10">Figure 4. Reversing a polymorphic association</span></td></tr></table></div><br class="calibre1" /><h4 class="calibre_18">Putting Up Traffic Lights</h4><p class="calibre_6"> A potential weakness of this solution is that it permits associations that you might not want to be permitted. Intersection tables usually model many-to-many associations, so this would allow a given comment to be associated with multiple bugs or multiple feature requests. However, you probably want each comment to pertain to only one bug or one feature request. You can enforce at least part of this rule by declaring a <code class="calibre15">UNIQUE</code> constraint on the <code class="calibre15">comment_id</code> column of each intersection table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/soln/reverse-unique.sql">Polymorphic/soln/reverse-unique.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsComments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;UNIQUE&nbsp;KEY&nbsp;(comment_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(issue_id,&nbsp;comment_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(issue_id)&nbsp;REFERENCES&nbsp;Bugs(issue_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(comment_id)&nbsp;REFERENCES&nbsp;Comments(comment_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> This ensures that a given comment can be referenced only once in the intersection table, which naturally prevents it from being associated with multiple bugs or multiple feature requests. However, the metadata doesn't prevent a given comment from being referenced once in both intersection tables, associating the comment with both a bug and a feature request. This is probably not what you want, but ensuring against it remains the responsibility of your application code. </p><h4 class="calibre_18">Looking Both Ways</h4><p class="calibre_6"> You can query comments given a specific bug or feature request simply by using the intersection table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/soln/reverse-join.sql">Polymorphic/soln/reverse-join.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;BugsComments&nbsp;AS&nbsp;b</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;Comments&nbsp;AS&nbsp;c&nbsp;USING&nbsp;(comment_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;b.issue_id&nbsp;=&nbsp;1234;</code></span><br class="calibre1" /></div><p class="calibre_6"> You can query the matching bug or feature request based on an instance of a comment by using an outer join to both intersection tables. You have to name all the possible parent tables, but that's no more complex than the query you had to use in the Polymorphic Associations antipattern. Also, you can depend on referential integrity when using intersection tables, whereas with Polymorphic Associations you couldn't. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/soln/reverse-join.sql">Polymorphic/soln/reverse-join.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;(BugsComments&nbsp;JOIN&nbsp;Bugs&nbsp;AS&nbsp;b&nbsp;USING&nbsp;(issue_id))</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;USING&nbsp;(comment_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;(FeaturesComments&nbsp;JOIN&nbsp;FeatureRequests&nbsp;AS&nbsp;f&nbsp;USING&nbsp;(issue_id))</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;USING&nbsp;(comment_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;c.comment_id&nbsp;=&nbsp;9876;</code></span><br class="calibre1" /></div><h4 class="calibre_18">Merging Lanes</h4><p class="calibre_6"> Sometimes you need to make the result of a query against multiple parent tables appear is if you had stored the parents in a single table (see the section <a href="#calibre_link-120"><em class="calibre6">Single Table Inheritance</em></a>). You can do this in either of two ways. </p><p class="calibre_6"> First look at the following query using <code class="calibre15">UNION</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/soln/reverse-union.sql">Polymorphic/soln/reverse-union.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;b.issue_id,&nbsp;b.description,&nbsp;b.reporter,&nbsp;b.priority,&nbsp;b.status,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;b.severity,&nbsp;b.version_affected,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;NULL&nbsp;AS&nbsp;sponsor</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FROM&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;JOIN&nbsp;(BugsComments&nbsp;JOIN&nbsp;Bugs&nbsp;AS&nbsp;b&nbsp;USING&nbsp;(issue_id))</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;USING&nbsp;(comment_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;WHERE&nbsp;c.comment_id&nbsp;=&nbsp;9876;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">UNION</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;f.issue_id,&nbsp;f.description,&nbsp;f.reporter,&nbsp;f.priority,&nbsp;f.status,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;NULL&nbsp;AS&nbsp;severity,&nbsp;NULL&nbsp;AS&nbsp;version_affected,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;f.sponsor</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FROM&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;JOIN&nbsp;(FeaturesComments&nbsp;JOIN&nbsp;FeatureRequests&nbsp;AS&nbsp;f&nbsp;USING&nbsp;(issue_id))</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;USING&nbsp;(comment_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;WHERE&nbsp;c.comment_id&nbsp;=&nbsp;9876;</code></span><br class="calibre1" /></div><p class="calibre_6"> This query should be guaranteed to return a single row if your application has associated each comment with exactly one parent table. Since query results can be combined with <code class="calibre15">UNION</code> only if their columns are the same in number and data type, you must provide null placeholders for columns that are unique to each parent table. You must list the columns in the same order in both queries involved in the <code class="calibre15">UNION</code>. </p><p class="calibre_6"> Alternatively, look at the following query using the SQL <code class="calibre15">COALESCE</code> function. This function returns its first non-null argument. Since you are using an outer join in the query, a comment that pertains to a feature request and has no matching row in <code class="calibre15">Bugs</code> would return all fields in <code class="calibre15">b.*</code> as null. Likewise, all fields in <code class="calibre15">f.*</code> would be null if the comment pertains to a bug instead of a feature request. List the fields specific to one parent table or the other in a simple manner; if they are irrelevant to the matching parent table, they are returned as null. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/soln/reverse-coalesce.sql">Polymorphic/soln/reverse-coalesce.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;c.*,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;COALESCE(b.issue_id,&nbsp;&nbsp;&nbsp;&nbsp;f.issue_id&nbsp;&nbsp;&nbsp;)&nbsp;AS&nbsp;issue_id,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;COALESCE(b.description,&nbsp;f.description)&nbsp;AS&nbsp;description,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;COALESCE(b.reporter,&nbsp;&nbsp;&nbsp;&nbsp;f.reporter&nbsp;&nbsp;&nbsp;)&nbsp;AS&nbsp;reporter,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;COALESCE(b.priority,&nbsp;&nbsp;&nbsp;&nbsp;f.priority&nbsp;&nbsp;&nbsp;)&nbsp;AS&nbsp;priority,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;COALESCE(b.status,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;AS&nbsp;status,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;b.severity,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;b.version_affected,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;f.sponsor</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;(BugsComments&nbsp;JOIN&nbsp;Bugs&nbsp;AS&nbsp;b&nbsp;USING&nbsp;(issue_id))</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;USING&nbsp;(comment_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;(FeaturesComments&nbsp;JOIN&nbsp;FeatureRequests&nbsp;AS&nbsp;f&nbsp;USING&nbsp;(issue_id))</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;USING&nbsp;(comment_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;c.comment_id&nbsp;=&nbsp;9876;</code></span><br class="calibre1" /></div><p class="calibre_6"> Both of these queries are pretty complex, so they're good candidates for a database view, and you can use them more simply in your application. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Polymorphic/base-table-association.jpg" src="images/000004.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-122" class="calibre10">Figure 5. Association of <code class="calibre15">Comments</code> to the <code class="calibre15">Base Issues</code> table</span></td></tr></table></div><br class="calibre1" /><h3 class="calibre_8">Create a Common Super-Table</h3><p class="calibre_6"> In object-oriented polymorphism, two subtypes can be referenced similarly because they implicitly share a common supertype. In SQL, the Polymorphic Associations antipattern leaves out that crucial entity: the common supertype. You can fix that by creating a base table that all of your parent tables extend (see the section <a href="#calibre_link-121"><em class="calibre6">Class Table Inheritance</em></a>). Add the foreign key in the child <code class="calibre15">Comments</code> table to reference the base table. You don't need an <code class="calibre15">issue_type</code> column. This solution is illustrated in the entity-relationship diagram in Figure <a href="#calibre_link-122"><em class="calibre6">Association of <code class="calibre15">Comments</code> to the <code class="calibre15">Base Issues</code> table</em></a>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/soln/super-table.sql">Polymorphic/soln/super-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Issues&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(issue_id)&nbsp;REFERENCES&nbsp;Issues(issue_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;.&nbsp;.&nbsp;.</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;FeatureRequests&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(issue_id)&nbsp;REFERENCES&nbsp;Issues(issue_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;.&nbsp;.&nbsp;.</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Comments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;issue_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;author&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_date&nbsp;DATETIME,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(issue_id)&nbsp;REFERENCES&nbsp;Issues(issue_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(author)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Note that the primary keys of <code class="calibre15">Bugs</code> and <code class="calibre15">FeatureRequests</code> are also foreign keys. They reference the surrogate key value generated in the <code class="calibre15">Issues</code> table, instead of generating a new value for themselves. </p><p class="calibre_6"> Given a specific comment, you can retrieve the referenced bug or feature request using a relatively simple query. You don't have to include the <code class="calibre15">Issues</code> table in that query at all, unless you defined attribute columns in that table. Also, since the primary key value of the <code class="calibre15">Bugs</code> table and its ancestor <code class="calibre15">Issues</code> table are the same, you can join <code class="calibre15">Bugs</code> directly to <code class="calibre15">Comments</code>. You can join two tables even if there is no foreign key constraint linking them directly, as long as you use columns that represent comparable information in your database. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/soln/super-join.sql">Polymorphic/soln/super-join.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Comments&nbsp;AS&nbsp;c</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Bugs&nbsp;AS&nbsp;b&nbsp;USING&nbsp;(issue_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;FeatureRequests&nbsp;AS&nbsp;f&nbsp;USING&nbsp;(issue_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;c.comment_id&nbsp;=&nbsp;9876;</code></span><br class="calibre1" /></div><p class="calibre_6"> Given a specific bug, you can retrieve its comments just as easily. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Polymorphic/soln/super-join.sql">Polymorphic/soln/super-join.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;AS&nbsp;b</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;Comments&nbsp;AS&nbsp;c&nbsp;USING&nbsp;(issue_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;b.issue_id&nbsp;=&nbsp;1234;</code></span><br class="calibre1" /></div><p class="calibre_6"> The point is that if you use an ancestor table like <code class="calibre15">Issues</code>, you can rely on the enforcement of your database's data integrity by foreign keys. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">In every table relationship, there is one referencing table</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">and one referenced table.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-123" id="calibre_link-20">[8]</a>
<small class="calibre3"> See <a href="http://www.hibernate.org/hib_docs/reference/en/html/inheritance.html">http://www.hibernate.org/hib_docs/reference/en/html/inheritance.html</a>. "Hibernate" is a service mark of Red Hat, Inc. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-416"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-193">
<pagebreak>
<a id="calibre_link-417">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-139" class="calibre12"><small class="calibre13">Chapter 8</small><br class="calibre14" />Multicolumn Attributes</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> The sublime and the ridiculous are often so nearly related that it is difficult to class them separately. </em></p></div><div class="calibre1"><div class="calibre4"><span> Thomas Paine </span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> I can't count the number of times I have created a table to store people's contact information. Always this kind of table has commonplace columns such as the person's name, salutation, address, and probably company name. </p><p class="calibre_6"> Phone numbers are a little trickier. People use multiple numbers: a home number, a work number, a fax number, and a mobile number are common. In the contact information table, it's easy to store these in four columns. </p><p class="calibre_6"> But what about additional numbers? The person's assistant, second mobile phone, or field office have distinct phone numbers, and there could be other unforeseen categories. I could create more columns for the less common cases, but that seems clumsy because it adds seldom-used fields to data entry forms. How many columns is enough? </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-281">
<pagebreak>
<a id="calibre_link-418">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-419">Objective: Store Multivalue Attributes</h2><p class="calibre_6"> This is the same objective as in the Chapter <a href="#calibre_link-140"><em class="calibre6">Jaywalking</em></a>: an attribute seems to belong in one table, but the attribute has multiple values. Previously, we saw that combining multiple values into a comma-separated string makes it hard to validate the values, hard to read or change individual values, and hard to compute aggregate expressions such as counting the number of distinct values. </p><p class="calibre_6"> We'll use a new example to illustrate this antipattern. We want the bugs database to allow <span>tags</span> so we can categorize bugs. Some bugs may be categorized by the software subsystem that they affect, for instance <code class="calibre15">printing</code>, <code class="calibre15">reports</code>, or <code class="calibre15">email</code>. Other bugs may be categorized by the nature of the defect; for instance, a crash bug could be tagged <code class="calibre15">crash</code>, while you could tag a report of slowness with <code class="calibre15">performance</code>, and you could tag a bad color choice in the user interface with <code class="calibre15">cosmetic</code>. </p><p class="calibre_6"> The bug-tagging feature must support multiple tags, because tags are not necessarily mutually exclusive. A defect could affect multiple systems or could affect the performance of printing. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-3">
<pagebreak>
<a id="calibre_link-420">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-421">Antipattern: Create Multiple Columns</h2><p class="calibre_6"> We still have to account for multiple values in the attribute, but we know the new solution must store only a single value in each column. It might seem natural to create multiple columns in this table, each containing a single tag. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/anti/create-table.sql">Multi-Column/anti/create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;description&nbsp;VARCHAR(1000),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;tag1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;tag2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;tag3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> As you assign tags to a given bug, you'd put values in one of these three columns. Unused columns remain null. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/anti/update.sql">Multi-Column/anti/update.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Bugs&nbsp;SET&nbsp;tag2&nbsp;=&nbsp;<em class="calibre6">'performance'</em>&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;3456;</code></span><br class="calibre1" /></div><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">bug_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">description</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">tag1</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">tag2</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">tag3</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1234</p></td><td class="calibre19"><p class="calibre_6">Crashes while saving</p></td><td class="calibre19"><p class="calibre_6">crash</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">3456</p></td><td class="calibre19"><p class="calibre_6">Increase performance</p></td><td class="calibre19"><p class="calibre_6">printing</p></td><td class="calibre19"><p class="calibre_6">performance</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">5678</p></td><td class="calibre19"><p class="calibre_6">Support XML</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> Most tasks you could do easily with a conventional attribute now become more complex. </p><h3 class="calibre_8">Searching for Values</h3><p class="calibre_6"> When searching for bugs with a given tag, you must search all three columns, because the tag string could occupy any of these columns.</p><p class="calibre_6">For example, to retrieve bugs that reference <code class="calibre15">performance</code>, use a query like the following: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/anti/search.sql">Multi-Column/anti/search.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;tag1&nbsp;=&nbsp;<em class="calibre6">'performance'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;OR&nbsp;tag2&nbsp;=&nbsp;<em class="calibre6">'performance'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;OR&nbsp;tag3&nbsp;=&nbsp;<em class="calibre6">'performance'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> You might need to search for bugs that reference both tags, <code class="calibre15">performance</code> and <code class="calibre15">printing</code>. To do this, use a query like the following one. Remember to use parentheses correctly, because <code class="calibre15">OR</code> has lower precedence than <code class="calibre15">AND</code>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/anti/search-two-tags.sql">Multi-Column/anti/search-two-tags.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;(tag1&nbsp;=&nbsp;<em class="calibre6">'performance'</em>&nbsp;OR&nbsp;tag2&nbsp;=&nbsp;<em class="calibre6">'performance'</em>&nbsp;OR&nbsp;tag3&nbsp;=&nbsp;<em class="calibre6">'performance'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;AND&nbsp;(tag1&nbsp;=&nbsp;<em class="calibre6">'printing'</em>&nbsp;OR&nbsp;tag2&nbsp;=&nbsp;<em class="calibre6">'printing'</em>&nbsp;OR&nbsp;tag3&nbsp;=&nbsp;<em class="calibre6">'printing'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> The syntax required to search for a single value over multiple columns is lengthy and tedious to write. You can make it more compact by using an <code class="calibre15">IN</code> predicate in a slightly untraditional manner: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/anti/search-two-tags.sql">Multi-Column/anti/search-two-tags.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;<em class="calibre6">'performance'</em>&nbsp;IN&nbsp;(tag1,&nbsp;tag2,&nbsp;tag3)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;AND&nbsp;<em class="calibre6">'printing'</em>&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;(tag1,&nbsp;tag2,&nbsp;tag3);</code></span><br class="calibre1" /></div><h3 class="calibre_8">Adding and Removing Values</h3><p class="calibre_6"> Adding and removing a value from the set of columns presents its own issues. Simply using <code class="calibre15">UPDATE</code> to change one of the columns isn't safe, since you can't be sure which column is unoccupied, if any. You might have to retrieve the row into your application to see. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/anti/add-tag-two-step.sql">Multi-Column/anti/add-tag-two-step.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;3456;</code></span><br class="calibre1" /></div><p class="calibre_6"> In this case, for instance, the result shows you that <code class="calibre15">tag2</code> is null. Then you can form the <code class="calibre15">UPDATE</code> statement. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/anti/add-tag-two-step.sql">Multi-Column/anti/add-tag-two-step.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Bugs&nbsp;SET&nbsp;tag2&nbsp;=&nbsp;<em class="calibre6">'performance'</em>&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;3456;</code></span><br class="calibre1" /></div><p class="calibre_6"> You face the risk that in the moment after you query the table and before you update it, another client has gone through the same steps of reading the row and updating it. Depending on who applied their update first, either you or he risks getting an update conflict error or having his changes overwritten by the other. You can avoid this two-step query by using complex SQL expressions. </p><p class="calibre_6"> The following statement uses the <code class="calibre15">NULLIF</code> function to make each column null if it equals a specific value. <code class="calibre15">NULLIF</code> returns null if its two arguments are equal.<a href="#calibre_link-4" id="calibre_link-169">[9]</a></p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/anti/remove-tag.sql">Multi-Column/anti/remove-tag.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SET&nbsp;tag1&nbsp;=&nbsp;NULLIF(tag1,&nbsp;<em class="calibre6">'performance'</em>),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;tag2&nbsp;=&nbsp;NULLIF(tag2,&nbsp;<em class="calibre6">'performance'</em>),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;tag3&nbsp;=&nbsp;NULLIF(tag3,&nbsp;<em class="calibre6">'performance'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;bug_id&nbsp;=&nbsp;3456;</code></span><br class="calibre1" /></div><p class="calibre_6"> The following statement adds the new tag <code class="calibre15">performance</code> to the first column that is currently null. However, if none of the three columns is null, then the statement makes no change to the row, and the new tag value is not recorded at all. Also, constructing this statement is laborious. Notice you must repeat the string <code class="calibre15">performance</code> six times. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/anti/add-tag.sql">Multi-Column/anti/add-tag.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SET&nbsp;tag1&nbsp;=&nbsp;CASE</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;<em class="calibre6">'performance'</em>&nbsp;IN&nbsp;(tag2,&nbsp;tag3)&nbsp;THEN&nbsp;tag1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE&nbsp;COALESCE(tag1,&nbsp;<em class="calibre6">'performance'</em>)&nbsp;END,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;tag2&nbsp;=&nbsp;CASE</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;<em class="calibre6">'performance'</em>&nbsp;IN&nbsp;(tag1,&nbsp;tag3)&nbsp;THEN&nbsp;tag2</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE&nbsp;COALESCE(tag2,&nbsp;<em class="calibre6">'performance'</em>)&nbsp;END,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;tag3&nbsp;=&nbsp;CASE</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;<em class="calibre6">'performance'</em>&nbsp;IN&nbsp;(tag1,&nbsp;tag2)&nbsp;THEN&nbsp;tag3</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE&nbsp;COALESCE(tag3,&nbsp;<em class="calibre6">'performance'</em>)&nbsp;END</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;bug_id&nbsp;=&nbsp;3456;</code></span><br class="calibre1" /></div><h3 class="calibre_8">Ensuring Uniqueness</h3><p class="calibre_6"> You probably don't want the same value to appear in multiple columns, but when you use the Multicolumn Attributes antipattern, the database can't prevent this. In other words, it's hard to prevent the following statement: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/anti/insert-duplicate.sql">Multi-Column/anti/insert-duplicate.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Bugs&nbsp;(description,&nbsp;tag1,&nbsp;tag2,&nbsp;tag3)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(<em class="calibre6">'printing&nbsp;is&nbsp;slow'</em>,&nbsp;<em class="calibre6">'printing'</em>,&nbsp;<em class="calibre6">'performance'</em>,&nbsp;<em class="calibre6">'performance'</em>);</code></span><br class="calibre1" /></div><h3 class="calibre_8">Handling Growing Sets of Values</h3><p class="calibre_6"> Another weakness of this design is that three columns might not be enough. To keep the design of one value per column, you must define as many columns as the maximum number of tags a bug can have. How can you predict, at the time you define the table, what that greatest number will be? </p><p class="calibre_6"> One tactic is to guess at a moderate number of columns and expand later, if necessary, by adding more columns. Most databases allow you to restructure existing tables, so you can add <code class="calibre15">Bugs.tag4</code>, or even more columns, as you need them. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/anti/alter-table.sql">Multi-Column/anti/alter-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Bugs&nbsp;ADD&nbsp;COLUMN&nbsp;tag4&nbsp;VARCHAR(20);</code></span><br class="calibre1" /></div><p class="calibre_6"> However, this change is costly in three ways: </p><ul class="calibre_14"><li class="calibre_15"> Restructuring a database table that already contains data may require locking the entire table, blocking access for other concurrent clients. </li><li class="calibre_15"> Some databases implement this kind of table restructure by defining a new table to match the desired structure, copying the data from the old table, and then dropping the old table. If the table in question has a lot of data, this transfer can take a long time. </li><li class="calibre_15"> When you add a column in the set for a multicolumn attribute, you must revisit every SQL statement in every application that uses this table, editing the statement to support new columns. <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/anti/search-four-columns.sql">Multi-Column/anti/search-four-columns.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;tag1&nbsp;=&nbsp;<em class="calibre6">'performance'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;OR&nbsp;tag2&nbsp;=&nbsp;<em class="calibre6">'performance'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;OR&nbsp;tag3&nbsp;=&nbsp;<em class="calibre6">'performance'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;OR&nbsp;tag4&nbsp;=&nbsp;<em class="calibre6">'performance'</em>;&nbsp;<em class="calibre6">--&nbsp;you&nbsp;must&nbsp;add&nbsp;this&nbsp;new&nbsp;term</em></code></span><br class="calibre1" /></div><br class="calibre_16" /> This is a meticulous and time-consuming development task. If you miss any queries that need edits, it can lead to bugs that are difficult to detect. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-51">
<pagebreak>
<a id="calibre_link-422">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-423">How to Recognize the Antipattern</h2><p class="calibre_6"> If the user interface or documentation for your project describes an attribute to which you can assign multiple values but is limited to a fixed maximum number of values, this might indicate that the Multicolumn Attributes antipattern is in use. </p><p class="calibre_6"> Admittedly, some attributes might have a limit on the number of selections on purpose, but it's more common that there's no such limit. If the limit seems arbitrary or unjustified, it might be because of this antipattern. </p><p class="calibre_6"> Another clue that the antipattern might be in use is if you hear statements such as the following: </p><ul class="calibre_14"><li class="calibre_15"> "How many is the greatest number of tags we need to support?" <br class="calibre_16" /> You need to decide how many columns to define in the table for a multivalue attribute like <code class="calibre15">tag</code>. </li><li class="calibre_15"> "How can I search multiple columns at the same time in SQL?" <br class="calibre_16" /> If you're searching for a given value across multiple columns, this is a clue that the multiple columns should really be stored as a single logical attribute. </li></ul><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Patterns Among Antipatterns</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The Jaywalking and Multicolumn Attributes antipatterns have a common thread: these two antipatterns are both solutions for the same objective: to store an attribute that may have multiple values. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> In the examples for Jaywalking, we saw how that antipattern relates to many-to-many relationships. In this chapter, we see a simpler one-to-many relationship. Be aware that both antipatterns are sometimes used for both types of relationships. </blockquote></small></p></div><hr class="calibre7" /></div></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-101">
<pagebreak>
<a id="calibre_link-424">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-425">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> In some cases, an attribute may have a fixed number of choices, and the position or order of these choices may be significant. For example, a given bug may be associated with several users' accounts, but the nature of each association is unique. One is the user who reported the bug, another is a programmer assigned to fix the bug, and another is the quality control engineer assigned to verify the fix. Even though the values in each of these columns are compatible, their significance and usage actually makes them logically different attributes. </p><p class="calibre_6"> It would be valid to define three ordinary columns in the <code class="calibre15">Bugs</code> table to store each of these three attributes. The drawbacks described in this chapter aren't as important, because you are more likely to use them separately. Sometimes you might still need to query over all three columns, for instance to report everyone involved with a given bug. But you can accept this complexity for a few cases in exchange for greater simplicity in most other cases. </p><p class="calibre_6"> Another way to structure this is to create a dependent table for multiple associations from the <code class="calibre15">Bugs</code> table the <code class="calibre15">Accounts</code> table and give this new table an extra column to note the role each account has in relation to that bug. However, this structure might lead to some of the problems described in the Chapter <a href="#calibre_link-102"><em class="calibre6">Entity-Attribute-Value</em></a>. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-168">
<pagebreak>
<a id="calibre_link-426">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-427">Solution: Create Dependent Table</h2><p class="calibre_6"> As we saw in the Chapter <a href="#calibre_link-140"><em class="calibre6">Jaywalking</em></a>, the best solution is to create a dependent table with one column for the multivalue attribute. Store the multiple values in multiple rows instead of multiple columns. Also, define a foreign key in the dependent table to associate the values to its parent row in the <code class="calibre15">Bugs</code> table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/soln/create-table.sql">Multi-Column/soln/create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Tags&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;tag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(bug_id,&nbsp;tag),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Tags&nbsp;(bug_id,&nbsp;tag)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(1234,&nbsp;<em class="calibre6">'crash'</em>),&nbsp;(3456,&nbsp;<em class="calibre6">'printing'</em>),&nbsp;(3456,&nbsp;<em class="calibre6">'performance'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> When all the tags associated with a bug are in a single column, searching for bugs with a given tag is more straightforward. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/soln/search.sql">Multi-Column/soln/search.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;JOIN&nbsp;Tags&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;tag&nbsp;=&nbsp;<em class="calibre6">'performance'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> Even more complex searches, such as a bug that relates to two specific tags, is easy to read. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/soln/search-two-tags.sql">Multi-Column/soln/search-two-tags.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;Tags&nbsp;AS&nbsp;t1&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;Tags&nbsp;AS&nbsp;t2&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;t1.tag&nbsp;=&nbsp;<em class="calibre6">'printing'</em>&nbsp;AND&nbsp;t2.tag&nbsp;=&nbsp;<em class="calibre6">'performance'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> You can add or remove an association much more easily than with the Multicolumn Attributes antipattern. Simply insert or delete a row from the dependent table. There's no need to inspect multiple columns to see where you can add a value. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Multi-Column/soln/insert-delete.sql">Multi-Column/soln/insert-delete.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Tags&nbsp;(bug_id,&nbsp;tag)&nbsp;VALUES&nbsp;(1234,&nbsp;<em class="calibre6">'save'</em>);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;Tags&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234&nbsp;AND&nbsp;tag&nbsp;=&nbsp;<em class="calibre6">'crash'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> The <code class="calibre15">PRIMARY&nbsp;KEY</code> constraint ensures that no duplication is allowed. A given tag can be applied to a given bug only once. If you attempt to insert a duplicate, SQL returns a duplicate key error. </p><p class="calibre_6"> You are not limited to three tags per bug, as you were when there were only three <code class="calibre15">tag<em class="calibre6">N</em></code> columns in the <code class="calibre15">Bugs</code> table. Now you can apply as many tags per bug as you need. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Store each value with the same meaning in a single column.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-169" id="calibre_link-4">[9]</a>
<small class="calibre3"> The <code class="calibre15">NULLIF</code> is a standard function in SQL; it's supported by all brands except Informix and Ingres. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-428"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-251">
<pagebreak>
<a id="calibre_link-429">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-214" class="calibre12"><small class="calibre13">Chapter 9</small><br class="calibre14" />Metadata Tribbles</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> I want these things off the ship. I don't care if it takes every last man we've got, I want them off the ship. </em></p></div><div class="calibre1"><div class="calibre4"><span>James T. Kirk</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> My wife worked for years as a programmer in Oracle PL/SQL and Java. She described a case that showed how a database design that was intended to simplify work instead created more work. </p><p class="calibre_6"> A table <code class="calibre15">Customers</code> used by the Sales division at her company kept data such as customers' contact information, their business type, and how much revenue had been received from that customer: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/intro/create-table.sql">Metadata-Tribbles/intro/create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Customers&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;customer_id&nbsp;&nbsp;&nbsp;NUMBER(9)&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;contact_info&nbsp;&nbsp;VARCHAR(255),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;business_type&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;revenue&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUMBER(9,2)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> But the Sales division needed to break down the revenue by year so they could track recently active customers. They decided to add a series of new columns, each column's name indicating the year it covered: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/intro/alter-table.sql">Metadata-Tribbles/intro/alter-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Customers&nbsp;ADD&nbsp;(revenue2002&nbsp;NUMBER(9,2));</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Customers&nbsp;ADD&nbsp;(revenue2003&nbsp;NUMBER(9,2));</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Customers&nbsp;ADD&nbsp;(revenue2004&nbsp;NUMBER(9,2));</code></span><br class="calibre1" /></div><p class="calibre_6"> Then they entered incomplete data, only for customers they thought were interesting to track. On most rows, they left null in those revenue columns. The programmers started wondering whether they could store other information in these mostly unused columns. </p><p class="calibre_6"> Each year, they needed to add one more column. A database administrator was responsible for managing Oracle's tablespaces. So each year, they had to have a series of meetings, schedule a data migration to restructure the tablespace, and add the new column. Ultimately they wasted a lot of time and money. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-306">
<pagebreak>
<a id="calibre_link-430">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-431">Objective: Support Scalability</h2><p class="calibre_6"> Performance degrades for any database query as the volume of data goes up. Even if a query returns results promptly with a few thousand rows, the tables naturally accumulate data to the point where the same query may not have acceptable performance. Using indexes intelligently helps, but nevertheless the tables grow, and this affects the speed of queries against them. </p><p class="calibre_6"> The objective is to structure a database to improve the performance of queries and support tables that grow steadily. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-31">
<pagebreak>
<a id="calibre_link-432">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-433">Antipattern: Clone Tables or Columns</h2><p class="calibre_6"> In the television series <em class="calibre6">Star Trek</em>,<a href="#calibre_link-32" id="calibre_link-207">[10]</a> "tribbles" are small furry animals kept as pets. Tribbles are very appealing at first, but soon they reveal their tendency to reproduce out of control, and managing the overpopulation of tribbles becomes a serious problem. </p><p class="calibre_6"> Where do you put them? Who's responsible for them? How long would it take to pick up every tribble? Eventually, Captain Kirk discovers that his ship and crew can't function, and he has to order his crew to make it top priority to remove the tribbles. </p><p class="calibre_6"> We know from experience that querying a table with few rows is quicker than querying a table with many rows, all other things being equal. This leads to a common fallacy that we must make every table contain fewer rows, no matter what we have to do. This leads to two forms of the antipattern: </p><ul class="calibre_14"><li class="calibre_15"> Split a single long table into multiple smaller tables, using table names based on distinct data values in one of the table's attributes. </li><li class="calibre_15"> Split a single column into multiple columns, using column names based on distinct values in another attribute. </li></ul><p class="calibre_6"> But you can't get something for nothing; to meet the goal of having few rows in every table, you have to either create tables that have too many columns or else create a greater number of tables. In both cases, you find that the number of tables or columns continues to grow, since new data values can make you create new schema objects. </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Mixing Metadata with Data</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Notice that by appending the year onto the base table name, we've combined a data value with a metadata identifier. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> This is the reverse of <span>mixing data with metadata</span> that we saw earlier in the Entity-Attribute-Value and Polymorphic Associations antipatterns. In those cases, we stored metadata identifiers (a column name and table name) as string data. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> In Multicolumn Attributes and Metadata Tribbles, we're making a data value into a column name or a table name. If you use any of these antipatterns, you create more problems than you solve. </blockquote></small></p></div><hr class="calibre7" /></div><h3 class="calibre_8">Spawning Tables</h3><p class="calibre_6"> To split data into separate tables, you'd need some policy for which rows belong in which tables. For example, you could split them up by the year in the <code class="calibre15">date_reported</code> column: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/create-tables.sql">Metadata-Tribbles/anti/create-tables.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs_2008&nbsp;(&nbsp;.&nbsp;.&nbsp;.&nbsp;);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs_2009&nbsp;(&nbsp;.&nbsp;.&nbsp;.&nbsp;);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs_2010&nbsp;(&nbsp;.&nbsp;.&nbsp;.&nbsp;);</code></span><br class="calibre1" /></div><p class="calibre_6"> As you insert rows into the database, it's your responsibility to use the correct table, depending on the values you insert: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/insert.sql">Metadata-Tribbles/anti/insert.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Bugs_2010&nbsp;(...,&nbsp;date_reported,&nbsp;...)&nbsp;VALUES&nbsp;(...,&nbsp;<em class="calibre6">'2010-06-01'</em>,&nbsp;...);</code></span><br class="calibre1" /></div><p class="calibre_6"> Fast forward to January 1 of the next year. Your application starts getting an error from all new bug reports, because you didn't remember to create the <code class="calibre15">Bugs_2011</code> table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/insert.sql">Metadata-Tribbles/anti/insert.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Bugs_2011&nbsp;(...,&nbsp;date_reported,&nbsp;...)&nbsp;VALUES&nbsp;(...,&nbsp;<em class="calibre6">'2011-02-20'</em>,&nbsp;...);</code></span><br class="calibre1" /></div><p class="calibre_6"> This means that introducing a new <em class="calibre6">data</em> value can cause a need for a new <em class="calibre6">metadata</em> object. This is not usually the relationship between data and metadata in SQL. </p><h3 class="calibre_8">Managing Data Integrity</h3><p class="calibre_6"> Suppose your boss is trying to count bugs reported during the year, but his numbers don't adding up. After investigating, you discover that some 2010 bugs were entered in the <code class="calibre15">Bugs_2009</code> table by mistake. The following query should always return an empty result, and if it doesn't, you have a problem: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/data-integrity.sql">Metadata-Tribbles/anti/data-integrity.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs_2009</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;date_reported&nbsp;NOT&nbsp;BETWEEN&nbsp;<em class="calibre6">'2009-01-01'</em>&nbsp;AND&nbsp;<em class="calibre6">'2009-12-31'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> There's no way to limit the data relative to the name of its table automatically, but you can declare a <code class="calibre15">CHECK</code> constraint in each of your tables: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/check-constraint.sql">Metadata-Tribbles/anti/check-constraint.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs_2009&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;other&nbsp;columns</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;date_reported&nbsp;DATE&nbsp;CHECK&nbsp;(EXTRACT(YEAR&nbsp;FROM&nbsp;date_reported)&nbsp;=&nbsp;2009)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs_2010&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;other&nbsp;columns</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;date_reported&nbsp;DATE&nbsp;CHECK&nbsp;(EXTRACT(YEAR&nbsp;FROM&nbsp;date_reported)&nbsp;=&nbsp;2010)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Remember to adjust the value in the <code class="calibre15">CHECK</code> constraint when you create <code class="calibre15">Bugs_2011</code>. If you make a mistake, you could create a table that rejects the rows it's supposed to accept. </p><h3 class="calibre_8">Synchronizing Data</h3><p class="calibre_6"> One day, your customer support analyst asks to change a bug report date. It's in the database as reported on 2010-01-03, but the customer who reported it actually sent it in by fax a week earlier, on 2009-12-27. You could change the date with a simple <code class="calibre15">UPDATE</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/anomaly.sql">Metadata-Tribbles/anti/anomaly.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Bugs_2010</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SET&nbsp;date_reported&nbsp;=&nbsp;<em class="calibre6">'2009-12-27'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;bug_id&nbsp;=&nbsp;1234;</code></span><br class="calibre1" /></div><p class="calibre_6"> But this correction makes the row an invalid entry in the <code class="calibre15">Bugs_2010</code> table. You would need to remove the row from one table and insert it into the other table, in the infrequent case that a simple <code class="calibre15">UPDATE</code> would cause this anomaly. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/synchronize.sql">Metadata-Tribbles/anti/synchronize.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Bugs_2009&nbsp;(bug_id,&nbsp;date_reported,&nbsp;...)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;bug_id,&nbsp;date_reported,&nbsp;...</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FROM&nbsp;Bugs_2010</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;Bugs_2010&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234;</code></span><br class="calibre1" /></div><h3 class="calibre_8">Ensuring Uniqueness</h3><p class="calibre_6"> You should make sure that the primary key values are unique across all the split tables. If you need to move a row from one table to another, you need some assurance that the primary key value doesn't conflict with another row. </p><p class="calibre_6"> If you use a database that supports sequence objects, you can use a single sequence to generate values for all the split tables. For databases that support only per-table ID uniqueness, this may be more awkward. You have to define one extra table solely to produce primary key values: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/id-generator.sql">Metadata-Tribbles/anti/id-generator.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsIdGenerator&nbsp;(bug_id&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;BugsIdGenerator&nbsp;(bug_id)&nbsp;VALUES&nbsp;(DEFAULT);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">ROLLBACK;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Bugs_2010&nbsp;(bug_id,&nbsp;.&nbsp;.&nbsp;.)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(LAST_INSERT_ID(),&nbsp;.&nbsp;.&nbsp;.);</code></span><br class="calibre1" /></div><h3 class="calibre_8">Querying Across Tables</h3><p class="calibre_6"> Inevitably, your boss needs a query that references multiple tables. For example, he may ask for a count of all open bugs regardless of the year they were created. You can reconstruct the full set of bugs using a <code class="calibre15">UNION</code> of all the split tables and query that as a derived table: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/union.sql">Metadata-Tribbles/anti/union.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;b.status,&nbsp;COUNT(*)&nbsp;AS&nbsp;count_per_status&nbsp;FROM&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs_2008</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;UNION</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs_2009</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;UNION</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs_2010&nbsp;)&nbsp;AS&nbsp;b</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;b.status;</code></span><br class="calibre1" /></div><p class="calibre_6"> As the years go on and you create more tables such as <code class="calibre15">Bugs_2011</code>, you need to keep your application code up-to-date to reference the newly created tables. </p><h3 class="calibre_8">Synchronizing Metadata</h3><p class="calibre_6"> Your boss tells you to add a column to track the hours of work required to resolve each bug. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/alter-table.sql">Metadata-Tribbles/anti/alter-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Bugs_2010&nbsp;ADD&nbsp;COLUMN&nbsp;hours&nbsp;NUMERIC(9,2);</code></span><br class="calibre1" /></div><p class="calibre_6"> If you've split the table, then the new column applies only to the one table you alter. None of the other tables contains the new column. </p><p class="calibre_6"> If you use a <code class="calibre15">UNION</code> query across your split tables as in the previous section, you stumble upon a new problem: you can combine tables using <code class="calibre15">UNION</code> if they have the same columns. If they differ, then you have to name only the columns that all tables have in common, without using the <code class="calibre15">*</code> wildcard. </p><h3 class="calibre_8">Managing Referential Integrity</h3><p class="calibre_6"> If a dependent table like <code class="calibre15">Comments</code> references <code class="calibre15">Bugs</code>, the dependent table cannot declare a foreign key. A foreign key must specify a single table, but in this case the parent table is split into many. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/foreign-key.sql">Metadata-Tribbles/anti/foreign-key.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Comments&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;comment_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs_????(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> The split table may also have problems being a dependent instead of a parent. For example, <code class="calibre15">Bugs.reported_by</code> references the <code class="calibre15">Accounts</code> table. If you want to query all bugs reported by a given person regardless of the year, you need a query like the following: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/join-union.sql">Metadata-Tribbles/anti/join-union.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Accounts&nbsp;a</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">JOIN&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs_2008</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;UNION&nbsp;ALL</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs_2009</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;UNION&nbsp;ALL</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs_2010</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;)&nbsp;t&nbsp;ON&nbsp;(a.account_id&nbsp;=&nbsp;t.reported_by)</code></span><br class="calibre1" /></div><h3 class="calibre_8">Identifying Metadata Tribbles Columns</h3><p class="calibre_6"> Columns can be Metadata Tribbles, too. You can create a table containing columns that are bound to propagate by their nature, as we saw in the story at the beginning of this chapter. </p><p class="calibre_6"> Another example we might have in our bugs database is a table that records summary data for project metrics, where individual columns store subtotals. For instance, in the following table, it's only a matter of time before you need to add the column <code class="calibre15">bugs_fixed_2011</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/anti/multi-column.sql">Metadata-Tribbles/anti/multi-column.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;ProjectHistory&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bugs_fixed_2008&nbsp;&nbsp;INT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bugs_fixed_2009&nbsp;&nbsp;INT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bugs_fixed_2010&nbsp;&nbsp;INT</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-87">
<pagebreak>
<a id="calibre_link-434">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-435">How to Recognize the Antipattern</h2><p class="calibre_6"> The following phrases may indicate that the Metadata Tribbles antipattern is growing in your database: </p><ul class="calibre_14"><li class="calibre_15"> "Then we need to create a table (or column) per …" <br class="calibre_16" /> When you describe your database with phrases using <span>per</span> in this way, you're splitting tables by distinct values in one of the columns. </li><li class="calibre_15"> "What's the maximum number of tables (or columns) that the database supports?" <br class="calibre_16" /> Most brands of database can handle many more tables and columns than you would need, if you used a sensible database design. If you think you might exceed the maximum, it's a strong sign that you need to rethink your design. </li><li class="calibre_15"> "We found out why the application failed to add new data this morning: we forgot to create a new table for the new year." <br class="calibre_16" /> This is a common consequence of Metadata Tribbles. When new data demands new database objects, you need to define those objects proactively or else risk unforeseen failures. </li><li class="calibre_15"> "How do I run a query to search many tables at once? All the tables have the same columns." <br class="calibre_16" /> If you need to search many tables with identical structure, you should have stored them together in a single table, with one extra attribute column to distinguish the rows. </li><li class="calibre_15"> "How do I pass a parameter for a table name? I need to query a table name appended with the year number dynamically." <br class="calibre_16" /> You wouldn't need to do this if your data were in one table. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-153">
<pagebreak>
<a id="calibre_link-436">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-437">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> One good use of manually splitting tables is for <span>archiving</span>---removing historical data from day-to-day use. Often the need to run queries against historical data is greatly reduced after the data is no longer current. </p><p class="calibre_6"> If you have no need to query current data and historical data together, it's appropriate to copy the older data to another location and delete it from the active tables. Archiving keeps the data in a compatible table structure for occasional analysis but allows queries against current data to run with greater performance. </p><blockquote class="calibre_9"><div class="calibre1">Sharding Databases at WordPress.com</div><div class="calibre1"><p class="calibre_6"> At the MySQL Conference &amp; Expo 2009, I had lunch with Barry Abrahamson, database architect for WordPress.com, a popular hosting service for blogging software. </p><p class="calibre_6"> Barry said when he started out hosting blogs, he hosted all his customers together in a single database. The content of a single blog site really wasn't that much, after all. It stood to reason that a single database is more manageable. </p><p class="calibre_6"> This did work well for the site initially, but it soon grew to very large-scale operations. Now it hosts 7 million blogs on 300 database servers. Each server hosts a subset of their customers. </p><p class="calibre_6"> When Barry adds a server, it would be very hard to separate data within a single database that belongs to an individual customer's blog. By splitting the data into a separate database per customer, he made it much easier to move any individual blog from one server to another. As customers come and go and some customers' blogs are busy while others go stale, his job to rebalance the load over multiple servers becomes even more important. </p><p class="calibre_6"> It's easier to back up and restore individual databases of moderate size than a single database containing terabytes of data. For example, if a customer calls and says their data got SNAFU'd because of bad data entry, how would Barry restore one customer's data if all the customers share a single, monolithic database backup? </p><p class="calibre_6"> Although it seems like the right thing to do from a data modeling perspective to keep everything in a single database, splitting the database sensibly makes database administration tasks easier after the database size passes a certain threshold. </p></div></blockquote></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-206">
<pagebreak>
<a id="calibre_link-438">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-439">Solution: Partition and Normalize</h2><p class="calibre_6"> There are better ways to improve performance if a table gets too large, instead of splitting the table manually. These include horizontal partitioning, vertical partitioning, and using dependent tables. </p><h3 class="calibre_8">Using Horizontal Partitioning</h3><p class="calibre_6"> You can gain the benefits of splitting a large table without the drawbacks by using a feature that is called either <em class="calibre6">horizontal partitioning</em> or <em class="calibre6">sharding</em>. You define a logical table with some rule for separating rows into individual partitions, and the database manages the rest. Physically, the table is split, but you can still execute SQL statements against the table as though it were whole. </p><p class="calibre_6"> You have flexibility in that you can define the way each individual table splits its rows into separate storage. For example, using the partitioning support in MySQL version 5.1, you can specify partitions as an optional part of a <code class="calibre15">CREATE TABLE</code> statement. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/soln/horiz-partition.sql">Metadata-Tribbles/soln/horiz-partition.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;other&nbsp;columns</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;date_reported&nbsp;DATE</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">)&nbsp;PARTITION&nbsp;BY&nbsp;HASH&nbsp;(&nbsp;YEAR(date_reported)&nbsp;)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PARTITIONS&nbsp;4;</code></span><br class="calibre1" /></div><p class="calibre_6"> The previous example achieves a partitioning similar to that which we saw earlier in this chapter, separating rows based on the year in the <code class="calibre15">date_reported</code> column. However, its advantages over splitting the table manually are that rows are never placed in the wrong split table, even if the value of <code class="calibre15">date_reported</code> column is updated, and you can run queries against the <code class="calibre15">Bugs</code> table without the need to reference individual split tables. </p><p class="calibre_6"> The number of separate physical tables used to store the rows is fixed at four in this example. When you have rows spanning more than four years, one of the partitions will be used to store more than one year's worth of data. This will continue as the years go on. You don't need to add new partitions unless the volume of data becomes so great that you feel the need to split it further. </p><p class="calibre_6"> Partitioning is not defined in the SQL standard, so each brand of database implements it in their own nonstandard way. The terminology, syntax, and specific features of partitioning vary between brands. Nevertheless, some form of partitioning is now supported by every major brand of database. </p><h3 class="calibre_8">Using Vertical Partitioning</h3><p class="calibre_6"> Whereas horizontal partitioning splits a table by rows, vertical partitioning splits a table by columns. Splitting a table by columns can have advantages when some columns are bulky or seldom needed. </p><p class="calibre_6"><code class="calibre15">BLOB</code> and <code class="calibre15">TEXT</code> columns have variable size, and they may be very large. For efficiency of both storage and retrieval, many database brands automatically store columns with these data types separately from the other columns of a given row. If you run a query without referencing any <code class="calibre15">BLOB</code> or <code class="calibre15">TEXT</code> columns of a table, you can access the other columns more efficiently. But if you use the column wildcard <code class="calibre15">*</code> in your query, the database retrieves all columns from that table, including any <code class="calibre15">BLOB</code> or <code class="calibre15">TEXT</code> columns. </p><p class="calibre_6"> For example, in the <code class="calibre15">Products</code> table of our bugs database, we might store a copy of the installation file for the respective product. This file is typically a self-extracting archive with an extension such as <code class="calibre15">.exe</code> on Windows or <code class="calibre15">.dmg</code> on a Mac. The files are usually very large, but a <code class="calibre15">BLOB</code> column can store binary data of enormous size. </p><p class="calibre_6"> Logically, the installer file should be an attribute of the <code class="calibre15">Products</code> table. But in most queries against that table, you wouldn't need the installer. Storing such a large volume of data in the <code class="calibre15">Products</code> table, which you use infrequently, could lead to inadvertent performance problems if you're in the habit of retrieving all columns using the <code class="calibre15">*</code> wildcard. </p><p class="calibre_6"> The remedy is to store the <code class="calibre15">BLOB</code> column in another table, separate from but dependent on the <code class="calibre15">Products</code> table. Make its primary key also serve as a foreign key to the <code class="calibre15">Products</code> table to ensure there is at most one row per product row. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/soln/vert-partition.sql">Metadata-Tribbles/soln/vert-partition.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;ProductInstallers&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;installer_image&nbsp;BLOB,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> The previous example is extreme to make the point, but it shows the benefit of storing some columns in a separate table. For example, in MySQL's MyISAM storage engine, querying a table is most efficient when the rows are of fixed size. <code class="calibre15">VARCHAR</code> is a variable-length data type, so the presence of a single column with that data type in a table prevents the table from gaining that advantage. If you store all variable-length columns in a separate table, then queries against the primary table can benefit (if even a little bit). </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/soln/separate-fixed-length.sql">Metadata-Tribbles/soln/separate-fixed-length.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,&nbsp;<em class="calibre6">--&nbsp;fixed&nbsp;length&nbsp;data&nbsp;type</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;summary&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHAR(80),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">--&nbsp;fixed&nbsp;length&nbsp;data&nbsp;type</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;date_reported&nbsp;DATE,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">--&nbsp;fixed&nbsp;length&nbsp;data&nbsp;type</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED,&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">--&nbsp;fixed&nbsp;length&nbsp;data&nbsp;type</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;&nbsp;(reported_by)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugDescriptions&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;description&nbsp;&nbsp;VARCHAR(1000),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">--&nbsp;variable&nbsp;length&nbsp;data&nbsp;type</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;resolution&nbsp;&nbsp;&nbsp;VARCHAR(1000)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="calibre6">--&nbsp;variable&nbsp;length&nbsp;data&nbsp;type</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><h3 class="calibre_8">Fixing Metadata Tribbles Columns</h3><p class="calibre_6"> Similar to the solution we saw in the Chapter <a href="#calibre_link-139"><em class="calibre6">Multicolumn Attributes</em></a>, the remedy for Metadata Tribbles columns is to create a dependent table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Metadata-Tribbles/soln/create-history-table.sql">Metadata-Tribbles/soln/create-history-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;ProjectHistory&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;project_id&nbsp;&nbsp;BIGINT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;year&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SMALLINT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bugs_fixed&nbsp;&nbsp;INT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(project_id,&nbsp;year),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(project_id)&nbsp;REFERENCES&nbsp;Projects(project_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Instead of one row per project with multiple columns for each year, use multiple rows, with one column for bugs fixed. If you define the table in this way, you don't need to add new columns to support subsequent years. You can store any number of rows per project in this table as time goes on. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Don't let data spawn metadata.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-207" id="calibre_link-32">[10]</a>
<small class="calibre3"> "Star Trek" and related marks are trademarks of CBS Studios Inc. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-440"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-294">
<pagebreak>
<a id="calibre_link-441">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 class="calibre12" id="calibre_link-215"><small class="calibre13">Part 2</small><br class="calibre14" />Physical Database Design Antipatterns</h1><pagebreak><div class="calibre1" id="calibre_link-442"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-21">
<pagebreak>
<a id="calibre_link-443">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-216" class="calibre12"><small class="calibre13">Chapter 10</small><br class="calibre14" />Rounding Errors</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> 10.0 times 0.1 is hardly ever 1.0. </em></p></div><div class="calibre1"><div class="calibre4"><span> Brian Kernighan </span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> Your boss asks you to produce a report of the cost of programmer time for the project, based on the total work to fix each bug. Each programmer in the <code class="calibre15">Accounts</code> table has a different hourly rate, so you record the number of <code class="calibre15">hours</code> required to fix each bug in the <code class="calibre15">Bugs</code> table, and you multiply it by the <code class="calibre15">hourly_rate</code> of the programmer assigned to do the work. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Rounding-Errors/intro/cost-per-bug.sql">Rounding-Errors/intro/cost-per-bug.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;b.bug_id,&nbsp;b.hours&nbsp;*&nbsp;a.hourly_rate&nbsp;AS&nbsp;cost_per_bug</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;AS&nbsp;b</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;Accounts&nbsp;AS&nbsp;a&nbsp;ON&nbsp;(b.assigned_to&nbsp;=&nbsp;a.account_id);</code></span><br class="calibre1" /></div><p class="calibre_6"> To support this query, you need to create new columns in the <code class="calibre15">Bugs</code> and <code class="calibre15">Accounts</code> tables. Both columns should support fractional values, because you need to track the costs precisely. You decide to define the new columns as <code class="calibre15">FLOAT</code>, because this data type supports fractional values. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Rounding-Errors/intro/float-columns.sql">Rounding-Errors/intro/float-columns.sql</a></span></span></div><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Bugs&nbsp;ADD&nbsp;COLUMN&nbsp;hours&nbsp;FLOAT;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Accounts&nbsp;ADD&nbsp;COLUMN&nbsp;hourly_rate&nbsp;FLOAT;</code></span><br class="calibre1" /></div><p class="calibre_6"> You update the columns with information from the bug work logs and the programmers' rates, test the report, and call it a day. </p><p class="calibre_6"> The next day, your boss shows up in your office with a copy of the project cost report. "These numbers don't add up," he tells you through gritted teeth. "I did the calculation by hand for comparison, and your report is inaccurate---slightly, by only a few dollars. How do you explain this?" You start to perspire. What could have gone wrong with such a simple calculation? </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-74">
<pagebreak>
<a id="calibre_link-444">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-445">Objective: Use Fractional Numbers Instead of Integers</h2><p class="calibre_6"> The integer is a useful data type, but it stores only whole numbers like 1 or 327 or -19. It can't represent fractional values like 2.5. You need a different data type if you need numbers with more precision than an integer. For example, sums of money are usually represented by numbers with two decimal places, like $19.95. </p><p class="calibre_6"> So, the objective is to store numeric values that aren't whole numbers and to use them in arithmetic computations. There is an additional objective, although it ought to go without saying: the results of arithmetic computations must be <em class="calibre6">correct</em>. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-112">
<pagebreak>
<a id="calibre_link-446">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-447">Antipattern: Use FLOAT Data Type</h2><p class="calibre_6"> Most programming languages support a data type for real numbers, called <code class="calibre15">float</code> or <code class="calibre15">double</code>. SQL supports a similar data type of the same name. Many programmers naturally use the SQL <code class="calibre15">FLOAT</code> data type everywhere they need fractional numeric data, because they are accustomed to programming with the <code class="calibre15">float</code> data type. </p><p class="calibre_6"> The <code class="calibre15">FLOAT</code> data type in SQL, like <code class="calibre15">float</code> in most programming languages, encodes a real number in a binary format according to the IEEE 754 standard. You need to understand some characteristics of floating-point numbers in this format to use them effectively. </p><h3 class="calibre_8">Rounding by Necessity</h3><p class="calibre_6"> Many programmers are not aware of a characteristic of this floating-point format: not all values you can describe in decimal can be stored in binary. Out of necessity, some numbers must be rounded to a value that is very close. </p><p class="calibre_6"> To give some context for this rounding behavior, compare with rational numbers such as one-third, represented by a repeating decimal number like 0.333…. The true value cannot be represented in decimal, because you would need to write an infinite number of digits. The number of digits is the precision of the number, so a repeating decimal number would require <span>infinite precision</span>. </p><p class="calibre_6"> The compromise is to use <span>finite precision</span>, choosing a numeric value as close as possible to the original value, for example 0.333. However, this means that the value isn't exactly the same number we intended. </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"> 1/3 + 1/3 + 1/3 </p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">= 1.000</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">0.333 + 0.333 + 0.333</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">= 0.999</code></p></td></tr></table><p class="calibre_6"> Even if we increase the precision, we still can't add three of these approximations of one-third to get a true value of 1.0. This is the necessary compromise of using finite precision to represent numbers that may have repeating decimals. </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"> 1/3 + 1/3 + 1/3 </p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">= 1.000000</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">0.333333 + 0.333333 + 0.333333</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">= 0.999999</code></p></td></tr></table><p class="calibre_6"> This means some legitimate numbers that you can imagine cannot be represented with finite precision. You might think this is OK, because you can't really type a number with infinite digits anyway, so naturally any number you can type has finite precision and should be stored precisely, right? Unfortunately not. </p><p class="calibre_6"> IEEE 754 represents floating-point numbers in a base-2 format. The values that require infinite precision in binary are different values from those that behave this way in decimal. Some values that only need finite precision in decimal, for instance 59.95, require infinite precision to be represented exactly in binary. The <code class="calibre15">FLOAT</code> data type can't do this, so it uses the closest value in base-2 it can store, which is equal to 59.950000762939 in base-10. </p><p class="calibre_6"> Some values coincidentally use finite precision in both formats. In theory, if you understand the details of storing numbers in the IEEE 754 format, you can predict how a given decimal value is represented in binary. But in practice, most people won't do this computation for every floating-point value they use. You can't guarantee that a <code class="calibre15">FLOAT</code> column in the database will be given only values that are cooperative, so your application should assume that any value in this column may have been rounded. </p><p class="calibre_6"> Some databases support related data types called <code class="calibre15">DOUBLE&nbsp;PRECISION</code> and <code class="calibre15">REAL</code>. The precision that these data types and <code class="calibre15">FLOAT</code> support varies by database implementation, but they all represent floating-point values with a finite number of binary digits, so they all have similar rounding behavior. </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Meet the IEEE 754 Format</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The proposals for a standard binary format for floating-point numbers dates back to 1979. It was formally made a standard in 1985, and it is now widely implemented in software, most programming languages, and microprocessors. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The format has three fields to encode a floating-point value: a field for a <span>fraction</span> portion of the value, a field for the <span>exponent</span> to which to raise the fraction, and a single-bit <span>sign</span> field. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> One advantage of IEEE 754 is that by using the exponent, it can represent fractional values that are both very small and very large. The format not only supports real numbers, but the range of values it supports is greater than integers in fixed-point format. The double-precision format supports an even greater range of values. So, these formats are useful for scientific applications. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> But the most common use of fractional numeric values is probably to represent quantities of money. There's no need to use IEEE 754 for money, because the scaled decimal format described in this chapter can handle money values just as easily and more accurately. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Good references for learning more about this format are the Wikipedia article (<a href="http://en.wikipedia.org/wiki/IEEE_754-1985">http://en.wikipedia.org/wiki/IEEE_754-1985</a>) or David Goldberg's article, “What Every Computer Scientist Should Know About Floating-Point Arithmetic.”<a href="#calibre_link-43">[WECSSKAFA]</a> Goldberg's article is also reprinted at <a href="http://www.validlab.com/goldberg/paper.pdf">http://www.validlab.com/goldberg/paper.pdf</a>. </blockquote></small></p></div><hr class="calibre7" /></div><h3 class="calibre_8">Using FLOAT in SQL</h3><p class="calibre_6"> Some databases can compensate for the inexactness and display the intended value. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Rounding-Errors/anti/select-rate.sql">Rounding-Errors/anti/select-rate.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;hourly_rate&nbsp;FROM&nbsp;Accounts&nbsp;WHERE&nbsp;account_id&nbsp;=&nbsp;123;</code></span><br class="calibre1" /></div><p class="calibre_6"> Returns: <code class="calibre15">59.95</code></p><p class="calibre_6"> But the actual value stored in the <code class="calibre15">FLOAT</code> column may not be exactly this value. If you magnify the value by a billion, you see the discrepancy: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Rounding-Errors/anti/magnify-rate.sql">Rounding-Errors/anti/magnify-rate.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;hourly_rate&nbsp;*&nbsp;1000000000&nbsp;FROM&nbsp;Accounts&nbsp;WHERE&nbsp;account_id&nbsp;=&nbsp;123;</code></span><br class="calibre1" /></div><p class="calibre_6"> Returns: <code class="calibre15">59950000762.939</code></p><p class="calibre_6"> You might expect the magnified value returned by the previous query to be 59950000000.000. This shows that the value 59.95 has been rounded to a value that can be represented in the finite precision offered by the IEEE 754 binary format. In this case, the value is within 1 ten-millionth, which is close enough for many calculations. </p><p class="calibre_6"> However, it's not close enough for some other kinds of calculations to be accurate. One example is using a <code class="calibre15">FLOAT</code> in an equality comparison. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Rounding-Errors/anti/inexact.sql">Rounding-Errors/anti/inexact.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Accounts&nbsp;WHERE&nbsp;hourly_rate&nbsp;=&nbsp;59.95;</code></span><br class="calibre1" /></div><p class="calibre_6"> Result: empty set; no rows match. </p><p class="calibre_6"> We saw before that the value stored in <code class="calibre15">hourly_rate</code> is actually slightly more than 59.95. So even though you assigned the value 59.95 to this column for <code class="calibre15">account_id</code> 123, now the row fails to match the previous query. </p><p class="calibre_6"> One common workaround for this issue is to treat floating-point values as "effectively equal" if they are close within a small threshold. Subtract one value from the other, and use SQL's absolute value function <code class="calibre15">ABS</code> to strip the sign from the difference. If the result is zero, then the two values were exactly equal. If the result is small enough, then the two values can be treated as effectively equal. The following query succeeds in finding the row: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Rounding-Errors/anti/threshold.sql">Rounding-Errors/anti/threshold.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Accounts&nbsp;WHERE&nbsp;ABS(hourly_rate&nbsp;-&nbsp;59.95)&nbsp;&lt;&nbsp;0.000001;</code></span><br class="calibre1" /></div><p class="calibre_6"> However, the difference is still large enough that a comparison of finer precision fails: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Rounding-Errors/anti/threshold.sql">Rounding-Errors/anti/threshold.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Accounts&nbsp;WHERE&nbsp;ABS(hourly_rate&nbsp;-&nbsp;59.95)&nbsp;&lt;&nbsp;0.0000001;</code></span><br class="calibre1" /></div><p class="calibre_6"> The appropriate threshold varies, because the absolute difference between the base-10 value and the rounded base-2 value varies. </p><p class="calibre_6"> Another example of the inexact nature of <code class="calibre15">FLOAT</code> causing accuracy problems is when you calculate aggregates of many values. For example, if you use <code class="calibre15">SUM</code> to add up the floating-point values in a column, the sum accumulates the discrepancy caused by rounding all the values. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Rounding-Errors/anti/cumulative.sql">Rounding-Errors/anti/cumulative.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;SUM(&nbsp;b.hours&nbsp;*&nbsp;a.hourly_rate&nbsp;)&nbsp;AS&nbsp;project_cost</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;AS&nbsp;b</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">JOIN&nbsp;Accounts&nbsp;AS&nbsp;a&nbsp;ON&nbsp;(b.assigned_to&nbsp;=&nbsp;a.account_id);</code></span><br class="calibre1" /></div><p class="calibre_6"> The cumulative impact of inexact floating-point numbers is even more severe when calculating the aggregate product of a set of numbers instead of the sum. The difference seems small, but it compounds. For example, if you multiply the value 1 by a factor of exactly 1.0, the result is always 1. It doesn't matter how many times you apply this factor. However, if the factor is actually 0.999, this has a different result. If you multiply a value of one by 0.999 a thousand times in succession, you get a result of about 0.3677. The more times you multiply, the more the discrepancy grows. </p><p class="calibre_6"> A good example of applying a multiplication many times in succession is to calculate compounding interest in a financial application. Using inexact floating-point numbers introduces an error that seems tiny but grows as it compounds on itself. So, using exact values in financial applications is important. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-187">
<pagebreak>
<a id="calibre_link-448">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-449">How to Recognize the Antipattern</h2><p class="calibre_6"> Virtually any use of <code class="calibre15">FLOAT</code>, <code class="calibre15">REAL</code>, or <code class="calibre15">DOUBLE&nbsp;PRECISION</code> data types is suspect. Most applications that use floating-point numbers don't require the range of values supported by IEEE 754 formats. </p><p class="calibre_6"> It seems natural to use <code class="calibre15">FLOAT</code> data types in SQL, because it shares its name with a data type found in most programming languages. But there is a better choice for the data type. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-282">
<pagebreak>
<a id="calibre_link-450">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-451">Legitimate Uses of the Antipattern</h2><p class="calibre_6"><code class="calibre15">FLOAT</code> is a good data type when you need real number values with a greater range than <code class="calibre15">INTEGER</code> or <code class="calibre15">NUMERIC</code> data types support. Scientific applications are often cited as the best use of a <code class="calibre15">FLOAT</code>. </p><p class="calibre_6"> Oracle uses the <code class="calibre15">FLOAT</code> data type to mean an exact scaled numeric, whereas the <code class="calibre15">BINARY_FLOAT</code> data type is an inexact numeric, using the IEEE 754 encoding. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-5">
<pagebreak>
<a id="calibre_link-452">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-453">Solution: Use NUMERIC Data Type</h2><p class="calibre_6"> Instead of <code class="calibre15">FLOAT</code> or its siblings, use the <code class="calibre15">NUMERIC</code> or <code class="calibre15">DECIMAL</code> SQL data types for fixed-precision fractional numbers. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Rounding-Errors/soln/numeric-columns.sql">Rounding-Errors/soln/numeric-columns.sql</a></span></span></div><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Bugs&nbsp;ADD&nbsp;COLUMN&nbsp;hours&nbsp;NUMERIC(9,2);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Accounts&nbsp;ADD&nbsp;COLUMN&nbsp;hourly_rate&nbsp;NUMERIC(9,2);</code></span><br class="calibre1" /></div><p class="calibre_6"> These data types store numeric values exactly, up to the <span>precision</span> you specify in the column definition. Specify precision as an argument to the data type, similar to the syntax you would use for the length of a <code class="calibre15">VARCHAR</code> data type. The precision is the total number of decimal digits you can use in a value in this column. A precision of 9 means that you can store a value like 123456789, but you may not be able to store 1234567890.<a href="#calibre_link-6" id="calibre_link-7">[11]</a></p><p class="calibre_6"> You may also specify a <span>scale</span> in a second argument to the data type. The scale is the number of digits to the right of the decimal point. These digits are included in the precision digits, so a precision of 9 with a scale of 2 means you can store a value like 1234567.89, but not 12345678.91 or 123456.789. </p><p class="calibre_6"> The precision and scale you specify applies to the column on all rows in the table. In other words, you can't store values with scale 2 on some rows and scale 4 on other rows. It's ordinary in SQL that a column's data type applies uniformly on all rows (just as a column defined as <code class="calibre15">VARCHAR(20)</code> would allow a string of that length on every row). </p><p class="calibre_6"> The advantage of <code class="calibre15">NUMERIC</code> and <code class="calibre15">DECIMAL</code> are that they store rational numbers without rounding, as the <code class="calibre15">FLOAT</code> data types do. After you set a value to 59.95, you can depend on that value being stored exactly. When you compare it for equality to a literal value 59.95, the comparison succeeds. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Rounding-Errors/soln/exact.sql">Rounding-Errors/soln/exact.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;hourly_rate&nbsp;FROM&nbsp;Accounts&nbsp;WHERE&nbsp;hourly_rate&nbsp;=&nbsp;59.95;</code></span><br class="calibre1" /></div><p class="calibre_6"> Returns: <code class="calibre15">59.95</code></p><p class="calibre_6"> Likewise, if you scale up the value by a billion, you get the expected value: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Rounding-Errors/soln/magnify-rate-exact.sql">Rounding-Errors/soln/magnify-rate-exact.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;hourly_rate&nbsp;*&nbsp;1000000000&nbsp;FROM&nbsp;Accounts&nbsp;WHERE&nbsp;hourly_rate&nbsp;=&nbsp;59.95;</code></span><br class="calibre1" /></div><p class="calibre_6"> Returns: <code class="calibre15">59950000000</code></p><p class="calibre_6"> The data types <code class="calibre15">NUMERIC</code> and <code class="calibre15">DECIMAL</code> behave identically; there should be no difference between them. <code class="calibre15">DEC</code> is also a synonym for <code class="calibre15">DECIMAL</code>. </p><p class="calibre_6"> You still can't store values that require infinite precision, such as one-third. But at least we're more familiar with values that have this restriction in decimal format. </p><p class="calibre_6"> If you need exact decimal values, use the <code class="calibre15">NUMERIC</code> data type. The <code class="calibre15">FLOAT</code> data type is unable to represent many decimal rational numbers, so they should be treated as inexact values. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Do not use <code class="calibre15">FLOAT</code> if you can avoid it.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-7" id="calibre_link-6">[11]</a>
<small class="calibre3"> In some brands of database, the size of the column is rounded up internally to the nearest byte, word, or double word, so the maximum value of a <code class="calibre15">NUMERIC</code> column may have more digits than the precision you specified. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-454"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-52">
<pagebreak>
<a id="calibre_link-455">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-217" class="calibre12"><small class="calibre13">Chapter 11</small><br class="calibre14" />31 Flavors</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> Science is feasible when the variables are few and can be enumerated; when their combinations are distinct and clear. </em></p></div><div class="calibre1"><div class="calibre4"><span>Paul Valéry</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> In a personal contact information table, the <span>salutation</span> is a good example of a column that can have only a few values. Once you support <code class="calibre15">Mr.</code>, <code class="calibre15">Mrs.</code>, <code class="calibre15">Ms.</code>, <code class="calibre15">Dr.</code>, and <code class="calibre15">Rev.</code>, you've accounted for virtually everyone. You could specify this list in the column definition, using a data type or a constraint, so that no one can accidentally enter an invalid string into the <code class="calibre15">salutation</code> column. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/intro/create-table.sql">31-Flavors/intro/create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;PersonalContacts&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;other&nbsp;columns</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;salutation&nbsp;VARCHAR(4)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;CHECK&nbsp;(salutation&nbsp;IN&nbsp;(<em class="calibre6">'Mr.'</em>,&nbsp;<em class="calibre6">'Mrs.'</em>,&nbsp;<em class="calibre6">'Ms.'</em>,&nbsp;<em class="calibre6">'Dr.'</em>,&nbsp;<em class="calibre6">'Rev.'</em>)),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> That should settle it, since there are no other salutations you need to support, right? </p><p class="calibre_6"> Unfortunately, your boss tells you that your company is opening a subsidiary in France. You need to support the salutations <code class="calibre15">M.</code>, <code class="calibre15">Mme.</code>, and <code class="calibre15">Mlle.</code> Your assignment is to alter your contact table to permit these values. This is a delicate job and may not be possible without interrupting availability of that table. </p><p class="calibre_6"> You also thought your boss mentioned that the company is trying to open an office next month in Brazil. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-98">
<pagebreak>
<a id="calibre_link-456">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-457">Objective: Restrict a Column to Specific Values</h2><p class="calibre_6"> Restricting a column's values to a fixed set of values is very useful. If we can ensure that the column never contains an invalid entry, it can simplify use of that column. </p><p class="calibre_6"> For example, in the <code class="calibre15">Bugs</code> table of our example database, the <code class="calibre15">status</code> column indicates whether a given bug is <code class="calibre15">NEW</code>, <code class="calibre15">IN&nbsp;PROGRESS</code>, <code class="calibre15">FIXED</code>, and so on. The significance of each of these status values depends on how we manage bugs in our project, but the point is that the data in the column must be one of these values. </p><p class="calibre_6"> Ideally, we need the database to reject invalid data: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/obj/insert-invalid.sql">31-Flavors/obj/insert-invalid.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Bugs&nbsp;(status)&nbsp;VALUES&nbsp;(<em class="calibre6">'NEW'</em>);&nbsp;<em class="calibre6">--&nbsp;OK</em></code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Bugs&nbsp;(status)&nbsp;VALUES&nbsp;(<em class="calibre6">'BANANA'</em>);&nbsp;<em class="calibre6">--&nbsp;Error!</em></code></span><br class="calibre1" /></div></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-170">
<pagebreak>
<a id="calibre_link-458">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-459">Antipattern: Specify Values in the Column Definition</h2><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Baskin-Robbins 31 Ice Cream</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> In 1953, this famous chain of ice cream parlors offered one flavor for each day of the month. The chain used the slogan <span>31&nbsp;Flavors</span> for many years. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Today, more than sixty years later, Baskin-Robbins offers twenty-one classic flavors, twelve seasonal flavors, sixteen regional flavors, as well as a variety of Bright Choices and Flavors of the Month. Even though its ice cream flavors were once an immutable set that defined its brand, Baskin-Robbins expanded its choices and made them configurable and variable. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The same thing could happen in the project for which you're designing a database---in fact, you should count on it. </blockquote></small></p></div><hr class="calibre7" /></div><p class="calibre_6"> Many people choose to specify the valid data values when they define the column. The column definition is part of the <span>metadata</span>---the definition of the table structure itself. </p><p class="calibre_6"> For example, you could define a <span>check constraint</span> on the column. This constraint disallows any insert or update that would make the constraint false. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/anti/create-table-check.sql">31-Flavors/anti/create-table-check.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;other&nbsp;columns</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;&nbsp;VARCHAR(20)&nbsp;CHECK&nbsp;(status&nbsp;IN&nbsp;(<em class="calibre6">'NEW'</em>,&nbsp;<em class="calibre6">'IN&nbsp;PROGRESS'</em>,&nbsp;<em class="calibre6">'FIXED'</em>))</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> MySQL supports a nonstandard data type called <code class="calibre15">ENUM</code> that restricts the column to a specific set of values. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/anti/create-table-enum.sql">31-Flavors/anti/create-table-enum.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;other&nbsp;columns</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;ENUM(<em class="calibre6">'NEW'</em>,&nbsp;<em class="calibre6">'IN&nbsp;PROGRESS'</em>,&nbsp;<em class="calibre6">'FIXED'</em>),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> In MySQL's implementation, you declare the values as strings, but internally the column is stored as the ordinal number of the string in the enumerated list. The storage is therefore compact, but when you sort a query by this column, the result is ordered by the ordinal value, not alphabetically by the string value. You may not expect this behavior. </p><p class="calibre_6"> Other solutions include <span>domains</span> and <span>user-defined types</span> (UDTs). You can use these to restrict a column to a specific set of values and conveniently apply the same domain or data type to several columns within your database. But these features are not supported widely among brands of RDBMSs yet. </p><p class="calibre_6"> Finally, you could write a trigger that contains the set of permitted values and raises an error unless the <code class="calibre15">status</code> matches one of these values. </p><p class="calibre_6"> All of these solutions share some disadvantages. The following sections describe some of these problems. </p><h3 class="calibre_8">What Was the Middle One?</h3><p class="calibre_6"> Suppose you're developing a user interface for the bug tracker so that a user can edit bug reports. To make the interface guide the user to pick one of the valid <code class="calibre15">status</code> values, you choose to fill a drop-down menu control with these values. How do you query the database for an enumerated list of values that are currently allowed in the <code class="calibre15">status</code> column? </p><p class="calibre_6"> Your first instinct might be to query all the values currently in use, with a simple query like the following one: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/anti/distinct.sql">31-Flavors/anti/distinct.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;DISTINCT&nbsp;status&nbsp;FROM&nbsp;Bugs;</code></span><br class="calibre1" /></div><p class="calibre_6"> However, if all the bugs are new, the previous query returns only <code class="calibre15">NEW</code>. If you use this result to populate a user interface control for the <code class="calibre15">status</code> of bugs, you could create a chicken-and-egg situation; you can't change a bug to any status other than those currently in use. </p><p class="calibre_6"> To get the complete list of permitted <code class="calibre15">status</code> values, you need to query the definition of that column's metadata. Most SQL databases support <span>system views</span> for these kinds of queries, but using them can be complex. For example, if you used MySQL's <code class="calibre15">ENUM</code> data type, you can use the following query to query the <code class="calibre15">INFORMATION_SCHEMA</code> system views: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/anti/information-schema.sql">31-Flavors/anti/information-schema.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;column_type</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;information_schema.columns</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;table_schema&nbsp;=&nbsp;<em class="calibre6">'bugtracker_schema'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;AND&nbsp;table_name&nbsp;=&nbsp;<em class="calibre6">'bugs'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;AND&nbsp;column_name&nbsp;=&nbsp;<em class="calibre6">'status'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> You can't simply get the discrete enumeration values from the <code class="calibre15">INFORMATION_SCHEMA</code> in a conventional result set. Instead, you get a string containing the definition of the check constraint or <code class="calibre15">ENUM</code> data type. For example, the previous query in MySQL returns a column of type <code class="calibre15">LONGTEXT</code>, with the value <code class="calibre15">ENUM('NEW', 'IN&nbsp;PROGRESS', 'FIXED')</code>, including the parentheses, commas, and single quotes. You must write application code to parse this string and extract the individual quoted values before you can use them to populate a user interface control. </p><p class="calibre_6"> The queries needed to report check constraints, domains, or UDTs are progressively more complex. Most people choose the better part of valor and manually maintain a parallel list of values in application code. This is an easy way for bugs to affect your project as application data becomes out of sync with the database metadata. </p><h3 class="calibre_8">Adding a New Flavor</h3><p class="calibre_6"> The most common alterations are to add or remove one of the permitted values. There's no syntax to add or remove a value from an <code class="calibre15">ENUM</code> or check constraint; you can only redefine the column with a new set of values. The following is an example of adding <code class="calibre15">DUPLICATE</code> as one new <code class="calibre15">status</code> value in the MySQL <code class="calibre15">ENUM</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/anti/add-enum-value.sql">31-Flavors/anti/add-enum-value.sql</a></span></span></div><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Bugs&nbsp;MODIFY&nbsp;COLUMN&nbsp;status</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ENUM(<em class="calibre6">'NEW'</em>,&nbsp;<em class="calibre6">'IN&nbsp;PROGRESS'</em>,&nbsp;<em class="calibre6">'FIXED'</em>,&nbsp;<em class="calibre6">'DUPLICATE'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> You need to know that the previous definition of the column allowed <code class="calibre15">NEW</code>, <code class="calibre15">IN&nbsp;PROGRESS</code>, and <code class="calibre15">FIXED</code>. This leads you back to the difficulty of querying the current set of values as described earlier. </p><p class="calibre_6"> Some database brands can't change the definition of a column unless the table is empty. You might need to dump the contents of the table, redefine the table, and then import your saved data, making the table inaccessible in the meantime. This work is common enough that it has a name: <span>ETL</span> for "extract, transform, and load." Other brands of database support restructuring a populated table with <code class="calibre15">ALTER&nbsp;TABLE</code> commands, but it can still be complex and expensive to perform these changes. </p><p class="calibre_6"> As a matter of policy, changing metadata---that is, changing the definition of tables and columns---should be infrequent and with attention to testing and quality assurance. If you need to change metadata to add or remove a value from an <code class="calibre15">ENUM</code>, then you either have to skip the appropriate testing or spend a lot of software engineering effort on short notice to make the change. Either way, these changes introduce risk and destabilize your project. </p><h3 class="calibre_8">Old Flavors Never Die</h3><p class="calibre_6"> If you make a value obsolete, you could upset historical data. For example, you change your quality control process to replace <code class="calibre15">FIXED</code> with two stages, <code class="calibre15">CODE&nbsp;COMPLETE</code> and <code class="calibre15">VERIFIED</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/anti/remove-enum-value.sql">31-Flavors/anti/remove-enum-value.sql</a></span></span></div><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Bugs&nbsp;MODIFY&nbsp;COLUMN&nbsp;status</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ENUM(<em class="calibre6">'NEW'</em>,&nbsp;<em class="calibre6">'IN&nbsp;PROGRESS'</em>,&nbsp;<em class="calibre6">'CODE&nbsp;COMPLETE'</em>,&nbsp;<em class="calibre6">'VERIFIED'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> If you remove <code class="calibre15">FIXED</code> from the enumeration, what do you do with bugs whose <code class="calibre15">status</code> was <code class="calibre15">FIXED</code>? Should you advance all <code class="calibre15">FIXED</code> bugs to <code class="calibre15">VERIFIED</code>? Should you instead set obsolete values to null or a default value? </p><p class="calibre_6"> You may have to keep an obsolete value that old rows reference. But then how can you distinguish between obsolete values and exclude them from your user interface so that no one can set a bug's status to the obsolete value? </p><h3 class="calibre_8">Portability Is Hard</h3><p class="calibre_6"> Check constraints, domains, and UDTs are not supported uniformly among brands of SQL databases. The <code class="calibre15">ENUM</code> data type is a proprietary feature in MySQL. Each brand of database may have a different limit on the length of the list you can give in a column definition. Trigger languages vary as well. These variations make it hard to choose a solution if you need to support multiple brands of database. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-252">
<pagebreak>
<a id="calibre_link-460">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-461">How to Recognize the Antipattern</h2><p class="calibre_6"> The problems with using <code class="calibre15">ENUM</code> or a check constraint arise when the set of values is not fixed. If you're considering using <code class="calibre15">ENUM</code>, first ask yourself whether the set of values are expected to change or even whether they <em class="calibre6">might</em> change. If so, it's probably not a good time to employ an <code class="calibre15">ENUM</code>. </p><ul class="calibre_14"><li class="calibre_15"> "We have to take the database offline so we can add a new choice in one of our application's menus. It should take no more than thirty minutes, if all goes well." <br class="calibre_16" /> This is a sign that a set of values is baked into the definition of a column. You should never need to interrupt service for a change like this. </li><li class="calibre_15"> "The <code class="calibre15">status</code> column can have one of the following values. We should not need to revise this list." <br class="calibre_16" /><em class="calibre6">Shouldn't need to</em> are weasel words, and this says something quite different from <em class="calibre6">can't</em>. </li><li class="calibre_15"> "The list of values in the application code got out of sync with the business rules in the database---again." <br class="calibre_16" /> This is a risk of maintaining information in two different places. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-307">
<pagebreak>
<a id="calibre_link-462">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-463">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> As we discussed, <code class="calibre15">ENUM</code> may cause fewer problems if the set of values is unchanging. It's still difficult to query the metadata for the set of values, but you can maintain a matching list of values in application code without getting out of sync. </p><p class="calibre_6"><code class="calibre15">ENUM</code> is most likely to succeed when it would make no sense to alter the set of permitted values, such as when a column represents an either/or choice with two mutually exclusive values: <code class="calibre15">LEFT</code>/<code class="calibre15">RIGHT</code>, <code class="calibre15">ACTIVE</code>/<code class="calibre15">IN-</code><code class="calibre15">ACTIVE</code>, <code class="calibre15">ON</code>/<code class="calibre15">OFF</code>, <code class="calibre15">INTERNAL</code>/<code class="calibre15">EXTERNAL</code>, and so on. </p><p class="calibre_6"> Check constraints can be used in many ways other than simply to implement an <code class="calibre15">ENUM</code>-like mechanism, such as checking that a time interval's <code class="calibre15">start</code> is less than its <code class="calibre15">end</code>. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-28">
<pagebreak>
<a id="calibre_link-464">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-465">Solution: Specify Values in Data</h2><p class="calibre_6"> There's a better solution to restrict values in a column: create a <span>lookup table</span> with one row for each value you allow in the <code class="calibre15">Bugs.status</code> column. Then declare a foreign key constraint on <code class="calibre15">Bugs.status</code> referencing the new table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/soln/create-lookup-table.sql">31-Flavors/soln/create-lookup-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugStatus&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;VARCHAR(20)&nbsp;PRIMARY&nbsp;KEY</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;BugStatus&nbsp;(status)&nbsp;VALUES&nbsp;(<em class="calibre6">'NEW'</em>),&nbsp;(<em class="calibre6">'IN&nbsp;PROGRESS'</em>),&nbsp;(<em class="calibre6">'FIXED'</em>);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;other&nbsp;columns</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(status)&nbsp;REFERENCES&nbsp;BugStatus(status)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;UPDATE&nbsp;CASCADE</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> When you insert or update a row in the <code class="calibre15">Bugs</code> table, you must use a <code class="calibre15">status</code> value that exists in the <code class="calibre15">BugStatus</code> table. This enforces the status values like the <code class="calibre15">ENUM</code> or a check constraint, but there are several ways this solution offers more flexibility. </p><h3 class="calibre_8">Querying the Set of Values</h3><p class="calibre_6"> The set of permitted values is now stored in data, not metadata as it was with the <code class="calibre15">ENUM</code> data type. You can query data values from a lookup table with <code class="calibre15">SELECT</code>, just like any other table. This makes it much easier to retrieve the set of values as a data set to present in your user interface. You can even sort the set of values the user can choose from. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/soln/query-canonical-values.sql">31-Flavors/soln/query-canonical-values.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;status&nbsp;FROM&nbsp;BugStatus&nbsp;ORDER&nbsp;<span class="calibre10">by</span>&nbsp;status;</code></span><br class="calibre1" /></div><h3 class="calibre_8">Updating the Values in the Lookup Table</h3><p class="calibre_6"> When you use a lookup table, you can add a value to the set with an ordinary <code class="calibre15">INSERT</code> statement. You can make a change like this without interrupting access to the table. You don't need to redefine any columns, schedule downtime, or perform an ETL operation. You also don't need to know the current set of values in the lookup table to add or remove a value. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/soln/insert-value.sql">31-Flavors/soln/insert-value.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;BugStatus&nbsp;(status)&nbsp;VALUES&nbsp;(<em class="calibre6">'DUPLICATE'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> You can also rename a value easily, if you declared the foreign key with the <code class="calibre15">ON&nbsp;UPDATE&nbsp;CASCADE</code> option. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/soln/update-value.sql">31-Flavors/soln/update-value.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;BugStatus&nbsp;SET&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'INVALID'</em>&nbsp;WHERE&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'BOGUS'</em>;</code></span><br class="calibre1" /></div><h3 class="calibre_8">Supporting Obsolete Values</h3><p class="calibre_6"> You can't <code class="calibre15">DELETE</code> a row from the lookup table if it's referenced by a row in <code class="calibre15">Bugs</code>. The foreign key on the <code class="calibre15">status</code> column enforces referential integrity, so the value must exist in the lookup table. </p><p class="calibre_6"> However, you can add another attribute column to the lookup table to designate some values as obsolete. This allows you to maintain historical data in the <code class="calibre15">Bugs.status</code> column, while distinguishing between the obsolete values and values that are eligible to appear in your user interface. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/soln/inactive.sql">31-Flavors/soln/inactive.sql</a></span></span></div><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;BugStatus&nbsp;ADD&nbsp;COLUMN&nbsp;active</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ENUM(<em class="calibre6">'INACTIVE'</em>,&nbsp;<em class="calibre6">'ACTIVE'</em>)&nbsp;NOT&nbsp;NULL&nbsp;DEFAULT&nbsp;<em class="calibre6">'ACTIVE'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> Use <code class="calibre15">UPDATE</code> instead of <code class="calibre15">DELETE</code> to make a value obsolete: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/soln/update-inactive.sql">31-Flavors/soln/update-inactive.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;BugStatus&nbsp;SET&nbsp;active&nbsp;=&nbsp;<em class="calibre6">'INACTIVE'</em>&nbsp;WHERE&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'DUPLICATE'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> When you retrieve the set of values to show in a user interface for users to pick, restrict the query to status values that are <code class="calibre15">ACTIVE</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/31-Flavors/soln/select-active.sql">31-Flavors/soln/select-active.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;status&nbsp;FROM&nbsp;BugStatus&nbsp;WHERE&nbsp;active&nbsp;=&nbsp;<em class="calibre6">'ACTIVE'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> This gives you more flexibility than an <code class="calibre15">ENUM</code> or a check constraint, because those solutions don't support extra attributes per value. </p><h3 class="calibre_8">Portability Is Easy</h3><p class="calibre_6"> Unlike the <code class="calibre15">ENUM</code> data type, check constraints, or domains or UDTs, the lookup table solution relies only on the standard SQL feature of declarative referential integrity using foreign key constraints. This makes the solution more portable. </p><p class="calibre_6"> You can also keep a virtually unlimited number of values in your lookup table, since you store each value on a separate row. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Use metadata when validating against a fixed set of values.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Use data when validating against a fluid set of values.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-466"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-81">
<pagebreak>
<a id="calibre_link-467">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-218" class="calibre12"><small class="calibre13">Chapter 12</small><br class="calibre14" />Phantom Files</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> Whenever a theory appears to you as the only possible one, take this as a sign that you have neither understood the theory nor the problem which it was intended to solve. </em></p></div><div class="calibre1"><div class="calibre4"><span>Karl Popper</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> Catastrophe strikes your database server. While relocating a rack full of hard drives, the rack tipped over and crashed. Fortunately, no one was hurt, but the massive hard drives shattered. Even the raised floor was broken where they fell. Fortunately, the IT department is prepared: they make good backups of every important system every day, and they quickly deploy a new server and restore your database. </p><p class="calibre_6"> It doesn't take long during smoke testing to notice a problem: your application associates graphic images with many database entities, but all the images are missing! You call the IT technician immediately. </p><p class="calibre_6"> "We restored the database and verified it's complete as of the last backup," the technician says. "Where were the images stored?" </p><p class="calibre_6"> You remember now that in this application, images are stored outside the database, and ordinary files are stored on the filesystem. The database stores the path to the image, and the application opens each image file at that path. "The images were stored as files. They were on the <code class="calibre15">/var</code> filesystem, same as the databases." </p><p class="calibre_6"> The technician shakes his head. "We don't back up files on the <code class="calibre15">/var</code> filesystem unless you specifically told us which ones. We back up any databases, of course, but other files on <code class="calibre15">/var</code> are usually just logs, cache data, or other temporary files. By default, they don't get backed up." </p><p class="calibre_6"> Your heart sinks. There were more than 11,000 images used in your product catalog database. Most of them probably exist in other places, but tracking them all down, reformatting them, and generating thumbnail versions for web searches will take weeks. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-154">
<pagebreak>
<a id="calibre_link-468">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-469">Objective: Store Images or Other Bulky Media</h2><p class="calibre_6"> Images and other media are used in most applications these days. Sometimes media are associated with entities stored in the database. For example, you may allow a user to have a portrait or avatar that is displayed when he posts a comment. In our bugs database, bugs often need a screenshot to illustrate the circumstances of the defect. </p><p class="calibre_6"> The objective described in this chapter is to store images and associate them with database entities, such as user accounts or bugs. When we query these entities from the database, we need the capability to retrieve the associated images in the application. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-208">
<pagebreak>
<a id="calibre_link-470">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-471">Antipattern: Assume You Must Use Files</h2><p class="calibre_6"> Conceptually, an image is an attribute in a table. For example, the <code class="calibre15">Accounts</code> table may have a <code class="calibre15">portrait_image</code> column. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Phantom-Files/anti/create-accounts.sql">Phantom-Files/anti/create-accounts.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Accounts&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_name&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;portrait_image&nbsp;&nbsp;BLOB</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Likewise, you can store multiple images of the same type in a dependent table. For example, each bug may have multiple screenshots that illustrate the bug. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Phantom-Files/anti/create-screenshots.sql">Phantom-Files/anti/create-screenshots.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Screenshots&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;image_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;screenshot_image&nbsp;&nbsp;BLOB,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;caption&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(100),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(bug_id,&nbsp;image_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> That much is straightforward, but choosing the data type for an image is a subject of controversy. Raw binary data for an image can be stored in a <code class="calibre15">BLOB</code> data type, as shown previously. However, many people instead store the image as a file on the filesystem and store the path to this file as a <code class="calibre15">VARCHAR</code>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Phantom-Files/anti/create-screenshots-path.sql">Phantom-Files/anti/create-screenshots-path.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Screenshots&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;image_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;screenshot_path&nbsp;&nbsp;&nbsp;VARCHAR(100),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;caption&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(100),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(bug_id,&nbsp;image_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Software developers argue passionately about this issue. There are good reasons for both solutions, but it's common for programmers to be unequivocal that we should always store files external to the database. It may put me in an unpopular position, but I'm going to describe several real risks to this design in the following sections. </p><h3 class="calibre_8">Files Don't Obey DELETE</h3><p class="calibre_6"> The first problem is one of garbage collection. If your images are outside the database and you delete the row that contains the path, there is no way for the file named by that path to be removed automatically. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Phantom-Files/anti/delete.sql">Phantom-Files/anti/delete.sql</a></span></span></div><span class="calibre3"><code class="calibre15">DELETE&nbsp;FROM&nbsp;Screenshots&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234&nbsp;<span class="calibre10">and</span>&nbsp;image_id&nbsp;=&nbsp;1;</code></span><br class="calibre1" /></div><p class="calibre_6"> Unless you design your application to remove these "orphaned" image files as you delete the database row that references them, they will accumulate. </p><h3 class="calibre_8">Files Don't Obey Transaction Isolation</h3><p class="calibre_6"> Normally, when you update or delete data, these changes aren't visible to other clients until you finish your transaction with <code class="calibre15">COMMIT</code>. </p><p class="calibre_6"> However, any change you make to files outside the database don't work this way. If you remove a file, it is immediately inaccessible to other clients. And if you change the contents of the file, other clients see those changes immediately, instead of seeing the previous content of the file while your transaction is still uncommitted. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Phantom-Files/anti/transaction.php">Phantom-Files/anti/transaction.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query("DELETE&nbsp;FROM&nbsp;Screenshots</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234&nbsp;AND&nbsp;image_id&nbsp;=1");</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">unlink(<em class="calibre6">'images/screenshot1234-1.jpg'</em>);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">//&nbsp;Other&nbsp;clients&nbsp;still&nbsp;see&nbsp;the&nbsp;row&nbsp;in&nbsp;the&nbsp;database,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">//&nbsp;but&nbsp;not&nbsp;the&nbsp;image&nbsp;file.</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$pdo-&gt;commit();</code></span><br class="calibre1" /></div><p class="calibre_6"> In practice, these kinds of anomalies may be infrequent. Also, the impact is minor in this example; a missing image is hardly rare in a web application. But in other scenarios, the consequences could be unfortunate. </p><h3 class="calibre_8">Files Don't Obey ROLLBACK</h3><p class="calibre_6"> It's normal to roll back transactions in case of errors, or even if the logic of your application requires that changes be canceled. </p><p class="calibre_6"> For example, suppose you remove a screenshot file as you execute a <code class="calibre15">DELETE</code> statement to remove the corresponding row in the database. If you roll back this change, the deletion of the row in the database is reversed, but the file is still gone. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Phantom-Files/anti/rollback.php">Phantom-Files/anti/rollback.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query("DELETE&nbsp;FROM&nbsp;Screenshots</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234&nbsp;AND&nbsp;image_id&nbsp;=1");</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">unlink("images/screenshot1234-1.jpg");</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$pdo-&gt;rollback();</code></span><br class="calibre1" /></div><p class="calibre_6"> The row in the database is restored but not the image file. </p><h3 class="calibre_8">Files Don't Obey Database Backup Tools</h3><p class="calibre_6"> Most database brands provide a client tool to assist in backing up a database that is in use. For example, MySQL provides <code class="calibre15">mysqldump</code>, Oracle provides <code class="calibre15">rman</code>, PostgreSQL provides <code class="calibre15">pg_dump</code>, SQLite provides the <code class="calibre15">.dump</code> command, and so on. Using a backup tool is important because if other clients are making changes concurrently, your backup could contain partial changes, potentially breaking referential integrity or even making the backup corrupt and useless for recovery. </p><p class="calibre_6"> A backup tool doesn't know how to include files referenced by pathname in a <code class="calibre15">VARCHAR</code> column of a table. So when you back up a database, you need to remember a two-step process: use the database backup tool, and then use a filesystem backup tool for the collection of external image files. </p><p class="calibre_6"> Even if you include the external files with the backup, it's hard to ensure that copies of these files are in sync with the transaction you used to back up the database. Applications may add or change image files at any time, perhaps only a moment after you began your database backup. </p><h3 class="calibre_8">Files Don't Obey SQL Access Privileges</h3><p class="calibre_6"> External files circumvent any privileges that you assign with the <code class="calibre15">GRANT</code> and <code class="calibre15">REVOKE</code> SQL statements. SQL privileges manage access to tables and columns, but they don't apply to external files named by strings in the database. </p><h3 class="calibre_8">Files Are Not SQL Data Types</h3><p class="calibre_6"> The path stored in <code class="calibre15">screenshot_path</code> is merely a string. The database doesn't verify that the string is a valid pathname, nor can the database verify that the file exists at the path you name. If the file is renamed, moved, or deleted, the database doesn't update the string in the database automatically. Any logic that treats this string as a pathname depends on code you write in your application. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Phantom-Files/anti/file-get.php">Phantom-Files/anti/file-get.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">define(<em class="calibre6">'DATA_DIRECTORY'</em>,&nbsp;<em class="calibre6">'/var/bugtracker/data/'</em>);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query("SELECT&nbsp;image_path&nbsp;FROM&nbsp;Screenshots</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234&nbsp;AND&nbsp;image_id&nbsp;=&nbsp;1");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$row&nbsp;=&nbsp;$stmt-&gt;fetch();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$image_path&nbsp;=&nbsp;$row[0];</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">//&nbsp;Read&nbsp;the&nbsp;actual&nbsp;image&nbsp;--&nbsp;I&nbsp;hope&nbsp;the&nbsp;path&nbsp;is&nbsp;correct!</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$image&nbsp;=&nbsp;file_get_contents(DATA_DIRECTORY&nbsp;.&nbsp;$image_path);</code></span><br class="calibre1" /></div><p class="calibre_6"> One advantage of using a database is that it helps us preserve data integrity. When you put some of your data in external files, you circumvent this advantage, and you have to write application code to perform checks that should be handled by the database. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-288">
<pagebreak>
<a id="calibre_link-472">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-473">How to Recognize the Antipattern</h2><p class="calibre_6"> The signs of this antipattern require a little investigation. If the project has any documentation to guide software administrators or if you have the opportunity to interview the programmers who designed it (even if that's you), seek the answers to questions like the following: </p><ul class="calibre_14"><li class="calibre_15"> What is the data backup and restore procedure? How can a backup be verified? Have you tested restoring data on a clean server or a different server than where the backup was made? </li><li class="calibre_15"> Do images accumulate, or are they removed from the system when they are obsolete? What is the procedure for removing them? Is this an automated or manual procedure? </li><li class="calibre_15"> Which users of the application have access to view images? How is access enforced? What do users see if they request to view images they don't have privilege to see? </li><li class="calibre_15"> Can I cancel a change to an image? If so, should the application restore the previous state of an image? </li></ul><p class="calibre_6"> Projects that are guilty of the antipattern typically fail to think through some or all of these questions. Not every application needs robust transaction management or SQL access control for image files. You might find that taking a database offline during backups is a fair trade-off. If these answers are unclear or not forthcoming, it could indicate that the project designed their use of external files carelessly. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-12">
<pagebreak>
<a id="calibre_link-474">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 id="calibre_link-475" class="calibre_7">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> There are good reasons to store images or other large objects in files outside the database: </p><ul class="calibre_14"><li class="calibre_15"> The database is much leaner without images, because images tend to be large compared to simple datatypes like integers and strings. </li><li class="calibre_15"> Backing up the database is faster and the result is smaller if images are not included. You must copy images from the filesystem as a separate backup step, but this can be more manageable than a huge database backup. </li><li class="calibre_15"> If images are in files external to the database, it's easier to do ad hoc image previewing or editing. For example, if you need to apply a batch edit to all your images, it's especially good to keep images external to the database. </li></ul><p class="calibre_6"> If these advantages of storing images in files are important and the issues described earlier are not deal-breakers, you may decide that it's the right thing to do in this project. </p><p class="calibre_6"> Some database brands support special SQL data types that do reference external files more or less transparently. Oracle calls this data type <code class="calibre15">BFILE</code>, while SQL&nbsp;Server&nbsp;2008 calls it <code class="calibre15">FILESTREAM</code>. </p><blockquote class="calibre_9"><div class="calibre1">Don't Rule Out Either Design</div><div class="calibre1"><p class="calibre_6"> I designed an application that stored images outside a database for a contract project in 1992. My employer was hired to develop a registration application for a technical conference. As conference attendees arrived, a video camera took their picture, added it to their registration record, and printed it on their conference badge. </p><p class="calibre_6"> My application was fairly simple. Each image could be inserted and updated only by one client application (if the person blinked or didn't like their photo, we could replace it during registration). There was no requirement for sophisticated transaction handling, concurrent access from multiple clients, or rollback. We were not using SQL access privileges. Previewing the images was simpler without having to fetch them from the database. </p><p class="calibre_6"> I worked on this project at a time when the practical limits of applications and databases were much lower than what today's technology can handle. It made sense given these constraints to store images in a collection of directories and manage them with application code. </p></div></blockquote><p class="calibre_6"> You need to plan how your application uses images to know whether the issues described in the "Antipattern" section would affect you. Make an informed decision, instead of listening to generalizations from programmers that storing images in external files is always the best solution. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-75">
<pagebreak>
<a id="calibre_link-476">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-477">Solution: Use BLOB Data Types As Needed</h2><p class="calibre_6"> If any of the issues described in the "Antipattern" section of this chapter apply to you, you should consider storing images inside the database instead of in external files. All database brands support the <code class="calibre15">BLOB</code> data type, which you can use to store any binary data. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Phantom-Files/soln/create-screenshots.sql">Phantom-Files/soln/create-screenshots.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Screenshots&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;image_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;screenshot_image&nbsp;&nbsp;BLOB,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;caption&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(100),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(bug_id,&nbsp;image_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> If you store an image in this way in a <code class="calibre15">BLOB</code> column, all the issues are solved: </p><ul class="calibre_14"><li class="calibre_15"> The image data is stored in the database. There is no extra step to load it. There's no risk that the file's pathname is incorrect. </li><li class="calibre_15"> Deleting a row deletes the image automatically. </li><li class="calibre_15"> Changes to an image are not visible to other clients until you commit the change. </li><li class="calibre_15"> Rolling back a transaction restores the previous state of the image. </li><li class="calibre_15"> Updating a row creates a lock, so no other client can update the same image concurrently. </li><li class="calibre_15"> Database backups include all the images. </li><li class="calibre_15"> SQL privileges control access to the image as well as the row. </li></ul><p class="calibre_6"> The maximum size for a <code class="calibre15">BLOB</code> varies by database brand, but it's enough to store most images. All databases should support <code class="calibre15">BLOB</code> or something akin to it. MySQL, for example, provides a data type called <code class="calibre15">MEDIUMBLOB</code> that stores up to 16 megabytes, which is enough for most images. Oracle supports data types called <code class="calibre15">LONG RAW</code> or <code class="calibre15">BLOB</code>, with capacity up to 2 or 4 gigabytes, respectively. Similar data types are available in other database brands. </p><p class="calibre_6"> Images usually exist in a file to begin with, so you need some way to load them into a <code class="calibre15">BLOB</code> column in the database. Some databases provide functions to load external files. For example, MySQL has a function called <code class="calibre15">LOAD_FILE</code> you can use to read a file, typically to store the content in a <code class="calibre15">BLOB</code> column. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Phantom-Files/soln/load-file.sql">Phantom-Files/soln/load-file.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Screenshots</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SET&nbsp;screenshot_image&nbsp;=&nbsp;LOAD_FILE(<em class="calibre6">'images/screenshot1234-1.jpg'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;bug_id&nbsp;=&nbsp;1234&nbsp;AND&nbsp;image_id&nbsp;=&nbsp;1;</code></span><br class="calibre1" /></div><p class="calibre_6"> You can also save the contents of a <code class="calibre15">BLOB</code> column to a file. For example, MySQL has an optional clause of the <code class="calibre15">SELECT</code> statement to store the result of a query verbatim, without any formatting to denote column or row termination. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Phantom-Files/soln/dumpfile.sql">Phantom-Files/soln/dumpfile.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;screenshot_image</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">INTO&nbsp;DUMPFILE&nbsp;<em class="calibre6">'images/screenshot1234-1.jpg'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Screenshots</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;bug_id&nbsp;=&nbsp;1234&nbsp;AND&nbsp;image_id&nbsp;=1;</code></span><br class="calibre1" /></div><p class="calibre_6"> You can also fetch the image data from the <code class="calibre15">BLOB</code> and output it directly. In a web application, you can output binary content such as an image, but you need to set the content type appropriately. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Phantom-Files/soln/binary-content.php">Phantom-Files/soln/binary-content.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">header(<em class="calibre6">'Content-type:&nbsp;image/jpg'</em>);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query("SELECT&nbsp;screenshot_image&nbsp;FROM&nbsp;Screenshots</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234&nbsp;AND&nbsp;image_id&nbsp;=&nbsp;1");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$row&nbsp;=&nbsp;$stmt-&gt;fetch();</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">print</span>&nbsp;$row[0];</code></span><br class="calibre1" /></div><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Resources outside the database are not managed by the database.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-478"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-124">
<pagebreak>
<a id="calibre_link-479">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-164" class="calibre12"><small class="calibre13">Chapter 13</small><br class="calibre14" />Index Shotgun</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> Whenever any result is sought by its aid, the question will then arise---By what course of calculation can these results be arrived at by the machine in the shortest time? </em></p></div><div class="calibre1"><div class="calibre4"><span> Charles Babbage, Passages from the Life of a Philosopher (1864) </span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> "Hey! You got a minute? I could use your help," the Oklahoman accent on the phone is shouting over the data center ventilation. It's the lead database administrator for your company. </p><p class="calibre_6"> "Sure," you answer, a little unsure what he could want. </p><p class="calibre_6"> "The thing is, you've got a database here that's pretty much taken over the server," the DBA continues. "I got in there to take a look, and I see the problem. You've got no indexes on some tables and every index in the world on some other tables. We've got to get this worked out or give you a server all to yerself, because nobody else can get any time!" </p><p class="calibre_6"> "I'm sorry---actually, I don't know that much about databases," you reply, trying to calm down the DBA. "We did our best to guess at the optimization, but obviously that's what an expert like you can do. Isn't there some database tuning you can do?" </p><p class="calibre_6"> "Son, I tuned everything I can; that's why we're still running down here at all," the DBA answers. "The only option left is to throttle your app, and I don't think you want that. We've got to stop guessing and start getting some answers on what your app needs the database to do." </p><p class="calibre_6"> You can tell this is getting over your head. Warily you ask, "What do you have in mind? I told you, we don't have expert database knowledge in our team." </p><p class="calibre_6"> "That's no problem," the DBA laughs. "You do know your application, right? That's the part that counts---and the part I <em class="calibre6">can't</em> help with. I'll get one of my boys to set you up with the right tools, and then we'll fix your bottleneck. You just need a little mentoring. You'll see." </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-194">
<pagebreak>
<a id="calibre_link-480">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-481">Objective: Optimize Performance</h2><p class="calibre_6"> Performance is the single most common concern I hear from database developers. Just look at the talks scheduled at any technical conference: they're full of tools and techniques to squeeze more work out of your database. When I give a talk about a way to structure a database or write SQL to give better reliability, security, or correctness, I'm not surprised when the only question from the audience is, "OK, but how does that affect performance?" </p><p class="calibre_6"> The best technique for improving performance in your database is to use indexes well. An index is a data structure that the database uses to correlate values to the rows where these values occur in a given column. An index provides an easy way for the database to find values more quickly than the brute-force method of searching the whole table from top to bottom. </p><p class="calibre_6"> Software developers typically don't understand how or when to use an index. Documentation and books about databases rarely or never contains a clear guide for when to use an index. Developers can only guess how to use indexes effectively. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-283">
<pagebreak>
<a id="calibre_link-482">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-483">Antipattern: Using Indexes Without a Plan</h2><p class="calibre_6"> When we choose our indexes by guessing, we inevitably make some wrong choices. Misunderstandings about when to use indexes leads to mistakes in one of these three categories: </p><ul class="calibre_14"><li class="calibre_15"> Defining no indexes or not enough indexes </li><li class="calibre_15"> Defining too many indexes or indexes that don't help </li><li class="calibre_15"> Running queries that no index can help </li></ul><h3 class="calibre_8">No Indexes</h3><p class="calibre_6"> We commonly read that a database incurs overhead as it keeps an index up-to-date. Each time we use <code class="calibre15">INSERT</code>, <code class="calibre15">UPDATE</code>, or <code class="calibre15">DELETE</code>, the database has to update the index data structures for that table to be consistent so that our subsequent searches use these indexes to find the right set of rows reliably. </p><p class="calibre_6"> We're trained to think that overhead means waste. So when we read that the database incurs overhead to keep an index updated, we want to eliminate that overhead. Some developers conclude that the remedy is to eliminate the indexes. This advice is common, but it ignores the fact that indexes have benefits that justify their overhead. </p><p class="calibre_6"> Not all overhead is waste. Does your company employ administrative staff, legal professionals, accountants, and pay for facilities, even though those expenses don't directly contribute to generating revenue? Yes, because those people contribute to the success of your company in important ways. </p><p class="calibre_6"> In a typical application, you'll run hundreds of queries against a table for every one update. Every time you run a query that uses an index, you win back the overhead that went into maintaining that index. </p><p class="calibre_6"> An index can also help an <code class="calibre15">UPDATE</code> or <code class="calibre15">DELETE</code> statement by finding the desired rows quickly. For example, the index on the <code class="calibre15">bug_id</code> primary key helps the following statement: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Index-Shotgun/anti/update.sql">Index-Shotgun/anti/update.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Bugs&nbsp;SET&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'FIXED'</em>&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234;</code></span><br class="calibre1" /></div><p class="calibre_6"> A statement that searches an unindexed column has to perform a full table scan to find matching rows. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Index-Shotgun/anti/update-unindexed.sql">Index-Shotgun/anti/update-unindexed.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Bugs&nbsp;SET&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'OBSOLETE'</em>&nbsp;WHERE&nbsp;date_reported&nbsp;&lt;&nbsp;<em class="calibre6">'2000-01-01'</em>;</code></span><br class="calibre1" /></div><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Indexes Aren't Standard</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Did you know that the ANSI SQL standard says nothing about indexes? The implementation and optimization of data storage is not specified by the SQL language, so every brand of database is free to implement indexes differently. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Most brands have similar <code class="calibre15">CREATE INDEX</code> syntax, but each brand has flexibility to innovate and add their own proprietary technology. There's no standard for index capabilities. Likewise, there is no standard for index maintenance, automatic query optimization, query plan reporting, or commands like <code class="calibre15">EXPLAIN</code>. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> To get the most out of indexes, you have to study the documentation for your brand of database. The specific syntax and features of indexes vary greatly, but the logical concepts apply across the board. </blockquote></small></p></div><hr class="calibre7" /></div><h3 class="calibre_8">Too Many Indexes</h3><p class="calibre_6"> You benefit from an index only if you run queries that use that index. There's no benefit to creating indexes that you don't use. Here are some examples: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Index-Shotgun/anti/create-table.sql">Index-Shotgun/anti/create-table.sql</a></span></span></div><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;date_reported&nbsp;DATE&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;summary&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(80)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(10)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;hours&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUMERIC(9,2),</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">1»</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;INDEX&nbsp;(bug_id),&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">2»</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;INDEX&nbsp;(summary),&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">3»</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;INDEX&nbsp;(hours),&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">4»</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;INDEX&nbsp;(bug_id,&nbsp;date_reported,&nbsp;status)&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> In the previous example, there are several useless indexes: </p><dl class="calibre16"><p class="calibre_6"><span><span class="calibre_22">«1»</span></span>&nbsp; <code class="calibre15">bug_id</code>: </p><blockquote class="calibre_9"> Most databases create an index automatically for a primary key, so it's redundant to define another index. There's no benefit to it, and it could just be extra overhead. Each database brand has its own rules for when to create an index automatically. You need to read the documentation for the database you use. <br class="calibre1" /></blockquote><p class="calibre_6"><span><span class="calibre_22">«2»</span></span>&nbsp; <code class="calibre15">summary</code>: </p><blockquote class="calibre_9"> An indexing for a long string datatype like <code class="calibre15">VARCHAR(80)</code> is larger than an index for a more compact data type. Also, you're not likely to run queries that search or sort by the full <code class="calibre15">summary</code> column. <br class="calibre1" /></blockquote><p class="calibre_6"><span><span class="calibre_22">«3»</span></span>&nbsp; <code class="calibre15">hours</code>: </p><blockquote class="calibre_9"> This is another example of a column that you're probably not going to search for specific values. <br class="calibre1" /></blockquote><p class="calibre_6"><span><span class="calibre_22">«4»</span></span>&nbsp; <code class="calibre15">bug_id</code>, <code class="calibre15">date_reported</code>, <code class="calibre15">status</code>: </p><blockquote class="calibre_9"> There are good reasons to use compound indexes, but many people create compound indexes that are redundant or seldom used. Also, the order of columns in a compound index is important; you should use the columns left-to-right in search criteria, join criteria, or sorting order. <br class="calibre1" /></blockquote></dl><blockquote class="calibre_9"><div class="calibre1">Hedging Your Bets</div><div class="calibre1"><p class="calibre_6"> Bill Cosby told a story about his vacation in Las Vegas: He was so frustrated by losing in the casinos that he decided he had to win something---once---before he left. So he bought $200 in quarter chips, went to the roulette table, and put chips on every square, red and black. <em class="calibre6">He covered the table.</em> The dealer spun the ball…and it fell on the floor. </p></div></blockquote><p class="calibre_6"> Some people create indexes on every column---and every combination of columns---because they don't know which indexes will benefit their queries. If you cover a database table with indexes, you incur a lot of overhead with no assurance of payoff. </p><h3 class="calibre_8">When No Index Can Help</h3><p class="calibre_6"> The next type of mistake is to run a query that can't use any index. Developers create more and more indexes, trying to find some magical combination of columns or index options to make their query run faster. </p><p class="calibre_6"> We can think of a database index using an analogy to a telephone book. If I ask you to look up everyone in the telephone book whose last name is Charles, it's an easy task. All the people with the same last name are listed together, because that's how the telephone book is ordered. </p><p class="calibre_6"> However, if I ask you to look up everyone in the telephone book whose <em class="calibre6">first name</em> is Charles, this doesn't benefit from the order of names in the book. Anyone can have that first name, regardless of their last name, so you have to search through the entire book line by line. </p><p class="calibre_6"> The telephone book is ordered by last name and then by first name, just like a compound database index on <code class="calibre15">last_name</code>, <code class="calibre15">first_name</code>. This index doesn't help you search by first name. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Index-Shotgun/anti/create-index.sql">Index-Shotgun/anti/create-index.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;INDEX&nbsp;TelephoneBook&nbsp;ON&nbsp;Accounts(last_name,&nbsp;first_name);</code></span><br class="calibre1" /></div><p class="calibre_6"> Some examples of queries that can't benefit from this index include the following: </p><ul class="calibre_14"><li class="calibre_15"><div class="calibre_11"><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Accounts&nbsp;ORDER&nbsp;BY&nbsp;first_name,&nbsp;last_name;</code></span><br class="calibre1" /></div><br class="calibre_16" /> This query shows the telephone book scenario. If you create a compound index for the columns <code class="calibre15">last_name</code> followed by <code class="calibre15">first_name</code> (as in a telephone book), the index doesn't help you sort primarily by <code class="calibre15">first_name</code>. </li><li class="calibre_15"><div class="calibre_11"><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;MONTH(date_reported)&nbsp;=&nbsp;4;</code></span><br class="calibre1" /></div><br class="calibre_16" /> Even if you create an index for the <code class="calibre15">date_reported</code> column, the order of the index doesn't help you search by month. The order of this index is based on the entire date, starting with the year. But each year has a fourth month, so the rows where the month is equal to 4 are scattered through the table. <br class="calibre_16" /> Some databases support indexes on expressions, or indexes on generated columns, as well as indexes on plain columns. But you have to define the index prior to using it, and that index helps only for the expression you specify in its definition. </li><li class="calibre_15"><div class="calibre_11"><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;last_name&nbsp;=&nbsp;<em class="calibre6">'Charles'</em>&nbsp;OR&nbsp;first_name&nbsp;=&nbsp;<em class="calibre6">'Charles'</em>;</code></span><br class="calibre1" /></div><br class="calibre_16" /> We're back to the problem that rows with that specific first name are scattered unpredictably with respect to the order of the index we defined. The result of the previous query is the same as the result of the following: <div class="calibre_11"><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;last_name&nbsp;=&nbsp;<em class="calibre6">'Charles'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">UNION</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;first_name&nbsp;=&nbsp;<em class="calibre6">'Charles'</em>;</code></span><br class="calibre1" /></div><br class="calibre_16" /> The index in our example helps find that last name, but it doesn't help find that first name. </li><li class="calibre_15"><div class="calibre_11"><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;description&nbsp;LIKE&nbsp;<em class="calibre6">'%crash%'</em>;</code></span><br class="calibre1" /></div><br class="calibre_16" /> Because the pattern in this search predicate could occur anywhere in the string, there's no way the sorted index data structure can help. </li></ul><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Low-Selectivity Indexes</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"><span>Selectivity</span> is a statistic about a database index. It's the ratio of the number of distinct values in the index to the total number of rows in the table: </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15">SELECT&nbsp;COUNT(DISTINCT&nbsp;status)&nbsp;/</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;COUNT(status)&nbsp;AS&nbsp;selectivity&nbsp;FROM&nbsp;Bugs;</code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The lower the selectivity ratio, the less effective an index is. Why is this? Let's consider an analogy. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> This book has an index of a different type: each entry in a book's index lists the pages where the entry's words appear. If a word appears frequently in the book, it may list many page numbers. To find the part of the book you're looking for, you have to turn to each page in the list one by one. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Indexes don't bother to list words that appear on too many pages. If you have to flip back and forth from the index to the pages of the book too much, then you might as well just read the whole book cover to cover. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Likewise in a database index, if a given value appears on many rows in the table, it's more trouble to read the index than simply to scan the entire table. In fact, in these cases it can actually be more expensive to use that index. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Ideally your database tracks the selectivity of indexes and shouldn't use an index that gives no benefit. </blockquote></small></p></div><hr class="calibre7" /></div></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-88">
<pagebreak>
<a id="calibre_link-484">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-485">How to Recognize the Antipattern</h2><p class="calibre_6"> The following are symptoms of the Index Shotgun antipattern: </p><ul class="calibre_14"><li class="calibre_15"> "Here's my query; how can I make it faster?" <br class="calibre_16" /> This is probably the single most common SQL question, but it's missing details about table description, indexes, data volume, and measurements of performance and optimization. Without this context, any answer is just guesswork. </li><li class="calibre_15"> "I defined an index on every field; why isn't it faster?" <br class="calibre_16" /> This is the classic Index Shotgun antisolution. You've tried every possible index---but you're shooting in the dark. </li><li class="calibre_15"> "I read that indexes make the database slow, so I don't use them." <br class="calibre_16" /> Like many developers, you're looking for a one-size-fits-all strategy for performance improvement. No such blanket rule exists. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-155">
<pagebreak>
<a id="calibre_link-486">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-487">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> If you need to design a database for general use, without knowing what queries are important to optimize, you can't be sure of which indexes are best. You have to make an educated guess. It's likely that you'll miss some indexes that could have given benefit. It's also likely that you'll create some indexes that turn out to be unneeded. But you have to make the best guess you can. </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">The Database Isn't Always the Bottleneck</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Common wisdom in software developer communities is that the database is always the slowest part of your application and the source of performance issues. However, this isn't true. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> For example, in one application I worked on, my manager asked me to find out why it was so slow, and he insisted it was the fault of the database. After I used a profiling tool to measure the application code, I found that it spent 80 percent of its time parsing its own HTML output to find form fields so it could populate values into forms. The performance issue had nothing to do with the database queries. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Before making assumptions about where the performance problem exists, use software diagnostic tools to measure. Otherwise, you could be practicing premature optimization. </blockquote></small></p></div><hr class="calibre7" /></div></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-33">
<pagebreak>
<a id="calibre_link-488">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-489">Solution: MENTOR Your Indexes</h2><p class="calibre_6"> The Index Shotgun antipattern is about creating or dropping indexes without reason, so let's come up with ways to analyze a database and find good reasons to include indexes or omit them. </p><p class="calibre_6"> You can use the mnemonic <span>MENTOR</span> to describe a checklist for analyzing your database for good index choices: <span>Measure</span>, <span>Explain</span>, <span>Nominate</span>, <span>Test</span>, <span>Optimize</span>, and <span>Rebuild</span>. </p><h3 class="calibre_8">Measure</h3><p class="calibre_6"> You can't make informed decisions without information. Most databases provide some way to log the time to execute SQL queries so you can identify the operations with the greatest cost. For example: </p><ul class="calibre_14"><li class="calibre_15"> Microsoft SQL Server and Oracle both have <span>SQL Trace</span> facilities and tools to report and analyze trace results. Microsoft calls this tool the <span>SQL&nbsp;Server Profiler</span>, and Oracle calls it <span>TKProf</span>. </li><li class="calibre_15"> MySQL and PostgreSQL can log queries that take longer to execute than a specified threshold of time. MySQL calls this the <span>slow query log</span>, and its <code class="calibre15">long_query_time</code> configuration parameter defaults to 10 seconds. PostgreSQL has a similar configuration variable <code class="calibre15">log_min_duration_statement</code>. <br class="calibre_16" /> PostgreSQL also has a companion tool called <span>pgFouine</span>, which helps you analyze the query log and identify queries that need attention (<a href="http://pgfouine.projects.postgresql.org/">http://pgfouine.projects.postgresql.org/</a>). </li></ul><p class="calibre_6"> Once you know which queries account for the most time in your application, you know where you should focus your optimizing attention for the greatest benefit. You might even find that all queries are working efficiently except for one single bottleneck query. This is the query you should start optimizing. </p><p class="calibre_6"> The area of greatest cost in your application isn't necessarily the most time-consuming query if that query is run only rarely. Other simpler queries might be run frequently, more often than you would expect, so they account for more total time. Giving attention to optimizing these queries gives you more bang for your buck. </p><p class="calibre_6"> Disable any query result caching while you're measuring query performance. This type of cache is designed to bypass query execution and index usage, so it won't give an accurate measurement. </p><p class="calibre_6"> You can get more accurate information by profiling your application after you deploy it. Collect aggregate data of where the code spends its time when real users are using it, and against the real database. You should monitor profiling data from time to time to be sure you haven't acquired a new bottleneck. </p><p class="calibre_6"> Remember to disable or turn down the reporting rate of profilers after you're done measuring, because these tools incur some overhead. </p><h3 class="calibre_8">Explain</h3><p class="calibre_6"> Having identified the query that has the greatest cost, your next step is to find out <em class="calibre6">why</em> it's so slow. Every database uses an optimizer to pick indexes for your query. You can get the database to give you a report of its analysis, called the <span>query execution plan</span> (QEP). </p><p class="calibre_6"> The syntax to request a QEP varies by database brand: </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Database Brand</p></td><td class="calibre19"><p class="calibre_6">QEP Reporting Solution</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">IBM DB2</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">EXPLAIN</code>, <code class="calibre15">db2expln</code> command, or Visual Explain</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Microsoft SQL Server</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">SET SHOWPLAN_XML</code>, or Display Execution Plan</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">MySQL</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">EXPLAIN</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Oracle</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">EXPLAIN PLAN</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">PostgreSQL</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">EXPLAIN</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">SQLite</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">EXPLAIN</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> There's no standard for what information a QEP report includes or the format of the report. In general, the QEP shows you which tables are involved in a query, how the optimizer chooses to use indexes, and what order it will access the tables. The report may also include statistics, such as the number of rows generated by each stage of the query. </p><p class="calibre_6"> Let's look at a sample SQL query and request a QEP report: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Index-Shotgun/soln/explain.sql">Index-Shotgun/soln/explain.sql</a></span></span></div><span class="calibre3"><code class="calibre15">EXPLAIN&nbsp;SELECT&nbsp;Bugs.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">JOIN&nbsp;(BugsProducts&nbsp;JOIN&nbsp;Products&nbsp;USING&nbsp;(product_id))</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;summary&nbsp;LIKE&nbsp;<em class="calibre6">'%crash%'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;AND&nbsp;product_name&nbsp;=&nbsp;<em class="calibre6">'Open&nbsp;RoundFile'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">ORDER&nbsp;BY&nbsp;date_reported&nbsp;DESC;</code></span><br class="calibre1" /></div><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Index_Shotgun/explain_qep.jpg" src="images/000006.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-34" class="calibre10">Figure 1. MySQL query execution plan</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> In the MySQL QEP report shown in Figure <a href="#calibre_link-34"><em class="calibre6">MySQL query execution plan</em></a>, the <code class="calibre15">key</code> column shows that this query makes use of only the primary key index <code class="calibre15">BugsProducts</code>. Also, the extra notes in the last column indicate that the query will sort the result in a temporary table, without the benefit of an index. </p><p class="calibre_6"> The <code class="calibre15">LIKE</code> expression forces a full table scan in <code class="calibre15">Bugs</code>, and there is no index on <code class="calibre15">Products.product_name</code>. We can improve this query if we create a new index on <code class="calibre15">product_name</code> and also use a full-text search solution.<a href="#calibre_link-35" id="calibre_link-37">[12]</a></p><p class="calibre_6"> The information in a QEP report is vendor-specific. In this example, you should read the MySQL manual page "Optimizing Queries with EXPLAIN" to understand how to interpret the report.<a href="#calibre_link-36" id="calibre_link-39">[13]</a></p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Covering Indexes</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> If an index provides all the columns we need, then we don't need to read rows of data from the table at all. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Imagine if telephone book entries contained only a page number; after you looked up a name, you would then have to turn to the page it referenced to get the actual phone number. It makes more sense to look up the information in one step. Looking up a name is quick because the book is ordered, and right there you can get other attributes you need for that entry, such as the phone number and perhaps also an address. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> This is how a <span>covering index</span> works. You can define the index to include extra columns, even though they're not otherwise necessary for the index. </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15">CREATE&nbsp;INDEX&nbsp;BugCovering&nbsp;ON&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;(status,&nbsp;bug_id,&nbsp;date_reported,&nbsp;reported_by,&nbsp;summary);</code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> If your query references only the columns included in the index data structure, the database generates your query results by reading only the index. </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15">SELECT&nbsp;status,&nbsp;bug_id,&nbsp;date_reported,&nbsp;summary</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;WHERE&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'OPEN'</em>;</code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The database doesn't need to read the corresponding rows from this table. You can't use covering indexes for every query, but when you can, it's usually a great win for performance. </blockquote></small></p></div><hr class="calibre7" /></div><h3 class="calibre_8">Nominate</h3><p class="calibre_6"> Now that you have the optimizer's QEP for your query, you should look for cases where the query accesses a table without using an index. </p><p class="calibre_6"> Some databases have tools to do this for you, collecting query trace statistics and proposing a number of changes, including creating new indexes that you're missing but would benefit your query. For example: </p><ul class="calibre_14"><li class="calibre_15"> IBM DB2 Design Advisor </li><li class="calibre_15"> Microsoft SQL&nbsp;Server Database Engine Tuning Advisor </li><li class="calibre_15"> MySQL Enterprise Query Analyzer </li><li class="calibre_15"> Oracle Automatic SQL Tuning Advisor </li></ul><p class="calibre_6"> Even without automatic advisors, you can learn how to recognize when an index could benefit a query. You need to study your database's documentation to interpret the QEP report. </p><h3 class="calibre_8">Test</h3><p class="calibre_6"> This step is important: after creating indexes, profile your queries again. It's important to confirm that your change made a difference so you know that your work is done. </p><p class="calibre_6"> You can also use this step to impress your boss and justify the work you put into this optimization. You don't want your weekly status to be like this: "I've tried everything I can think of to fix our performance issues, and we'll just have to wait and see…." Instead, you should have the opportunity to report this: "I determined we could create one new index on a high-activity table, and I improved the performance of our critical queries by 38 percent." </p><h3 class="calibre_8">Optimize</h3><p class="calibre_6"> Indexes are compact, frequently used data structures, which makes them good candidates for keeping in cache memory. Reading indexes in memory improves performance an order of magnitude greater than reading indexes via disk I/O. </p><p class="calibre_6"> Database servers allow you to configure the amount of system memory to allocate for caching. Most databases set the cache buffer size pretty low to ensure that the database works well on a wide variety of systems. You probably want to raise the size of the cache. </p><p class="calibre_6"> How much memory should you allocate to cache? There's no single answer to this, because it depends on the size of your database and how much system memory you have available. </p><p class="calibre_6"> You may also benefit from preloading indexes into cache memory, instead of relying on database activity to bring the most frequently used data or indexes into the cache. For instance, on MySQL, use the <code class="calibre15">LOAD INDEX INTO CACHE</code> statement. </p><h3 class="calibre_8">Rebuild</h3><p class="calibre_6"> Indexes provide the most efficiency when they are <span>balanced</span>. Over time, as you update and delete rows, the indexes may become progressively imbalanced, similar to how filesystems become fragmented over time. In practice, you may not see a large difference between an index that is optimal vs. one that has some imbalance. But we want to get the most out of indexes, so it's worthwhile to perform maintenance on a regular schedule. </p><p class="calibre_6"> Like most features related to indexes, each database brand uses vendor-specific terminology, syntax, and capabilities. </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Database Brand</p></td><td class="calibre19"><p class="calibre_6">Index Maintenance Command</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">IBM DB2</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">REBUILD INDEX</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Microsoft SQL Server</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">ALTER INDEX ... REORGANIZE</code>, <code class="calibre15">ALTER INDEX ... REBUILD</code>, or <code class="calibre15">DBCC DBREINDEX</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">MySQL</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">ANALYZE TABLE</code> or <code class="calibre15">OPTIMIZE TABLE</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Oracle</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">ALTER INDEX ... REBUILD</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">PostgreSQL</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">VACUUM</code> or <code class="calibre15">ANALYZE</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">SQLite</p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">VACUUM</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> How frequently should you rebuild an index? You might hear generic answers such as "once a week," but in truth there's no single answer that fits all applications. It depends on how frequently you commit changes to a given table that could introduce imbalance. It also depends on how large the table is and how important it is to get optimal benefit from indexes for this table. Is it worth spending hours rebuilding indexes for a large but seldom used table if you can expect to gain only an extra 1 percent performance? You're the best judge of this, because you know your data and your operation requirements better than anyone else does. </p><p class="calibre_6"> A lot of the knowledge about getting the most out of indexes is vendor-specific, so you'll need to research the brand of database you use. Your resources include the database manual, books and magazines, blogs and mailing lists, and also lots of experimentation on your own. The most important rule is that guessing blindly at indexing isn't a good strategy. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Know your data, know your queries, and MENTOR your indexes.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-37" id="calibre_link-35">[12]</a>
<small class="calibre3"> See the Chapter <a href="#calibre_link-38"><em class="calibre6">Poor Man's Search Engine</em></a>. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-39" id="calibre_link-36">[13]</a>
<small class="calibre3">
<a href="http://dev.mysql.com/doc/refman/5.1/en/using-explain.html">http://dev.mysql.com/doc/refman/5.1/en/using-explain.html</a>
</small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-490"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-239">
<pagebreak>
<a id="calibre_link-491">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 class="calibre12" id="calibre_link-219"><small class="calibre13">Part 3</small><br class="calibre14" />Query Antipatterns</h1><pagebreak><div class="calibre1" id="calibre_link-492"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-295">
<pagebreak>
<a id="calibre_link-493">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-220" class="calibre12"><small class="calibre13">Chapter 14</small><br class="calibre14" />Fear of the Unknown</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> As we know, there are known knowns; there are things we know we know. We also know there are known unknowns; that is to say we know there are some things we do not know. But there are also unknown unknowns---the ones we don't know we don't know. </em></p></div><div class="calibre1"><div class="calibre4"><span>Donald Rumsfeld</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> In our example bugs database, the <code class="calibre15">Accounts</code> table has columns <code class="calibre15">first_</code><code class="calibre15">name</code> and <code class="calibre15">last_name</code>. You can use an expression to format the user's full name as a single column using the string concatenation operator: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/intro/full-name.sql">Fear-Unknown/intro/full-name.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;first_name&nbsp;||&nbsp;<em class="calibre6">'&nbsp;'</em>&nbsp;||&nbsp;last_name&nbsp;AS&nbsp;full_name&nbsp;FROM&nbsp;Accounts;</code></span><br class="calibre1" /></div><p class="calibre_6"> Suppose your boss asks you to modify the database to add the user's middle initial to the table (perhaps two users have the same first name and last name, and the middle initial is a good way to avoid confusion). This is a pretty simple alteration. You also manually add the middle initials for a few users. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/intro/middle-name.sql">Fear-Unknown/intro/middle-name.sql</a></span></span></div><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Accounts&nbsp;ADD&nbsp;COLUMN&nbsp;middle_initial&nbsp;CHAR(2);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Accounts&nbsp;SET&nbsp;middle_initial&nbsp;=&nbsp;<em class="calibre6">'J.'</em>&nbsp;WHERE&nbsp;account_id&nbsp;=&nbsp;123;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Accounts&nbsp;SET&nbsp;middle_initial&nbsp;=&nbsp;<em class="calibre6">'C.'</em>&nbsp;WHERE&nbsp;account_id&nbsp;=&nbsp;321;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;first_name&nbsp;||&nbsp;<em class="calibre6">'&nbsp;'</em>&nbsp;||&nbsp;middle_initial&nbsp;||&nbsp;<em class="calibre6">'&nbsp;'</em>&nbsp;||&nbsp;last_name&nbsp;AS&nbsp;full_name</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Accounts;</code></span><br class="calibre1" /></div><p class="calibre_6"> Suddenly, the application ceases to show any names. Actually, on a second look, you notice it isn't universal. Only the names of users who have specified their middle initial appear normally; every else's name is now blank. </p><p class="calibre_6"> What happened to everyone else's names? Can you fix this before your boss notices and starts to panic, thinking you've lost data in the database? </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-22">
<pagebreak>
<a id="calibre_link-494">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-495">Objective: Distinguish Missing Values</h2><p class="calibre_6"> It's inevitable that some data in your database has no value. Either you need to insert a row before you have discovered the values for all the columns, or else some columns have no meaningful value in some legitimate circumstances. SQL supports a special null value, corresponding to the <code class="calibre15">NULL</code> keyword. </p><p class="calibre_6"> There are many ways you can use a null value productively in SQL tables and queries: </p><ul class="calibre_14"><li class="calibre_15"> You can use null in place of a value that is not available at the time the row is created, such as the date of termination for an employee who is still working. </li><li class="calibre_15"> A given column can use a null value when it has no applicable value on a given row, such as the fuel efficiency rating for a car that is fully electric. </li><li class="calibre_15"> A function can return a null value when given invalid inputs, as in <code class="calibre15">DAY('2009-12-32')</code>. </li><li class="calibre_15"> An outer join uses null values as placeholders for the columns of an unmatched table in an outer join. </li></ul><p class="calibre_6"> The objective is to write queries against columns that contain null. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-76">
<pagebreak>
<a id="calibre_link-496">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-497">Antipattern: Use Null as an Ordinary Value, or Vice Versa</h2><p class="calibre_6"> Many software developers are caught off-guard by the behavior of null in SQL. Unlike in most programming languages, SQL treats null as a special value, different from zero, false, or an empty string. This is true in standard SQL and most brands of database. However, in Oracle and Sybase, null is exactly the same as a string of zero length. The null value follows some special behavior, too. </p><h3 class="calibre_8">Using Null in Expressions</h3><p class="calibre_6"> One case that surprises some people is when you perform arithmetic on a column or expression that is null. For example, many programmers would expect the result to be <code class="calibre15">10</code> for bugs that have been given no estimate in the <code class="calibre15">hours</code> column, but instead the query returns null. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/anti/expression.sql">Fear-Unknown/anti/expression.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;hours&nbsp;+&nbsp;10&nbsp;FROM&nbsp;Bugs;</code></span><br class="calibre1" /></div><p class="calibre_6"> Null is not the same as zero. A number ten greater than an unknown is still an unknown. </p><p class="calibre_6"> Null is not the same as a string of zero length. Combining any string with null in standard SQL returns null (despite the behavior in Oracle and Sybase). </p><p class="calibre_6"> Null is not the same as false. Boolean expressions with <code class="calibre15">AND</code>, <code class="calibre15">OR</code>, and <code class="calibre15">NOT</code> also produce results that some people find confusing. </p><h3 class="calibre_8">Searching Nullable Columns</h3><p class="calibre_6"> The following query returns only rows where <code class="calibre15">assigned_to</code> has the value 123, not rows with other values or rows where the column is null: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/anti/search.sql">Fear-Unknown/anti/search.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;assigned_to&nbsp;=&nbsp;123;</code></span><br class="calibre1" /></div><p class="calibre_6"> You might think that the next query returns the complementary set of rows, that is, all rows <em class="calibre6">not</em> returned by the previous query: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/anti/search-not.sql">Fear-Unknown/anti/search-not.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;NOT&nbsp;(assigned_to&nbsp;=&nbsp;123);</code></span><br class="calibre1" /></div><p class="calibre_6"> However, neither query result includes rows where <code class="calibre15">assigned_to</code> is null. Any comparison to null returns <span>unknown</span>, not true or false. Even the negation of null is still null. </p><p class="calibre_6"> It's common to make the following mistakes searching for null values or non-null values: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/anti/equals-null.sql">Fear-Unknown/anti/equals-null.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;assigned_to&nbsp;=&nbsp;NULL;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;assigned_to&nbsp;&lt;&gt;&nbsp;NULL;</code></span><br class="calibre1" /></div><p class="calibre_6"> The condition in a <code class="calibre15">WHERE</code> clause is satisfied only when the expression is true, but a comparison to <code class="calibre15">NULL</code> is never true; it's unknown. It doesn't matter whether the comparison is for equality or inequality; it's still unknown, which is certainly not true. Neither of the previous queries return rows where <code class="calibre15">assigned_to</code> is null. </p><h3 class="calibre_8">Using Null in Query Parameters</h3><p class="calibre_6"> It's also difficult to use null in a parameterized SQL expression as if the null were an ordinary value. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/anti/parameter.sql">Fear-Unknown/anti/parameter.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;assigned_to&nbsp;=&nbsp;?;</code></span><br class="calibre1" /></div><p class="calibre_6"> The previous query returns predictable results when you send an ordinary integer value for the parameter, but you can't use a literal <code class="calibre15">NULL</code> as the parameter. </p><h3 class="calibre_8">Avoiding the Issue</h3><p class="calibre_6"> If handling null makes queries more complex, many software developers choose to disallow nulls in the database. Instead, they choose an ordinary value to signify "unknown" or "inapplicable." </p><blockquote class="calibre_9"><div class="calibre1">“We Hate Nulls!”</div><div class="calibre1"><p class="calibre_6"> Jack, a software developer, described his client's request that he prevent any null values in their database. Their explanation was simply "We hate nulls" and that the presence of nulls would lead to errors in their application code. Jack asked what other value should he use to represent a missing value. </p><p class="calibre_6"> I told Jack that representing a missing value is the exact purpose of null. No matter what other value he chooses to signify a missing value, he'd need to modify the application code to treat that value as special. </p><p class="calibre_6"> Jack's client's attitude to null is wrong; similarly, I could say that I don't like writing code to prevent division by zero errors, but that doesn't make it a good choice to prohibit all instances of the value zero. </p></div></blockquote><p class="calibre_6"> What exactly is wrong with this practice? In the following example, declare the previously nullable columns <code class="calibre15">assigned_to</code> and <code class="calibre15">hours</code> as <code class="calibre15">NOT&nbsp;NULL</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/anti/special-create-table.sql">Fear-Unknown/anti/special-create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;other&nbsp;columns</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;assigned_to&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;hours&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUMERIC(9,2)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(assigned_to)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Let's say you use -1 to represent an unknown value. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/anti/special-insert.sql">Fear-Unknown/anti/special-insert.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Bugs&nbsp;(assigned_to,&nbsp;hours)&nbsp;VALUES&nbsp;(-1,&nbsp;-1);</code></span><br class="calibre1" /></div><p class="calibre_6"> The hours column is numeric, so you're restricted to a numeric value to mean "unspecified." It has to have no meaning in that column, so you chose a negative value. But the value <code class="calibre15">-1</code> would throw off calculations such as <code class="calibre15">SUM</code> or <code class="calibre15">AVG</code>. You have to exclude rows with this value, using special-case expressions, which is what you were trying to avoid by prohibiting null. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/anti/special-select.sql">Fear-Unknown/anti/special-select.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;AVG(&nbsp;hours&nbsp;)&nbsp;AS&nbsp;average_hours_per_bug&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;hours&nbsp;&lt;&gt;&nbsp;-1;</code></span><br class="calibre1" /></div><p class="calibre_6"> In another column, the value <code class="calibre15">-1</code> might be significant, so you have to choose a different value on a case-by-case basis for each column. You also have to remember or document the special values used by each column. This adds a lot of meticulous and unnecessary work to a project. </p><p class="calibre_6"> Now let's look at the <code class="calibre15">assigned_to</code> column. It is a foreign key to the <code class="calibre15">Accounts</code> table. When a bug has been reported but not assigned yet, what non-null value can you use? Any non-null value must reference a row in <code class="calibre15">Accounts</code>, so you need to create a placeholder row in <code class="calibre15">Accounts</code>, meaning "no one" or "unassigned." It seems ironic to create an account to reference, so you can represent the absence of a reference to a real user's account. </p><p class="calibre_6"> When you declare a column as <code class="calibre15">NOT&nbsp;NULL</code>, it should be because it would make no sense for the row to exist without a value in that column. For example, the <code class="calibre15">Bugs.reported_by</code> column must have a value, because every bug was reported by someone. But a bug may exist without having been assigned yet. Missing values should be null. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-125">
<pagebreak>
<a id="calibre_link-498">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-499">How to Recognize the Antipattern</h2><p class="calibre_6"> If you find yourself or another member of your team describing issues like the following, it could be because of improper handling of nulls: </p><ul class="calibre_14"><li class="calibre_15"> "How do I find rows where no value has been set in the <code class="calibre15">assigned_to</code> (or other) column?" <br class="calibre_16" /> You can't use the equality operator for null. We'll see how to use the <code class="calibre15">IS&nbsp;NULL</code> predicate later in this chapter. </li><li class="calibre_15"> "The full names of some users appear blank in the application presentation, but I can see them in the database." <br class="calibre_16" /> The problem might be that you're concatenating strings with null, which produces null. </li><li class="calibre_15"> "The report of total hours spent working on this project includes only a few of the bugs that we completed! Only those for which we assigned a priority are included." <br class="calibre_16" /> Your aggregate query to sum the hours probably includes an expression in the <code class="calibre15">WHERE</code> clause that fails to be true when <code class="calibre15">priority</code> is null. Watch out for unexpected results when you use <em class="calibre6">not equals</em> expressions. For example, on rows where <code class="calibre15">priority</code> is null, the expression <code class="calibre15">priority &lt;&gt; 1</code> will fail. </li><li class="calibre_15"> "It turns out we can't use the string we've been using to represent <em class="calibre6">unknown</em> in the <code class="calibre15">Bugs</code> table, so we need to have a meeting to discuss what new special value we can use and estimate the development time to migrate our data and convert our code to use that value." <br class="calibre_16" /> This is a likely consequence of assigning a special flag value that could be a legitimate value in your column's domain. Eventually, you may find you need to use that value for its literal meaning instead of its flag meaning. </li></ul><p class="calibre_6"> Recognizing problems with your handling of nulls can be elusive. Problems may not occur during application testing, especially if you overlooked some edge cases while designing sample data for tests. However, when your application is used in production, data can take many unanticipated forms. If a null can creep into the data, you can count on it happening. </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Are Nulls Relational?</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> There is some controversy about null in SQL. E. F. Codd, the computer scientist who developed relational theory, recognized the need for null to signify missing data. However, C. J. Date has shown that the behavior of null as defined in the SQL standard has some edge cases that conflict with relational logic. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The fact is that most programming languages are not perfect implementations of computer science theories. The SQL language supports null, for better or for worse. We've seen some of the hazards, but you can learn how to account for these cases and use null productively. </blockquote></small></p></div><hr class="calibre7" /></div></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-195">
<pagebreak>
<a id="calibre_link-500">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-501">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> Using null is not the antipattern; the antipattern is using null like an ordinary value or using an ordinary value like null. </p><p class="calibre_6"> One situation where you need to treat null as an ordinary value is when you import or export external data. In a text file with comma-separated fields, all values must be represented by text. For example, in MySQL's <code class="calibre15">mysqlimport</code> tool for loading data from a text file, <code class="calibre15">\N</code> represents a null. </p><p class="calibre_6"> Similarly, user input cannot represent a null directly. An application that accepts user input may provide a way to map some special input sequence to null. For example, Microsoft&nbsp;.NET&nbsp;2.0 and newer supports a property called <code class="calibre15">ConvertEmptyStringToNull</code> for web user interfaces. Parameters and bound fields with this property automatically convert an empty string value ("") to null. </p><p class="calibre_6"> Finally, null won't work if you need to support several distinct missing-value cases. Let's say you want to distinguish between a bug that has never been assigned and a bug that was previously assigned to a person who has left the project---you have to use a distinct value for each state. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-284">
<pagebreak>
<a id="calibre_link-502">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-503">Solution: Use Null as a Unique Value</h2><p class="calibre_6"> Most problems with null values are based on a common misunderstanding of the behavior of SQL's three-valued logic. For programmers accustomed to the conventional true/false logic implemented in most other languages, this can be a challenge. You can handle null values in SQL queries with a little study of how they work. </p><h3 class="calibre_8">Null in Scalar Expressions</h3><p class="calibre_6"> Suppose Stan is thirty years old, while Oliver's age is unknown. If I ask you whether Stan is older than Oliver, your only possible answer is "I don't know." If I ask you whether Stan is the same age as Oliver, your answer is also "I don't know." If I ask you what is the sum of Stan's age and Oliver's age, your answer is the same. </p><p class="calibre_6"> Suppose Charlie's age is also unknown. If I ask you whether Oliver's age is equal to Charlie's age, your answer is still "I don't know." This shows why the result of a comparison like <code class="calibre15">NULL&nbsp;=&nbsp;NULL</code> is also null. </p><p class="calibre_6"> The following table describes some cases where programmers expect one result but get something different. </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Expression</p></td><td class="calibre19"><p class="calibre_6">Expected</p></td><td class="calibre19"><p class="calibre_6">Actual</p></td><td class="calibre19"><p class="calibre_6">Because</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL = 0</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">TRUE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6">Null is not zero.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL = 12345</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">FALSE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6">Unknown if the unspecified value is equal to a given value.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL &lt;&gt; 12345</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">TRUE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6">Also unknown if it's unequal.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL + 12345</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">12345</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6">Null is not zero.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL || 'string'</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">'string'</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6">Null is not an empty string.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL = NULL</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">TRUE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6">Unknown if one unspecified value is the same as another.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL &lt;&gt; NULL</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">FALSE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6">Also unknown if they're different.</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> Of course, these examples apply not only when using the <code class="calibre15">NULL</code> keyword but also to any column or expression whose value is null. </p><h3 class="calibre_8">Null in Boolean Expressions</h3><p class="calibre_6"> The key concept for understanding how null values behave in boolean expressions is that null is neither true nor false. </p><p class="calibre_6"> The following table describes some cases where programmers expect one result but get something different. </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Expression</p></td><td class="calibre19"><p class="calibre_6">Expected</p></td><td class="calibre19"><p class="calibre_6">Actual</p></td><td class="calibre19"><p class="calibre_6">Because</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL AND TRUE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">FALSE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6">Null is not false.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL AND FALSE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">FALSE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">FALSE</code></p></td><td class="calibre19"><p class="calibre_6">Any truth value <code class="calibre15">AND FALSE</code> is false.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL OR FALSE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">FALSE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6">Null is not false.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL OR TRUE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">TRUE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">TRUE</code></p></td><td class="calibre19"><p class="calibre_6">Any truth value <code class="calibre15">OR TRUE</code> is true.</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">NOT (NULL)</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">TRUE</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">NULL</code></p></td><td class="calibre19"><p class="calibre_6">Null is not false.</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> A null value certainly isn't true, but it isn't the same as false. If it were, then applying <code class="calibre15">NOT</code> to a null value would result in true. But that's not the way it works; <code class="calibre15">NOT (NULL)</code> results in another null. This confuses some people who try to use boolean expressions with null. </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">The Right Result for the Wrong Reason</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Consider the following case, where a nullable column may behave in a more intuitive way by serendipity. </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;assigned_to&nbsp;&lt;&gt;&nbsp;<em class="calibre6">'NULL'</em>;</code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Here the nullable column <code class="calibre15">assigned_to</code> is compared to the string value <code class="calibre15">'NULL'</code> (notice the quotes), instead of the actual <code class="calibre15">NULL</code> keyword. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Where <code class="calibre15">assigned_to</code> is null, comparing it to the string <code class="calibre15">'NULL'</code> is not true. The row is excluded from the query result, which is the programmer's intent. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The other case is that the column is an integer compared to the string <code class="calibre15">'NULL'</code>. The integer value of a string like <code class="calibre15">'NULL'</code> is zero in most brands of database. The integer value of <code class="calibre15">assigned_to</code> is almost certainly greater than zero. It's unequal to the string, so therefore the row is included in the query result. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Thus, by making another common mistake, that of putting quotes around the <code class="calibre15">NULL</code> keyword, some programmers may unwittingly get the result they wanted. Unfortunately, this coincidence doesn't hold in other searches, such as <code class="calibre15">WHERE assigned_to&nbsp;=&nbsp;'NULL'</code>. </blockquote></small></p></div><hr class="calibre7" /></div><h3 class="calibre_8">Searching for Null</h3><p class="calibre_6"> Since neither equality nor inequality return true when comparing one value to a null value, you need some other operation if you are searching for a null. Older SQL standards define the <code class="calibre15">IS&nbsp;NULL</code> predicate, which returns true if its single operand is null. The opposite, <code class="calibre15">IS&nbsp;NOT&nbsp;NULL</code>, returns false if its operand is null. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/soln/search.sql">Fear-Unknown/soln/search.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;assigned_to&nbsp;IS&nbsp;NULL;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;assigned_to&nbsp;IS&nbsp;NOT&nbsp;NULL;</code></span><br class="calibre1" /></div><p class="calibre_6"> In addition, the SQL-99 standard defines another comparison predicate, <code class="calibre15">IS&nbsp;DISTINCT&nbsp;FROM</code>. This works like an ordinary inequality operator <code class="calibre15">&lt;&gt;</code>, except that it always returns true or false, even when its operands are null. This relieves you from writing tedious expressions that must test <code class="calibre15">IS&nbsp;NULL</code> before comparing to a value. The following two queries are equivalent: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/soln/is-distinct-from.sql">Fear-Unknown/soln/is-distinct-from.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;assigned_to&nbsp;IS&nbsp;NULL&nbsp;OR&nbsp;assigned_to&nbsp;&lt;&gt;&nbsp;1;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;assigned_to&nbsp;IS&nbsp;DISTINCT&nbsp;FROM&nbsp;1;</code></span><br class="calibre1" /></div><p class="calibre_6"> You can use this predicate with query parameters to which you want to send either a literal value or <code class="calibre15">NULL</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/soln/is-distinct-from-parameter.sql">Fear-Unknown/soln/is-distinct-from-parameter.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;assigned_to&nbsp;IS&nbsp;DISTINCT&nbsp;FROM&nbsp;?;</code></span><br class="calibre1" /></div><p class="calibre_6"> Support for <code class="calibre15">IS DISTINCT FROM</code> is inconsistent among database brands. PostgreSQL, IBM DB2, and Firebird do support it, whereas Oracle and Microsoft SQL Server don't support it yet. MySQL offers a proprietary operator <code class="calibre15">&lt;=&gt;</code> that works like <code class="calibre15">IS NOT DISTINCT FROM</code>. </p><h3 class="calibre_8">Declare Columns NOT NULL</h3><p class="calibre_6"> It's recommended to declare a <code class="calibre15">NOT&nbsp;NULL</code> constraint on a column for which a null would break a policy in your application or otherwise be nonsensical. It's better to allow the database to enforce constraints uniformly rather than rely on application code. </p><p class="calibre_6"> For example, it's reasonable that any entry in the <code class="calibre15">Bugs</code> table should have a non-null value for the <code class="calibre15">date_reported</code>, <code class="calibre15">reported_by</code>, and <code class="calibre15">status</code> columns. Likewise, rows in child tables like <code class="calibre15">Comments</code> must include a non-null <code class="calibre15">bug_id</code>, referencing an existing bug. You should declare these columns with the <code class="calibre15">NOT&nbsp;NULL</code> option. </p><p class="calibre_6"> Some people recommend that you define a <code class="calibre15">DEFAULT</code> for every column, so that if you omit the column in an <code class="calibre15">INSERT</code> statement, the column gets some value instead of null. That's good advice for some columns but not for other columns. For example, <code class="calibre15">Bugs.reported_by</code> should not be null. What default, if any, should you declare for this column? It's valid and common for a column to need a <code class="calibre15">NOT&nbsp;NULL</code> constraint yet have no logical default value. </p><h3 class="calibre_8">Dynamic Defaults</h3><p class="calibre_6"> In some queries, you may need to force a column or expression to be non-null for the sake of simplifying the query logic, but you don't want that value to be stored. What you need is a way to set a default for a given column or expression ad hoc, in a specific query only. For this you should use the <code class="calibre15">COALESCE</code> function. This function accepts a variable number of arguments and returns its first non-null argument. </p><p class="calibre_6"> In the story about concatenating users' names shown in the story opening this chapter, you could use <code class="calibre15">COALESCE</code> to make an expression that uses a single space in place of the middle initial, so a null-valued middle initial doesn't make the whole expression become null. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Fear-Unknown/soln/coalesce.sql">Fear-Unknown/soln/coalesce.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;first_name&nbsp;||&nbsp;COALESCE(<em class="calibre6">'&nbsp;'</em>&nbsp;||&nbsp;middle_initial&nbsp;||&nbsp;<em class="calibre6">'&nbsp;'</em>,&nbsp;<em class="calibre6">'&nbsp;'</em>)&nbsp;||&nbsp;last_name</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;AS&nbsp;full_name</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Accounts;</code></span><br class="calibre1" /></div><p class="calibre_6"><code class="calibre15">COALESCE</code> is a standard SQL function. Some database brands support a similar function by another name, such as <code class="calibre15">NVL</code> or <code class="calibre15">ISNULL</code>. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Use null to signify a missing value for any data type.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-504"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-8">
<pagebreak>
<a id="calibre_link-505">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-221" class="calibre12"><small class="calibre13">Chapter 15</small><br class="calibre14" />Ambiguous Groups</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> Intellect distinguishes between the possible and the impossible; reason distinguishes between the sensible and the senseless. Even the possible can be senseless. </em></p></div><div class="calibre1"><div class="calibre4"><span>Max Born</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> Suppose your boss needs to know which projects in the bugs database are still active and which projects have been abandoned. One report he asks you to generate is the latest bug reported per product. You write a query using the MySQL database to calculate the greatest value in the <code class="calibre15">date_reported</code> column per group of bugs sharing a given <code class="calibre15">product_id</code>. The report looks like this: </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">product_name</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">latest</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">bug_id</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Open RoundFile</p></td><td class="calibre19"><p class="calibre_6">2010-06-01</p></td><td class="calibre19"><p class="calibre_6">1234</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Visual TurboBuilder</p></td><td class="calibre19"><p class="calibre_6">2010-02-16</p></td><td class="calibre19"><p class="calibre_6">3456</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">ReConsider</p></td><td class="calibre19"><p class="calibre_6">2010-01-01</p></td><td class="calibre19"><p class="calibre_6">5678</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> Your boss is a detail-oriented person, and he spends some time looking up each bug listed in the report. He notices that the row listed as the most recent for "Open RoundFile" shows a <code class="calibre15">bug_id</code> that isn't the latest bug. The full data shows the discrepancy: </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">product_name</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">date_reported</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">bug_id</code></p></td><td class="calibre19"><p class="calibre_6"></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Open RoundFile</p></td><td class="calibre19"><p class="calibre_6">2009-12-19</p></td><td class="calibre19"><p class="calibre_6"><em class="calibre6">1234</em></p></td><td class="calibre19"><p class="calibre_6"><em class="calibre6">This bug_id…</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Open RoundFile</p></td><td class="calibre19"><p class="calibre_6"><em class="calibre6">2010-06-01</em></p></td><td class="calibre19"><p class="calibre_6">2248</p></td><td class="calibre19"><p class="calibre_6"><em class="calibre6">doesn't match this date</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Visual TurboBuilder</p></td><td class="calibre19"><p class="calibre_6">2010-02-16</p></td><td class="calibre19"><p class="calibre_6">3456</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Visual TurboBuilder</p></td><td class="calibre19"><p class="calibre_6">2010-02-10</p></td><td class="calibre19"><p class="calibre_6">4077</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">Visual TurboBuilder</p></td><td class="calibre19"><p class="calibre_6">2010-02-16</p></td><td class="calibre19"><p class="calibre_6">5150</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">ReConsider</p></td><td class="calibre19"><p class="calibre_6">2010-01-01</p></td><td class="calibre19"><p class="calibre_6">5678</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">ReConsider</p></td><td class="calibre19"><p class="calibre_6">2009-11-09</p></td><td class="calibre19"><p class="calibre_6">8063</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> How can you explain this problem? Why does it affect one product but not the others? How can you get the desired report? </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-55">
<pagebreak>
<a id="calibre_link-506">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-507">Objective: Get Row with Greatest Value per Group</h2><p class="calibre_6"> Most programmers who learn SQL get to the stage of using <code class="calibre15">GROUP&nbsp;BY</code> in a query, applying some aggregate function to groups of rows, and getting a result with one row per group. This is a powerful feature that makes it easy to get a wide variety of complex reports using relatively little code. </p><p class="calibre_6"> For example, a query to get the latest bug reported for each product in the bugs database looks like this: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/anti/groupbyproduct.sql">Groups/anti/groupbyproduct.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;product_id,&nbsp;MAX(date_reported)&nbsp;AS&nbsp;latest</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;JOIN&nbsp;BugsProducts&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;product_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> A natural extension to this query is to request the ID of the specific bug with the latest date reported: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/anti/groupbyproduct.sql">Groups/anti/groupbyproduct.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;product_id,&nbsp;MAX(date_reported)&nbsp;AS&nbsp;latest,&nbsp;bug_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;JOIN&nbsp;BugsProducts&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;product_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> However, this query results in either an error or an unreliable answer. This is a common source of confusion for programmers using SQL. </p><p class="calibre_6"> The objective is to run a query that not only reports the greatest value in a group (or the least value or the average value) but also includes other attributes of the row where that value is found. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-103">
<pagebreak>
<a id="calibre_link-508">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-509">Antipattern: Reference Nongrouped Columns</h2><p class="calibre_6"> The root cause of this antipattern is simple, and it reveals a common misconception that many programmers have about how grouping queries work in SQL. </p><h3 class="calibre_8">The Single-Value Rule</h3><p class="calibre_6"> The rows in each group are those rows with the same value in the column or columns you name after <code class="calibre15">GROUP&nbsp;BY</code>. For example, in the following query, there is one row group for each distinct value in <code class="calibre15">product_id</code>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/anti/groupbyproduct.sql">Groups/anti/groupbyproduct.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;product_id,&nbsp;MAX(date_reported)&nbsp;AS&nbsp;latest</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;JOIN&nbsp;BugsProducts&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;product_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> Every column in the select-list of a query must have a single value row per row group. This is called the <span>Single-Value Rule</span>. Columns named in the <code class="calibre15">GROUP&nbsp;BY</code> clause are guaranteed to be exactly one value per group, no matter how many rows the group matches. </p><p class="calibre_6"> The <code class="calibre15">MAX</code> expression is also guaranteed to result in a single value for each group: the highest value found in the argument of <code class="calibre15">MAX</code> over all the rows in the group. </p><p class="calibre_6"> However, the database server can't be so sure about any other column named in the select-list. It can't always guarantee that the same value occurs on every row in a group for those other columns. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/anti/groupbyproduct.sql">Groups/anti/groupbyproduct.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;product_id,&nbsp;MAX(date_reported)&nbsp;AS&nbsp;latest,&nbsp;bug_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;JOIN&nbsp;BugsProducts&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;product_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> In this example, there are many distinct values for <code class="calibre15">bug_id</code> for a given <code class="calibre15">product_id</code>, because the <code class="calibre15">BugsProducts</code> table associates multiple bugs to a given product. In a grouping query that reduces to a single row per product, there's no way to represent all the values of <code class="calibre15">bug_id</code>. </p><p class="calibre_6"> Since there is no guarantee of a single value per group in the "extra" columns, the database assumes that they violate the Single-Value Rule. Most brands of database report an error if you try to run any query that tries to return a column other than those columns named in the <code class="calibre15">GROUP&nbsp;BY</code> clause or as arguments to aggregate functions. </p><p class="calibre_6"> MySQL and SQLite have different behavior from other brands of database, which we'll explore in the section <a href="#calibre_link-104"><em class="calibre6">Legitimate Uses of the Antipattern</em></a>. </p><h3 class="calibre_8">Do-What-I-Mean Queries</h3><p class="calibre_6"> The common misconception that programmers have is that SQL can guess which <code class="calibre15">bug_id</code> you want in the report, based on the fact that <code class="calibre15">MAX</code> is used in another column. Most people assume that if the query fetches the greatest value, then other columns named will naturally take their value from the same row where that greatest value occurs. </p><p class="calibre_6"> Unfortunately, SQL can't make this inference in several cases: </p><ul class="calibre_14"><li class="calibre_15"> If two bugs have the exact same value for <code class="calibre15">date_reported</code> and that is the greatest value in the group, which value of <code class="calibre15">bug_id</code> should the query report? </li><li class="calibre_15"> If you query for two different aggregate functions, for example <code class="calibre15">MAX</code> and <code class="calibre15">MIN</code>, these probably correspond to two different rows in the group. Which <code class="calibre15">bug_id</code> should the query return for this group? <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/anti/maxandmin.sql">Groups/anti/maxandmin.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;product_id,&nbsp;MAX(date_reported)&nbsp;AS&nbsp;latest,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;MIN(date_reported)&nbsp;AS&nbsp;earliest,&nbsp;bug_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;JOIN&nbsp;BugsProducts&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;product_id;</code></span><br class="calibre1" /></div></li><li class="calibre_15"> If none of the rows in the table matches the value returned by the aggregate function, what is the value of <code class="calibre15">bug_id</code>? This is commonly true for the functions <code class="calibre15">AVG</code>, <code class="calibre15">COUNT</code>, and <code class="calibre15">SUM</code>. <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/anti/sumbyproduct.sql">Groups/anti/sumbyproduct.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;product_id,&nbsp;SUM(hours)&nbsp;AS&nbsp;total_project_estimate,&nbsp;bug_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;JOIN&nbsp;BugsProducts&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;product_id;</code></span><br class="calibre1" /></div></li></ul><p class="calibre_6"> These are examples of why the Single-Value Rule is important. Not every query that fails to follow this rule would produce an ambiguous result, but many do. It would be clever if the database could tell an ambiguous query from an unambiguous one and produce an error only when the data contains ambiguity. But that would not be good for application reliability; it would mean that the same query might be valid or invalid, depending on the state of data. </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">GROUP BY and DISTINCT</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> SQL supports a query modifier called <code class="calibre15">DISTINCT</code> that reduces the rows of the query result so that every row is unique. For example, the following query reports who reported bugs and which days they reported bugs, but only one row per date and person: </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15">SELECT&nbsp;DISTINCT&nbsp;date_reported,&nbsp;reported_by&nbsp;FROM&nbsp;Bugs;</code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> A grouping query can achieve the same result by omitting any aggregate function. The query result is reduced to one row for each distinct pair of values in the column named in the <code class="calibre15">GROUP&nbsp;BY</code> clause: </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15">SELECT&nbsp;date_reported,&nbsp;reported_by&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;date_reported,&nbsp;reported_by;</code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Both queries produce the same result and should be optimized and executed similarly, so the difference in this example is only a matter of preference. </blockquote></small></p></div><hr class="calibre7" /></div></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-171">
<pagebreak>
<a id="calibre_link-510">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-511">How to Recognize the Antipattern</h2><p class="calibre_6"> In most brands of database, writing a query that violates the Single-Value Rule should elicit an error immediately as you prepare the query. The following are examples of error messages given by some brands of database: </p><ul class="calibre_14"><li class="calibre_15"> Firebird 2.1: <div class="calibre_11"><span class="calibre3"><code class="calibre15">Invalid&nbsp;expression&nbsp;in&nbsp;the&nbsp;<span class="calibre10">select</span>&nbsp;list&nbsp;(<span class="calibre10">not</span>&nbsp;contained&nbsp;in&nbsp;either&nbsp;an</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">aggregate&nbsp;function&nbsp;<span class="calibre10">or</span>&nbsp;the&nbsp;GROUP&nbsp;BY&nbsp;clause)</code></span><br class="calibre1" /></div></li><li class="calibre_15"> IBM DB2 9.5: <div class="calibre_11"><span class="calibre3"><code class="calibre15">An&nbsp;expression&nbsp;starting&nbsp;with&nbsp;<em class="calibre6">"BUG_ID"</em>&nbsp;specified&nbsp;in&nbsp;a&nbsp;SELECT&nbsp;clause,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">HAVING&nbsp;clause,&nbsp;<span class="calibre10">or</span>&nbsp;ORDER&nbsp;BY&nbsp;clause&nbsp;is&nbsp;<span class="calibre10">not</span>&nbsp;specified&nbsp;in&nbsp;the&nbsp;GROUP&nbsp;BY</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">clause&nbsp;<span class="calibre10">or</span>&nbsp;it&nbsp;is&nbsp;in&nbsp;a&nbsp;SELECT&nbsp;clause,&nbsp;HAVING&nbsp;clause,&nbsp;<span class="calibre10">or</span>&nbsp;ORDER&nbsp;BY&nbsp;clause</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">with&nbsp;a&nbsp;column&nbsp;function&nbsp;<span class="calibre10">and</span>&nbsp;no&nbsp;GROUP&nbsp;BY&nbsp;clause&nbsp;is&nbsp;specified.</code></span><br class="calibre1" /></div></li><li class="calibre_15"> Microsoft SQL Server 2008: <div class="calibre_11"><span class="calibre3"><code class="calibre15">Column&nbsp;<em class="calibre6">'Bugs.bug_id'</em>&nbsp;is&nbsp;invalid&nbsp;in&nbsp;the&nbsp;<span class="calibre10">select</span>&nbsp;list&nbsp;because&nbsp;it&nbsp;is&nbsp;<span class="calibre10">not</span></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">contained&nbsp;in&nbsp;either&nbsp;an&nbsp;aggregate&nbsp;function&nbsp;<span class="calibre10">or</span>&nbsp;the&nbsp;GROUP&nbsp;BY&nbsp;clause.</code></span><br class="calibre1" /></div></li><li class="calibre_15"> MySQL 5.1, after setting the <code class="calibre15">ONLY_FULL_GROUP</code> SQL mode to disallow ambiguous queries. <div class="calibre_11"><span class="calibre3"><code class="calibre15"><em class="calibre6">'bugs.b.bug_id'</em>&nbsp;isn't&nbsp;in&nbsp;GROUP&nbsp;BY</code></span><br class="calibre1" /></div></li><li class="calibre_15"> Oracle 10.2: <div class="calibre_11"><span class="calibre3"><code class="calibre15"><span class="calibre10">not</span>&nbsp;a&nbsp;GROUP&nbsp;BY&nbsp;expression</code></span><br class="calibre1" /></div></li><li class="calibre_15"> PostgreSQL 8.3: <div class="calibre_11"><span class="calibre3"><code class="calibre15">column&nbsp;<em class="calibre6">"bp.bug_id"</em>&nbsp;must&nbsp;appear&nbsp;in&nbsp;the&nbsp;GROUP&nbsp;BY&nbsp;clause&nbsp;<span class="calibre10">or</span>&nbsp;be</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">used&nbsp;in&nbsp;an&nbsp;aggregate&nbsp;function</code></span><br class="calibre1" /></div></li></ul><p class="calibre_6"> In SQLite and in MySQL, ambiguous columns may contain unexpected and unreliable values. In MySQL, the value returned is from the first row in the group, where <span>first</span> corresponds to physical storage. SQLite gives the opposite result: the value is from the <span>last</span> row in the group. In both cases, the behavior is not documented, and these databases aren't obligated to work the same in future versions. It's your responsibility to notice these cases and to design your queries to avoid ambiguity. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-253">
<pagebreak>
<a id="calibre_link-512">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 id="calibre_link-104" class="calibre_7">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> As we've seen, MySQL and SQLite can't guarantee a reliable result for a column that doesn't fit the Single-Value Rule. There are cases when you can take advantage of the fact that these databases enforce the rule less strictly than other brands. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/legit/functional.sql">Groups/legit/functional.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;b.reported_by,&nbsp;a.account_name</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;b&nbsp;JOIN&nbsp;Accounts&nbsp;a&nbsp;ON&nbsp;(b.reported_by&nbsp;=&nbsp;a.account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;b.reported_by;</code></span><br class="calibre1" /></div><p class="calibre_6"> In the previous query, the <code class="calibre15">account_name</code> column technically violates the Single-Value Rule, since it's named neither in the <code class="calibre15">GROUP&nbsp;BY</code> clause nor in an aggregate function. Nevertheless, there is only one value possible for <code class="calibre15">account_name</code> in each group; the groups are based on <code class="calibre15">Bugs.reported_by</code>, which is a foreign key to the <code class="calibre15">Accounts</code> table. Therefore, the groups correspond one-to-one with rows in the <code class="calibre15">Accounts</code> table. </p><p class="calibre_6"> In other words, if you know the value of <code class="calibre15">reported_by</code>, then you know the value of <code class="calibre15">account_name</code> unambiguously, like if you had queried by the primary key of the <code class="calibre15">Accounts</code> table. </p><p class="calibre_6"> This kind of unambiguous relationship is called a <span>functional dependency</span>. The most common example of this is between the primary key of a table and the table's attributes: <code class="calibre15">account_name</code> is a functional dependency of its primary key, <code class="calibre15">account_id</code>. If you group a query by a table's primary key column(s), then the groups correspond to a single row of that table, and therefore all other columns of the same table must have a single value per group. </p><p class="calibre_6"><code class="calibre15">Bugs.reported_by</code> has a similar relationship with the dependent attributes of the <code class="calibre15">Accounts</code> table, because it references the primary key of the <code class="calibre15">Accounts</code> table. When the query groups by the <code class="calibre15">reported_by</code> column, which is a foreign key, the attributes of the <code class="calibre15">Accounts</code> table are functionally dependent, and the query result contains no ambiguity. </p><p class="calibre_6"> However, most brands of database still return an error. Not only is this the behavior required by the SQL standard, but it's not too expensive to figure out functional dependencies on the fly.<a href="#calibre_link-254" id="calibre_link-315">[14]</a> But if you use MySQL or SQLite and you're careful to query only functionally dependent columns, you can use this kind of grouping query and still avoid problems of ambiguity. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-314">
<pagebreak>
<a id="calibre_link-513">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-514">Solution: Use Columns Unambiguously</h2><p class="calibre_6"> The sections that follow describe several ways you can resolve this antipattern and write unambiguous queries. </p><h3 class="calibre_8">Query Only Functionally Dependent Columns</h3><p class="calibre_6"> The most straightforward solution is to eliminate ambiguous columns from the query. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/anti/groupbyproduct.sql">Groups/anti/groupbyproduct.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;product_id,&nbsp;MAX(date_reported)&nbsp;AS&nbsp;latest</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;JOIN&nbsp;BugsProducts&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;product_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> The query reveals the date of the latest bug per product, even though it doesn't report the <code class="calibre15">bug_id</code> corresponding to that latest bug. Sometimes this is enough, so don't overlook a simple solution. </p><h3 class="calibre_8">Using a Correlated Subquery</h3><p class="calibre_6"> A correlated subquery contains a reference to the outer query and so produces different results for each row of the outer query. We can use this to find the latest bug per product by running a subquery to search for bugs with the same product and a greater date. When the subquery finds none, the bug in the outer query is the latest. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/soln/notexists.sql">Groups/soln/notexists.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;bp1.product_id,&nbsp;b1.date_reported&nbsp;AS&nbsp;latest,&nbsp;b1.bug_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;b1&nbsp;JOIN&nbsp;BugsProducts&nbsp;bp1&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;NOT&nbsp;EXISTS</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;(SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;b2&nbsp;JOIN&nbsp;BugsProducts&nbsp;bp2&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;WHERE&nbsp;bp1.product_id&nbsp;=&nbsp;bp2.product_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;b1.date_reported&nbsp;&lt;&nbsp;b2.date_reported);</code></span><br class="calibre1" /></div><p class="calibre_6"> Use this solution as a simple solution that is readable and easy to code. However, keep in mind that this solution isn't likely to be the best for performance, because correlated subqueries are executed once for each row of the outer query. </p><h3 class="calibre_8">Using a Derived Table</h3><p class="calibre_6"> You can use a subquery as a <span>derived table</span>, producing an interim result that contains only the <code class="calibre15">product_id</code> and the corresponding greatest bug report date for each product. Then use this result to join against the tables so that the query result contains only bugs with the latest date per product. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/soln/derived-table.sql">Groups/soln/derived-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;m.product_id,&nbsp;m.latest,&nbsp;b1.bug_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;b1&nbsp;JOIN&nbsp;BugsProducts&nbsp;bp1&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;JOIN&nbsp;(SELECT&nbsp;bp2.product_id,&nbsp;MAX(b2.date_reported)&nbsp;AS&nbsp;latest</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;FROM&nbsp;Bugs&nbsp;b2&nbsp;JOIN&nbsp;BugsProducts&nbsp;bp2&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;GROUP&nbsp;BY&nbsp;bp2.product_id)&nbsp;m</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ON&nbsp;(bp1.product_id&nbsp;=&nbsp;m.product_id&nbsp;AND&nbsp;b1.date_reported&nbsp;=&nbsp;m.latest);</code></span><br class="calibre1" /></div><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">product_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">latest</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">bug_id</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">2010-06-01</p></td><td class="calibre19"><p class="calibre_6">2248</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">2010-02-16</p></td><td class="calibre19"><p class="calibre_6">3456</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">2010-02-16</p></td><td class="calibre19"><p class="calibre_6">5150</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6">2010-01-01</p></td><td class="calibre19"><p class="calibre_6">5678</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> Notice that you can get multiple rows per product if the <code class="calibre15">latest</code> date returned by the subquery matches multiple rows. If you need to ensure a single row per <code class="calibre15">product_id</code>, you can use another grouping function in the outer query: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/soln/derived-table-no-duplicates.sql">Groups/soln/derived-table-no-duplicates.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;m.product_id,&nbsp;m.latest,&nbsp;MAX(b1.bug_id)&nbsp;AS&nbsp;latest_bug_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;b1&nbsp;JOIN</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;(SELECT&nbsp;product_id,&nbsp;MAX(date_reported)&nbsp;AS&nbsp;latest</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;FROM&nbsp;Bugs&nbsp;b2&nbsp;JOIN&nbsp;BugsProducts&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;GROUP&nbsp;BY&nbsp;product_id)&nbsp;m</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ON&nbsp;(b1.date_reported&nbsp;=&nbsp;m.latest)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;m.product_id,&nbsp;m.latest;</code></span><br class="calibre1" /></div><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">product_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">latest</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">latest_bug_id</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">2010-06-01</p></td><td class="calibre19"><p class="calibre_6">2248</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">2010-02-16</p></td><td class="calibre19"><p class="calibre_6">5150</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6">2010-01-01</p></td><td class="calibre19"><p class="calibre_6">5678</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> Use the derived table solution as a more scalable alternative to the correlated subquery. The derived table is noncorrelated, so most database brands should be able to execute the subquery once. However, the database must store the interim result set in a temporary table, so this still isn't the best for performance. </p><h3 class="calibre_8">Using a JOIN</h3><p class="calibre_6"> You can create a join that tries to match against a set of rows that may not exist. This type of join is called an <span>outer join</span>. Where the matching rows don't exist, null is used for all columns in that nonexistent row. So, where the query finds null, we know no such row was found. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/soln/outer-join.sql">Groups/soln/outer-join.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;bp1.product_id,&nbsp;b1.date_reported&nbsp;AS&nbsp;latest,&nbsp;b1.bug_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;b1&nbsp;JOIN&nbsp;BugsProducts&nbsp;bp1&nbsp;ON&nbsp;(b1.bug_id&nbsp;=&nbsp;bp1.bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;(Bugs&nbsp;AS&nbsp;b2&nbsp;JOIN&nbsp;BugsProducts&nbsp;AS&nbsp;bp2&nbsp;ON&nbsp;(b2.bug_id&nbsp;=&nbsp;bp2.bug_id))</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ON&nbsp;(bp1.product_id&nbsp;=&nbsp;bp2.product_id&nbsp;AND&nbsp;(b1.date_reported&nbsp;&lt;&nbsp;b2.date_reported</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;b1.date_reported&nbsp;=&nbsp;b2.date_reported&nbsp;AND&nbsp;b1.bug_id&nbsp;&lt;&nbsp;b2.bug_id))</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;b2.bug_id&nbsp;IS&nbsp;NULL;</code></span><br class="calibre1" /></div><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">product_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">latest</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">bug_id</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">2010-06-01</p></td><td class="calibre19"><p class="calibre_6">2248</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">2010-02-16</p></td><td class="calibre19"><p class="calibre_6">5150</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6">2010-01-01</p></td><td class="calibre19"><p class="calibre_6">5678</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> It takes a few minutes of gazing at this query, and perhaps some doodles on notepaper, for most people to see how it works. But once you do, this technique can be an important tool. </p><p class="calibre_6"> Use the <code class="calibre15">JOIN</code> solution when the scalability of the query over large sets of data is important. Although it's a tougher concept to grasp and therefore more difficult to maintain, it often scales better than a subquery-based solution. Remember to measure the performance of several query forms, instead of assuming that one performs better than the other. </p><h3 class="calibre_8">Using an Aggregate Function for Extra Columns</h3><p class="calibre_6"> You can make the extra column comply with the Single-Value Rule by applying another aggregate function to it. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/soln/extra-aggregate.sql">Groups/soln/extra-aggregate.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;product_id,&nbsp;MAX(date_reported)&nbsp;AS&nbsp;latest,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;MAX(bug_id)&nbsp;AS&nbsp;latest_bug_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;JOIN&nbsp;BugsProducts&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;product_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> Use this solution only when you can rely on the latest <code class="calibre15">bug_id</code> being the bug with the latest date, in other words, if bugs are guaranteed to be reported in chronological order. </p><h3 class="calibre_8">Concatenating All Values per Group</h3><p class="calibre_6"> Finally, you can use another aggregate function on <code class="calibre15">bug_id</code> to avoid violating the Single-Value Rule. MySQL and SQLite support a function <code class="calibre15">GROUP_CONCAT</code> that concatenates all the values in the group into one value. By default, this is a comma-separated string. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/soln/group-concat-mysql.sql">Groups/soln/group-concat-mysql.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;product_id,&nbsp;MAX(date_reported)&nbsp;AS&nbsp;latest</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;GROUP_CONCAT(bug_id)&nbsp;AS&nbsp;bug_id_list,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;JOIN&nbsp;BugsProducts&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;product_id;</code></span><br class="calibre1" /></div><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">product_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">latest</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">bug_id_list</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">2010-06-01</p></td><td class="calibre19"><p class="calibre_6">1234,2248</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">2010-02-16</p></td><td class="calibre19"><p class="calibre_6">3456,4077,5150</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6">2010-01-01</p></td><td class="calibre19"><p class="calibre_6">5678,8063</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> This query doesn't reveal which <code class="calibre15">bug_id</code> corresponds to the latest date; the <code class="calibre15">bug_id_list</code> includes all <code class="calibre15">bug_id</code> values in each group. </p><p class="calibre_6"> Another disadvantage of this solution is that it isn't standard SQL. and other brands of database don't support this function. Some brands of database support custom functions and custom aggregate functions. For example, here's the solution for PostgreSQL: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Groups/soln/group-concat-pgsql.sql">Groups/soln/group-concat-pgsql.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;AGGREGATE&nbsp;GROUP_ARRAY&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;BASETYPE&nbsp;=&nbsp;ANYELEMENT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SFUNC&nbsp;=&nbsp;ARRAY_APPEND,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STYPE&nbsp;=&nbsp;ANYARRAY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;INITCOND&nbsp;=&nbsp;<em class="calibre6">'{}'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;product_id,&nbsp;MAX(date_reported)&nbsp;AS&nbsp;latest</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ARRAY_TO_STRING(GROUP_ARRAY(bug_id),&nbsp;<em class="calibre6">','</em>)&nbsp;AS&nbsp;bug_id_list,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;JOIN&nbsp;BugsProducts&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;product_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> Some other brands of database don't support custom functions, so the solution may require writing a stored procedure to loop over an nongrouped query result, concatenating values manually. </p><p class="calibre_6"> Use this solution when you expect the extra column to have a single value per group but the column still violates the Single-Value Rule. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Follow the Single-Value Rule to avoid ambiguous query results.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-315" id="calibre_link-254">[14]</a>
<small class="calibre3"> The example queries in this chapter are simple. Figuring out functional dependencies for any arbitrary SQL query is harder. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-515"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-40">
<pagebreak>
<a id="calibre_link-516">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-222" class="calibre12"><small class="calibre13">Chapter 16</small><br class="calibre14" />Random Selection</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> The generation of random numbers is too important to be left to chance. </em></p></div><div class="calibre1"><div class="calibre4"><span>Robert R. Coveyou</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> You're writing a web application that displays advertisements. You're supposed to choose a random ad on each viewing so that all your advertisers have an even chance of showing their ads and so that readers don't get bored seeing the same ad repeatedly. </p><p class="calibre_6"> Things go well for the first few days, but the application gradually becomes more sluggish. A few weeks later, people are complaining that your website is too slow. You discover it's not just psychological; you can measure a real difference in the page load time. Your readership is starting to lose interest, and traffic is declining. </p><p class="calibre_6"> Learning from past experiences, you first try to find the performance bottleneck using profiling tools and a test version of your database with a sample of the data. You measure the time to load web page, but curiously, there are no problems with the performance in any of the SQL queries used to produce the page. Yet the production website is getting slower and slower. </p><p class="calibre_6"> Finally, you realize that the database on your production website is much greater than the sample in your tests. You repeat your tests with a database of similar size to the production data and find that it's the ad-selection query. With a greater number of ads to choose from, the performance of that query drops sharply. You've discovered the query that fails to scale, and that's an important first step. </p><p class="calibre_6"> How can you redesign the query that chooses random ads before your website loses its audience and therefore your sponsors? </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-89">
<pagebreak>
<a id="calibre_link-517">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-518">Objective: Fetch a Sample Row</h2><p class="calibre_6"> It's surprising how frequently we need an SQL query that returns a random result. This seems to go against the principles of repeatability and deterministic programming. However, it's ordinary to ask for a sample from a large data set. The following are some examples: </p><ul class="calibre_14"><li class="calibre_15"> Displaying rotating content, such as an advertisement or a news story to highlight </li><li class="calibre_15"> Auditing a subset of records </li><li class="calibre_15"> Assigning incoming calls to available operators </li><li class="calibre_15"> Generating test data </li></ul><p class="calibre_6"> It's better to query the database for this sample, as an alternative to fetching the entire data set into your application just so you can pick a sample from the set. </p><p class="calibre_6"> The objective is to write an efficient SQL query that returns only a random sample of data.<a href="#calibre_link-90" id="calibre_link-24">[15]</a></p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-156">
<pagebreak>
<a id="calibre_link-519">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-520">Antipattern: Sort Data Randomly</h2><p class="calibre_6"> The most common SQL trick to pick a random row from a query is to sort the query randomly and pick the first row. This technique is easy to understand and easy to implement: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Random/anti/orderby-rand.sql">Random/anti/orderby-rand.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;ORDER&nbsp;BY&nbsp;RAND()&nbsp;LIMIT&nbsp;1;</code></span><br class="calibre1" /></div><p class="calibre_6"> Although this is a popular solution, it quickly shows its weakness. To understand this weakness, let's first compare it to conventional sorting, in which we compare values in a column and order the rows according to which row has a greater or lesser value in that column. This kind of sort is repeatable, in that it produces the same results when you run it more than once. It also benefits from an index, because an index is essentially a presorted set of the values from a given column. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Random/anti/indexed-sort.sql">Random/anti/indexed-sort.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;ORDER&nbsp;BY&nbsp;date_reported;</code></span><br class="calibre1" /></div><p class="calibre_6"> If your sorting criteria is a function that returns a random value per row, this makes it random whether a given row is greater or less than another row. So, the order has no relation to the values in each row. The order is also different each time you sort in this way. So far so good---this is the result we want. </p><p class="calibre_6"> Sorting by a nondeterministic expression (<code class="calibre15">RAND</code>) means the sorting cannot benefit from an index. There is no index containing the values returned by the random function. That's the point of them being random: they are different and unpredictable each time they're selected. </p><p class="calibre_6"> This is a problem for the performance of the query, because using an index is one of the best ways of speeding up sorting. The consequence of not using an index is that the query result set has to be sorted by the database "manually." This is called a <span>table scan</span>, and it often involves saving the entire result as a temporary table and sorting it by physically swapping rows. A table scan sort is much slower than an index-assisted sort, and the performance difference grows with the size of the data set. </p><p class="calibre_6"> Another weakness of the sort-by-random technique is that after the expensive process of sorting the entire data set, most of that work is wasted because all but the first row is immediately discarded. In a table with a thousand rows, why go to the trouble of randomizing all thousand when all we need is one row? </p><p class="calibre_6"> Both of these problems are unnoticeable when you run the query over a small number of rows, so during development and testing it may appear to be a good solution. But as the volume in your database increases over time, the query fails to scale well. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-240">
<pagebreak>
<a id="calibre_link-521">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-522">How to Recognize the Antipattern</h2><p class="calibre_6"> The technique shown in the antipattern is straightforward, and many programmers use it, either after reading it in an article or coming up with it on their own. Some of the following quotes are clues that your colleague is practicing the antipattern: </p><ul class="calibre_14"><li class="calibre_15"> "In SQL, returning a random row is really slow." <br class="calibre_16" /> The query to select a random sample worked well against trivial data during development and testing, but it gets progressively slower as the real data grows. No amount of database server tuning, indexing, or caching can improve the scalability. </li><li class="calibre_15"> "How can I increase memory for my application? I need to fetch all the rows so I can randomly pick one." <br class="calibre_16" /> You shouldn't have to load all the rows into the application, and it's wildly wasteful to do this. Besides, the database tends to grow larger than your application memory can handle. </li><li class="calibre_15"> "Does it seem to you like some entries come up more frequently than they should? This randomizer doesn't seem very random." <br class="calibre_16" /> Your random numbers are not synchronized with the gaps in primary key values in the database (see the section <a href="#calibre_link-241"><em class="calibre6">Choose Next Higher Key Value</em></a>). </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-296">
<pagebreak>
<a id="calibre_link-523">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-524">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> The inefficiency of the sort-by-random solution is tolerable if your data set is bound to be small. </p><p class="calibre_6"> For example, you could use a random method for assigning a programmer to fix a given bug. It's safe to assume that you'll never have so many programmers that you need to use a highly scalable method for choosing a random person. </p><p class="calibre_6"> Another example could be selecting a random U.S. state from a list of the 50 states, which is a list of modest size and not likely to grow during our lifetimes. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-23">
<pagebreak>
<a id="calibre_link-525">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-526">Solution: In No Particular Order…</h2><p class="calibre_6"> The sort-by-random technique is an example of a query that's bound to perform a table scan and an expensive manual sort. When you design solutions in SQL, you should be on the lookout for inefficient queries like this. Instead of searching fruitlessly for a way to optimize an unoptimizable query, rethink your approach. You can use the alternative techniques shown in the following sections to query a random row from a query result set. In different circumstances, each of these solutions can produce the same result with greater efficiency. </p><h3 class="calibre_8">Choose a Random Key Value Between 1 and MAX</h3><p class="calibre_6"> One technique that avoids sorting the table is to choose a random value between <code class="calibre15">1</code> and the greatest primary key value. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Random/soln/rand-1-to-max.sql">Random/soln/rand-1-to-max.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;b1.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;AS&nbsp;b1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">JOIN&nbsp;(SELECT&nbsp;CEIL(RAND()&nbsp;*&nbsp;(SELECT&nbsp;MAX(bug_id)&nbsp;FROM&nbsp;Bugs))&nbsp;AS&nbsp;rand_id)&nbsp;AS&nbsp;b2</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ON&nbsp;(b1.bug_id&nbsp;=&nbsp;b2.rand_id);</code></span><br class="calibre1" /></div><p class="calibre_6"> This solution assumes that primary key values start at <code class="calibre15">1</code> and that primary key values are contiguous. That is, there are no values unused between <code class="calibre15">1</code> and the greatest value. If there are gaps, a randomly chosen value may not match a row in the table. </p><p class="calibre_6"> Use this solution when you know your key uses all values between <code class="calibre15">1</code> and the greatest key value. </p><h3 id="calibre_link-241" class="calibre_8">Choose Next Higher Key Value</h3><p class="calibre_6"> This is similar to the preceding solution, but if you have gaps of unused values between <code class="calibre15">1</code> and the greatest key value, this query matches a random value to the first key value it finds. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Random/soln/next-higher.sql">Random/soln/next-higher.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;b1.*</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;AS&nbsp;b1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">JOIN&nbsp;(SELECT&nbsp;CEIL(RAND()&nbsp;*&nbsp;(SELECT&nbsp;MAX(bug_id)&nbsp;FROM&nbsp;Bugs))&nbsp;AS&nbsp;bug_id)&nbsp;AS&nbsp;b2</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;b1.bug_id&nbsp;&gt;=&nbsp;b2.bug_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">ORDER&nbsp;BY&nbsp;b1.bug_id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">LIMIT&nbsp;1;</code></span><br class="calibre1" /></div><p class="calibre_6"> This solves the problem of a random number that misses any key value, but it means that a key value that follows a gap is chosen more often. Random values should be approximately even in distribution, but <code class="calibre15">bug_id</code> values aren't. </p><p class="calibre_6"> Use this solution when gaps are uncommon and when it's not important for all key values to be chosen with equal frequency. </p><h3 class="calibre_8">Get a List of All Key Values, Choose One at Random</h3><p class="calibre_6"> You can use application code to pick one value from the primary keys in the result set. Then query the full row from the database using that primary key. This technique is shown in the following PHP code: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Random/soln/rand-key-from-list.php">Random/soln/rand-key-from-list.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$bug_id_list&nbsp;=&nbsp;$pdo-&gt;query("SELECT&nbsp;bug_id&nbsp;FROM&nbsp;Bugs")-&gt;fetchAll();</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$rand&nbsp;=&nbsp;random(&nbsp;count($bug_id_list)&nbsp;);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$rand_bug_id&nbsp;=&nbsp;$bug_id_list[$rand]["bug_id"];</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare("SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;?");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt-&gt;execute(&nbsp;<span class="calibre10">array</span>($rand_bug_id)&nbsp;);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$rand_bug&nbsp;=&nbsp;$stmt-&gt;fetch();</code></span><br class="calibre1" /></div><p class="calibre_6"> This avoids sorting the table, and the chance of choosing each key value is approximately equal, but this solution has other costs: </p><ul class="calibre_14"><li class="calibre_15"> Fetching all the <code class="calibre15">bug_id</code> values from the database might return a list of impractical size. It can even exceed application memory resources and cause an error such as the following: <div class="calibre_11"><span class="calibre3"><code class="calibre15">Fatal&nbsp;error:&nbsp;&nbsp;Allowed&nbsp;memory&nbsp;size&nbsp;of&nbsp;16777216&nbsp;bytes&nbsp;exhausted</code></span><br class="calibre1" /></div></li><li class="calibre_15"> The query must be run twice: once to produce the list of primary keys and a second time to fetch the random row. If the query is too complex and costly, this is a problem. </li></ul><p class="calibre_6"> Use this solution when you're selecting a random row from a simple query with a moderately sized result set. This solution is good for choosing from a list of noncontiguous values. </p><h3 class="calibre_8">Choose a Random Row Using an Offset</h3><p class="calibre_6"> Still another technique that avoids problems found in the preceding alternatives is to count the rows in the data set and return a random number between <code class="calibre15">0</code> and the count. Then use this number as an offset when querying the data set. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Random/soln/limit-offset.php">Random/soln/limit-offset.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$rand&nbsp;=&nbsp;"SELECT&nbsp;ROUND(RAND()&nbsp;*&nbsp;(SELECT&nbsp;COUNT(*)&nbsp;FROM&nbsp;Bugs))";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$offset&nbsp;=&nbsp;$pdo-&gt;query($rand)-&gt;fetch(PDO::FETCH_ASSOC);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;LIMIT&nbsp;1&nbsp;OFFSET&nbsp;:offset";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare($sql);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt-&gt;execute(&nbsp;$offset&nbsp;);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$rand_bug&nbsp;=&nbsp;$stmt-&gt;fetch();</code></span><br class="calibre1" /></div><p class="calibre_6"> This solution relies on the nonstandard <code class="calibre15">LIMIT</code> clause, supported by MySQL, PostgreSQL, and SQLite. </p><p class="calibre_6"> An alternative that uses the <code class="calibre15">ROW_NUMBER</code> window function works in Oracle, Microsoft SQL&nbsp;Server, and IBM&nbsp;DB2.</p><p class="calibre_6"> For example, here's the solution in Oracle: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Random/soln/row_number.php">Random/soln/row_number.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$rand&nbsp;=&nbsp;"SELECT&nbsp;1&nbsp;+&nbsp;MOD(ABS(dbms_random.random()),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;(SELECT&nbsp;COUNT(*)&nbsp;FROM&nbsp;Bugs))&nbsp;AS&nbsp;offset&nbsp;FROM&nbsp;dual";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$offset&nbsp;=&nbsp;$pdo-&gt;query($rand)-&gt;fetch(PDO::FETCH_ASSOC);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"WITH&nbsp;NumberedBugs&nbsp;AS&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;b.*,&nbsp;ROW_NUMBER()&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;bug_id)&nbsp;AS&nbsp;RN&nbsp;FROM&nbsp;Bugs&nbsp;b</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">)&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;NumberedBugs&nbsp;WHERE&nbsp;RN&nbsp;=&nbsp;:offset";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare($sql);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt-&gt;execute(&nbsp;$offset&nbsp;);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$rand_bug&nbsp;=&nbsp;$stmt-&gt;fetch();</code></span><br class="calibre1" /></div><p class="calibre_6"> Use this solution when you can't assume contiguous key values and you need to make sure each row has an even chance of being selected. </p><h3 class="calibre_8">Proprietary Solutions</h3><p class="calibre_6"> Any given brand of database might implement its own solution for this kind of task. For example, Microsoft SQL Server 2005 added a <code class="calibre15">TABLESAMPLE</code> clause: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Random/soln/tablesample-sql2005.sql">Random/soln/tablesample-sql2005.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;TABLESAMPLE&nbsp;(1&nbsp;ROWS);</code></span><br class="calibre1" /></div><p class="calibre_6"> Oracle uses a slightly different <code class="calibre15">SAMPLE</code> clause, for example to return 1 percent of the rows in the table: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Random/soln/sample-oracle.sql">Random/soln/sample-oracle.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;(SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;SAMPLE&nbsp;(1)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">ORDER&nbsp;BY&nbsp;dbms_random.value)&nbsp;WHERE&nbsp;ROWNUM&nbsp;=&nbsp;1;</code></span><br class="calibre1" /></div><p class="calibre_6"> You should read the documentation for the proprietary solution in your brand of database. There are often limitations or other options you need to know about. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Some queries cannot be optimized; take a different approach.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-24" id="calibre_link-90">[15]</a>
<small class="calibre3"> Mathematicians and computer scientists make a distinction between truly random and <span>pseudorandom</span>. In practice, computers can produce only pseudorandom values. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-527"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-77">
<pagebreak>
<a id="calibre_link-528">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-38" class="calibre12"><small class="calibre13">Chapter 17</small><br class="calibre14" />Poor Man's Search Engine</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> Some people, when confronted with a problem, think "I&nbsp;know, I'll use regular expressions." Now they have two problems. </em></p></div><div class="calibre1"><div class="calibre4"><span>Jamie Zawinski</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> I was working in a technical support job in 1995, at a time when companies were just starting to adopt the Web as a way to provide information to their customers. We had a collection of short documents describing solutions to common support questions, and we wanted to put them on the Web in a knowledge-base application. </p><p class="calibre_6"> We quickly realized that as the collection grew, it needed to be searchable, because customers didn't want to browse through hundreds of articles to find their answers. One strategy would be to organize the articles in categories, but even these groups were too large, and many articles belonged in multiple groups. </p><p class="calibre_6"> We wanted our customers to search the articles, narrowing down the list to those matching any criteria. The most flexible and straightforward interface was to allow the customer to enter any set of words and show them the articles in which those words appear. An article was weighted higher if it matched the search terms more fully. Also, we wanted to match word forms. For example, a search for the word <code class="calibre15">crash</code> should also match <code class="calibre15">crashed</code>, <code class="calibre15">crashes</code>, and <code class="calibre15">crashing</code>. Of course, the search had to work in a growing collection of documents quickly enough to be useful in a web application. </p><p class="calibre_6"> If that careful description sounds superfluous to you, that shouldn't be surprising. Searching through text online has become so common that we can hardly recall the time before it was available. But using SQL to search by keywords, while also making the solution both fast and accurate, is deceptively difficult. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-126">
<pagebreak>
<a id="calibre_link-529">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-530">Objective: Full-Text Search</h2><p class="calibre_6"> Any application that stores text needs to search for words or phrases within that text. We use databases to store more textual data than ever, and at the same time we demand to be able to search for matching text at greater speeds. Web applications especially need high-performance and scalable database techniques for searching text. </p><p class="calibre_6"> One fundamental principle of SQL (and relational theory from which SQL is derived) is that a value in a column is <span>atomic</span>. That is, you can compare a value to another value, but you always compare the <em class="calibre6">whole</em> value when you do that. Comparing substrings is bound to be inefficient or inaccurate in SQL. </p><p class="calibre_6"> In spite of this, we need a way to compare a short string to a longer string and find a match when the short string occurs anywhere within the longer string. How can we bridge this gulf using SQL? </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-196">
<pagebreak>
<a id="calibre_link-531">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-532">Antipattern: Pattern Matching Predicates</h2><p class="calibre_6"> SQL provides pattern-matching predicates for comparing strings, and this is the first solution most programmers use when searching for key words. The most widely supported of these is the <code class="calibre15">LIKE</code> predicate. </p><p class="calibre_6"> The <code class="calibre15">LIKE</code> predicate supports a wildcard (<code class="calibre15">%</code>) that matches zero or more characters. Using this wildcard before and after a key word matches any string that contains that word. The first wildcard matches any text preceding the word, and the second wildcard matches any text following the word. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/anti/like.sql">Search/anti/like.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;description&nbsp;LIKE&nbsp;<em class="calibre6">'%crash%'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> Regular expressions are also supported by many database brands, although not in a standard way. You don't need wildcards, because conventionally regular expressions match the pattern against any substring anyway. Here's an example using MySQL's regular expression predicate:<a href="#calibre_link-197" id="calibre_link-58">[16]</a></p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/anti/regexp.sql">Search/anti/regexp.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;description&nbsp;REGEXP&nbsp;<em class="calibre6">'crash'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> The most important disadvantage of pattern-matching operators is that they have poor performance. They can't benefit from a conventional index, so they must scan every row in a table. Since matching a pattern against a string column is a fairly expensive operation (relative to, for instance, comparing two integers for equality), the total cost of a table scan for this search is very high. </p><p class="calibre_6"> A second problem of simple pattern-matching using <code class="calibre15">LIKE</code> or regular expressions is that it can find unintended matches. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/anti/like-false-match.sql">Search/anti/like-false-match.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;description&nbsp;LIKE&nbsp;<em class="calibre6">'%one%'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> The previous example matches text that contains the words <code class="calibre15">one</code>, but it also matches strings <code class="calibre15">money</code>, <code class="calibre15">prone</code>, <code class="calibre15">lonely</code>, and so on. Searching for a pattern with the key word delimited by spaces doesn't match occurrences of the word with punctuation or at the start or end of the text. The regular expressions supported by your database might support a special pattern for a <span>word boundary</span>, to solve this issue:<a href="#calibre_link-198" id="calibre_link-59">[17]</a></p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/anti/regexp-word.sql">Search/anti/regexp-word.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;description&nbsp;REGEXP&nbsp;<em class="calibre6">'[[:&lt;:]]one[[:&gt;:]]'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> Given the problems of performance and scalability and the gymnastics you have to do to prevent irrelevant matches, simple pattern matching is a poor technique for searching for key words. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-285">
<pagebreak>
<a id="calibre_link-533">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-534">How to Recognize the Antipattern</h2><p class="calibre_6"> Some questions like the following commonly indicate that the Poor Man's Search Engine antipattern is being employed: </p><ul class="calibre_14"><li class="calibre_15"> "How do I insert a variable in between two wildcards in a <code class="calibre15">LIKE</code> expression?" <br class="calibre_16" /> The question usually comes up when the programmer wants to do a pattern-matching search using input from a user. </li><li class="calibre_15"> "How can I write a regular expression to check that a string contains multiple words, that the string <em class="calibre6">doesn't</em> contain a certain word, or that the string contains any form of a given word?" <br class="calibre_16" /> If a complex problem seems too hard to solve with a regular expression, it probably is. </li><li class="calibre_15"> "The search feature of our website has become unusably slow as we've added more documents to the database. What's wrong?" <br class="calibre_16" /> As the volume of data goes up, the antipattern solution shows poor scalability. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-9">
<pagebreak>
<a id="calibre_link-535">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-536">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> The expressions shown in the antipattern section are legal SQL queries, and they have a straightforward and simple usage. That counts for a lot. </p><p class="calibre_6"> Performance is often important, but some queries are run so infrequently that it doesn't make sense to invest a lot of resources to optimize them. Maintaining indexes to benefit a rarely used query could be just as costly as running that query in an inefficient manner. If the nature of the query is ad hoc, there's no guarantee that the index you defined would benefit that given query anyway. </p><p class="calibre_6"> It's hard to use pattern-matching operators for complex queries, but if you design the patterns for simple cases, they can help you get the right results with a minimum of fuss. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-56">
<pagebreak>
<a id="calibre_link-537">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-538">Solution: Use the Right Tool for the Job</h2><p class="calibre_6"> It's best to use a specialized search engine technology, instead of SQL. Another alternative is to reduce the recurring cost of search by saving the result. </p><p class="calibre_6"> The following sections describe some of the technologies offered as built-in extensions by different database brands and also technologies offered by independent projects. Also, we'll develop a solution that uses standard SQL but is more efficient on average than substring matching. </p><h3 class="calibre_8">Vendor Extensions</h3><p class="calibre_6"> Every major brand of database has invented their own answer to the common requirement of full-text search, but these features are not standard or compatible between database brands. If you use a single brand (or are willing to use vendor-dependent features), these features are the best way to get high-performance text search, with the greatest integration with SQL queries. </p><p class="calibre_6"> The following are brief descriptions of full-text search features in several brands of SQL database. The details are subject to change, so be sure to read the current documentation for your brand. </p><h4 class="calibre_18">Full-Text Index in MySQL</h4><p class="calibre_6"> MySQL provides a simple full-text index type for the MyISAM storage engine only. You can define a full-text index over columns of type <code class="calibre15">CHAR</code>, <code class="calibre15">VARCHAR</code>, or <code class="calibre15">TEXT</code>. Here's an example that defines a full-text index that includes content from the bug <code class="calibre15">summary</code> and <code class="calibre15">description</code> columns: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/mysql/alter-table.sql">Search/soln/mysql/alter-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Bugs&nbsp;ADD&nbsp;FULLTEXT&nbsp;INDEX&nbsp;bugfts&nbsp;(summary,&nbsp;description);</code></span><br class="calibre1" /></div><p class="calibre_6"> Use the <code class="calibre15">MATCH</code> function to search for a key word among the indexed text. You must name the columns in the full-text index (so you can match using another index that covers different columns in the same table). </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/mysql/match.sql">Search/soln/mysql/match.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;MATCH(summary,&nbsp;description)&nbsp;AGAINST&nbsp;(<em class="calibre6">'crash'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> Since MySQL 4.1, you can also use a simple boolean expression notation in the pattern to filter results more carefully. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/mysql/match-boolean.sql">Search/soln/mysql/match-boolean.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;MATCH(summary,&nbsp;description)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;AGAINST&nbsp;(<em class="calibre6">'+crash&nbsp;-save'</em>&nbsp;IN&nbsp;BOOLEAN&nbsp;MODE);</code></span><br class="calibre1" /></div><h4 class="calibre_18">Text Indexing in Oracle</h4><p class="calibre_6"> Oracle has supported text-indexing features since Oracle 8 in 1997, when it was part of a data cartridge called ConText. The technology has been updated several times, and the feature is now integrated into the database software. The text indexing in Oracle is complex and rich, so here is a greatly simplified summary: </p><ul class="calibre_14"><li class="calibre_15"><code class="calibre15">CONTEXT</code><br class="calibre_16" /> Create an index of this type for a single text column. Use the <code class="calibre15">CONTAINS</code> operator to search using this index. The index doesn't stay consistent with changes to data, so you have to rebuild the index manually or on a schedule. <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/oracle/create-index.sql">Search/soln/oracle/create-index.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;INDEX&nbsp;BugsText&nbsp;ON&nbsp;Bugs(summary)&nbsp;INDEXTYPE&nbsp;IS&nbsp;CTSSYS.CONTEXT;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;CONTAINS(summary,&nbsp;<em class="calibre6">'crash'</em>)&nbsp;&gt;&nbsp;0;</code></span><br class="calibre1" /></div></li><li class="calibre_15"><code class="calibre15">CTXCAT</code><br class="calibre_16" /> This index type is specialized for short text samples such as those used in online catalogs, along with other structured columns from the same table. The index stays consistent as transactions update the indexed data. <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/oracle/ctxcat-create.sql">Search/soln/oracle/ctxcat-create.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CTX_DDL.CREATE_INDEX_SET(<em class="calibre6">'BugsCatalogSet'</em>);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">CTX_DDL.ADD_INDEX(<em class="calibre6">'BugsCatalogSet'</em>,&nbsp;<em class="calibre6">'status'</em>);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">CTX_DDL.ADD_INDEX(<em class="calibre6">'BugsCatalogSet'</em>,&nbsp;<em class="calibre6">'priority'</em>);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;INDEX&nbsp;BugsCatalog&nbsp;ON&nbsp;Bugs(summary)&nbsp;INDEXTYPE&nbsp;IS&nbsp;CTSSYS.CTXCAT</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PARAMETERS(<em class="calibre6">'BugsCatalogSet'</em>);</code></span><br class="calibre1" /></div><br class="calibre_16" /> The <code class="calibre15">CATSEARCH</code> operator takes two arguments for searching the text column and the structured column set, respectively. <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/oracle/ctxcat-search.sql">Search/soln/oracle/ctxcat-search.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;CATSEARCH(summary,&nbsp;<em class="calibre6">'(crash&nbsp;save)'</em>,&nbsp;<em class="calibre6">'status&nbsp;=&nbsp;"NEW"'</em>)&nbsp;&gt;&nbsp;0;</code></span><br class="calibre1" /></div></li><li class="calibre_15"><code class="calibre15">CTXXPATH</code><br class="calibre_16" /> This index type is specialized for searching an XML document with the <code class="calibre15">existsNode</code> operator. <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/oracle/ctxxpath.sql">Search/soln/oracle/ctxxpath.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;INDEX&nbsp;BugTestXml&nbsp;ON&nbsp;Bugs(testoutput)&nbsp;INDEXTYPE&nbsp;IS&nbsp;CTSSYS.CTXXPATH;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;testoutput.existsNode(<em class="calibre6">'/testsuite/test[@status="fail"]'</em>)&nbsp;&gt;&nbsp;0;</code></span><br class="calibre1" /></div></li><li class="calibre_15"><code class="calibre15">CTXRULE</code><br class="calibre_16" /> Suppose you have a large collection of documents in your database and you need to classify them based on their content. <br class="calibre_16" /> With the <code class="calibre15">CTXRULE</code> index, you can design rules to analyze documents and report their classification. Alternatively, you can provide a sample set of documents with your idea of their classifications and have Oracle design the rules to apply to the rest of the document collection. You can even fully automate the process, letting Oracle analyze your document collection and come up with a set of rules and classifications for identifying them. <br class="calibre_16" /> Examples using <code class="calibre15">CTXRULE</code> indexes are beyond the scope of this book. </li></ul><h4 class="calibre_18">Full-Text Search in Microsoft SQL Server</h4><p class="calibre_6"> SQL Server 2000 and later support full-text searching, with complex configuration options for languages, a thesaurus, and automatic synchronization with data changes. SQL Server provides a series of stored procedures for creating full-text indexes, and you can use the <code class="calibre15">CONTAINS</code> operator in queries to employ the full-text index. </p><p class="calibre_6"> To perform the familiar example of searching for bugs that include the word <code class="calibre15">crash</code>, first enable the full-text feature, and define a catalog in your database: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/microsoft/catalog.sql">Search/soln/microsoft/catalog.sql</a></span></span></div><span class="calibre3"><code class="calibre15">EXEC&nbsp;sp_fulltext_database&nbsp;<em class="calibre6">'enable'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">EXEC&nbsp;sp_fulltext_catalog&nbsp;<em class="calibre6">'BugsCatalog'</em>,&nbsp;<em class="calibre6">'create'</em></code></span><br class="calibre1" /></div><p class="calibre_6"> Next, define a full-text index on the <code class="calibre15">Bugs</code> table, add columns to the index, and activate the index: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/microsoft/create-index.sql">Search/soln/microsoft/create-index.sql</a></span></span></div><span class="calibre3"><code class="calibre15">EXEC&nbsp;sp_fulltext_table&nbsp;<em class="calibre6">'Bugs'</em>,&nbsp;<em class="calibre6">'create'</em>,&nbsp;<em class="calibre6">'BugsCatalog'</em>,&nbsp;<em class="calibre6">'bug_id'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">EXEC&nbsp;sp_fulltext_column&nbsp;<em class="calibre6">'Bugs'</em>,&nbsp;<em class="calibre6">'summary'</em>,&nbsp;<em class="calibre6">'add'</em>,&nbsp;<em class="calibre6">'2057'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">EXEC&nbsp;sp_fulltext_column&nbsp;<em class="calibre6">'Bugs'</em>,&nbsp;<em class="calibre6">'description'</em>,&nbsp;<em class="calibre6">'add'</em>,&nbsp;<em class="calibre6">'2057'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">EXEC&nbsp;sp_fulltext_table&nbsp;<em class="calibre6">'Bugs'</em>,&nbsp;<em class="calibre6">'activate'</em></code></span><br class="calibre1" /></div><p class="calibre_6"> Enable automatic synchronization for the full-text index so that changes to the indexed column are propagated to the index. Then begin the process of populating the index. This will run in the background, so it may take some time to complete before queries benefit from the index. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/microsoft/start.sql">Search/soln/microsoft/start.sql</a></span></span></div><span class="calibre3"><code class="calibre15">EXEC&nbsp;sp_fulltext_table&nbsp;<em class="calibre6">'Bugs'</em>,&nbsp;<em class="calibre6">'start_change_tracking'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">EXEC&nbsp;sp_fulltext_table&nbsp;<em class="calibre6">'Bugs'</em>,&nbsp;<em class="calibre6">'start_background_updateindex'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">EXEC&nbsp;sp_fulltext_table&nbsp;<em class="calibre6">'Bugs'</em>,&nbsp;<em class="calibre6">'start_full'</em></code></span><br class="calibre1" /></div><p class="calibre_6"> Finally, run a query using the <code class="calibre15">CONTAINS</code> operator: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/microsoft/search.sql">Search/soln/microsoft/search.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;CONTAINS(summary,&nbsp;<em class="calibre6">'"crash"'</em>);</code></span><br class="calibre1" /></div><h4 class="calibre_18">Text Search in PostgreSQL</h4><p class="calibre_6"> PostgreSQL 8.3 provides a sophisticated and highly configurable way of converting text into a searchable collections of lexical elements and matching these documents against patterns. </p><p class="calibre_6"> To get the best benefit of performance, you need to store content as its original text form and also as a searchable form using the special data type <code class="calibre15">TSVECTOR</code>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/postgresql/create-table.sql">Search/soln/postgresql/create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;summary&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(80),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;description&nbsp;&nbsp;TEXT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ts_bugtext&nbsp;&nbsp;&nbsp;TSVECTOR</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;other&nbsp;columns</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Make sure the <code class="calibre15">TSVECTOR</code> column is kept in sync with the content in the text column(s) you want to make searchable. PostgreSQL provides a built-in trigger procedure to make this easier: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/postgresql/trigger.sql">Search/soln/postgresql/trigger.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TRIGGER&nbsp;ts_bugtext&nbsp;BEFORE&nbsp;INSERT&nbsp;OR&nbsp;UPDATE&nbsp;ON&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FOR&nbsp;EACH&nbsp;ROW&nbsp;EXECUTE&nbsp;PROCEDURE</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;tsvector_update_trigger(ts_bugtext,&nbsp;<em class="calibre6">'pg_catalog.english'</em>,&nbsp;summary,&nbsp;description);</code></span><br class="calibre1" /></div><p class="calibre_6"> You should also create a <span>generalized inverted index</span> (<span>GIN</span>) index on the <code class="calibre15">TSVECTOR</code> column: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/postgresql/create-index.sql">Search/soln/postgresql/create-index.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;INDEX&nbsp;bugs_ts&nbsp;ON&nbsp;Bugs&nbsp;USING&nbsp;GIN(ts_bugtext);</code></span><br class="calibre1" /></div><p class="calibre_6"> After this, you can use the PostgreSQL text search operator <code class="calibre15">@@</code> to search efficiently, aided by the full-text index: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/postgresql/search.sql">Search/soln/postgresql/search.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;ts_bugtext&nbsp;@@&nbsp;to_tsquery(<em class="calibre6">'crash'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> There are many other options for customizing searchable content, search queries, and search results. </p><h4 class="calibre_18">Full-Text Search (FTS) in SQLite</h4><p class="calibre_6"> Standard tables in SQLite don't support efficient full-text searches, but you can use an optional extension for SQLite to store searchable text in a <span>virtual table</span> specialized for searching text. Three versions of the searchable text extension exist, known as FTS1, FTS2, and FTS3. </p><p class="calibre_6"> FTS extensions are not typically enabled in a default build of SQLite, so you need to build it from source with one of the FTS extensions enabled. For example, add the following options to <code class="calibre15">Makefile.in</code>, and then build SQLite. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/sqlite/makefile.in">Search/soln/sqlite/makefile.in</a></span></span></div><span class="calibre3"><code class="calibre15">TCC&nbsp;+=&nbsp;-DSQLITE_CORE=1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">TCC&nbsp;+=&nbsp;-DSQLITE_ENABLE_FTS3=1</code></span><br class="calibre1" /></div><p class="calibre_6"> Once you have a version of SQLite with FTS enabled, you can create a virtual table for the searchable text. Any data type, constraints, or other column options are ignored. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/sqlite/create-table.sql">Search/soln/sqlite/create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;VIRTUAL&nbsp;TABLE&nbsp;BugsText&nbsp;USING&nbsp;fts3(summary,&nbsp;description);</code></span><br class="calibre1" /></div><p class="calibre_6"> If you are indexing text from another table (as in this example using the <code class="calibre15">Bugs</code> table), you must copy the data into the virtual table. The FTS virtual table always contains a primary key column called <code class="calibre15">docid</code>, so you can correlate rows to those in a source table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/sqlite/insert.sql">Search/soln/sqlite/insert.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;BugsText&nbsp;(docid,&nbsp;summary,&nbsp;description)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;bug_id,&nbsp;summary,&nbsp;description&nbsp;FROM&nbsp;Bugs;</code></span><br class="calibre1" /></div><p class="calibre_6"> Now you can query the FTS virtual table <code class="calibre15">BugsText</code> using the efficient full-text search predicate <code class="calibre15">MATCH</code>, and you can join matching rows to the source table <code class="calibre15">Bugs</code>. Using the name of the FTS table as a pseudocolumn matches the pattern against any column. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/sqlite/search.sql">Search/soln/sqlite/search.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;b.*&nbsp;FROM&nbsp;BugsText&nbsp;t&nbsp;JOIN&nbsp;Bugs&nbsp;b&nbsp;ON&nbsp;(t.docid&nbsp;=&nbsp;b.bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;BugsText&nbsp;MATCH&nbsp;<em class="calibre6">'crash'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> The matching pattern also supports limited boolean expressions. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/sqlite/search-boolean.sql">Search/soln/sqlite/search-boolean.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;BugsText&nbsp;WHERE&nbsp;BugsText&nbsp;MATCH&nbsp;<em class="calibre6">'crash&nbsp;-save'</em>;</code></span><br class="calibre1" /></div><h3 class="calibre_8">Third-Party Search Engines</h3><p class="calibre_6"> If you need to search text in a way that works the same regardless of which database brand you use, you need a search engine that runs independently from the SQL database. This section briefly describes two such products, Sphinx Search and Apache Lucene. </p><h4 class="calibre_18">Sphinx Search</h4><p class="calibre_6"> Sphinx Search (<a href="http://www.sphinxsearch.com/">http://www.sphinxsearch.com/</a>) is an open source search engine technology that integrates well with MySQL and PostgreSQL. As of this writing, an unofficial patch exists for using Sphinx Search with the open source Firebird database. Perhaps in the future this search engine will support other databases. </p><p class="calibre_6"> Indexing and searching is fast in Sphinx Search, and it supports distributed queries as well. It's a good choice for high-scale searching applications that have data that updates infrequently. </p><p class="calibre_6"> You can use Sphinx Search to index data stored in a MySQL database. By modifying a few fields in a configuration file <code class="calibre15">sphinx.conf</code>, you can specify the database. You must also write an SQL query to fetch data for building the index. The first column in this query is the integer primary key. You may declare some columns as attributes for restricting or sorting results. The remaining columns are those to be full-text indexed. Finally, another SQL query fetches a full row from the database given a primary key value coded as <code class="calibre15">$id</code>. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/sphinx/sphinx.conf">Search/soln/sphinx/sphinx.conf</a></span></span></div><span class="calibre3"><code class="calibre15">source&nbsp;bugsrc</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;mysql</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;sql_user&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;bugsuser</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;sql_pass&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;xyzzy</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;sql_db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;bugsdatabase</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;sql_query&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;\</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;bug_id,&nbsp;status,&nbsp;date_reported,&nbsp;summary,&nbsp;description&nbsp;\</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;sql_attr_timestamp&nbsp;&nbsp;&nbsp;=&nbsp;date_reported</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;sql_attr_str2ordinal&nbsp;=&nbsp;status</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;sql_query_info&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;$id</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">index&nbsp;bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;bugsrc</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;/opt/local/var/db/sphinx/bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /></div><p class="calibre_6"> Once you declare this configuration in <code class="calibre15">sphinx.conf</code>, you can create the index at the shell with the <code class="calibre15">indexer</code> command: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/sphinx/indexer.sh">Search/soln/sphinx/indexer.sh</a></span></span></div><span class="calibre3"><code class="calibre15">indexer&nbsp;-c&nbsp;sphinx.conf&nbsp;bugs</code></span><br class="calibre1" /></div><p class="calibre_6"> You can search the index using the <code class="calibre15">search</code> command: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/sphinx/search.sh">Search/soln/sphinx/search.sh</a></span></span></div><span class="calibre3"><code class="calibre15">search&nbsp;-b&nbsp;<em class="calibre6">"crash&nbsp;-save"</em></code></span><br class="calibre1" /></div><p class="calibre_6"> Sphinx Search also has a daemon process and an API with which to invoke searches from popular scripting languages such as PHP, Perl, and Ruby. The major disadvantage of the current software is that the index algorithm doesn't support incremental updates efficiently. Using Sphinx Search over a data source that updates frequently requires some compromises. For example, split your searchable table into two tables, the first to store the majority of historical data that doesn't change and the second to store a smaller set of current data that grows incrementally and must be reindexed. Then your application must search two Sphinx Search indexes. </p><h4 class="calibre_18">Apache Lucene</h4><p class="calibre_6"> Lucene (<a href="http://lucene.apache.org/">http://lucene.apache.org/</a>) is a mature search engine for Java applications. Work-alike projects exist for other languages including C++, C#, Perl, Python, Ruby, and PHP. </p><p class="calibre_6"> Lucene builds an index in its proprietary format for a collection of text <span>documents</span>. The Lucene index doesn't stay in sync with the source data it indexes. If you insert, delete, or update rows in the database, you must apply matching changes to a Lucene index. </p><p class="calibre_6"> Using the Lucene search engine is a bit like using a car engine; you need quite a bit of supporting technology around it to make it useful. Lucene doesn't read data collections from an SQL database directly. you have to write documents in the Lucene index. For example, you could run an SQL query and, for each row of the result, create one Lucene document and save it to the Lucene index. You can use Lucene through its Java API. </p><p class="calibre_6"> Fortunately, Apache also offers a complementary project called Solr (<a href="http://lucene.apache.org/solr/">http://lucene.apache.org/solr/</a>. Solr is a server that provides a gateway to a Lucene index. You can add documents to Solr and submit search queries using a REST-like interface so you can use it from any programming language. </p><p class="calibre_6"> You can also direct Solr to connect to a database itself, run a query, and index the results using its <code class="calibre15">DataImportHandler</code> tool. </p><h3 class="calibre_8">Roll Your Own</h3><p class="calibre_6"> Suppose you don't want to use proprietary search features, nor do you want to install an independent search engine product. You need an efficient, database-independent solution to make text searchable. In this section, we design what's called an <span>inverted index</span>. Basically, an inverted index is a list of all words one might search for. In a many-to-many relationship, the index associates these words with the text entries that contain the respective word. That is, a word like <code class="calibre15">crash</code> can appear in many bugs, and each bug may match many other keywords. This section shows how to design an inverted index. </p><p class="calibre_6"> First, define a table <code class="calibre15">Keywords</code> to list keywords for which users search, and define an intersection table <code class="calibre15">BugsKeywords</code> to establish a many-to-many relationship: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/inverted-index/create-table.sql">Search/soln/inverted-index/create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Keywords&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;keyword_id&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;keyword&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(40)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;UNIQUE&nbsp;KEY&nbsp;(keyword)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsKeywords&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;keyword_id&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(keyword_id,&nbsp;bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(keyword_id)&nbsp;REFERENCES&nbsp;Keywords(keyword_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Next, add a row to <code class="calibre15">BugsKeywords</code> for every keyword that matches the description text for a given bug. We can use substring-match query to determine these matches using <code class="calibre15">LIKE</code> or regular expressions. This is nothing more costly than the naive searching method described in the "Antipattern" section, but we gain efficiency because we only need to perform the search once. If we save the result in the intersection table, all subsequent searches for the same keyword are much faster. </p><p class="calibre_6"> Next, we write a stored procedure to make it easier to search for a given keyword.<a href="#calibre_link-57" id="calibre_link-60">[18]</a> If the word has already been searched, the query is faster because the rows in <code class="calibre15">BugsKeywords</code> are a list of the documents that contain the keyword. If no one has searched for the given keyword before, we need to search the collection of text entries the hard way. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/inverted-index/search-proc.sql">Search/soln/inverted-index/search-proc.sql</a></span></span></div><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">CREATE&nbsp;PROCEDURE&nbsp;BugsSearch(keyword&nbsp;VARCHAR(40))</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">BEGIN</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SET&nbsp;@keyword&nbsp;=&nbsp;keyword;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">1»</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PREPARE&nbsp;s1&nbsp;FROM&nbsp;'SELECT&nbsp;MAX(keyword_id)&nbsp;INTO&nbsp;@k&nbsp;FROM&nbsp;Keywords&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;keyword&nbsp;=&nbsp;?';</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;EXECUTE&nbsp;s1&nbsp;USING&nbsp;@keyword;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;DEALLOCATE&nbsp;PREPARE&nbsp;s1;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;IF&nbsp;(@k&nbsp;IS&nbsp;NULL)&nbsp;THEN</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">2»</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;PREPARE&nbsp;s2&nbsp;FROM&nbsp;<em class="calibre6">'INSERT&nbsp;INTO&nbsp;Keywords&nbsp;(keyword)&nbsp;VALUES&nbsp;(?)'</em>;&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;EXECUTE&nbsp;s2&nbsp;USING&nbsp;@keyword;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;DEALLOCATE&nbsp;PREPARE&nbsp;s2;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">3»</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;LAST_INSERT_ID()&nbsp;INTO&nbsp;@k;&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">4»</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;PREPARE&nbsp;s3&nbsp;FROM&nbsp;'INSERT&nbsp;INTO&nbsp;BugsKeywords&nbsp;(bug_id,&nbsp;keyword_id)&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;bug_id,&nbsp;?&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;summary&nbsp;REGEXP&nbsp;CONCAT(<em class="calibre6">''</em>[[:&lt;:]]<em class="calibre6">''</em>,&nbsp;?,&nbsp;<em class="calibre6">''</em>[[:&gt;:]]<em class="calibre6">''</em>)</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;description&nbsp;REGEXP&nbsp;CONCAT(<em class="calibre6">''</em>[[:&lt;:]]<em class="calibre6">''</em>,&nbsp;?,&nbsp;<em class="calibre6">''</em>[[:&gt;]]<em class="calibre6">''</em>)';</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;EXECUTE&nbsp;s3&nbsp;USING&nbsp;@k,&nbsp;@keyword,&nbsp;@keyword;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;DEALLOCATE&nbsp;PREPARE&nbsp;s3;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;END&nbsp;IF;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">5»</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PREPARE&nbsp;s4&nbsp;FROM&nbsp;'SELECT&nbsp;b.*&nbsp;FROM&nbsp;Bugs&nbsp;b&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;JOIN&nbsp;BugsKeywords&nbsp;k&nbsp;USING&nbsp;(bug_id)</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;k.keyword_id&nbsp;=&nbsp;?';</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;EXECUTE&nbsp;s4&nbsp;USING&nbsp;@k;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;DEALLOCATE&nbsp;PREPARE&nbsp;s4;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">END</code></span><br class="calibre1" /></div><dl class="calibre16"><p class="calibre_6"><span><span class="calibre_22">«1»</span></span></p><blockquote class="calibre_9"> Search for the user-specified keyword. Return either the integer primary key from <code class="calibre15">Keywords.keyword_id</code> or null if the word has not been seen previously. <br class="calibre1" /></blockquote><p class="calibre_6"><span><span class="calibre_22">«2»</span></span></p><blockquote class="calibre_9"> If the word was not found, insert it as a new word. <br class="calibre1" /></blockquote><p class="calibre_6"><span><span class="calibre_22">«3»</span></span></p><blockquote class="calibre_9"> Query for the primary key value generated in <code class="calibre15">Keywords</code>. <br class="calibre1" /></blockquote><p class="calibre_6"><span><span class="calibre_22">«4»</span></span></p><blockquote class="calibre_9"> Populate the intersection table by searching <code class="calibre15">Bugs</code> for rows containing the new keyword. <br class="calibre1" /></blockquote><p class="calibre_6"><span><span class="calibre_22">«5»</span></span></p><blockquote class="calibre_9"> Finally, query the full rows from <code class="calibre15">Bugs</code> that match the <code class="calibre15">keyword_id</code>, whether the keyword was found or had to be inserted as a new entry. <br class="calibre1" /></blockquote></dl><p class="calibre_6"> Now we can call this stored procedure and pass the desired keyword. The procedure returns the set of matching bugs, whether it has to calculate the matching bugs and populate the intersection table for a new keyword or whether it simply benefits from the result of an earlier search. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/inverted-index/search-proc.sql">Search/soln/inverted-index/search-proc.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CALL&nbsp;BugsSearch(<em class="calibre6">'crash'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> There's another piece to this solution: we need to define a trigger to populate the intersection table as each new bug is inserted. If you need to support edits to bug descriptions, you may also have to write a trigger to reanalyze text and add or delete rows in the <code class="calibre15">BugsKeywords</code> table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Search/soln/inverted-index/trigger.sql">Search/soln/inverted-index/trigger.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TRIGGER&nbsp;Bugs_Insert&nbsp;AFTER&nbsp;INSERT&nbsp;ON&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FOR&nbsp;EACH&nbsp;ROW</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">BEGIN</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;INSERT&nbsp;INTO&nbsp;BugsKeywords&nbsp;(bug_id,&nbsp;keyword_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;NEW.bug_id,&nbsp;k.keyword_id&nbsp;FROM&nbsp;Keywords&nbsp;k</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;NEW.description&nbsp;REGEXP&nbsp;CONCAT(<em class="calibre6">'[[:&lt;:]]'</em>,&nbsp;k.keyword,&nbsp;<em class="calibre6">'[[:&gt;:]]'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;NEW.summary&nbsp;REGEXP&nbsp;CONCAT(<em class="calibre6">'[[:&lt;:]]'</em>,&nbsp;k.keyword,&nbsp;<em class="calibre6">'[[:&gt;:]]'</em>);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">END</code></span><br class="calibre1" /></div><p class="calibre_6"> The keyword list is populated naturally as users perform searches, so we don't need to fill the keyword list with every word found in the knowledge-base articles. On the other hand, if we can anticipate likely keywords, we can easily run a search for them, thus bearing the initial cost of being the first to search for each keyword so that doesn't fall on our users. </p><p class="calibre_6"> I used an inverted index for my knowledge-base application that I described at the start of this chapter. I also enhanced the <code class="calibre15">Keywords</code> table with an additional column <code class="calibre15">num_searches</code>. I incremented this column each time a user searched for a given keyword so I could track which searches were most in demand. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">You don't have to use SQL to solve every problem.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-58" id="calibre_link-197">[16]</a>
<small class="calibre3"> Although SQL-99 defines the predicate <code class="calibre15">SIMILAR&nbsp;TO</code> for matching regular expressions, most brands of SQL database use nonstandard syntax. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-59" id="calibre_link-198">[17]</a>
<small class="calibre3"> This example uses MySQL syntax. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-60" id="calibre_link-57">[18]</a>
<small class="calibre3"> This example stored procedure uses MySQL syntax. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-539"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-105">
<pagebreak>
<a id="calibre_link-540">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-223" class="calibre12"><small class="calibre13">Chapter 18</small><br class="calibre14" />Spaghetti Query</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"><em class="calibre6">Enita non sunt multiplicanda praeter necessitatem</em> (Latin,&nbsp;"entities are not to be multiplied beyond necessity"). </em></p></div><div class="calibre1"><div class="calibre4"><span>William of Ockham</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> Your boss is on the phone with his boss, and he waves to you to come over. He covers his phone receiver with his hand and whispers to you, "The executives are in a budget meeting, and we're going to have our staff cut unless we can feed my VP some statistics to prove that our department keeps a lot of people busy. I need to know how many products we work on, how many developers fixed bugs, the average bugs fixed per developer, and how many of our fixed bugs were reported by customers. Right now!" </p><p class="calibre_6"> You leap to your SQL tool and start writing. You want all the answers at once, so you make one complex query, hoping to do the least amount of duplicate work and therefore produce the results faster. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Spaghetti-Query/intro/report.sql">Spaghetti-Query/intro/report.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;COUNT(bp.product_id)&nbsp;AS&nbsp;how_many_products,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;COUNT(dev.account_id)&nbsp;AS&nbsp;how_many_developers,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;COUNT(b.bug_id)/COUNT(dev.account_id)&nbsp;AS&nbsp;avg_bugs_per_developer,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;COUNT(cust.account_id)&nbsp;AS&nbsp;how_many_customers</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;b&nbsp;JOIN&nbsp;BugsProducts&nbsp;bp&nbsp;ON&nbsp;(b.bug_id&nbsp;=&nbsp;bp.bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">JOIN&nbsp;Accounts&nbsp;dev&nbsp;ON&nbsp;(b.assigned_to&nbsp;=&nbsp;dev.account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">JOIN&nbsp;Accounts&nbsp;cust&nbsp;ON&nbsp;(b.reported_by&nbsp;=&nbsp;cust.account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;cust.email&nbsp;NOT&nbsp;LIKE&nbsp;<em class="calibre6">'%@example.com'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;bp.product_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> The numbers come back, but they seem wrong. How did we get dozens of products? How can the average bugs fixed be exactly 1.0? And it wasn't the number of customers; it was the number of bugs reported by customers that your boss needs. How can all the numbers be so far off? This query will be a lot more complex than you thought. </p><p class="calibre_6"> Your boss hangs up the phone. "Never mind," he sighs. "It's too late. Let's clean out our desks." </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-172">
<pagebreak>
<a id="calibre_link-541">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-542">Objective: Decrease SQL Queries</h2><p class="calibre_6"> One of the most common places where SQL programmers get stuck is when they ask, "How can I do this with a single query?" This question is asked for virtually any task. Programmers have been trained that one SQL query is difficult, complex, and expensive, so they reason that two SQL queries must be twice as bad. More than two SQL queries to solve a problem is generally out of the question. </p><p class="calibre_6"> Programmers can't reduce the complexity of their tasks, but they want to simplify the solution. They state their goal with terms like "elegant" or "efficient," and they think they've achieved those goals by solving the task with a single query. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-255">
<pagebreak>
<a id="calibre_link-543">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-544">Antipattern: Solve a Complex Problem in One Step</h2><p class="calibre_6"> SQL is a very expressive language---you can accomplish a lot in a single query or statement. But that doesn't mean it's mandatory or even a good idea to approach every task with the assumption it has to be done in one line of code. Do you have this habit with any other programming language you use? Probably not. </p><h3 class="calibre_8">Unintended Products</h3><p class="calibre_6"> One common consequence of producing all your results in one query is a <span>Cartesian product</span>. This happens when two of the tables in the query have no condition restricting their relationship. Without such a restriction, the join of two tables pairs each row in the first table to <em class="calibre6">every</em> row in the other table. Each such pairing becomes a row of the result set, and you end up with many more rows than you expect. </p><p class="calibre_6"> Let's see an example. Suppose we want to query our bugs database to count the number of bugs fixed, and the number of bugs open, for a given product. Many programmers would try to use a query like the following to calculate these counts: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Spaghetti-Query/anti/cartesian.sql">Spaghetti-Query/anti/cartesian.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;p.product_id,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;COUNT(f.bug_id)&nbsp;AS&nbsp;count_fixed,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;COUNT(o.bug_id)&nbsp;AS&nbsp;count_open</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;BugsProducts&nbsp;p</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Bugs&nbsp;f&nbsp;ON&nbsp;(p.bug_id&nbsp;=&nbsp;f.bug_id&nbsp;AND&nbsp;f.status&nbsp;=&nbsp;<em class="calibre6">'FIXED'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Bugs&nbsp;o&nbsp;ON&nbsp;(p.bug_id&nbsp;=&nbsp;o.bug_id&nbsp;AND&nbsp;o.status&nbsp;=&nbsp;<em class="calibre6">'OPEN'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;p.product_id&nbsp;=&nbsp;1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;p.product_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> You happen to know that in reality there are twelve fixed bugs and seven open bugs for the given product. So, the result of the query is puzzling: </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">product_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">count_fixed</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">count_open</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">84</p></td><td class="calibre19"><p class="calibre_6">84</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> What caused this to be so inaccurate? It's no coincidence that 84 is 12 times 7. This example joins the <code class="calibre15">Products</code> table to two different subsets of <code class="calibre15">Bugs</code>, but this results in a Cartesian product between those two sets of bugs. Each of the twelve rows for <code class="calibre15">FIXED</code> bugs is paired with all seven rows for <code class="calibre15">OPEN</code> bugs. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Spaghetti/cartesian-product.jpg" src="images/000005.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-256" class="calibre10">Figure 1. Cartesian product between fixed and open bugs</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> You can visualize the Cartesian product graphically as shown in Figure <a href="#calibre_link-256"><em class="calibre6">Cartesian product between fixed and open bugs</em></a>. Each line connecting a fixed bug to an open bug becomes a row in the interim result set (before grouping is applied). We can see this interim result set by eliminating the <code class="calibre15">GROUP&nbsp;BY</code> clause and aggregate functions. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Spaghetti-Query/anti/cartesian-no-group.sql">Spaghetti-Query/anti/cartesian-no-group.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;p.product_id,&nbsp;f.bug_id&nbsp;AS&nbsp;fixed,&nbsp;o.bug_id&nbsp;AS&nbsp;open</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;BugsProducts&nbsp;p</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">JOIN&nbsp;Bugs&nbsp;f&nbsp;ON&nbsp;(p.bug_id&nbsp;=&nbsp;f.bug_id&nbsp;AND&nbsp;f.status&nbsp;=&nbsp;<em class="calibre6">'FIXED'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">JOIN&nbsp;Bugs&nbsp;o&nbsp;ON&nbsp;(p.bug_id&nbsp;=&nbsp;o.bug_id&nbsp;AND&nbsp;o.status&nbsp;=&nbsp;<em class="calibre6">'OPEN'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;p.product_id&nbsp;=&nbsp;1;</code></span><br class="calibre1" /></div><p class="calibre_6"> The only relationships expressed in that query are between the <code class="calibre15">Bugs-</code><code class="calibre15">Products</code> table and each subset of <code class="calibre15">Bugs</code>. No conditions restrict every <code class="calibre15">FIXED</code> bug from matching with every <code class="calibre15">OPEN</code> bug, and the default is that they do. The result produces twelve times seven rows. </p><p class="calibre_6"> It's all too easy to produce an unintentional Cartesian product when you try to make a query do double-duty like this. If you try to do more unrelated tasks with a single query, the total could be multiplied by yet another Cartesian product. </p><h3 class="calibre_8">As Though That Weren't Enough…</h3><p class="calibre_6"> Besides the fact that you can get the wrong results, it's important to consider that these queries are simply hard to write, hard to modify, and hard to debug. You should expect to get regular requests for incremental enhancements to your database applications. Managers want more complex reports and more fields in a user interface. If you design intricate, monolithic SQL queries, it's more costly and time-consuming to make enhancements to them. Your time is worth something, both to you and to your project. </p><p class="calibre_6"> There are runtime costs, too. An elaborate SQL query that has to use many joins, correlated subqueries, and other operations is harder for the SQL engine to optimize and execute quickly than a more straightforward query. Programmers have an instinct that executing fewer SQL queries is better for performance. This is true assuming the SQL queries in question are of equal complexity. On the other hand, the cost of a single monster query can increase exponentially, until it's much more economical to use several simpler queries. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-316">
<pagebreak>
<a id="calibre_link-545">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-546">How to Recognize the Antipattern</h2><p class="calibre_6"> If you hear the following statements from members of your project, it could indicate a case of the Spaghetti Query antipattern: </p><ul class="calibre_14"><li class="calibre_15"> "Why are my sums and counts impossibly large?" <br class="calibre_16" /> An unintended Cartesian product has multiplied two different joined data sets. </li><li class="calibre_15"> "I've been working on this monster SQL query all day!" <br class="calibre_16" /> SQL isn't this difficult---really. If you've been struggling with a single query for too long, you should reconsider your approach. </li><li class="calibre_15"> "We can't add anything to our database report, because it will take too long to figure out how to recode the SQL query." <br class="calibre_16" /> The person who coded the query will be responsible for maintaining that code forever, even if they have moved on to other projects. That person could be you, so don't write overly complex SQL that no one else can maintain! </li><li class="calibre_15"> "Try putting another <code class="calibre15">DISTINCT</code> into the query." <br class="calibre_16" /> Compensating for the explosion of rows in a Cartesian product, programmers reduce duplicates using the <code class="calibre15">DISTINCT</code> keyword as a query modifier or an aggregate function modifier. This hides the evidence of the malformed query but causes extra work for the RDBMS to generate the interim result set only to sort it and discard duplicates. </li></ul><p class="calibre_6"> Another clue that a query might be a Spaghetti Query is simply that it has an excessively long execution time. Poor performance could be symptomatic of other causes, but as you investigate such a query, you should consider that you may be trying to do too much in a single SQL statement. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-41">
<pagebreak>
<a id="calibre_link-547">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-548">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> The most common reason that you might need to run a complex task with a single query is that you're using a programming framework or a visual component library that connects to a data source and presents data in an application. Simple business intelligence and reporting tools also fall into this category, although more sophisticated BI software can merge results from multiple data sources. </p><p class="calibre_6"> A component or reporting tool that assumes its data source is a single SQL query may have a simpler usage, but it encourages you to design monolithic queries to synthesize all the data for your report. If you use one of these reporting applications, you may be forced to write a more complex SQL query than if you had the opportunity to write code to process the result set. </p><p class="calibre_6"> If the reporting requirements are too complex to be satisfied by a single SQL query, it might be better to produce multiple reports. If your boss doesn't like this, remind him or her of the relationship between the report's complexity and the hours it takes to produce it. </p><p class="calibre_6"> Sometimes, you may want to produce a complex result in one query because you need all the results combined in sorted order. It's easy to specify a sort order in an SQL query. It's likely to be more efficient for the database to do that than for you to write custom code in your application to sort the results of several queries. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-91">
<pagebreak>
<a id="calibre_link-549">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-550">Solution: Divide and Conquer</h2><p class="calibre_6"> The quote from William of Ockham at the beginning of this chapter is also known as the <span>law of parsimony</span>: </p><blockquote class="calibre_9"><div class="calibre1">The Law of Parsimony</div><div class="calibre1"><p class="calibre_6"> When you have two competing theories that make exactly the same predictions, the simpler one is the better. </p></div></blockquote><p class="calibre_6"> What this means to SQL is that when you have a choice between two queries that produce the same result set, choose the simpler one. We should keep this in mind when straightening out instances of this antipattern. </p><h3 class="calibre_8">One Step at a Time</h3><p class="calibre_6"> If you can't see a logical join condition between the tables involved in an unintended Cartesian product, that could be because there simply is no such condition. To avoid the Cartesian product, you have to split up a Spaghetti Query into several simpler queries. In the simple example shown earlier, we need only two queries: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Spaghetti-Query/soln/split-query.sql">Spaghetti-Query/soln/split-query.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;p.product_id,&nbsp;COUNT(f.bug_id)&nbsp;AS&nbsp;count_fixed</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;BugsProducts&nbsp;p</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Bugs&nbsp;f&nbsp;ON&nbsp;(p.bug_id&nbsp;=&nbsp;f.bug_id&nbsp;AND&nbsp;f.status&nbsp;=&nbsp;<em class="calibre6">'FIXED'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;p.product_id&nbsp;=&nbsp;1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;p.product_id;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;p.product_id,&nbsp;COUNT(o.bug_id)&nbsp;AS&nbsp;count_open</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;BugsProducts&nbsp;p</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Bugs&nbsp;o&nbsp;ON&nbsp;(p.bug_id&nbsp;=&nbsp;o.bug_id&nbsp;AND&nbsp;o.status&nbsp;=&nbsp;<em class="calibre6">'OPEN'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;p.product_id&nbsp;=&nbsp;1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;p.product_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> The results of these two queries are 12 and 7, as expected. </p><p class="calibre_6"> You may feel slight regret at resorting to an "inelegant" solution by splitting this into multiple queries, but this should quickly be replaced by relief as you realize this has several positive effects for development, maintenance, and performance: </p><ul class="calibre_14"><li class="calibre_15"> The query doesn't produce an unwanted Cartesian product, as shown in the earlier examples, so it's easier to be sure the query is giving you accurate results. </li><li class="calibre_15"> When new requirements are added to the report, it's easier to add another simple query than to integrate more calculations into an already-complicated query. </li><li class="calibre_15"> The SQL engine can usually optimize and execute a simple query more easily and reliably than a complex query. Even if it seems like the work is duplicated by splitting the query, it may nevertheless be a net win. </li><li class="calibre_15"> In a code review or a teammate training session, it's easier to explain how several straightforward queries work than to explain one intricate query. </li></ul><h3 class="calibre_8">Look for the UNION Label</h3><p class="calibre_6"> You can combine the results of several queries into one result set with the <code class="calibre15">UNION</code> operation. This can be useful if you really want to submit a single query and consume a single result set, for instance because the result needs to be sorted. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Spaghetti-Query/soln/union.sql">Spaghetti-Query/soln/union.sql</a></span></span></div><span class="calibre3"><code class="calibre15">(SELECT&nbsp;p.product_id,&nbsp;f.status,&nbsp;COUNT(f.bug_id)&nbsp;AS&nbsp;bug_count</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;FROM&nbsp;BugsProducts&nbsp;p</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Bugs&nbsp;f&nbsp;ON&nbsp;(p.bug_id&nbsp;=&nbsp;f.bug_id&nbsp;AND&nbsp;f.status&nbsp;=&nbsp;<em class="calibre6">'FIXED'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;WHERE&nbsp;p.product_id&nbsp;=&nbsp;1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;GROUP&nbsp;BY&nbsp;p.product_id,&nbsp;f.status)</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">UNION&nbsp;ALL</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">(SELECT&nbsp;p.product_id,&nbsp;o.status,&nbsp;COUNT(o.bug_id)&nbsp;AS&nbsp;bug_count</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;FROM&nbsp;BugsProducts&nbsp;p</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Bugs&nbsp;o&nbsp;ON&nbsp;(p.bug_id&nbsp;=&nbsp;o.bug_id&nbsp;AND&nbsp;o.status&nbsp;=&nbsp;<em class="calibre6">'OPEN'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;WHERE&nbsp;p.product_id&nbsp;=&nbsp;1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;GROUP&nbsp;BY&nbsp;p.product_id,&nbsp;o.status)</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">ORDER&nbsp;BY&nbsp;bug_count;</code></span><br class="calibre1" /></div><p class="calibre_6"> The result of the query is the result of each subquery, concatenated together. This example has two rows, one for each subquery. Remember to include a column to distinguish the results of one subquery from the other, in this case the <code class="calibre15">status</code> column. </p><p class="calibre_6"> Use the <code class="calibre15">UNION</code> operation only when the columns in both subqueries are compatible. You can't change the number, name, or data type of columns midway through a result set, so be sure that the columns apply to all the rows consistently and sensibly. If you catch yourself defining a column alias like <code class="calibre15">bugcount_or_customerid_or_null</code>, you're probably using <code class="calibre15">UNION</code> to combine query results that are not compatible. </p><h3 class="calibre_8">Solving Your Boss's Problem</h3><p class="calibre_6"> How could you have solved the urgent request for statistics about your project? Your boss said, "I need to know how many products we work on, how many developers fixed bugs, the average bugs fixed per developer, and how many of our fixed bugs were reported by customers." </p><p class="calibre_6"> The best solution is to split up the work: </p><ul class="calibre_14"><li class="calibre_15"> How many products: <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Spaghetti-Query/soln/count-products.sql">Spaghetti-Query/soln/count-products.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;COUNT(*)&nbsp;AS&nbsp;how_many_products</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Products;</code></span><br class="calibre1" /></div></li><li class="calibre_15"> How many developers fixed bugs: <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Spaghetti-Query/soln/count-developers.sql">Spaghetti-Query/soln/count-developers.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;COUNT(DISTINCT&nbsp;assigned_to)&nbsp;AS&nbsp;how_many_developers</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;status&nbsp;=&nbsp;<em class="calibre6">'FIXED'</em>;</code></span><br class="calibre1" /></div></li><li class="calibre_15"> Average number of bugs fixed per developer: <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Spaghetti-Query/soln/bugs-per-developer.sql">Spaghetti-Query/soln/bugs-per-developer.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;AVG(bugs_per_developer)&nbsp;AS&nbsp;average_bugs_per_developer</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;(SELECT&nbsp;dev.account_id,&nbsp;COUNT(*)&nbsp;AS&nbsp;bugs_per_developer</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;Bugs&nbsp;b&nbsp;JOIN&nbsp;Accounts&nbsp;dev</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;(b.assigned_to&nbsp;=&nbsp;dev.account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;b.status&nbsp;=&nbsp;<em class="calibre6">'FIXED'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GROUP&nbsp;BY&nbsp;dev.account_id)&nbsp;t;</code></span><br class="calibre1" /></div></li><li class="calibre_15"> How many of our fixed bugs were reported by customers: <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Spaghetti-Query/soln/bugs-by-customers.sql">Spaghetti-Query/soln/bugs-by-customers.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;COUNT(*)&nbsp;AS&nbsp;how_many_customer_bugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;b&nbsp;JOIN&nbsp;Accounts&nbsp;cust&nbsp;ON&nbsp;(b.reported_by&nbsp;=&nbsp;cust.account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;b.status&nbsp;=&nbsp;<em class="calibre6">'FIXED'</em>&nbsp;AND&nbsp;cust.email&nbsp;NOT&nbsp;LIKE&nbsp;<em class="calibre6">'%@example.com'</em>;</code></span><br class="calibre1" /></div></li></ul><p class="calibre_6"> Some of these queries are tricky enough by themselves. Trying to combine them all into a single pass would be a nightmare. </p><h3 class="calibre_8">Writing SQL Automatically---with SQL</h3><p class="calibre_6"> When you split up a complex SQL query, the result may be many similar queries, perhaps varying slightly depending on data values. Writing these queries is a chore, so it's a good application of code generation. </p><p class="calibre_6"><span>Code generation</span> is the technique of writing code whose output is new code you can compile or run. This can be worthwhile if the new code is laborious to write by hand. A code generator can eliminate repetitive work for you. </p><blockquote class="calibre_9"><div class="calibre1">Multitable Updates</div><div class="calibre1"><p class="calibre_6"> During a consulting job, I was called to solve an urgent SQL problem for a manager in another department. </p><p class="calibre_6"> I went to the manager's office and found a harried-looking fellow who was clearly at the end of his rope. We had barely exchanged greetings when he began sharing with me his woes. "I sure hope you can solve this problem quickly; our inventory system has been offline <em class="calibre6">all day</em>." He was no amateur with SQL, but he told me he had been working for hours on a statement that could update a large set of rows. </p><p class="calibre_6"> His problem was that he couldn't use a consistent SQL expression in his <code class="calibre15">UPDATE</code> statement for all values of rows. In fact, the value he needed to set was different on each row. His database tracked inventory for a computer lab and the usage of each computer. He wanted to set a column called <code class="calibre15">last_used</code> to the most recent date each computer had been used. </p><p class="calibre_6"> He was too focused on solving this complex task in a single SQL statement, another example of the Spaghetti Query antipattern. In the hours he had been struggling to write the perfect <code class="calibre15">UPDATE</code>, he could have made the changes manually. </p><p class="calibre_6"> Instead of writing one SQL statement to solve his complex update, I wrote a script to generate a set of simpler SQL statements that had the desired effect: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Spaghetti-Query/soln/generate-update.sql">Spaghetti-Query/soln/generate-update.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;CONCAT(<em class="calibre6">'UPDATE&nbsp;Inventory&nbsp;'</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">'&nbsp;SET&nbsp;last_used&nbsp;=&nbsp;'''</em>,&nbsp;MAX(u.usage_date),&nbsp;<em class="calibre6">''''</em>,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">'&nbsp;WHERE&nbsp;inventory_id&nbsp;=&nbsp;'</em>,&nbsp;u.inventory_id,&nbsp;<em class="calibre6">';'</em>)&nbsp;AS&nbsp;update_statement</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;ComputerUsage&nbsp;u</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">GROUP&nbsp;BY&nbsp;u.inventory_id;</code></span><br class="calibre1" /></div><p class="calibre_6"> The output of this query is a series of <code class="calibre15">UPDATE</code> statements, complete with semicolons, ready to run as an SQL script: </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">update_statement</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">UPDATE Inventory SET last_used = '2002-04-19' WHERE inventory_id = 1234;</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">UPDATE Inventory SET last_used = '2002-03-12' WHERE inventory_id = 2345;</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">UPDATE Inventory SET last_used = '2002-04-30' WHERE inventory_id = 3456;</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">UPDATE Inventory SET last_used = '2002-04-04' WHERE inventory_id = 4567;</code></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">…</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> With this technique, I solved in minutes what that manager had been struggling with for hours. </p></div></blockquote><p class="calibre_6"> Executing so many SQL queries or statements may not be the most efficient way to accomplish a task. But you should balance the goal of efficiency against the goal of getting the task done. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Although SQL makes it seem possible to solve a complex problem in a single line of code, don't be tempted to build a house of cards.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-551"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-157">
<pagebreak>
<a id="calibre_link-552">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-184" class="calibre12"><small class="calibre13">Chapter 19</small><br class="calibre14" />Implicit Columns</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> How can I tell what I think till I see what I say? </em></p></div><div class="calibre1"><div class="calibre4"><span>E. M. Forster</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> A PHP programmer asked for help troubleshooting the confusing result of a seemingly straightforward SQL query against his library database: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/intro/join-wildcard.sql">Implicit-Columns/intro/join-wildcard.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Books&nbsp;b&nbsp;JOIN&nbsp;Authors&nbsp;a&nbsp;ON&nbsp;(b.author_id&nbsp;=&nbsp;a.author_id);</code></span><br class="calibre1" /></div><p class="calibre_6"> This query returned all book titles as null. Even stranger, when he ran a different query without joining to the <code class="calibre15">Authors</code>, the result included the real book titles as expected. </p><p class="calibre_6"> I helped him find the cause of his trouble: the PHP database extension he was using returned each row resulting from the SQL query as an associative array. For example, he could access the <code class="calibre15">Books.isbn</code> column as <code class="calibre15">$row["isbn"]</code>. In his tables, both <code class="calibre15">Books</code> and <code class="calibre15">Authors</code> had a column called <code class="calibre15">title</code> (the latter was for titles like <code class="calibre15">Dr.</code> or <code class="calibre15">Rev.</code>). A single-result array element <code class="calibre15">$row["title"]</code> can store only one value; in this case, <code class="calibre15">Authors.title</code> occupied that array element. Most authors in the database had no title, so the result was that <code class="calibre15">$row["title"]</code> appeared to be null. When the query skipped the join to <code class="calibre15">Authors</code>, no conflict existed between column names, and the book title occupied the array element as expected. </p><p class="calibre_6"> I told the programmer that the solution was to declare a column alias to give one or the other <code class="calibre15">title</code> column a different name so that each would have a separate entry in the array. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/intro/join-alias.sql">Implicit-Columns/intro/join-alias.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;b.title,&nbsp;a.title&nbsp;AS&nbsp;salutation</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Books&nbsp;b&nbsp;JOIN&nbsp;Authors&nbsp;a&nbsp;ON&nbsp;(b.author_id&nbsp;=&nbsp;a.author_id);</code></span><br class="calibre1" /></div><p class="calibre_6"> His second question was, "How do I give one column an alias but also request other columns?" He wanted to continue using the wildcard (<code class="calibre15">SELECT *</code>) but apply an alias to one column covered by the wildcard. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-242">
<pagebreak>
<a id="calibre_link-553">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-554">Objective: Reduce Typing</h2><p class="calibre_6"> Software developers don't seem to like to type, which in a way makes their choice of career ironic, like the twist ending in an O.&nbsp;Henry story. </p><p class="calibre_6"> One example that programmers cite as requiring too much typing is when writing all the columns used in an SQL query: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/obj/select-explicit.sql">Implicit-Columns/obj/select-explicit.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;bug_id,&nbsp;date_reported,&nbsp;summary,&nbsp;description,&nbsp;resolution,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by,&nbsp;assigned_to,&nbsp;verified_by,&nbsp;status,&nbsp;priority,&nbsp;hours</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs;</code></span><br class="calibre1" /></div><p class="calibre_6"> It's no surprise that software developers gratefully use the SQL <span>wildcard</span> feature. The <code class="calibre15">*</code> symbol means <em class="calibre6">every column</em>, so the list of columns is implicit rather than explicit. This helps make queries more concise. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/obj/select-implicit.sql">Implicit-Columns/obj/select-implicit.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs;</code></span><br class="calibre1" /></div><p class="calibre_6"> Likewise, when using <code class="calibre15">INSERT</code>, it seems smart to take advantage of the default: the values apply to all the columns in the order they're defined in the table. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/obj/insert-explicit.sql">Implicit-Columns/obj/insert-explicit.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Accounts&nbsp;(account_name,&nbsp;first_name,&nbsp;last_name,&nbsp;email,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;password,&nbsp;portrait_image,&nbsp;hourly_rate)&nbsp;VALUES</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;(<em class="calibre6">'bkarwin'</em>,&nbsp;<em class="calibre6">'Bill'</em>,&nbsp;<em class="calibre6">'Karwin'</em>,&nbsp;<em class="calibre6">'bill@example.com'</em>,&nbsp;SHA2(<em class="calibre6">'xyzzy'</em>),&nbsp;NULL,&nbsp;49.95);</code></span><br class="calibre1" /></div><p class="calibre_6"> It's shorter to write the statement without listing the columns. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/obj/insert-implicit.sql">Implicit-Columns/obj/insert-implicit.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Accounts&nbsp;VALUES&nbsp;(DEFAULT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">'bkarwin'</em>,&nbsp;<em class="calibre6">'Bill'</em>,&nbsp;<em class="calibre6">'Karwin'</em>,&nbsp;<em class="calibre6">'bill@example.com'</em>,&nbsp;SHA2(<em class="calibre6">'xyzzy'</em>),&nbsp;NULL,&nbsp;49.95);</code></span><br class="calibre1" /></div></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-297">
<pagebreak>
<a id="calibre_link-555">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-556">Antipattern: a Shortcut That Gets You Lost</h2><p class="calibre_6"> Although using wildcards and unnamed columns satisfies the goal of less typing, this habit creates several hazards. </p><h3 class="calibre_8">Breaking Refactoring</h3><p class="calibre_6"> Suppose you need to add a column to the <code class="calibre15">Bugs</code> table, such as <code class="calibre15">date_due</code> for scheduling purposes. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/anti/add-column.sql">Implicit-Columns/anti/add-column.sql</a></span></span></div><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Bugs&nbsp;ADD&nbsp;COLUMN&nbsp;date_due&nbsp;DATE;</code></span><br class="calibre1" /></div><p class="calibre_6"> Your <code class="calibre15">INSERT</code> statement now results in an error, because you listed eleven values instead of the twelve the table now expects. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/anti/insert-mismatched.sql">Implicit-Columns/anti/insert-mismatched.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Bugs&nbsp;VALUES&nbsp;(DEFAULT,&nbsp;CURDATE(),&nbsp;<em class="calibre6">'New&nbsp;bug'</em>,&nbsp;<em class="calibre6">'Test&nbsp;T987&nbsp;fails...'</em>,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;123,&nbsp;NULL,&nbsp;NULL,&nbsp;DEFAULT,&nbsp;<em class="calibre6">'Medium'</em>,&nbsp;NULL);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><em class="calibre6">--&nbsp;SQLSTATE&nbsp;21S01:&nbsp;Column&nbsp;count&nbsp;doesn't&nbsp;match&nbsp;value&nbsp;count&nbsp;at&nbsp;row&nbsp;1</em></code></span><br class="calibre1" /></div><p class="calibre_6"> In an <code class="calibre15">INSERT</code> statement that uses implicit columns, you must give values for all columns in the same order that columns are defined in the table. If the columns change, the statement produces an error---or even assigns values to the wrong columns. </p><p class="calibre_6"> Suppose you run a <code class="calibre15">SELECT *</code> query, and since you don't know the column names, you reference columns based on their ordinal position: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/anti/ordinal.php">Implicit-Columns/anti/ordinal.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query("SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$row&nbsp;=&nbsp;$stmt-&gt;fetch();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$hours&nbsp;=&nbsp;$row[10];</code></span><br class="calibre1" /></div><p class="calibre_6"> But unknown to you, another person on the team dropped a column: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/anti/drop-column.sql">Implicit-Columns/anti/drop-column.sql</a></span></span></div><span class="calibre3"><code class="calibre15">ALTER&nbsp;TABLE&nbsp;Bugs&nbsp;DROP&nbsp;COLUMN&nbsp;verified_by;</code></span><br class="calibre1" /></div><p class="calibre_6"> The <code class="calibre15">hours</code> column is no longer at position 10. Your application is using the value in another column by mistake. As columns are renamed, added, or dropped, your query result could change in ways your code doesn't support. You can't predict how many columns your query returns if you use a wildcard. </p><p class="calibre_6"> These errors can propagate through your code, and by the time you notice the problem in the output of the application, it's hard to trace back to the line where the mistake occurred. </p><h3 class="calibre_8">Hidden Costs</h3><p class="calibre_6"> The convenience of using wildcards in queries can harm performance and scalability. The more columns your query fetches, the more data must travel over the network between your application and the database server. </p><p class="calibre_6"> You probably have many queries running concurrently in your production application environment. They compete for access to the same network bandwidth. Even a gigabit network can be saturated by a hundred application clients querying for thousands of rows at a time. </p><p class="calibre_6"> Object-relational mapping (ORM) techniques such as Active Record often use <code class="calibre15">SELECT *</code> by default to populate the fields of an object representing a row in a database. Even if the ORM offers the means to override this behavior, most programmers don't bother. </p><h3 class="calibre_8">You Asked for It, You Got It</h3><p class="calibre_6"> One of the most common questions I see from programmers using the SQL wildcard is, "Is there a shortcut to request all columns, except a few that I specify?" Perhaps these programmers are trying to avoid the resource cost of fetching bulky <code class="calibre15">TEXT</code> columns that they don't need, but they do want the convenience of using a wildcard. </p><p class="calibre_6"> The answer is no, SQL does not support any syntax, which means, "all the columns I want but none that I don't want." Either you use the wildcard to request all columns from a table, or else you have to list the columns you want explicitly. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-25">
<pagebreak>
<a id="calibre_link-557">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-558">How to Recognize the Antipattern</h2><p class="calibre_6"> The following scenarios may indicate that your project is using implicit columns inappropriately, and it's causing trouble: </p><ul class="calibre_14"><li class="calibre_15"> "The application broke because it's still referencing columns in the database result set by the old column names. We tried to update all the code, but I guess we missed some." <br class="calibre_16" /> You've changed a table in the database---adding, deleting, renaming, or changing the order of columns---but you failed to change your application code that references the table. It's laborious to track down all these references. </li><li class="calibre_15"> "It took us days to track down our network bottleneck, and we finally narrowed it down to excessive traffic to the database server. According to our statistics, the average query fetches more than 2MB of data but displays less than a tenth of that." <br class="calibre_16" /> You're fetching a lot of data you don't need. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-78">
<pagebreak>
<a id="calibre_link-559">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-560">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> A well-justified use of wildcards is in ad hoc SQL when you're writing quick queries to test a solution or as a diagnostic check of current data. A single-use query benefits less from maintainability. </p><p class="calibre_6"> The examples in this book use wildcards to save space and to avoid distracting from the more interesting parts of the example queries. I rarely use SQL wildcards in production application code. </p><p class="calibre_6"> If your application needs to run a query that adapts when columns are added, dropped, renamed, or repositioned, you may find it best to use wildcards. Be sure to plan for the extra work it takes to troubleshoot the pitfalls described earlier. </p><p class="calibre_6"> You can use wildcards for each table individually in a join query. Prefix the wildcard with the table name or alias. This allows you to specify a short list of specific columns you need from one table, while using the wildcard to fetch all columns from the other table. For example: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/legit/wildcard-one-table.sql">Implicit-Columns/legit/wildcard-one-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;b.*,&nbsp;a.first_name,&nbsp;a.email</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;b&nbsp;JOIN&nbsp;Accounts&nbsp;a</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ON&nbsp;(b.reported_by&nbsp;=&nbsp;a.account_id);</code></span><br class="calibre1" /></div><p class="calibre_6"> Keying in a long list of column names can be time-consuming. For some people, development efficiency is more important than runtime efficiency. Likewise, you might place a priority on writing queries that are shorter and therefore more readable. Using wildcards does reduce keystrokes and result in a shorter query, so if this is your priority, then use wildcards. </p><p class="calibre_6"> I've heard a developer claim that a long SQL query passing from the application to the database server causes too much network overhead. In theory, query length could make a difference in some cases. But it's more common that the rows of data that your query returns use much more network bandwidth than your SQL query string. Use your judgment about exception cases, but don't sweat the small stuff. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-127">
<pagebreak>
<a id="calibre_link-561">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-562">Solution: Name Columns Explicitly</h2><p class="calibre_6"> Always spell out all the columns you need, instead of relying on wildcards or implicit column lists. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/soln/select-explicit.sql">Implicit-Columns/soln/select-explicit.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;bug_id,&nbsp;date_reported,&nbsp;summary,&nbsp;description,&nbsp;resolution,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by,&nbsp;assigned_to,&nbsp;verified_by,&nbsp;status,&nbsp;priority,&nbsp;hours</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs;</code></span><br class="calibre1" /></div><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/soln/insert-explicit.sql">Implicit-Columns/soln/insert-explicit.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Accounts&nbsp;(account_name,&nbsp;first_name,&nbsp;last_name,&nbsp;email,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;password_hash,&nbsp;portrait_image,&nbsp;hourly_rate)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">VALUES&nbsp;(<em class="calibre6">'bkarwin'</em>,&nbsp;<em class="calibre6">'Bill'</em>,&nbsp;<em class="calibre6">'Karwin'</em>,&nbsp;<em class="calibre6">'bill@example.com'</em>,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SHA2(<em class="calibre6">'xyzzy'</em>),&nbsp;NULL,&nbsp;49.95);</code></span><br class="calibre1" /></div><p class="calibre_6"> All this typing seems burdensome, but it's worth it in several ways. </p><h3 class="calibre_8">Mistake-Proofing</h3><p class="calibre_6"> Remember poka-yoke?<a href="#calibre_link-128" id="calibre_link-129">[19]</a> You make your SQL queries more resistant to the errors and confusion described earlier when you specify the columns in the select-list of the query. </p><ul class="calibre_14"><li class="calibre_15"> If a column has been repositioned in the table, it doesn't change position in a query result. </li><li class="calibre_15"> If a column has been added in the table, it doesn't appear in the query result. </li><li class="calibre_15"> If a column has been dropped from the table, your query raises an error---but it's a good error, because you're led directly to the code that you need to fix, instead of left to hunt for the root cause. </li></ul><p class="calibre_6"> You get similar benefits when you specify columns in <code class="calibre15">INSERT</code> statements. The order of columns you specify overrides the order in the table definition, and values are assigned to the columns you intend. Newly added columns you haven't named in your statement are given default values or null. If you reference a column that has been deleted, you get an error, but troubleshooting is easier. </p><p class="calibre_6"> This is an example of the <span>fail early</span> principle. </p><h3 class="calibre_8">You Ain't Gonna Need It</h3><p class="calibre_6"> If you're concerned about the scalability and throughput of your software, you should look for possible wasteful use of network bandwidth. The bandwidth of an SQL query can seem harmless during software development and testing, but it bites you when your production environment is running thousands of SQL queries per second. </p><p class="calibre_6"> Once you abandon the SQL wildcard, you're naturally motivated to leave out unneeded columns---it means less typing. This promotes more efficient use of bandwidth too. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Implicit-Columns/soln/yagni.sql">Implicit-Columns/soln/yagni.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;date_reported,&nbsp;summary,&nbsp;description,&nbsp;resolution,&nbsp;status,&nbsp;priority</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs;</code></span><br class="calibre1" /></div><h3 class="calibre_8">You Need to Give Up Wildcards Anyway</h3><p class="calibre_6"> When you buy a bag of M&amp;M's candies from the vending machine, the wrapper is a convenience, making it easy to carry the package of candies back to your desk. Once you open the bag, however, you need to treat M&amp;M's as individuals. They roll, slide, and bounce all over the place. If you're not careful, some may fall under your desk and attract bugs. But there's no way to eat one until you tear open the bag. </p><p class="calibre_6"> In an SQL query, as soon as you want to apply an expression to a column or use a column alias or exclude columns for the sake of efficiency, you need to break open the "container" provided by the wildcard. You lose the convenience of treating the collection of columns as a single package, but you gain access to all of its contents. </p><p class="calibre_6"> You'll inevitably need to treat some columns in a query individually by employing a column alias or a function or removing a column from the list. If you skip the use of wildcards from the beginning, it'll be easier to change your query later. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Take all you want, but eat all you take.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-129" id="calibre_link-128">[19]</a>
<small class="calibre3"> The practice from the Japanese industry of designing mistake-proof systems. See the Chapter <a href="#calibre_link-130"><em class="calibre6">Keyless Entry</em></a>. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-563"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-199">
<pagebreak>
<a id="calibre_link-564">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 class="calibre12" id="calibre_link-224"><small class="calibre13">Part 4</small><br class="calibre14" />Application Development Antipatterns</h1><pagebreak><div class="calibre1" id="calibre_link-565"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-286">
<pagebreak>
<a id="calibre_link-566">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-225" class="calibre12"><small class="calibre13">Chapter 20</small><br class="calibre14" />Readable Passwords</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> The enemy knows the system. </em></p></div><div class="calibre1"><div class="calibre4"><span>Shannon's maxim</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> Suppose you receive a phone call from a man using one of the applications you support. The caller is having trouble logging in. </p><p class="calibre_6"> "This is Pat Johnson in Sales. I must have forgotten my password. Can you just look it up and tell me what it is?" Pat sounds a bit sheepish but also strangely in a hurry. </p><p class="calibre_6"> "I'm sorry, I'm not supposed to do that," you answer. "I can reset your account, and that'll send an email to the address you registered for your account. You can use the instructions in that email to set a new password." </p><p class="calibre_6"> The man on the phone becomes more impatient and assertive. "That's ridiculous," he says. "At my last company the support staff could look up my password. Are you unable to do your job? Do you want me to call your manager?" </p><p class="calibre_6"> Naturally, you want to preserve a smooth relationship with your users, so you run an SQL query to look up the plain-text password for Pat Johnson's account and read it to him over the phone. </p><p class="calibre_6"> The man hangs up. You comment to your co-worker, "That was a close call. I almost had an escalation from Pat Johnson. I hope he doesn't complain." </p><p class="calibre_6"> Your co-worker looks puzzled. "<em class="calibre6">He?</em> Pat Johnson in Sales is a woman. I think you just gave her password to a con artist." </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-92">
<pagebreak>
<a id="calibre_link-567">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-568">Objective: Recover or Reset Passwords</h2><p class="calibre_6"> It's a sure bet that in any application that has passwords, a user will forget his password. Most modern applications handle this by giving the user a chance to recover or reset his password through an email feedback mechanism. This solution depends on the user having access to the email address associated with the user profile in the application. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-158">
<pagebreak>
<a id="calibre_link-569">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-570">Antipattern: Store Password in Plain Text</h2><p class="calibre_6"> The frequent mistake in these kinds of password-recovery solutions is that the application allows the user to request an email containing his password in clear text. This is a dire security flaw related to the database design, and it leads to several security risks that could allow unauthorized people to gain privileged access to the application. </p><p class="calibre_6"> Let's explore these risks in the following sections, assuming our example bug-tracking database has a table <code class="calibre15">Accounts</code>, where each user's account is stored as a row in this table. </p><h3 class="calibre_8">Storing Passwords</h3><p class="calibre_6"> A password is typically stored in the <code class="calibre15">Accounts</code> table as a string attribute column: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Passwords/anti/create-table.sql">Passwords/anti/create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Accounts&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_id&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_name&nbsp;&nbsp;VARCHAR(20)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(100)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(30)&nbsp;NOT&nbsp;NULL</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> You can create an account simply by inserting one row and specifying the password as a string literal: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Passwords/anti/insert-plaintext.sql">Passwords/anti/insert-plaintext.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Accounts&nbsp;(account_id,&nbsp;account_name,&nbsp;email,&nbsp;password)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(123,&nbsp;<em class="calibre6">'billkarwin'</em>,&nbsp;<em class="calibre6">'bill@example.com'</em>,&nbsp;<em class="calibre6">'xyzzy'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> It's not secure to store a password in clear text or even to pass it over the network in the clear. If an attacker can read the SQL statement you use to insert a password, they can see the password plainly. This is also true for SQL statements to change a password or verify that user input matches a stored password. Hackers have several opportunities to steal a password, including the following: </p><ul class="calibre_14"><li class="calibre_15"> Intercepting network packets as the SQL statement is sent from the application client to the database server. This is easier than it sounds; there are free software tools such as Wireshark.<a href="#calibre_link-159" id="calibre_link-301">[20]</a></li><li class="calibre_15"> Searching SQL query logs on the database server. The attacker needs access to the database server host, but assuming they have that, they can access log files that may include a record of SQL statements executed by that database server. </li><li class="calibre_15"> Reading data from database backup files on the server or on backup media. Are your backup media kept safe? Do you erase backup media destructively before they are recycled or disposed of? </li></ul><h3 class="calibre_8">Authenticating Passwords</h3><p class="calibre_6"> Later, when the user tries to log in, your application compares the user's input to the password string stored in the database. This comparison is done as plain text, since the password itself is stored in plain text. For example, you can use a query like the following to return a 0 (false) or 1 (true), indicating whether the user's input matches the password in the database: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Passwords/anti/auth-plaintext.sql">Passwords/anti/auth-plaintext.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;CASE&nbsp;WHEN&nbsp;password&nbsp;=&nbsp;<em class="calibre6">'opensesame'</em>&nbsp;THEN&nbsp;1&nbsp;ELSE&nbsp;0&nbsp;END</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;AS&nbsp;password_matches</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Accounts</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;account_id&nbsp;=&nbsp;123;</code></span><br class="calibre1" /></div><p class="calibre_6"> In the previous example, the password the user entered, <code class="calibre15">opensesame</code>, is incorrect, and the query returns a zero value. </p><p class="calibre_6"> Like in the earlier section on storing passwords, interpolating the user's input string into the SQL query in plain text exposes it to discovery by an attacker. </p><blockquote class="calibre_9"><div class="calibre1">Don't Lump Together Two Different Conditions</div><div class="calibre1"><p class="calibre_6"> Most of the time, I see the authentication query place conditions for both the <code class="calibre15">account_id</code> and <code class="calibre15">password</code> columns in the <code class="calibre15">WHERE</code> clause: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Passwords/anti/auth-lumping.sql">Passwords/anti/auth-lumping.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Accounts</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;account_name&nbsp;=&nbsp;<em class="calibre6">'bill'</em>&nbsp;AND&nbsp;password&nbsp;=&nbsp;<em class="calibre6">'opensesame'</em>;</code></span><br class="calibre1" /></div><p class="calibre_6"> This query returns an empty result set if the account doesn't exist or if the user gave the wrong password. Your application can't separate the two causes for failed authentication. It's better to use a query that can treat the two cases as distinct. Then you can handle the failure appropriately. </p><p class="calibre_6"> For example, you may want to lock an account temporarily if you detect many failed logins, because this may indicate an attempted intrusion. However, you can't detect this pattern if you can't tell the difference between a wrong account name and a wrong password. </p></div></blockquote><h3 class="calibre_8">Sending Passwords in Email</h3><p class="calibre_6"> Since the password is stored in plain text in the database, retrieving the password in your application is simple: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Passwords/anti/select-plaintext.sql">Passwords/anti/select-plaintext.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;account_name,&nbsp;email,&nbsp;password</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Accounts</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;account_id&nbsp;=&nbsp;123;</code></span><br class="calibre1" /></div><p class="calibre_6"> Your application can then send to a user's email address on request. You've probably seen one of these emails as part of the password reminder feature of any number of websites you use. An example of this kind of email is shown here: </p><blockquote class="calibre_9"><div class="calibre1">Example of Password Recovery Email:</div><div class="calibre1"><div class="calibre_11"><span class="calibre3"><code class="calibre15">From:&nbsp;daemon</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">To:&nbsp;bill@example.com</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">Subject:&nbsp;password&nbsp;request</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">You&nbsp;requested&nbsp;a&nbsp;reminder&nbsp;of&nbsp;the&nbsp;password&nbsp;for&nbsp;your&nbsp;account&nbsp;<em class="calibre6">"bill"</em>.</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">Your&nbsp;password&nbsp;is&nbsp;<em class="calibre6">"xyzzy"</em>.</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">Click&nbsp;the&nbsp;link&nbsp;below&nbsp;to&nbsp;log&nbsp;in&nbsp;to&nbsp;your&nbsp;account:</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">http://www.example.com/login</code></span><br class="calibre1" /></div></div></blockquote><p class="calibre_6"> Sending an email with the password in plain text is a serious security risk. Email can be intercepted, logged, and stored in multiple ways by hackers. It's not good enough that you use a secure protocol to view mail or that the sending and receiving mail servers are managed by responsible system administrators. Since email is routed across the Internet, it can be intercepted at other sites. Secure protocols for email aren't necessarily widespread or under your control. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-42">
<pagebreak>
<a id="calibre_link-571">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-572">How to Recognize the Antipattern</h2><p class="calibre_6"> Any application that can recover your password and send it to you must be storing it in plain text or at least with some reversible encoding. This is the antipattern. If your application can read a password for a legitimate purpose, then it's possible that a hacker can read the password illicitly. </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Ethics of Software Development</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> If you're developing an application that supports passwords and you're asked to design a password recovery feature, you should push back respectfully, warn the project decision makers about the risks, and offer an alternative solution that provides similar value. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Just as an electrician should recognize and correct a wiring design that poses an unsafe fire risk, it's your responsibility as a software engineer to be aware of safety issues and to promote safer software. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> A good book you should read is <em class="calibre6">19 Deadly Sins of Software Security</em><a href="#calibre_link-43">[DSOSS]</a> . Another good resource is the Open Web Application Security Project (<a href="http://owasp.org">http://owasp.org</a>). </blockquote></small></p></div><hr class="calibre7" /></div></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-243">
<pagebreak>
<a id="calibre_link-573">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-574">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> Your application may need to use a password to access another third-party service---that is, your application can be a client. In this case, you must store that password in a readable format. Preferably, you use some encoding that your application can reverse, instead of using plain text in the database. </p><p class="calibre_6"> You can make a distinction between <span>identification</span> and <span>authentication</span>. A user can identify himself as anyone he wants, but authentication is proving he is who he says he is. Passwords are the most common way of doing this. </p><p class="calibre_6"> If you can't enforce security strong enough to defeat skilled and determined attackers, then you effectively have an identification mechanism but not a reliable authentication mechanism. But this isn't necessarily a deal-breaker. </p><p class="calibre_6"> Not every software application is at risk for attack, and not every application contains sensitive information that must be protected. For example, an intranet application may be accessed by only a few people who are known to be honest and cooperative. In this case, an identification mechanism may be enough for the application to work, and in those informal environments, a simpler login design may be adequate. The additional work necessary to create a strong authentication system may not be justified. </p><p class="calibre_6"> Be careful, though---applications have a tendency to evolve beyond their original environment or role. Before you make your quaint little intranet application available outside your company firewall, you should get a qualified security expert to evaluate it. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-298">
<pagebreak>
<a id="calibre_link-575">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-576">Solution: Store a Salted Hash of the Password</h2><p class="calibre_6"> The chief problem in this antipattern is that the original form of the password is readable. But you can authenticate the user's input against a password without reading it. This section describes how to implement this kind of secure password storage in an SQL database. </p><h3 class="calibre_8">Understanding Hash Functions</h3><p class="calibre_6"> Encode the password using a one-way <span>cryptographic hash function</span>. This function transforms its input string into a new string, called the <span>hash</span>, that is unrecognizable. Even the length of the original string is obscured, because the hash returned by a hash function is a fixed-length string. For example, the <code class="calibre15">SHA-256</code> algorithm converts our example password, <code class="calibre15">xyzzy</code>, to a 256-bit string of bits, usually represented as a 64-character string of hexadecimal digits: </p><div class="calibre_11"><span class="calibre3"><code class="calibre15">SHA2('xyzzy')&nbsp;=&nbsp;'184858a00fd7971f810848266ebcecee5e8b69972c5ffaed622f5ee078671aed'</code></span><br class="calibre1" /></div><p class="calibre_6"> Another characteristic of a hash is that it's not reversible. You can't recover the input string from its hash because the hashing algorithm is designed to "lose" some information about the input. A good hashing algorithm should take as much work to crack as it would to simply guess the input through trial and error. </p><p class="calibre_6"> A popular algorithm in the past has been <code class="calibre15">SHA-1</code>, but researchers have recently proved this 160-bit hashing algorithm to have insufficient cryptographic strength; a technique exists to infer the input from a hash string. This technique is very time-consuming but nevertheless takes less time than it would take to guess the password by trial and error. The National Institute of Standards and Technology (NIST) has announced a plan to phase out <code class="calibre15">SHA-1</code> as an approved secure hashing algorithm after 2010 in favor of these stronger variants: <code class="calibre15">SHA-224</code>, <code class="calibre15">SHA-256</code>, <code class="calibre15">SHA-384</code>, and <code class="calibre15">SHA-512</code>.<a href="#calibre_link-299" id="calibre_link-302">[21]</a> Whether you need to comply with NIST standards or not, it's a good idea to use at least <code class="calibre15">SHA-256</code> for passwords. </p><p class="calibre_6"><code class="calibre15">MD5</code> is another popular hash function, producing hash strings of 128 bits. <code class="calibre15">MD5</code> has also been shown to be cryptographically weak, so you shouldn't use it for encoding passwords. Weaker algorithms still have uses but not for sensitive information like passwords. </p><h3 class="calibre_8">Using a Hash in SQL</h3><p class="calibre_6"> The following is a redefinition of the <code class="calibre15">Accounts</code> table. The <code class="calibre15">SHA-256</code> password hash is always 64 characters long, so define the column as a fixed-length <code class="calibre15">CHAR</code> column of that length. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Passwords/soln/create-table.sql">Passwords/soln/create-table.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Accounts&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_name&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(100)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;password_hash&nbsp;&nbsp;CHAR(64)&nbsp;NOT&nbsp;NULL</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Hashing functions aren't part of the standard SQL language, so you may need to rely on your database brand to support hashing as an extension. For example, MySQL 6.0.5 with SSL support includes a function <code class="calibre15">SHA2</code>, which returns a 256-bit hash by default. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Passwords/soln/insert-hash.sql">Passwords/soln/insert-hash.sql</a></span></span></div><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Accounts&nbsp;(account_id,&nbsp;account_name,&nbsp;email,&nbsp;password_hash)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(123,&nbsp;<em class="calibre6">'billkarwin'</em>,&nbsp;<em class="calibre6">'bill@example.com'</em>,&nbsp;SHA2(<em class="calibre6">'xyzzy'</em>));</code></span><br class="calibre1" /></div><p class="calibre_6"> You can validate a user's input by applying the same hash function to it and comparing the result to the value stored in the database. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Passwords/soln/auth-hash.sql">Passwords/soln/auth-hash.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;CASE&nbsp;WHEN&nbsp;password_hash&nbsp;=&nbsp;SHA2(<em class="calibre6">'xyzzy'</em>)&nbsp;THEN&nbsp;1&nbsp;ELSE&nbsp;0&nbsp;END</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;AS&nbsp;password_matches</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Accounts</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;account_id&nbsp;=&nbsp;123;</code></span><br class="calibre1" /></div><p class="calibre_6"> You can lock an account easily by changing the value in the password hash to a string that the hash function can't return. For example, the string <code class="calibre15">noaccess</code> contains letters that aren't hexadecimal digits. </p><h3 class="calibre_8">Adding Salt to Your Hash</h3><p class="calibre_6"> If you store hashes instead of passwords and the attacker gains access to your database (by searching your trash for a CDROM backup, for example), he can still attempt to guess passwords by trial and error. Guessing each password may take a long time, but he can prepare his own database of hashes of likely passwords against which to compare the hash strings he finds in your database. If only one user chose a password that is a word in the dictionary, it's easy for an attacker to find it by searching your password database for hashes that match his prepared table of hashes. He can even do this with SQL: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Passwords/soln/dictionary-attack.sql">Passwords/soln/dictionary-attack.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;DictionaryHashes&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(100),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;password_hash&nbsp;&nbsp;CHAR(64)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;a.account_name,&nbsp;h.password</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Accounts&nbsp;AS&nbsp;a&nbsp;JOIN&nbsp;DictionaryHashes&nbsp;AS&nbsp;h</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;ON&nbsp;a.password_hash&nbsp;=&nbsp;h.password_hash;</code></span><br class="calibre1" /></div><p class="calibre_6"> One way to defeat this kind of "dictionary attack" is by including a <span>salt</span> in your password-encoding expression. A salt is a string of meaningless bytes you concatenate with the user's password, before passing the resulting string to the hash function. Even if the user chose a word in the dictionary as their password, the hash produced from a salted password won't match the hash in the attacker's hash database. For example, if the password is the word <em class="calibre6">password</em>, you can see that the hash of this word is different from a hash of the word with a few random bytes appended: </p><div class="calibre_11"><span class="calibre3"><code class="calibre15">SHA2(<em class="calibre6">'password'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;=&nbsp;<em class="calibre6">'5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8'</em></code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">SHA2(<em class="calibre6">'password-0xT!sp9'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;=&nbsp;<em class="calibre6">'7256d8d7741f740ee83ba7a9b30e7ac11fcd9dbd7a0147f4cc83c62dd6e0c45b'</em></code></span><br class="calibre1" /></div><p class="calibre_6"> Each password should use a different salt value to make an attacker have to generate a new dictionary table of hashes for each password. Then he's back to square one, because cracking passwords in your database takes as much time as guessing them with trial and error.<a href="#calibre_link-300" id="calibre_link-303">[22]</a></p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Passwords/soln/salt.sql">Passwords/soln/salt.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Accounts&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_name&nbsp;&nbsp;&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(100)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;password_hash&nbsp;&nbsp;CHAR(32)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;salt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY(8)&nbsp;NOT&nbsp;NULL</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Accounts&nbsp;(account_id,&nbsp;account_name,&nbsp;email,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;password_hash,&nbsp;salt)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(123,&nbsp;<em class="calibre6">'billkarwin'</em>,&nbsp;<em class="calibre6">'bill@example.com'</em>,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;SHA2(<em class="calibre6">'xyzzy'</em>&nbsp;||&nbsp;<em class="calibre6">'-0xT!sp9'</em>),&nbsp;<em class="calibre6">'-0xT!sp9'</em>);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;(password_hash&nbsp;=&nbsp;SHA2(<em class="calibre6">'xyzzy'</em>&nbsp;||&nbsp;salt))&nbsp;AS&nbsp;password_matches</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Accounts</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;account_id&nbsp;=&nbsp;123;</code></span><br class="calibre1" /></div><p class="calibre_6"> A good length for a salt is 8 bytes. You should generate the salt randomly for each password. The previous examples show a salt string containing printable characters, but remember you can make a salt using any random, unprintable bytes. </p><h3 class="calibre_8">Hiding the Password from SQL</h3><p class="calibre_6"> Now that you're using a strong hashing function to encode the password before you store it and you use a salt to thwart dictionary attacks, you would think this is enough to ensure security. But the password still appears in plain text in the SQL expression, which means that it's readable if an attacker can intercept network packets or if SQL queries are logged and the log files fall into the wrong hands. </p><p class="calibre_6"> You can protect against this kind of exposure if you don't put the plain-text password into the SQL query. Instead, compute the hash in your application code, and use only the hash in the SQL query. It does an attacker little good to intercept the hash, because he can't reverse it to get the password. </p><p class="calibre_6"> You do need the salt before you can compute the hash.</p><p class="calibre_6"> The following is a PHP example using the <code class="calibre15">PDO</code> extension to get the salt, compute a hash, and run a query to validate the password against the salted hash stored in the database: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Passwords/soln/auth-salt.php">Passwords/soln/auth-salt.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$password&nbsp;=&nbsp;<em class="calibre6">'xyzzy'</em>;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;"SELECT&nbsp;salt</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;Accounts</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;account_name&nbsp;=&nbsp;<em class="calibre6">'bill'</em>");</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$row&nbsp;=&nbsp;$stmt-&gt;fetch();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$salt&nbsp;=&nbsp;$row[0];</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$hash&nbsp;=&nbsp;hash(<em class="calibre6">'sha256'</em>,&nbsp;$password&nbsp;.&nbsp;$salt);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query("</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SELECT&nbsp;(password_hash&nbsp;=&nbsp;<em class="calibre6">'$hash'</em>)&nbsp;AS&nbsp;password_matches;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FROM&nbsp;Accounts&nbsp;AS&nbsp;a</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;WHERE&nbsp;a.acct_name&nbsp;=&nbsp;<em class="calibre6">'bill'</em>");</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$row&nbsp;=&nbsp;$stmt-&gt;fetch();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">if</span>&nbsp;($row&nbsp;===&nbsp;false)&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;//&nbsp;account&nbsp;<em class="calibre6">'bill'</em>&nbsp;does&nbsp;not&nbsp;exist</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}&nbsp;<span class="calibre10">else</span>&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;$password_matches&nbsp;=&nbsp;$row[0];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">if</span>&nbsp;(!$password_matches)&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;password&nbsp;given&nbsp;was&nbsp;incorrect</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /></div><p class="calibre_6"> The <code class="calibre15">hash</code> function is guaranteed to return only hexadecimal digits, so there's no risk of SQL injection (see the Chapter <a href="#calibre_link-226"><em class="calibre6">SQL Injection</em></a>). </p><p class="calibre_6"> In web applications, there's another place where attackers have an opportunity to intercept data on the network: between the user's browser and the web application server. When the user submits a login form, the browser sends his password in plain text to the server, where it's used to compute a hash as described earlier. You could protect against this by encoding the password into a hash in the user's browser before sending the form data. But this is awkward because you need to retrieve the salt associated with that password before you can compute the correct hash. A good compromise is to use a secure HTTP connection whenever sending a password from browser to the application. </p><h3 class="calibre_8">Resetting the Password Instead of Recovering the Password</h3><p class="calibre_6"> Now that the password is stored in a more secure way, you still need to solve the original objective: help users who have forgotten their password. You can't recover their password, because now your database stores a hash instead of the password. You can't reverse the hash any more easily than an attacker could. But you can allow a user access in other ways. Two sample implementations are described here. </p><p class="calibre_6"> The first alternative is that when a user who has forgotten his password requests help, instead of emailing his password to him, your application can send an email with a temporary password generated by the application. For additional security, the application may expire the temporary password after a short time, so if the email is intercepted, it's more likely that it will not allow unauthorized access. Also, the application should be designed so that the user is forced to change the password as his first action when he logs in. </p><blockquote class="calibre_9"><div class="calibre1">Example of Email with a System-Generated Temporary Password</div><div class="calibre1"><div class="calibre_11"><span class="calibre3"><code class="calibre15">From:&nbsp;daemon</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">To:&nbsp;bill@example.com</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">Subject:&nbsp;password&nbsp;reset</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">You&nbsp;requested&nbsp;to&nbsp;reset&nbsp;your&nbsp;password&nbsp;for&nbsp;your&nbsp;account.</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">Your&nbsp;temporary&nbsp;password&nbsp;is&nbsp;<em class="calibre6">"p0trz3b1e"</em>.</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">This&nbsp;password&nbsp;will&nbsp;cease&nbsp;to&nbsp;allow&nbsp;access&nbsp;after&nbsp;one&nbsp;hour.</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">Click&nbsp;the&nbsp;link&nbsp;below&nbsp;to&nbsp;log&nbsp;in&nbsp;to&nbsp;your&nbsp;account&nbsp;and</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">set&nbsp;your&nbsp;new&nbsp;password:</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">http://www.example.com/login</code></span><br class="calibre1" /></div></div></blockquote><p class="calibre_6"> In a second alternative, instead of including a new password in an email, the request is logged in a database table and assigned a unique token as an identifier: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Passwords/soln/reset-request.sql">Passwords/soln/reset-request.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;PasswordResetRequest&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;token&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHAR(32)&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_id&nbsp;&nbsp;BIGINT&nbsp;UNSIGNED&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;expiration&nbsp;&nbsp;TIMESTAMP&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(account_id)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">SET&nbsp;@token&nbsp;=&nbsp;MD5(<em class="calibre6">'billkarwin'</em>&nbsp;||&nbsp;CURRENT_TIMESTAMP);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;PasswordResetRequest&nbsp;(token,&nbsp;account_id,&nbsp;expiration)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;VALUES&nbsp;(@token,&nbsp;123,&nbsp;CURRENT_TIMESTAMP&nbsp;+&nbsp;INTERVAL&nbsp;1&nbsp;HOUR);</code></span><br class="calibre1" /></div><p class="calibre_6"> Then you include the token in an email. You could also send the token in some other message, such as SMS, as long as it's an address that's already associated with the account requesting a password reset. That way, if a stranger requests a password reset illicitly, it sends a spurious email only to the actual owner of the account. </p><blockquote class="calibre_9"><div class="calibre1">Example of Email with a Temporary Link to a Password Reset Page</div><div class="calibre1"><div class="calibre_11"><span class="calibre3"><code class="calibre15">From:&nbsp;daemon</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">To:&nbsp;bill@example.com</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">Subject:&nbsp;password&nbsp;reset</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">You&nbsp;requested&nbsp;to&nbsp;reset&nbsp;your&nbsp;password&nbsp;for&nbsp;your&nbsp;account.</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">Click&nbsp;the&nbsp;link&nbsp;below&nbsp;within&nbsp;one&nbsp;hour&nbsp;to&nbsp;change&nbsp;your&nbsp;password.</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">After&nbsp;one&nbsp;hour,&nbsp;the&nbsp;link&nbsp;below&nbsp;will&nbsp;no&nbsp;longer&nbsp;work&nbsp;and&nbsp;your</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">password&nbsp;will&nbsp;remain&nbsp;unchanged.</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">http://www.example.com/reset_password?token=f5cabff22532bd0025118905bdea50da</code></span><br class="calibre1" /></div></div></blockquote><p class="calibre_6"> When the application receives a request for the special <code class="calibre15">reset_password</code> screen, the value in the <code class="calibre15">token</code> parameter must match a row in the <code class="calibre15">PasswordResetRequest</code> table, and the <code class="calibre15">expiration</code> timestamp on this row must still be upcoming, not past. The <code class="calibre15">account_id</code> on this row references the <code class="calibre15">Accounts</code> table, so the token is restricted to enable a password reset of only one specific account. </p><p class="calibre_6"> Of course, it would be harmful if the wrong people could access this page. Simple restrictions reduce this risk, such as giving the special screen a short expiration period and making sure the screen does not show the account for which the password is being set. </p><p class="calibre_6"> The state of cryptography is constantly advancing, trying to stay ahead of attack technology. The techniques in this chapter will improve a great number of typical applications, but if you need to develop very secure systems, you should move on to more advanced techniques such as the following: </p><ul class="calibre_14"><li class="calibre_15"> PBKDF2 (<a href="http://tools.ietf.org/html/rfc2898">http://tools.ietf.org/html/rfc2898</a>) is a widely used <span>key</span><span>strengthening</span> standard. </li><li class="calibre_15"> Bcrypt (<a href="http://bcrypt.sourceforge.net/">http://bcrypt.sourceforge.net/</a>) implements an <span>adaptive</span><span>hashing</span> function. </li></ul><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">If you can read passwords, so can a hacker.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-301" id="calibre_link-159">[20]</a>
<small class="calibre3"> Wireshark (formerly known as Ethereal) is available at <a href="http://www.wireshark.org/">http://www.wireshark.org/</a>. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-302" id="calibre_link-299">[21]</a>
<small class="calibre3">
<a href="http://csrc.nist.gov/groups/ST/toolkit/secure_hashing.html">http://csrc.nist.gov/groups/ST/toolkit/secure_hashing.html</a>
</small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-303" id="calibre_link-300">[22]</a>
<small class="calibre3"> A related, and more sophisticated, technique to recover passwords from their hashes is called a <span>rainbow table</span>. Employing a salt defends against this technique too. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-577"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-26">
<pagebreak>
<a id="calibre_link-578">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-226" class="calibre12"><small class="calibre13">Chapter 21</small><br class="calibre14" />SQL Injection</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> Quote me as saying I was misquoted. </em></p></div><div class="calibre1"><div class="calibre4"><span>Groucho Marx</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> In March 2010, serial computer hacker Albert Gonzalez was convicted for his role in the largest identity theft in history. He acquired an estimated 130&nbsp;million credit and debit card numbers by hacking into ATM machines and payment systems of several major retail store chains and the credit-card processing companies that serve them. </p><p class="calibre_6"> Gonzales broke the previous record, which he also held, for stealing 45.6&nbsp;million credit and debit card numbers in 2006. He performed that earlier crime by exploiting vulnerable wireless networks. </p><p class="calibre_6"> How did Gonzalez nearly triple his own record? We imagine a daring plot from a James Bond movie, with black-clad agents rappelling down elevators shafts, using supercomputers to crack state-of-the-art encrypted passwords, or sabotaging electrical power to an entire city. </p><p class="calibre_6"> The indictment describes a more mundane reality. Gonzalez exploited a vulnerability that is one of the most common security weaknesses on the Internet. He was able to use an attack technique called <span>SQL&nbsp;Injection</span> to gain privileged access to upload files to the corporate victims' servers. After Gonzalez and his coconspirators gained this access, the indictment states:<a href="#calibre_link-27" id="calibre_link-62">[23]</a></p><blockquote class="calibre_9"><div class="calibre1">Executing the Attacks: The Malware</div><div class="calibre1"><p class="calibre_6"> ...they would install "sniffer" programs that would capture credit and debit card numbers, corresponding Card Data, and other information on a real-time basis as the information moved through the Corporate Victims' credit and debit card processing networks, and then periodically transmit that information to the coconspirators. </p></div></blockquote><p class="calibre_6"> The retailers whose websites Gonzalez attacked have said that they've made changes to correct these security holes. However, they've plugged only one hole, while new web applications are created every day that contain other holes. SQL Injection attacks remain an easy target for hackers, because software developers don't understand the nature of the vulnerability or how to write code to prevent it. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-79">
<pagebreak>
<a id="calibre_link-579">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-580">Objective: Write Dynamic SQL Queries</h2><p class="calibre_6"> SQL is intended to be used in concert with application code. When you build SQL queries as strings and combine application variables into the string, this is commonly called <span>dynamic SQL</span>.<a href="#calibre_link-80" id="calibre_link-63">[24]</a></p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/obj/dynamic-sql.php">SQL-Injection/obj/dynamic-sql.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;$bug_id";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query($sql);</code></span><br class="calibre1" /></div><p class="calibre_6"> This simple example shows interpolating a PHP variable into a string. We intend that <code class="calibre15">$bug_id</code> is an integer so that by the time the database receives the query, the value of <code class="calibre15">$bug_id</code> is part of the query. </p><p class="calibre_6"> Dynamic SQL queries are a natural way to get the most out of a database. When you use application data to specify how you want to query a database, you're using SQL as a two-way language. Your application is having a kind of dialogue with the database. </p><p class="calibre_6"> However, it's not too hard to make your software do tasks that you want it to do---the harder challenge is making your software secure so it doesn't allow actions that you don't want it to do. Software defects resulting from SQL Injection are failures to satisfy the latter. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-200">
<pagebreak>
<a id="calibre_link-581">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-582">Antipattern: Execute Unverified Input As Code</h2><p class="calibre_6"> SQL injection happens when you interpolate some content into an SQL query string and the content modifies the syntax of your query in ways you didn't intend. In the classic example of SQL Injection, the value you interpolate into your string finishes the SQL statement and executes a second complete statement. For instance, if the value of the <code class="calibre15">$bug_id</code> variable is <code class="calibre15">1234; DELETE FROM Bugs</code>, the resulting SQL shown earlier would look like this: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/delete.sql">SQL-Injection/anti/delete.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234;&nbsp;DELETE&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /></div><p class="calibre_6"> This type of SQL Injection can be spectacular, as shown in Figure <a href="#calibre_link-201"><em class="calibre6">Exploits of a mom</em></a>.<a href="#calibre_link-202" id="calibre_link-64">[25]</a> Usually these flaws are more subtle---but still dangerous. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="SQL_injection/exploits_of_a_mom.jpg" src="images/000003.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-201" class="calibre10">Figure 1. Exploits of a mom</span></td></tr></table></div><br class="calibre1" /><h3 class="calibre_8">Accidents May Happen</h3><p class="calibre_6"> Suppose you are writing a web interface to view the bugs database and one page allows you to view a project based on its name: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/ohare.php">SQL-Injection/anti/ohare.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$project_name&nbsp;=&nbsp;$_REQUEST["name"];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Projects&nbsp;WHERE&nbsp;project_name&nbsp;=&nbsp;<em class="calibre6">'$project_name'</em>";</code></span><br class="calibre1" /></div><p class="calibre_6"> The trouble begins when your team is hired to develop software for O'Hare International Airport in Chicago. You naturally give the project a name like "O'Hare." How do you submit a request to view the project in your web application? </p><p class="calibre_6"><code class="calibre15">http://bugs.example.com/project/view.php?name=O'Hare</code></p><p class="calibre_6"> Your PHP code takes the value of that request parameter and interpolates it into the SQL query, but it produces a query that neither you nor the user intended: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/ohare.sql">SQL-Injection/anti/ohare.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Projects&nbsp;WHERE&nbsp;project_name&nbsp;=&nbsp;<em class="calibre6">'O'</em>Hare'</code></span><br class="calibre1" /></div><p class="calibre_6"> Because a string is terminated by the first quote character it finds, the resulting expression contains a short string, <code class="calibre15">'O'</code>, followed by some extra characters, <code class="calibre15">Hare'</code>, that make no sense in this context. The database can only report this as a syntax error. This is an honest accident. The risk of anything bad happening is low, because a statement with a syntax error can't execute. The greater risk is that the statement executes without error but does something you didn't intend. </p><h3 class="calibre_8">The Top Web Security Threat</h3><p class="calibre_6"> SQL Injection becomes a greater threat when an attacker can use this to manipulate your SQL statements. For example, your application may allow a user to change his or her password: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/set-password.php">SQL-Injection/anti/set-password.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$password&nbsp;=&nbsp;$_REQUEST["password"];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$userid&nbsp;=&nbsp;$_REQUEST["userid"];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"UPDATE&nbsp;Accounts&nbsp;SET&nbsp;password_hash&nbsp;=&nbsp;SHA2(<em class="calibre6">'$password'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;account_id&nbsp;=&nbsp;$userid";</code></span><br class="calibre1" /></div><p class="calibre_6"> A clever attacker who can guess how the request parameters are used in your SQL statement can send a carefully chosen string to exploit it: </p><p class="calibre_6"><code class="calibre15">http://bugs.example.com/setpass?password=xyzzy&amp;userid=123 OR TRUE</code></p><p class="calibre_6"> After interpolating the string from the <code class="calibre15">userid</code> parameter into your SQL expression, the string has changed the syntax of the statement. Now it changes the password for <em class="calibre6">every</em> account in the database, not for one specific account: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/set-password.sql">SQL-Injection/anti/set-password.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Accounts&nbsp;SET&nbsp;password_hash&nbsp;=&nbsp;SHA2(<em class="calibre6">'xyzzy'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;account_id&nbsp;=&nbsp;123&nbsp;OR&nbsp;TRUE;</code></span><br class="calibre1" /></div><p class="calibre_6"> This is key to understanding SQL Injection and also how to combat it: SQL Injection works by changing the syntax of the SQL statement before the statement is parsed. As long as you insert dynamic portions to the statement before it's parsed, you have a risk of SQL Injection. </p><p class="calibre_6"> There are countless ways a maliciously chosen string can alter the behavior of your SQL statements. It's limited only by the imagination of the attacker and your ability to protect your SQL statements. </p><h3 class="calibre_8">The Quest for a Cure</h3><p class="calibre_6"> Now that we know the threat of SQL Injection, the next natural question is, what do we need to do to protect code from being exploited? You may have read a blog or an article that described some single technique and claimed it's the universal remedy against SQL Injection. In reality, none of these techniques is proof against all forms of SQL Injection, so you need to use all of them in different cases. </p><h4 class="calibre_18">Escaping Values</h4><p class="calibre_6"> The oldest way to protect SQL queries from accidental unmatched quote characters is to <span>escape</span> any quote characters to prevent them from becoming the end of the quoted string. In standard SQL, you can use two quote characters to make one literal quote character: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/ohare-escape.sql">SQL-Injection/anti/ohare-escape.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Projects&nbsp;WHERE&nbsp;project_name&nbsp;=&nbsp;<em class="calibre6">'O''Hare'</em></code></span><br class="calibre1" /></div><p class="calibre_6"> Most brands of database also support the backslash to escape the following quote character, just like most other programming languages do: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/ohare-escape.sql">SQL-Injection/anti/ohare-escape.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Projects&nbsp;WHERE&nbsp;project_name&nbsp;=&nbsp;<em class="calibre6">'O\'Hare'</em></code></span><br class="calibre1" /></div><p class="calibre_6"> The idea is that you transform application data before you interpolate it into SQL strings. Most SQL programming interfaces provide a convenience function. For example, in PHP's PDO extension, use the <code class="calibre15">quote</code> function to both delimit a string with quote characters and escape any literal quote characters within the string. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/ohare-escape.php">SQL-Injection/anti/ohare-escape.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$project_name&nbsp;=&nbsp;$pdo-&gt;quote($_REQUEST["name"]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Projects&nbsp;WHERE&nbsp;project_name&nbsp;=&nbsp;$project_name";</code></span><br class="calibre1" /></div><p class="calibre_6"> This technique can reduce the risk of SQL Injection resulting from unmatched quote characters within the dynamic content. But it doesn't work as well for nonstring content. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/set-password-escape.php">SQL-Injection/anti/set-password-escape.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$password&nbsp;=&nbsp;$pdo-&gt;quote($_REQUEST["password"]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$userid&nbsp;=&nbsp;$pdo-&gt;quote($_REQUEST["userid"]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"UPDATE&nbsp;Accounts&nbsp;SET&nbsp;password_hash&nbsp;=&nbsp;SHA2($password)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;account_id&nbsp;=&nbsp;$userid";</code></span><br class="calibre1" /></div><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/set-password-escape.sql">SQL-Injection/anti/set-password-escape.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Accounts&nbsp;SET&nbsp;password_hash&nbsp;=&nbsp;SHA2(<em class="calibre6">'xyzzy'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;account_id&nbsp;=&nbsp;<em class="calibre6">'123&nbsp;OR&nbsp;TRUE'</em></code></span><br class="calibre1" /></div><p class="calibre_6"> You can't compare a numeric column directly to a string containing digits in all brands of database. Some databases may implicitly cast the string to a sensible numeric equivalent, but in standard SQL you have to use the <code class="calibre15">CAST</code> function deliberately to convert a string to a numeric data type. </p><p class="calibre_6"> There are also obscure corner cases where strings in non-ASCII character sets can pass through a function intended to escape the quote characters but leave unescaped quote characters intact.<a href="#calibre_link-203" id="calibre_link-65">[26]</a></p><h4 class="calibre_18">Query Parameters</h4><p class="calibre_6"> The solution most frequently cited as a panacea to SQL Injection is to use <span>query parameters</span>. Instead of interpolating dynamic values into your SQL string, leave <span>parameter placeholders</span> in the string as you prepare the query. Then provide a parameter value as you execute the prepared query. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/parameter.php">SQL-Injection/anti/parameter.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare("SELECT&nbsp;*&nbsp;FROM&nbsp;Projects&nbsp;WHERE&nbsp;project_name&nbsp;=&nbsp;?");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$params&nbsp;=&nbsp;<span class="calibre10">array</span>($_REQUEST["name"]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt-&gt;execute($params);</code></span><br class="calibre1" /></div><p class="calibre_6"> Many programmers recommend this solution because you don't have to escape dynamic content or worry about flawed escaping functions. In fact, query parameters are a very strong defense against SQL Injection. But parameters aren't a universal solution because the value of a query parameter is always interpreted as a single literal value. </p><ul class="calibre_14"><li class="calibre_15"> No lists of values can be a single parameter: <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/parameter.php">SQL-Injection/anti/parameter.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare("SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;bug_id&nbsp;IN&nbsp;(&nbsp;?&nbsp;)");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt-&gt;execute(<span class="calibre10">array</span>("1234,3456,5678"));</code></span><br class="calibre1" /></div><br class="calibre_16" /> This works as though you provided a single string value composed of digits and commas, which doesn't work the same as a series of integers: <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/parameter.sql">SQL-Injection/anti/parameter.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;bug_id&nbsp;IN&nbsp;(&nbsp;<em class="calibre6">'1234,3456,5678'</em>&nbsp;)</code></span><br class="calibre1" /></div></li><li class="calibre_15"> No table identifier can be a parameter: <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/parameter.php">SQL-Injection/anti/parameter.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare("SELECT&nbsp;*&nbsp;FROM&nbsp;?&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt-&gt;execute(<span class="calibre10">array</span>("Bugs"));</code></span><br class="calibre1" /></div><br class="calibre_16" /> This works as though you had entered a string literal in place of the table name, which is simply a syntax error: <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/parameter.sql">SQL-Injection/anti/parameter.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;<em class="calibre6">'Bugs'</em>&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;1234</code></span><br class="calibre1" /></div></li><li class="calibre_15"> No column identifier can be a parameter: <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/parameter.php">SQL-Injection/anti/parameter.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare("SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;ORDER&nbsp;BY&nbsp;?");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt-&gt;execute(<span class="calibre10">array</span>("date_reported"));</code></span><br class="calibre1" /></div><br class="calibre_16" /> In this example, the sort is a no-op, because the expression is a constant string, the same on every row: <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/parameter.sql">SQL-Injection/anti/parameter.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;ORDER&nbsp;BY&nbsp;<em class="calibre6">'date_reported'</em>;</code></span><br class="calibre1" /></div></li><li class="calibre_15"> No SQL keyword can be a parameter: <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/parameter.php">SQL-Injection/anti/parameter.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare("SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;ORDER&nbsp;BY&nbsp;date_reported&nbsp;?");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt-&gt;execute(<span class="calibre10">array</span>("DESC"));</code></span><br class="calibre1" /></div><br class="calibre_16" /> The parameter is interpreted as a literal string, not an SQL keyword. In this example, the result is a syntax error. <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/parameter.sql">SQL-Injection/anti/parameter.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;ORDER&nbsp;BY&nbsp;date_reported&nbsp;<em class="calibre6">'DESC'</em></code></span><br class="calibre1" /></div></li></ul><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">What Was My Complete Query?</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Many people think that using SQL query parameters is a way to quote values into an SQL statement automatically. This isn't accurate, and thinking about query parameters this way leads to misunderstanding about how they work. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The RDBMS server parses your SQL as you <span>prepare</span> the query. After this, nothing can change the syntax of that SQL query. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> You provide values as you <span>execute</span> a prepared query. Each value you provide is used for each placeholder, one for one. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> You can execute a prepared query again, substituting new parameter values for the old values. So, the RDBMS must keep track of the query and the parameter values separately. This is good for security. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> This means that if you retrieve the prepared SQL query string, it doesn't contain any parameter values. It would be handy to see the SQL statement including parameter values if you're debugging or logging queries, but these values are never combined with the query in its human-readable SQL form. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The best way to debug your dynamic SQL statements is to log both the statement with parameter placeholders at prepare time and the parameter values at execute time. </blockquote></small></p></div><hr class="calibre7" /></div><h4 class="calibre_18">Stored Procedures</h4><p class="calibre_6"> Use of stored procedures is another method that many software developers claim is proof against SQL Injection vulnerabilities. Typically, stored procedures contain fixed SQL statements, parsed when you define the procedure. </p><p class="calibre_6"> However, it's possible to use dynamic SQL in stored procedures unsafely. In the following example, the <code class="calibre15">input_userid</code> argument is interpolated into the SQL query verbatim, which is unsafe. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/procedure.sql">SQL-Injection/anti/procedure.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;PROCEDURE&nbsp;UpdatePassword(input_password&nbsp;VARCHAR(20),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;input_userid&nbsp;VARCHAR(20))</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">BEGIN</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;SET&nbsp;@sql&nbsp;=&nbsp;CONCAT('UPDATE&nbsp;Accounts</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;SET&nbsp;password_hash&nbsp;=&nbsp;SHA2(<em class="calibre6">',&nbsp;QUOTE(input_password),&nbsp;'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;account_id&nbsp;=&nbsp;',&nbsp;input_userid);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PREPARE&nbsp;stmt&nbsp;FROM&nbsp;@sql;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;EXECUTE&nbsp;stmt;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">END</code></span><br class="calibre1" /></div><p class="calibre_6"> Using dynamic SQL in a stored procedure is no more and no less safe than using dynamic SQL in application code. The <code class="calibre15">input_userid</code> argument can contain harmful content and produce an unsafe SQL statement: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/anti/set-password.sql">SQL-Injection/anti/set-password.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Accounts&nbsp;SET&nbsp;password_hash&nbsp;=&nbsp;SHA2(<em class="calibre6">'xyzzy'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;account_id&nbsp;=&nbsp;123&nbsp;OR&nbsp;TRUE;</code></span><br class="calibre1" /></div><h4 class="calibre_18">Data Access Frameworks</h4><p class="calibre_6"> You might see advocates of data access frameworks claim that their library protects your code from SQL Injection risks. This is a false claim for any framework that allows you to write SQL statements as strings. </p><blockquote class="calibre_9"><div class="calibre1">Practice Good Hygiene</div><div class="calibre1"><p class="calibre_6"> After I gave a presentation on a PHP data access framework that I had developed, a member of the audience approached me and asked, "Does your framework prevent SQL Injection?" I answered that it provides functions for quoting strings and using query parameters. </p><p class="calibre_6"> The young man looked puzzled. "But can it prevent SQL Injection?" he repeated. He was looking for an automatic way to ensure that he doesn't make a mistake that he doesn't know how to recognize himself. </p><p class="calibre_6"> I told him the framework prevents SQL Injection like a toothbrush prevents cavities. You have to use it consistently to get the benefit. </p></div></blockquote><p class="calibre_6"> No framework can force you to write safe SQL code. A framework may provide convenience functions to help you, but it's easy to bypass these functions and instead use common string manipulation to build an SQL statement unsafely. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-287">
<pagebreak>
<a id="calibre_link-583">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-584">How to Recognize the Antipattern</h2><p class="calibre_6"> Practically every database application builds SQL statements dynamically. If you build any portion of an SQL statement by concatenating strings together or interpolating variables into strings, then the statement potentially exposes your application to SQL Injection attacks. </p><p class="calibre_6"> SQL Injection vulnerabilities are so common that you should assume that you have some in any application that uses SQL, unless you've just completed a code review specifically to find and correct these issues. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-10">
<pagebreak>
<a id="calibre_link-585">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-586">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> This antipattern is different from most of the others in this book, in that there aren't any legitimate reasons for allowing your application to have a security vulnerability because of SQL Injection. It's your responsibility as a software developer to write code defensively and to help your peers to do so as well. Software is only as secure as its weakest link---make sure you're not responsible for that weakest link! </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Rule #31: Check the Back Seat</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> If you like to watch monster movies, you know that creatures like to hide behind the driver seat of your car and grab you after you get in. The lesson is that you shouldn't assume there's no danger inside a familiar space like your car. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> SQL Injection can take indirect forms. Even if you insert user-supplied data safely using query parameters, you might use that data later as you form dynamic SQL queries: </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql1&nbsp;=&nbsp;<em class="calibre6">"SELECT&nbsp;last_name&nbsp;FROM&nbsp;Accounts&nbsp;WHERE&nbsp;account_id&nbsp;=&nbsp;123"</em>;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$row&nbsp;=&nbsp;$pdo-&gt;query($sql1)-&gt;fetch();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql2&nbsp;=&nbsp;<em class="calibre6">"SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;MATCH(description)&nbsp;AGAINST&nbsp;('"</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;.&nbsp;$row[<em class="calibre6">"last_name"</em>]&nbsp;.&nbsp;&nbsp;<em class="calibre6">"')"</em>;</code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> What would happen in the previous query if the user had spelled their name as <em class="calibre6">O'Hara</em>---or if they had deliberately entered their name to contain SQL syntax? </blockquote></small></p></div><hr class="calibre7" /></div></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-61">
<pagebreak>
<a id="calibre_link-587">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-588">Solution: Trust No One</h2><p class="calibre_6"> There is no single technique for securing your SQL code. You should learn all of the following techniques and use them in appropriate cases. </p><h3 class="calibre_8">Filter Input</h3><p class="calibre_6"> Instead of wondering whether some input contains harmful content, you should strip away any characters that aren't valid for that input. That is, if you need an integer, use only the part of the content that comprises an integer. The best way to do this depends on your programming language; for example, in PHP, use the <code class="calibre15">filter</code> extension: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/soln/filter.php">SQL-Injection/soln/filter.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$bugid&nbsp;=&nbsp;filter_input(INPUT_GET,&nbsp;"bugid",&nbsp;FILTER_SANITIZE_NUMBER_INT);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;{$bugid}";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query($sql);</code></span><br class="calibre1" /></div><p class="calibre_6"> You can use type casting functions for simple cases like numbers: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/soln/casting.php">SQL-Injection/soln/casting.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$bugid&nbsp;=&nbsp;intval($_GET["bugid"]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;{$bugid}";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query($sql);</code></span><br class="calibre1" /></div><p class="calibre_6"> You can also use regular expressions to match safe substrings, filtering out illegitimate content: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/soln/regexp.php">SQL-Injection/soln/regexp.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sortorder&nbsp;=&nbsp;"date_reported";&nbsp;//&nbsp;<span class="calibre10">default</span></code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">if</span>&nbsp;(preg_match("/[_[:alnum:]]+/",&nbsp;$_GET["order"],&nbsp;$matches))&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;$sortorder&nbsp;=&nbsp;$matches[1];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;ORDER&nbsp;BY&nbsp;{$sortorder}";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query($sql);</code></span><br class="calibre1" /></div><h3 class="calibre_8">Parameterize Dynamic Values</h3><p class="calibre_6"> When the dynamic parts of your query are simple values, you should use query parameters to separate them from SQL expressions. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/soln/parameter.php">SQL-Injection/soln/parameter.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"UPDATE&nbsp;Accounts&nbsp;SET&nbsp;password_hash&nbsp;=&nbsp;SHA2(?)&nbsp;WHERE&nbsp;account_id&nbsp;=&nbsp;?";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare($sql);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$params&nbsp;=&nbsp;<span class="calibre10">array</span>($_REQUEST["password"],&nbsp;$_REQUEST["userid"]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt-&gt;execute($params);</code></span><br class="calibre1" /></div><p class="calibre_6"> We saw examples in the "Antipattern" section that a parameter can substitute only for a single value. If you add the parameter values after the RDBMS parses the SQL statement, no SQL Injection attack can change the syntax of a parameterized query. Even if an attacker tries to use a malicious parameter value such as <code class="calibre15">123&nbsp;OR&nbsp;TRUE</code>, the RDBMS interprets the parameter as a value. At worst, the query fails to apply to any rows; it's not likely to apply to the wrong rows. The malicious value would result in a relatively safe SQL statement equivalent to the following: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/soln/parameter.sql">SQL-Injection/soln/parameter.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Accounts&nbsp;SET&nbsp;password_hash&nbsp;=&nbsp;SHA2(<em class="calibre6">'xyzzy'</em>)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;account_id&nbsp;=&nbsp;<em class="calibre6">'123&nbsp;OR&nbsp;TRUE'</em></code></span><br class="calibre1" /></div><p class="calibre_6"> You should use query parameters when you need to combine application variables as literal values in SQL expressions. </p><h3 class="calibre_8">Quoting Dynamic Values</h3><p class="calibre_6"> Query parameters are usually the best solution, but in rare cases a query with parameter placeholders causes the query optimizer to make odd decisions about which indexes to use. </p><p class="calibre_6"> For example, suppose you have a column in the <code class="calibre15">Accounts</code> table called <code class="calibre15">is_active</code>. This column stores a true value for 99 percent of the rows, giving it an uneven distribution of values. A query that searches for <code class="calibre15">is_active = false</code> would benefit from an index, but it would be a waste to read the index for a query searching for <code class="calibre15">is_active = true</code>. However, if you used a parameter in the expression <code class="calibre15">is_active = ?</code>, the optimizer can't know which value you will supply when you execute the prepared query, so it's liable to choose the wrong optimization plan. </p><p class="calibre_6"> In exotic cases like this, it could be better to interpolate values directly into the SQL statement, in spite of the general recommendation to use query parameters. If you do this, you should quote the strings carefully. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/soln/interpolate.php">SQL-Injection/soln/interpolate.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$quoted_active&nbsp;=&nbsp;$pdo-&gt;quote($_REQUEST["active"]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Accounts&nbsp;WHERE&nbsp;is_active&nbsp;=&nbsp;{$quoted_active}";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query($sql);</code></span><br class="calibre1" /></div><p class="calibre_6"> Make sure you use a function that is mature and well-tested against obscure SQL security issues. Most data access libraries include such a string-quoting function. For example, in PHP, use <code class="calibre15">PDO::quote</code>. Don't try to implement your own quoting function unless you have studied the security risks thoroughly. </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Parameterizing an IN() Predicate</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> We've seen that you can't pass a comma-separated string in a single parameter. You need as many parameters as the number of items in your list. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> For example, say you need to query six bugs by their primary keys, which you have in an array variable <code class="calibre15">$bug_list</code>: </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;bug_id&nbsp;IN&nbsp;(?,&nbsp;?,&nbsp;?,&nbsp;?,&nbsp;?,&nbsp;?)");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare($sql);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt-&gt;execute($bug_list);</code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> This works only if you have exactly six items in <code class="calibre15">$bug_list</code>, matching the number of parameter placeholders. You should build the SQL <code class="calibre15">IN</code> predicate dynamically, using a number of placeholders equal to the number of items in <code class="calibre15">$bug_list</code>. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The following example in PHP uses some built-in array functions to produce an array of placeholders the same length as <code class="calibre15">$bug_list</code> and then joins that array with comma separators before interpolating it into the SQL expression. </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;WHERE&nbsp;bug_id&nbsp;IN&nbsp;("</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;join(",",&nbsp;array_fill(0,&nbsp;count($bug_list),&nbsp;"?"))&nbsp;.&nbsp;")";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare($sql);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt-&gt;execute($bug_list);</code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Use this technique to parameterize a list of values. </blockquote></small></p></div><hr class="calibre7" /></div><h3 class="calibre_8">Isolate User Input from Code</h3><p class="calibre_6"> Query parameters and escaping techniques help you combine literal values into SQL expressions, but they don't help with other parts of a statement, such as table or column identifiers or SQL keywords. You need another solution to make these parts of a query dynamic. </p><p class="calibre_6"> Suppose your users want to choose how to sort lists of bugs, for instance by status or by date created. They also want to choose the direction of sorting. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/soln/orderby.sql">SQL-Injection/soln/orderby.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;ORDER&nbsp;BY&nbsp;status&nbsp;ASC</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;ORDER&nbsp;BY&nbsp;date_reported&nbsp;DESC</code></span><br class="calibre1" /></div><p class="calibre_6"> In the following example, a PHP script accepts request parameters <code class="calibre15">order</code> and <code class="calibre15">dir</code>, and your code interpolates these user choices into the SQL query to be a column name and a keyword. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/soln/mapping.php">SQL-Injection/soln/mapping.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sortorder&nbsp;=&nbsp;$_REQUEST["order"];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$direction&nbsp;=&nbsp;$_REQUEST["dir"];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;ORDER&nbsp;BY&nbsp;$sortorder&nbsp;$direction";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query($sql);</code></span><br class="calibre1" /></div><p class="calibre_6"> The script assumes that <code class="calibre15">order</code> contains the name of a column and that <code class="calibre15">dir</code> contains either <code class="calibre15">ASC</code> or <code class="calibre15">DESC</code>. This is not a safe assumption, because a user can send any parameter values in a web request. </p><p class="calibre_6"> Instead, you can use the request parameters to look up predefined values and then use these values in your SQL query. </p><ol class="calibre22"><li value="1" class="calibre_15"> Declare a <code class="calibre15">$sortorders</code> array that maps user choices as keys and SQL column names as values. Declare a <code class="calibre15">$directions</code> array that maps user choices as keys and SQL keywords <code class="calibre15">ASC</code> and <code class="calibre15">DESC</code> as values. <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/soln/mapping.php">SQL-Injection/soln/mapping.php</a></span></span></div><span class="calibre3"><code class="calibre15">$sortorders&nbsp;=&nbsp;<span class="calibre10">array</span>(&nbsp;"status"&nbsp;=&gt;&nbsp;"status",&nbsp;"date"&nbsp;=&gt;&nbsp;"date_reported"&nbsp;);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$directions&nbsp;=&nbsp;<span class="calibre10">array</span>(&nbsp;"up"&nbsp;=&gt;&nbsp;"ASC",&nbsp;"down"&nbsp;=&gt;&nbsp;"DESC"&nbsp;);</code></span><br class="calibre1" /></div></li><li value="2" class="calibre_15"> Set variables <code class="calibre15">$sortorder</code> and <code class="calibre15">$dir</code> to default values in case the user's choices aren't in the arrays. <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/soln/mapping.php">SQL-Injection/soln/mapping.php</a></span></span></div><span class="calibre3"><code class="calibre15">$sortorder&nbsp;=&nbsp;"bug_id";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$direction&nbsp;=&nbsp;"ASC";</code></span><br class="calibre1" /></div></li><li value="3" class="calibre_15"> If the user's choices match array keys you declared in <code class="calibre15">$sortorders</code> and <code class="calibre15">$directions</code>, use the corresponding values. <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/soln/mapping.php">SQL-Injection/soln/mapping.php</a></span></span></div><span class="calibre3"><code class="calibre15"><span class="calibre10">if</span>&nbsp;(array_key_exists($_REQUEST["order"],&nbsp;$sortorders))&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;$sortorder&nbsp;=&nbsp;$sortorders[&nbsp;$_REQUEST["order"]&nbsp;];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">if</span>&nbsp;(array_key_exists($_REQUEST["dir"],&nbsp;$directions))&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;$direction&nbsp;=&nbsp;$directions[&nbsp;$_REQUEST["dir"]&nbsp;];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /></div></li><li value="4" class="calibre_15"> Now it's safe to use the <code class="calibre15">$sortorder</code> and <code class="calibre15">$direction</code> variables in your SQL query, because they can contain only values you declared in your code. <div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/SQL-Injection/soln/mapping.php">SQL-Injection/soln/mapping.php</a></span></span></div><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs&nbsp;ORDER&nbsp;BY&nbsp;{$sortorder}&nbsp;{$direction}";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;query($sql);</code></span><br class="calibre1" /></div></li></ol><p class="calibre_6"> Using this technique has several advantages: </p><ul class="calibre_14"><li class="calibre_15"> You never combine user input with your SQL query, so you reduce the risk of SQL Injection. </li><li class="calibre_15"> You can make any part of an SQL statement dynamic, including identifiers, SQL keywords, and even entire expressions. </li><li class="calibre_15"> You have an easy and efficient way to validate user choices. </li><li class="calibre_15"> You decouple the internal details of your database queries from the user interface. </li></ul><p class="calibre_6"> The choices are hard-coded in your application, but this is appropriate for table names, column names, and SQL keywords. Choices over the full range of strings or numbers are typical for data values, but not for identifiers or syntax. </p><h3 class="calibre_8">Get a Buddy to Review Your Code</h3><p class="calibre_6"> The best way to catch flaws is to get another pair of eyes to look at it. Ask a teammate who is familiar with SQL Injection risks to help you inspect your code. Don't let pride or ego keep you from doing the right thing---you may be embarrassed now over missing a coding mistake, but would you rather have to admit responsibility later for a security flaw that allowed hackers to exploit your website? </p><p class="calibre_6"> In an inspection for SQL Injection, use the following guidelines: </p><ol class="calibre22"><li value="1" class="calibre_15"> Find SQL statements that are formed using application variables, string concatenation, or replacement. </li><li value="2" class="calibre_15"> Trace the origin of all dynamic content used in your SQL statements. Find any data that comes from an external source, such as user input, files, environment, web services, third-party code, or even a string fetched from the database. </li><li value="3" class="calibre_15"> Assume any external content is potentially hazardous. Use filters, validators, and mapping arrays to transform untrusted content. </li><li value="4" class="calibre_15"> Combine external data into your SQL statements using query parameters or robust escaping functions. </li><li value="5" class="calibre_15"> Don't forget to inspect your stored procedures and other places where you may find dynamic SQL statements. </li></ol><p class="calibre_6"> Code inspection is the most accurate and economical way to find SQL Injection flaws. You should budget your time for this and treat it as a mandatory activity. You can also return the favor by inspecting your teammates' code. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Let users input values, but never let users input code.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-62" id="calibre_link-27">[23]</a>
<small class="calibre3">
<a href="http://voices.washingtonpost.com/securityfix/heartlandIndictment.pdf">http://voices.washingtonpost.com/securityfix/heartlandIndictment.pdf</a>
</small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-63" id="calibre_link-80">[24]</a>
<small class="calibre3"> Technically, any query parsed at runtime is dynamic SQL, but in common usage, it describes SQL that includes variable data. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-64" id="calibre_link-202">[25]</a>
<small class="calibre3"> Cartoon by Randall Munroe, used with permission (<a href="http://xkcd.com/327/">http://xkcd.com/327/</a>). </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-65" id="calibre_link-203">[26]</a>
<small class="calibre3"> See <a href="http://bugs.mysql.com/8378">http://bugs.mysql.com/8378</a> for an example. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-589"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-106">
<pagebreak>
<a id="calibre_link-590">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-186" class="calibre12"><small class="calibre13">Chapter 22</small><br class="calibre14" />Pseudokey Neat-Freak</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> Those who matter don't mind, and those who mind don't matter. </em></p></div><div class="calibre1"><div class="calibre4"><span>Bernard Baruch (on seating arrangements for his dinner party guests)</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> Your manager approaches you, holding two report printouts. "The bean counters are saying we have discrepancies between this quarter's report and last quarter's. I'm looking at them, and they're absolutely right. Most of the later assets have disappeared. What happened?" </p><p class="calibre_6"> You look at the reports, and the pattern of discrepancies rings a bell. "No, everything is still there. You asked me to clean up the rows in the database so there are no missing rows. You said the accountants kept asking you questions about missing assets, because of gaps in the numbering. </p><p class="calibre_6"> "So, I renumbered some of the rows to make them all fit into the places where there were missing rows before. There aren't any missing rows now---every number between 1 and about 12,340 is used. They're all still there, but some have just changed number and moved up. You told me to do this." </p><p class="calibre_6"> Your manager shakes his head. "But that's not what I want. The accountants have to track depreciation by the asset numbers. The number for each piece of equipment has to stay the same in each quarterly report. Besides, all the asset ID numbers are printed on labels on each piece. It'd take weeks to relabel everything in the company. Can you please change all the ID numbers back to their original values?" </p><p class="calibre_6"> You want to be cooperative, so you turn back to your keyboard to start working, but suddenly you think of a new problem. "What about new assets we bought this month, after I consolidated the asset IDs? The new assets have been assigned ID values that were in use before I did the renumbering. If I change the asset IDs back to their old values, what should I do about the duplicates?" </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-173">
<pagebreak>
<a id="calibre_link-591">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-592">Objective: Tidy Up the Data</h2><p class="calibre_6"> There's a certain type of person who is unnerved by a gap in a series of numbers. </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">bug_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">status</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">product_name</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">OPEN</p></td><td class="calibre19"><p class="calibre_6">Open RoundFile</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">FIXED</p></td><td class="calibre19"><p class="calibre_6">ReConsider</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6">OPEN</p></td><td class="calibre19"><p class="calibre_6">ReConsider</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> On one hand, it's understandable to be concerned, because it's unclear what happened to the row with <code class="calibre15">bug_id</code> 3. Why didn't the query return that bug? Did the database lose it? What was in that bug? Was the bug reported by one of our important customers? Am I going to be held responsible for the lost data? </p><p class="calibre_6"> The objective of one who practices the <span>Pseudokey Neat-Freak</span> antipattern is to resolve these troubling questions. This person is accountable for data integrity issues, but typically they don't have enough understanding of or confidence in the database technology to feel confident of the generated report results. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-257">
<pagebreak>
<a id="calibre_link-593">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-594">Antipattern: Filling in the Corners</h2><p class="calibre_6"> Most people's first reaction to a perceived gap is naturally to want to seal the gap. There are two ways you might do this. </p><h3 class="calibre_8">Assigning Numbers Out of Sequence</h3><p class="calibre_6"> Instead of allocating a new primary key value using the automatic pseudokey mechanism, you might want to make any new row use the first unused primary key value. This way, as you insert data, you naturally make gaps fill in. </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">bug_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">status</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">product_name</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">OPEN</p></td><td class="calibre19"><p class="calibre_6">Open RoundFile</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">FIXED</p></td><td class="calibre19"><p class="calibre_6">ReConsider</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">4</p></td><td class="calibre19"><p class="calibre_6">OPEN</p></td><td class="calibre19"><p class="calibre_6">ReConsider</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">3</p></td><td class="calibre19"><p class="calibre_6">NEW</p></td><td class="calibre19"><p class="calibre_6">Visual TurboBuilder</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> However, you have to run an unnecessary self-join query to find the lowest unused value: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Neat-Freak/anti/lowest-value.sql">Neat-Freak/anti/lowest-value.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;b1.bug_id&nbsp;+&nbsp;1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">FROM&nbsp;Bugs&nbsp;b1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">LEFT&nbsp;OUTER&nbsp;JOIN&nbsp;Bugs&nbsp;AS&nbsp;b2&nbsp;ON&nbsp;(b1.bug_id&nbsp;+&nbsp;1&nbsp;=&nbsp;b2.bug_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;b2.bug_id&nbsp;IS&nbsp;NULL</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">ORDER&nbsp;BY&nbsp;b1.bug_id&nbsp;LIMIT&nbsp;1;</code></span><br class="calibre1" /></div><p class="calibre_6"> Earlier in the book, we looked at a concurrency issue when you try to allocate a unique primary key value by running a query such as <code class="calibre15">SELECT MAX(bug_id)+1 FROM Bugs</code>.<a href="#calibre_link-258" id="calibre_link-94">[27]</a> This has the same flaw when two applications may try to find the lowest unused value at the same time. As both try to use the same value as a primary key value, one succeeds, and the other gets an error. This method is both inefficient and prone to errors. </p><h3 class="calibre_8">Renumbering Existing Rows</h3><p class="calibre_6"> You might find it's more urgent to make the primary key values be contiguous, and waiting for new rows to fill in the gaps won't fix the issue quickly enough. You might think to use a strategy of updating the key values of existing rows to eliminate gaps and make all the values contiguous. This usually means you find the row with the highest primary key value and update it with the lowest unused value. For example, you could update the value <code class="calibre15">4</code> to <code class="calibre15">3</code>: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Neat-Freak/anti/renumber.sql">Neat-Freak/anti/renumber.sql</a></span></span></div><span class="calibre3"><code class="calibre15">UPDATE&nbsp;Bugs&nbsp;SET&nbsp;bug_id&nbsp;=&nbsp;3&nbsp;WHERE&nbsp;bug_id&nbsp;=&nbsp;4;</code></span><br class="calibre1" /></div><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">bug_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">status</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">product_name</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">1</p></td><td class="calibre19"><p class="calibre_6">NEW</p></td><td class="calibre19"><p class="calibre_6">Open RoundFile</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">2</p></td><td class="calibre19"><p class="calibre_6">FIXED</p></td><td class="calibre19"><p class="calibre_6">ReConsider</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">3</em></p></td><td class="calibre19"><p class="calibre_6">DUPLICATE</p></td><td class="calibre19"><p class="calibre_6">ReConsider</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> To accomplish this, you need to find an unused key value using a method similar to the previous one for inserting new rows. You also need to run the <code class="calibre15">UPDATE</code> statement to reassign the primary key value. Either one of these steps is susceptible to concurrency issues. You need to repeat the steps many times to fill a wide gap in the numbers. </p><p class="calibre_6"> You must also propagate the changed value to all child records that reference the rows you renumber. This is easiest if you declared foreign keys with the <code class="calibre15">ON UPDATE CASCADE</code> option, but if you didn't, you would have to disable constraints, update all child records manually, and restore the constraints. This is a laborious, error-prone process that can interrupt service in your database, so if you feel you want to avoid it, you're right. </p><p class="calibre_6"> Even if you do accomplish this cleanup, it's short-lived. When a pseudokey generates a new value, the value is greater than the last value it generated (even if the row with that value has since been deleted or changed), <em class="calibre6">not</em> the highest value currently in the table, as some database programmers assume. Suppose you update the row with the greatest <code class="calibre15">bug_id</code> value <code class="calibre15">4</code> to the lower unused value to fill a gap. The next row you insert using the default pseudokey generator will allocate <code class="calibre15">5</code>, leaving a new gap at <code class="calibre15">4</code>. </p><h3 class="calibre_8">Manufacturing Data Discrepancies</h3><p class="calibre_6"> Mitch Ratcliffe said, "A computer lets you make more mistakes faster than any other human invention in human history…with the possible exception of handguns and tequila."<a href="#calibre_link-259" id="calibre_link-96">[28]</a></p><p class="calibre_6"> The story at the beginning of this chapter describes some hazards of renumbering primary key values. If another system external to your database depends on identifying rows by their primary keys, then your updates invalidate the data references in that system. </p><p class="calibre_6"> It's not a good idea to reuse the row's primary key value, because a gap could be the result of deleting or rolling back a row for a good reason. For example, suppose a user with <code class="calibre15">account_id</code> 789 is barred from your system for sending offensive emails. Your policies require you to delete the offender's account, but if you recycle primary keys, you would subsequently assign 789 to another user. Since some offensive emails are still waiting to be read by some recipients, you could get further complaints about <em class="calibre6">account 789</em>. Through no fault of his own, the poor user who now has that number catches the blame. </p><p class="calibre_6"> Don't reallocate pseudokey values just because they seem to be unused. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-317">
<pagebreak>
<a id="calibre_link-595">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-596">How to Recognize the Antipattern</h2><p class="calibre_6"> The following quotes can be hints that someone in your organization is about to use the Pseudokey Neat-Freak antipattern. </p><ul class="calibre_14"><li class="calibre_15"> "How can I reuse an autogenerated identity value after I roll back an insert?" <br class="calibre_16" /> Pseudokey allocation doesn't roll back; if it did, the RDBMS would have to allocate pseudokey values within the scope of a transaction. This would cause either race conditions or blocking when multiple clients are inserting data concurrently. </li><li class="calibre_15"> "What happened to <code class="calibre15">bug_id</code> 4?" <br class="calibre_16" /> This is an expression of misplaced anxiety over unused numbers in the sequence of primary keys. </li><li class="calibre_15"> "How can I query for the first unused ID?" <br class="calibre_16" /> The reason to do this search is almost certainly to reassign the ID. </li><li class="calibre_15"> "What if I run out of numbers?" <br class="calibre_16" /> This is used as a justification for reallocating unused ID values. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-44">
<pagebreak>
<a id="calibre_link-597">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-598">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> There's no reason to change the value of a pseudokey, since the value should have no significance anyway. If the values in the primary key column carry some meaning, then this column is a <span>natural key</span>, not a pseudokey. It's not unusual to change values in a natural key. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-93">
<pagebreak>
<a id="calibre_link-599">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-600">Solution: Get Over It</h2><p class="calibre_6"> The values in any primary key must be unique and non-null so you can use them to reference individual rows, but that's the only rule---they don't have to be consecutive numbers to identify rows. </p><h3 class="calibre_8">Numbering Rows</h3><p class="calibre_6"> Most pseudokey generators return numbers that look almost like row numbers, because they're <span>monotonically increasing</span> (that is, each successive value is one greater than the preceding value), but this is only a coincidence of their implementation. Generating values in this way is a convenient way to ensure uniqueness. </p><p class="calibre_6"> Don't confuse row numbers with primary keys. A primary key identifies one row in one table, whereas row numbers identify rows in a result set. Row numbers in a query result set don't correspond to primary key values in the table, especially when you use query operations like <code class="calibre15">JOIN</code>, <code class="calibre15">GROUP&nbsp;BY</code>, or <code class="calibre15">ORDER&nbsp;BY</code>. </p><p class="calibre_6"> There are good reasons to use row numbers, for example to return a subset of rows from a query result. This is often called <span>pagination</span>, like a page of an Internet search. To select a subset in this way, you need to use true row numbers that are increasing and consecutive, regardless of the form of the query. </p><p class="calibre_6"> SQL:2003 specifies <span>window functions</span> including <code class="calibre15">ROW_NUMBER</code>, which returns consecutive numbers specific to a query result set. A common use of row numbering is to limit the query result to a range of rows: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Neat-Freak/soln/row_number.sql">Neat-Freak/soln/row_number.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;t1.*&nbsp;FROM</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;(SELECT&nbsp;a.account_name,&nbsp;b.bug_id,&nbsp;b.summary,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROW_NUMBER()&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;a.account_name,&nbsp;b.date_reported)&nbsp;AS&nbsp;rn</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;FROM&nbsp;Accounts&nbsp;a&nbsp;JOIN&nbsp;Bugs&nbsp;b&nbsp;ON&nbsp;(a.account_id&nbsp;=&nbsp;b.reported_by))&nbsp;AS&nbsp;t1</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">WHERE&nbsp;t1.rn&nbsp;BETWEEN&nbsp;51&nbsp;AND&nbsp;100;</code></span><br class="calibre1" /></div><p class="calibre_6"> These functions are currently supported by many leading brands of database, including Oracle, Microsoft SQL Server&nbsp;2005, IBM DB2, PostgreSQL&nbsp;8.4, and Apache Derby. </p><p class="calibre_6"> MySQL, SQLite, Firebird, and Informix don't support SQL:2003 window functions, but they have proprietary syntax you can use in the scenario presented in this section. MySQL and SQLite support a <code class="calibre15">LIMIT</code> clause, and Firebird and Informix support a query option with keywords <code class="calibre15">FIRST</code> and <code class="calibre15">SKIP</code>. </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Are Integers a Nonrenewable Resource?</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Another misconception related to the Pseudokey Neat-Freak antipattern is the idea that a monotonically increasing pseudokey generator eventually exhausts the set of integers, so you must take precautions not to waste values. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> At first glance, this seems sensible. In mathematics, the set of integers is countably infinite, but in a database, any data type has a finite number of values. A 32-bit integer can represent a maximum of 2<small class="calibre5">^32</small> distinct values. It's true that each time you allocate a value for a primary key, you're one step closer to the last one. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> But do the math: if you generate unique primary key values as you insert 1,000 rows per second, 24 hours per day, you can continue for 136 years before you use all values in an unsigned 32-bit integer. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> If that doesn't meet your needs, then use a 64-bit integer. Now you can use <em class="calibre6">1 million</em> integers per second continuously for 584,542 years. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> It's very unlikely that you will run out of integers! </blockquote></small></p></div><hr class="calibre7" /></div><h3 class="calibre_8">Using GUIDs</h3><p class="calibre_6"> You could also generate random pseudokey values, as long as you don't use any number more than once. Some databases support a <span>globally unique identifier</span> (GUID) for this purpose. </p><p class="calibre_6"> A GUID is a pseudorandom number of 128 bits (usually represented by 32 hexadecimal digits). For practical purposes, a GUID is unique, so you can use it to generate a pseudokey. </p><p class="calibre_6"> The following example uses Microsoft SQL Server 2005 syntax: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Neat-Freak/soln/uniqueidentifier-sql2005.sql">Neat-Freak/soln/uniqueidentifier-sql2005.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;UNIQUEIDENTIFIER&nbsp;DEFAULT&nbsp;NEWID(),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;.&nbsp;.&nbsp;.</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">INSERT&nbsp;INTO&nbsp;Bugs&nbsp;(bug_id,&nbsp;summary)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">VALUES&nbsp;(DEFAULT,&nbsp;<em class="calibre6">'crashes&nbsp;when&nbsp;I&nbsp;save'</em>);</code></span><br class="calibre1" /></div><p class="calibre_6"> This creates a row like the following: </p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">bug_id</code></p></td><td class="calibre19"><p class="calibre_6"><code class="calibre15">summary</code></p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><code class="calibre15">0xff19966f868b11d0b42d00c04fc964ff</code></p></td><td class="calibre19"><p class="calibre_6">Crashes when I save</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><p class="calibre_6"> You gain at least two advantages over traditional pseudokey generators when you use GUIDs: </p><ul class="calibre_14"><li class="calibre_15"> You can generate pseudokeys on multiple database servers concurrently without using the same values. </li><li class="calibre_15"> No one will complain about gaps---they'll be too busy complaining about typing thirty-two hex digits for primary key values. </li></ul><p class="calibre_6"> The latter point leads to some of the disadvantages: </p><ul class="calibre_14"><li class="calibre_15"> The values are long and hard to type. </li><li class="calibre_15"> The values are random, so you can't infer any pattern or rely on a greater value indicating a more recent row. </li><li class="calibre_15"> Storing a GUID requires 16 bytes. This takes more space and runs more slowly than using a typical 4-byte integer pseudokey. </li></ul><h3 class="calibre_8">The Most Important Problem</h3><p class="calibre_6"> Now that you know the problems caused by renumbering pseudokeys and some alternative solutions for related goals, you still have one big problem to solve: how do you fend off an order from a boss who wants you to tidy up the database by closing the gaps in a pseudokey? This is a problem of communication, not technology. Nevertheless, you might need to <span>manage your manager</span> to defend the data integrity of your database. </p><ul class="calibre_14"><li class="calibre_15"><em class="calibre6">Explain the technology.</em> Honesty is usually the best policy. Be respectful and acknowledge the feeling behind the request. For example, tell your manager this: <br class="calibre_16" /> "The gaps do look strange, but they're harmless. It's normal for rows to be skipped, rolled back, or deleted from time to time. We allocate a new number for each new row in the database, instead of writing code to figure out which old numbers we can reuse safely. This makes our code cheap to develop, makes it faster to run, and reduces errors." </li><li class="calibre_15"><em class="calibre6">Be clear about the costs.</em> Changing the primary key values seems like a trivial task, but you should give realistic estimates for the work it will take to calculate new values, write and test code to handle duplicate values, cascade changes throughout the database, investigate the impact to other systems, and train users and administrators to manage the new procedures. <br class="calibre_16" /> Most managers prioritize based on cost of a task, and they should back down from requesting frivolous, micro-optimizing work when they're confronted with the real cost. </li><li class="calibre_15"><em class="calibre6">Use natural keys.</em> If your manager or other users of the database insist on interpreting meaning in the primary key values, then let there be meaning. Don't use pseudokeys---use a string or a number that encodes some identifying meaning. Then it's easier to explain any gaps within the context of the meaning of these natural keys. <br class="calibre_16" /> You can also use both a pseudokey and another attribute column you use as a natural identifier. Hide the pseudokey from reports if gaps in the numeric sequence make readers anxious. </li></ul><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Use pseudokeys as unique row identifiers; they're not row numbers.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-94" id="calibre_link-258">[27]</a>
<small class="calibre3"> See the sidebar <a href="#calibre_link-95"><em class="calibre6">Special Scope for Sequences</em></a>. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-96" id="calibre_link-259">[28]</a>
<small class="calibre3">
<em class="calibre6">MIT Technology Review</em>, April 1992. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-601"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-160">
<pagebreak>
<a id="calibre_link-602">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-227" class="calibre12"><small class="calibre13">Chapter 23</small><br class="calibre14" />See No Evil</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> It is a capital mistake to theorize before you have all the evidence. </em></p></div><div class="calibre1"><div class="calibre4"><span>Sherlock Holmes</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> "I found <em class="calibre6">another</em> bug in your product," the voice on the phone said. </p><p class="calibre_6"> I got this call while working as a technical support engineer for an SQL RDBMS in the 1990s. We had one customer who was well-known for making spurious reports against our database. Nearly all of his reports turned out to be simple mistakes on his part, not bugs. </p><p class="calibre_6"> "Good morning, Mr. Davis. Of course, we'd like to fix any problem you find," I answered. "Can you tell me what happened?" </p><p class="calibre_6"> "I ran a query against your database, and nothing came back." Mr. Davis said sharply. "But I know the data is in the database---I can verify it in a test script." </p><p class="calibre_6"> "Was there any problem with your query?" I asked. "Did the API return any error?" </p><p class="calibre_6"> Davis replied, "Why would I look at the return value of an API function? The function should just run my SQL query. If it returns an error, that indicates your product has a bug in it. If your product didn't have bugs, there would be no errors. I shouldn't have to work around your bugs." </p><p class="calibre_6"> I was stunned, but I had to let the facts speak for themselves. "OK, let's try a test. Copy and paste the <em class="calibre6">exact</em> SQL query from your code into the query tool, and run it. What does it say?" I waited for him. </p><p class="calibre_6"> "Syntax error at <code class="calibre15">SELCET</code>." After a pause, he said, "You can close this issue," and he hung up abruptly. </p><p class="calibre_6"> Mr. Davis was the sole developer for an air traffic control company, writing software that logged data about international airplane flights. We heard from him every week. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-271">
<pagebreak>
<a id="calibre_link-603">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-604">Objective: Write Less Code</h2><p class="calibre_6"> Everyone wants to write <span>elegant code</span>. That is, we want to do cool work with little code. The cooler the work is and the less code it takes us, the greater the ratio of elegance. If we can't make our work cooler, it stands to reason that at least we can improve the elegance ratio of coolness to code volume by doing the same work with less code. </p><p class="calibre_6"> That's a superficial reason, but there are more rational reasons to write concise code: </p><ul class="calibre_14"><li class="calibre_15"> We'll finish coding a working application more quickly. </li><li class="calibre_15"> We'll have less code to test, to document, or to have peer-reviewed. </li><li class="calibre_15"> We'll have fewer bugs if we have fewer lines of code. </li></ul><p class="calibre_6"> It's therefore an instinctive priority for programmers to eliminate any code they can, especially if that code fails to increase coolness. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-247">
<pagebreak>
<a id="calibre_link-605">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-606">Antipattern: Making Bricks Without Straw</h2><p class="calibre_6"> Developers commonly practice the See No Evil antipattern in two forms: first, ignoring the return values of a database API; and second, reading fragments of SQL code interspersed with application code. In both cases, developers fail to use information that is easily available to them. </p><h3 class="calibre_8">Diagnoses Without Diagnostics</h3><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/See-No-Evil/anti/no-check.php">See-No-Evil/anti/no-check.php</a></span></span></div><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">1»</span></code></span><span class="calibre3"><code class="calibre15">$pdo&nbsp;=&nbsp;<span class="calibre10">new</span>&nbsp;PDO("mysql:dbname=test;host=db.example.com",&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;"dbuser",&nbsp;"dbpassword");</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;bug_id,&nbsp;summary,&nbsp;date_reported&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;assigned_to&nbsp;=&nbsp;?&nbsp;AND&nbsp;status&nbsp;=&nbsp;?";</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">2»</span></code></span><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$dbh-&gt;prepare($sql);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">3»</span></code></span><span class="calibre3"><code class="calibre15">$stmt-&gt;execute(<span class="calibre10">array</span>(1,&nbsp;"OPEN"));&nbsp;&nbsp;&nbsp;&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">4»</span></code></span><span class="calibre3"><code class="calibre15">$bug&nbsp;=&nbsp;$stmt-&gt;fetch();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code></span><br class="calibre1" /></div><p class="calibre_6"> This code is concise, but there are several places in this code where status values returned from functions could indicate a problem, but you'll never know about it if you ignore the return values. </p><p class="calibre_6"> Probably the most common error from a database API occurs when you try to create a database connection, for example at <span><span class="calibre_22">«1»</span></span>. You could accidentally mistype the database name or server hostname or you could get the user or password wrong, or the database server could be unreachable. An error with instantiating a PDO connection throws an exception, which would terminate the example script shown previously. </p><p class="calibre_6"> The call to <code class="calibre15">prepare</code> at <span><span class="calibre_22">«2»</span></span> could return <code class="calibre15">false</code> if you have a simple syntax error caused by a typo or an imbalanced parenthesis or a misspelled column name. If this happens, the attempt to call <code class="calibre15">execute</code> as a method of <code class="calibre15">$stmt</code> at <span><span class="calibre_22">«3»</span></span> would be a fatal error because the value <code class="calibre15">false</code> isn't an object. </p><div class="calibre_11"><span class="calibre3"><code class="calibre15">PHP&nbsp;Fatal&nbsp;error:&nbsp;&nbsp;Call&nbsp;to&nbsp;a&nbsp;member&nbsp;<span class="calibre10">function</span>&nbsp;execute()&nbsp;on&nbsp;a&nbsp;non-object</code></span><br class="calibre1" /></div><p class="calibre_6"> The call to <code class="calibre15">execute</code> could also fail, for example, because the statement violates a constraint or exceeds access privileges. The method also returns <code class="calibre15">false</code> on error. </p><p class="calibre_6"> The call to <code class="calibre15">fetch</code> at <span><span class="calibre_22">«4»</span></span> would return <code class="calibre15">false</code> if any other error occurs, such as if the connection to the RDBMS fails. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="See_No_Evil/fatal-error.jpg" src="images/000027.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-248" class="calibre10">Figure 1. A fatal error in PHP results in a blank screen</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> Programmers with attitudes like Mr. Davis aren't uncommon. They may feel that checking return values and exceptions adds nothing to their code, because those cases aren't supposed to happen anyway. Also, the extra code is repetitive and makes an application ugly and hard to read. It definitely adds no coolness. </p><p class="calibre_6"> But users don't see the code; they only see the output. When a fatal error goes unhandled, the user may see only a blank white screen, as in Figure <a href="#calibre_link-248"><em class="calibre6">A fatal error in PHP results in a blank screen</em></a>, or else an incomprehensible exception message. When this happens, it's little consolation that the application code is tidy and concise. </p><h3 class="calibre_8">Lines Between the Reading</h3><p class="calibre_6"> Another common bad habit that fits the See No Evil antipattern is to debug by staring at application code that builds an SQL query as a string. This is difficult because it's hard to visualize the resulting SQL string after you build it with application logic, string concatenation, and extra content from application variables. Trying to debug in this way is like trying to solve a jigsaw puzzle without looking at the photo on the box. </p><p class="calibre_6"> For a simple example, let's look at a type of question I see frequently from developers. The following code builds a query conditionally by concatenating a <code class="calibre15">WHERE</code> clause if the script needs to search for a specific bug instead of a collection of bugs. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/See-No-Evil/anti/white-space.php">See-No-Evil/anti/white-space.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$sql&nbsp;&nbsp;=&nbsp;"SELECT&nbsp;*&nbsp;FROM&nbsp;Bugs";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">if</span>&nbsp;($bug_id)&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;.=&nbsp;"WHERE&nbsp;bug_id&nbsp;=&nbsp;"&nbsp;.&nbsp;intval($bug_id);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$stmt&nbsp;=&nbsp;$pdo-&gt;prepare($sql);</code></span><br class="calibre1" /></div><p class="calibre_6"> Why would the query in this example give an error? The answer is clearer if you look at the full <code class="calibre15">$sql</code> string resulting from the concatenation: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/See-No-Evil/anti/white-space.sql">See-No-Evil/anti/white-space.sql</a></span></span></div><span class="calibre3"><code class="calibre15">SELECT&nbsp;*&nbsp;FROM&nbsp;BugsWHERE&nbsp;bug_id&nbsp;=&nbsp;1234</code></span><br class="calibre1" /></div><p class="calibre_6"> There's no whitespace between <code class="calibre15">Bugs</code> and <code class="calibre15">WHERE</code>, which gives the query invalid syntax, as though it were reading a table called <code class="calibre15">BugsWHERE</code>, followed by an SQL expression in an invalid context. The code concatenated the strings with no space between them. </p><p class="calibre_6"> Developers waste an unbelievable amount of time and energy trying to debug problems like this by looking at the code that builds the SQL, instead of looking at the SQL itself. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-244">
<pagebreak>
<a id="calibre_link-607">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-608">How to Recognize the Antipattern</h2><p class="calibre_6"> Though you might think that the absence of code is by nature difficult to spot, many modern IDE products highlight instances in your code where you ignore a return value from a function that returns one or where your code calls a function but neglects to handle a checked exception.<a href="#calibre_link-245" id="calibre_link-133">[29]</a> You could also encounter the See No Evil antipattern if you hear phrases like the following: </p><ul class="calibre_14"><li class="calibre_15"> "My program crashes after I query the database." <br class="calibre_16" /> Often the crash happens because your query failed, and you tried to use the result in an illegal manner, such as calling a method on a nonobject or dereferencing a null pointer. </li><li class="calibre_15"> "Can you help me find my SQL error? Here's my code…" <br class="calibre_16" /> First, start by looking at the SQL, not the code that builds it. </li><li class="calibre_15"> "I don't bother cluttering up my code with error handling." <br class="calibre_16" /> Some computer scientists have estimated that up to 50 percent of the lines of code in a robust application are devoted to handling error cases. This may seem like a lot, unless you think of all the steps that you could include under error handling: detecting, classifying, reporting, and compensating. It's important for any software to be able to do all that. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-204">
<pagebreak>
<a id="calibre_link-609">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-610">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> You can omit error checking when there's really nothing for you to do in response to the error. For example, the <code class="calibre15">close</code> function for a database connection returns a status, but if your application is about to finish and exit anyway, it's likely that the resources for that connection will be cleaned up regardless. </p><p class="calibre_6"> Exceptions in object-oriented languages allow you to trigger an exception without being responsible for handling it. Your code trusts that whatever code called yours is the code that's responsible for handling the exception. Your code therefore can allow the exception to pass back up the calling stack. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-131">
<pagebreak>
<a id="calibre_link-611">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-612">Solution: Recover from Errors Gracefully</h2><p class="calibre_6"> Anyone who enjoys dancing knows that missteps are inevitable. The secret to remaining graceful is to know how to recover. Give yourself a chance to notice the cause of the mistake. Then you can react quickly and seamlessly, getting back into rhythm before anyone has noticed your gaffe. </p><h3 class="calibre_8">Maintain the Rhythm</h3><p class="calibre_6"> Checking return status and exceptions from database API calls is the best way to ensure that you haven't missed a step. The following example shows code that checks the status after each call that could cause an error: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/See-No-Evil/soln/check.php">See-No-Evil/soln/check.php</a></span></span></div><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15"><span class="calibre10">try</span>&nbsp;{</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$pdo&nbsp;=&nbsp;<span class="calibre10">new</span>&nbsp;PDO("mysql:dbname=test;host=localhost",</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"dbuser",&nbsp;"dbpassword");</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">1»</span></code></span><span class="calibre3"><code class="calibre15">}&nbsp;<span class="calibre10">catch</span>&nbsp;(PDOException&nbsp;$e)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;report_error($e-&gt;getMessage());</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">return</span>;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">$sql&nbsp;=&nbsp;"SELECT&nbsp;bug_id,&nbsp;summary,&nbsp;date_reported&nbsp;FROM&nbsp;Bugs</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;assigned_to&nbsp;=&nbsp;?&nbsp;AND&nbsp;status&nbsp;=&nbsp;?";</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">2»</span></code></span><span class="calibre3"><code class="calibre15"><span class="calibre10">if</span>&nbsp;(($stmt&nbsp;=&nbsp;$pdo-&gt;prepare($sql))&nbsp;===&nbsp;false)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$error&nbsp;=&nbsp;$pdo-&gt;errorInfo();</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;report_error($error[2]);</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">return</span>;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">3»</span></code></span><span class="calibre3"><code class="calibre15"><span class="calibre10">if</span>&nbsp;($stmt-&gt;execute(<span class="calibre10">array</span>(1,&nbsp;"OPEN"))&nbsp;===&nbsp;false)&nbsp;{&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$error&nbsp;=&nbsp;$stmt-&gt;errorInfo();</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;report_error($error[2]);</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">return</span>;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_21">4»</span></code></span><span class="calibre3"><code class="calibre15"><span class="calibre10">if</span>&nbsp;(($bug&nbsp;=&nbsp;$stmt-&gt;fetch())&nbsp;===&nbsp;false)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$error&nbsp;=&nbsp;$stmt-&gt;errorInfo();</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;report_error($error[2]);</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">return</span>;</code></span><br class="calibre1" /><span class="calibre_19"><code class="calibre15"><span class="calibre_20">_</span></code></span><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /></div><p class="calibre_6"> The code at <span><span class="calibre_22">«1»</span></span> catches the exception that is thrown if a database connection fails. The other functions return <code class="calibre15">false</code> when there's a problem. After checking for a problem at <span><span class="calibre_22">«2»</span></span>, <span><span class="calibre_22">«3»</span></span>, and <span><span class="calibre_22">«4»</span></span>, you can get more information from the database connection object or the statement object. </p><h3 class="calibre_8">Retrace Your Steps</h3><p class="calibre_6"> It's also important to use the actual SQL query to debug a problem, instead of the code that produces an SQL query. Many simple mistakes, such as misspellings or imbalanced quotes or parentheses, are apparent instantly, even though they're obscure and puzzling otherwise. </p><ul class="calibre_14"><li class="calibre_15"> Build your SQL query in a variable, instead of building it ad hoc in the arguments of the API method to prepare the query. This gives you the opportunity to examine the variable before you use it. </li><li class="calibre_15"> Choose a place to output SQL that is not part of your application output, such as a log file, an IDE debugger console, or a browser extension to show diagnostic output.<a href="#calibre_link-132" id="calibre_link-134">[30]</a></li><li class="calibre_15"> Do not print the SQL query within HTML comments of a web application's output. Any user can view your page source. Reading the SQL query gives hackers a lot of knowledge about your database structure. </li></ul><p class="calibre_6"> Using an object-relational mapping (ORM) framework that builds and executes SQL queries transparently can make debugging complicated. If you don't have access to the content of the SQL query, how can you observe it for debugging? Some ORM frameworks solve this by sending generated SQL to a log. </p><p class="calibre_6"> Finally, most database brands provide their own logging mechanism on the database servers instead of in application client code. If you can't enable SQL logging in the application, you can still monitor queries as the database server executes them. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Troubleshooting code is already hard enough.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Don't hinder yourself by doing it blind.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-133" id="calibre_link-245">[29]</a>
<small class="calibre3"> A checked exception is one that a function's signature declares, so you know that the function might throw that exception type. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-134" id="calibre_link-132">[30]</a>
<small class="calibre3"> Firebug (<a href="http://getfirebug.com/">http://getfirebug.com/</a>) is a good example. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-613"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-161">
<pagebreak>
<a id="calibre_link-614">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-228" class="calibre12"><small class="calibre13">Chapter 24</small><br class="calibre14" />Diplomatic Immunity</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> Humans are allergic to change. They love to say, "We've always done it this way." I try to fight that. That's why I have a clock on my wall that runs counterclockwise. </em></p></div><div class="calibre1"><div class="calibre4"><span>Rear Adm. Grace Murray Hopper</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> One of my earliest jobs gave me a lesson in the importance of using software engineering best practices, after a tragic accident left me responsible for an important database application. </p><p class="calibre_6"> I interviewed for a contract job at Hewlett-Packard to develop and maintain an application on UNIX, written in C with HP ALLBASE/SQL. The manager and staff interviewing me told me sadly that their programmer who had worked on that application was killed in a traffic accident. No one else in their department knew how to use UNIX or anything about the application. </p><p class="calibre_6"> After I started the job, I found that the developer had never written documentation or tests for this application, and he never used a source code control system or even code comments. All his code resided in a single directory, including code that was part of the live system, code that was under development, and code that was no longer used. </p><p class="calibre_6"> This project had high <span>technical debt</span>---a consequence of using shortcuts instead of best practices.<a href="#calibre_link-162" id="calibre_link-179">[31]</a> Technical debt causes risk and extra work in a project until you pay it off by refactoring, testing, and documenting. </p><p class="calibre_6"> I worked for six months to organize and document the code for what was really a fairly modest application, because I had to spend a lot of my time supporting its users and continuing development. </p><p class="calibre_6"> There was obviously no way that I could ask my predecessor to help me come up to speed on the project. The experience really demonstrated the impact of letting technical debt get out of control. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-135">
<pagebreak>
<a id="calibre_link-615">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-616">Objective: Employ Best Practices</h2><p class="calibre_6"> Professional programmers strive to use good software engineering habits in their projects, such as the following: </p><ul class="calibre_14"><li class="calibre_15"> Keeping application source code under revision control using tools such as Subversion or Git. </li><li class="calibre_15"> Developing and running automated unit tests or functional tests for applications. </li><li class="calibre_15"> Writing documentation, specifications, and code comments to record the requirements and implementation strategies of an application. </li></ul><p class="calibre_6"> The time you take to develop software using best practices is a net win, because it reduces a lot of needless or repetitive work. Most experienced developers know that sacrificing these practices for the sake of expediency is a recipe for failure. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-11">
<pagebreak>
<a id="calibre_link-617">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-618">Antipattern: Make SQL a Second-Class Citizen</h2><p class="calibre_6"> Even among developers who accept best practices when developing application code, there's a tendency to think of database code as exempt from these practices. I call this antipattern <span>Diplomatic Immunity</span> because it assumes that the rules of application development don't apply to database development. </p><p class="calibre_6"> Why would developers make this assumption? The following are some possible reasons: </p><ul class="calibre_14"><li class="calibre_15"> The role of software engineer and database administrator are separate in some companies. The DBA typically works with several teams of programmers, so there's a perception that she's not a full-time member of any one of these teams. She's treated like a visitor, and she's not subject to the same responsibilities as the software engineers. </li><li class="calibre_15"> The SQL language used for relational databases is different from conventional programming. Even the way we invoke SQL statements as a specialized language within application code suggests a kind of guest-like status. </li><li class="calibre_15"> Advanced IDE tools are popular for application code languages, making editing, testing, and source control quick and painless. But tools for database development are not as advanced, or at least not as widely used. Developers can code applications with best practices easily, but applying these practices to SQL feels clumsy by comparison. Developers tend to find other things to do. </li><li class="calibre_15"> In IT, it's ordinary for knowledge and operation of the database to be focused on one person---the DBA. Because the DBA is the only one who has access to the database server, she serves as a living knowledge base and source control system. </li></ul><p class="calibre_6"> The database is the foundation of an application, and quality matters. You know how to develop application code with high quality, but you may be building your application on top of a database that has failed to solve the needs of the project or that no one understands. The risk is that you're developing an application only to find that you have to scrap it. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-66">
<pagebreak>
<a id="calibre_link-619">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-620">How to Recognize the Antipattern</h2><p class="calibre_6"> You might think it's hard to show evidence of not doing something, but that isn't always true. The following are some telltale signs of cutting corners: </p><ul class="calibre_14"><li class="calibre_15"> "We are adopting the new engineering process---that is, a lightweight version of it." <br class="calibre_16" /><span>Lightweight</span> in this context means that the team intends to skip some tasks that the engineering process calls for. Some of these may be legitimate to skip, but it could also be a euphemism for not following important best practices. </li><li class="calibre_15"> "We don't need the DBA staff to attend training for our new source control system, since they don't use it anyway." <br class="calibre_16" /> Excluding some technical team members from training (and probably access) <em class="calibre6">ensures</em> that they won't use those tools. </li><li class="calibre_15"> "How can I track usage of tables and columns in the database? There are some elements we don't know the purpose of, and we'd like to eliminate them if they're obsolete." <br class="calibre_16" /> You are not using the project documentation for the database schema. The document may be out-of-date, may be inaccessible, or may never have existed at all. Even if you don't know the purpose of some tables or columns, they might be important to someone, and you can't remove them. </li><li class="calibre_15"> "Is there a tool to compare two database schema, report the differences, and create a script to alter one to match the other?" <br class="calibre_16" /> If you don't follow a process of deploying changes to database schema, they can get out of sync, and then it's a complicated task to bring them back into order. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-107">
<pagebreak>
<a id="calibre_link-621">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-622">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> I do write documentation and tests, and I use source control and other good habits for any code I want to use more than once. But I also write code that is truly ad hoc, such as a one-time test of an API function to remind myself how to use it or an SQL query I write to answer a user's question. </p><p class="calibre_6"> A good guideline for whether code is really temporary is to delete it immediately after you've used it. If you can't bring yourself to do that, it's probably worth keeping. That's OK, but that means it's worth storing in source control and writing at least some brief notes about what the code is for and how to use it. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-174">
<pagebreak>
<a id="calibre_link-623">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-624">Solution: Establish a Big-Tent Culture of Quality</h2><p class="calibre_6"> Quality is simply testing to most software developers, but that's only <span>quality control</span>---only part of the story. The full life cycle of software engineering involves <span>quality assurance</span>, which includes three parts: </p><ol class="calibre22"><li value="1" class="calibre_15"> Specify project requirements clearly and in writing. </li><li value="2" class="calibre_15"> Design and develop a solution for your requirements. </li><li value="3" class="calibre_15"> Validate and test that your solution matches the requirements. </li></ol><p class="calibre_6"> You need to do all three of these to perform QA correctly, although in some software methodologies, you don't necessarily have to do them in that order. </p><p class="calibre_6"> You can achieve quality assurance in database development by following best practices in <span>documentation</span>, <span>source code control</span>, and <span>testing</span>. </p><h3 class="calibre_8">Exhibit A: Documentation</h3><p class="calibre_6"> There's no such thing as self-documenting code. Although it's true that a skilled programmer can decipher most code through a combination of careful analysis and experimentation, this is laborious.<a href="#calibre_link-175" id="calibre_link-180">[32]</a> Also, code can't tell you about missing features or unsolved problems. </p><p class="calibre_6"> You should document the requirements and implementation of a database just as you do application code. Whether you're the original designer of the database or you're inheriting a database designed by someone else, use the following checklist to document a database: </p><dl class="calibre16"><p class="calibre_6"><span>Entity-relationship diagram:</span></p><blockquote class="calibre_9"> The single most important piece of documentation for a database is an ER diagram showing the tables and their relationships. Several chapters in this book use a simple form of ER diagrams. More complex ER diagrams have notation for columns, keys, indexes, and other database objects. <br class="calibre1" /> Some diagramming software packages include elements for ER diagram notation. Some tools can even reverse-engineer an SQL script or a live database and produce an ER diagram. <br class="calibre1" /> One caveat is that databases can be complex and have so many tables that it's impractical to use a single diagram. In this case, you should decompose it into several diagrams. Usually you can choose natural subgroups of tables so each diagram is readable enough to be useful and not overwhelming to the reader. <br class="calibre1" /></blockquote><p class="calibre_6"><span>Tables, columns, and views:</span></p><blockquote class="calibre_9"> You also need written documentation for your database, because an ER diagram isn't the right format to describe the purpose and usage of each table, column, and other object. <br class="calibre1" /> Tables need a description of what type of entity the table models. For example, <code class="calibre15">Bugs</code>, <code class="calibre15">Products</code>, and <code class="calibre15">Accounts</code> are pretty clear, but what about a lookup table like <code class="calibre15">BugStatus</code> or an intersection table like <code class="calibre15">BugsProducts</code> or a dependent table like <code class="calibre15">Comments</code>? Also, how many rows do you anticipate each table to have? What queries against this table do you expect? What indexes exist in this table? <br class="calibre1" /> Columns each have a name and a data type, but that doesn't tell the reader what the column's values mean. What values make sense in that column (it's rarely the full range of the data type)? For columns storing a quantitative value, what is the unit of measurement? Does the column allow nulls or not, and why? Does it have a unique constraint, and if so, why? <br class="calibre1" /> Views store frequently used queries against one or more tables. What made it worthwhile to create a given view? What application or user is expected to use the view? Was the view intended to abstract a complex relationship of tables? Does it exist as a way to allow unprivileged users to query a subset of rows or columns in a privileged table? Is the view updatable? <br class="calibre1" /></blockquote><p class="calibre_6"><span>Relationships:</span></p><blockquote class="calibre_9"> Referential integrity constraints implement dependencies between tables, but this might not tell everything that you intend the constraints to model. For example, <code class="calibre15">Bugs.reported_by</code> is not nullable, but <code class="calibre15">Bugs.assigned_to</code> is nullable. Does that mean a bug can be fixed before it's assigned? If not, what are the business rules for when the bug must be assigned? <br class="calibre1" /> In some cases, you may have implicit relationships but no constraints for them. Without documentation, it's hard to know where these relationships exist. <br class="calibre1" /></blockquote><p class="calibre_6"><span>Triggers:</span></p><blockquote class="calibre_9"> Data validation, data transformation, and logging database changes are examples of tasks for a trigger. What business rules are you implementing in triggers? <br class="calibre1" /></blockquote><p class="calibre_6"><span>Stored procedures:</span></p><blockquote class="calibre_9"> Document your stored procedures like an API. What problem is the procedure solving? Does a procedure perform any changes to data? What are the data types and meanings of the input and output parameters? Do you intend the procedure to replace a certain type of query to eliminate a performance bottleneck? Do you use the procedure to grant unprivileged users access to privileged tables? <br class="calibre1" /></blockquote><p class="calibre_6"><span>SQL Security:</span></p><blockquote class="calibre_9"> What database users do you define for applications to use? What access privileges do each of these users have? What SQL roles do you provide, and which users can use them? Are any users designated for specific tasks, such as backups or reports? What system-level security provisions do you use, such as if the client must reach the RDBMS server via SSL? What measures do you take to detect and block attempts at illicit authentication, such as brute-force password guessing? Have you done a thorough code review for SQL Injection vulnerabilities? <br class="calibre1" /></blockquote><p class="calibre_6"><span>Database infrastructure:</span></p><blockquote class="calibre_9"> This information is chiefly used by IT staff and DBAs, but developers need to know some of it too. What RDBMS brand and version do you operate? What is your database server hostname? Do you use multiple database servers, replication, clusters, proxies, and so on? What is your network organization and the port number used by the database server? What connection options do client applications need to use? What are the database user passwords? What are your database backup policies? <br class="calibre1" /></blockquote><p class="calibre_6"><span>Object-relational mapping:</span></p><blockquote class="calibre_9"> Your project may implement some database-handling logic in application code, as part of an layer of ORM-based code classes. What business rules are implemented in this way? Data validation, data transformation, logging, caching, or profiling? <br class="calibre1" /></blockquote></dl><p class="calibre_6"> Developers don't like to maintain engineering documentation. It's hard to write, it's hard to keep up-to-date, and it's dispiriting when few people read what you do write. But even battle-hardened, extreme programmers know that they need to document the database, even if they document no other part of their software.<a href="#calibre_link-176" id="calibre_link-181">[33]</a></p><div class="sidebar" id="calibre_link-178"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Schema Evolution Tools</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Your code is under source control, but your database isn't. Ruby on Rails popularized a technique called <span>migrations</span> to manage upgrades to a database instance under source control. Let's briefly see an example of an upgrade: </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Write a script with code to upgrade a database by one step, based on Rails' abstract class for making database changes. Also write a downgrade function that reverses the changes from those in the upgrade function. </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;AddHoursToBugs&nbsp;&lt;&nbsp;ActiveRecord::Migration</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">def</span>&nbsp;<span class="calibre10">self</span>.up</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;add_column&nbsp;:bugs,&nbsp;:hours,&nbsp;:decimal</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">end</span></code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">def</span>&nbsp;<span class="calibre10">self</span>.down</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;remove_column&nbsp;:bugs,&nbsp;:hours</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">end</span></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">end</span></code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The Rails tool that runs migrations automatically creates a table to record the revision or revisions that apply to your current database instance. Rails 2.1 introduced changes to make this system more flexible, and subsequent versions of Rails may also change the way migrations work. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Create a new migration script for each schema alteration in the database. You accumulate a set of these migration scripts; each one can upgrade or downgrade the database schema one step. If you need to change your database to version 5, specify an argument to the migration tool. </blockquote></small></p><div class="calibre_11"><span class="calibre3"><code class="calibre15">$&nbsp;rake&nbsp;db:migrate&nbsp;VERSION=5</code></span><br class="calibre1" /></div><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> There's a lot more to learn about migrations in <em class="calibre6">Agile Web Development with Rails, Third Edition</em><a href="#calibre_link-43">[AWDWR]</a> or <a href="http://guides.rubyonrails.org/migrations.html">http://guides.rubyonrails.org/migrations.html</a>. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Most other web development frameworks, including Doctrine for PHP, Django for Python, and Microsoft ASP.NET, support features similar to Rails' migrations, either included with the framework or available as a community project. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Migrations automate a lot of tedious work of synchronizing a database instance with the structure expected in a given revision of your project under source code control. But they aren't perfect. They handle only a few simple types of schema changes, and they basically implement a revision system on top of your conventional source control. </blockquote></small></p></div><hr class="calibre7" /></div><h3 class="calibre_8">Trail of Evidence: Source Code Control</h3><p class="calibre_6"> If your database server failed completely, how would you re-create a database? What's the best way to track a complex upgrade to your database design? How would you back out a change? </p><p class="calibre_6"> We know how we would use a source control system to manage application code, solving similar problems of software development. A project under source control should include <em class="calibre6">everything</em> you need to rebuild and redeploy the project if your existing deployment explodes. Source control also serves as a history of changes and an incremental backup so you can reverse any of these changes. </p><p class="calibre_6"> You can use source control with your database code and get similar benefits for development.</p><p class="calibre_6"> You should check into source control the files related to your database development, including the following: </p><dl class="calibre16"><p class="calibre_6"><span>Data definition scripts:</span></p><blockquote class="calibre_9"> All brands of database provide ways to execute <span>SQL scripts</span> containing <code class="calibre15">CREATE&nbsp;TABLE</code> and other statements that define the database objects. <br class="calibre1" /></blockquote><p class="calibre_6"><span>Triggers and procedures:</span></p><blockquote class="calibre_9"> Many projects supplement application code with routines stored in the database. Your application probably won't work without these routines, so they count as part of your project's code. <br class="calibre1" /></blockquote><p class="calibre_6"><span>Bootstrap data:</span></p><blockquote class="calibre_9"> Lookup tables may contain some set of data that represents an initial state of your database, before any users enter new data. You should keep bootstrap data to help if you need to re-create a database from your project source. Also called <span>seed data</span>. <br class="calibre1" /></blockquote><p class="calibre_6"><span>ER diagrams and documentation:</span></p><blockquote class="calibre_9"> These files aren't code, but they're closely tied to the code, describing database requirements, implementation, and integration with the application. As the project evolution results in changes to both the database and the application, you should keep these files up-to-date. Make sure the documents describe the current designs. <br class="calibre1" /></blockquote><p class="calibre_6"><span>DBA scripts:</span></p><blockquote class="calibre_9"> Most projects have a collection of data-handling jobs that run outside the application. These include tasks for import/export, synchronization, reporting, backups, validation, testing, and so on. These may be written as SQL scripts, not part of a conventional application programming language. <br class="calibre1" /></blockquote></dl><p class="calibre_6"> Make sure your database code files are associated with the application code that uses that database. Part of the benefit of using source control is that if you check out your project from source control given a certain revision number, date, or milestone, the files should work together. Use the same source control repository for both application code and database code. </p><h3 class="calibre_8">Burden of Proof: Testing</h3><p class="calibre_6"> The final part of quality assurance is quality control---validating that your application does what it set out to do. Most professional developers are familiar with techniques to write automated tests to validate application code behavior. One important principle of testing is <span>isolation</span>, testing only one part of the system at a time so that if a defect exists, you can narrow down where it exists as precisely as possible. </p><p class="calibre_6"> We can extend the practice of isolation testing to the database by validating the database structure and behavior independently from your application code.</p><p class="calibre_6"> The following example shows a unit test script using the PHPUnit test framework:<a href="#calibre_link-177" id="calibre_link-182">[34]</a></p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Diplomatic_immunity/DatabaseTest.php">Diplomatic_immunity/DatabaseTest.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">require_once</span>&nbsp;"PHPUnit/Framework/TestCase.php";</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;DatabaseTest&nbsp;<span class="calibre10">extends</span>&nbsp;PHPUnit_Framework_TestCase</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">protected</span>&nbsp;$pdo;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;setUp()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;pdo&nbsp;=&nbsp;<span class="calibre10">new</span>&nbsp;PDO("mysql:dbname=bugs",&nbsp;"testuser",&nbsp;"xxxxxx");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;testTableFooExists()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stmt&nbsp;=&nbsp;$this-&gt;pdo-&gt;query("SELECT&nbsp;COUNT(*)&nbsp;FROM&nbsp;Bugs");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err&nbsp;=&nbsp;$this-&gt;pdo-&gt;errorInfo();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assertType("object",&nbsp;$stmt,&nbsp;$err[2]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assertEquals("PDOStatement",&nbsp;get_class($stmt));</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;testTableFooColumnBugIdExists()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stmt&nbsp;=&nbsp;$this-&gt;pdo-&gt;query("SELECT&nbsp;COUNT(bug_id)&nbsp;FROM&nbsp;Bugs");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err&nbsp;=&nbsp;$this-&gt;pdo-&gt;errorInfo();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assertType("object",&nbsp;$stmt,&nbsp;$err[2]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assertEquals("PDOStatement",&nbsp;get_class($stmt));</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">static</span>&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;main()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$suite&nbsp;&nbsp;=&nbsp;<span class="calibre10">new</span>&nbsp;PHPUnit_Framework_TestSuite(<span class="calibre10">__CLASS__</span>);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;PHPUnit_TextUI_TestRunner::run($suite);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">DatabaseTest::main();</code></span><br class="calibre1" /></div><p class="calibre_6"> You can use the following checklist for tests that validate your database: </p><dl class="calibre16"><p class="calibre_6"><span>Tables, columns, views:</span></p><blockquote class="calibre_9"> You should test that tables and views you expect to exist in the database do exist. Each time you enhance the database with a new table, view, or column, add a new test that confirms that the object is present. You can also use <span>negative tests</span> to confirm that a table or column you removed in the current revision of your project is in fact no longer present. <br class="calibre1" /></blockquote><p class="calibre_6"><span>Constraints:</span></p><blockquote class="calibre_9"> This is another use of negative testing. Try to execute <code class="calibre15">INSERT</code>, <code class="calibre15">UPDATE</code>, or <code class="calibre15">DELETE</code> statements that should result in an error because of a constraint. For example, try to violate not-null, unique constraints, or foreign keys. If the statement doesn't return an error, then your constraint isn't working. You can catch many bugs early by identifying these failures. <br class="calibre1" /></blockquote><p class="calibre_6"><span>Triggers:</span></p><blockquote class="calibre_9"> Triggers can enforce constraints too. Triggers can perform cascading effects, transform values, log changes, and so on. You should test these scenarios by executing a statement that spawns the trigger and then querying to confirm that the trigger performed the action you intended. <br class="calibre1" /></blockquote><p class="calibre_6"><span>Stored procedures:</span></p><blockquote class="calibre_9"> Testing procedures in the database is closest to conventional unit testing of application code. A stored procedure has input parameters, which could throw errors if you try to pass values outside the range of valid input. Logic within the body of the procedure could allow multiple execution paths. The procedure could return a single value or a query result set, depending on the inputs and the state of data in the database. Also, the procedure could have <span>side effects</span> in the form of updating the database. You can test all of these features of procedures. <br class="calibre1" /></blockquote><p class="calibre_6"><span>Bootstrap data:</span></p><blockquote class="calibre_9"> Even a supposedly empty database typically needs some initial data, such as in lookup tables. You can run queries to validate that the initial data is present. <br class="calibre1" /></blockquote><p class="calibre_6"><span>Queries:</span></p><blockquote class="calibre_9"> Application code is laced with SQL queries. You can execute queries in a test environment to validate syntax and results. Confirm that the result set includes the column names and data types you expect, just like testing tables and views. <br class="calibre1" /></blockquote><p class="calibre_6"><span>ORM classes:</span></p><blockquote class="calibre_9"> Like triggers, ORM classes contain logic, including validation, transformation, or monitoring. You should test your ORM-based database abstraction code as you would any other application code. Confirm that these classes do the expected actions with input and also that they reject invalid input. <br class="calibre1" /></blockquote></dl><p class="calibre_6"> If any of your tests fail, your application could be using the wrong database instance. Always double-check that you're connecting to the right database---the mistake is frequently simply a matter of connecting to the wrong instance. Edit the configuration if needed and try again. If you're sure you're connection is proper but you need to alter the database, then you can run a <span>migration script</span> (see the sidebar <a href="#calibre_link-178"><em class="calibre6">Schema Evolution Tools</em></a>) to synchronize this database instance to match what your application expects. </p><h3 class="calibre_8">Case Load: Working in Multiple Branches</h3><p class="calibre_6"> While you develop your application, you could work on multiple revisions of the code. You might even work on different revisions in the same day. For example, you could fix an urgent bug in the branch of the application currently deployed and then moments later resume working on long-term development in the main branch. </p><p class="calibre_6"> But the database your application uses isn't under revision control. It's not practical to set up and tear down a database on a moment's notice, even if the database brand you use is relatively agile and easy to use. </p><p class="calibre_6"> Ideally, create a separate instance of your database for each revision of the application you need to develop, test, stage, or deploy. Also, each developer in your project team needs a separate database instance so they can work without interfering with the rest of the team. </p><p class="calibre_6"> Make your application support a configurable means to specify database connection parameters so that whichever application revision you work on, you can specify which database to use without overwriting code. </p><p class="calibre_6"> Today every RDBMS brand, both commercial and open source, offers a free solution for development and testing. Platform virtualization technology such as VMware Workstation, Xen, and VirtualBox allow every developer to run a clone of the server infrastructure at little cost. There is no reason that software developers can't develop and test in a fully functional environment that matches the production environment. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Use software development best practices, including documentation, testing, and source control, for your database as well as your application.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-179" id="calibre_link-162">[31]</a>
<small class="calibre3"> Ward Cunningham coined this metaphor in his experience report for OOPSLA 1992 (<a href="http://c2.com/doc/oopsla92.html">http://c2.com/doc/oopsla92.html</a>). </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-180" id="calibre_link-175">[32]</a>
<small class="calibre3"> If code were readable, why would we call it <span>code</span>? </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-181" id="calibre_link-176">[33]</a>
<small class="calibre3"> For example, Jeff Atwood and Joel Spolsky see little value in documenting code, <em class="calibre6">except</em> for the database, in StackOverflow podcast #80, <a href="http://blog.stackoverflow.com/2010/01/podcast-80/">http://blog.stackoverflow.com/2010/01/podcast-80/</a>. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-182" id="calibre_link-177">[34]</a>
<small class="calibre3"> See <a href="http://www.phpunit.de/">http://www.phpunit.de/</a>. Admittedly, testing database functionality isn't strictly <span>unit testing</span>, but you still can use this tool to organize and automate the tests. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-625"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-260">
<pagebreak>
<a id="calibre_link-626">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-229" class="calibre12"><small class="calibre13">Chapter 25</small><br class="calibre14" />Magic Beans</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> Explanations exist; they have existed for all time; there is always a well-known solution to every human problem---neat, plausible, and wrong. </em></p></div><div class="calibre1"><div class="calibre4"><span>H. L. Mencken</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> "Why is it taking so long to add one little feature?" Your manager had assigned your team to enhance the bug-tracking application to show a count of how many comments a bug had received. You've been working on this task for four weeks. </p><p class="calibre_6"> Your group of software developers in the meeting room looks reluctant to answer the question. As project lead, you answer. "We've had a couple of false starts," you explain. "It seemed simple at first, until we realized there were some other screens in the application where we needed to show the comment count." </p><p class="calibre_6"> "And designing the screens took four weeks?" your manager asks. </p><p class="calibre_6"> "Well, no, that's just a little bit of HTML, and that's pretty easy since we use the framework that separates code from presentation," you go on. "But each time we added this element to a screen, we had to duplicate code to fetch data in the screen's back-end code. And that meant each back-end class needed a new suite of tests." </p><p class="calibre_6"> "Don't we use a testing framework?" your manager asks. "How long does it take to code a few more tests?" </p><p class="calibre_6"> "Writing tests isn't as simple as writing the code," another engineer says hesitantly. "We also created scripts for test data. Then we needed to reload data on the test database for each test. We needed to test the front end too, with all the permutations of the new feature combined with old scenarios." </p><p class="calibre_6"> Your manager's eyes are now starting to glaze over, but your co-worker continues, "We now have 600 tests for the front end, and each one runs an instance of a browser emulator. It just takes time to run through all those tests." He shrugs, "There's nothing we can do about that." </p><p class="calibre_6"> Your manager takes a deep breath, and says, "OK…I didn't follow all that; I just want to know why this is so complicated to add one simple feature. Wasn't your object-oriented framework supposed to make it quicker and easier to add features?" </p><p class="calibre_6"> Good question. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-318">
<pagebreak>
<a id="calibre_link-627">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-628">Objective: Simplify Models in MVC</h2><p class="calibre_6"> Web application frameworks make it faster and easier to add features and code to an application. The greatest contributor to the cost of a software project is development time. So, the more we can reduce developer time, the less expensive it is to produce software. Robert L. Glass found that "eighty percent of software work is intellectual. A fair amount of it is creative. Little of it is clerical."<a href="#calibre_link-319" id="calibre_link-265">[35]</a></p><p class="calibre_6"> One way we assist the intellectual part of software development is to adopt the terminology and conventions of design patterns. When we say <span>Singleton</span> or <span>Facade</span> or <span>Factory</span>, the other developers on our team know what we mean. That saves a lot of time. </p><p class="calibre_6"> Much of the code in any application is repetitive---practically boilerplate. Frameworks help improve coding productivity by giving us reusable components and code generation tools. We can produce working software applications while writing less original code. </p><p class="calibre_6"> Design patterns and software frameworks come together when we use the <span>Model View Controller</span> (MVC) architecture. This is a technique for separating concerns in an application, as illustrated in Figure <a href="#calibre_link-320"><em class="calibre6">Model View Controller</em></a>. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Magic_beans/mvc.jpg" src="images/000002.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-320" class="calibre10">Figure 1. Model View Controller</span></td></tr></table></div><br class="calibre1" /><ul class="calibre_14"><li class="calibre_15"> The <span>controllers</span> accept user input, define the work the application should do in response, delegate work to the appropriate models, and send results to the view. </li><li class="calibre_15"> The <span>models</span> handle everything else; they are the heart of the application and include input validation, business logic, and database interaction. </li><li class="calibre_15"> The <span>views</span> present information in the user interface. </li></ul><p class="calibre_6"> It's easy to understand what the controller and the view do. But the purpose of the model is more vague. There's a great desire in the software developer community to simplify and generalize what a model is, with the goal of reducing the complexity of software design. But often that goal leads them to oversimplify by assuming the model is only a data access object. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-45">
<pagebreak>
<a id="calibre_link-629">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-630">Antipattern: The Model Is an Active Record</h2><p class="calibre_6"> In simple applications, you don't need much custom logic in a model. It's relatively straightforward to match the fields of a model object to the columns of a single table in a database. This is a type of <span>object-relational mapping</span>. All you need the object to do is know how to create a row in the table, read the row, and update and delete it---the basic <span>CRUD</span> operations. </p><div class="sidebar"><hr class="calibre7" /><div class="calibre4"><h3 class="calibre2">Leaky Abstractions</h3></div><hr class="calibre7" /><div class="calibre1"><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Joel Spolsky coined the term <span>leaky abstractions</span> in 2002.<a href="#calibre_link-46" id="calibre_link-266">[36]</a> An abstraction simplifies the internal workings of some technology and makes it easier to use. But when you have to know the internals anyway to be productive, that's when it's called a leaky abstraction. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The use of the Active Record pattern as a model in MVC is a good example of a leaky abstraction. In very simple cases, Active Record works like magic. But if you try to use it for all database access, you find many operations such as <code class="calibre15">JOIN</code> or <code class="calibre15">GROUP&nbsp;BY</code> that are simple to express in SQL are awkward in Active Record. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> Some frameworks try to enhance Active Record to support a variety of SQL clauses. The more these enhancements expose the fact that the class uses SQL internally, the more you feel like you might be better off using SQL directly. </blockquote></small></p><p class="calibre_17"><small class="calibre3"><blockquote class="calibre_9"> The abstraction has failed to hide its secrets, like Toto exposing the Wizard of Oz as an ordinary man behind a curtain. </blockquote></small></p><blockquote class="calibre_9"><small class="calibre3"> See <em class="calibre6">The Law of Leaky Abstractions</em><a href="#calibre_link-47">[TLOLA]</a> . </small><br class="calibre_12" /></blockquote></div><hr class="calibre7" /></div><p class="calibre_6"> Martin Fowler described a design pattern to support this mapping, called <span>Active Record</span>.<a href="#calibre_link-48" id="calibre_link-267">[37]</a> Active Record is a data access pattern. You define a class corresponding to a table or view in your database. You can call a class method <code class="calibre15">find</code> that returns an object instance of the class, corresponding to an individual row in that table or view. You can also use the class constructor to create a new row. Calling <code class="calibre15">save</code> on this object either inserts a new row or updates the existing row. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Magic-Beans/anti/doctrine.php">Magic-Beans/anti/doctrine.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$bugsTable&nbsp;=&nbsp;Doctrine_Core::getTable(<em class="calibre6">'Bugs'</em>);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$bugsTable-&gt;find(1234);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">$bug&nbsp;=&nbsp;<span class="calibre10">new</span>&nbsp;Bugs();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$bug-&gt;summary&nbsp;=&nbsp;"Crashes&nbsp;when&nbsp;I&nbsp;save";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$bug-&gt;save();</code></span><br class="calibre1" /></div><p class="calibre_6"> Ruby on Rails popularized Active Record for web development frameworks in 2004, and now most web application frameworks use this pattern as the <em class="calibre6">de facto</em> data access object (DAO). There's nothing wrong with using Active Record; it's a fine pattern that provides a simple interface to individual rows in a single table. The antipattern is the convention that all model classes in an MVC application inherit from the base Active Record class. This is an example of the <span>Golden Hammer</span> antipattern: if the only tool you have is a hammer, treat everything as if it were a nail. </p><p class="calibre_6"> It's tempting to embrace any convention that simplifies software design. We can make our work easier if we're willing to sacrifice some flexibility, and if we never really needed the flexibility to begin with, that's even better. </p><p class="calibre_6"> But this is a fairy tale, like <em class="calibre6">Jack and the Beanstalk.</em> Jack believed that his magic beans would grow into a mighty beanstalk while he slept. It worked out all right in Jack's story, but we may not always be so lucky. Let's look at the consequences of the <span>Magic Beans</span> antipattern. </p><h3 class="calibre_8">Active Record Couples Models to the Schema</h3><p class="calibre_6"> Active Record is a simple pattern, because a plain Active Record class represents a single table or view in the database. The fields of each Active Record object match the columns in one corresponding table. If you have sixteen tables, you define sixteen model subclasses. </p><p class="calibre_6"> This means that if you need to refactor your database to represent a new structure of data, your model classes need to change, as well as any code in your application that uses the model classes. Likewise, if you add a controller to handle a new screen in your application, you may have to duplicate code that queries your models. </p><h3 class="calibre_8">Active Record Exposes CRUD Functions</h3><p class="calibre_6"> The next problem you may run into is that other programmers who use your model class can bypass your intended usage, updating data directly using CRUD functions. </p><p class="calibre_6"> For example, you might add a method <code class="calibre15">assignUser</code> to a bug model, because you need to send an email to that engineer after updating the bug. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Magic-Beans/anti/crud.php">Magic-Beans/anti/crud.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;CustomBugs&nbsp;<span class="calibre10">extends</span>&nbsp;BaseBugs</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;assignUser(Accounts&nbsp;$a)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assigned_to&nbsp;=&nbsp;$a-&gt;account_id;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;save();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;mail($a-&gt;email,&nbsp;"Assigned&nbsp;bug",</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"You&nbsp;are&nbsp;now&nbsp;responsible&nbsp;<span class="calibre10">for</span>&nbsp;bug&nbsp;<em class="calibre6">#{$this-&gt;bug_id}.");</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /></div><p class="calibre_6"> However, another programmer working on the bug application bypasses your method and assigns the bug manually without sending the email. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Magic-Beans/anti/crud.php">Magic-Beans/anti/crud.php</a></span></span></div><span class="calibre3"><code class="calibre15">$bugsTable&nbsp;=&nbsp;Doctrine_Core::getTable(<em class="calibre6">'Bugs'</em>);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$bugsTable-&gt;find(1234);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$bug-&gt;assigned_to&nbsp;=&nbsp;$user-&gt;account_id;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">$bug-&gt;save();</code></span><br class="calibre1" /></div><p class="calibre_6"> Your requirement was to have an email notification sent whenever the assignment changes. This allows that step to be bypassed. Does it make sense for your derived model class to expose the CRUD methods of the base Active Record class? How can you prevent other programmers from using these methods inappropriately? How can you exclude the base Active Record interface from your model class's generated documentation and code completion in programming editors? </p><h3 class="calibre_8">Active Record Encourages an Anemic Domain Model</h3><p class="calibre_6"> A closely related point is that a model frequently has no behavior <em class="calibre6">except</em> generic CRUD methods. Many developers extend the base Active Record class without adding any new methods related to the work the model should do. </p><p class="calibre_6"> Treating models as simple data access objects encourages you to code your business logic outside the model, usually spread over multiple controller classes and reducing cohesion of the model's behavior. Martin Fowler calls this antipattern the <span>Anemic Domain Model</span> in his blog.<a href="#calibre_link-49" id="calibre_link-268">[38]</a> For example, you might have separate Active Record classes corresponding to the <code class="calibre15">Bugs</code>, <code class="calibre15">Accounts</code>, and <code class="calibre15">Products</code> tables. But you need data from all three of these tables in many application tasks. </p><p class="calibre_6"> Let's look at a simple code example for our bug-tracking application that implements bug assignment, data entry, bug display, and bug search tasks. It uses a PHP framework called Doctrine to provide a simple active record interface, and it uses the Zend Framework for the MVC architecture. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Magic-Beans/anti/anemic.php">Magic-Beans/anti/anemic.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;AdminController&nbsp;<span class="calibre10">extends</span>&nbsp;Zend_Controller_Action</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;assignAction()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bugsTable&nbsp;=&nbsp;Doctrine_Core::getTable("Bugs");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug&nbsp;=&nbsp;$bugsTable-&gt;find($_POST["bug_id"]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;Products[]&nbsp;=&nbsp;$_POST["product_id"];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;assigned_to&nbsp;=&nbsp;$_POST["user_assigned_to"];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;save();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;BugController&nbsp;<span class="calibre10">extends</span>&nbsp;Zend_Controller_Action</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;enterAction()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug&nbsp;=&nbsp;<span class="calibre10">new</span>&nbsp;Bugs();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;summary&nbsp;=&nbsp;$_POST["summary"];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;description&nbsp;=&nbsp;$_POST["summary"];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;status&nbsp;=&nbsp;"NEW";</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$accountsTable&nbsp;=&nbsp;Doctrine_Core::getTable("Accounts");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$auth&nbsp;=&nbsp;Zend_Auth::getInstance();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">if</span>&nbsp;($auth&nbsp;&amp;&amp;&nbsp;$auth-&gt;hasIdentity())&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;reported_by&nbsp;=&nbsp;$auth-&gt;getIdentity();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;}</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;save();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;displayAction()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bugsTable&nbsp;=&nbsp;Doctrine_Core::getTable("Bugs");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;view-&gt;bug&nbsp;=&nbsp;$bugsTable-&gt;find($_GET["bug_id"]);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$accountsTable&nbsp;=&nbsp;Doctrine_Core::getTable("Accounts");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;view-&gt;reportedBy&nbsp;=&nbsp;$accountsTable-&gt;find($bug-&gt;reported_by);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;view-&gt;assignedTo&nbsp;=&nbsp;$accountsTable-&gt;find($bug-&gt;assigned_to);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;view-&gt;verifiedBy&nbsp;=&nbsp;$accountsTable-&gt;find($bug-&gt;verified_by);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$productsTable&nbsp;=&nbsp;Doctrine_Core::getTable("Products");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;view-&gt;products&nbsp;=&nbsp;$bug-&gt;Products;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;SearchController&nbsp;<span class="calibre10">extends</span>&nbsp;Zend_Controller_Action</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;bugsAction()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$q&nbsp;=&nbsp;Doctrine_Query::create()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;from("Bugs&nbsp;b")</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;join("b.Products&nbsp;p")</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;where("b.status&nbsp;=&nbsp;?",&nbsp;$_GET["status"])</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;andWhere("MATCH(b.summary,&nbsp;b.description)&nbsp;AGAINST&nbsp;(?)",&nbsp;$_GET["search"]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;view-&gt;searchResults&nbsp;=&nbsp;$q-&gt;fetchArray();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /></div><p class="calibre_6"> Code that uses Active Record in controller classes expands to become a procedural approach to organizing application logic. If the database schema or the desired application behavior ever changes, you need to update many places in the code. Likewise, if you add a controller, you need to write new code even if your queries against the model are similar to those in other controllers. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Magic_beans/crisscross.jpg" src="images/000001.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-50" class="calibre10">Figure 2. Using Magic Beans leads to vinelike tangles.</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> The class interaction diagram (shown in Figure <a href="#calibre_link-50"><em class="calibre6">Using Magic Beans leads to vinelike tangles.</em></a>) is messy and hard to read; it only gets worse as we add more controllers and DAO classes. This should be a strong clue that the code that uses different models together is duplicated across controllers. You need to use another approach to simplify and encapsulate part of your application. </p><h3 class="calibre_8">Unit Testing Magic Beans Is Hard</h3><p class="calibre_6"> When you employ the Magic Beans antipattern, you find that testing each of the layers in MVC is harder. </p><ul class="calibre_14"><li class="calibre_15"><em class="calibre6">Testing the model:</em> Since you've made the model the same class as the Active Record, you can't test model behavior separately from data access. To test the model, you have to execute queries against a live database. <br class="calibre_16" /> Many people use <span>database fixtures</span>. A database fixture loads data into a test database to ensure that each test runs against a baseline state. Doing this much complex setup and teardown work makes testing models slow and error-prone, as well as requiring a live database for tests. </li><li class="calibre_15"><em class="calibre6">Testing the view:</em> Testing views involves rendering the view into HTML and parsing the result to verify that dynamic HTML elements provided by models appear in the output. Even if your framework simplifies the assertions in your test scripts, the framework has to run complex and time-consuming code to perform the rendering and then parse the HTML for specific elements. </li><li class="calibre_15"><em class="calibre6">Testing the controller:</em> You also find that testing the controller is complex, because a model that is a data access object leads to repetitions of the same code in multiple controllers, all of which need to be tested. <br class="calibre_16" /> To test a controller, you need to create a fake HTTP request. The output of a web application is an HTTP response header and body. To verify the test, you have to pick apart the HTTP response the controller returns. This needs a lot of setup code to test business logic, and it makes tests run slowly. </li></ul><p class="calibre_6"> If you could separate business logic from the database access and separate business logic from presentation, it would help to meet the goals of MVC, and it would make testing simpler too. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-304">
<pagebreak>
<a id="calibre_link-631">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-632">How to Recognize the Antipattern</h2><p class="calibre_6"> The following clues may mean that you have Magic Beans: </p><ul class="calibre_14"><li class="calibre_15"> "How can I pass a custom SQL query to a model?" <br class="calibre_16" /> The question suggests that you're using a database access class as a model class. You shouldn't have to pass SQL queries to the model---the model class should encapsulate any queries it needs. </li><li class="calibre_15"> "Should I copy complex model queries to all my controllers, or should I code them once in an abstract controller?" <br class="calibre_16" /> Neither of these solutions gives you the stability or simplicity you are looking for. You should code complex queries within the model, exposed as part of the interface of the model. That way, you follow the <span>Don't Repeat Yourself</span> (DRY) principle, and you make the model's usage simpler.<a href="#calibre_link-305" id="calibre_link-269">[39]</a></li><li class="calibre_15"> "I have to write more database fixtures to unit test my models." <br class="calibre_16" /> If you're using database fixtures, you're testing database access, not business logic. You should be able to unit test a model in isolation from the database. </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-136">
<pagebreak>
<a id="calibre_link-633">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-634">Legitimate Uses of the Antipattern</h2><p class="calibre_6"> There's nothing wrong with the Active Record design pattern per se. It's a convenient pattern for simple CRUD operations. In most applications, you have some cases where you need only a simple data access object for simple operations on individual rows of a table. You can simplify these cases by defining the model as coincident with its DAO. </p><p class="calibre_6"> Another good use of Active Record is for prototyping code. When writing code quickly is more important than writing code that's testable and maintainable, shortcuts are important. Showing a working prototype early and often is a great way to refine the project with active feedback. Anything you can do to speed up development of the prototype is helpful in these circumstances, and using simple application frameworks can help in this case. </p><p class="calibre_6"> Just be sure to budget some time for refactoring the code to pay back the technical debt you gather by writing coding in a prototype mode. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-261">
<pagebreak>
<a id="calibre_link-635">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-636">Solution: The Model Has an Active Record</h2><p class="calibre_6"> Controllers handle application input and views handle application output, both relatively simple and well-defined tasks. Frameworks are best at helping you put these together quickly. But it's hard for a framework to provide a one-size-fits-all solution for models, because models comprise the rest of the object-oriented design for your application. </p><p class="calibre_6"> This is where you actually need to think hard about what the objects are in your application and what data and behavior those objects have. Remember Robert L. Glass's estimate that the majority of software development is intellectual and creative? </p><h3 class="calibre_8">Grasping the Model</h3><p class="calibre_6"> Fortunately, there's a lot of wisdom in the field of object-oriented design to guide you. Craig Larman's book <em class="calibre6">Applying UML and Patterns</em><a href="#calibre_link-262">[AUAPAITOAADAID]</a> , for example, describes guidelines called the General Responsibility Assignment Software Patterns (GRASP). Some of these guidelines are especially relevant to separating models from their data access objects: </p><h4 class="calibre_18">Information Expert</h4><p class="calibre_6"> The object responsible for an operation should have <em class="calibre6">all</em> the data needed to fulfill that operation. Since some operations in your application involve multiple tables (or no tables) and Active Record is good at working with only one table at a time, we need another class to aggregate several database access objects together and use them for the composite operation. </p><p class="calibre_6"> The relationship between a model and a DAO like Active Record should be <span>HAS-A</span> (aggregation) instead of <span>IS-A</span> (inheritance). Most frameworks that rely on Active Record assume the IS-A solution. If your model uses DAOs instead of inheriting from the DAO class, then you can design the model to contain all data and code for the domain it's supposed to model---even if it takes multiple database tables to represent it. </p><h4 class="calibre_18">Creator</h4><p class="calibre_6"> How the model persists its data in a database should be an internal implementation detail. A domain model that aggregates its DAOs should have the responsibility to create those objects. </p><p class="calibre_6"> The controllers and views in your application should use the domain model interface, without being aware of what kind of database interaction is necessary for the model to fetch or store data. This makes it easy to change the database queries later, in one place in your application. </p><h4 class="calibre_18">Low Coupling</h4><p class="calibre_6"> It's important to decouple logically independent blocks of code. This gives you the flexibility to change the implementation of a class without affecting its consumers. You can't simplify the requirements of the application; some complexity has to reside somewhere in your code. But you can make the best choice about where you implement that complexity. </p><h4 class="calibre_18">High Cohesion</h4><p class="calibre_6"> The interface for the domain model class should reflect its intended usage, not the physical database structure or CRUD operations. Generic methods of the Active Record interface like <code class="calibre15">find</code>, <code class="calibre15">first</code>, <code class="calibre15">insert</code>, or even <code class="calibre15">save</code> don't tell you much about how they apply to application requirements. Methods like <code class="calibre15">assignUser</code> are more descriptive, and your controller code is easier to understand. </p><p class="calibre_6"> When you decouple a model class from the DAO it uses, you can even design more than one model class for the same DAO. This is better for cohesion than trying to combine all work related to the given tables into a single class extending Active Record. </p><h3 class="calibre_8">Putting the Domain Model into Action</h3><p class="calibre_6">In <em class="calibre6">Domain-Driven Design: Tackling Complexity in the Heart of Software</em><a href="#calibre_link-263">[DDTCITHOS]</a> , Eric Evans describes a better solution: the <span>domain model</span>. </p><p class="calibre_6"> A model in the original MVC sense---not in the opinionated software sense---is an object-oriented representation of a <span>domain</span> in your application, that is, the business rules in your application and the data for those business rules. The model is where you implement business logic for the application; storing it in a database is an internal implementation detail of a model. </p><p class="calibre_6"> Once we have the model designed around concepts in our application, instead of database layout, we can start to implement database operations completely hidden within our model classes. Let's look at a possible refactoring of our earlier example code: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Magic-Beans/soln/domainmodel.php">Magic-Beans/soln/domainmodel.php</a></span></span></div><span class="calibre3"><code class="calibre15">&lt;?php</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;BugReport</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">protected</span>&nbsp;$bugsTable;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">protected</span>&nbsp;$accountsTable;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">protected</span>&nbsp;$productsTable;</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;__construct()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;bugsTable&nbsp;=&nbsp;Doctrine_Core::getTable("Bugs");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;accountsTable&nbsp;=&nbsp;Doctrine_Core::getTable("Accounts");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;productsTable&nbsp;=&nbsp;Doctrine_Core::getTable("Products");</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;create($summary,&nbsp;$description,&nbsp;$reportedBy)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug&nbsp;=&nbsp;<span class="calibre10">new</span>&nbsp;Bugs();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;summary&nbsp;=&nbsp;$summary</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;description&nbsp;=&nbsp;$description</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;status&nbsp;=&nbsp;"NEW";</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;reported_by&nbsp;=&nbsp;$reportedBy;</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;save();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;assignUser($bugId,&nbsp;$assignedTo)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug&nbsp;=&nbsp;$bugsTable-&gt;find($bugId);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;assigned_to&nbsp;=&nbsp;$assignedTo"];</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$bug-&gt;save();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;get($bugId)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">return</span>&nbsp;$bugsTable-&gt;find($bugId);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;search($status,&nbsp;$searchString)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$q&nbsp;=&nbsp;Doctrine_Query::create()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;from("Bugs&nbsp;b")</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;join("b.Products&nbsp;p")</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;where("b.status&nbsp;=&nbsp;?",&nbsp;$status)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;andWhere("MATCH(b.summary,&nbsp;b.description)&nbsp;AGAINST&nbsp;(?)",&nbsp;$searchString]);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">return</span>&nbsp;$q-&gt;fetchArray();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;AdminController&nbsp;<span class="calibre10">extends</span>&nbsp;Zend_Controller_Action</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;assignAction()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;bugReport-&gt;assignUser(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_getParam("bug"),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_getParam("user"));</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;BugController&nbsp;<span class="calibre10">extends</span>&nbsp;Zend_Controller_Action</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;enterAction()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$auth&nbsp;=&nbsp;Zend_Auth::getInstance();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="calibre10">if</span>&nbsp;($auth&nbsp;&amp;&amp;&nbsp;$auth-&gt;hasIdentity())&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$identity&nbsp;=&nbsp;$auth-&gt;getIdentity();</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;}</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;bugReport-&gt;create(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_getParam("summary"),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_getParam("description"),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$identity);</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;displayAction()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;view-&gt;bug&nbsp;=&nbsp;$this-&gt;bugReport-&gt;get(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_getParam("bug"));</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15"><span class="calibre10">class</span>&nbsp;SearchController&nbsp;<span class="calibre10">extends</span>&nbsp;Zend_Controller_Action</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<span class="calibre10">public</span>&nbsp;<span class="calibre10">function</span>&nbsp;bugsAction()</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;{</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;view-&gt;searchResults&nbsp;=&nbsp;$this-&gt;bugReport-&gt;search(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_getParam("status",&nbsp;"OPEN"),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_getParam("search"));</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;}</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">}</code></span><br class="calibre1" /></div><p class="calibre_6"> You should be able to notice several improvements: </p><ul class="calibre_14"><li class="calibre_15"> The class interaction diagram (shown in Figure <a href="#calibre_link-264"><em class="calibre6">Untangling the vines by decoupling</em></a>) is much simpler and easier to read, indicating an improvement in decoupling classes. </li><li class="calibre_15"> By decoupling the model's interface from its underlying database structure, we've reduced and simplified the code in the controller. </li><li class="calibre_15"> Each model class creates the objects to interact with one or more tables. The controllers do not need to know which tables are involved. </li><li class="calibre_15"> The model classes encapsulate and hide the database queries. The controller is concerned only with retrieving user inputs and invoking higher-level tasks through the model API. </li><li class="calibre_15"> In some cases, a query is too complex to do easily through a DAO, and writing custom SQL is needed. Using plain SQL seems less scary when it's safely encapsulated inside a model class. </li></ul><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Magic_beans/domainmodel.jpg" src="images/000028.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-264" class="calibre10">Figure 3. Untangling the vines by decoupling</span></td></tr></table></div><br class="calibre1" /><h3 class="calibre_8">Testing Plain Objects</h3><p class="calibre_6"> Ideally, you should be able to test your model without connecting to a live database. If you decouple your model from its DAO, then you can create <span>stub</span> and <span>mock</span> DAOs to help unit test your model. </p><p class="calibre_6"> Likewise, you can test the interface of a domain model just like any other object-oriented testing: call methods of the object, and then validate the method's return value. This is faster and easier than creating fake HTTP requests to feed to a controller and parsing the resulting HTTP response. </p><p class="calibre_6"> You still test your controllers with fake HTTP requests, but because the controller code is simpler, you don't need to test as many logical paths. </p><p class="calibre_6"> If you separate models and controllers and separate data access components from models, then you can unit test all these classes more simply and with better isolation. This makes it easier to diagnose defects when they occur. Isn't this the point of unit tests? </p><h3 class="calibre_8">Getting Down to Earth</h3><p class="calibre_6"> You can use a data access object productively in any software development framework, even one that encourages the Magic Beans antipattern. However, developers who don't learn how to employ object-oriented design principles are doomed to write spaghetti code. </p><p class="calibre_6"> The basics of domain modeling described and cited in this chapter will help you choose the best design to support testing and code maintenance. You'll finally be able to achieve great productivity developing database-driven applications. </p><p class="calibre_6">&nbsp;</p><table class="calibre17"><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6"><em class="calibre6">Decouple your models from your tables.</em></p></td></tr><tr class="calibre18"><td class="calibre19"><p class="calibre_6">&nbsp;</p></td></tr><tr class="calibre18"><td class="calibre19"><hr class="calibre7" /></td></tr></table><br class="calibre1" /><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-265" id="calibre_link-319">[35]</a>
<small class="calibre3">
<em class="calibre6">Facts and Fallacies of Software Engineering</em><a href="#calibre_link-43">[FAFOSE]</a> , p.60. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-266" id="calibre_link-46">[36]</a>
<small class="calibre3"> See <em class="calibre6">The Law of Leaky Abstractions</em><a href="#calibre_link-47">[TLOLA]</a> . </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-267" id="calibre_link-48">[37]</a>
<small class="calibre3"> See Active Record in <em class="calibre6">Patterns of Enterprise Application Architecture</em><a href="#calibre_link-114">[POEAA]</a> , p.160. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-268" id="calibre_link-49">[38]</a>
<small class="calibre3">
<a href="http://www.martinfowler.com/bliki/AnemicDomainModel.html">http://www.martinfowler.com/bliki/AnemicDomainModel.html</a>
</small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-269" id="calibre_link-305">[39]</a>
<small class="calibre3"> DRY was coined in <em class="calibre6">The Pragmatic Programmer</em><a href="#calibre_link-270">[TPPFJTM]</a> by Andy Hunt and Dave Thomas. </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-637"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-246">
<pagebreak>
<a id="calibre_link-638">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 class="calibre12" id="calibre_link-230"><small class="calibre13">Part 5</small><br class="calibre14" />Appendixes</h1><pagebreak><div class="calibre1" id="calibre_link-639"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-205">
<pagebreak>
<a id="calibre_link-640">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-167" class="calibre12"><small class="calibre13">Chapter 26</small><br class="calibre14" />Rules of Normalization</h1><hr class="calibre7" /><br class="calibre1" /><div class="calibre1"><hr class="calibre7" /><small class="calibre3"><div class="calibre1"><p class="calibre_6"><em class="calibre6"> Young man, in mathematics you don't understand things. You just get used to them. </em></p></div><div class="calibre1"><div class="calibre4"><span>John von Neumann</span></div></div></small><hr class="calibre7" /></div><p class="calibre_6"> Relational database design isn't arbitrary or mysterious. You can use a number of well-defined rules to design a data storage strategy that avoids redundancy and helps make your application mistake-proof, like the poka-yoke ideas mentioned earlier in this book. You've probably heard other metaphors for the same idea, such as <span>defensive design</span> or <span>fail early</span>. </p><p class="calibre_6"> The rules of normalization aren't complicated, but they are subtle. Developers often misunderstand how they work, perhaps because they expect the rules to be harder than they are. </p><p class="calibre_6"> Another possibility is that people are turned off by having to follow rules at all. Rules are the bête noire of developers who value newness, creativity, and innovation. Rules are in a way the opposite of freedom. </p><p class="calibre_6"> Software developers continually make trade-offs between simplicity and flexibility. You can make a lot of work for yourself by reinventing the wheel and developing custom data management software for every application. Or you can take advantage of existing knowledge and technology if you can conform to a relational design. </p><p class="calibre_6"> I've described the antipatterns in this book using their own merits (or faults) to avoid being too academic or theoretical. But in this appendix, we'll see that theory can also be practical. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-183">
<pagebreak>
<a id="calibre_link-641">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-642">What Does Relational Mean?</h2><p class="calibre_6"> This term <span>relational</span> doesn't refer to relationships between tables. It refers to the table itself, or rather, the relationship between columns within a table. In a way, it refers to both. </p><p class="calibre_6"> Mathematicians define a <span>relation</span> as the combination of two sets of values from different domains, with some condition applied that gives us a subset of all the possible combinations. </p><p class="calibre_6"> For example, one set is the names of baseball teams, and the other set is cities. The combination of every team to every city is a long list of pairings. But we're interested in a particular subset of this list: the teams paired with their home city. Valid pairs include <code class="calibre15">Chicago</code>/<code class="calibre15">White Sox</code>, <code class="calibre15">Chicago</code>/<code class="calibre15">Cubs</code>, or <code class="calibre15">Boston</code>/<code class="calibre15">Red Sox</code>, but not <code class="calibre15">Miami</code>/<code class="calibre15">Red Sox</code>. </p><p class="calibre_6"> The word <em class="calibre6">relation</em> is used in two ways: as a rule ("this city is the home city of that team") and as the subset of pairings that comply with the rule. In SQL, we can store that result in a table with two columns, and one row per pair. </p><p class="calibre_6"> Of course, relations support more than two columns. You can combine any number of domains, one per column, into a relation. Also, you can use domains like the set of 32-bit integers or the set of text strings of a specific length. </p><p class="calibre_6"> Before we can begin normalizing tables, we need to be sure that they are proper relations. They have to meet a few criteria. </p><h3 class="calibre_8">Rows Have No Order from Top to Bottom</h3><p class="calibre_6"> In SQL, a query returns results in an unpredictable order, unless you use an <code class="calibre15">ORDER&nbsp;BY</code> clause to specify the order. But apart from the order, the set of rows is the same. </p><h3 class="calibre_8">Columns Have No Order from Left to Right</h3><p class="calibre_6"> Whether we ask Steven to test the product Open RoundFile against bug #1234 or whether we need to know if bug #1234 can be verified in product Open RoundFile by Steven, the result should be the same. </p><p class="calibre_6"> This is related to the antipattern in the Chapter <a href="#calibre_link-184"><em class="calibre6">Implicit Columns</em></a>, where we would use columns by their position instead of by their name. </p><h3 class="calibre_8">Duplicate Rows Are Not Allowed</h3><p class="calibre_6"> Once you know a fact, stating it again doesn't make it any more true. Given the name of a baseball team, your data dictates the city. We say the city <span>depends on</span> the team name. </p><p class="calibre_6"> To prevent duplicates, we have to be able to tell one row from another and to address individual rows. To ensure this in SQL, we declare a primary key constraint for a column or set of columns, whatever is needed to uniquely identify rows. </p><p class="calibre_6"> We might have duplication among nonkey columns---there are two teams in the city of Boston---but the row as a whole is still unique because the team names are different. </p><h3 class="calibre_8">Every Column Has One Type, and One Value per Row</h3><p class="calibre_6"> A relation has a <span>header</span> that defines the names and data types of the columns. Every row must have the same columns as those in the header, and a given column must have the same meaning on all rows. </p><p class="calibre_6"> We saw an antipattern break this rule in two ways in the Chapter <a href="#calibre_link-102"><em class="calibre6">Entity-Attribute-Value</em></a>. First, the EAV table models an entity that can have a custom set of attributes for every instance, so the entity is not bound by any header that defines its attributes. </p><p class="calibre_6"> Second, the EAV <code class="calibre15">attr_value</code> column contains all the entity's attributes, such as the bug's date reported, the bug's status, the account the bug is assigned to, and so on. A given value like 1234 in this column may be valid for two different attributes but mean something totally different. </p><p class="calibre_6"> The antipattern in the Chapter <a href="#calibre_link-185"><em class="calibre6">Polymorphic Associations</em></a> also breaks this rule, because a given value like 1234 references the primary key of any of the multiple parent tables. You can't say 1234 on one row means the same thing as 1234 on another row. </p><h3 class="calibre_8">Rows Have No Hidden Components</h3><p class="calibre_6"> Columns contain data values, not physical storage indicators such as row IDs or object IDs. Above in the Chapter <a href="#calibre_link-186"><em class="calibre6">Pseudokey Neat-Freak</em></a>, we saw that primary keys are unique, but they aren't row numbers. </p><p class="calibre_6"> Some databases bend this rule, giving you access to internal storage details with extensions to SQL (for example, the <code class="calibre15">ROWNUM</code> pseudocolumn in Oracle or <code class="calibre15">OID</code> in PostgreSQL). However, these values aren't properly part of the relation. </p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-163">
<pagebreak>
<a id="calibre_link-643">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-644">Myths About Normalization</h2><p class="calibre_6"> It's hard to find a subject that is so widely misunderstood, despite having a precise definition. You are practically guaranteed to encounter developers who express with complete confidence untruths such as these: </p><ul class="calibre_14"><li class="calibre_15"> "Normalization makes a database slower. Denormalization makes a database faster." <br class="calibre_16" /><em class="calibre6">False.</em> It's true that you may need to use a join to retrieve attributes from separate tables after you apply normalization. If you denormalize data, you can avoid some joins. <br class="calibre_16" /> For example, the comma-separated list in the Chapter <a href="#calibre_link-140"><em class="calibre6">Jaywalking</em></a> stores products for a given bug. But what if you also need a list of bugs for a given product? Denormalization usually helps convenience or performance for one type of query, but at a great cost for some other types of queries. <br class="calibre_16" /> There are legitimate uses for denormalization. But you should model your database in a normal form first, before deciding to use denormaliziation. The <span>MENTOR</span> guide for indexing in the Chapter <a href="#calibre_link-164"><em class="calibre6">Index Shotgun</em></a> applies to denormalization too: be sure you measure performance both before and after you implement a change for the sake of efficiency. </li><li class="calibre_15"> "Normalization says to push the data out to child tables and reference it using a pseudokey." <br class="calibre_16" /><em class="calibre6">False.</em> You can use pseudokeys for the goal of convenience, performance, or storage efficiency, and those reasons are legitimate. But don't believe that it has anything to do with normalization. </li><li class="calibre_15"> "Normalization is where you separate attributes as much as possible, such as in the Entity-Attribute-Value design." <br class="calibre_16" /><em class="calibre6">False.</em> It's common for developers to use the word <em class="calibre6">normalization</em> inaccurately, implying that it makes data less human-readable or less convenient to query. In fact, the opposite is true. </li><li class="calibre_15"> "No one needs to normalize past the third normal form. The other normal forms are so esoteric that you'll never encounter them." <br class="calibre_16" /><em class="calibre6">False.</em> One study showed that more than 20 percent of business databases contain designs that satisfy the first three normal forms but violate the fourth normal form. This is a minority, but it's far from insignificant. If you learn of a bug that potentially results in data loss and occurs in 20 percent of your applications, wouldn't you want to fix it? </li></ul></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-137">
<pagebreak>
<a id="calibre_link-645">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-646">What Is Normalization?</h2><p class="calibre_6"> The following are the objectives of normalization: </p><ul class="calibre_14"><li class="calibre_15"> To represent facts about the real world in a way that we can understand </li><li class="calibre_15"> To reduce storing facts redundantly and to prevent anomalous or inconsistent data </li><li class="calibre_15"> To support integrity constraints </li></ul><p class="calibre_6"> Notice that improving database performance is not on this list. Normalization helps us store data <span>correctly</span> and avoid getting into trouble. It's practically inevitable that a database that is not normalized becomes a mess. We find ourselves developing a lot more code to clean up inconsistent or duplicate data. We experience delays and expenses to our businesses from faulty data. If you include these scenarios, the benefits to performance from normalizing a database become clearer. </p><p class="calibre_6"> When a table satisfies rules of normalization, we say the table is in <span>normal form</span>. There are five traditional normal forms, describing progressive levels of normalization. Each normal form eliminates a specific type of redundancy or anomaly when you design a relation. Generally, if your table satisfies a normal form, the table also satisfies all the preceding normal forms. There are three additional normal forms that researchers have described. The progression of normal forms is shown in Figure <a href="#calibre_link-138"><em class="calibre6">Progression of normal forms</em></a>. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Normalization/Normal_Forms.jpg" src="images/000024.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-138" class="calibre10">Figure 1. Progression of normal forms</span></td></tr></table></div><br class="calibre1" /><h3 class="calibre_8">First Normal Form</h3><p class="calibre_6"> The most fundamental requirement for first normal form is that the table must be a relation. If it doesn't meet the criteria for a relation described in the first section, then your table can't be in first normal form or any of the subsequent normal forms. </p><p class="calibre_6"> The next requirement is that the table must not have any <span>repeating groups</span>. Remember that each row in a relation is a combination between several sets, choosing one value from each set. A repeating group means that one row may have multiple values from the given set. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Normalization/1NF.jpg" src="images/000022.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-141" class="calibre10">Figure 2. Repeating groups vs. first normal form</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> We saw two antipatterns that create repeating groups: </p><ul class="calibre_14"><li class="calibre_15"> Multiple values from the same domain across multiple columns, in the Chapter <a href="#calibre_link-139"><em class="calibre6">Multicolumn Attributes</em></a></li><li class="calibre_15"> Multiple values within a single column, in the Chapter <a href="#calibre_link-140"><em class="calibre6">Jaywalking</em></a></li></ul><p class="calibre_6"> In Figure <a href="#calibre_link-141"><em class="calibre6">Repeating groups vs. first normal form</em></a>, we can see repeating groups according to each of these antipatterns. The proper design that satisfies first normal form is to create a separate table. Tags now occupy a single column, and we can support multiple tags by storing one tag per row. </p><h3 class="calibre_8">Second Normal Form</h3><p class="calibre_6"> The second normal form is identical to the first normal form, unless your table has a compound primary key. In the tagging example, let's keep track of which user chose to apply each given tag to a bug. We're also interested in who first coined a given tag. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Normalization/2NF-anti.sql">Normalization/2NF-anti.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsTags&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;tag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;tagger&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;coiner&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(bug_id,&nbsp;tag),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(tagger)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(coiner)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Normalization/2NF.jpg" src="images/000019.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-142" class="calibre10">Figure 3. Redundancy vs. second normal form</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> In Figure <a href="#calibre_link-142"><em class="calibre6">Redundancy vs. second normal form</em></a>, we can see that the identity of the coiner is stored redundantly.<a href="#calibre_link-143" id="calibre_link-109">[40]</a> This means someone might create an <span>anomaly</span> by changing the identity of the coiner on one row for a given tag (<code class="calibre15">crash</code>) without changing all rows for the same tag. </p><p class="calibre_6"> To satisfy second normal form, we should store the coiner for a given tag only once. That means we have to define another table, <code class="calibre15">Tags</code>, where the tag is the primary key, so there's bound to be only one row per distinct tag. Then we can store the coiner of that tag in this new table instead of in <code class="calibre15">BugsTags</code> and prevent anomalies. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Normalization/2NF-normal.sql">Normalization/2NF-normal.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Tags&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;tag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20)&nbsp;PRIMARY&nbsp;KEY,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;coiner&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(coiner)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsTags&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;tag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARCHAR(20)&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;tagger&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(bug_id,&nbsp;tag),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(tag)&nbsp;REFERENCES&nbsp;Tags(tag),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(tagger)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><h3 class="calibre_8">Third Normal Form</h3><p class="calibre_6"> In the <code class="calibre15">Bugs</code> table, you might want to store the email of the engineer working on the bug. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Normalization/3NF-anti.sql">Normalization/3NF-anti.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;Bugs&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;SERIAL&nbsp;PRIMARY&nbsp;KEY</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;<em class="calibre6">--&nbsp;.&nbsp;.&nbsp;.</em></code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;assigned_to&nbsp;BIGINT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;assigned_email&nbsp;VARCHAR(100),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(assigned_to)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> However, the email is an attribute of the assigned engineer's account; it's not strictly an attribute of the bug. It's redundant to store the email in this way, and we risk anomalies like in the table that fails second normal form. </p><p class="calibre_6"> In the example for second normal form the offending column is related to at least <em class="calibre6">part</em> of the compound primary key. In this example, that violates third normal form, the offending column doesn't correspond to the primary key at all. </p><p class="calibre_6"> To fix this, we need to put the email address into the <code class="calibre15">Accounts</code> table. See how you can separate the column from the <code class="calibre15">Bugs</code> table in Figure <a href="#calibre_link-144"><em class="calibre6">Redundancy vs. third normal form</em></a>. That's the right place because the email corresponds directly to the primary key of that table, without redundancy. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Normalization/3NF.jpg" src="images/000017.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-144" class="calibre10">Figure 4. Redundancy vs. third normal form</span></td></tr></table></div><br class="calibre1" /><h3 class="calibre_8">Boyce-Codd Normal Form</h3><p class="calibre_6"> A slightly stronger version of third normal form is called Boyce-Codd normal form. The difference between these two normal forms is that in third normal form, all nonkey attributes must depend on the key of the table. In Boyce-Codd normal form, key columns are subject to this rule as well. This would come up only when the table has multiple sets of columns that <em class="calibre6">could</em> serve as the table's key. </p><p class="calibre_6"> For example, suppose we have three tag types: tags that describe the impact of the bug, tags for the subsystem the bug affects, and tags that describe the fix for the bug. We decide that each bug must have at most one tag of each type. Our candidate key could be <code class="calibre15">bug_id</code> plus <code class="calibre15">tag</code>, but it could also be <code class="calibre15">bug_id</code> plus <code class="calibre15">tag_type</code>. Either pair of columns would be specific enough to address every row individually. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Normalization/BCNF.jpg" src="images/000015.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-145" class="calibre10">Figure 5. Third normal form vs. Boyce-Codd normal form</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> In Figure <a href="#calibre_link-145"><em class="calibre6">Third normal form vs. Boyce-Codd normal form</em></a>, we see an example of a table that is in third normal form, but not Boyce-Codd normal form, and how to change it. </p><h3 class="calibre_8">Fourth Normal Form</h3><p class="calibre_6"> Now let's alter our database to allow each bug to be reported by multiple users, assigned to multiple development engineers, and verified by multiple quality engineers. We know that a many-to-many relationship deserves an additional table: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Normalization/4NF-anti.sql">Normalization/4NF-anti.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsAccounts&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by&nbsp;&nbsp;BIGINT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;assigned_to&nbsp;&nbsp;BIGINT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;verified_by&nbsp;&nbsp;BIGINT,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(reported_by)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(assigned_to)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(verified_by)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> We can't use <code class="calibre15">bug_id</code> alone as the primary key. We need multiple rows per bug so we can support multiple accounts in each column. We also can't declare a primary key over the first two or the first three columns, because that would still fail to support multiple values in the last column. So, the primary key would need to be over all four columns. However, <code class="calibre15">assigned_to</code> and <code class="calibre15">verified_by</code> should be nullable, because bugs can be reported before being assigned or verified, All primary key columns standardly have a <code class="calibre15">NOT&nbsp;NULL</code> constraint. </p><p class="calibre_6"> Another problem is that we may have redundant values when any column contains fewer accounts than some other column. The redundant values are shown in Figure <a href="#calibre_link-146"><em class="calibre6">Merged relationships vs. fourth normal form</em></a>. </p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Normalization/4NF.jpg" src="images/000013.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-146" class="calibre10">Figure 6. Merged relationships vs. fourth normal form</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> All the problems shown previously are caused by trying to create an intersection table that does double-duty---or triple-duty in this case. When you try to use a single intersection table to represent multiple many-to-many relationships, it violates fourth normal form. </p><p class="calibre_6"> The figure shows how we can solve this by splitting the table so that we have one intersection table for each type of many-to-many relationship. This solves the problems of redundancy and mismatched numbers of values in each column. </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Normalization/4NF-normal.sql">Normalization/4NF-normal.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsReported&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;reported_by&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(bug_id,&nbsp;reported_by),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(reported_by)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsAssigned&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;assigned_to&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(bug_id,&nbsp;assigned_to),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(assigned_to)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsVerified&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;verified_by&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(bug_id,&nbsp;verified_by),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(verified_by)&nbsp;REFERENCES&nbsp;Accounts(account_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><h3 class="calibre_8">Fifth Normal Form</h3><p class="calibre_6"> Any table that meets the criteria of Boyce-Codd normal form and does not have a compound primary key is already in fifth normal form. But to understand fifth normal form, let's work through an example. </p><p class="calibre_6"> Some engineers work only on certain products. We should design our database so that we know the facts of who works on which products and which bugs, with a minimum of redundancy. Our first try at supporting this is to add a column to our <code class="calibre15">BugsAssigned</code> table to show that a given engineer works on a product: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Normalization/5NF-anti.sql">Normalization/5NF-anti.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsAssigned&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;assigned_to&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(bug_id,&nbsp;assigned_to),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(assigned_to)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> This doesn't tell us which products we may assign the engineer to work on; it only tells us which products the engineer is currently assigned to work on. It also stores the fact that an engineer works on a given product redundantly. This is caused by trying to store multiple facts about independent many-to-many relationships in a single table, similar to the problem we saw in the fourth normal form. The redundancy is illustrated in Figure <a href="#calibre_link-147"><em class="calibre6">Merged relationships vs. fifth normal form</em></a>.<a href="#calibre_link-148" id="calibre_link-110">[41]</a></p><div class="calibre1"><table class="calibre17"><tr class="calibre18"><td class="calibre19"><div class="calibre1"><img alt="Normalization/5NF.jpg" src="images/000010.jpg" class="calibre20" /></div></td></tr><tr class="calibre18"><td class="calibre_10"><hr class="calibre7" /><span id="calibre_link-147" class="calibre10">Figure 7. Merged relationships vs. fifth normal form</span></td></tr></table></div><br class="calibre1" /><p class="calibre_6"> Our solution is to isolate each relationship into separate tables: </p><div class="calibre_11"><div background="gray" class="calibre_12"><span class="underline"><span class="calibre3"><a href="http://media.pragprog.com/titles/bksqla/code/Normalization/5NF-normal.sql">Normalization/5NF-normal.sql</a></span></span></div><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;BugsAssigned&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;bug_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;assigned_to&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(bug_id,&nbsp;assigned_to),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(bug_id)&nbsp;REFERENCES&nbsp;Bugs(bug_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(assigned_to)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /><br class="calibre1" /><span class="calibre3"><code class="calibre15">CREATE&nbsp;TABLE&nbsp;EngineerProducts&nbsp;(</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;account_id&nbsp;&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;product_id&nbsp;&nbsp;&nbsp;BIGINT&nbsp;NOT&nbsp;NULL,</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(account_id,&nbsp;product_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(account_id)&nbsp;REFERENCES&nbsp;Accounts(account_id),</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">&nbsp;&nbsp;FOREIGN&nbsp;KEY&nbsp;(product_id)&nbsp;REFERENCES&nbsp;Products(product_id)</code></span><br class="calibre1" /><span class="calibre3"><code class="calibre15">);</code></span><br class="calibre1" /></div><p class="calibre_6"> Now we can record the fact that an engineer is available to work on a given product, independently from the fact that the engineer is working on a given bug for that product. </p><h3 class="calibre_8">Further Normal Forms</h3><p class="calibre_6"><span>Domain-Key normal form</span> (DKNF) says that every constraint on a table is a logical consequence of the table's domain constraints and key constraints. Normal forms three, four, five, and Boyce-Codd normal form are all encompassed by DKNF. </p><p class="calibre_6"> For example, you may decide that a bug that has a status of <code class="calibre15">NEW</code> or <code class="calibre15">DUPLICATE</code> has resulted in no work, so there should be no <code class="calibre15">hours</code> logged, and also it makes no sense to assign a quality engineer in the <code class="calibre15">verified_by</code> column. You might implement these constraints with a trigger or a <code class="calibre15">CHECK</code> constraint. These are constraints between nonkey columns of the table, so they don't meet the criteria of DKNF. </p><p class="calibre_6"><span>Sixth normal form</span> seeks to eliminate all join dependencies. It's typically used to support a history of changes to attributes. For example, the <code class="calibre15">Bugs.status</code> changes over time, and we might want to record this history in a child table, as well as when the change occurred, who made the change, and perhaps other details. </p><p class="calibre_6"> You can imagine that for <code class="calibre15">Bugs</code> to support sixth normal form fully, nearly every column may need a separate accompanying history table. This leads to an overabundance of tables. Sixth normal form is overkill for most applications, but some data warehousing techniques use it.<a href="#calibre_link-149" id="calibre_link-111">[42]</a></p></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-108">
<pagebreak>
<a id="calibre_link-647">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h2 class="calibre_7" id="calibre_link-648">Common Sense</h2><p class="calibre_6"> Rules of normalization aren't esoteric or complicated. They're really just a commonsense technique to reduce redundancy and improve consistency of data. </p><p class="calibre_6"> You can use this brief overview of relations and normal forms as an quick reference to help you design better databases in future projects. <br class="calibre1" /></p><hr class="calibre7" /><h4 class="calibre21">Footnotes</h4><br class="calibre_13" /><a href="#calibre_link-109" id="calibre_link-143">[40]</a>
<small class="calibre3"> The figure uses names instead of ID numbers for the user identities. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-110" id="calibre_link-148">[41]</a>
<small class="calibre3"> The figure uses names instead of ID numbers for the products. </small><br class="calibre_12" /><br class="calibre_13" /><a href="#calibre_link-111" id="calibre_link-149">[42]</a>
<small class="calibre3"> For example, Anchor Modeling uses it (<a href="http://www.anchormodeling.com/">http://www.anchormodeling.com/</a>). </small><br class="calibre_12" /><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><pagebreak><div class="calibre1" id="calibre_link-649"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


<div class="calibre" id="calibre_link-97">
<pagebreak>
<a id="calibre_link-650">
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<pagebreak>
<h1 id="calibre_link-231" class="calibre12"><small class="calibre13">Chapter 27</small><br class="calibre14" />Bibliography</h1><hr class="calibre7" /><br class="calibre1" /><div id="calibre_link-651" class="calibre1"><table cellspacing="3" class="calibre17"><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-43">[A]</a></td><td class="calibre19"><em class="calibre6">AntiPatterns</em>, William J. Brown and Raphael C. Malveau and Hays W. {McCormick III, 1998. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-47">[SPT]</a></td><td class="calibre19"><em class="calibre6">SQL Performance Tuning</em>, Peter Gulutzan and Trudy Pelzer, 2003. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-114">[HPM]</a></td><td class="calibre19"><em class="calibre6">High Performance MySQL</em>, Baron Schwartz and Peter Zaitsev and Vadim Tkachenko and Jeremy Zawodny and Arjen Lentz and Derek J. Balling, 2008. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-270">[JCTAHISFS]</a></td><td class="calibre19"><em class="calibre6">Joe Celko's Trees and Hierarchies in SQL for Smarties</em>, Joe Celko, 2004. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-262">[SDP]</a></td><td class="calibre19"><em class="calibre6">SQL Design Patterns</em>, Vadim Tropashko, 2006. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-263">[JCSPS]</a></td><td class="calibre19"><em class="calibre6">Joe Celko's SQL Programming Style</em>, Joe Celko, 2005. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-652">[ARMODFLSDB]</a></td><td class="calibre19"><em class="calibre6">A Relational Model of Data for Large Shared Data Banks</em>, Edgar F. Codd, 1970. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-653">[POEAA]</a></td><td class="calibre19"><em class="calibre6">Patterns of Enterprise Application Architecture</em>, Martin Fowler, 2003. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-654">[WECSSKAFA]</a></td><td class="calibre19"><em class="calibre6">What Every Computer Scientist Should Know About Floating-Point Arithmetic</em>, David Goldberg, 1991. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-655">[DSOSS]</a></td><td class="calibre19"><em class="calibre6">19 Deadly Sins of Software Security</em>, Michael Howard and David LeBlanc and John Viega, 2005. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-656">[AWDWR]</a></td><td class="calibre19"><em class="calibre6">Agile Web Development with Rails</em>, Sam Ruby and David Thomas and David Heinemeier Hansson, 2008. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-657">[FAFOSE]</a></td><td class="calibre19"><em class="calibre6">Facts and Fallacies of Software Engineering</em>, Robert L. Glass, 1992. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-658">[TLOLA]</a></td><td class="calibre19"><em class="calibre6">The Law of Leaky Abstractions</em>, Joel Spolsky, 2002. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-659">[POEAA]</a></td><td class="calibre19"><em class="calibre6">Patterns of Enterprise Application Architecture</em>, Martin Fowler, 2003. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-660">[TPPFJTM]</a></td><td class="calibre19"><em class="calibre6">The Pragmatic Programmer: From Journeyman to Master</em>, Andrew Hunt and David Thomas, 2000. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-661">[AUAPAITOAADAID]</a></td><td class="calibre19"><em class="calibre6">Applying UML and Patterns: an Introduction to Object-Oriented Analysis and Design and Iterative Development</em>, Craig Larman, 2004. </td></tr><tr valign="top" class="calibre18"><td class="calibre19"><a id="calibre_link-662">[DDTCITHOS]</a></td><td class="calibre19"><em class="calibre6">Domain-Driven Design: Tackling Complexity in the Heart of Software</em>, Eric Evans, 2003. </td></tr></table></div><br class="calibre_4" /><div class="calibre_5"><small class="calibre3"><em class="calibre6">Copyright (c) 2010, The Pragmatic Bookshelf.</em></small></div><div class="mbp_pagebreak" id="calibre_link-663"></div>
</pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></pagebreak></a></pagebreak></div>


</body></html>