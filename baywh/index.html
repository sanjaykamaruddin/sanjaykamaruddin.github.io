<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link href="style.css" rel="stylesheet" type="text/css" /><title>Build APIs You Won't Hate</title></head><body><div dir="ltr" class="calibre" id="calibre_link-99">
  <h2 class="calibre1">Build APIs You Won't Hate</h2>

  <h3 class="calibre2">Everyone and their dog wants an API, so you should probably learn how to build them.</h3>
  <p class="calibre3">&nbsp;</p>

  <h4 class="calibre4">Phil Sturgeon</h4>
  <p class="calibre3">&nbsp;</p>
  <p class="calibre3">This book is for sale at <a href="http://leanpub.com/build-apis-you-wont-hate">http://leanpub.com/build-apis-you-wont-hate</a></p>
  <p class="calibre3">This version was published on 2015-08-12</p>
  <p class="calibre3"><img src="images/000008.png" id="calibre_link-105" alt="publisher&apos;s logo" class="calibre5" /></p>
    <p class="calibre3">*&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;*</p>
  <p class="calibre3">This is a <a href="http://leanpub.com">Leanpub</a> book. Leanpub empowers authors and publishers with the Lean Publishing process. <a href="http://leanpub.com/manifesto">Lean Publishing</a> is the act of publishing an in-progress ebook using lightweight tools and many iterations to get reader feedback, pivot until you have the right book and build traction once you do.</p>
  <p class="calibre3">*&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;*</p>

  <p class="calibre3"></p>
<div class="calibre6">© 2013 - 2015 Phil Sturgeon</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-100">
  <section class="dedication" type="dedication">
    <p class="calibre3">A huge thank you to all the developers and other folks who built the technologies this book talks about.  </p>

<p class="calibre3">I would also like to thank everyone who bought an early copy of this book on LeanPub. 2014 was a really messed up year for me, and those book sales kept me going, and kept me motivated to finish the book on time.</p>

<p class="calibre3">Without you, I would be much further away from getting my boat.</p>
  </section>
</div>


<div dir="ltr" class="calibre" id="calibre_link-0">
      <section type="frontmatter toc">
         <header>
            <h2 id="calibre_link-106" class="calibre7">Table of Contents</h2>
         </header>

         <nav type="toc">
           <ol class="toc">
  <li class="calibre8">
    <a href="#calibre_link-1" class="calibre9">Introduction</a>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-2" class="calibre9">Sample Code</a>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-3" class="calibre9"><span class="section-number">1. </span>Useful Database Seeding</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-4" class="calibre9"><span class="section-number">1.1 </span>Introduction</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-5" class="calibre9"><span class="section-number">1.2 </span>Introduction to Database Seeding</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-6" class="calibre9"><span class="section-number">1.3 </span>Building Seeders</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-7" class="calibre9"><span class="section-number">1.4 </span>That is about it</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-8" class="calibre9"><span class="section-number">1.5 </span>Secondary Data</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-9" class="calibre9"><span class="section-number">1.6 </span>When to run this?</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-10" class="calibre9"><span class="section-number">2. </span>Planning and Creating Endpoints</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-11" class="calibre9"><span class="section-number">2.1 </span>Functional Requirements</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-12" class="calibre9"><span class="section-number">2.2 </span>Endpoint Theory</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-13" class="calibre9"><span class="section-number">2.3 </span>Planning Endpoints</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-14" class="calibre9"><span class="section-number">3. </span>Input and Output Theory</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-15" class="calibre9"><span class="section-number">3.1 </span>Introduction</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-16" class="calibre9"><span class="section-number">3.2 </span>Requests</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-17" class="calibre9"><span class="section-number">3.3 </span>Responses</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-18" class="calibre9"><span class="section-number">3.4 </span>Supporting Formats</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-19" class="calibre9"><span class="section-number">3.5 </span>Content Structure</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-20" class="calibre9"><span class="section-number">4. </span>Status Codes, Errors and Messages</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-21" class="calibre9"><span class="section-number">4.1 </span>Introduction</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-22" class="calibre9"><span class="section-number">4.2 </span>HTTP Status Codes</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-23" class="calibre9"><span class="section-number">4.3 </span>Error Codes and Error Messages</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-24" class="calibre9"><span class="section-number">4.4 </span>Error or Errors</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-25" class="calibre9"><span class="section-number">4.5 </span>Standards for Error Responses</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-26" class="calibre9"><span class="section-number">4.6 </span>Common Pitfalls</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-27" class="calibre9"><span class="section-number">5. </span>Endpoint Testing</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-28" class="calibre9"><span class="section-number">5.1 </span>Introduction</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-29" class="calibre9"><span class="section-number">5.2 </span>Concepts &amp; Tools</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-30" class="calibre9"><span class="section-number">5.3 </span>Setup</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-31" class="calibre9"><span class="section-number">5.4 </span>Initialise</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-32" class="calibre9"><span class="section-number">5.5 </span>Features</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-33" class="calibre9"><span class="section-number">5.6 </span>Scenarios</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-34" class="calibre9"><span class="section-number">5.7 </span>Prepping Behat</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-35" class="calibre9"><span class="section-number">5.8 </span>Running Behat</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-36" class="calibre9"><span class="section-number">6. </span>Outputting Data</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-37" class="calibre9"><span class="section-number">6.1 </span>Introduction</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-38" class="calibre9"><span class="section-number">6.2 </span>The Direct Approach</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-39" class="calibre9"><span class="section-number">6.3 </span>Transformations with Fractal</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-40" class="calibre9"><span class="section-number">6.4 </span>Hiding Schema Updates</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-41" class="calibre9"><span class="section-number">6.5 </span>Outputting Errors</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-42" class="calibre9"><span class="section-number">6.6 </span>Testing this Output</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-43" class="calibre9"><span class="section-number">6.7 </span>Homework</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-44" class="calibre9"><span class="section-number">7. </span>Data Relationships</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-45" class="calibre9"><span class="section-number">7.1 </span>Introduction</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-46" class="calibre9"><span class="section-number">7.2 </span>Subresources</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-47" class="calibre9"><span class="section-number">7.3 </span>Foreign Key Arrays</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-48" class="calibre9"><span class="section-number">7.4 </span>Compound Documents (aka Sideloading)</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-49" class="calibre9"><span class="section-number">7.5 </span>Embedded Documents (aka Nesting)</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-50" class="calibre9"><span class="section-number">7.6 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-51" class="calibre9"><span class="section-number">8. </span>Debugging</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-52" class="calibre9"><span class="section-number">8.1 </span>Introduction</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-53" class="calibre9"><span class="section-number">8.2 </span>Command-line Debugging</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-54" class="calibre9"><span class="section-number">8.3 </span>Browser Debugging</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-55" class="calibre9"><span class="section-number">8.4 </span>Network Debugging</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-56" class="calibre9"><span class="section-number">9. </span>Authentication</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-57" class="calibre9"><span class="section-number">9.1 </span>Introduction</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-58" class="calibre9"><span class="section-number">9.2 </span>When is Authentication Useful?</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-59" class="calibre9"><span class="section-number">9.3 </span>Different Approaches to Authentication</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-60" class="calibre9"><span class="section-number">9.4 </span>Implementing an OAuth 2.0 Server</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-61" class="calibre9"><span class="section-number">9.5 </span>Where the OAuth 2.0 Server Lives</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-62" class="calibre9"><span class="section-number">9.6 </span>Understanding OAuth 2.0 Grant Types</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-63" class="calibre9"><span class="section-number">10. </span>Pagination</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-64" class="calibre9"><span class="section-number">10.1 </span>Introduction</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-65" class="calibre9"><span class="section-number">10.2 </span>Paginators</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-66" class="calibre9"><span class="section-number">10.3 </span>Offsets and Cursors</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-67" class="calibre9"><span class="section-number">11. </span>Documentation</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-68" class="calibre9"><span class="section-number">11.1 </span>Introduction</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-69" class="calibre9"><span class="section-number">11.2 </span>Types of Documentation</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-70" class="calibre9"><span class="section-number">11.3 </span>Picking a Tool</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-71" class="calibre9"><span class="section-number">11.4 </span>Setting up API Blueprint and Aglio</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-72" class="calibre9"><span class="section-number">11.5 </span>Learning API Blueprint Syntax</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-73" class="calibre9"><span class="section-number">11.6 </span>Further Reading</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-74" class="calibre9"><span class="section-number">12. </span>HATEOAS</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-75" class="calibre9"><span class="section-number">12.1 </span>Introduction</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-76" class="calibre9"><span class="section-number">12.2 </span>Content Negotiation</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-77" class="calibre9"><span class="section-number">12.3 </span>Hypermedia Controls</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-78" class="calibre9"><span class="section-number">13. </span>API Versioning</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-79" class="calibre9"><span class="section-number">13.1 </span>Introduction</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-80" class="calibre9"><span class="section-number">13.2 </span>Different Approaches to API Versioning</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-81" class="calibre9"><span class="section-number">13.3 </span>Ask Your Users</a>
      </li>
    </ol>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-82" class="calibre9">Conclusion</a>
  </li>
  <li class="calibre8">
    <a href="#calibre_link-83" class="calibre9">Further Reading</a>
    <ol class="calibre10">
      <li class="calibre11">
        <a href="#calibre_link-84" class="calibre9">API Web Resources</a>
      </li>
      <li class="calibre11">
        <a href="#calibre_link-85" class="calibre9">Non-API Books</a>
      </li>
    </ol>
  </li>
</ol>

         </nav>

         <nav type="landmarks" id="calibre_link-107" class="calibre12">
            <h2 class="calibre1">Guide</h2>
            <ol class="calibre13">
               <li class="calibre14">
                  <a type="bodymatter" href="#calibre_link-86">Begin Reading</a>
               </li>
            </ol>
         </nav>
</section>
</div>


<div dir="ltr" class="calibre" id="calibre_link-86">
<div class="calibre6">
<h2 id="calibre_link-1" class="calibre1">Introduction</h2>

<p class="calibre3">A lot of articles and tutorials talk about REST and with a varying level of accuracy. Some claim that
certain things are more RESTful than others whilst actually having very little to do with REST.
The word REST has been so utterly misused for the last seven or eight years that it actually means
nothing anymore, and a large chunk of the API development community has moved to terms like Hypermedia
API to represent what was intended by the original meaning of REST before it was utterly ruined. This book
will not get too hung up on these politics. It will mostly outline the pros and cons of various approaches,
only giving you the “one true way” when the other approaches are all patently awful (like SOAP and XML-RPC).</p>

<p class="calibre3">Whilst trying to learn about API development, I found most resources out there to be horribly lacking or
specifically aimed at one single framework. Many tutorials and books use apples and pears examples that are
not concrete enough, or talk like listing <code class="calibre15">/users</code> and <code class="calibre15">/users/1</code> are the only endpoints you will ever need.
Between 2012 and 2014, I worked for a company called Kapture where my primary function was to inherit,
rebuild, maintain and further develop a fairly large API with many different endpoints exposing a lot of
different use cases.</p>

<p class="calibre3">This book will discuss the theory of designing and building APIs in any language or framework. This theory will
be applied in examples built mostly in PHP, with some Ruby and Python too. The book will not be too code-heavy
regardless, since reading code is no fun.</p>

<p class="calibre3">By the end of this book, you will have built an API that can create, read, update, delete things, handle searching,
and do everything else a good Hypermedia API needs to do.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-91">
<div class="calibre6">
<h2 id="calibre_link-2" class="calibre1">Sample Code</h2>

<p class="calibre3">This book covers both theory which is applicable to any language, and it covers concrete examples using source code written in PHP. 
PHP was selected mostly because it had to be written in something, but all content is applicable to any language.</p>

<p class="calibre3">The code can be downloaded in a few ways.</p>

<p class="calibre3">a) You can clone it:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code>git clone https://github.com/philsturgeon/build-apis-you-wont-hate.git
</pre></div>

</figure>

<p class="calibre3">b) Browse around it:</p>

<blockquote class="calibre17">
  <p class="calibre3">https://github.com/philsturgeon/build-apis-you-wont-hate</p>
</blockquote>

<p class="calibre3">c) Download it as a <code class="calibre15">.zip</code> file:</p>

<blockquote class="calibre17">
  <p class="calibre3">http://bit.ly/apisyouwonthate-zip</p>
</blockquote>

<p class="calibre3">The book assumes a few things in relation to this same code.</p>

<ol class="calibre13">
  <li class="calibre14">You have PHP 5.4 available.</li>
  <li class="calibre14">You are ok playing with Laravel 4, even if you have no experience with it.</li>
  <li class="calibre14">You place the contents in <code class="calibre15">~/apisyouwonthate</code>.</li>
</ol>

<p class="calibre3">If you put the sample code somewhere else, then update the path in the examples.</p>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-87">
<div class="calibre6">
<h2 id="calibre_link-3" class="calibre1">
<span class="section-number">1. </span>Useful Database Seeding</h2>

<h3 id="calibre_link-4" class="calibre2">
<span class="section-number">1.1 </span>Introduction</h3>

<p class="calibre3">The first step to creating any sort of application is creating the database. Whether you are using some sort of relational platform, MongoDB, Riak, or whatever, you will need a vague idea of how your data is going to be stored.</p>

<p class="calibre3">For relational databases it is very likely you will start off your planning with an entity-relationship diagram. For document based databases such as MongoDB, CouchDB or ElasticSearch, you will just let your application magically build a schema. Either way, you need to create a plan - even if it is on a napkin. This book will assume a traditional relational database is storing your data, but the principles are easily adapted for NoSQL systems too.</p>

<p class="calibre3">This chapter assumes you have already got a database designed and built. This chapter skips the “planning a database” section, because there are plenty of other books on that already.</p>

<h3 id="calibre_link-5" class="calibre2">
<span class="section-number">1.2 </span>Introduction to Database Seeding</h3>

<p class="calibre3">With a database schema designed and implemented, the next step is to store some data. Instead of entering your real data, it is far easier to use “dummy data” to test if the schema is appropriate for your API application. This brings the added benefit of letting you ditch the database and try again without worrying about maintaining the data.</p>

<p class="calibre3">The process of populating a database is known as “seeding”.</p>

<p class="calibre3">This data could be:</p>

<ul class="calibre18">
  <li class="calibre14">test users</li>
  <li class="calibre14">content entries with a bunch of comments</li>
  <li class="calibre14">fake locations available for check-in</li>
  <li class="calibre14">fake notifications to display in an iPhone app (one of each type)</li>
  <li class="calibre14">credit-card payments at various stages of processing - with some complete, some half done and some super-fraudulent looking ones</li>
</ul>

<p class="calibre3">The process of creating seeding scripts means you can avoid wasting time creating them manually over and over again. Ultimately, the more processes you can automate during the development of your API, the more time you have to consider the intricacies of your applications, which need much more consideration.</p>

<p class="calibre3">Dummy data is necessary for realistic acceptance testing, getting freelancers/new hires up to speed with useful content, keeping real customer data private to those outside your company, and avoiding the temptation to copy live data over to your development environments.</p>

<h4 id="calibre_link-108" class="calibre4">Why is using production data in development bad?</h4>

<p class="calibre3">Have you ever been writing a script that sends out emails and used some dummy copy while you’re building it? Ever used some cheeky words in that content? Ever accidentally sent that email out to 10,000 real customers email addresses? Ever been fired for losing a company over £200,000?</p>

<p class="calibre3">I haven’t, but I know a guy that has been. Don’t be that guy.</p>

<h4 id="calibre_link-109" class="calibre4">What data should you use?</h4>

<p class="calibre3">Garbage! Use absolute nonsense for your development database, but nonsense of the correct data type, size, and format. That can be done with a fun little library called <a href="https://github.com/fzaninotto/Faker">Faker</a> by <a href="https://twitter.com/francoisz/">François Zaninotto</a> which is a wonderful little library that can essentially bullshit for Queen and country.</p>

<h3 id="calibre_link-6" class="calibre2">
<span class="section-number">1.3 </span>Building Seeders</h3>

<p class="calibre3">Kapture, the company I previously worked for, used the Laravel framework, which has <a href="http://laravel.com/docs/migrations#database-seeding">Database Seeding</a> baked in. This is essentially a tarted up CLI task, which almost any modern PHP framework will have (or bloody well should), so the principles are applicable to all.</p>

<p class="calibre3">Break your database seeders down into logical groupings. This does not need to be “one seeder-per-table”, but it can be. Sometimes your data needs to be built at the same time as other types of data. For example, users
are created in the same seeder as their settings, OAuth tokens, and friendship data is made. Putting that
into multiple seeders purely to keep things tidy would complicate your seeders and slow things down a lot, so maybe consider combining them.</p>

<p class="calibre3">In this chapter I will use a check-in application as an example. The application handles “users” and tracks their “check-ins” into “merchants” (or “venues”). “Merchants” also provide “campaigns” (or “opportunities”).</p>

<p class="calibre3">So, this is a simplified version of the user seeder, ignoring the Laravel-specific structure. <em class="calibre19">If you are using Laravel, just shove this in your <code class="calibre15">run()</code> method.</em></p>

<figure class="code">
  <figcaption class="calibre20">Creating a user with Faker and Eloquent ORM</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="nv">$faker</code> <code class="o">=</code> <code class="calibre15">Faker\Factory</code><code class="o">::</code><code class="na">create</code><code class="calibre15">();</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="k">for</code> <code class="calibre15">(</code><code class="nv">$i</code> <code class="o">=</code> <code class="o">0</code><code class="calibre15">;</code> <code class="nv">$i</code> <code class="o">&lt;</code> <code class="calibre15">Config</code><code class="o">::</code><code class="na">get</code><code class="calibre15">(</code><code class="s">'seeding.users'</code><code class="calibre15">);</code> <code class="nv">$i</code><code class="o">++</code><code class="calibre15">)</code> <code class="calibre15">{</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code>     <code class="nv">$user</code> <code class="o">=</code> <code class="calibre15">User</code><code class="o">::</code><code class="na">create</code><code class="calibre15">([</code>
<code class="lineno"> 6</code>         <code class="s">'name'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">name</code><code class="calibre15">,</code>
<code class="lineno"> 7</code>         <code class="s">'email'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">email</code><code class="calibre15">,</code>
<code class="lineno"> 8</code>         <code class="s">'active'</code> <code class="o">=&gt;</code> <code class="nv">$i</code> <code class="o">===</code> <code class="o">0</code> <code class="o">?</code> <code class="k">true</code> <code class="o">:</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">boolean</code><code class="calibre15">,</code>
<code class="lineno"> 9</code>         <code class="s">'gender'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">randomElement</code><code class="calibre15">([</code><code class="s">'male'</code><code class="calibre15">,</code> <code class="s">'female'</code><code class="calibre15">,</code> <code class="s">'other'</code><code class="calibre15">]),</code>
<code class="lineno">10</code>         <code class="s">'timezone'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">numberBetween</code><code class="calibre15">(</code><code class="o">-</code><code class="o">10</code><code class="calibre15">,</code> <code class="o">10</code><code class="calibre15">),</code>
<code class="lineno">11</code>         <code class="s">'birthday'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">dateTimeBetween</code><code class="calibre15">(</code><code class="s">'-40 years'</code><code class="calibre15">,</code> <code class="s">'-18 years'</code><code class="calibre15">),</code>
<code class="lineno">12</code>         <code class="s">'location'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">boolean</code> <code class="o">?</code> <code class="s">"</code><code class="si">{</code><code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">city</code><code class="si">}</code><code class="s">, </code><code class="si">{</code><code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">state</code><code class="si">}</code><code class="s">"</code> <code class="o">:</code> <code class="k">null</code><code class="calibre15">,</code>
<code class="lineno">13</code>         <code class="s">'had_feedback_email'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">boolean</code><code class="calibre15">,</code>
<code class="lineno">14</code>         <code class="s">'sync_name_bio'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">boolean</code><code class="calibre15">,</code>
<code class="lineno">15</code>         <code class="s">'bio'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">sentence</code><code class="calibre15">(</code><code class="o">100</code><code class="calibre15">),</code>
<code class="lineno">16</code>     <code class="calibre15">]);</code>
<code class="lineno">17</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">What do we have here? Let’s go through this one section at a time:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$faker</code> <code class="o">=</code> <code class="calibre15">Faker\Factory</code><code class="o">::</code><code class="na">create</code><code class="calibre15">();</code>
</pre></div>

</figure>

<p class="calibre3">An instance of Faker, our bullshit artist for-hire.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">3</code> <code class="k">for</code> <code class="calibre15">(</code><code class="nv">$i</code> <code class="o">=</code> <code class="o">0</code><code class="calibre15">;</code> <code class="nv">$i</code> <code class="o">&lt;</code> <code class="calibre15">Config</code><code class="o">::</code><code class="na">get</code><code class="calibre15">(</code><code class="s">'seeding.users'</code><code class="calibre15">);</code> <code class="nv">$i</code><code class="o">++</code><code class="calibre15">)</code> <code class="calibre15">{</code>
</pre></div>

</figure>

<p class="calibre3">We are going to want a certain number of users, but you should have a few less on development than you do on testing or staging to save time.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">5</code>     <code class="nv">$user</code> <code class="o">=</code> <code class="calibre15">User</code><code class="o">::</code><code class="na">create</code><code class="calibre15">([</code>
<code class="lineno">6</code>         <code class="s">'name'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">name</code><code class="calibre15">,</code>
<code class="lineno">7</code>         <code class="s">'email'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">email</code><code class="calibre15">,</code>
</pre></div>

</figure>

<p class="calibre3">Make a random name and random email. There is no need to define the pool of random data it uses, because IT’S MAGIC!</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">8</code>         <code class="s">'active'</code> <code class="o">=&gt;</code> <code class="nv">$i</code> <code class="o">===</code> <code class="o">0</code> <code class="o">?</code> <code class="k">true</code> <code class="o">:</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">boolean</code><code class="calibre15">,</code>
</pre></div>

</figure>

<p class="calibre3">Ok I lied, our garbage is not 100% random. We want user number 1 to be active for tests later on.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">9</code>         <code class="s">'gender'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">randomElement</code><code class="calibre15">([</code><code class="s">'male'</code><code class="calibre15">,</code> <code class="s">'female'</code><code class="calibre15">,</code> <code class="s">'other'</code><code class="calibre15">]),</code>
</pre></div>

</figure>

<p class="calibre3">Gender equality is important.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">10</code>         <code class="s">'timezone'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">numberBetween</code><code class="calibre15">(</code><code class="o">-</code><code class="o">10</code><code class="calibre15">,</code> <code class="o">10</code><code class="calibre15">),</code>
</pre></div>

</figure>

<p class="calibre3">Our original developer decided that saving time zones as an integer was a clever thing to do.</p>

<aside class="warning">
    <h4 id="calibre_link-110" class="calibre21">Store Time zones, Not Offsets</h4>
  <p class="calibre3">Did you know that some time zones are not complete hours? Did you know that Nepal is UTC/GMT +05:45? Did you know that Chatham Island (New Zealand) goes from
UTC/GMT +12:45 to UTC/GMT +13:45 in their local summer? Did you know that some places add 30 minutes when in daylight savings time? Don’t use integers as
timestamps.
Most major programming languages (PHP included) implement the <a href="http://www.iana.org/time-zones">IANA</a> time zone database, which is an industry standard. If you store <code class="calibre15">America/New_York</code> or <code class="calibre15">Asia/Khandyga</code>
then the offset and daylight savings time can be automatically calculated.</p>

</aside>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">11</code>         <code class="s">'birthday'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">dateTimeBetween</code><code class="calibre15">(</code><code class="s">'-40 years'</code><code class="calibre15">,</code> <code class="s">'-18 years'</code><code class="calibre15">),</code>
</pre></div>

</figure>

<p class="calibre3">Users of all of our target age demographic.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">13</code>         <code class="s">'location'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">boolean</code> <code class="o">?</code> <code class="s">"</code><code class="si">{</code><code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">city</code><code class="si">}</code><code class="s">, </code><code class="si">{</code><code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">state</code><code class="si">}</code><code class="s">"</code> <code class="o">:</code> <code class="k">null</code><code class="calibre15">,</code>
</pre></div>

</figure>

<p class="calibre3">Give us a city name and a state name. This works fine with loads of countries, which is cool.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">14</code>         <code class="s">'had_feedback_email'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">boolean</code><code class="calibre15">,</code>
<code class="lineno">15</code>         <code class="s">'sync_name_bio'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">boolean</code><code class="calibre15">,</code>
</pre></div>

</figure>

<p class="calibre3">Some user flags are not as important, so set them to be <code class="calibre15">true</code> or <code class="calibre15">false</code> at random.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">16</code>         <code class="s">'bio'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">sentence</code><code class="calibre15">(</code><code class="o">100</code><code class="calibre15">),</code>
</pre></div>

</figure>

<p class="calibre3">Make a sentence with 100 characters in it.</p>

<h3 id="calibre_link-7" class="calibre2">
<span class="section-number">1.4 </span>That is about it</h3>

<p class="calibre3">You will end up making a lot of these files, and you will want to populate pretty much every table you have with data. You will also want to tell your Database Seeder to wipe all the tables that will be populated. Do this globally right at the start of the process. Do not wipe tables at the top of each seeder, or content in that table from other seeders will be deleted.</p>

<figure class="code">
  <figcaption class="calibre20">Example of an overall system in Laravel</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="k">class</code> <code class="nc">DatabaseSeeder</code> <code class="k">extends</code> <code class="calibre15">Seeder</code>
<code class="lineno"> 2</code> <code class="calibre15">{</code>
<code class="lineno"> 3</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">run</code><code class="calibre15">()</code>
<code class="lineno"> 4</code>     <code class="calibre15">{</code>
<code class="lineno"> 5</code>         <code class="k">if</code> <code class="calibre15">(</code><code class="calibre15">App</code><code class="o">::</code><code class="na">environment</code><code class="calibre15">()</code> <code class="o">===</code> <code class="s">'production'</code><code class="calibre15">)</code> <code class="calibre15">{</code>
<code class="lineno"> 6</code>             <code class="k">exit</code><code class="calibre15">(</code><code class="s">'I just stopped you getting fired. Love Phil'</code><code class="calibre15">);</code>
<code class="lineno"> 7</code>         <code class="calibre15">}</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>         <code class="c">// Disable mass-assignment protection with Laravel</code>
<code class="lineno">10</code>         <code class="calibre15">Eloquent</code><code class="o">::</code><code class="na">unguard</code><code class="calibre15">();</code>
<code class="lineno">11</code> 
<code class="lineno">12</code>         <code class="nv">$tables</code> <code class="o">=</code> <code class="calibre15">[</code>
<code class="lineno">13</code>             <code class="s">'locations'</code><code class="calibre15">,</code>
<code class="lineno">14</code>             <code class="s">'merchants'</code><code class="calibre15">,</code>
<code class="lineno">15</code>             <code class="s">'opps'</code><code class="calibre15">,</code>
<code class="lineno">16</code>             <code class="s">'opps_locations'</code><code class="calibre15">,</code>
<code class="lineno">17</code>             <code class="s">'moments'</code><code class="calibre15">,</code>
<code class="lineno">18</code>             <code class="s">'rewards'</code><code class="calibre15">,</code>
<code class="lineno">19</code>             <code class="s">'users'</code><code class="calibre15">,</code>
<code class="lineno">20</code>             <code class="s">'oauth_sessions'</code><code class="calibre15">,</code>
<code class="lineno">21</code>             <code class="s">'notifications'</code><code class="calibre15">,</code>
<code class="lineno">22</code>             <code class="s">'favorites'</code><code class="calibre15">,</code>
<code class="lineno">23</code>             <code class="s">'settings'</code><code class="calibre15">,</code>
<code class="lineno">24</code>             <code class="s">'friendships'</code><code class="calibre15">,</code>
<code class="lineno">25</code>             <code class="s">'impressions'</code><code class="calibre15">,</code>
<code class="lineno">26</code>         <code class="calibre15">];</code>
<code class="lineno">27</code> 
<code class="lineno">28</code>         <code class="k">foreach</code> <code class="calibre15">(</code><code class="nv">$tables</code> <code class="k">as</code> <code class="nv">$table</code><code class="calibre15">)</code> <code class="calibre15">{</code>
<code class="lineno">29</code>             <code class="calibre15">DB</code><code class="o">::</code><code class="na">table</code><code class="calibre15">(</code><code class="nv">$table</code><code class="calibre15">)</code><code class="o">-&gt;</code><code class="na">truncate</code><code class="calibre15">();</code>
<code class="lineno">30</code>         <code class="calibre15">}</code>
<code class="lineno">31</code> 
<code class="lineno">32</code>         <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">call</code><code class="calibre15">(</code><code class="s">'MerchantTableSeeder'</code><code class="calibre15">);</code>
<code class="lineno">33</code>         <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">call</code><code class="calibre15">(</code><code class="s">'PlaceTableSeeder'</code><code class="calibre15">);</code>
<code class="lineno">34</code>         <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">call</code><code class="calibre15">(</code><code class="s">'UserTableSeeder'</code><code class="calibre15">);</code>
<code class="lineno">35</code>         <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">call</code><code class="calibre15">(</code><code class="s">'OppTableSeeder'</code><code class="calibre15">);</code>
<code class="lineno">36</code>         <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">call</code><code class="calibre15">(</code><code class="s">'MomentTableSeeder'</code><code class="calibre15">);</code>
<code class="lineno">37</code>     <code class="calibre15">}</code>
<code class="lineno">38</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">This wipes everything, then runs other seeder classes to do their thing.</p>

<aside class="tip">
    <h4 id="calibre_link-111" class="calibre21">Foreign Keys</h4>
  <p class="calibre3">It can be difficult to wipe a database when foreign keys constraints are enforced, so in that scenario your seeder
should run <code class="calibre15">DB::statement('SET FOREIGN_KEY_CHECKS=0;');</code> before the truncation of the tables and <code class="calibre15">DB::statement('SET FOREIGN_KEY_CHECKS=1;');</code> afterwards to enable the checks again.</p>

</aside>

<h3 id="calibre_link-8" class="calibre2">
<span class="section-number">1.5 </span>Secondary Data</h3>

<p class="calibre3">As I said, it is quite likely that you will need to insert data that relates to itself. To do this, work out which data will be primary (like users). In the case of a check-in system you will also probably consider “venues” or “merchants”, depending on the nomenclature of your system.</p>

<p class="calibre3">For this example, I will show how to create “merchants”, then attach “opportunities”, which are essentially “campaigns”.</p>

<figure class="code">
  <figcaption class="calibre20">Primary Seeder for the Merchant Table</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">&lt;?</code><code class="calibre15">php</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="k">class</code> <code class="nc">MerchantTableSeeder</code> <code class="k">extends</code> <code class="calibre15">Seeder</code>
<code class="lineno"> 4</code> <code class="calibre15">{</code>
<code class="lineno"> 5</code>     <code class="sd">/**</code>
<code class="lineno"> 6</code> <code class="sd">     * Run the database seeds.</code>
<code class="lineno"> 7</code> <code class="sd">     *</code>
<code class="lineno"> 8</code> <code class="sd">     * @return void</code>
<code class="lineno"> 9</code> <code class="sd">     */</code>
<code class="lineno">10</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">run</code><code class="calibre15">()</code>
<code class="lineno">11</code>     <code class="calibre15">{</code>
<code class="lineno">12</code>         <code class="nv">$faker</code> <code class="o">=</code> <code class="calibre15">Faker\Factory</code><code class="o">::</code><code class="na">create</code><code class="calibre15">();</code>
<code class="lineno">13</code> 
<code class="lineno">14</code>         <code class="c">// Create however many merchants</code>
<code class="lineno">15</code>         <code class="k">for</code> <code class="calibre15">(</code><code class="nv">$i</code> <code class="o">=</code> <code class="o">0</code><code class="calibre15">;</code> <code class="nv">$i</code> <code class="o">&lt;</code> <code class="calibre15">Config</code><code class="o">::</code><code class="na">get</code><code class="calibre15">(</code><code class="s">'seeding.merchants'</code><code class="calibre15">);</code> <code class="nv">$i</code><code class="o">++</code><code class="calibre15">)</code> <code class="calibre15">{</code>
<code class="lineno">16</code>             <code class="calibre15">Merchant</code><code class="o">::</code><code class="na">create</code><code class="calibre15">([</code>
<code class="lineno">17</code>                 <code class="s">'name'</code>        <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">company</code><code class="calibre15">,</code>
<code class="lineno">18</code>                 <code class="s">'website'</code>     <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">url</code><code class="calibre15">,</code>
<code class="lineno">19</code>                 <code class="s">'phone'</code>       <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">phoneNumber</code><code class="calibre15">,</code>
<code class="lineno">20</code>                 <code class="s">'description'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">text</code><code class="calibre15">(</code><code class="o">200</code><code class="calibre15">),</code>
<code class="lineno">21</code>             <code class="calibre15">]);</code>
<code class="lineno">22</code>         <code class="calibre15">}</code>
<code class="lineno">23</code>     <code class="calibre15">}</code>
<code class="lineno">24</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption class="calibre20">Primary Seeder for the Opp Table</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">&lt;?</code><code class="calibre15">php</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="k">use</code> <code class="calibre15">Carbon\Carbon</code><code class="calibre15">;</code>
<code class="lineno"> 4</code> <code class="k">use</code> <code class="calibre15">Kapture\CategoryFinder</code><code class="calibre15">;</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code> <code class="k">class</code> <code class="nc">OppTableSeeder</code> <code class="k">extends</code> <code class="calibre15">Seeder</code>
<code class="lineno"> 7</code> <code class="calibre15">{</code>
<code class="lineno"> 8</code>     <code class="k">protected</code> <code class="nv">$categoryFinder</code><code class="calibre15">;</code>
<code class="lineno"> 9</code>     <code class="k">protected</code> <code class="nv">$places</code><code class="calibre15">;</code>
<code class="lineno">10</code>     
<code class="lineno">11</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">__construct</code><code class="calibre15">(</code><code class="calibre15">CategoryFinder</code> <code class="nv">$finder</code><code class="calibre15">,</code> <code class="calibre15">Place</code> <code class="nv">$places</code><code class="calibre15">)</code>
<code class="lineno">12</code>     <code class="calibre15">{</code>
<code class="lineno">13</code>         <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">categoryFinder</code> <code class="o">=</code> <code class="nv">$finder</code><code class="calibre15">;</code>
<code class="lineno">14</code>         <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">places</code> <code class="o">=</code> <code class="nv">$places</code><code class="calibre15">;</code>
<code class="lineno">15</code>     <code class="calibre15">}</code>
<code class="lineno">16</code> 
<code class="lineno">17</code>     <code class="k">protected</code> <code class="nv">$imageArray</code> <code class="o">=</code> <code class="calibre15">[</code>
<code class="lineno">18</code>         <code class="s">'http://example.com/images/example1.jpg'</code><code class="calibre15">,</code>
<code class="lineno">19</code>         <code class="s">'http://example.com/images/example2.jpg'</code><code class="calibre15">,</code>
<code class="lineno">20</code>         <code class="s">'http://example.com/images/example3.jpg'</code><code class="calibre15">,</code>
<code class="lineno">21</code>         <code class="s">'http://example.com/images/example4.jpg'</code><code class="calibre15">,</code>
<code class="lineno">22</code>         <code class="s">'http://example.com/images/example5.jpg'</code><code class="calibre15">,</code>
<code class="lineno">23</code>     <code class="calibre15">];</code>
<code class="lineno">24</code> 
<code class="lineno">25</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">run</code><code class="calibre15">()</code>
<code class="lineno">26</code>     <code class="calibre15">{</code>
<code class="lineno">27</code>         <code class="nv">$faker</code> <code class="o">=</code> <code class="calibre15">Faker\Factory</code><code class="o">::</code><code class="na">create</code><code class="calibre15">();</code>
<code class="lineno">28</code> 
<code class="lineno">29</code>         <code class="k">foreach</code> <code class="calibre15">(</code><code class="calibre15">Merchant</code><code class="o">::</code><code class="na">all</code><code class="calibre15">()</code> <code class="k">as</code> <code class="nv">$merchant</code><code class="calibre15">)</code> <code class="calibre15">{</code>
<code class="lineno">30</code> 
<code class="lineno">31</code>             <code class="c">// Create however many opps for this merchant</code>
<code class="lineno">32</code>             <code class="k">foreach</code> <code class="calibre15">(</code><code class="nb">range</code><code class="calibre15">(</code><code class="o">1</code><code class="calibre15">,</code> <code class="calibre15">rand</code><code class="calibre15">(</code><code class="o">2</code><code class="calibre15">,</code> <code class="o">4</code><code class="calibre15">))</code> <code class="k">as</code> <code class="nv">$i</code><code class="calibre15">)</code> <code class="calibre15">{</code>
<code class="lineno">33</code> 
<code class="lineno">34</code>                 <code class="c">// There are three types of image to add</code>
<code class="lineno">35</code>                 <code class="nv">$image</code> <code class="o">=</code> <code class="calibre15">Image</code><code class="o">::</code><code class="na">create</code><code class="calibre15">([</code>
<code class="lineno">36</code>                     <code class="s">'name'</code> <code class="o">=&gt;</code> <code class="s">"</code><code class="si">{</code><code class="nv">$merchant</code><code class="o">-&gt;</code><code class="na">name</code><code class="si">}</code><code class="s"> Image #</code><code class="si">{</code><code class="nv">$i</code><code class="si">}</code><code class="s">"</code><code class="calibre15">,</code>
<code class="lineno">37</code>                     <code class="s">'url'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">randomElement</code><code class="calibre15">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">imageArray</code><code class="calibre15">),</code>
<code class="lineno">38</code>                 <code class="calibre15">]);</code>
<code class="lineno">39</code> 
<code class="lineno">40</code>                 <code class="c">// Start it immediately and make it last for 2 months</code>
<code class="lineno">41</code>                 <code class="nv">$starts</code> <code class="o">=</code> <code class="calibre15">Carbon</code><code class="o">::</code><code class="na">now</code><code class="calibre15">();</code>
<code class="lineno">42</code> 
<code class="lineno">43</code>                 <code class="c">// We need to definitely have at least one we are in control of</code>
<code class="lineno">44</code>                 <code class="k">if</code> <code class="calibre15">(</code><code class="nv">$i</code> <code class="o">===</code> <code class="o">1</code><code class="calibre15">)</code> <code class="calibre15">{</code>
<code class="lineno">45</code>                     <code class="c">// Have ONE that ends really soon</code>
<code class="lineno">46</code>                     <code class="nv">$ends</code> <code class="o">=</code> <code class="calibre15">Carbon</code><code class="o">::</code><code class="na">now</code><code class="calibre15">()</code><code class="o">-&gt;</code><code class="na">addDays</code><code class="calibre15">(</code><code class="o">2</code><code class="calibre15">);</code>
<code class="lineno">47</code>                     <code class="nv">$teaser</code> <code class="o">=</code> <code class="s">'Something about cheese'</code><code class="calibre15">;</code>
<code class="lineno">48</code> 
<code class="lineno">49</code>                 <code class="calibre15">}</code> <code class="k">else</code> <code class="calibre15">{</code>
<code class="lineno">50</code>                     <code class="nv">$ends</code> <code class="o">=</code> <code class="calibre15">Carbon</code><code class="o">::</code><code class="na">now</code><code class="calibre15">()</code><code class="o">-&gt;</code><code class="na">addDays</code><code class="calibre15">(</code><code class="o">60</code><code class="calibre15">);</code>
<code class="lineno">51</code>                     <code class="nv">$teaser</code> <code class="o">=</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">sentence</code><code class="calibre15">(</code><code class="calibre15">rand</code><code class="calibre15">(</code><code class="o">3</code><code class="calibre15">,</code> <code class="o">5</code><code class="calibre15">));</code>
<code class="lineno">52</code>                 <code class="calibre15">}</code>
<code class="lineno">53</code> 
<code class="lineno">54</code>                 <code class="nv">$category</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">categoryFinder</code><code class="o">-&gt;</code><code class="na">setRandom</code><code class="calibre15">()</code><code class="o">-&gt;</code><code class="na">getOne</code><code class="calibre15">();</code>
<code class="lineno">55</code> 
<code class="lineno">56</code>                 <code class="nv">$opp</code> <code class="o">=</code> <code class="calibre15">Opp</code><code class="o">::</code><code class="na">create</code><code class="calibre15">([</code>
<code class="lineno">57</code>                     <code class="s">'name'</code>           <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">sentence</code><code class="calibre15">(</code><code class="calibre15">rand</code><code class="calibre15">(</code><code class="o">3</code><code class="calibre15">,</code> <code class="o">5</code><code class="calibre15">)),</code>
<code class="lineno">58</code>                     <code class="s">'teaser'</code>         <code class="o">=&gt;</code> <code class="nv">$teaser</code><code class="calibre15">,</code>
<code class="lineno">59</code>                     <code class="s">'details'</code>        <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">paragraph</code><code class="calibre15">(</code><code class="o">3</code><code class="calibre15">),</code>
<code class="lineno">60</code>                     <code class="s">'starts'</code>         <code class="o">=&gt;</code> <code class="nv">$starts</code><code class="o">-&gt;</code><code class="na">format</code><code class="calibre15">(</code><code class="s">'Y-m-d H:i:s'</code><code class="calibre15">),</code>
<code class="lineno">61</code>                     <code class="s">'ends'</code>           <code class="o">=&gt;</code> <code class="nv">$ends</code><code class="o">-&gt;</code><code class="na">format</code><code class="calibre15">(</code><code class="s">'Y-m-d H:i:s'</code><code class="calibre15">),</code>
<code class="lineno">62</code>                     <code class="s">'category_id'</code>    <code class="o">=&gt;</code> <code class="nv">$category</code><code class="o">-&gt;</code><code class="na">id</code><code class="calibre15">,</code>
<code class="lineno">63</code>                     <code class="s">'merchant_id'</code>    <code class="o">=&gt;</code> <code class="nv">$merchant</code><code class="o">-&gt;</code><code class="na">id</code><code class="calibre15">,</code>
<code class="lineno">64</code>                     <code class="s">'published'</code>      <code class="o">=&gt;</code> <code class="k">true</code><code class="calibre15">,</code>
<code class="lineno">65</code>                 <code class="calibre15">]);</code>
<code class="lineno">66</code> 
<code class="lineno">67</code>                 <code class="c">// Attach an image to the opp</code>
<code class="lineno">68</code>                 <code class="nv">$opp</code><code class="o">-&gt;</code><code class="na">images</code><code class="calibre15">()</code><code class="o">-&gt;</code><code class="na">attach</code><code class="calibre15">(</code><code class="nv">$image</code><code class="calibre15">,</code> <code class="calibre15">[</code>
<code class="lineno">69</code>                     <code class="s">'published'</code> <code class="o">=&gt;</code> <code class="k">true</code>
<code class="lineno">70</code>                 <code class="calibre15">]);</code>
<code class="lineno">71</code>             <code class="calibre15">}</code>
<code class="lineno">72</code> 
<code class="lineno">73</code>             <code class="k">echo</code> <code class="s">"Created </code><code class="si">$i</code><code class="s"> Opps for </code><code class="si">$merchant-&gt;name</code><code class="s"> </code><code class="se">\n</code><code class="s">"</code><code class="calibre15">;</code>
<code class="lineno">74</code>         <code class="calibre15">}</code>
<code class="lineno">75</code>     <code class="calibre15">}</code>
<code class="lineno">76</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">This might look a little crazy, and it is certainly a mixture of lazy-static ORM usage in the controller and some dependency injection, but these seeders have not received a large amount of love. They definitely do their job, and could always be cleaner, but here are the basics:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">41</code>         <code class="k">foreach</code> <code class="calibre15">(</code><code class="calibre15">Merchant</code><code class="o">::</code><code class="na">all</code><code class="calibre15">()</code> <code class="k">as</code> <code class="nv">$merchant</code><code class="calibre15">)</code> <code class="calibre15">{</code>
</pre></div>

</figure>

<p class="calibre3">Loop through all merchants.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">43</code>             <code class="c">// Create however many opps for this merchant</code>
<code class="lineno">44</code>             <code class="k">foreach</code> <code class="calibre15">(</code><code class="nb">range</code><code class="calibre15">(</code><code class="o">1</code><code class="calibre15">,</code> <code class="calibre15">rand</code><code class="calibre15">(</code><code class="o">2</code><code class="calibre15">,</code> <code class="o">4</code><code class="calibre15">))</code> <code class="k">as</code> <code class="nv">$i</code><code class="calibre15">)</code> <code class="calibre15">{</code>
</pre></div>

</figure>

<p class="calibre3">Create between 1 and 4 opportunities for a merchant.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">46</code>                 <code class="c">// There are three types of image to add</code>
<code class="lineno">47</code>                 <code class="nv">$image</code> <code class="o">=</code> <code class="calibre15">Image</code><code class="o">::</code><code class="na">create</code><code class="calibre15">([</code>
<code class="lineno">48</code>                     <code class="s">'name'</code> <code class="o">=&gt;</code> <code class="s">"</code><code class="si">{</code><code class="nv">$merchant</code><code class="o">-&gt;</code><code class="na">name</code><code class="si">}</code><code class="s"> Image #</code><code class="si">{</code><code class="nv">$i</code><code class="si">}</code><code class="s">"</code><code class="calibre15">,</code>
<code class="lineno">49</code>                     <code class="s">'url'</code> <code class="o">=&gt;</code> <code class="nv">$faker</code><code class="o">-&gt;</code><code class="na">randomElement</code><code class="calibre15">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">imageArray</code><code class="calibre15">),</code>
<code class="lineno">50</code>                 <code class="calibre15">]);</code>
</pre></div>

</figure>

<p class="calibre3">Add an image from our array of example images on S3, or our website somewhere. The more the merrier.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">66</code>                 <code class="nv">$category</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">categoryFinder</code><code class="o">-&gt;</code><code class="na">setRandom</code><code class="calibre15">()</code><code class="o">-&gt;</code><code class="na">getOne</code><code class="calibre15">();</code>
</pre></div>

</figure>

<p class="calibre3">I will talk more about finders in a later chapter, but for now, just know this is a convenient way of getting a single random category back.</p>

<p class="calibre3">The rest should all be relatively obvious.</p>

<p class="calibre3">If you are using Laravel, you can run the above commands on the command line with: <code class="calibre15">$ php artisan db:seed</code>. The Rails equivalent is hilariously similar: <code class="calibre15">$ rake db:seed</code>.</p>

<h3 id="calibre_link-9" class="calibre2">
<span class="section-number">1.6 </span>When to run this?</h3>

<p class="calibre3">Database seeds are often run both manually and automatically, depending on what is going on.</p>

<p class="calibre3">For example, if you have just added a new endpoint with new data, you will want to let your teammates know to pull the latest code, run the migrations and run the seed.</p>

<p class="calibre3">This is also great when a freelancer comes in to do some work, or a new developer starts up, or your iPhone dev wants to get some data to use. In all these instances, that command just needs to be run on the command line.</p>

<p class="calibre3">This is also occasionally run manually on the staging server and automatically on the Jenkins testing server when we deploy new builds of the API.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-94">
<div class="calibre6">
<h2 id="calibre_link-10" class="calibre1">
<span class="section-number">2. </span>Planning and Creating Endpoints</h2>

<p class="calibre3">With your database planned and full of fake but useful data it is time to plan what your endpoints are going to look like. An endpoint is simply a URL. When you go to <code class="calibre15">http://example.com/foo/bar</code> that is an
endpoint and you can simply call it <code class="calibre15">/foo/bar</code> because the domain will be the same for all of them.</p>

<p class="calibre3">The first step is to work out the requirements of an API, then we can move onto some theory and finally see the theory implemented in some examples.</p>

<h3 id="calibre_link-11" class="calibre2">
<span class="section-number">2.1 </span>Functional Requirements</h3>

<p class="calibre3">Try thinking of <em class="calibre19">everything</em> your API will need to handle. This will initially be a list of CRUD (create, read, update, delete) endpoints for your resources. Talk to your mobile app developer, your JS front-end people, or just talk to yourself if you are the only developer on the project.</p>

<p class="calibre3">Definitely talk to your customers or “the business” (they are the customers) and get them to help you think of functionality too, but they will probably not know what an endpoint is.</p>

<p class="calibre3">When you have a relatively extensive list the next step is to make a simple list of “actions”. This is very much like planning a PHP class. You first write up pseudo-code referencing the classes and methods like they exist, right? TDD (Test Driven Development)? If not, that is how you should do it, or <a href="http://grumpy-learning.com/">Chris Hartjes</a> will find you, and he <em class="calibre19">will</em> kill you.</p>

<p class="calibre3">I will go ahead with the check-in application, introduced in the previous chapter, to show how these principles can be put in practice.</p>

<p class="calibre3">If I have a “places” resource in mind, I need to list out with just bullet points what it will do:</p>

<blockquote class="calibre17">
  <p class="calibre3">Places<br class="calibre6" />
- <strong class="calibre22">Create</strong><br class="calibre6" />
- <strong class="calibre22">Read</strong><br class="calibre6" />
- <strong class="calibre22">Update</strong><br class="calibre6" />
- <strong class="calibre22">Delete</strong></p>
</blockquote>

<p class="calibre3">That is fairly obvious. Who will be able to view these places and who will be able to create and edit them is, for now, irrelevant in our planning stages. This API will get much smarter with the ideas of user-context and permissions at a later date. For now, just list all the things that need to be done.</p>

<p class="calibre3">A paginate-able list of places is also a requirement, so get that down:</p>

<blockquote class="calibre17">
  <p class="calibre3">Places<br class="calibre6" />
- Create<br class="calibre6" />
- Read<br class="calibre6" />
- Update<br class="calibre6" />
- Delete<br class="calibre6" />
- <strong class="calibre22">List</strong></p>
</blockquote>

<p class="calibre3">The API will need to offer the ability to search places by location too, but that is not a brand new endpoint. If the API was built with SOAP or XML-RPC, you would create a <code class="calibre15">getPlacesByLatAndLon</code> method to hit in the URL, but this isn’t SOAP - thankfully. The list method will handle that with a few parameters, so why not shove them in as a note for later:</p>

<blockquote class="calibre17">
  <p class="calibre3">Places<br class="calibre6" />
- Create<br class="calibre6" />
- Read<br class="calibre6" />
- Update<br class="calibre6" />
- Delete<br class="calibre6" />
- List <strong class="calibre22">(lat, lon, distance or box)</strong></p>
</blockquote>

<p class="calibre3">Adding a few parameters as a reminder, at this stage, is cool, but lets not worry about adding too much. For example, Create and Update are complicated, so adding every single field would be a mess.</p>

<p class="calibre3">Update is more than just updating the specific Places fields in a <code class="calibre15">places</code> SQL table. Update can do all sorts of cool stuff. If you need to “favorite” a Place, just send <code class="calibre15">is_favorite</code> to that endpoint and you’ve favorited it. More on that later, just remember that not every single action requires its own endpoint.</p>

<p class="calibre3">Places will also need to have an image uploaded via the API. In this example, we are only going to accept one image for a place and a new image overrides the old, so add “Image” to the list. Otherwise you’d add “Images” to the list:</p>

<blockquote class="calibre17">
  <p class="calibre3">Places<br class="calibre6" />
- Create<br class="calibre6" />
- Read<br class="calibre6" />
- Update<br class="calibre6" />
- Delete<br class="calibre6" />
- List (lat, lon, distance or box)<br class="calibre6" />
- <strong class="calibre22">Image</strong></p>
</blockquote>

<p class="calibre3">A complete API action plan might look like this:</p>

<blockquote class="calibre17">
  <p class="calibre3">Categories<br class="calibre6" />
- Create<br class="calibre6" />
- List</p>
</blockquote>

<blockquote class="calibre17">
  <p class="calibre3">Checkins<br class="calibre6" />
- Create<br class="calibre6" />
- Read<br class="calibre6" />
- Update<br class="calibre6" />
- Delete<br class="calibre6" />
- List<br class="calibre6" />
- Image</p>
</blockquote>

<blockquote class="calibre17">
  <p class="calibre3">Opps<br class="calibre6" />
- Create<br class="calibre6" />
- Read<br class="calibre6" />
- Update<br class="calibre6" />
- Delete<br class="calibre6" />
- List<br class="calibre6" />
- Image<br class="calibre6" />
- Checkins</p>
</blockquote>

<blockquote class="calibre17">
  <p class="calibre3">Places<br class="calibre6" />
- Create<br class="calibre6" />
- Read<br class="calibre6" />
- Update<br class="calibre6" />
- Delete<br class="calibre6" />
- List (lat, lon, distance or box)<br class="calibre6" />
- Image  </p>
</blockquote>

<blockquote class="calibre17">
  <p class="calibre3">Users<br class="calibre6" />
- Create<br class="calibre6" />
- Read<br class="calibre6" />
- Update<br class="calibre6" />
- Delete<br class="calibre6" />
- List (active, suspended)<br class="calibre6" />
- Image<br class="calibre6" />
- Favorites<br class="calibre6" />
- Checkins<br class="calibre6" />
- Followers</p>
</blockquote>

<p class="calibre3">That might not contain everything, but it seems like a fairly solid start to our API. It is certainly going to take long enough to write all that, so if somebody thinks of something else they can just make an Issue.</p>

<p class="calibre3">Moving on.</p>

<h3 id="calibre_link-12" class="calibre2">
<span class="section-number">2.2 </span>Endpoint Theory</h3>

<p class="calibre3">Turning this action plan into actual endpoints requires knowing a little theory on RESTful APIs and best practices for naming conventions. There are no right answers here, but some approaches have fewer cons than others. I will try to push you in the direction I have found to be most useful, and highlight the pros and cons of each.</p>

<h4 id="calibre_link-112" class="calibre4">GET Resources</h4>

<ul class="calibre18">
  <li class="calibre14">
<code class="calibre15">GET /resources</code> - Some paginated list of stuff, in some logical default order, for that specific data.</li>
  <li class="calibre14">
<code class="calibre15">GET /resources/X</code> - Just entity X. That can be an ID, hash, slug, username, etc., as long as it’s unique to one “resource”.</li>
  <li class="calibre14">
<code class="calibre15">GET /resources/X,Y,Z</code> - The client wants multiple things, so give them multiple things.</li>
</ul>

<p class="calibre3">It can be hard to pick between subresource URLs or embedded data. Embedded data can be rather difficult to pull off so that will be saved for <a href="#calibre_link-44">Chapter 7: Embedding Data</a>. For now the answer is “just subresources”, but eventually the answer will be “both”. This is how subresources look:</p>

<ul class="calibre18">
  <li class="calibre14">
<code class="calibre15">GET /places/X/checkins</code> - Find all the checkins for a specific place.</li>
  <li class="calibre14">
<code class="calibre15">GET /users/X/checkins</code> - Find all the checkins for a specific user.</li>
  <li class="calibre14">
<code class="calibre15">GET /users/X/checkins/Y</code> - Find a specific checkin for a specific user.</li>
</ul>

<p class="calibre3">The latter is questionable and not something I have ever personally done. At that point, I would prefer to simply use <code class="calibre15">/checkins/X</code>.</p>

<aside class="warning">
    <h3 id="calibre_link-113" class="calibre23">Auto-Increment is the Devil</h3>

  <p class="calibre3">In these examples X and Y can be an auto-incrementing ID as many developers will assume. One important factor with auto-incrementing ID’s is that anyone with access to your API will know exactly how many resources you have, which might not be a statistic you want your competitors to have.</p>

  <p class="calibre3">Consumers could also write a script which hits <code class="calibre15">/users/1</code>, then <code class="calibre15">/users/2</code> and <code class="calibre15">/users/3</code>, etc., scraping all data as it goes. Sure they could probably do that from the “list” endpoints anyway, but not all resources should have a “get all” approach.</p>

  <p class="calibre3">Instead a unique identifier is often a good idea. A universal unique identifier (UUID) seems like a logical thing to do: <a href="https://github.com/ramsey/uuid">ramsey\uuid for PHP</a>, <a href="https://rubygems.org/gems/uuid">uuid for Ruby</a>, <a href="http://docs.python.org/2/library/uuid.html">uuid in Python 2.5+</a>.</p>

</aside>

<h4 id="calibre_link-114" class="calibre4">DELETE Resources</h4>

<p class="calibre3">Want to delete things? Easy:</p>

<ul class="calibre18">
  <li class="calibre14">
<code class="calibre15">DELETE /places/X</code> - Delete a single place.</li>
  <li class="calibre14">
<code class="calibre15">DELETE /places/X,Y,Z</code> - Delete a bunch of places.</li>
  <li class="calibre14">
<code class="calibre15">DELETE /places</code> - This is a potentially dangerous endpoint that could be skipped, as it should delete all places.</li>
  <li class="calibre14">
<code class="calibre15">DELETE /places/X/image</code> - Delete the image for a place, or:</li>
  <li class="calibre14">
<code class="calibre15">DELETE /places/X/images</code> - If you chose to have multiple images this would remove all of them.</li>
</ul>

<h4 id="calibre_link-115" class="calibre4">POST vs PUT: FIGHT!</h4>

<p class="calibre3">What about creating and updating? This is where it gets almost religious. There are lots of people who will try to pair the HTTP POST or HTTP PUT verb (verb, i.e. an HTTP method) to a specific CRUD action and always only ever do that one action with that one verb. That sucks and is not productive or functionally scalable.</p>

<p class="calibre3">Generally speaking, PUT is used if you know the entire URL beforehand and the action is idempotent. Idempotent is a fancy word for “can do it over and over again without causing different results”.</p>

<p class="calibre3">For example, create <em class="calibre19">could</em> be a PUT if you are creating one image for a place. If you were to do this:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nf">PUT</code> <code class="nc">/places/1/image</code> <code class="k">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="na">Host</code><code class="o">:</code> <code class="calibre15">example.com</code>
<code class="lineno">3</code> <code class="na">Content-Type</code><code class="o">:</code> <code class="calibre15">image/jpeg</code>
</pre></div>

</figure>

<p class="calibre3">That would be a perfect example of when to use a <code class="calibre15">PUT</code> because you already know the entire URL ( <code class="calibre15">/places/1/image</code> ) and you can do it time and time again.</p>

<p class="calibre3">The API at Kapture used a <code class="calibre15">POST</code> to <code class="calibre15">/checkins</code> to create the metadata for that new check-in, then returned the URL for us to PUT the image to. You could try checking in multiple times and it would not matter because none of those processes would be complete, but POSTing multiple times is not idempotent because each checkin is different. PUT is idempotent because you are uploading that image to the full URL and you can do it over and over again if you like (for instance, because the upload failed and it has to try again).</p>

<p class="calibre3">So, if you have multiple images for places, maybe you could use the following:</p>

<blockquote class="calibre17">
  <p class="calibre3">POST /places/X/images</p>
</blockquote>

<p class="calibre3">Then multiple attempts would be different images. If you know you are only going to have one image and a new attempt is an override, then the following would be ideal:</p>

<blockquote class="calibre17">
  <p class="calibre3">PUT /places/X/image</p>
</blockquote>

<p class="calibre3">Another example could be user settings:</p>

<ul class="calibre18">
  <li class="calibre14">
<code class="calibre15">POST /me/settings</code> - I would expect this to allow me to POST specific fields one at a time, not force me to send the entire body of settings.</li>
  <li class="calibre14">
<code class="calibre15">PUT /me/settings</code> - Send me ALL the settings.</li>
</ul>

<p class="calibre3">It’s a tricky difference, but do not try and tie an HTTP Method to one CRUD action only.</p>

<h4 id="calibre_link-116" class="calibre4">Plural, Singular or Both?</h4>

<p class="calibre3">Some developers decide to make all endpoints singular, but I take issue with this. Given <code class="calibre15">/user/1</code> and <code class="calibre15">/user</code>, which user is that last one returning? Is it “me”? What about <code class="calibre15">/place</code>? It returns multiple? Confusing.</p>

<p class="calibre3">I know it can be tempting to create <code class="calibre15">/user/1</code> and <code class="calibre15">/users</code> because the two endpoints do different things, right? I started off down this route (#pun) originally, but in my experience, this convention grows badly. Sure it works with the example of “users”, but what about those fun English words that create exceptions like <code class="calibre15">/opportunity/1</code> which when pluralised becomes <code class="calibre15">/opportunities</code>. Gross.</p>

<p class="calibre3">I pick plural for everything as it is the most obvious:</p>

<ul class="calibre18">
  <li class="calibre14">
<code class="calibre15">/places</code> - “If I run a GET on that, I will get a collection of places”</li>
  <li class="calibre14">
<code class="calibre15">/places/45</code> - “Pretty sure I am just talking about place 45”</li>
  <li class="calibre14">
<code class="calibre15">/places/45,28</code> - “Ahh, places 45 and 28, got it”</li>
</ul>

<p class="calibre3">Another solid reason for using plural consistently is that it allows for consistently named subresources:</p>

<ul class="calibre18">
  <li class="calibre14"><code class="calibre15">/places</code></li>
  <li class="calibre14"><code class="calibre15">/places/45</code></li>
  <li class="calibre14"><code class="calibre15">/places/45/checkins</code></li>
  <li class="calibre14"><code class="calibre15">/places/45/checkins/91</code></li>
  <li class="calibre14"><code class="calibre15">/checkins/91</code></li>
</ul>

<p class="calibre3">Consistency is key.</p>

<h4 id="calibre_link-117" class="calibre4">Verb or Noun?</h4>

<p class="calibre3">Traditionally APIs would consist of a series of endpoints that described actions:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">POST</code> <code class="o">/</code><code class="calibre15">SendUserMessage</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="nl">Host:</code> <code class="calibre15">example</code><code class="calibre15">.</code><code class="calibre15">com</code>
<code class="lineno">3</code> <code class="calibre15">Content</code><code class="o">-</code><code class="calibre15">Type</code><code class="o">:</code> <code class="calibre15">application</code><code class="o">/</code><code class="calibre15">x</code><code class="o">-</code><code class="calibre15">www</code><code class="o">-</code><code class="calibre15">form</code><code class="o">-</code><code class="calibre15">urlencoded</code>
<code class="lineno">4</code> 
<code class="lineno">5</code> <code class="calibre15">id</code><code class="o">=</code><code class="o">5</code><code class="o">&amp;</code><code class="calibre15">message</code><code class="o">=</code><code class="calibre15">Hello</code><code class="o">!</code>
</pre></div>

</figure>

<p class="calibre3">As you might have already gathered, this is not how things are done with REST.</p>

<p class="calibre3">Some API developers consider the following approach to be more RESTful because it uses a subresource:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">POST</code> <code class="o">/</code><code class="calibre15">users</code><code class="o">/</code><code class="o">5</code><code class="o">/</code><code class="calibre15">send</code><code class="o">-</code><code class="calibre15">message</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="nl">Host:</code> <code class="calibre15">example</code><code class="calibre15">.</code><code class="calibre15">com</code>
<code class="lineno">3</code> <code class="calibre15">Content</code><code class="o">-</code><code class="calibre15">Type</code><code class="o">:</code> <code class="calibre15">application</code><code class="o">/</code><code class="calibre15">json</code>
<code class="lineno">4</code> 
<code class="lineno">5</code> <code class="calibre15">{</code> <code class="s">"message"</code> <code class="o">:</code> <code class="s">"Hello!"</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Nope, because that is still using a verb in the URL. A verb is an action - a doing term - and our API
only needs one verb - the HTTP Method. All other verbs need to stay out of the URL.</p>

<p class="calibre3">A noun is a <em class="calibre19">place</em> or a <em class="calibre19">thing</em>. Resources are things, and a URL becomes the place on the Internet where a thing lives.</p>

<p class="calibre3">This example would be drastically more RESTful:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">POST</code> <code class="o">/</code><code class="calibre15">users</code><code class="o">/</code><code class="o">5</code><code class="o">/</code><code class="calibre15">messages</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="nl">Host:</code> <code class="calibre15">example</code><code class="calibre15">.</code><code class="calibre15">com</code>
<code class="lineno">3</code> <code class="calibre15">Content</code><code class="o">-</code><code class="calibre15">Type</code><code class="o">:</code> <code class="calibre15">application</code><code class="o">/</code><code class="calibre15">json</code>
<code class="lineno">4</code> 
<code class="lineno">5</code> <code class="calibre15">{</code> <code class="s">"message"</code> <code class="o">:</code> <code class="s">"Hello!"</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Perfect! We are creating a new message that belongs to a user. The best part about keeping it nice and RESTful like this is that other HTTP actions can be made to the identical URL:</p>

<ul class="calibre18">
  <li class="calibre14"><code class="calibre15">GET /users/philsturgeon/messages</code></li>
  <li class="calibre14"><code class="calibre15">PATCH /users/philsturgeon/messages/xdWRwerG</code></li>
  <li class="calibre14"><code class="calibre15">DELETE /users/philsturgeon/messages/xdWRwerG</code></li>
</ul>

<p class="calibre3">This is all much easier to document and much easier to understand for both humans and software which is “RESTfully aware.”</p>

<p class="calibre3">If, like a freelance client I consulted, you need to send multiple messages to multiple users (potentially hundreds of
thousands) you could even make messages its own endpoint and send the messages in batches of a few hundred:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">POST</code> <code class="o">/</code><code class="calibre15">messages</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno"> 2</code> <code class="nl">Host:</code> <code class="calibre15">example</code><code class="calibre15">.</code><code class="calibre15">com</code>
<code class="lineno"> 3</code> <code class="calibre15">Content</code><code class="o">-</code><code class="calibre15">Type</code><code class="o">:</code> <code class="calibre15">application</code><code class="o">/</code><code class="calibre15">json</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code> <code class="calibre15">[</code>
<code class="lineno"> 6</code> 	<code class="calibre15">{</code>
<code class="lineno"> 7</code> 		<code class="s">"user"</code> <code class="o">:</code> <code class="calibre15">{</code> <code class="s">"id"</code> <code class="o">:</code> <code class="o">10</code> <code class="calibre15">},</code>
<code class="lineno"> 8</code> 		<code class="s">"message"</code> <code class="o">:</code> <code class="s">"Hello!"</code>
<code class="lineno"> 9</code> 	<code class="calibre15">},</code>
<code class="lineno">10</code> 	<code class="calibre15">{</code>
<code class="lineno">11</code> 		<code class="s">"user"</code> <code class="o">:</code> <code class="calibre15">{</code> <code class="s">"username"</code> <code class="o">:</code> <code class="s">"philsturgeon"</code> <code class="calibre15">},</code>
<code class="lineno">12</code> 		<code class="s">"message"</code> <code class="o">:</code> <code class="s">"Hello!"</code>
<code class="lineno">13</code> 	<code class="calibre15">}</code>
<code class="lineno">14</code> <code class="calibre15">]</code>
</pre></div>

</figure>

<p class="calibre3">It would look incredibly similar to create the data as it would to retrieve the data, which is intentional.</p>

<h3 id="calibre_link-13" class="calibre2">
<span class="section-number">2.3 </span>Planning Endpoints</h3>

<h4 id="calibre_link-118" class="calibre4">Controllers</h4>

<p class="calibre3">You need to list events, venues, users and categories? Easy. One controller for each type of resource:</p>

<ul class="calibre18">
  <li class="calibre14">CategoriesController</li>
  <li class="calibre14">EventsController</li>
  <li class="calibre14">UsersController</li>
  <li class="calibre14">VenuesController</li>
</ul>

<p class="calibre3">Everything should be a resource, and each resource needs a controller.</p>

<p class="calibre3">Later on we will look at some things that are not resources. Subresources can sometimes just be a method. For example, profile and settings are a subresource of users, so maybe they can go in <code class="calibre15">UsersController</code>. These rules are flexible.</p>

<h4 id="calibre_link-119" class="calibre4">Routes</h4>

<p class="calibre3">Try to avoid the temptation to screw around with <a href="https://philsturgeon.uk/blog/2013/07/beware-the-route-to-evil">magic routing conventions</a>, it is best to just write them manually. I will keep going with the previous examples and show the process of turning the action plan into routes using Laravel syntax, because why not:</p>

<table class="calibre24">
  <thead class="calibre25">
    <tr class="calibre26">
      <th class="calibre27">Action</th>
      <th class="calibre27">Endpoint</th>
      <th class="calibre27">Route</th>
    </tr>
  </thead>
  <tbody class="calibre28">
    <tr class="calibre26">
      <td class="calibre29">Create</td>
      <td class="calibre29"><code class="calibre15">POST /users</code></td>
      <td class="calibre29"><code class="calibre15">Route::post('users', 'UsersController@create'); </code></td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Read</td>
      <td class="calibre29"><code class="calibre15">GET /users/X</code></td>
      <td class="calibre29"><code class="calibre15">Route::get('users/{id}', 'UsersController@show');</code></td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Update</td>
      <td class="calibre29"><code class="calibre15">PUT /users/X</code></td>
      <td class="calibre29"><code class="calibre15">Route::put('users/{id}', 'UsersController@update');</code></td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Delete</td>
      <td class="calibre29"><code class="calibre15">DELETE /users/X</code></td>
      <td class="calibre29"><code class="calibre15">Route::delete('users/{id}', 'UsersController@delete');</code></td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">List</td>
      <td class="calibre29"><code class="calibre15">GET /users</code></td>
      <td class="calibre29"><code class="calibre15">Route::get('users', 'UsersController@list');</code></td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Image</td>
      <td class="calibre29"><code class="calibre15">PUT /users/X/image</code></td>
      <td class="calibre29"><code class="calibre15">Route::put('users/{id}/image', 'UsersController@uploadImage');</code></td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Favorites</td>
      <td class="calibre29"><code class="calibre15">GET /users/X/favorites</code></td>
      <td class="calibre29"><code class="calibre15">Route::get('users/{id}/favorites', 'UsersController@favorites');</code></td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Checkins</td>
      <td class="calibre29"><code class="calibre15">GET /users/X/checkins</code></td>
      <td class="calibre29"><code class="calibre15">Route::get('users/{user_id}/checkins', 'CheckinsController@index');</code></td>
    </tr>
  </tbody>

</table>

<p class="calibre3">There are a few things in here worth considering.</p>

<ol class="calibre13">
  <li class="calibre14">Favorites go to the <code class="calibre15">UserController</code> because favorites are only ever relevant to the user.</li>
  <li class="calibre14">Checkins go to the <code class="calibre15">CheckinController</code> because we might already have a checkin controller handling
<code class="calibre15">/checkins</code> and the logic is basically identical. We will know if there is a <code class="calibre15">user_id</code> param in the URL
if our router is nice enough to let us know, so we can use that to make it user specific if needs be.</li>
</ol>

<p class="calibre3">They are rather complex concerns, but are examples of things you can be thinking about at this point. You want to avoid having multiple endpoints doing painfully similar things with copy and paste logic because:</p>

<ol class="calibre13">
  <li class="calibre14">
<a href="https://github.com/sebastianbergmann/phpcpd">PHP Copy/Paste Detector</a> will be angry.</li>
  <li class="calibre14">Your iPhone developer will be mad that different endpoints provide the same resource, but in a slightly different format, therefore confusing RestKit.</li>
  <li class="calibre14">It is boring and “ain’t nobody got time for that!”</li>
</ol>

<h4 id="calibre_link-120" class="calibre4">Methods</h4>

<p class="calibre3">When you have listed all of the routes you will need for your application, go and make the corresponding controller methods. Make them all empty and have one of them <code class="calibre15">return "Oh hai!";</code>, and check the output. <code class="calibre15">GET /places</code> for example should <code class="calibre15">Oh hai!</code> in the browser.</p>

<p class="calibre3">You just wrote an API.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-89">
<div class="calibre6">
<h2 id="calibre_link-14" class="calibre1">
<span class="section-number">3. </span>Input and Output Theory</h2>

<h3 id="calibre_link-15" class="calibre2">
<span class="section-number">3.1 </span>Introduction</h3>

<p class="calibre3">Now that we have a good idea of how endpoints work, the next glass of theory to swallow down is “input” and “output”. This is the easiest of all, as it’s really just HTTP “requests” and “responses”. This is the same as AJAX or anything else.</p>

<p class="calibre3">If you have ever been forced to work with SOAP, you will know all about WSDLs. If you know what they are, be happy you no longer need them. If you do not know what a WSDL is, then be happy you never have to learn. SOAP was the worst.</p>

<p class="calibre3">Input is purely an HTTP request, and there are multiple parts to this.</p>

<h3 id="calibre_link-16" class="calibre2">
<span class="section-number">3.2 </span>Requests</h3>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nf">GET</code> <code class="nc">/places?lat=40.759211&amp;lon=-73.984638</code> <code class="k">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="na">Host</code><code class="o">:</code> <code class="calibre15">api.example.com</code>
</pre></div>

</figure>

<p class="calibre3">This is a very simple <code class="calibre15">GET</code> request. We can see the URL path being requested is <code class="calibre15">/places</code> with a query string of <code class="calibre15">lat=40.759211&amp;lon=-73.984638</code>. The HTTP version in use is HTTP/1.1; the host name is defined. This is essentially what your browser does when you go to any website - rather boring I’m sure.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nf">POST</code> <code class="nc">/moments/1/gift</code> <code class="k">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="na">Host</code><code class="o">:</code> <code class="calibre15">api.example.com</code>
<code class="lineno">3</code> <code class="na">Authorization</code><code class="o">:</code> <code class="calibre15">Bearer vr5HmMkzlxKE70W1y4MibiJUusZwZC25NOVBEx3BD1</code>
<code class="lineno">4</code> <code class="na">Content-Type</code><code class="o">:</code> <code class="calibre15">application/json</code>
<code class="lineno">5</code> 
<code class="lineno">6</code> <code class="calibre15">{</code> <code class="k">"user_id"</code> <code class="calibre15">:</code> <code class="o">2</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Here we make a POST request with an “HTTP body”. The <code class="calibre15">Content-Type</code> header points out we are sending JSON and the blank line above the JSON separates the “HTTP headers” from the “HTTP body”. HTTP really is amazingly simple. This is all you need to do for anything, and you can do all of this with an HTTP client in whatever programming language you feel like using this week:</p>

<figure class="code">
  <figcaption class="calibre20">Using PHP and the Guzzle HTTP library to make an HTTP Request</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="k">use</code> <code class="calibre15">Guzzle\Http\Client</code><code class="calibre15">;</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="nv">$headers</code> <code class="o">=</code> <code class="calibre15">[</code>
<code class="lineno"> 4</code>     <code class="s">'Authorization'</code> <code class="o">=&gt;</code> <code class="s">'Bearer vr5HmMkzlxKE70W1y4MibiJUusZwZC25NOVBEx3BD1'</code><code class="calibre15">,</code>
<code class="lineno"> 5</code>     <code class="s">'Content-Type'</code> <code class="o">=&gt;</code> <code class="s">'application/json'</code><code class="calibre15">,</code>
<code class="lineno"> 6</code> <code class="calibre15">];</code>
<code class="lineno"> 7</code> <code class="nv">$payload</code> <code class="o">=</code> <code class="calibre15">[</code>
<code class="lineno"> 8</code>     <code class="s">'user_id'</code> <code class="o">=&gt;</code> <code class="o">2</code>
<code class="lineno"> 9</code> <code class="calibre15">];</code>
<code class="lineno">10</code> 
<code class="lineno">11</code> <code class="c">// Create a client and provide a base URL</code>
<code class="lineno">12</code> <code class="nv">$client</code> <code class="o">=</code> <code class="k">new</code> <code class="calibre15">Client</code><code class="calibre15">(</code><code class="s">'http://api.example.com'</code><code class="calibre15">);</code>
<code class="lineno">13</code> 
<code class="lineno">14</code> <code class="nv">$req</code> <code class="o">=</code> <code class="nv">$client</code><code class="o">-&gt;</code><code class="na">post</code><code class="calibre15">(</code><code class="s">'/moments/1/gift'</code><code class="calibre15">,</code> <code class="nv">$headers</code><code class="calibre15">,</code> <code class="nb">json_encode</code><code class="calibre15">(</code><code class="nv">$payload</code><code class="calibre15">));</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption class="calibre20">Using Python and the Requests HTTP library to make an HTTP Request </figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="k">import</code> <code class="nc">json</code>
<code class="lineno"> 2</code> <code class="k">import</code> <code class="nc">requests</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code> <code class="calibre15">headers</code> <code class="o">=</code> <code class="calibre15">{</code>
<code class="lineno"> 5</code>     <code class="s">'Authorization'</code><code class="calibre15">:</code> <code class="s">'Bearer vr5HmMkzlxKE70W1y4MibiJUusZwZC25NOVBEx3BD1'</code><code class="calibre15">,</code>
<code class="lineno"> 6</code>     <code class="s">'Content-Type'</code><code class="calibre15">:</code> <code class="s">'application/json'</code><code class="calibre15">,</code>
<code class="lineno"> 7</code> <code class="calibre15">}</code>
<code class="lineno"> 8</code> <code class="calibre15">payload</code> <code class="o">=</code> <code class="calibre15">{</code>
<code class="lineno"> 9</code>     <code class="s">'user_id'</code><code class="calibre15">:</code> <code class="o">2</code>
<code class="lineno">10</code> <code class="calibre15">}</code>
<code class="lineno">11</code> <code class="calibre15">req</code> <code class="o">=</code> <code class="calibre15">requests</code><code class="o">.</code><code class="calibre15">post</code><code class="calibre15">(</code>
<code class="lineno">12</code>   <code class="s">'http://api.example.com/moments/1/gift'</code><code class="calibre15">,</code>
<code class="lineno">13</code>   <code class="calibre15">data</code><code class="o">=</code><code class="calibre15">json</code><code class="o">.</code><code class="calibre15">dumps</code><code class="calibre15">(</code><code class="calibre15">payload</code><code class="calibre15">),</code>
<code class="lineno">14</code>   <code class="calibre15">headers</code><code class="o">=</code><code class="calibre15">headers</code>
<code class="lineno">15</code> <code class="calibre15">)</code>
</pre></div>

</figure>

<p class="calibre3">It’s all the same. Define your headers, define the body in an appropriate format, and send it on its way. Then you get a response; so let’s talk about that.</p>

<h3 id="calibre_link-17" class="calibre2">
<span class="section-number">3.3 </span>Responses</h3>

<p class="calibre3">Much the same as an HTTP Request, your HTTP Response is going to end up as plain text (unless you’re using SSL, but shut up, we aren’t there yet).</p>

<figure class="code">
  <figcaption class="calibre20">Example HTTP response containing a JSON body</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="k">HTTP</code><code class="o">/</code><code class="o">1.1</code> <code class="o">200</code> <code class="ne">OK</code>
<code class="lineno"> 2</code> <code class="na">Server</code><code class="o">:</code> <code class="calibre15">nginx</code>
<code class="lineno"> 3</code> <code class="na">Content-Type</code><code class="o">:</code> <code class="calibre15">application/json</code>
<code class="lineno"> 4</code> <code class="na">Connection</code><code class="o">:</code> <code class="calibre15">close</code>
<code class="lineno"> 5</code> <code class="na">X-Powered-By</code><code class="o">:</code> <code class="calibre15">PHP/5.5.5-1+debphp.org~quantal+2</code>
<code class="lineno"> 6</code> <code class="na">Cache-Control</code><code class="o">:</code> <code class="calibre15">no-cache, private</code>
<code class="lineno"> 7</code> <code class="na">Date</code><code class="o">:</code> <code class="calibre15">Fri, 22 Nov 2013 16:37:57 GMT</code>
<code class="lineno"> 8</code> <code class="na">Transfer-Encoding</code><code class="o">:</code> <code class="calibre15">Identity</code>
<code class="lineno"> 9</code> 
<code class="lineno">10</code> <code class="calibre15">{</code>
<code class="lineno">11</code>   <code class="k">"id"</code><code class="calibre15">:</code><code class="s">"1690"</code><code class="calibre15">,</code>
<code class="lineno">12</code>   <code class="k">"is_gift"</code><code class="calibre15">:</code><code class="k">true</code><code class="calibre15">,</code>
<code class="lineno">13</code>   <code class="k">"user"</code><code class="calibre15">:{</code>
<code class="lineno">14</code>     <code class="k">"id"</code><code class="calibre15">:</code><code class="o">1</code><code class="calibre15">,</code>
<code class="lineno">15</code>     <code class="k">"name"</code><code class="calibre15">:</code><code class="s">"Theron Weissnat"</code><code class="calibre15">,</code>
<code class="lineno">16</code>     <code class="k">"bio"</code><code class="calibre15">:</code><code class="s">"Occaecati excepturi magni odio distinctio dolores."</code><code class="calibre15">,</code>
<code class="lineno">17</code>     <code class="k">"gender"</code><code class="calibre15">:</code><code class="s">"female"</code><code class="calibre15">,</code>
<code class="lineno">18</code>     <code class="k">"picture_url"</code><code class="calibre15">:</code><code class="s">"https:\/\/cdn.example.com/foo.png"</code><code class="calibre15">,</code>
<code class="lineno">19</code>     <code class="k">"timezone"</code><code class="calibre15">:</code><code class="o">-1</code><code class="calibre15">,</code>
<code class="lineno">20</code>     <code class="k">"birthday"</code><code class="calibre15">:</code><code class="s">"1989-09-17 16:27:36"</code><code class="calibre15">,</code>
<code class="lineno">21</code>     <code class="k">"status"</code><code class="calibre15">:</code><code class="s">"available"</code><code class="calibre15">,</code>
<code class="lineno">22</code>     <code class="k">"created_at"</code><code class="calibre15">:</code><code class="s">"2013-11-22 16:37:57"</code><code class="calibre15">,</code>
<code class="lineno">23</code>     <code class="k">"redeem_by"</code><code class="calibre15">:</code><code class="s">"2013-12-22 16:37:57"</code>
<code class="lineno">24</code>   <code class="calibre15">}</code>
<code class="lineno">25</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">We can spot some fairly obvious things here. <code class="calibre15">200 OK</code> is a standard no-issues-here-buddy response. We have a <code class="calibre15">Content-Type</code> again, and the API is pointing out that caching this is not ok. The <code class="calibre15">X-Powered-By</code> header is also a nice little reminder that I should switch <code class="calibre15">expose_php = On</code> to <code class="calibre15">expose_php = Off</code> in php.ini. Oops.</p>

<p class="calibre3">This is essentially the majority of how an API works. Just like learning a programming language, you will always come across new functions and utilities that will improve the RESTful-ness of your API. I will point out a bunch of them as we go, but just like the <a href="http://php.net/manual/en/function.levenshtein.php">levenshtein()</a> function in PHP, there will be HTTP Headers that you had no idea existed popping up that will make you think, “How the shit did I not notice that?”.</p>

<h3 id="calibre_link-18" class="calibre2">
<span class="section-number">3.4 </span>Supporting Formats</h3>

<p class="calibre3">Picking what formats to support is hard, but there are a few easy wins to make early on.</p>

<h4 id="calibre_link-121" class="calibre4">No Form Data</h4>

<p class="calibre3">PHP developers always try to do something that literally nobody else does, and that is to send form data to the API using the <code class="calibre15">application/x-www-form-urlencoded</code> content type.</p>

<p class="calibre3">This content type is one of the few ways that browsers send data via a form when you use HTTP POST, and PHP will take that data, slice it up, and make it available in <code class="calibre15">$_POST</code>. Because of this convenient feature, many PHP developers will make their API send data that way. Later they wonder why sending data with PUT is “different” and wonder why there is no <code class="calibre15">$_PUT</code> in PHP.</p>

<p class="calibre3">Urf.</p>

<p class="calibre3"><code class="calibre15">$_GET</code> and <code class="calibre15">$_POST</code> do not have the 1:1 relationship with HTTP GET and HTTP POST as their names might suggest. <code class="calibre15">$_GET</code> just contains query string content <em class="calibre19">regardless</em> of the HTTP method. <code class="calibre15">$_POST</code> contains the values of the HTTP Body if it was in the right format, and the <code class="calibre15">Content-Type</code> header is <code class="calibre15">application/x-www-form-urlencoded</code>. An HTTP POST item could still have a query string, and that would still be in <code class="calibre15">$_GET</code>. Some PHP frameworks kill off <code class="calibre15">$_GET</code> data in an HTTP POST request, which further exaggerates this 1:1 relationship between the superglobal and the method.</p>

<p class="calibre3">Knowing that PHP has some silly names for things, we can move on and completely ignore <code class="calibre15">$_POST</code>. Pour one out in the ground, because it is dead to you.</p>

<p class="calibre3">Why? So many reasons, including the fact that once again everything in <code class="calibre15">application/x-www-form-urlencoded</code> is a string.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="err">foo=something&amp;bar=1&amp;baz=0</code>
</pre></div>

</figure>

<p class="calibre3">Yeah, you have to use <code class="calibre15">1</code> or <code class="calibre15">0</code> because <code class="calibre15">bar=true</code> would be <code class="calibre15">string("true")</code> on the server-side. Data types are important, so let’s not just throw them out the window for the sake of “easy access to our data”. That argument is also moronic as something like <code class="calibre15">Input::json('foo')</code> is possible in most decent PHP frameworks. Even without it, you just have to use <code class="calibre15">file_get_contents('php://input')</code> to read the HTTP body yourself.</p>

<aside class="warning">
    <h4 id="calibre_link-122" class="calibre21">php://input on &lt; PHP 5.6</h4>
  <p class="calibre3">In versions of PHP prior to 5.6 the input stream would empty after first read. Basically, if you tried to read the
HTTP body twice, the second attempt would fail. This has been fixed in PHP 5.6.0 so feel free to hit it as many times
as you like.</p>

</aside>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="nf">POST</code> <code class="nc">/checkins</code> <code class="k">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno"> 2</code> <code class="na">Host</code><code class="o">:</code> <code class="calibre15">api.example.com</code>
<code class="lineno"> 3</code> <code class="na">Authorization</code><code class="o">:</code> <code class="calibre15">Bearer vr5HmMkzlxKE70W1y4MibiJUusZwZC25NOVBEx3BD1</code>
<code class="lineno"> 4</code> <code class="na">Content-Type</code><code class="o">:</code> <code class="calibre15">application/json</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code> <code class="calibre15">{</code>
<code class="lineno"> 7</code>     <code class="k">"checkin"</code><code class="calibre15">:</code> <code class="calibre15">{</code>
<code class="lineno"> 8</code>         <code class="k">"place_id"</code> <code class="calibre15">:</code> <code class="o">1</code><code class="calibre15">,</code>
<code class="lineno"> 9</code>         <code class="k">"message"</code><code class="calibre15">:</code> <code class="s">"This is a bunch of text."</code><code class="calibre15">,</code>
<code class="lineno">10</code>         <code class="k">"with_friends"</code><code class="calibre15">:</code> <code class="calibre15">[</code><code class="o">1</code><code class="calibre15">,</code> <code class="o">2</code><code class="calibre15">,</code> <code class="o">3</code><code class="calibre15">,</code> <code class="o">4</code><code class="calibre15">,</code> <code class="o">5</code><code class="calibre15">]</code>
<code class="lineno">11</code>     <code class="calibre15">}</code>
<code class="lineno">12</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">This is a perfectly valid HTTP body for a checkin. You know what they are saying. You know who the user is from their auth token. You know who they are with and you get the benefit of having it wrapped up in a single <code class="calibre15">checkin</code> key for simple documentation, and, easy “You sent a checkin object to the user settings page, muppet.” responses.</p>

<p class="calibre3">That same request using form data is a mess.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nf">POST</code> <code class="nc">/checkins</code> <code class="k">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="na">Host</code><code class="o">:</code> <code class="calibre15">api.example.com</code>
<code class="lineno">3</code> <code class="na">Authorization</code><code class="o">:</code> <code class="calibre15">Bearer vr5HmMkzlxKE70W1y4MibiJUusZwZC25NOVBEx3BD1</code>
<code class="lineno">4</code> <code class="na">Content-Type</code><code class="o">:</code> <code class="calibre15">application/x-www-form-urlencoded</code>
<code class="lineno">5</code> 
<code class="lineno">6</code> checkin[place_id]=1&amp;checkin[message]=This is a bunch of text&amp;checkin[with_friends][]=\
<code class="lineno">7</code> 1&amp;checkin[with_friends][]=2&amp;checkin[with_friends][]=3&amp;checkin[with_friends][]=4&amp;check\
<code class="lineno">8</code> in[with_friends][]=5
</pre></div>

</figure>

<p class="calibre3">This makes me upset <em class="calibre19">and</em> angry. Do not do it in your API.</p>

<p class="calibre3">Finally, do not try to be clever by mixing JSON with form data:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="nf">POST</code> <code class="nc">/checkins</code> <code class="k">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno"> 2</code> <code class="na">Host</code><code class="o">:</code> <code class="calibre15">api.example.com</code>
<code class="lineno"> 3</code> <code class="na">Authorization</code><code class="o">:</code> <code class="calibre15">Bearer vr5HmMkzlxKE70W1y4MibiJUusZwZC25NOVBEx3BD1</code>
<code class="lineno"> 4</code> <code class="na">Content-Type</code><code class="o">:</code> <code class="calibre15">application/x-www-form-urlencoded</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code> json="{
<code class="lineno"> 7</code>     \"checkin\": {
<code class="lineno"> 8</code>         \"place_id\" : 1,
<code class="lineno"> 9</code>         \"message\": \"This is a bunch of text.\",
<code class="lineno">10</code>         \"with_friends\": [1, 2, 3, 4, 5]
<code class="lineno">11</code>     }
<code class="lineno">12</code> }"
</pre></div>

</figure>

<p class="calibre3">Who is the developer trying to impress with stuff like that? It is insanity, and anyone who tries this needs to have their badge and gun revoked. </p>

<p class="calibre3">Developers do this because they still want “easy access” to their JSON, but do not know how to read it from the HTTP Body correctly.</p>

<p class="calibre3">Sending proper JSON data is rather simple in most server-side languages as demonstrated at the start of this chapter, but
JavaScript can be a little different. If you are working with frameworks, like Backbone, EmberJS and AngularJS, then 
they will most likely be handling their data interactions with your API in JSON already.</p>

<p class="calibre3">If you need to do this manually, you can use jQuery’s <code class="calibre15">$.ajax()</code> method:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">$</code><code class="calibre15">.</code><code class="calibre15">ajax</code><code class="calibre15">({</code>
<code class="lineno">2</code>   <code class="calibre15">type</code><code class="o">:</code> <code class="s">"POST"</code><code class="calibre15">,</code>
<code class="lineno">3</code>   <code class="calibre15">url</code><code class="o">:</code> <code class="calibre15">url</code><code class="calibre15">,</code>
<code class="lineno">4</code>   <code class="calibre15">data</code><code class="o">:</code> <code class="calibre15">{</code> <code class="calibre15">foo</code> <code class="o">:</code> <code class="s">"bar"</code> <code class="calibre15">},</code>
<code class="lineno">5</code>   <code class="calibre15">success</code><code class="o">:</code> <code class="calibre15">success</code><code class="calibre15">,</code>
<code class="lineno">6</code>   <code class="calibre15">dataType</code><code class="o">:</code> <code class="s">"json"</code>
<code class="lineno">7</code> <code class="calibre15">});</code>
</pre></div>

</figure>

<p class="calibre3">This is a very manual approach, which may be too time consuming, so jQuery has another solution.
<a href="http://api.jquery.com/serializearray/">The <code class="calibre15">$.serializeArray()</code> method</a> can turn values from all matched elements into a JSON string for you
to then send to the API.</p>

<h4 id="calibre_link-123" class="calibre4">JSON and XML</h4>

<p class="calibre3">Any modern API you interact with will support JSON unless it is a financial services API, or the developer is a moron - probably both to be fair. Sometimes they will support XML too. XML used to be the popular format for data transfer with both SOAP and XML-RPC (duh). XML is, however, a nasty-ass disgusting mess of tags, and the file-size of an XML file containing the same data as a JSON file is often much larger.</p>

<p class="calibre3">Beyond purely the size of the data being stored, XML is horribly bad at storing type. That might not worry a PHP developer all that much as PHP is not really any better when it comes to type, but look at this:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">{</code>
<code class="lineno">2</code>     <code class="s">"place"</code><code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno">3</code>         <code class="s">"id"</code> <code class="o">:</code> <code class="o">1</code><code class="calibre15">,</code>
<code class="lineno">4</code>         <code class="s">"name"</code><code class="o">:</code> <code class="s">"This is a bunch of text."</code><code class="calibre15">,</code>
<code class="lineno">5</code>         <code class="s">"is_true"</code><code class="o">:</code> <code class="k">false</code><code class="calibre15">,</code>
<code class="lineno">6</code>         <code class="s">"maybe"</code><code class="o">:</code> <code class="k">null</code><code class="calibre15">,</code>
<code class="lineno">7</code>         <code class="s">"empty_string"</code><code class="o">:</code> <code class="s">""</code>
<code class="lineno">8</code>     <code class="calibre15">}</code>
<code class="lineno">9</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">That response in XML:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="k">&lt;places&gt;</code>
<code class="lineno">2</code>     <code class="k">&lt;place&gt;</code>
<code class="lineno">3</code>         <code class="k">&lt;id&gt;</code>1<code class="k">&lt;/id&gt;</code>,
<code class="lineno">4</code>         <code class="k">&lt;name&gt;</code>This is a bunch of text.<code class="k">&lt;/name&gt;</code>
<code class="lineno">5</code>         <code class="k">&lt;is_true&gt;</code>0<code class="k">&lt;/is_true&gt;</code>
<code class="lineno">6</code>         <code class="k">&lt;maybe</code> <code class="k">/&gt;</code>
<code class="lineno">7</code>         <code class="k">&lt;empty_string</code> <code class="k">/&gt;</code>
<code class="lineno">8</code>     <code class="k">&lt;/place&gt;</code>
<code class="lineno">9</code> <code class="k">&lt;/places&gt;</code>
</pre></div>

</figure>

<p class="calibre3">Basically, in XML, <em class="calibre19">everything</em> is considered a string, meaning integers, booleans, and nulls can be confused. Both <code class="calibre15">maybe</code> and <code class="calibre15">empty_string</code> have the same value, because there is no way to denote a null value either. Gross.</p>

<p class="calibre3">Now, the XML-savvy among you will be wondering why I am not using attributes to simplify it? Well, this XML structure is a typical “auto-generated” chunk of XML converted from an array in the same way that JSON is built - but this of course ignores attributes and does not allow for all the specific structure that your average XML consumer will almost certainly demand.</p>

<p class="calibre3">If you want to start using attributes for some bits of data but not others, then your conversion logic becomes INSANELY complicated. How would we build something like this?</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="k">&lt;places&gt;</code>
<code class="lineno">2</code>     <code class="k">&lt;place</code> <code class="na">id=</code><code class="s">"1"</code> <code class="na">is_true=</code><code class="s">"1"</code><code class="k">&gt;</code>
<code class="lineno">3</code>         <code class="k">&lt;name&gt;</code>This is a bunch of text.<code class="k">&lt;/name&gt;</code>
<code class="lineno">4</code>         <code class="k">&lt;empty_string</code> <code class="k">/&gt;</code>
<code class="lineno">5</code>     <code class="k">&lt;/place&gt;</code>
<code class="lineno">6</code> <code class="k">&lt;/places&gt;</code>
</pre></div>

</figure>

<p class="calibre3">The answer is that unless you seek specific fields, try to guess that an “id” is probably an attribute, etc., then there is no programmatic way in your API to take the same array and make JSON <em class="calibre19">and</em> XML. Instead, you realistically need to use a “view” (from the MVC pattern) to represent this data, just like you would with HTML, or work with XML generation in a more OOP way. Either way, it is an abomination, and I refuse to work in those conditions. Luckily, nobody at Kapture wanted XML, so I did not have to rage quit back to England.</p>

<p class="calibre3">If your team is on the fence about XML, and you are not required by the business to use it, then skip it. It can be fun to show off your API switching formats and supporting all sorts of stuff (and we will get to that later on) but XML is a complication many APIs do not require these days.</p>

<p class="calibre3">Work out which format(s) you actually need, and <em class="calibre19">stick to those</em>. Sure Flickr supports <code class="calibre15">lolcat</code> as input and output, but they have a much bigger team, and that was probably the result of a hack project in which the development team were only paid with cold pizza. JSON is fine. If you have a lot of Ruby cool kids around, then you will probably want to output YAML too, which is as easy to generate as JSON in most cases.</p>

<h3 id="calibre_link-19" class="calibre2">
<span class="section-number">3.5 </span>Content Structure</h3>

<p class="calibre3">This is a tough topic and there is no right answer. Whether you use EmberJS, RestKit, or any other framework with knowledge of REST, you will find somebody annoyed that the data is not in their specific preferred format. There are a lot of factors, and I will simply explain them all and let you know where I landed.</p>

<h4 id="calibre_link-124" class="calibre4">JSON-API</h4>

<p class="calibre3">There is one recommended format on <a href="http://jsonapi.org/format/">JSON-API</a>, which maybe you all just want to use. It suggests that both single resources and resource collections should both be inside a plural key.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">{</code>
<code class="lineno">2</code>   <code class="s">"posts"</code><code class="o">:</code> <code class="calibre15">[{</code>
<code class="lineno">3</code>     <code class="s">"id"</code><code class="o">:</code> <code class="s">"1"</code><code class="calibre15">,</code>
<code class="lineno">4</code>     <code class="s">"title"</code><code class="o">:</code> <code class="s">"Rails is Omakase"</code>
<code class="lineno">5</code>   <code class="calibre15">}]</code>
<code class="lineno">6</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">
  <strong class="calibre22">Pros</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Consistent response - It <em class="calibre19">always</em> has the same structure</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Cons</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Some RESTful/Data utilities freak about having single responses in an array</li>
  <li class="calibre14">Potentially confusing to humans</li>
</ul>

<p class="calibre3">EmberJS (EmberData) used to have a rough time with JSON-API out of the box, but the EmberJS team and the
JSON-API people have worked together to improve the situation. Rails and AngularJS also have a lot of people focusing on JSON-API as a centralized standard too, but it is not always perfect.</p>

<p class="calibre3">JSON-API is a wonderful resource with a lot of great ideas, but it strikes me as over complicated in multiple areas. It is also (in April 2015) still not v1.0.0 final. RC versions are released with breaking changes every few months, and this can be a huge problem for those with previous versions already implemented and live.</p>

<aside class="information">
    <h4 id="calibre_link-125" class="calibre21">Update 2015-05-29: JSON-API v1.0</h4>
  <p class="calibre3">To little fanfare, JSON-API v1.0 has finally been released. It has solved a few of problems in previous RC versions. As predicted, the switch to v1.0 created more than a few problems for developers of APIs who had already implemented earlier versions.<br class="calibre6" />
Luckily, at Ride, we were not requiring the <code class="calibre15">application/vnd.api+json</code> mime type, which means we can use this as a switch. If nothing is provided, we know it’s our old API clients and default to JSON-API v1.0 RC2, but if that header is provided we can use a different adapter and serialize to JSON-API v1.0 final. A bit of a hack, but it works, and we do not have to implement versioning to do it.</p>

</aside>

<h4 id="calibre_link-126" class="calibre4">Twitter-style</h4>

<p class="calibre3">Ask for one user get one user:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">{</code>
<code class="lineno">2</code>   <code class="s">"name"</code><code class="o">:</code> <code class="s">"Hulk Hogan"</code><code class="calibre15">,</code>
<code class="lineno">3</code>   <code class="s">"id"</code><code class="o">:</code> <code class="s">"100002"</code>
<code class="lineno">4</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Ask for a collection of things, get a collection of things:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">[</code>
<code class="lineno"> 2</code>   <code class="calibre15">{</code>
<code class="lineno"> 3</code>     <code class="s">"name"</code><code class="o">:</code> <code class="s">"Hulk Hogan"</code><code class="calibre15">,</code>
<code class="lineno"> 4</code>     <code class="s">"id"</code><code class="o">:</code> <code class="s">"100002"</code>
<code class="lineno"> 5</code>   <code class="calibre15">},</code>
<code class="lineno"> 6</code>   <code class="calibre15">{</code>
<code class="lineno"> 7</code>     <code class="s">"name"</code><code class="o">:</code> <code class="s">"Mick Foley"</code><code class="calibre15">,</code>
<code class="lineno"> 8</code>     <code class="s">"id"</code><code class="o">:</code> <code class="s">"100003"</code>
<code class="lineno"> 9</code>   <code class="calibre15">}</code>
<code class="lineno">10</code> <code class="calibre15">]</code>
</pre></div>

</figure>

<p class="calibre3">
  <strong class="calibre22">Pros</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Minimalistic response</li>
  <li class="calibre14">Almost every framework/utility can comprehend it</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Cons</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">No space for pagination or other metadata</li>
</ul>

<p class="calibre3">This is potentially a reasonable solution if you will never use pagination or metadata.</p>

<h4 id="calibre_link-127" class="calibre4">Facebook-style</h4>

<p class="calibre3">Ask for one user get one user:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">{</code>
<code class="lineno">2</code>   <code class="s">"name"</code><code class="o">:</code> <code class="s">"Hulk Hogan"</code><code class="calibre15">,</code>
<code class="lineno">3</code>   <code class="s">"id"</code><code class="o">:</code> <code class="s">"100002"</code>
<code class="lineno">4</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Ask for a collection of things, get a collection of things, but namespaced:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>   <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno"> 3</code>     <code class="calibre15">{</code>
<code class="lineno"> 4</code>       <code class="s">"name"</code><code class="o">:</code> <code class="s">"Hulk Hogan"</code><code class="calibre15">,</code>
<code class="lineno"> 5</code>       <code class="s">"id"</code><code class="o">:</code> <code class="s">"100002"</code>
<code class="lineno"> 6</code>     <code class="calibre15">},</code>
<code class="lineno"> 7</code>     <code class="calibre15">{</code>
<code class="lineno"> 8</code>       <code class="s">"name"</code><code class="o">:</code> <code class="s">"Mick Foley"</code><code class="calibre15">,</code>
<code class="lineno"> 9</code>       <code class="s">"id"</code><code class="o">:</code> <code class="s">"100003"</code>
<code class="lineno">10</code>     <code class="calibre15">}</code>
<code class="lineno">11</code>   <code class="calibre15">]</code>
<code class="lineno">12</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">
  <strong class="calibre22">Pros</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Space for pagination and other metadata in collection</li>
  <li class="calibre14">Simplistic response even with the extra namespace</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Cons</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Single items still can only have metadata by embedding it in the item resource</li>
</ul>

<p class="calibre3">By placing the collection into the <code class="calibre15">"data"</code> namespace, you can easily add other content next to it, which relates to the response, but is not part of the list of resources at all. Counts, links, etc., can all go here (more on this later). It also
means when you embed other nested relationships you can include a <code class="calibre15">”data”</code> element for them and even include metadata for those embedded relationships. More on that later too.</p>

<p class="calibre3">The only potential “con” left with Facebook is that the single resources are not namespaced, meaning that adding any sort of metadata would pollute the global namespace - something which PHP developers are against after a decade of flagrantly doing so.</p>

<p class="calibre3">So the final output example (and the one which I used at Kapture for v4) is the following.</p>

<h4 id="calibre_link-128" class="calibre4">Much Namespace, Nice Output</h4>

<p class="calibre3">Namespace the resource:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">{</code>
<code class="lineno">2</code>   <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno">3</code>     <code class="s">"name"</code><code class="o">:</code> <code class="s">"Phil Sturgeon"</code><code class="calibre15">,</code>
<code class="lineno">4</code>     <code class="s">"id"</code><code class="o">:</code> <code class="s">"511501255"</code>
<code class="lineno">5</code>   <code class="calibre15">}</code>
<code class="lineno">6</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Namespace the collection:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>   <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno"> 3</code>     <code class="calibre15">{</code>
<code class="lineno"> 4</code>       <code class="s">"name"</code><code class="o">:</code> <code class="s">"Hulk Hogan"</code><code class="calibre15">,</code>
<code class="lineno"> 5</code>       <code class="s">"id"</code><code class="o">:</code> <code class="s">"100002"</code>
<code class="lineno"> 6</code>     <code class="calibre15">},</code>
<code class="lineno"> 7</code>     <code class="calibre15">{</code>
<code class="lineno"> 8</code>       <code class="s">"name"</code><code class="o">:</code> <code class="s">"Mick Foley"</code><code class="calibre15">,</code>
<code class="lineno"> 9</code>       <code class="s">"id"</code><code class="o">:</code> <code class="s">"100003"</code>
<code class="lineno">10</code>     <code class="calibre15">}</code>
<code class="lineno">11</code>   <code class="calibre15">]</code>
<code class="lineno">12</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">This is close to the JSON-API response. It has the benefits of the Facebook approach, and is just like Twitter, but
everything is namespaced. Some folks (including me in the past) will suggest that you should change <code class="calibre15">"data"</code> to <code class="calibre15">"users"</code>,
 but when you start to nest your data, you want to keep that special name for the name of the relationship. For example:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>   <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno"> 3</code>     <code class="s">"name"</code><code class="o">:</code> <code class="s">"Hulk Hogan"</code><code class="calibre15">,</code>
<code class="lineno"> 4</code>     <code class="s">"id"</code><code class="o">:</code> <code class="s">"100002"</code>
<code class="lineno"> 5</code>     <code class="s">"comments"</code><code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno"> 6</code>         <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno"> 7</code>             <code class="calibre15">{</code>
<code class="lineno"> 8</code>               <code class="s">"id"</code><code class="o">:</code> <code class="o">123423</code>
<code class="lineno"> 9</code>               <code class="s">"text"</code><code class="o">:</code> <code class="s">"Sorry I said those inappropriate things!"</code>
<code class="lineno">10</code>             <code class="calibre15">}</code>
<code class="lineno">11</code>         <code class="calibre15">]</code>
<code class="lineno">12</code>     <code class="calibre15">}</code>
<code class="lineno">13</code>   <code class="calibre15">}</code>
<code class="lineno">14</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">So here we can see the benefits of keeping the root scope generic. We know that a user is being returned, because we are
requesting a user, and when comments are being returned we wrap that in a <code class="calibre15">"data"</code> item so that pagination, or links, can
be added to that nested data too. This is the structure I will be testing against and using for examples, but it is only
a simple tweak between any of these structures.</p>

<p class="calibre3">We will get to links, relationships, compound documents, pagination, etc., in later chapters, but for now forget about it.
All you want to worry about is your response, which consists of this chunk of data or an error.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-98">
<div class="calibre6">
<h2 id="calibre_link-20" class="calibre1">
<span class="section-number">4. </span>Status Codes, Errors and Messages</h2>

<h3 id="calibre_link-21" class="calibre2">
<span class="section-number">4.1 </span>Introduction</h3>

<p class="calibre3">If a valid request comes in for data, you show data. If creating something on the API with valid data, you show the created object. If something goes wrong, however, you want to let people know what is wrong using two simultaneous approaches:</p>

<ol class="calibre13">
  <li class="calibre14">HTTP status codes</li>
  <li class="calibre14">Custom error codes and messages</li>
</ol>

<h3 id="calibre_link-22" class="calibre2">
<span class="section-number">4.2 </span>HTTP Status Codes</h3>

<p class="calibre3">Status codes are used in all responses and have a number from <code class="calibre15">200</code> to <code class="calibre15">507</code> &ndash; with plenty of gaps in between &ndash; and each has a message and a definition. Most server-side languages, frameworks, etc., default to <code class="calibre15">200 OK</code>.</p>

<p class="calibre3">Status codes are grouped into a few different categories:</p>

<p class="calibre3">
  <strong class="calibre22">2xx is all about success</strong>
</p>

<p class="calibre3">Whatever the client tried to do was successful up to the point that the response was sent. Keep in mind that a status like <code class="calibre15">202 Accepted</code> does not say anything about the actual result, it only indicates that a request was accepted and is being processed asynchronously.</p>

<p class="calibre3">
  <strong class="calibre22">3xx is all about redirection</strong>
</p>

<p class="calibre3">These are all about sending the calling application somewhere else for the actual resource. The best known of these are the <code class="calibre15">303 See Other</code> and the <code class="calibre15">301 Moved Permanently</code>, which are used a lot on the web to redirect a browser to another URL.</p>

<p class="calibre3">
  <strong class="calibre22">4xx is all about client errors</strong>
</p>

<p class="calibre3">With these status codes, we indicate that the client has done something invalid and needs to fix the request before resending it.</p>

<p class="calibre3">
  <strong class="calibre22">5xx is all about service errors</strong>
</p>

<p class="calibre3">With these status codes, we indicate that something went wrong in the service. For example, a database connection failed. Typically, a client application can retry the request. The server can even specify when the client is allowed to retry the command using a <code class="calibre15">Retry-After</code> HTTP header.</p>

<p class="calibre3">
  <em class="calibre19"><a href="http://www.develop.com/httpstatuscodesrest">Using HTTP status codes in a REST service</a> &ndash; Maurice de Beijer</em>
</p>

<p class="calibre3">For a more complete list of HTTP status codes and their definitions the <a href="http://restpatterns.org/HTTP_Status_Codes">REST &amp; WOA Wiki</a> has an extensive list of them.</p>

<p class="calibre3">Arguments between developers will continue for the rest of time over the exact appropriate code to use in any given situation, but these are the status codes the API used at Kapture:</p>

<ul class="calibre18">
  <li class="calibre14">200 - Generic everything is OK</li>
  <li class="calibre14">201 - Created something OK</li>
  <li class="calibre14">202 - Accepted but is being processed async (for a video means encoding, for an image means resizing, etc.)</li>
  <li class="calibre14">400 - Bad Request (should really be for invalid syntax, but some folks use for validation)</li>
  <li class="calibre14">401 - Unauthorized (no current user and there should be)</li>
  <li class="calibre14">403 - The current user is forbidden from accessing this data</li>
  <li class="calibre14">404 - That URL is not a valid route, or the item resource does not exist</li>
  <li class="calibre14">405 - Method Not Allowed (your framework will probably do this for you)</li>
  <li class="calibre14">410 - Data has been deleted, deactivated, suspended, etc.</li>
  <li class="calibre14">500 - Something unexpected happened, and it is the APIs fault</li>
  <li class="calibre14">503 - API is not here right now, please try again later</li>
</ul>

<p class="calibre3">It can be tempting to try and squeeze as many error codes in as you can, but I would advise you to try and keep it simple. You won’t unlock any achievement badges for using them all.</p>

<p class="calibre3">Most 5xx issues will likely happen under odd architecture or server related issues that are nothing to do with your API. For example, if PHP-FPM segfaults behind Nginx (502), if your Amazon Elastic Load Balancer has no healthy instances (503), or if your disk drive fills up with cat gifs (507).</p>

<h3 id="calibre_link-23" class="calibre2">
<span class="section-number">4.3 </span>Error Codes and Error Messages</h3>

<p class="calibre3">Error codes are usually strings or integers that act as a unique index to a corresponding human-readable error message with more information about what is going wrong. That sounds a lot like HTTP status codes, but these errors are about application specific things that may or may not have anything to do with HTTP specific responses.</p>

<p class="calibre3">Some folks will try to use HTTP status codes exclusively and skip using error codes because they do not like the idea of making their own error codes or having to document them, but this is not a scalable approach. There will be some situations where the same endpoint could easily return the same status code for more than one different condition. The status codes are there to merely hint at the category of error relying on the actual error code and error message provided in the HTTP response to include more information in case the client is interested.</p>

<p class="calibre3">For example, an issue with the access token will always result in the user not being recognized. An uninterested client would simply say “User could not get in” while a more interested client would probably prefer to offer suggestions via messages in their own webapp/iPhone app interface.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">{</code>
<code class="lineno">2</code>   <code class="s">"error"</code><code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno">3</code>     <code class="s">"type"</code><code class="o">:</code> <code class="s">"OAuthException"</code><code class="calibre15">,</code>
<code class="lineno">4</code>     <code class="s">"message"</code><code class="o">:</code> <code class="s">"Session has expired at unix time 1385243766.</code>
<code class="lineno">5</code> <code class="calibre15">The</code> <code class="calibre15">current</code> <code class="calibre15">unix</code> <code class="calibre15">time</code> <code class="calibre15">is</code> <code class="o">1385848532.</code><code class="s">"</code>
<code class="lineno">6</code>   <code class="calibre15">}</code>
<code class="lineno">7</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Humans can understand that nicely enough, but Facebook used to lack error codes, making it rather hard for computers to understand the problem. They have added them since the first edition of this book, but before that you would find yourself doing substring matching on the message text, which is lunacy.</p>

<p class="calibre3">Foursquare is not a bad example of using both, but they place an emphasis on tying their errors to a status code.</p>

<p class="calibre3">
  <a href="https://developer.foursquare.com/overview/responses">https://developer.foursquare.com/overview/responses</a>
</p>

<p class="calibre3">Twitter does a great job of having HTTP status codes documented and having specific error codes for other issues too. Some are tied to HTTP status codes, which is fine, but many are not. Some are also tied to the same status code, highlighting the issues raised above.</p>

<p class="calibre3">
  <a href="https://dev.twitter.com/docs/error-codes-responses">https://dev.twitter.com/docs/error-codes-responses</a>
</p>

<table class="calibre24">
  <thead class="calibre25">
    <tr class="calibre26">
      <th class="calibre27">Code</th>
      <th class="calibre27">Text</th>
      <th class="calibre27">Description</th>
    </tr>
  </thead>
  <tbody class="calibre28">
    <tr class="calibre26">
      <td class="calibre29">161</td>
      <td class="calibre29">You are unable to follow more people at this time</td>
      <td class="calibre29">Corresponds with HTTP 403 - thrown when a user cannot follow another user due to some kind of limit</td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">179</td>
      <td class="calibre29">Sorry, you are not authorized to see this status</td>
      <td class="calibre29">Corresponds with HTTP 403 - thrown when a Tweet cannot be viewed by the authenticating user, usually due to the tweet’s author having protected their tweets.</td>
    </tr>
  </tbody>

</table>

<h4 id="calibre_link-129" class="calibre4">Programmatically Detecting Error Codes</h4>

<p class="calibre3">You can use error codes to make an application respond intelligently to failure of something as basic as a posted Twitter
status.</p>

<figure class="code">
  <figcaption class="calibre20">Using Python to catch exceptions and react to the Twitter error code</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="k">try</code><code class="calibre15">:</code>
<code class="lineno"> 2</code>     <code class="calibre15">api</code><code class="o">.</code><code class="calibre15">PostUpdates</code><code class="calibre15">(</code><code class="calibre15">body</code><code class="calibre15">[</code><code class="s">'text'</code><code class="calibre15">])</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code> <code class="k">except</code> <code class="calibre15">twitter</code><code class="o">.</code><code class="calibre15">TwitterError</code><code class="calibre15">,</code> <code class="calibre15">exc</code><code class="calibre15">:</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code>     <code class="calibre15">skip_codes</code> <code class="o">=</code> <code class="calibre15">[</code>
<code class="lineno"> 7</code>         <code class="c"># Page does not exist</code>
<code class="lineno"> 8</code>         <code class="o">34</code><code class="calibre15">,</code>
<code class="lineno"> 9</code> 
<code class="lineno">10</code>         <code class="c"># You cannot send messages to users who are not following you</code>
<code class="lineno">11</code>         <code class="o">150</code><code class="calibre15">,</code>
<code class="lineno">12</code> 
<code class="lineno">13</code>         <code class="c"># Sent too many</code>
<code class="lineno">14</code>         <code class="c"># TODO Make this requeue with a dekal somehow</code>
<code class="lineno">15</code>         <code class="o">151</code>
<code class="lineno">16</code>     <code class="calibre15">]</code>
<code class="lineno">17</code> 
<code class="lineno">18</code>     <code class="calibre15">error_code</code> <code class="o">=</code> <code class="calibre15">exc</code><code class="o">.</code><code class="calibre15">__getitem__</code><code class="calibre15">(</code><code class="o">0</code><code class="calibre15">)[</code><code class="o">0</code><code class="calibre15">][</code><code class="s">'code'</code><code class="calibre15">]</code>
<code class="lineno">19</code> 
<code class="lineno">20</code>     <code class="c"># If the error code is one of those listed before, let’s just end here</code>
<code class="lineno">21</code>     <code class="k">if</code> <code class="calibre15">error_code</code> <code class="ow">in</code> <code class="calibre15">skip_codes</code><code class="calibre15">:</code>
<code class="lineno">22</code>         <code class="calibre15">message</code><code class="o">.</code><code class="calibre15">reject</code><code class="calibre15">()</code>
<code class="lineno">23</code> 
<code class="lineno">24</code>     <code class="k">else</code><code class="calibre15">:</code>
<code class="lineno">25</code>         <code class="c"># Rate limit exceeded? Might be worth taking a nap before we requeue</code>
<code class="lineno">26</code>         <code class="k">if</code> <code class="calibre15">error_code</code> <code class="o">==</code> <code class="o">88</code><code class="calibre15">:</code>
<code class="lineno">27</code>             <code class="calibre15">time</code><code class="o">.</code><code class="calibre15">sleep</code><code class="calibre15">(</code><code class="o">10</code><code class="calibre15">)</code>
<code class="lineno">28</code> 
<code class="lineno">29</code>         <code class="calibre15">message</code><code class="o">.</code><code class="calibre15">requeue</code><code class="calibre15">()</code>
</pre></div>

</figure>

<p class="calibre3">Compare this sort of logic with the Facebook example from when they lacked error codes:</p>

<figure class="code">
  <figcaption class="calibre20">Using Python to analyse Facebook error strings as no codes exist</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="k">except</code> <code class="calibre15">facebook</code><code class="o">.</code><code class="calibre15">GraphAPIError</code><code class="calibre15">,</code> <code class="calibre15">e</code><code class="calibre15">:</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code>     <code class="calibre15">phrases</code> <code class="o">=</code> <code class="calibre15">[</code><code class="s">'expired'</code><code class="calibre15">,</code> <code class="s">'session has been invalidated'</code><code class="calibre15">]</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code>     <code class="k">for</code> <code class="calibre15">phrase</code> <code class="ow">in</code> <code class="calibre15">phrases</code><code class="calibre15">:</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code>         <code class="c"># If the token has expired then lets knock it out so we don't try again</code>
<code class="lineno"> 8</code>         <code class="k">if</code> <code class="calibre15">e</code><code class="o">.</code><code class="calibre15">message</code><code class="o">.</code><code class="calibre15">find</code><code class="calibre15">(</code><code class="calibre15">phrase</code><code class="calibre15">)</code> <code class="o">&gt;</code> <code class="o">0</code><code class="calibre15">:</code>
<code class="lineno"> 9</code>             <code class="calibre15">log</code><code class="o">.</code><code class="calibre15">info</code><code class="calibre15">(</code><code class="s">"Deactivating Token </code><code class="si">%s</code><code class="s">"</code><code class="calibre15">,</code> <code class="calibre15">user</code><code class="calibre15">[</code><code class="s">'token_id'</code><code class="calibre15">])</code>
<code class="lineno">10</code>             <code class="nb">self</code><code class="o">.</code><code class="calibre15">_deactivate_token</code><code class="calibre15">(</code><code class="calibre15">user</code><code class="calibre15">[</code><code class="s">'token_id'</code><code class="calibre15">])</code>
<code class="lineno">11</code> 
<code class="lineno">12</code>     <code class="calibre15">log</code><code class="o">.</code><code class="calibre15">error</code><code class="calibre15">(</code><code class="s">"-- Unknown Facebook Error"</code><code class="calibre15">,</code> <code class="calibre15">exec_info</code><code class="o">=</code><code class="nb">True</code><code class="calibre15">)</code>
</pre></div>

</figure>

<p class="calibre3">If they change their error messages then this might stop working, which would be a problem. Codes that
do not change are a much more sensible way to go about this.</p>

<figure class="code">
  <figcaption class="calibre20">If Facebook added codes and documentation links to GraphAPI error responses.</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">{</code>
<code class="lineno">2</code>   <code class="s">"error"</code><code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno">3</code>     <code class="s">"type"</code><code class="o">:</code> <code class="s">"OAuthException"</code><code class="calibre15">,</code>
<code class="lineno">4</code>     <code class="s">"code"</code><code class="o">:</code> <code class="s">"ERR-01234"</code><code class="calibre15">,</code>
<code class="lineno">5</code>     <code class="s">"message"</code><code class="o">:</code> <code class="s">"Session has expired at unix time 1385243766. The current unix time is\</code>
<code class="lineno">6</code> <code class="s"> 1385848532."</code>
<code class="lineno">7</code>     <code class="s">"href"</code><code class="o">:</code> <code class="s">"http://example.com/docs/errors/#ERR-01234"</code>
<code class="lineno">8</code>   <code class="calibre15">}</code>
<code class="lineno">9</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<h3 id="calibre_link-24" class="calibre2">
<span class="section-number">4.4 </span>Error or Errors</h3>

<p class="calibre3">When returning errors, I always used to return just one error. In the case of validation I would return
them one at a time as an easy way to exit out of a controller. Thinking about it this was probably just
laziness.</p>

<p class="calibre3">After being forced to work with the JSON-API standard, the use of multiple errors started to feel more natural.</p>

<figure class="code">
  <figcaption class="calibre20">If Facebook returned multiple errors in a list for GraphAPI responses.</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">{</code>
<code class="lineno">2</code>   <code class="s">"errors"</code><code class="o">:</code> <code class="calibre15">[{</code>
<code class="lineno">3</code>     <code class="s">"type"</code><code class="o">:</code> <code class="s">"OAuthException"</code><code class="calibre15">,</code>
<code class="lineno">4</code>     <code class="s">"code"</code><code class="o">:</code> <code class="s">"ERR-01234"</code><code class="calibre15">,</code>
<code class="lineno">5</code>     <code class="s">"message"</code><code class="o">:</code> <code class="s">"Session has expired at unix time 1385243766. The current unix time is\</code>
<code class="lineno">6</code> <code class="s"> 1385848532."</code>
<code class="lineno">7</code>     <code class="s">"href"</code><code class="o">:</code> <code class="s">"http://example.com/docs/errors/#ERR-01234"</code>
<code class="lineno">8</code>   <code class="calibre15">}]</code>
<code class="lineno">9</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<h3 id="calibre_link-25" class="calibre2">
<span class="section-number">4.5 </span>Standards for Error Responses</h3>

<p class="calibre3">So far, this chapter has used entirely home-grown formats for errors. It is incredibly common, even with
the most popular APIs to build completely arbitrary error formats, so I wanted to teach you the theory
before forcing you to read complicated standards.</p>

<p class="calibre3">There are two popular standards that cover error reporting, which are both fairly similar, but sadly
still in draft at time of writing.</p>

<h4 id="calibre_link-130" class="calibre4">JSON-API</h4>

<p class="calibre3"><a href="http://jsonapi.org/format/#errors">JSON-API</a> is discussed in a few sections of this book and is a
standard outlining the general format of requests and responses in JSON when working with HTTP APIs. It
has a section on errors, which I quite like.</p>

<p class="calibre3">The following is an excerpt from the JSON-API standard at time of writing.</p>

<blockquote class="calibre17">
  <p class="calibre3">An error object MAY have the following members:</p>
</blockquote>

<blockquote class="calibre17">
  <ul class="calibre18">
    <li class="calibre14">
<code class="calibre15">"id"</code> - A unique identifier for this particular occurrence of the problem.</li>
    <li class="calibre14">
<code class="calibre15">"href"</code> - A URI that MAY yield further details about this particular occurrence of the problem.</li>
    <li class="calibre14">
<code class="calibre15">"status"</code> - The HTTP status code applicable to this problem, expressed as a string value.</li>
    <li class="calibre14">
<code class="calibre15">"code"</code> - An application-specific error code, expressed as a string value.</li>
    <li class="calibre14">
<code class="calibre15">"title"</code> - A short, human-readable summary of the problem. It SHOULD NOT change from occurrence to occurrence of the problem, except for purposes of localization.</li>
    <li class="calibre14">
<code class="calibre15">"detail"</code> - A human-readable explanation specific to this occurrence of the problem.</li>
    <li class="calibre14">
<code class="calibre15">"links"</code> - Associated resources, which can be dereferenced from the request document.</li>
    <li class="calibre14">
<code class="calibre15">"path"</code> - The relative path to the relevant attribute within the associated resource(s). Only appropriate for problems that apply to a single resource or type of resource.</li>
  </ul>
</blockquote>

<blockquote class="calibre17">
  <p class="calibre3">Additional members MAY be specified within error objects.</p>
</blockquote>

<p class="calibre3">When constructing your API error responses, you pretty much just need to make an array with items that looks a bit
like this:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">{</code>
<code class="lineno">2</code>   <code class="s">"errors"</code><code class="o">:</code> <code class="calibre15">[{</code>
<code class="lineno">3</code>     <code class="s">"code"</code><code class="o">:</code> <code class="s">"ERR-01234"</code><code class="calibre15">,</code>
<code class="lineno">4</code>     <code class="s">"title"</code><code class="o">:</code> <code class="s">"OAuth Exception"</code><code class="calibre15">,</code>
<code class="lineno">5</code>     <code class="s">"details"</code><code class="o">:</code> <code class="s">"Session has expired at unix time 1385243766. The current unix time is\</code>
<code class="lineno">6</code> <code class="s"> 1385848532."</code><code class="calibre15">,</code>
<code class="lineno">7</code>     <code class="s">"href"</code><code class="o">:</code> <code class="s">"http://example.com/docs/errors/#ERR-01234"</code>
<code class="lineno">8</code>   <code class="calibre15">}]</code>
<code class="lineno">9</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">See how that Facebook example has been slightly tweaked to follow the standard? Nice and easy.</p>

<h4 id="calibre_link-131" class="calibre4">Problem Details for HTTP APIs</h4>

<p class="calibre3">This is currently a <a href="http://tools.ietf.org/html/draft-nottingham-http-problem">draft RFC</a>, which at the
time of writing was on Draft 7.</p>

<p class="calibre3">The goal of this RFC is to define a “problem detail”, like we have been doing throughout this chapter,
but in a standard way (to avoid inventing new formats for each and every HTTP API). It is being headed up
by Mark Nottingham.</p>

<p class="calibre3">Mark wrote a <a href="https://www.mnot.net/blog/2013/05/15/http_problem">tutorial about problem details</a>, which will explain the standard a little better.</p>

<p class="calibre3">If you are interested in implementing this standard then there are tools to make it easy:</p>

<ul class="calibre18">
  <li class="calibre14">
<a href="https://github.com/Crell/ApiProblem">crell/api-problem</a> for PHP</li>
</ul>

<h3 id="calibre_link-26" class="calibre2">
<span class="section-number">4.6 </span>Common Pitfalls</h3>

<h4 id="calibre_link-132" class="calibre4">200 OK and Error Code</h4>

<p class="calibre3">If you return an HTTP status code of 200 with an error code, then Chuck Norris will roundhouse your door in, destroy your computer, instantly 35-pass wipe your backups, cancel your Dropbox account, and block you from GitHub. HTTP 4xx or 5xx codes alert the client that something bad happened, and error codes provide specifics of the exact issue if the client is interested.</p>

<h4 id="calibre_link-133" class="calibre4">Non-Existent, Gone, or Hiding?</h4>

<p class="calibre3">404 is drastically overused in APIs. People use it for “never existed”, “no longer exists”, “you can’t view it” and “it is deactivated”, which is way too vague. That can be split up into 404, 403 and 410 but this is still vague.</p>

<p class="calibre3">If you get a 403, this could be because the requesting user is not in the correct group to see the requested content. Should the client suggest you upgrade your account somehow? Are you not friends with the user whose content you are trying to view? Should the client suggest you add them as a friend?</p>

<p class="calibre3">A 410 on a resource could be due to a user deleting that entire piece of content, or it could be down to the user deleting their entire account.</p>

<p class="calibre3">In all of these situations, the ideal solution is to complement the HTTP status code with an error code, which can be whatever you want as long as they are unique within your API and documented somewhere. </p>

<p class="calibre3">Do not do what Google does &mdash; supply a list of error codes while having other error codes that are not documented <em class="calibre19">anywhere</em> &mdash; because if I see that, I will come for you.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-92">
<div class="calibre6">
<h2 id="calibre_link-27" class="calibre1">
<span class="section-number">5. </span>Endpoint Testing</h2>

<h3 id="calibre_link-28" class="calibre2">
<span class="section-number">5.1 </span>Introduction</h3>

<p class="calibre3">You might be sitting there thinking, “This escalated quickly, I’m not ready for testing!” but this is
essentially the point. You have to set up your tests as early as possible so you actually bother using them,
otherwise they become the <em class="calibre19">next thing</em> that just never gets done. Have no fear. Testing an API is not only
easy, it is actually really quite fun.</p>

<h3 id="calibre_link-29" class="calibre2">
<span class="section-number">5.2 </span>Concepts &amp; Tools</h3>

<p class="calibre3">With an API, there are a few things to test, but the most basic idea is, “when I request this URL, I want to
see a <code class="calibre15">foo</code> resource”, and “when I throw this JSON at the API, it should a) accept it or b) freak out.”</p>

<p class="calibre3">This can be done in several ways, and a lot of people will instantly try to unit test it, but that quickly
becomes a nightmare. While you might think just writing a bit of code with your favourite HTTP client is
simple, if you have over 50 endpoints and want to do multiple checks per endpoint, you end up with a mess of
code which can become hard to maintain, especially if your favourite HTTP client releases a major version with
a brand new interface.</p>

<p class="calibre3">The more code you have in your tests, the higher the chances of your tests being rubbish, which means you won’t run
them. Bad tests also run the risk of false positives, which are super dangerous as they lead you into thinking your
code actually works when it does not.</p>

<p class="calibre3">One very simplistic approach will be to use a BDD (Behaviour Driven Development) tool. A very popular BDD
tool is <a href="http://cukes.info/">Cucumber</a>, and this is considered by many to be a Ruby tool. It can in fact be used
for Python, PHP, and probably a whole bevy of other languages but some of the integrations can be tricky. For the
PHP users here, we will be using Behat, which is pretty much the same thing, along with <a href="http://docs.behat.org/guides/1.gherkin.html">Gherkin</a>
(the same DSL (Domain-Specific Language) that Cucumber uses, so all of us are on basically the same page.)</p>

<p class="calibre3">The outline of this chapter will be to show how to set up and use the BDD tool Behat, talk through the various moving
parts, then show you a working example in our source code inside a Laravel sample app. You can build your own tests in
your own language, or in any framework, but just go along with this PHP example to see a basic working - even if you
personally prefer another language. Go on. It won’t bite.</p>

<h3 id="calibre_link-30" class="calibre2">
<span class="section-number">5.3 </span>Setup</h3>

<p class="calibre3">As a PHP developer, you simply need to install Behat, which can be done with <a href="https://getcomposer.org/">Composer</a>. It is
fair to assume that if you are using any sort of modern PHP framework, you are already familiar with Composer, so we
can skip boring the non-PHP developers by getting too stuck into it.</p>

<p class="calibre3">Assuming that Composer is <a href="https://getcomposer.org/doc/00-intro.md#globally">installed globally</a> in your system, to install Behat run:</p>

<figure class="code">
  <figcaption class="calibre20">Install Behat globally with Composer</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code>composer global require <code class="s">"behat/behat ~2.5"</code>
</pre></div>

</figure>

<p class="calibre3">Make sure <code class="calibre15">~/.composer/vendor/bin/</code> is added to your <code class="calibre15">$PATH</code> and you should be good to go.</p>

<p class="calibre3">If you are a Ruby user, you have the ease of simply running <code class="calibre15">$ gem install cucumber</code>, or shove it in your <code class="calibre15">Gemfile</code>.</p>

<p class="calibre3">Google should help you with Python.</p>

<p class="calibre3">The rest of this chapter is going to stick purely to PHP for the sake of simplicity, and others can just use the equivalent commands as we go.</p>

<h3 id="calibre_link-31" class="calibre2">
<span class="section-number">5.4 </span>Initialise</h3>

<p class="calibre3">These Behat tests will live in a <code class="calibre15">tests</code> folder, but it may need to coexist with other unit tests or other types of
test. For this reason, I like to put them in a subfolder called <code class="calibre15">tests/behat</code>.</p>

<p class="calibre3">I have provided an example of a simple Behat test suite in the sample code that lives inside the <code class="calibre15">app/</code> folder. This
is done mainly because it is a good place to put your tests and Laravel already has a tests folder, but if you are using
any other framework you can put these tests anywhere you please.</p>

<p class="calibre3">So, go to the app folder:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code><code class="nb">cd</code> ~/apisyouwonthate/chapter5/app
</pre></div>

</figure>

<p class="calibre3">The folder structure and basic Behat setup has already been run with the following commands, so you can skip this step:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code>mkdir -p tests/behat <code class="o">&amp;&amp;</code> <code class="nb">cd </code>tests/behat
<code class="lineno">2</code> <code class="nv">$ </code>behat --init
</pre></div>

</figure>

<p class="calibre3">This will have the following output:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="o">+</code><code class="calibre15">d</code> <code class="calibre15">features</code> <code class="o">-</code> <code class="calibre15">place</code> <code class="calibre15">your</code> <code class="o">*</code><code class="calibre15">.</code><code class="calibre15">feature</code> <code class="calibre15">files</code> <code class="calibre15">here</code>
<code class="lineno">2</code> <code class="o">+</code><code class="calibre15">d</code> <code class="calibre15">features</code><code class="o">/</code><code class="calibre15">bootstrap</code> <code class="o">-</code> <code class="calibre15">place</code> <code class="calibre15">bootstrap</code> <code class="calibre15">scripts</code> <code class="calibre15">and</code> <code class="k">static</code> <code class="calibre15">files</code> <code class="calibre15">here</code>
<code class="lineno">3</code> <code class="o">+</code><code class="calibre15">f</code> <code class="calibre15">features</code><code class="o">/</code><code class="calibre15">bootstrap</code><code class="o">/</code><code class="calibre15">FeatureContext</code><code class="calibre15">.</code><code class="calibre15">php</code> <code class="o">-</code> <code class="calibre15">place</code> <code class="calibre15">your</code> <code class="calibre15">feature</code> <code class="calibre15">related</code> <code class="calibre15">code</code> <code class="calibre15">here</code>
</pre></div>

</figure>

<p class="calibre3">The output here outlines the structure of files it has created. Everything lives inside the <code class="calibre15">features/</code> folder, and
this will be where your Behat tests will go. The <code class="calibre15">features/bootstrap/</code> folder contains only one file at this point,
which is <code class="calibre15">FeatureContext.php</code>.</p>

<p class="calibre3">The default version of this file is a little bare, so this sample code contains a beefed up one, which will be used
throughout this chapter.</p>

<h3 id="calibre_link-32" class="calibre2">
<span class="section-number">5.5 </span>Features</h3>

<p class="calibre3">Features are a way to group your various tests together. Personally, I keep things fairly simple and consider each resource and subresource to be its own Behat feature.</p>

<p class="calibre3">Looking at our users example from <a href="#calibre_link-10">Chapter 2: Planning and Creating Endpoints</a>:</p>

<table class="calibre24">
  <thead class="calibre25">
    <tr class="calibre26">
      <th class="calibre27">Action</th>
      <th class="calibre27">Endpoint</th>
      <th class="calibre27">Feature</th>
    </tr>
  </thead>
  <tbody class="calibre28">
    <tr class="calibre26">
      <td class="calibre29">Create</td>
      <td class="calibre29">POST /users</td>
      <td class="calibre29">features/users.feature</td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Read</td>
      <td class="calibre29">GET /users/X</td>
      <td class="calibre29">features/users.feature</td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Update</td>
      <td class="calibre29">PUT /users/X</td>
      <td class="calibre29">features/users.feature</td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Delete</td>
      <td class="calibre29">DELETE /users/X</td>
      <td class="calibre29">features/users.feature</td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">List</td>
      <td class="calibre29">GET /users</td>
      <td class="calibre29">features/users.feature</td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Image</td>
      <td class="calibre29">PUT /users/X/image</td>
      <td class="calibre29">features/users-image.feature</td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Favorites</td>
      <td class="calibre29">GET /users/X/favorites</td>
      <td class="calibre29">features/users-favorites.feature</td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Checkins</td>
      <td class="calibre29">GET /users/X/checkins</td>
      <td class="calibre29">features/users-checkins.feature</td>
    </tr>
  </tbody>

</table>

<p class="calibre3">So, anything to do with <code class="calibre15">/users</code> and <code class="calibre15">/users/X</code> would be the same, but maybe <code class="calibre15">/users/X/checkins</code> becomes a new
feature because we are talking about something else.</p>

<p class="calibre3">You can use that convention, or try something else, but this grows pretty well without having a bazillion files
to sift through.</p>

<h3 id="calibre_link-33" class="calibre2">
<span class="section-number">5.6 </span>Scenarios</h3>

<p class="calibre3">Gherkin uses “scenarios” as its core structure and they each contain “steps”. In a unit testing world the scenarios would be their own <code class="calibre15">test_foo()</code> methods, and the steps would be assertions.</p>

<p class="calibre3">These features and scenarios line up with the action plan created in Chapter 2. Each RESTful resource in that action plan needs at least one feature, and because each action has an endpoint we need <em class="calibre19">at least</em> one scenario for each action.</p>

<p class="calibre3">Too much jargon? Time for an example:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">Feature</code><code class="o">:</code> <code class="calibre15">Places</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="calibre15">Scenario</code><code class="o">:</code> <code class="calibre15">Finding</code> <code class="calibre15">a</code> <code class="calibre15">specific</code> <code class="calibre15">place</code>
<code class="lineno"> 4</code>     <code class="calibre15">When</code> <code class="calibre15">I</code> <code class="calibre15">request</code> <code class="s">"GET /places/1"</code>
<code class="lineno"> 5</code>     <code class="calibre15">Then</code> <code class="calibre15">I</code> <code class="k">get</code> <code class="calibre15">a</code> <code class="s">"200"</code> <code class="calibre15">response</code>
<code class="lineno"> 6</code>     <code class="calibre15">And</code> <code class="calibre15">scope</code> <code class="calibre15">into</code> <code class="calibre15">the</code> <code class="s">"data"</code> <code class="calibre15">property</code>
<code class="lineno"> 7</code>         <code class="calibre15">And</code> <code class="calibre15">the</code> <code class="calibre15">properties</code> <code class="calibre15">exist</code><code class="o">:</code>
<code class="lineno"> 8</code>             <code class="s">"""</code>
<code class="lineno"> 9</code> <code class="s">            id</code>
<code class="lineno">10</code> <code class="s">            name</code>
<code class="lineno">11</code> <code class="s">            lat</code>
<code class="lineno">12</code> <code class="s">            lon</code>
<code class="lineno">13</code> <code class="s">            address1</code>
<code class="lineno">14</code> <code class="s">            address2</code>
<code class="lineno">15</code> <code class="s">            city</code>
<code class="lineno">16</code> <code class="s">            state</code>
<code class="lineno">17</code> <code class="s">            zip</code>
<code class="lineno">18</code> <code class="s">            website</code>
<code class="lineno">19</code> <code class="s">            phone</code>
<code class="lineno">20</code> <code class="s">            """</code>
<code class="lineno">21</code>         <code class="calibre15">And</code> <code class="calibre15">the</code> <code class="s">"id"</code> <code class="calibre15">property</code> <code class="k">is</code> <code class="calibre15">an</code> <code class="calibre15">integer</code>
<code class="lineno">22</code> 
<code class="lineno">23</code> <code class="calibre15">Scenario</code><code class="o">:</code> <code class="calibre15">Listing</code> <code class="calibre15">all</code> <code class="calibre15">places</code> <code class="k">is</code> <code class="calibre15">not</code> <code class="calibre15">possible</code>
<code class="lineno">24</code>     <code class="calibre15">When</code> <code class="calibre15">I</code> <code class="calibre15">request</code> <code class="s">"GET /places"</code>
<code class="lineno">25</code>     <code class="calibre15">Then</code> <code class="calibre15">I</code> <code class="k">get</code> <code class="calibre15">a</code> <code class="s">"400"</code> <code class="calibre15">response</code>
<code class="lineno">26</code> 
<code class="lineno">27</code> <code class="calibre15">Scenario</code><code class="o">:</code> <code class="calibre15">Searching</code> <code class="calibre15">non</code><code class="o">-</code><code class="calibre15">existent</code> <code class="calibre15">places</code>
<code class="lineno">28</code>     <code class="calibre15">When</code> <code class="calibre15">I</code> <code class="calibre15">request</code> <code class="s">"GET /places?q=c800e42c377881f8ae509cf9a516d4eb59&amp;lat=1&amp;lon=1"</code>
<code class="lineno">29</code>     <code class="calibre15">Then</code> <code class="calibre15">I</code> <code class="k">get</code> <code class="calibre15">a</code> <code class="s">"200"</code> <code class="calibre15">response</code>
<code class="lineno">30</code>     <code class="calibre15">And</code> <code class="calibre15">the</code> <code class="s">"data"</code> <code class="calibre15">property</code> <code class="calibre15">contains</code> <code class="o">0</code> <code class="calibre15">items</code>
<code class="lineno">31</code> 
<code class="lineno">32</code> <code class="calibre15">Scenario</code><code class="o">:</code> <code class="calibre15">Searching</code> <code class="calibre15">places</code> <code class="k">with</code> <code class="calibre15">filters</code>
<code class="lineno">33</code>     <code class="calibre15">When</code> <code class="calibre15">I</code> <code class="calibre15">request</code> <code class="s">"GET /places?lat=40.76855&amp;lon=-73.9945&amp;q=cheese"</code>
<code class="lineno">34</code>     <code class="calibre15">Then</code> <code class="calibre15">I</code> <code class="k">get</code> <code class="calibre15">a</code> <code class="s">"200"</code> <code class="calibre15">response</code>
<code class="lineno">35</code>     <code class="calibre15">And</code> <code class="calibre15">the</code> <code class="s">"pagination"</code> <code class="calibre15">property</code> <code class="k">is</code> <code class="calibre15">an</code> <code class="calibre15">object</code>
<code class="lineno">36</code>     <code class="calibre15">And</code> <code class="calibre15">the</code> <code class="s">"data"</code> <code class="calibre15">property</code> <code class="k">is</code> <code class="calibre15">an</code> <code class="calibre15">array</code>
<code class="lineno">37</code>     <code class="calibre15">And</code> <code class="calibre15">scope</code> <code class="calibre15">into</code> <code class="calibre15">the</code> <code class="calibre15">first</code> <code class="s">"data"</code> <code class="calibre15">property</code>
<code class="lineno">38</code>         <code class="calibre15">And</code> <code class="calibre15">the</code> <code class="calibre15">properties</code> <code class="calibre15">exist</code><code class="o">:</code>
<code class="lineno">39</code>             <code class="s">"""</code>
<code class="lineno">40</code> <code class="s">            id</code>
<code class="lineno">41</code> <code class="s">            name</code>
<code class="lineno">42</code> <code class="s">            lat</code>
<code class="lineno">43</code> <code class="s">            lon</code>
<code class="lineno">44</code> <code class="s">            address1</code>
<code class="lineno">45</code> <code class="s">            address2</code>
<code class="lineno">46</code> <code class="s">            city</code>
<code class="lineno">47</code> <code class="s">            state</code>
<code class="lineno">48</code> <code class="s">            zip</code>
<code class="lineno">49</code> <code class="s">            website</code>
<code class="lineno">50</code> <code class="s">            phone</code>
<code class="lineno">51</code> <code class="s">            """</code>
<code class="lineno">52</code>     <code class="calibre15">And</code> <code class="calibre15">reset</code> <code class="calibre15">scope</code>
</pre></div>

</figure>

<p class="calibre3">This uses some custom rules that have been defined in the file <code class="calibre15">FeatureContext.php</code>. More on that shortly.</p>

<p class="calibre3">The “feature file” is called <code class="calibre15">places.feature</code> and has four scenarios. One to find a specific place, another to show that
listing all places is not allowed (400 means bad input, you should specify <code class="calibre15">lat</code> and <code class="calibre15">lon</code>), and two more to test how
well searching works.</p>

<p class="calibre3">Try to think up the guard clauses that the endpoints will need, then make a scenario for each of those.</p>

<p class="calibre3">For example, if the endpoint requires <code class="calibre15">lat</code> and <code class="calibre15">lon</code> as query string parameters, try omitting them and testing that
to ensure the error message and status codes are correct.</p>

<p class="calibre3">If an input is expecting a boolean value, but a string is provided? Maybe that should be a test too:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">Scenario</code><code class="o">:</code> <code class="calibre15">Wrong</code> <code class="calibre15">Arguments</code> <code class="k">for</code> <code class="calibre15">user</code> <code class="calibre15">follow</code>
<code class="lineno">2</code>     <code class="calibre15">Given</code> <code class="calibre15">I</code> <code class="calibre15">have</code> <code class="calibre15">the</code> <code class="calibre15">payload</code><code class="o">:</code>
<code class="lineno">3</code>         <code class="s">"""</code>
<code class="lineno">4</code> <code class="s">        {"</code><code class="calibre15">is_following</code><code class="s">": "</code><code class="calibre15">foo</code><code class="s">"}</code>
<code class="lineno">5</code> <code class="s">        """</code>
<code class="lineno">6</code>     <code class="calibre15">When</code> <code class="calibre15">I</code> <code class="calibre15">request</code> <code class="s">"PUT /users/1"</code>
<code class="lineno">7</code>     <code class="calibre15">Then</code> <code class="calibre15">I</code> <code class="k">get</code> <code class="calibre15">a</code> <code class="s">"400"</code> <code class="calibre15">response</code>
</pre></div>

</figure>

<p class="calibre3">Want to be sure your controllers can handle weird requests with a 404 instead of freaking out and going all 500 Internal Error? There is another test:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">Scenario</code><code class="o">:</code> <code class="calibre15">Try</code> <code class="calibre15">to</code> <code class="calibre15">find</code> <code class="calibre15">an</code> <code class="calibre15">invalid</code> <code class="calibre15">moments</code>
<code class="lineno">2</code>     <code class="calibre15">When</code> <code class="calibre15">I</code> <code class="calibre15">request</code> <code class="s">"GET /moments/nope"</code>
<code class="lineno">3</code>     <code class="calibre15">Then</code> <code class="calibre15">I</code> <code class="k">get</code> <code class="calibre15">a</code> <code class="s">"404"</code> <code class="calibre15">response</code>
</pre></div>

</figure>

<p class="calibre3">Sure there is no actual code yet, but you can write all of these tests based off of nothing but your action plan and your routes. You should use what you know about the output content structure from <a href="#calibre_link-14">Chapter 3</a> to plan what output you expect to see.</p>

<p class="calibre3">Then all you need to do is… you know… build your entire API.</p>

<h3 id="calibre_link-34" class="calibre2">
<span class="section-number">5.7 </span>Prepping Behat</h3>

<p class="calibre3">You are probably wondering how you actually run these tests, because Behat involves making HTTP requests, and you’ve just been writing text-files. Well, the class in <code class="calibre15">FeatureContext.php</code> handles all of that and a lot more, but first we need to configure Behat so we know what the hostname is going to be for these requests.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code>vim app/tests/behat/behat-dev.yml
</pre></div>

</figure>

<p class="calibre3">In this file put in something along the lines of:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="k">default</code><code class="o">:</code>
<code class="lineno">2</code>   <code class="calibre15">context</code><code class="o">:</code>
<code class="lineno">3</code>     <code class="calibre15">parameters</code><code class="o">:</code>
<code class="lineno">4</code>         <code class="calibre15">base_url</code><code class="o">:</code> <code class="calibre15">http</code><code class="o">://</code><code class="calibre15">localhost</code><code class="o">:</code><code class="o">8000</code>
</pre></div>

</figure>

<p class="calibre3">If you have virtual hosts set up on your machine then use those, and if you are running a local web server on a different port, then obviously you can use that too. That value could be <code class="calibre15">http://localhost:4000</code> or <code class="calibre15">http://dev-api.example.com</code>, it does not matter.</p>

<h3 id="calibre_link-35" class="calibre2">
<span class="section-number">5.8 </span>Running Behat</h3>

<p class="calibre3">This is the easiest bit:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code>behat -c tests/behat/behat-dev.yml
</pre></div>

</figure>

<p class="calibre3">Running this from the sample application should return a lot of green lights, because I have gone to the effort of
writing a few very basic feature tests against a few very simple endpoints that return data from a SQLite database.</p>

<p class="calibre3">Once you have that running, I recommend you try and make some tests in your own applications along the same sort of lines.
While we will have sample code to play with for many chapters, I strongly suggest you try to test your own API (brand
new or existing) too, as this is the most value you could get from the book.</p>

<p class="calibre3">Test. TEST. TEST YOUR APPLICATIONS.</p>

<h4 id="calibre_link-134" class="calibre4">Test Driven Development</h4>

<p class="calibre3">Writing tests first is also a great way to go. Now that you have an understanding of your action plan, what the
endpoints <em class="calibre19">should</em> be, and what their output <em class="calibre19">should</em> look like, you <em class="calibre19">should</em> be fine to build out tests against them
even if they do not exist.</p>

<p class="calibre3">Running the tests will show you that everything is broken of course, so you’ll just go through and build and test
the endpoints one at a time. This sounds hard, but you just CANNOT afford to mess about with testing on an API.</p>

<p class="calibre3">Doing this first will save you a shit-ton of hard work down the road. I have the scars to prove it.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-95">
<div class="calibre6">
<h2 id="calibre_link-36" class="calibre1">
<span class="section-number">6. </span>Outputting Data</h2>

<h3 id="calibre_link-37" class="calibre2">
<span class="section-number">6.1 </span>Introduction</h3>

<p class="calibre3">In <a href="#calibre_link-14">Chapter 3: Input and Output Theory</a> we looked at the theory of the output structure and the pros and
cons for various different formats. The rest of this book assumes you have picked your favourite, and it assumes that
favourite is my favourite. This does not matter all that much, but doing everything for everyone would be an exercise in
futility and boredom.</p>

<p class="calibre3">The aim of this chapter is to help you build out your controller endpoints. Assuming you have written tests for these
endpoints before they exist, we can now fill up a few of those tests with green lights (instead of the omnishambles of
errors and fails you are most likely facing).</p>

<p class="calibre3">This example shows a list of places:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>     <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno"> 3</code>         <code class="calibre15">{</code>
<code class="lineno"> 4</code>             <code class="s">"id"</code><code class="o">:</code> <code class="o">2</code><code class="calibre15">,</code>
<code class="lineno"> 5</code>             <code class="s">"name"</code><code class="o">:</code> <code class="s">"Videology"</code><code class="calibre15">,</code>
<code class="lineno"> 6</code>             <code class="s">"lat"</code><code class="o">:</code> <code class="o">40.713857</code><code class="calibre15">,</code>
<code class="lineno"> 7</code>             <code class="s">"lon"</code><code class="o">:</code> <code class="o">-</code><code class="o">73.961936</code><code class="calibre15">,</code>
<code class="lineno"> 8</code>             <code class="s">"created_at"</code><code class="o">:</code> <code class="s">"2013-04-02"</code>
<code class="lineno"> 9</code>         <code class="calibre15">},</code>
<code class="lineno">10</code>         <code class="calibre15">{</code>
<code class="lineno">11</code>             <code class="s">"id"</code><code class="o">:</code> <code class="o">1</code><code class="calibre15">,</code>
<code class="lineno">12</code>             <code class="s">"name"</code><code class="o">:</code> <code class="s">"Barcade"</code><code class="calibre15">,</code>
<code class="lineno">13</code>             <code class="s">"lat"</code><code class="o">:</code> <code class="o">40.712017</code><code class="calibre15">,</code>
<code class="lineno">14</code>             <code class="s">"lon"</code><code class="o">:</code> <code class="o">-</code><code class="o">73.950995</code><code class="calibre15">,</code>
<code class="lineno">15</code>             <code class="s">"created_at"</code><code class="o">:</code> <code class="s">"2012-09-23"</code>
<code class="lineno">16</code>         <code class="calibre15">}</code>
<code class="lineno">17</code>     <code class="calibre15">]</code>
<code class="lineno">18</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Here is just the one place:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">{</code>
<code class="lineno">2</code>     <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno">3</code>         <code class="s">"id"</code><code class="o">:</code> <code class="o">2</code><code class="calibre15">,</code>
<code class="lineno">4</code>         <code class="s">"name"</code><code class="o">:</code> <code class="s">"Videology"</code><code class="calibre15">,</code>
<code class="lineno">5</code>         <code class="s">"lat"</code><code class="o">:</code> <code class="o">40.713857</code><code class="calibre15">,</code>
<code class="lineno">6</code>         <code class="s">"lon"</code><code class="o">:</code> <code class="o">-</code><code class="o">73.961936</code><code class="calibre15">,</code>
<code class="lineno">7</code>         <code class="s">"created_at"</code><code class="o">:</code> <code class="s">"2013-04-02"</code>
<code class="lineno">8</code>     <code class="calibre15">]</code>
<code class="lineno">9</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<h3 id="calibre_link-38" class="calibre2">
<span class="section-number">6.2 </span>The Direct Approach</h3>

<p class="calibre3">The first thing that every developer tries to do is take their favourite ORM, ODM, DataMapper, or Query Builder, pull up
a query, then wang that result directly into the output.</p>

<figure class="code">
  <figcaption class="calibre20">Dangerously bad example of passing data from the database directly as output</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">&lt;?</code><code class="calibre15">php</code>
<code class="lineno"> 2</code> <code class="k">class</code> <code class="nc">PlaceController</code> <code class="k">extends</code> <code class="calibre15">ApiController</code>
<code class="lineno"> 3</code> <code class="calibre15">{</code>
<code class="lineno"> 4</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">show</code><code class="calibre15">(</code><code class="nv">$id</code><code class="calibre15">)</code>
<code class="lineno"> 5</code>     <code class="calibre15">{</code>
<code class="lineno"> 6</code>         <code class="k">return</code> <code class="nb">json_encode</code><code class="calibre15">([</code>
<code class="lineno"> 7</code>             <code class="s">'data'</code> <code class="o">=&gt;</code> <code class="calibre15">Place</code><code class="o">::</code><code class="na">find</code><code class="calibre15">(</code><code class="nv">$id</code><code class="calibre15">)</code><code class="o">-&gt;</code><code class="na">toArray</code><code class="calibre15">(),</code>
<code class="lineno"> 8</code>         <code class="calibre15">]);</code>
<code class="lineno"> 9</code>     <code class="calibre15">}</code>
<code class="lineno">10</code> 
<code class="lineno">11</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">index</code><code class="calibre15">()</code>
<code class="lineno">12</code>     <code class="calibre15">{</code>
<code class="lineno">13</code>         <code class="k">return</code> <code class="nb">json_encode</code><code class="calibre15">([</code>
<code class="lineno">14</code>             <code class="s">'data'</code> <code class="o">=&gt;</code> <code class="calibre15">Place</code><code class="o">::</code><code class="na">all</code><code class="calibre15">()</code><code class="o">-&gt;</code><code class="na">toArray</code><code class="calibre15">(),</code>
<code class="lineno">15</code>         <code class="calibre15">]);</code>
<code class="lineno">16</code>     <code class="calibre15">}</code>
<code class="lineno">17</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">This is the absolute worst idea you could have for enough reasons for me to fill up a chapter on its own, but I will
try to keep it to just a section.</p>

<aside class="warning">
    <h3 id="calibre_link-135" class="calibre23">ORMs in Controllers</h3>

  <p class="calibre3">Your controller should definitely not have this sort of ORM/Query Builder logic scattered around the methods. This
is done to keep the example to one class.</p>

</aside>

<p class="calibre3"><strong class="calibre22">Performance:</strong> If you return “all” items, the API will be fine during development, but suck when you have a thousand
records in that table… or a million.</p>

<p class="calibre3"><strong class="calibre22">Display:</strong> PHP’s popular SQL extensions all type cast all data coming out of a query as a string. So if you have a
MySQL “boolean” field (generally this is a <code class="calibre15">tinyint(1)</code> field with a value of <code class="calibre15">0</code> or <code class="calibre15">1</code>) it will display in the JSON
output as a string with a value of <code class="calibre15">"0"</code> or <code class="calibre15">"1"</code>, which is lunacy. If you’re using PostgreSQL, it is even worse. The
value directly output by PHP’s PostgreSQL driver is <code class="calibre15">"f"</code> or <code class="calibre15">"t"</code>. Your mobile developers won’t like it one bit, and
anyone looking at your public API is going to immediately consider this an amateur API. You want <code class="calibre15">true</code> or <code class="calibre15">false</code> as
an actual JSON boolean, not a numeric string or a <code class="calibre15">char(1)</code>.</p>

<p class="calibre3"><strong class="calibre22">Security:</strong> Outputting all fields can lead to API clients (users of all sorts) being able to view your users
passwords, see sensitive information like email addresses for businesses involved (venues, partners, events, etc.),
gain access to secret keys and tokens generally not allowed. If you leak your forgotten password tokens for example,
then you’re going to have an <em class="calibre19">extremely</em> bad time; it is as bad as leaking the password itself.</p>

<p class="calibre3">Some ORM’s have a “hidden” option to hide specific fields from being output. If you can promise that you and every
single other developer on your team (now, next year and for the entire lifetime of this application) will remember
about that, then congratulations, you could also achieve world peace with a team that focused.</p>

<p class="calibre3"><strong class="calibre22">Stability:</strong> If you change the name of a database field, or modify your MongoDB document, or change the statuses
available for a field between v3 and v4, then your API will continue to behave perfectly, but all of your iPhone users
are going to have busted crashing applications &mdash; and it is your fault. You will promise yourself that you will avoid
changing things, but you absolutely will. Change happens.</p>

<p class="calibre3">So, next, our theoretical developer friend will try hardcoding the output.</p>

<figure class="code">
  <figcaption class="calibre20">Laborious example of type casting and formatting data for output</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">&lt;?</code><code class="calibre15">php</code>
<code class="lineno"> 2</code> <code class="k">class</code> <code class="nc">PlaceController</code> <code class="k">extends</code> <code class="calibre15">ApiController</code>
<code class="lineno"> 3</code> <code class="calibre15">{</code>
<code class="lineno"> 4</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">show</code><code class="calibre15">(</code><code class="nv">$id</code><code class="calibre15">)</code>
<code class="lineno"> 5</code>     <code class="calibre15">{</code>
<code class="lineno"> 6</code>         <code class="nv">$place</code> <code class="o">=</code> <code class="calibre15">Place</code><code class="o">::</code><code class="na">find</code><code class="calibre15">(</code><code class="nv">$id</code><code class="calibre15">);</code>
<code class="lineno"> 7</code> 
<code class="lineno"> 8</code>         <code class="k">return</code> <code class="nb">json_encode</code><code class="calibre15">([</code>
<code class="lineno"> 9</code>             <code class="s">'data'</code> <code class="o">=&gt;</code> <code class="calibre15">[</code>
<code class="lineno">10</code>                 <code class="s">'id'</code>         <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">int</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">id</code><code class="calibre15">,</code>
<code class="lineno">11</code>                 <code class="s">'name'</code>       <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">name</code><code class="calibre15">,</code>
<code class="lineno">12</code>                 <code class="s">'lat'</code>        <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">float</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">lat</code><code class="calibre15">,</code>
<code class="lineno">13</code>                 <code class="s">'lon'</code>        <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">float</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">lon</code><code class="calibre15">,</code>
<code class="lineno">14</code>                 <code class="s">'created_at'</code> <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">string</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">created_at</code><code class="calibre15">,</code>
<code class="lineno">15</code>             <code class="calibre15">],</code>
<code class="lineno">16</code>         <code class="calibre15">]);</code>
<code class="lineno">17</code>     <code class="calibre15">}</code>
<code class="lineno">18</code> 
<code class="lineno">19</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">index</code><code class="calibre15">()</code>
<code class="lineno">20</code>     <code class="calibre15">{</code>
<code class="lineno">21</code>         <code class="nv">$places</code> <code class="o">=</code> <code class="calibre15">[];</code>
<code class="lineno">22</code> 
<code class="lineno">23</code>         <code class="k">foreach</code> <code class="calibre15">(</code><code class="calibre15">Place</code><code class="o">::</code><code class="na">all</code><code class="calibre15">()</code> <code class="k">as</code> <code class="nv">$place</code><code class="calibre15">)</code> <code class="calibre15">{</code>
<code class="lineno">24</code>             <code class="nv">$places</code><code class="calibre15">[]</code> <code class="o">=</code> <code class="calibre15">[</code>
<code class="lineno">25</code>                 <code class="s">'id'</code>         <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">int</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">id</code><code class="calibre15">,</code>
<code class="lineno">26</code>                 <code class="s">'name'</code>       <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">name</code><code class="calibre15">,</code>
<code class="lineno">27</code>                 <code class="s">'lat'</code>        <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">float</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">lat</code><code class="calibre15">,</code>
<code class="lineno">28</code>                 <code class="s">'lon'</code>        <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">float</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">lon</code><code class="calibre15">,</code>
<code class="lineno">29</code>                 <code class="s">'created_at'</code> <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">string</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">created_at</code><code class="calibre15">,</code>
<code class="lineno">30</code>             <code class="calibre15">];</code>
<code class="lineno">31</code>         <code class="calibre15">}</code>
<code class="lineno">32</code> 
<code class="lineno">33</code>         <code class="k">return</code> <code class="nb">json_encode</code><code class="calibre15">([</code>
<code class="lineno">34</code>             <code class="s">'data'</code> <code class="o">=&gt;</code> <code class="nv">$places</code><code class="calibre15">,</code>
<code class="lineno">35</code>         <code class="calibre15">]);</code>
<code class="lineno">36</code>     <code class="calibre15">}</code>
<code class="lineno">37</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Thanks to specifying exactly what fields to return in the JSON array, the security issues are taken care of. The
type casting of various fields turn numeric strings into integers, coordinates into floats, and that pesky <code class="calibre15">Carbon</code>
(DateTime) object from Laravel into a string, instead of letting the object turn itself into an array.</p>

<p class="calibre3">The only issue this has not taken care of from the above example is performance, but that is a job for pagination, which
will be covered in <a href="#calibre_link-63">Chapter 10: Pagination</a>.</p>

<p class="calibre3">A new issue has, however, been created. It should be a fairly obvious one; this is icky. Our theoretical developer now
tries something else.</p>

<figure class="code">
  <figcaption class="calibre20">Considerably better approach to formatting data for output</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">&lt;?</code><code class="calibre15">php</code>
<code class="lineno"> 2</code> <code class="k">class</code> <code class="nc">PlaceController</code> <code class="k">extends</code> <code class="calibre15">ApiController</code>
<code class="lineno"> 3</code> <code class="calibre15">{</code>
<code class="lineno"> 4</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">show</code><code class="calibre15">(</code><code class="nv">$id</code><code class="calibre15">)</code>
<code class="lineno"> 5</code>     <code class="calibre15">{</code>
<code class="lineno"> 6</code>         <code class="nv">$place</code> <code class="o">=</code> <code class="calibre15">Place</code><code class="o">::</code><code class="na">find</code><code class="calibre15">(</code><code class="nv">$id</code><code class="calibre15">);</code>
<code class="lineno"> 7</code> 
<code class="lineno"> 8</code>         <code class="k">return</code> <code class="nb">json_encode</code><code class="calibre15">([</code>
<code class="lineno"> 9</code>             <code class="s">'data'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">transformPlaceToJson</code><code class="calibre15">(</code><code class="nv">$place</code><code class="calibre15">),</code>
<code class="lineno">10</code>         <code class="calibre15">]);</code>
<code class="lineno">11</code>     <code class="calibre15">}</code>
<code class="lineno">12</code> 
<code class="lineno">13</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">index</code><code class="calibre15">()</code>
<code class="lineno">14</code>     <code class="calibre15">{</code>
<code class="lineno">15</code>         <code class="nv">$places</code> <code class="o">=</code> <code class="calibre15">[];</code>
<code class="lineno">16</code>         <code class="k">foreach</code> <code class="calibre15">(</code><code class="calibre15">Place</code><code class="o">::</code><code class="na">all</code><code class="calibre15">()</code> <code class="k">as</code> <code class="nv">$place</code><code class="calibre15">)</code> <code class="calibre15">{</code>
<code class="lineno">17</code>             <code class="nv">$places</code><code class="calibre15">[]</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">transformPlaceToJson</code><code class="calibre15">(</code><code class="nv">$place</code><code class="calibre15">);</code>
<code class="lineno">18</code>         <code class="calibre15">}</code>
<code class="lineno">19</code> 
<code class="lineno">20</code>         <code class="k">return</code> <code class="nb">json_encode</code><code class="calibre15">([</code>
<code class="lineno">21</code>             <code class="s">'data'</code> <code class="o">=&gt;</code> <code class="nv">$places</code><code class="calibre15">,</code>
<code class="lineno">22</code>         <code class="calibre15">]);</code>
<code class="lineno">23</code>     <code class="calibre15">}</code>
<code class="lineno">24</code> 
<code class="lineno">25</code>     <code class="k">private</code> <code class="k">function</code> <code class="nf">transformPlaceToJson</code><code class="calibre15">(</code><code class="calibre15">Place</code> <code class="nv">$place</code><code class="calibre15">)</code>
<code class="lineno">26</code>     <code class="calibre15">{</code>
<code class="lineno">27</code>         <code class="k">return</code> <code class="calibre15">[</code>
<code class="lineno">28</code>             <code class="s">'id'</code>         <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">int</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">id</code><code class="calibre15">,</code>
<code class="lineno">29</code>             <code class="s">'name'</code>       <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">name</code><code class="calibre15">,</code>
<code class="lineno">30</code>             <code class="s">'lat'</code>        <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">float</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">lat</code><code class="calibre15">,</code>
<code class="lineno">31</code>             <code class="s">'lon'</code>        <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">float</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">lon</code><code class="calibre15">,</code>
<code class="lineno">32</code>             <code class="s">'created_at'</code> <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">string</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">created_at</code><code class="calibre15">,</code>
<code class="lineno">33</code>         <code class="calibre15">];</code>
<code class="lineno">34</code>     <code class="calibre15">}</code>
<code class="lineno">35</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Certainly much better, but what if a different controller wants to show a place at any point? You could theoretically
move all of these transform methods to a new class or shove them in the <code class="calibre15">ApiController</code>, but that would just be odd.</p>

<p class="calibre3">Really, you want to make (what I have come to call) “transformers”, partially because the name is
awesome and because that is what they are doing &mdash; transforming data from the format it was stored as
in the data store into something ready to be converted into JSON, or whatever else, with a bit more
structure than just dumping out whatever your DB driver happened to give you.</p>

<p class="calibre3">I built a component to do this called <a href="http://fractal.thephpleague.com/">Fractal</a>, because PHP did not seem to have anything that would let me do
this.  Other languages have great solutions for this already. Some call it “data marshaling” or “serialization”,
but it is all achieving roughly the same goal: take potentially complicated data from a range of stores and turn
it into a consistent output.</p>

<ul class="calibre18">
  <li class="calibre14">
<a href="http://marshmallow.readthedocs.org/">Marshmallow</a> - Python</li>
  <li class="calibre14">
<a href="https://github.com/rails-api/active_model_serializers">ActiveModel Serializers</a> - Built for Rails API, which will be part of Rails 4.2</li>
  <li class="calibre14">
<a href="https://github.com/apotonick/roar">Roar</a> - Ruby, but not limited to Rails or ActiveModel</li>
</ul>

<h3 id="calibre_link-39" class="calibre2">
<span class="section-number">6.3 </span>Transformations with Fractal</h3>

<p class="calibre3">With Fractal, transformers are created as either a callback, or an instance of an object implementing
<code class="calibre15">TransformerAbstract</code>. They do exactly the job that our <code class="calibre15">transformPlaceToJson()</code> method did, but they live
on their own, are easily unit testable (if that floats your boat), and remove a lot of presentation clutter from the
controller.</p>

<p class="calibre3">Fractal does a lot more than that, which will be explored later on, but it covers concerns with transformation perfectly,
removes the security, stability, and display concerns addressed earlier.</p>

<p class="calibre3">That is the end of theory in this book. We will now be working with code. Open up the Sample Code ZIP file, or head to
the <a href="https://github.com/philsturgeon/build-apis-you-wont-hate">GitHub repo</a>, and extract it somewhere useful.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code><code class="nb">cd </code>chapter6
<code class="lineno">2</code> <code class="nv">$ </code>composer install
<code class="lineno">3</code> <code class="nv">$ </code>php artisan serve
<code class="lineno">4</code> Laravel development server started on http://localhost:8000
</pre></div>

</figure>

<p class="calibre3">Open your browser and go to <code class="calibre15">http://localhost:8000/places</code>. There you’ll see a list of places looking like this:</p>


<figure class="image">
  <img src="images/000001.png" alt="Fractal default JSON structure using the JSONView extension for Chrome" class="calibre30" />
  <figcaption class="calibre31">Fractal default JSON structure using the JSONView extension for Chrome</figcaption>
</figure>


<p class="calibre3">This is a Laravel application, but only because it has migrations and seeding and I like it. This is made up of a few
bits of PHP that would work in any framework, and the approach works in any language.</p>

<ul class="calibre18">
  <li class="calibre14">
<strong class="calibre22">composer.json</strong> - Added an autoloadable folder using PSR-0 allowing my own code to be loaded</li>
  <li class="calibre14">
<strong class="calibre22">app/controllers/ApiController.php</strong> - Insanely simple base controller for wrapping responses</li>
  <li class="calibre14">
<strong class="calibre22">app/controllers/PlaceController.php</strong> - Grab some data and pass it to the <code class="calibre15">ApiController</code>
</li>
</ul>

<p class="calibre3">Other than defining some basic GET routes in <code class="calibre15">app/routes.php</code> that is basically all that is being done.</p>

<p class="calibre3">The <code class="calibre15">PlaceController</code> looks like this:</p>

<figure class="code">
  <figcaption class="calibre20">Example of a controller using Fractal to output data</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">&lt;?</code><code class="calibre15">php</code>
<code class="lineno"> 2</code> <code class="k">use</code> <code class="calibre15">App\Transformer\PlaceTransformer</code><code class="calibre15">;</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code> <code class="k">class</code> <code class="nc">PlaceController</code> <code class="k">extends</code> <code class="calibre15">ApiController</code>
<code class="lineno"> 5</code> <code class="calibre15">{</code>
<code class="lineno"> 6</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">index</code><code class="calibre15">()</code>
<code class="lineno"> 7</code>     <code class="calibre15">{</code>
<code class="lineno"> 8</code>         <code class="nv">$places</code> <code class="o">=</code> <code class="calibre15">Place</code><code class="o">::</code><code class="na">take</code><code class="calibre15">(</code><code class="o">10</code><code class="calibre15">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="calibre15">();</code>
<code class="lineno"> 9</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">respondWithCollection</code><code class="calibre15">(</code><code class="nv">$places</code><code class="calibre15">,</code> <code class="k">new</code> <code class="calibre15">PlaceTransformer</code><code class="calibre15">);</code>
<code class="lineno">10</code>     <code class="calibre15">}</code>
<code class="lineno">11</code> 
<code class="lineno">12</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">show</code><code class="calibre15">(</code><code class="nv">$id</code><code class="calibre15">)</code>
<code class="lineno">13</code>     <code class="calibre15">{</code>
<code class="lineno">14</code>         <code class="nv">$place</code> <code class="o">=</code> <code class="calibre15">Place</code><code class="o">::</code><code class="na">find</code><code class="calibre15">(</code><code class="nv">$id</code><code class="calibre15">);</code>
<code class="lineno">15</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">respondWithItem</code><code class="calibre15">(</code><code class="nv">$place</code><code class="calibre15">,</code> <code class="k">new</code> <code class="calibre15">PlaceTransformer</code><code class="calibre15">);</code>
<code class="lineno">16</code>     <code class="calibre15">}</code>
<code class="lineno">17</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">The “raw data” (happens to be an ORM model but could be anything) is sent back with the appropriate convenience method,
and a transformer instance is provided too. These <code class="calibre15">respondWithCollection()</code> and <code class="calibre15">respondWithItem()</code> methods come from
<code class="calibre15">ApiController</code> and their job is just to create Fractal instances without exposing as many classes to interact with.</p>

<p class="calibre3">The <code class="calibre15">PlaceTransformer</code> looks like this:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="cp">&lt;?php</code> <code class="k">namespace</code> <code class="calibre15">App\Transformer</code><code class="calibre15">;</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="k">use</code> <code class="calibre15">Place</code><code class="calibre15">;</code>
<code class="lineno"> 4</code> <code class="k">use</code> <code class="calibre15">League\Fractal\TransformerAbstract</code><code class="calibre15">;</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code> <code class="k">class</code> <code class="nc">PlaceTransformer</code> <code class="k">extends</code> <code class="calibre15">TransformerAbstract</code>
<code class="lineno"> 7</code> <code class="calibre15">{</code>
<code class="lineno"> 8</code>     <code class="sd">/**</code>
<code class="lineno"> 9</code> <code class="sd">     * Turn this item object into a generic array</code>
<code class="lineno">10</code> <code class="sd">     *</code>
<code class="lineno">11</code> <code class="sd">     * @return array</code>
<code class="lineno">12</code> <code class="sd">     */</code>
<code class="lineno">13</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">transform</code><code class="calibre15">(</code><code class="calibre15">Place</code> <code class="nv">$place</code><code class="calibre15">)</code>
<code class="lineno">14</code>     <code class="calibre15">{</code>
<code class="lineno">15</code>         <code class="k">return</code> <code class="calibre15">[</code>
<code class="lineno">16</code>             <code class="s">'id'</code>           <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">int</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">id</code><code class="calibre15">,</code>
<code class="lineno">17</code>             <code class="s">'name'</code>         <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">name</code><code class="calibre15">,</code>
<code class="lineno">18</code>             <code class="s">'lat'</code>          <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">float</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">lat</code><code class="calibre15">,</code>
<code class="lineno">19</code>             <code class="s">'lon'</code>          <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">float</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">lon</code><code class="calibre15">,</code>
<code class="lineno">20</code>             <code class="s">'address1'</code>     <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">address1</code><code class="calibre15">,</code>
<code class="lineno">21</code>             <code class="s">'address2'</code>     <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">address2</code><code class="calibre15">,</code>
<code class="lineno">22</code>             <code class="s">'city'</code>         <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">city</code><code class="calibre15">,</code>
<code class="lineno">23</code>             <code class="s">'state'</code>        <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">state</code><code class="calibre15">,</code>
<code class="lineno">24</code>             <code class="s">'zip'</code>          <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">zip</code><code class="calibre15">,</code>
<code class="lineno">25</code>             <code class="s">'website'</code>      <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">website</code><code class="calibre15">,</code>
<code class="lineno">26</code>             <code class="s">'phone'</code>        <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">phone</code><code class="calibre15">,</code>
<code class="lineno">27</code>         <code class="calibre15">];</code>
<code class="lineno">28</code>     <code class="calibre15">}</code>
<code class="lineno">29</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Simple.</p>

<p class="calibre3">The ApiController is kept super simple at this point too:</p>

<figure class="code">
  <figcaption class="calibre20">Simple ApiController for basic responses using Fractal</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">&lt;?</code><code class="calibre15">php</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="k">use</code> <code class="calibre15">League\Fractal\Resource\Collection</code><code class="calibre15">;</code>
<code class="lineno"> 4</code> <code class="k">use</code> <code class="calibre15">League\Fractal\Resource\Item</code><code class="calibre15">;</code>
<code class="lineno"> 5</code> <code class="k">use</code> <code class="calibre15">League\Fractal\Manager</code><code class="calibre15">;</code>
<code class="lineno"> 6</code> <code class="k">use</code> <code class="calibre15">Illuminate\Routing\Controller</code><code class="calibre15">;</code>
<code class="lineno"> 7</code> 
<code class="lineno"> 8</code> <code class="k">class</code> <code class="nc">ApiController</code> <code class="k">extends</code> <code class="calibre15">Controller</code>
<code class="lineno"> 9</code> <code class="calibre15">{</code>
<code class="lineno">10</code>     <code class="k">protected</code> <code class="nv">$statusCode</code> <code class="o">=</code> <code class="o">200</code><code class="calibre15">;</code>
<code class="lineno">11</code> 
<code class="lineno">12</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">__construct</code><code class="calibre15">(</code><code class="calibre15">Manager</code> <code class="nv">$fractal</code><code class="calibre15">)</code>
<code class="lineno">13</code>     <code class="calibre15">{</code>
<code class="lineno">14</code>         <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">fractal</code> <code class="o">=</code> <code class="nv">$fractal</code><code class="calibre15">;</code>
<code class="lineno">15</code>     <code class="calibre15">}</code>
<code class="lineno">16</code> 
<code class="lineno">17</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">getStatusCode</code><code class="calibre15">()</code>
<code class="lineno">18</code>     <code class="calibre15">{</code>
<code class="lineno">19</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">statusCode</code><code class="calibre15">;</code>
<code class="lineno">20</code>     <code class="calibre15">}</code>
<code class="lineno">21</code> 
<code class="lineno">22</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">setStatusCode</code><code class="calibre15">(</code><code class="nv">$statusCode</code><code class="calibre15">)</code>
<code class="lineno">23</code>     <code class="calibre15">{</code>
<code class="lineno">24</code>         <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">statusCode</code> <code class="o">=</code> <code class="nv">$statusCode</code><code class="calibre15">;</code>
<code class="lineno">25</code>         <code class="k">return</code> <code class="nv">$this</code><code class="calibre15">;</code>
<code class="lineno">26</code>     <code class="calibre15">}</code>
<code class="lineno">27</code> 
<code class="lineno">28</code>     <code class="k">protected</code> <code class="k">function</code> <code class="nf">respondWithItem</code><code class="calibre15">(</code><code class="nv">$item</code><code class="calibre15">,</code> <code class="nv">$callback</code><code class="calibre15">)</code>
<code class="lineno">29</code>     <code class="calibre15">{</code>
<code class="lineno">30</code>         <code class="nv">$resource</code> <code class="o">=</code> <code class="k">new</code> <code class="calibre15">Item</code><code class="calibre15">(</code><code class="nv">$item</code><code class="calibre15">,</code> <code class="nv">$callback</code><code class="calibre15">);</code>
<code class="lineno">31</code> 
<code class="lineno">32</code>         <code class="nv">$rootScope</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">fractal</code><code class="o">-&gt;</code><code class="na">createData</code><code class="calibre15">(</code><code class="nv">$resource</code><code class="calibre15">);</code>
<code class="lineno">33</code> 
<code class="lineno">34</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">respondWithArray</code><code class="calibre15">(</code><code class="nv">$rootScope</code><code class="o">-&gt;</code><code class="na">toArray</code><code class="calibre15">());</code>
<code class="lineno">35</code>     <code class="calibre15">}</code>
<code class="lineno">36</code> 
<code class="lineno">37</code>     <code class="k">protected</code> <code class="k">function</code> <code class="nf">respondWithCollection</code><code class="calibre15">(</code><code class="nv">$collection</code><code class="calibre15">,</code> <code class="nv">$callback</code><code class="calibre15">)</code>
<code class="lineno">38</code>     <code class="calibre15">{</code>
<code class="lineno">39</code>         <code class="nv">$resource</code> <code class="o">=</code> <code class="k">new</code> <code class="calibre15">Collection</code><code class="calibre15">(</code><code class="nv">$collection</code><code class="calibre15">,</code> <code class="nv">$callback</code><code class="calibre15">);</code>
<code class="lineno">40</code> 
<code class="lineno">41</code>         <code class="nv">$rootScope</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">fractal</code><code class="o">-&gt;</code><code class="na">createData</code><code class="calibre15">(</code><code class="nv">$resource</code><code class="calibre15">);</code>
<code class="lineno">42</code> 
<code class="lineno">43</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">respondWithArray</code><code class="calibre15">(</code><code class="nv">$rootScope</code><code class="o">-&gt;</code><code class="na">toArray</code><code class="calibre15">());</code>
<code class="lineno">44</code>     <code class="calibre15">}</code>
<code class="lineno">45</code> 
<code class="lineno">46</code>     <code class="k">protected</code> <code class="k">function</code> <code class="nf">respondWithArray</code><code class="calibre15">(</code><code class="k">array</code> <code class="nv">$array</code><code class="calibre15">,</code> <code class="k">array</code> <code class="nv">$headers</code> <code class="o">=</code> <code class="calibre15">[])</code>
<code class="lineno">47</code>     <code class="calibre15">{</code>
<code class="lineno">48</code>         <code class="k">return</code> <code class="calibre15">Response</code><code class="o">::</code><code class="na">json</code><code class="calibre15">(</code><code class="nv">$array</code><code class="calibre15">,</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">statusCode</code><code class="calibre15">,</code> <code class="nv">$headers</code><code class="calibre15">);</code>
<code class="lineno">49</code>     <code class="calibre15">}</code>
<code class="lineno">50</code> 
<code class="lineno">51</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">The method <code class="calibre15">respondWithArray()</code> takes a general array to convert into JSON, which will prove useful with errors. Other
than that, everything you return will be a Fractal Item, or a Collection.</p>

<h3 id="calibre_link-40" class="calibre2">
<span class="section-number">6.4 </span>Hiding Schema Updates</h3>

<p class="calibre3">Schema updates happen and they can be hard to avoid. If the change in question is simply a renamed field, then this is
insanely easy to handle:</p>

<p class="calibre3">
  <strong class="calibre22">Before</strong>
</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code>         <code class="err">'</code><code class="calibre15">website</code><code class="err">'</code> <code class="o">=&gt;</code> <code class="err">$</code><code class="calibre15">place</code><code class="o">-&gt;</code><code class="calibre15">website</code><code class="calibre15">,</code>
</pre></div>

</figure>

<p class="calibre3">
  <strong class="calibre22">After</strong>
</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code>         <code class="err">'</code><code class="calibre15">website</code><code class="err">'</code> <code class="o">=&gt;</code> <code class="err">$</code><code class="calibre15">place</code><code class="o">-&gt;</code><code class="calibre15">url</code><code class="calibre15">,</code>
</pre></div>

</figure>

<p class="calibre3">By changing the right (our internal data structure) and keeping the left the same (the external field name), we maintain
control over the outside stability for the client applications.</p>

<p class="calibre3">Sometimes it is a status change, a new status being added, or the change is fairly drastic and the statuses all change, but
the old API version is still expecting the old ones. Maybe someone changed “available” to “active” to be consistent with
the other tables because the original developer was as consistent and logical as a rabid ferret.</p>

<p class="calibre3">
  <strong class="calibre22">Before</strong>
</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code>         <code class="err">'</code><code class="calibre15">status</code><code class="err">'</code> <code class="o">=&gt;</code> <code class="err">$</code><code class="calibre15">place</code><code class="o">-&gt;</code><code class="calibre15">status</code><code class="calibre15">,</code>
</pre></div>

</figure>

<p class="calibre3">
  <strong class="calibre22">After</strong>
</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code>         <code class="err">'</code><code class="calibre15">status</code><code class="err">'</code> <code class="o">=&gt;</code> <code class="err">$</code><code class="calibre15">place</code><code class="o">-&gt;</code><code class="calibre15">status</code> <code class="o">===</code> <code class="err">'</code><code class="calibre15">available</code><code class="err">'</code> <code class="o">?</code> <code class="err">'</code><code class="calibre15">active</code><code class="err">'</code> <code class="o">:</code> <code class="err">$</code><code class="calibre15">place</code><code class="o">-&gt;</code><code class="calibre15">status</code><code class="calibre15">,</code>
</pre></div>

</figure>

<p class="calibre3">Gross, but useful.</p>

<h3 id="calibre_link-41" class="calibre2">
<span class="section-number">6.5 </span>Outputting Errors</h3>

<p class="calibre3">Exactly how to output errors is something I am still toying with myself. The current front runner is adding
convenience methods to the <code class="calibre15">ApiController</code>, which handle global routes with a constant as the code and an HTTP error code
set with an optional message in case I want to override the message.</p>

<figure class="code">
  <figcaption class="calibre20">Simple error codes and responses added to ApiController</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">&lt;?</code><code class="calibre15">php</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="c">// ...</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code> <code class="k">class</code> <code class="nc">ApiController</code> <code class="k">extends</code> <code class="calibre15">Controller</code>
<code class="lineno"> 6</code> <code class="calibre15">{</code>
<code class="lineno"> 7</code>     <code class="c">// ...</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>     <code class="k">const</code> <code class="no">CODE_WRONG_ARGS</code> <code class="o">=</code> <code class="s">'GEN-FUBARGS'</code><code class="calibre15">;</code>
<code class="lineno">10</code>     <code class="k">const</code> <code class="no">CODE_NOT_FOUND</code> <code class="o">=</code> <code class="s">'GEN-LIKETHEWIND'</code><code class="calibre15">;</code>
<code class="lineno">11</code>     <code class="k">const</code> <code class="no">CODE_INTERNAL_ERROR</code> <code class="o">=</code> <code class="s">'GEN-AAAGGH'</code><code class="calibre15">;</code>
<code class="lineno">12</code>     <code class="k">const</code> <code class="no">CODE_UNAUTHORIZED</code> <code class="o">=</code> <code class="s">'GEN-MAYBGTFO'</code><code class="calibre15">;</code>
<code class="lineno">13</code>     <code class="k">const</code> <code class="no">CODE_FORBIDDEN</code> <code class="o">=</code> <code class="s">'GEN-GTFO'</code><code class="calibre15">;</code>
<code class="lineno">14</code> 
<code class="lineno">15</code>     <code class="c">// ...</code>
<code class="lineno">16</code> 
<code class="lineno">17</code>     <code class="k">protected</code> <code class="k">function</code> <code class="nf">respondWithError</code><code class="calibre15">(</code><code class="nv">$message</code><code class="calibre15">,</code> <code class="nv">$errorCode</code><code class="calibre15">)</code>
<code class="lineno">18</code>     <code class="calibre15">{</code>
<code class="lineno">19</code>         <code class="k">if</code> <code class="calibre15">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">statusCode</code> <code class="o">===</code> <code class="o">200</code><code class="calibre15">)</code> <code class="calibre15">{</code>
<code class="lineno">20</code>             <code class="nb">trigger_error</code><code class="calibre15">(</code>
<code class="lineno">21</code>                 <code class="s">"You better have a really good reason for erroring on a 200..."</code><code class="calibre15">,</code>
<code class="lineno">22</code>                 <code class="calibre15">E_USER_WARNING</code>
<code class="lineno">23</code>             <code class="calibre15">);</code>
<code class="lineno">24</code>         <code class="calibre15">}</code>
<code class="lineno">25</code> 
<code class="lineno">26</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">respondWithArray</code><code class="calibre15">([</code>
<code class="lineno">27</code>             <code class="s">'error'</code> <code class="o">=&gt;</code> <code class="calibre15">[</code>
<code class="lineno">28</code>                 <code class="s">'code'</code> <code class="o">=&gt;</code> <code class="nv">$errorCode</code><code class="calibre15">,</code>
<code class="lineno">29</code>                 <code class="s">'http_code'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">statusCode</code><code class="calibre15">,</code>
<code class="lineno">30</code>                 <code class="s">'message'</code> <code class="o">=&gt;</code> <code class="nv">$message</code><code class="calibre15">,</code>
<code class="lineno">31</code>             <code class="calibre15">]</code>
<code class="lineno">32</code>         <code class="calibre15">]);</code>
<code class="lineno">33</code>     <code class="calibre15">}</code>
<code class="lineno">34</code> 
<code class="lineno">35</code>     <code class="sd">/**</code>
<code class="lineno">36</code> <code class="sd">     * Generates a Response with a 403 HTTP header and a given message.</code>
<code class="lineno">37</code> <code class="sd">     *</code>
<code class="lineno">38</code> <code class="sd">     * @return  Response</code>
<code class="lineno">39</code> <code class="sd">     */</code>
<code class="lineno">40</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">errorForbidden</code><code class="calibre15">(</code><code class="nv">$message</code> <code class="o">=</code> <code class="s">'Forbidden'</code><code class="calibre15">)</code>
<code class="lineno">41</code>     <code class="calibre15">{</code>
<code class="lineno">42</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">setStatusCode</code><code class="calibre15">(</code><code class="o">403</code><code class="calibre15">)</code>
<code class="lineno">43</code>           <code class="o">-&gt;</code><code class="na">respondWithError</code><code class="calibre15">(</code><code class="nv">$message</code><code class="calibre15">,</code> <code class="calibre15">self</code><code class="o">::</code><code class="na">CODE_FORBIDDEN</code><code class="calibre15">);</code>
<code class="lineno">44</code>     <code class="calibre15">}</code>
<code class="lineno">45</code> 
<code class="lineno">46</code>     <code class="sd">/**</code>
<code class="lineno">47</code> <code class="sd">     * Generates a Response with a 500 HTTP header and a given message.</code>
<code class="lineno">48</code> <code class="sd">     *</code>
<code class="lineno">49</code> <code class="sd">     * @return  Response</code>
<code class="lineno">50</code> <code class="sd">     */</code>
<code class="lineno">51</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">errorInternalError</code><code class="calibre15">(</code><code class="nv">$message</code> <code class="o">=</code> <code class="s">'Internal Error'</code><code class="calibre15">)</code>
<code class="lineno">52</code>     <code class="calibre15">{</code>
<code class="lineno">53</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">setStatusCode</code><code class="calibre15">(</code><code class="o">500</code><code class="calibre15">)</code>
<code class="lineno">54</code>           <code class="o">-&gt;</code><code class="na">respondWithError</code><code class="calibre15">(</code><code class="nv">$message</code><code class="calibre15">,</code> <code class="calibre15">self</code><code class="o">::</code><code class="na">CODE_INTERNAL_ERROR</code><code class="calibre15">);</code>
<code class="lineno">55</code>     <code class="calibre15">}</code>
<code class="lineno">56</code> 
<code class="lineno">57</code>     <code class="sd">/**</code>
<code class="lineno">58</code> <code class="sd">     * Generates a Response with a 404 HTTP header and a given message.</code>
<code class="lineno">59</code> <code class="sd">     *</code>
<code class="lineno">60</code> <code class="sd">     * @return  Response</code>
<code class="lineno">61</code> <code class="sd">     */</code>
<code class="lineno">62</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">errorNotFound</code><code class="calibre15">(</code><code class="nv">$message</code> <code class="o">=</code> <code class="s">'Resource Not Found'</code><code class="calibre15">)</code>
<code class="lineno">63</code>     <code class="calibre15">{</code>
<code class="lineno">64</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">setStatusCode</code><code class="calibre15">(</code><code class="o">404</code><code class="calibre15">)</code>
<code class="lineno">65</code>           <code class="o">-&gt;</code><code class="na">respondWithError</code><code class="calibre15">(</code><code class="nv">$message</code><code class="calibre15">,</code> <code class="calibre15">self</code><code class="o">::</code><code class="na">CODE_NOT_FOUND</code><code class="calibre15">);</code>
<code class="lineno">66</code>     <code class="calibre15">}</code>
<code class="lineno">67</code> 
<code class="lineno">68</code>     <code class="sd">/**</code>
<code class="lineno">69</code> <code class="sd">     * Generates a Response with a 401 HTTP header and a given message.</code>
<code class="lineno">70</code> <code class="sd">     *</code>
<code class="lineno">71</code> <code class="sd">     * @return  Response</code>
<code class="lineno">72</code> <code class="sd">     */</code>
<code class="lineno">73</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">errorUnauthorized</code><code class="calibre15">(</code><code class="nv">$message</code> <code class="o">=</code> <code class="s">'Unauthorized'</code><code class="calibre15">)</code>
<code class="lineno">74</code>     <code class="calibre15">{</code>
<code class="lineno">75</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">setStatusCode</code><code class="calibre15">(</code><code class="o">401</code><code class="calibre15">)</code>
<code class="lineno">76</code>           <code class="o">-&gt;</code><code class="na">respondWithError</code><code class="calibre15">(</code><code class="nv">$message</code><code class="calibre15">,</code> <code class="calibre15">self</code><code class="o">::</code><code class="na">CODE_UNAUTHORIZED</code><code class="calibre15">);</code>
<code class="lineno">77</code>     <code class="calibre15">}</code>
<code class="lineno">78</code> 
<code class="lineno">79</code>     <code class="sd">/**</code>
<code class="lineno">80</code> <code class="sd">     * Generates a Response with a 400 HTTP header and a given message.</code>
<code class="lineno">81</code> <code class="sd">     *</code>
<code class="lineno">82</code> <code class="sd">     * @return  Response</code>
<code class="lineno">83</code> <code class="sd">     */</code>
<code class="lineno">84</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">errorWrongArgs</code><code class="calibre15">(</code><code class="nv">$message</code> <code class="o">=</code> <code class="s">'Wrong Arguments'</code><code class="calibre15">)</code>
<code class="lineno">85</code>     <code class="calibre15">{</code>
<code class="lineno">86</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">setStatusCode</code><code class="calibre15">(</code><code class="o">400</code><code class="calibre15">)</code>
<code class="lineno">87</code>           <code class="o">-&gt;</code><code class="na">respondWithError</code><code class="calibre15">(</code><code class="nv">$message</code><code class="calibre15">,</code> <code class="calibre15">self</code><code class="o">::</code><code class="na">CODE_WRONG_ARGS</code><code class="calibre15">);</code>
<code class="lineno">88</code>     <code class="calibre15">}</code>
<code class="lineno">89</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">This basically allows for generic error messages to be returned in your controller without having to think too much
about the specifics.</p>

<figure class="code">
  <figcaption class="calibre20">Controller using Fractal, combined with a simple error response</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">&lt;?</code><code class="calibre15">php</code>
<code class="lineno"> 2</code> <code class="k">use</code> <code class="calibre15">App\Transformer\PlaceTransformer</code><code class="calibre15">;</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code> <code class="k">class</code> <code class="nc">PlaceController</code> <code class="k">extends</code> <code class="calibre15">ApiController</code>
<code class="lineno"> 5</code> <code class="calibre15">{</code>
<code class="lineno"> 6</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">index</code><code class="calibre15">()</code>
<code class="lineno"> 7</code>     <code class="calibre15">{</code>
<code class="lineno"> 8</code>         <code class="nv">$places</code> <code class="o">=</code> <code class="calibre15">Place</code><code class="o">::</code><code class="na">take</code><code class="calibre15">(</code><code class="o">10</code><code class="calibre15">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="calibre15">();</code>
<code class="lineno"> 9</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">respondWithCollection</code><code class="calibre15">(</code><code class="nv">$places</code><code class="calibre15">,</code> <code class="k">new</code> <code class="calibre15">PlaceTransformer</code><code class="calibre15">);</code>
<code class="lineno">10</code>     <code class="calibre15">}</code>
<code class="lineno">11</code> 
<code class="lineno">12</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">show</code><code class="calibre15">(</code><code class="nv">$id</code><code class="calibre15">)</code>
<code class="lineno">13</code>     <code class="calibre15">{</code>
<code class="lineno">14</code>         <code class="nv">$place</code> <code class="o">=</code> <code class="calibre15">Place</code><code class="o">::</code><code class="na">find</code><code class="calibre15">(</code><code class="nv">$id</code><code class="calibre15">);</code>
<code class="lineno">15</code> 
<code class="lineno">16</code>         <code class="k">if</code> <code class="calibre15">(</code><code class="o">!</code> <code class="nv">$place</code><code class="calibre15">)</code> <code class="calibre15">{</code>
<code class="lineno">17</code>             <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">errorNotFound</code><code class="calibre15">(</code>
<code class="lineno">18</code>                 <code class="s">'Did you just invent an ID and try loading a place?'</code>
<code class="lineno">19</code>             <code class="calibre15">);</code>
<code class="lineno">20</code>         <code class="calibre15">}</code>
<code class="lineno">21</code> 
<code class="lineno">22</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">respondWithItem</code><code class="calibre15">(</code><code class="nv">$place</code><code class="calibre15">,</code> <code class="k">new</code> <code class="calibre15">PlaceTransformer</code><code class="calibre15">);</code>
<code class="lineno">23</code>     <code class="calibre15">}</code>
<code class="lineno">24</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Other “Place” specific errors could go directly into the <code class="calibre15">PlaceController</code> as methods just like these, with their own
constants in the controller, picking a <code class="calibre15">statusCode</code> in the method, or relying on one as an argument.</p>

<h3 id="calibre_link-42" class="calibre2">
<span class="section-number">6.6 </span>Testing this Output</h3>

<p class="calibre3">You have already seen how to test your endpoints using the Gherkin syntax in <a href="#calibre_link-27">Chapter 5: Endpoint Testing</a>,
so we can apply that testing logic to this output:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">Feature</code><code class="o">:</code> <code class="calibre15">Places</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="calibre15">Scenario</code><code class="o">:</code> <code class="calibre15">Listing</code> <code class="calibre15">places</code> <code class="calibre15">without</code> <code class="calibre15">search</code> <code class="calibre15">criteria</code> <code class="k">is</code> <code class="calibre15">not</code> <code class="calibre15">possible</code>
<code class="lineno"> 4</code>     <code class="calibre15">When</code> <code class="calibre15">I</code> <code class="calibre15">request</code> <code class="s">"GET /places"</code>
<code class="lineno"> 5</code>     <code class="calibre15">Then</code> <code class="calibre15">I</code> <code class="k">get</code> <code class="calibre15">a</code> <code class="s">"400"</code> <code class="calibre15">response</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> <code class="calibre15">Scenario</code><code class="o">:</code> <code class="calibre15">Finding</code> <code class="calibre15">a</code> <code class="calibre15">specific</code> <code class="calibre15">place</code>
<code class="lineno"> 8</code>     <code class="calibre15">When</code> <code class="calibre15">I</code> <code class="calibre15">request</code> <code class="s">"GET /places/1"</code>
<code class="lineno"> 9</code>     <code class="calibre15">Then</code> <code class="calibre15">I</code> <code class="k">get</code> <code class="calibre15">a</code> <code class="s">"200"</code> <code class="calibre15">response</code>
<code class="lineno">10</code>     <code class="calibre15">And</code> <code class="calibre15">scope</code> <code class="calibre15">into</code> <code class="calibre15">the</code> <code class="s">"data"</code> <code class="calibre15">property</code>
<code class="lineno">11</code>         <code class="calibre15">And</code> <code class="calibre15">the</code> <code class="calibre15">properties</code> <code class="calibre15">exist</code><code class="o">:</code>
<code class="lineno">12</code>             <code class="s">"""</code>
<code class="lineno">13</code> <code class="s">            id</code>
<code class="lineno">14</code> <code class="s">            name</code>
<code class="lineno">15</code> <code class="s">            lat</code>
<code class="lineno">16</code> <code class="s">            lon</code>
<code class="lineno">17</code> <code class="s">            address1</code>
<code class="lineno">18</code> <code class="s">            address2</code>
<code class="lineno">19</code> <code class="s">            city</code>
<code class="lineno">20</code> <code class="s">            state</code>
<code class="lineno">21</code> <code class="s">            zip</code>
<code class="lineno">22</code> <code class="s">            website</code>
<code class="lineno">23</code> <code class="s">            phone</code>
<code class="lineno">24</code> <code class="s">            created_at</code>
<code class="lineno">25</code> <code class="s">            """</code>
<code class="lineno">26</code>         <code class="calibre15">And</code> <code class="calibre15">the</code> <code class="s">"id"</code> <code class="calibre15">property</code> <code class="k">is</code> <code class="calibre15">an</code> <code class="calibre15">integer</code>
<code class="lineno">27</code> 
<code class="lineno">28</code> <code class="calibre15">Scenario</code><code class="o">:</code> <code class="calibre15">Searching</code> <code class="calibre15">non</code><code class="o">-</code><code class="calibre15">existent</code> <code class="calibre15">place</code>
<code class="lineno">29</code>     <code class="calibre15">When</code> <code class="calibre15">I</code> <code class="calibre15">request</code> <code class="s">"GET /places?q=c800e42c377881f8ae509cf9a516d4eb59&amp;lat=1&amp;lon=1"</code>
<code class="lineno">30</code>     <code class="calibre15">Then</code> <code class="calibre15">I</code> <code class="k">get</code> <code class="calibre15">a</code> <code class="s">"200"</code> <code class="calibre15">response</code>
<code class="lineno">31</code>     <code class="calibre15">And</code> <code class="calibre15">the</code> <code class="s">"data"</code> <code class="calibre15">property</code> <code class="calibre15">contains</code> <code class="o">0</code> <code class="calibre15">items</code>
<code class="lineno">32</code> 
<code class="lineno">33</code> 
<code class="lineno">34</code> <code class="calibre15">Scenario</code><code class="o">:</code> <code class="calibre15">Searching</code> <code class="calibre15">places</code> <code class="k">with</code> <code class="calibre15">filters</code>
<code class="lineno">35</code>     <code class="calibre15">When</code> <code class="calibre15">I</code> <code class="calibre15">request</code> <code class="s">"GET /places?lat=40.76855&amp;lon=-73.9945&amp;q=cheese"</code>
<code class="lineno">36</code>     <code class="calibre15">Then</code> <code class="calibre15">I</code> <code class="k">get</code> <code class="calibre15">a</code> <code class="s">"200"</code> <code class="calibre15">response</code>
<code class="lineno">37</code>     <code class="calibre15">And</code> <code class="calibre15">the</code> <code class="s">"data"</code> <code class="calibre15">property</code> <code class="k">is</code> <code class="calibre15">an</code> <code class="calibre15">array</code>
<code class="lineno">38</code>     <code class="calibre15">And</code> <code class="calibre15">scope</code> <code class="calibre15">into</code> <code class="calibre15">the</code> <code class="calibre15">first</code> <code class="s">"data"</code> <code class="calibre15">property</code>
<code class="lineno">39</code>         <code class="calibre15">And</code> <code class="calibre15">the</code> <code class="calibre15">properties</code> <code class="calibre15">exist</code><code class="o">:</code>
<code class="lineno">40</code>             <code class="s">"""</code>
<code class="lineno">41</code> <code class="s">            id</code>
<code class="lineno">42</code> <code class="s">            name</code>
<code class="lineno">43</code> <code class="s">            lat</code>
<code class="lineno">44</code> <code class="s">            lon</code>
<code class="lineno">45</code> <code class="s">            address1</code>
<code class="lineno">46</code> <code class="s">            address2</code>
<code class="lineno">47</code> <code class="s">            city</code>
<code class="lineno">48</code> <code class="s">            state</code>
<code class="lineno">49</code> <code class="s">            zip</code>
<code class="lineno">50</code> <code class="s">            website</code>
<code class="lineno">51</code> <code class="s">            phone</code>
<code class="lineno">52</code> <code class="s">            created_at</code>
<code class="lineno">53</code> <code class="s">            """</code>
<code class="lineno">54</code>     <code class="calibre15">And</code> <code class="calibre15">reset</code> <code class="calibre15">scope</code>
</pre></div>

</figure>

<p class="calibre3">This is again using the <code class="calibre15">FeatureContext.php</code> provided in the sample code, which makes it really easy to test output.
We are again assuming that all output is in a <code class="calibre15">"data"</code> element, which is either an object (when one resource has been
requested), or an array of objects (multiple resources or a collection have been requested).</p>

<p class="calibre3">When you are searching for data, you want to ensure that a query not finding any data does not explode. This can be down to your
controller processing on output and failing because what should be an <code class="calibre15">array</code> is <code class="calibre15">null</code>, or because some PHP collection
class is missing methods, etc. This is why we perform the search with a hardcoded invalid search term and then check that
it returns an empty collection:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">{</code>
<code class="lineno">2</code>     <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">[]</code>
<code class="lineno">3</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">The line <code class="calibre15">And the "data" property contains 0 items</code> will cover this. Then we can search for valid terms, knowing that
our database seeder has made sure at least one Place has the keyword “cheese” in the name. Using the line <code class="calibre15">And scope
into the first "data" property</code> the scope changes to be inside the first data item returned, and the properties can be
checked for existence too. If no data, or required fields are missing, this test will fail.</p>

<h3 id="calibre_link-43" class="calibre2">
<span class="section-number">6.7 </span>Homework</h3>

<p class="calibre3">Your homework is to take apart the sample application, fit it into your API, and try to build valid output for as many
of your GET endpoints as possible. Check the data types and make sure the array structure is output in the expected
fashion using the test example above.</p>

<p class="calibre3">With valid output covered and basic errors covered, what is next? The most complicated part of API generation, which at
some point every developer has to try and work out: embedding/nesting resources, or making “relationships”.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-102">
<div class="calibre6">
<h2 id="calibre_link-44" class="calibre1">
<span class="section-number">7. </span>Data Relationships</h2>

<h3 id="calibre_link-45" class="calibre2">
<span class="section-number">7.1 </span>Introduction</h3>

<p class="calibre3">If you have ever worked with relational databases, the chances are you understand relationships. Users have
comments. Authors have one or many books. Books belong to a publisher. Southerners have one or more teeth.
 Whatever the example, relationships are incredibly important to any application and therefore an API too.</p>

<p class="calibre3">Relationships for your API output do not need to be directly mapped to database relationships.
If your database relationships are built properly, relationships will often be similar, but your
output might have extra dynamic relationships that are not defined by a JOIN, and might not
necessarily include every possible database relationship.</p>

<p class="calibre3">Put more eloquently:</p>

<blockquote class="calibre17">
  <p class="calibre3">REST components communicate by transferring a representation of a resource in a format matching one of
an evolving set of standard data types, selected dynamically based on the capabilities or desires of
the recipient and the nature of the resource. Whether the representation is in the same format as the raw
source, or is derived from the source, remains hidden behind the interface.
&ndash; <a href="http://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm#sec_5_2">Roy Fielding</a></p>
</blockquote>

<p class="calibre3">This explanation highlights an important factor: the output has to be based on the “desires of
the recipient”. There are many popular approaches to designing relationships, but many of them do
not satisfy the “desires of the recipient”. Still, I will cover the popular approaches
with their pros and cons.</p>

<h3 id="calibre_link-46" class="calibre2">
<span class="section-number">7.2 </span>Subresources</h3>

<p class="calibre3">One very simplistic way to approach related data is to offer up new URLs for your API consumers
to digest. This was covered lightly in <a href="#calibre_link-10">Chapter 2: Planning and Creating Endpoints</a> and is
a perfectly valid approach.</p>

<p class="calibre3">If an API has <code class="calibre15">places</code> as a resource and wants to allow access to a places check-ins, an
endpoint could be made to handle exactly that:</p>

<blockquote class="calibre17">
  <p class="calibre3">/places/X/checkins</p>
</blockquote>

<p class="calibre3">The downside here is that if you have already requested <code class="calibre15">GET /places/X</code>, then fetching the check-ins
will require an extra HTTP request. Imagine a mobile app that wants to get
all <code class="calibre15">places</code> in an area and put them on a map, then allow a user to browse through them. If the <code class="calibre15">place</code>
search happens as one request, then the <code class="calibre15">/places/X/checkins</code> is executed each time the user clicks on a
place, forcing the user to do a lot of unnecessary waiting. This is known as <code class="calibre15">1 + n</code>, meaning the work
done is increased by an extra one request for each <code class="calibre15">place</code> you look up.</p>

<p class="calibre3">That also assumes the only related data is check-ins. At Kapture, our API also had <code class="calibre15">merchant</code>, <code class="calibre15">images</code>,
<code class="calibre15">current_campaign</code> and <code class="calibre15">previous_campaigns</code> to look up. Using “subresources” would only mean that four
extra HTTP requests per place need to happen, which is <code class="calibre15">1 + 4n</code>.</p>

<p class="calibre3">If 50 <code class="calibre15">places</code> were returned, and each time the related data had to be loaded, assuming the app user looked
through all 50 <code class="calibre15">places</code>, there would be 1 initial request to get 50 results. Each of those results
would require 4 more requests, meaning: <code class="calibre15">1 + (50 x 4) = 251</code>. 251 HTTP requests happening (even assuming they are
asynchronous) is just unnecessary, and going over HTTP on a mobile is the slowest things you can do. Even with
caching, depending on the data set, it could still be 251 requests.</p>

<p class="calibre3">Some API developers try to avoid going over HTTP too many times by shoving as much data as possible into one
request, so when you call the <code class="calibre15">/places</code> endpoint you automatically get <code class="calibre15">checkins</code>, <code class="calibre15">current_opps</code>,
<code class="calibre15">merchants</code> and <code class="calibre15">images</code>. Unfortunately, shoving all of the information into the response (whether or not the
client has indicated any interest in it) means waiting for huge file downloads full of irrelevant
data! Even with GZIP compression enabled on the web server, downloading something you do not need is obviously not
desirable, and can be avoided. This can mean major performance gains on mobile, and minor gains over a slow network,
or weak Wi-Fi for desktop or tablets.</p>

<p class="calibre3">The trade-off here is between downloading enough data to avoid making the user wait for subsequent loads
and downloading too much data to make them wait for the initial load is hard. An API needs the
flexibility, and making subresources the only way to load related data is restrictive for the API consumer.</p>

<h3 id="calibre_link-47" class="calibre2">
<span class="section-number">7.3 </span>Foreign Key Arrays</h3>

<p class="calibre3">Another approach to related data is to provide an array of foreign keys in the output. To use
the <a href="http://jsonapi.org/">JSON-API</a> standard as an example; if a <code class="calibre15">post</code> has multiple
<code class="calibre15">comments</code>, the <code class="calibre15">/posts</code> endpoint might contain the following:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">{</code>
<code class="lineno">2</code>   <code class="s">"post"</code><code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno">3</code>     <code class="s">"id"</code><code class="o">:</code> <code class="o">1</code><code class="calibre15">,</code>
<code class="lineno">4</code>     <code class="s">"title"</code><code class="o">:</code> <code class="s">"Progressive Enhancement is Dead"</code><code class="calibre15">,</code>
<code class="lineno">5</code>     <code class="s">"_links"</code><code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno">6</code>       <code class="s">"comments"</code><code class="o">:</code> <code class="calibre15">[</code><code class="s">"1"</code><code class="calibre15">,</code> <code class="s">"2"</code><code class="calibre15">]</code>
<code class="lineno">7</code>     <code class="calibre15">}</code>
<code class="lineno">8</code>   <code class="calibre15">}</code>
<code class="lineno">9</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Here you still end up with <code class="calibre15">n + 1</code> requests, but at least you can take those IDs and make a grouped
request like <code class="calibre15">/comments/1,2</code> or <code class="calibre15">/comments?ids=1,2</code> to reduce how many HTTP requests are being made.</p>

<p class="calibre3">Back to the places example. If you have 50 places returned and need 4 extra pieces of data, you could
iterate through the 50, map which items expect what pieces of data, request all unique pieces of data,
and only end up with <code class="calibre15">1 + 4 = 5</code> HTTP requests instead of 251.</p>

<p class="calibre3">The downside is that the API consumer has to stitch all of that data together, which could be a lot of
work for a large dataset.</p>

<h3 id="calibre_link-48" class="calibre2">
<span class="section-number">7.4 </span>Compound Documents (aka Sideloading)</h3>

<p class="calibre3">Instead of just putting the foreign keys into the resource, you can take things a step further and
sideload the data, which is also recommended by JSON-API.</p>

<blockquote class="calibre17">
  <p class="calibre3">Compound documents contain multiple collections to allow for sideloading of related objects.
Side-loading is desirable when nested representation of related objects would result in potentially
expensive repetition. For example, given a list of 50 comments by only 3 authors, a nested representation
would include 50 author objects where a sideloaded representation would contain only 3 author objects.
&ndash; <strong class="calibre22">Source:</strong> <a href="https://canvas.instructure.com/doc/api/file.compound_documents.html">canvas.instructure.com</a></p>
</blockquote>

<p class="calibre3">If we look at a collection of posts following the example from the section titled “Foreign Key Arrays,” an API
might show a response like this:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>   <code class="s">"posts"</code><code class="o">:</code> <code class="calibre15">[{</code>
<code class="lineno"> 3</code>     <code class="s">"id"</code><code class="o">:</code> <code class="s">"1"</code><code class="calibre15">,</code>
<code class="lineno"> 4</code>     <code class="s">"title"</code><code class="o">:</code> <code class="s">"Awesome API Book"</code><code class="calibre15">,</code>
<code class="lineno"> 5</code>     <code class="s">"_links"</code><code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno"> 6</code>       <code class="s">"comments"</code><code class="o">:</code> <code class="calibre15">[</code><code class="s">"1"</code><code class="calibre15">,</code> <code class="s">"2"</code><code class="calibre15">]</code>
<code class="lineno"> 7</code>     <code class="calibre15">},</code> <code class="calibre15">{</code>
<code class="lineno"> 8</code>     <code class="s">"id"</code><code class="o">:</code> <code class="s">"2"</code><code class="calibre15">,</code>
<code class="lineno"> 9</code>     <code class="s">"title"</code><code class="o">:</code> <code class="s">"But Really That API Book"</code><code class="calibre15">,</code>
<code class="lineno">10</code>     <code class="s">"_links"</code><code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno">11</code>       <code class="s">"comments"</code><code class="o">:</code> <code class="calibre15">[</code><code class="s">"3"</code><code class="calibre15">]</code>
<code class="lineno">12</code>     <code class="calibre15">}</code>
<code class="lineno">13</code>   <code class="calibre15">}],</code>
<code class="lineno">14</code>   <code class="s">"_linked"</code><code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno">15</code>     <code class="s">"comments"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno">16</code>       <code class="calibre15">{</code>
<code class="lineno">17</code>         <code class="s">"id"</code><code class="o">:</code> <code class="s">"1"</code>
<code class="lineno">18</code>         <code class="s">"message"</code><code class="o">:</code> <code class="s">"Great book"</code><code class="calibre15">,</code>
<code class="lineno">19</code>         <code class="s">"created_at"</code><code class="o">:</code> <code class="s">"2014-08-23T18:20:03Z"</code>
<code class="lineno">20</code>       <code class="calibre15">},</code>
<code class="lineno">21</code>       <code class="calibre15">{</code>
<code class="lineno">22</code>         <code class="s">"id"</code><code class="o">:</code> <code class="s">"2"</code>
<code class="lineno">23</code>         <code class="s">"message"</code><code class="o">:</code> <code class="s">"I lolled"</code><code class="calibre15">,</code>
<code class="lineno">24</code>         <code class="s">"created_at"</code><code class="o">:</code> <code class="s">"2014-08-24T20:04:01Z"</code>
<code class="lineno">25</code>       <code class="calibre15">},</code>
<code class="lineno">26</code>       <code class="calibre15">{</code>
<code class="lineno">27</code>         <code class="s">"id"</code><code class="o">:</code> <code class="s">"3"</code>
<code class="lineno">28</code>         <code class="s">"message"</code><code class="o">:</code> <code class="s">"Ugh JSON-API..."</code><code class="calibre15">,</code>
<code class="lineno">29</code>         <code class="s">"created_at"</code><code class="o">:</code> <code class="s">"2014-08-29T14:01:13Z"</code>
<code class="lineno">30</code>       <code class="calibre15">}</code>
<code class="lineno">31</code>     <code class="calibre15">]</code>
<code class="lineno">32</code>   <code class="calibre15">}</code>
<code class="lineno">33</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Just like with the foreign key array approach, the client will have to do a lot of stitching
together to map which comment belongs to which post. The data is all there, but getting it into
a format for easy iteration could be a PITA.</p>

<p class="calibre3">That said, it will avoid duplicating the same item multiple times. While a <code class="calibre15">comment</code> would likely
only be on a single post, if you were to include <code class="calibre15">user</code> information, the same user could show up
multiple times as a commenter if they are active, or even as a commenter <em class="calibre19">and</em> a post author.</p>

<h3 id="calibre_link-49" class="calibre2">
<span class="section-number">7.5 </span>Embedded Documents (aka Nesting)</h3>

<p class="calibre3">Instead of flattening the entire response to top level collections and losing the obvious context
of the data, embedding data leaves it in the structure a client would expect.</p>

<p class="calibre3">This approach was used for the last two versions of the API at Kapture, and I used it on a few other
APIs. It offers the most flexibility for the API consumer; it can reduce HTTP requests or reduce
download size depending on what the consumer wants.</p>

<p class="calibre3">An API consumer could call the endpoint with the following query string parameter:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="o">/</code><code class="calibre15">places</code><code class="o">?</code><code class="calibre15">include</code><code class="o">=</code><code class="calibre15">checkins</code><code class="calibre15">,</code><code class="calibre15">merchant</code>
</pre></div>

</figure>

<p class="calibre3">This would alert Fractal (if properly configured) to include the <code class="calibre15">checkins</code> for that <code class="calibre15">place</code>, and the <code class="calibre15">merchant</code> data in the response inside the <code class="calibre15">place</code> resource:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>     <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno"> 3</code>         <code class="calibre15">{</code>
<code class="lineno"> 4</code>             <code class="s">"id"</code><code class="o">:</code> <code class="o">2</code><code class="calibre15">,</code>
<code class="lineno"> 5</code>             <code class="s">"name"</code><code class="o">:</code> <code class="s">"Videology"</code><code class="calibre15">,</code>
<code class="lineno"> 6</code>             <code class="s">"lat"</code><code class="o">:</code> <code class="o">40.713857</code><code class="calibre15">,</code>
<code class="lineno"> 7</code>             <code class="s">"lon"</code><code class="o">:</code> <code class="o">-</code><code class="o">73.961936</code><code class="calibre15">,</code>
<code class="lineno"> 8</code>             <code class="s">"created_at"</code><code class="o">:</code> <code class="s">"2013-04-02"</code><code class="calibre15">,</code>
<code class="lineno"> 9</code>             <code class="s">"checkins"</code> <code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno">10</code>                 <code class="c">// ...</code>
<code class="lineno">11</code>             <code class="calibre15">],</code>
<code class="lineno">12</code>             <code class="s">"merchant"</code> <code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno">13</code>                 <code class="c">// ...</code>
<code class="lineno">14</code>             <code class="calibre15">}</code>
<code class="lineno">15</code>         <code class="calibre15">},</code>
<code class="lineno">16</code>         <code class="calibre15">{</code>
<code class="lineno">17</code>             <code class="s">"id"</code><code class="o">:</code> <code class="o">1</code><code class="calibre15">,</code>
<code class="lineno">18</code>             <code class="s">"name"</code><code class="o">:</code> <code class="s">"Barcade"</code><code class="calibre15">,</code>
<code class="lineno">19</code>             <code class="s">"lat"</code><code class="o">:</code> <code class="o">40.712017</code><code class="calibre15">,</code>
<code class="lineno">20</code>             <code class="s">"lon"</code><code class="o">:</code> <code class="o">-</code><code class="o">73.950995</code><code class="calibre15">,</code>
<code class="lineno">21</code>             <code class="s">"created_at"</code><code class="o">:</code> <code class="s">"2012-09-23"</code><code class="calibre15">,</code>
<code class="lineno">22</code>             <code class="s">"checkins"</code> <code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno">23</code>                 <code class="c">// ...</code>
<code class="lineno">24</code>             <code class="calibre15">],</code>
<code class="lineno">25</code>             <code class="s">"merchant"</code> <code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno">26</code>                 <code class="c">// ...</code>
<code class="lineno">27</code>             <code class="calibre15">}</code>
<code class="lineno">28</code>         <code class="calibre15">}</code>
<code class="lineno">29</code>     <code class="calibre15">]</code>
<code class="lineno">30</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Some systems (like Facebook, or any API using Fractal) will let you nest those embeds with dot notation:</p>

<p class="calibre3"><strong class="calibre22">E.g:</strong> <code class="calibre15">/places?include=checkins,merchant,current_opp.images</code></p>

<h4 id="calibre_link-136" class="calibre4">Embedding with Fractal</h4>

<p class="calibre3">Picking back up from chapter 6, your transformer at this point is mainly just giving you a method to
handle array conversion from your data source to a simple array. Fractal can, however, include resources
and collections too. Continuing the theme of users, places, and check-ins, the <code class="calibre15">UserTransformer</code> might
have a check-ins list to see a users check-in history.</p>

<figure class="code">
  <figcaption class="calibre20">UserTransformer using Fractal</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">&lt;?</code><code class="calibre15">php</code> <code class="k">namespace</code> <code class="calibre15">App\Transformer</code><code class="calibre15">;</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="k">use</code> <code class="calibre15">User</code><code class="calibre15">;</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code> <code class="k">use</code> <code class="calibre15">League\Fractal\TransformerAbstract</code><code class="calibre15">;</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> <code class="k">class</code> <code class="nc">UserTransformer</code> <code class="k">extends</code> <code class="calibre15">TransformerAbstract</code>
<code class="lineno"> 8</code> <code class="calibre15">{</code>
<code class="lineno"> 9</code>     <code class="k">protected</code> <code class="nv">$availableEmbeds</code> <code class="o">=</code> <code class="calibre15">[</code>
<code class="lineno">10</code>         <code class="s">'checkins'</code>
<code class="lineno">11</code>     <code class="calibre15">];</code>
<code class="lineno">12</code> 
<code class="lineno">13</code>     <code class="sd">/**</code>
<code class="lineno">14</code> <code class="sd">     * Turn this item object into a generic array</code>
<code class="lineno">15</code> <code class="sd">     *</code>
<code class="lineno">16</code> <code class="sd">     * @return array</code>
<code class="lineno">17</code> <code class="sd">     */</code>
<code class="lineno">18</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">transform</code><code class="calibre15">(</code><code class="calibre15">User</code> <code class="nv">$user</code><code class="calibre15">)</code>
<code class="lineno">19</code>     <code class="calibre15">{</code>
<code class="lineno">20</code>         <code class="k">return</code> <code class="calibre15">[</code>
<code class="lineno">21</code>             <code class="s">'id'</code>             <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">int</code><code class="calibre15">)</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">id</code><code class="calibre15">,</code>
<code class="lineno">22</code>             <code class="s">'name'</code>           <code class="o">=&gt;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">name</code><code class="calibre15">,</code>
<code class="lineno">23</code>             <code class="s">'bio'</code>            <code class="o">=&gt;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">bio</code><code class="calibre15">,</code>
<code class="lineno">24</code>             <code class="s">'gender'</code>         <code class="o">=&gt;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">gender</code><code class="calibre15">,</code>
<code class="lineno">25</code>             <code class="s">'location'</code>       <code class="o">=&gt;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">location</code><code class="calibre15">,</code>
<code class="lineno">26</code>             <code class="s">'birthday'</code>       <code class="o">=&gt;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">birthday</code><code class="calibre15">,</code>
<code class="lineno">27</code>             <code class="s">'joined'</code>         <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">string</code><code class="calibre15">)</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">created_at</code><code class="calibre15">,</code>
<code class="lineno">28</code>         <code class="calibre15">];</code>
<code class="lineno">29</code>     <code class="calibre15">}</code>
<code class="lineno">30</code> 
<code class="lineno">31</code>     <code class="sd">/**</code>
<code class="lineno">32</code> <code class="sd">     * Embed Checkins</code>
<code class="lineno">33</code> <code class="sd">     *</code>
<code class="lineno">34</code> <code class="sd">     * @return League\Fractal\Resource\Collection</code>
<code class="lineno">35</code> <code class="sd">     */</code>
<code class="lineno">36</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">embedCheckins</code><code class="calibre15">(</code><code class="calibre15">User</code> <code class="nv">$user</code><code class="calibre15">)</code>
<code class="lineno">37</code>     <code class="calibre15">{</code>
<code class="lineno">38</code>         <code class="nv">$checkins</code> <code class="o">=</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">checkins</code><code class="calibre15">;</code>
<code class="lineno">39</code> 
<code class="lineno">40</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">collection</code><code class="calibre15">(</code><code class="nv">$checkins</code><code class="calibre15">,</code> <code class="k">new</code> <code class="calibre15">CheckinTransformer</code><code class="calibre15">);</code>
<code class="lineno">41</code>     <code class="calibre15">}</code>
<code class="lineno">42</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">The <code class="calibre15">CheckinTransformer</code> can then accept a <code class="calibre15">user</code> and a <code class="calibre15">place</code>. There is no benefit to requesting the user in this
context, because we know that already, but asking for the place would return information about the location that is
being checked into.</p>

<figure class="code">
  <figcaption class="calibre20">CheckinTransformer using Fractal</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">&lt;?</code><code class="calibre15">php</code> <code class="k">namespace</code> <code class="calibre15">App\Transformer</code><code class="calibre15">;</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="k">use</code> <code class="calibre15">Checkin</code><code class="calibre15">;</code>
<code class="lineno"> 4</code> <code class="k">use</code> <code class="calibre15">League\Fractal\TransformerAbstract</code><code class="calibre15">;</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code> <code class="k">class</code> <code class="nc">CheckinTransformer</code> <code class="k">extends</code> <code class="calibre15">TransformerAbstract</code>
<code class="lineno"> 7</code> <code class="calibre15">{</code>
<code class="lineno"> 8</code>     <code class="sd">/**</code>
<code class="lineno"> 9</code> <code class="sd">     * List of resources possible to embed via this processor</code>
<code class="lineno">10</code> <code class="sd">     *</code>
<code class="lineno">11</code> <code class="sd">     * @var array</code>
<code class="lineno">12</code> <code class="sd">     */</code>
<code class="lineno">13</code>     <code class="k">protected</code> <code class="nv">$availableEmbeds</code> <code class="o">=</code> <code class="calibre15">[</code>
<code class="lineno">14</code>         <code class="s">'place'</code><code class="calibre15">,</code>
<code class="lineno">15</code>         <code class="s">'user'</code><code class="calibre15">,</code>
<code class="lineno">16</code>     <code class="calibre15">];</code>
<code class="lineno">17</code> 
<code class="lineno">18</code>     <code class="sd">/**</code>
<code class="lineno">19</code> <code class="sd">     * Turn this item object into a generic array</code>
<code class="lineno">20</code> <code class="sd">     *</code>
<code class="lineno">21</code> <code class="sd">     * @return array</code>
<code class="lineno">22</code> <code class="sd">     */</code>
<code class="lineno">23</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">transform</code><code class="calibre15">(</code><code class="calibre15">Checkin</code> <code class="nv">$checkin</code><code class="calibre15">)</code>
<code class="lineno">24</code>     <code class="calibre15">{</code>
<code class="lineno">25</code>         <code class="k">return</code> <code class="calibre15">[</code>
<code class="lineno">26</code>             <code class="s">'id'</code>          <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">int</code><code class="calibre15">)</code> <code class="nv">$checkin</code><code class="o">-&gt;</code><code class="na">id</code><code class="calibre15">,</code>
<code class="lineno">27</code>             <code class="s">'created_at'</code>  <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">string</code><code class="calibre15">)</code> <code class="nv">$checkin</code><code class="o">-&gt;</code><code class="na">created_at</code><code class="calibre15">,</code>
<code class="lineno">28</code>         <code class="calibre15">];</code>
<code class="lineno">29</code>     <code class="calibre15">}</code>
<code class="lineno">30</code> 
<code class="lineno">31</code>     <code class="sd">/**</code>
<code class="lineno">32</code> <code class="sd">     * Embed Place</code>
<code class="lineno">33</code> <code class="sd">     *</code>
<code class="lineno">34</code> <code class="sd">     * @return League\Fractal\Resource\Item</code>
<code class="lineno">35</code> <code class="sd">     */</code>
<code class="lineno">36</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">embedPlace</code><code class="calibre15">(</code><code class="calibre15">Checkin</code> <code class="nv">$checkin</code><code class="calibre15">)</code>
<code class="lineno">37</code>     <code class="calibre15">{</code>
<code class="lineno">38</code>         <code class="nv">$place</code> <code class="o">=</code> <code class="nv">$checkin</code><code class="o">-&gt;</code><code class="na">place</code><code class="calibre15">;</code>
<code class="lineno">39</code> 
<code class="lineno">40</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">item</code><code class="calibre15">(</code><code class="nv">$place</code><code class="calibre15">,</code> <code class="k">new</code> <code class="calibre15">PlaceTransformer</code><code class="calibre15">);</code>
<code class="lineno">41</code>     <code class="calibre15">}</code>
<code class="lineno">42</code> 
<code class="lineno">43</code>     <code class="sd">/**</code>
<code class="lineno">44</code> <code class="sd">     * Embed User</code>
<code class="lineno">45</code> <code class="sd">     *</code>
<code class="lineno">46</code> <code class="sd">     * @return League\Fractal\Resource\Item</code>
<code class="lineno">47</code> <code class="sd">     */</code>
<code class="lineno">48</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">embedUser</code><code class="calibre15">(</code><code class="calibre15">Checkin</code> <code class="nv">$checkin</code><code class="calibre15">)</code>
<code class="lineno">49</code>     <code class="calibre15">{</code>
<code class="lineno">50</code>         <code class="nv">$user</code> <code class="o">=</code> <code class="nv">$checkin</code><code class="o">-&gt;</code><code class="na">user</code><code class="calibre15">;</code>
<code class="lineno">51</code> 
<code class="lineno">52</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">item</code><code class="calibre15">(</code><code class="nv">$user</code><code class="calibre15">,</code> <code class="k">new</code> <code class="calibre15">UserTransformer</code><code class="calibre15">);</code>
<code class="lineno">53</code>     <code class="calibre15">}</code>
<code class="lineno">54</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">These examples happen to be using the lazy loading functionality of an ORM for <code class="calibre15">$user-&gt;checkins</code> and <code class="calibre15">$checkin-&gt;place</code>, but
there is no reason that eager loading could not also be used by inspecting the <code class="calibre15">$_GET['include']</code> list
of requested scopes. Something like this can easily go in your controller constructor somewhere in the
base controller, or <em class="calibre19">something</em>:</p>

<figure class="code">
  <figcaption class="calibre20">Example of user input dictating which Eloquent ORM (Laravel) relationships to eager load</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="nv">$requestedEmbeds</code> <code class="o">=</code> <code class="calibre15">Input</code><code class="o">::</code><code class="na">get</code><code class="calibre15">(</code><code class="s">'include'</code><code class="calibre15">);</code> <code class="c">// ['checkins', 'place'] or just ['place']</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="c">// Left is relationship names. Right is include names.</code>
<code class="lineno"> 4</code> <code class="c">// Avoids exposing relationships and whatever not directly set</code>
<code class="lineno"> 5</code> <code class="nv">$possibleRelationships</code> <code class="o">=</code> <code class="calibre15">[</code>
<code class="lineno"> 6</code>     <code class="s">'checkins'</code> <code class="o">=&gt;</code> <code class="s">'checkins'</code><code class="calibre15">,</code>
<code class="lineno"> 7</code>     <code class="s">'venue'</code> <code class="o">=&gt;</code> <code class="s">'place'</code><code class="calibre15">,</code>
<code class="lineno"> 8</code> <code class="calibre15">];</code>
<code class="lineno"> 9</code> 
<code class="lineno">10</code> <code class="c">// Check for potential ORM relationships, and convert from generic "include" names</code>
<code class="lineno">11</code> <code class="nv">$eagerLoad</code> <code class="o">=</code> <code class="nb">array_keys</code><code class="calibre15">(</code><code class="nb">array_intersect</code><code class="calibre15">(</code><code class="nv">$possibleRelationships</code><code class="calibre15">,</code> <code class="nv">$requestedEmbeds</code><code class="calibre15">));</code>
<code class="lineno">12</code> 
<code class="lineno">13</code> <code class="nv">$books</code> <code class="o">=</code> <code class="calibre15">Book</code><code class="o">::</code><code class="na">with</code><code class="calibre15">(</code><code class="nv">$eagerLoad</code><code class="calibre15">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="calibre15">();</code>
<code class="lineno">14</code> 
<code class="lineno">15</code> <code class="c">// do the usual fractal stuff</code>
</pre></div>

</figure>

<p class="calibre3">Having the following code somewhere in the <code class="calibre15">ApiController</code>, or in your bootstrap, will make this all work:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="k">class</code> <code class="calibre15">ApiController</code>
<code class="lineno"> 2</code> <code class="calibre15">{</code>
<code class="lineno"> 3</code>     <code class="c">// ...</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code>     <code class="k">public</code> <code class="k">function</code> <code class="calibre15">__construct</code><code class="calibre15">(</code><code class="calibre15">Manager</code> <code class="calibre15">$fractal</code><code class="calibre15">)</code>
<code class="lineno"> 6</code>     <code class="calibre15">{</code>
<code class="lineno"> 7</code>         <code class="calibre15">$this</code><code class="o">-&gt;</code><code class="calibre15">fractal</code> <code class="o">=</code> <code class="calibre15">$fractal</code><code class="calibre15">;</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>         <code class="c">// Are we going to try and include data?</code>
<code class="lineno">10</code>         <code class="k">if</code> <code class="calibre15">(</code><code class="calibre15">Input</code><code class="o">::</code><code class="calibre15">get</code><code class="calibre15">(</code><code class="s">'include'</code><code class="calibre15">))</code> <code class="calibre15">{</code>
<code class="lineno">11</code>           <code class="calibre15">$this</code><code class="o">-&gt;</code><code class="calibre15">fractal</code><code class="o">-&gt;</code><code class="calibre15">parseIncludes</code><code class="calibre15">(</code><code class="calibre15">Input</code><code class="o">::</code><code class="calibre15">get</code><code class="calibre15">(</code><code class="s">'include'</code><code class="calibre15">));</code>
<code class="lineno">12</code>         <code class="calibre15">}</code>
<code class="lineno">13</code>     <code class="calibre15">}</code>
<code class="lineno">14</code> 
<code class="lineno">15</code>     <code class="c">// ...</code>
<code class="lineno">16</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">That is how you would do things in Laravel at least.</p>

<h4 id="calibre_link-137" class="calibre4">Embedding with Rails</h4>

<p class="calibre3">The Rails lot are big fans of their ActiveRecord package, and most suggest using it to embed data. The
specific part is in the <a href="http://apidock.com/rails/ActiveRecord/Serialization/to_json">Serializaton::to_json Documentation</a>.</p>

<p class="calibre3">To include associations, use <code class="calibre15">blog.to_json(:include =&gt; :posts)</code>.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>   <code class="s">"id"</code><code class="o">:</code> <code class="o">1</code><code class="calibre15">,</code> <code class="s">"name"</code><code class="o">:</code> <code class="s">"Konata Izumi"</code><code class="calibre15">,</code> <code class="s">"age"</code><code class="o">:</code> <code class="o">16</code><code class="calibre15">,</code>
<code class="lineno"> 3</code>   <code class="s">"created_at"</code><code class="o">:</code> <code class="s">"2006/08/01"</code><code class="calibre15">,</code> <code class="s">"awesome"</code><code class="o">:</code> <code class="nb">true</code><code class="calibre15">,</code>
<code class="lineno"> 4</code>   <code class="s">"posts"</code><code class="o">:</code> <code class="calibre15">[{</code>
<code class="lineno"> 5</code>     <code class="s">"id"</code><code class="o">:</code> <code class="o">1</code><code class="calibre15">,</code>
<code class="lineno"> 6</code>     <code class="s">"author_id"</code><code class="o">:</code> <code class="o">1</code><code class="calibre15">,</code>
<code class="lineno"> 7</code>     <code class="s">"title"</code><code class="o">:</code> <code class="s">"Welcome to the weblog"</code>
<code class="lineno"> 8</code>   <code class="calibre15">},</code> <code class="calibre15">{</code>
<code class="lineno"> 9</code>     <code class="s">"id"</code><code class="o">:</code> <code class="o">2</code><code class="calibre15">,</code>
<code class="lineno">10</code>     <code class="nl">author_id:</code> <code class="o">1</code><code class="calibre15">,</code>
<code class="lineno">11</code>     <code class="s">"title"</code><code class="o">:</code> <code class="s">"So I was thinking"</code>
<code class="lineno">12</code>   <code class="calibre15">}]</code>
<code class="lineno">13</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Second level and higher order associations work as well:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">blog</code><code class="calibre15">.</code><code class="calibre15">to_json</code><code class="calibre15">(</code><code class="o">:</code><code class="calibre15">include</code> <code class="o">=&gt;</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>   <code class="o">:</code><code class="calibre15">posts</code> <code class="o">=&gt;</code> <code class="calibre15">{</code>
<code class="lineno"> 3</code>     <code class="o">:</code><code class="calibre15">include</code> <code class="o">=&gt;</code> <code class="calibre15">{</code>
<code class="lineno"> 4</code>       <code class="o">:</code><code class="calibre15">comments</code> <code class="o">=&gt;</code> <code class="calibre15">{</code>
<code class="lineno"> 5</code>         <code class="o">:</code><code class="calibre15">only</code> <code class="o">=&gt;</code> <code class="o">:</code><code class="calibre15">body</code>
<code class="lineno"> 6</code>       <code class="calibre15">}</code>
<code class="lineno"> 7</code>     <code class="calibre15">},</code>
<code class="lineno"> 8</code>     <code class="o">:</code><code class="calibre15">only</code> <code class="o">=&gt;</code> <code class="o">:</code><code class="calibre15">title</code>
<code class="lineno"> 9</code>   <code class="calibre15">}</code>
<code class="lineno">10</code> <code class="calibre15">})</code>
</pre></div>

</figure>

<p class="calibre3">A little more complicated, but you get more control over what is returned:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>   <code class="s">"id"</code><code class="o">:</code> <code class="o">1</code><code class="calibre15">,</code>
<code class="lineno"> 3</code>   <code class="s">"name"</code><code class="o">:</code> <code class="s">"Konata Izumi"</code><code class="calibre15">,</code>
<code class="lineno"> 4</code>   <code class="s">"age"</code><code class="o">:</code> <code class="o">16</code><code class="calibre15">,</code>
<code class="lineno"> 5</code>   <code class="s">"created_at"</code><code class="o">:</code> <code class="s">"2006/08/01"</code><code class="calibre15">,</code>
<code class="lineno"> 6</code>   <code class="s">"awesome"</code><code class="o">:</code> <code class="nb">true</code><code class="calibre15">,</code>
<code class="lineno"> 7</code>   <code class="s">"posts"</code><code class="o">:</code> <code class="calibre15">[{</code>
<code class="lineno"> 8</code>     <code class="s">"comments"</code><code class="o">:</code> <code class="calibre15">[{</code>
<code class="lineno"> 9</code>       <code class="s">"body"</code><code class="o">:</code> <code class="s">"1st post!"</code>
<code class="lineno">10</code>     <code class="calibre15">},</code> <code class="calibre15">{</code>
<code class="lineno">11</code>       <code class="s">"body"</code><code class="o">:</code> <code class="s">"Second!"</code>
<code class="lineno">12</code>     <code class="calibre15">}],</code>
<code class="lineno">13</code>     <code class="s">"title"</code><code class="o">:</code> <code class="s">"Welcome to the weblog"</code>
<code class="lineno">14</code>   <code class="calibre15">},</code>
<code class="lineno">15</code>   <code class="calibre15">{</code>
<code class="lineno">16</code>     <code class="s">"comments"</code><code class="o">:</code> <code class="calibre15">[{</code>
<code class="lineno">17</code>       <code class="s">"body"</code><code class="o">:</code> <code class="s">"Don't think too hard"</code>
<code class="lineno">18</code>     <code class="calibre15">}],</code>
<code class="lineno">19</code>     <code class="s">"title"</code><code class="o">:</code> <code class="s">"So I was thinking"</code>
<code class="lineno">20</code>   <code class="calibre15">}]</code>
<code class="lineno">21</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">This will work well, assuming everything is represented as ActiveRecord, which who knows, it might be.</p>

<h3 id="calibre_link-50" class="calibre2">
<span class="section-number">7.6 </span>Summary</h3>

<p class="calibre3">The most important thing here is that an API has <em class="calibre19">some</em> way to include related data. Regardless of whether
sideloading or embedding is the approach used, it is important to pick one.</p>

<p class="calibre3">One area that may affect your decision is using a JavaScript framework like EmberJS. In theory, an
API should not concern itself with implementation specific details such as which JavaScript framework
is being used, but if that EmberJS platform is a requirement of the business, then picking a
compatible data structure known to work with it might be key.</p>

<p class="calibre3">At the time of writing, EmberJS (or more specifically EmberData) requires a specific sideloading approach,
which might cause a headache for other consumers of your API. This is changing over time as EmberJS leans
more towards JSON-API, but until JSON-API settles on v1.0 final they cannot be expected to maintain
perfect support for the adapter.</p>

<p class="calibre3">Fractal will make your decision less important since using <a href="http://fractal.thephpleague.com/serializers/">Serializers</a> allows you to switch between the
two types rather easily. Later on in the book, we will talk about looking at MIME types and responding
with different data, so it would not be difficult to use different headers for different data
structures i.e., one custom output maybe using the embedded approach, and one JSON-API with sideloaded
data.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-103">
<div class="calibre6">
<h2 id="calibre_link-51" class="calibre1">
<span class="section-number">8. </span>Debugging</h2>

<h3 id="calibre_link-52" class="calibre2">
<span class="section-number">8.1 </span>Introduction</h3>

<p class="calibre3">Debugging is the art of working out why something is broken, which can be pretty difficult in an API. In much of web development, you are simply looking at what is output to the page, overusing <code class="calibre15">var_dump()</code>, or checking the browsers console for JavaScript errors.</p>

<p class="calibre3">Working with an API, you are mostly just working with requests and responses, but you need to initiate these requests in a repeatable way, often with full control over all of the HTTP headers, body content, etc.</p>

<p class="calibre3">There are a few methods you can utilize for debugging:</p>

<ul class="calibre18">
  <li class="calibre14">Command-line debugging</li>
  <li class="calibre14">Browser debugging</li>
  <li class="calibre14">Network debugging</li>
</ul>

<h3 id="calibre_link-53" class="calibre2">
<span class="section-number">8.2 </span>Command-line Debugging</h3>

<p class="calibre3">Debugging via the command-line by using tools like <code class="calibre15">curl</code> is a great option for some. They tout the benefits of being able to do it from inside a network firewall. Certainly this can be an option for debugging live servers, but for development purposes (which is what we are doing here), using <code class="calibre15">curl</code> is just a lot of commands to remember for no reason.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code>curl -X POST http://localhost/places/fg345d/checkins --data @payload.json
</pre></div>

</figure>

<p class="calibre3">It is not the most complicated way to initiate a request, but it is not the easiest. You will need to update that <code class="calibre15">payload.json</code> every time, or have a bunch of JSON in the CLI, and that can be really messy with multi-line payloads.</p>

<p class="calibre3">The CLI is a pain in the backside when you have a lot of endpoints with lots of potential values. Please, if you take yourself, your API, or your job as a developer seriously, do not do this.</p>

<h3 id="calibre_link-54" class="calibre2">
<span class="section-number">8.3 </span>Browser Debugging</h3>

<p class="calibre3">Working in the browser is a great way to do things, and developers are fairly used to it. Sadly, most browsers can only really handle <code class="calibre15">GET</code> and <code class="calibre15">POST</code> requests by default, and a RESTful API requires <code class="calibre15">PUT</code>, <code class="calibre15">DELETE</code>, <code class="calibre15">PATCH</code>, etc., too. A well built RESTful API will also require the use of HTTP headers, which can be difficult to manipulate in a browser, as they are built to handle all of that for you.</p>

<h4 id="calibre_link-138" class="calibre4">HTTP Clients</h4>

<p class="calibre3">Called a “HTTP client” or “REST client” interchangeably, these bits of software help perfectly with the job this book sets out to achieve: building nontrivial APIs. They allow you to format your HTTP request through a convenient GUI, choosing the HTTP verb, adding headers, entering a body, etc., then present the HTTP response to you with formatting or in source view if you prefer. Many of these GUIs will let you save common requests or build “collections” much like a set of bookmarks, but for your endpoints, and with all the correct headers and values.</p>

<p class="calibre3">These clients exist for Windows, OS X and Linux, but one that has really stood out to me is the Chrome extension called
<a href="http://getpostman.com/">Postman</a>.</p>


<figure class="image">
  <img src="images/000010.png" alt="Postman HTTP Client, showing a collection and a successful JSON response" class="calibre30" />
  <figcaption class="calibre31">Postman HTTP Client, showing a collection and a successful JSON response</figcaption>
</figure>


<p class="calibre3">I have a collection, which almost mirrors my Behat tests, and have at least one for each endpoint, some with more.</p>

<p class="calibre3">Using Postman, I can develop “in the browser”, see errors easily, keep changing things and click “send” for as long as I have to to make it work. When I expect it to work, I run the Behat scenario that covers the endpoint, and see if the tests are green. If Behat fails and the errors are not enough to resolve the problem, I then simply go back to Postman and try again.</p>

<p class="calibre3">Repeat until the endpoint “works” and passes the test.</p>

<h4 id="calibre_link-139" class="calibre4">Debug Panel</h4>

<p class="calibre3">The approach above works fine if the problem is one that you can see. Anything to do with a slow page return, silent fails, unexpected results, etc., needs more information, and to do that you probably need another extension.</p>

<ul class="calibre18">
  <li class="calibre14">
<strong class="calibre22"><a href="https://github.com/dejan/rails_panel">RailsPanel</a></strong> - Chrome-only DevTool panel with logging and profiling for Ruby on Rails (<a href="http://railscasts.com/episodes/402-better-errors-railspanel?view=asciicast">RailsCasts Video</a>)</li>
  <li class="calibre14">
<strong class="calibre22"><a href="https://github.com/itsgoingd/clockwork-chrome">Clockwork</a></strong> - Chrome DevTool panel and standalone web app with logging and profiling for PHP</li>
  <li class="calibre14">
<strong class="calibre22"><a href="http://craig.is/writing/chrome-logger">Chrome Logger</a></strong> - Chrome Logger only for Python, PHP, Ruby, Node, .NET, CF and Go</li>
</ul>

<p class="calibre3">The first two are very similar and are the most feature filled, but the latter covers basic logging for a wider selection of languages.</p>

<p class="calibre3">Sure these examples are mostly Chrome, there are probably alternatives, but either way there is no harm in having Chrome as your development browser and continue to use your favourite for general browsing.</p>


<figure class="image">
  <img src="images/000016.png" alt="Clockwork showing the Laravel timeline in Chromium Browser" class="calibre30" />
  <figcaption class="calibre31">Clockwork showing the Laravel timeline in Chromium Browser</figcaption>
</figure>


<p class="calibre3">This timeline can be useful for working out where things are slowing down. Define your own events to see where the time is going.</p>

<p class="calibre3">Seeing logs in this panel is another benefit, and it helps keep you from switching back to the console all the time to catch the output of your logs via <code class="calibre15">tail -f</code>. Certainly you should be in the command line anyway, but constantly hitting <code class="calibre15">Alt+Tab</code> can cause distractions which slow you down.</p>

<p class="calibre3">For those of you who normally debug with <code class="calibre15">var_dump()</code> or breakpoints, you could simply use Clockwork/RailsPanel/Chrome Logger to do it and see it in the panel, leaving your output untouched and avoiding tricky setup with IDE or other GUI programs.</p>

<figure class="code">
  <figcaption class="calibre20">CheckinTransformer using Fractal, with added Logging</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">&lt;?</code><code class="calibre15">php</code> <code class="k">namespace</code> <code class="calibre15">App\Transformer</code><code class="calibre15">;</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="k">use</code> <code class="calibre15">Checkin</code><code class="calibre15">;</code>
<code class="lineno"> 4</code> <code class="k">use</code> <code class="calibre15">Log</code><code class="calibre15">;</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code> <code class="k">use</code> <code class="calibre15">League\Fractal\TransformerAbstract</code><code class="calibre15">;</code>
<code class="lineno"> 7</code> 
<code class="lineno"> 8</code> <code class="k">class</code> <code class="nc">CheckinTransformer</code> <code class="k">extends</code> <code class="calibre15">TransformerAbstract</code>
<code class="lineno"> 9</code> <code class="calibre15">{</code>
<code class="lineno">10</code>     <code class="sd">/**</code>
<code class="lineno">11</code> <code class="sd">     * List of resources possible to embed via this processor</code>
<code class="lineno">12</code> <code class="sd">     *</code>
<code class="lineno">13</code> <code class="sd">     * @var array</code>
<code class="lineno">14</code> <code class="sd">     */</code>
<code class="lineno">15</code>     <code class="k">protected</code> <code class="nv">$availableEmbeds</code> <code class="o">=</code> <code class="calibre15">[</code>
<code class="lineno">16</code>         <code class="s">'place'</code><code class="calibre15">,</code>
<code class="lineno">17</code>         <code class="s">'user'</code><code class="calibre15">,</code>
<code class="lineno">18</code>     <code class="calibre15">];</code>
<code class="lineno">19</code> 
<code class="lineno">20</code>     <code class="sd">/**</code>
<code class="lineno">21</code> <code class="sd">     * Turn this item object into a generic array</code>
<code class="lineno">22</code> <code class="sd">     *</code>
<code class="lineno">23</code> <code class="sd">     * @return array</code>
<code class="lineno">24</code> <code class="sd">     */</code>
<code class="lineno">25</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">transform</code><code class="calibre15">(</code><code class="calibre15">Checkin</code> <code class="nv">$checkin</code><code class="calibre15">)</code>
<code class="lineno">26</code>     <code class="calibre15">{</code>
<code class="lineno">27</code>         <code class="k">return</code> <code class="calibre15">[</code>
<code class="lineno">28</code>             <code class="s">'id'</code>          <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">int</code><code class="calibre15">)</code> <code class="nv">$checkin</code><code class="o">-&gt;</code><code class="na">id</code><code class="calibre15">,</code>
<code class="lineno">29</code>             <code class="s">'created_at'</code>  <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">string</code><code class="calibre15">)</code> <code class="nv">$checkin</code><code class="o">-&gt;</code><code class="na">created_at</code><code class="calibre15">,</code>
<code class="lineno">30</code>         <code class="calibre15">];</code>
<code class="lineno">31</code>     <code class="calibre15">}</code>
<code class="lineno">32</code> 
<code class="lineno">33</code>     <code class="sd">/**</code>
<code class="lineno">34</code> <code class="sd">     * Embed Place</code>
<code class="lineno">35</code> <code class="sd">     *</code>
<code class="lineno">36</code> <code class="sd">     * @return League\Fractal\Resource\Item</code>
<code class="lineno">37</code> <code class="sd">     */</code>
<code class="lineno">38</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">embedPlace</code><code class="calibre15">(</code><code class="calibre15">Checkin</code> <code class="nv">$checkin</code><code class="calibre15">)</code>
<code class="lineno">39</code>     <code class="calibre15">{</code>
<code class="lineno">40</code>         <code class="nv">$place</code> <code class="o">=</code> <code class="nv">$checkin</code><code class="o">-&gt;</code><code class="na">place</code><code class="calibre15">;</code>
<code class="lineno">41</code> 
<code class="lineno">42</code>         <code class="calibre15">Log</code><code class="o">::</code><code class="na">info</code><code class="calibre15">(</code><code class="s">"Embedding place-</code><code class="si">{</code><code class="nv">$place</code><code class="o">-&gt;</code><code class="na">id</code><code class="si">}</code><code class="s"> into checkin-</code><code class="si">{</code><code class="nv">$checkin</code><code class="o">-&gt;</code><code class="na">id</code><code class="si">}</code><code class="s">"</code><code class="calibre15">);</code>
<code class="lineno">43</code> 
<code class="lineno">44</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">item</code><code class="calibre15">(</code><code class="nv">$place</code><code class="calibre15">,</code> <code class="k">new</code> <code class="calibre15">PlaceTransformer</code><code class="calibre15">);</code>
<code class="lineno">45</code>     <code class="calibre15">}</code>
<code class="lineno">46</code> 
<code class="lineno">47</code>     <code class="sd">/**</code>
<code class="lineno">48</code> <code class="sd">     * Embed User</code>
<code class="lineno">49</code> <code class="sd">     *</code>
<code class="lineno">50</code> <code class="sd">     * @return League\Fractal\Resource\Item</code>
<code class="lineno">51</code> <code class="sd">     */</code>
<code class="lineno">52</code>     <code class="k">public</code> <code class="k">function</code> <code class="nf">embedUser</code><code class="calibre15">(</code><code class="calibre15">Checkin</code> <code class="nv">$checkin</code><code class="calibre15">)</code>
<code class="lineno">53</code>     <code class="calibre15">{</code>
<code class="lineno">54</code>         <code class="nv">$user</code> <code class="o">=</code> <code class="nv">$checkin</code><code class="o">-&gt;</code><code class="na">user</code><code class="calibre15">;</code>
<code class="lineno">55</code> 
<code class="lineno">56</code>         <code class="calibre15">Log</code><code class="o">::</code><code class="na">info</code><code class="calibre15">(</code><code class="s">"Embedding user-</code><code class="si">{</code><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">id</code><code class="si">}</code><code class="s"> into checkin-</code><code class="si">{</code><code class="nv">$checkin</code><code class="o">-&gt;</code><code class="na">id</code><code class="si">}</code><code class="s">"</code><code class="calibre15">);</code>
<code class="lineno">57</code> 
<code class="lineno">58</code>         <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">item</code><code class="calibre15">(</code><code class="nv">$user</code><code class="calibre15">,</code> <code class="k">new</code> <code class="calibre15">UserTransformer</code><code class="calibre15">);</code>
<code class="lineno">59</code>     <code class="calibre15">}</code>
<code class="lineno">60</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">That will look a little something like this:</p>


<figure class="image">
  <img src="images/000002.png" alt="Clockwork showing the Log in Chromium Browser" class="calibre30" />
  <figcaption class="calibre31">Clockwork showing the Log in Chromium Browser</figcaption>
</figure>


<p class="calibre3">You can log arrays and objects too:</p>


<figure class="image">
  <img src="images/000011.png" alt="Clockwork showing the Log in Chromium Browser" class="calibre30" />
  <figcaption class="calibre31">Clockwork showing the Log in Chromium Browser</figcaption>
</figure>


<p class="calibre3">If logging something cannot help you with a problem, you need to log more things. Eventually you will work it out.</p>

<h3 id="calibre_link-55" class="calibre2">
<span class="section-number">8.4 </span>Network Debugging</h3>

<p class="calibre3">The previously mentioned approaches to debugging are very much about being in control: create a request and see what happens with the response. Sometimes you need to debug what is happening to your API when the requests are not completely in control. If your iPhone developer comes over and says “the API is broken”, it can be hard to work out why.</p>

<p class="calibre3">If you know exactly what endpoint is being hit and what the error is (because the iPhone dev is pointing to some debug data on his XCode screen), then maybe you can fix it, but often you will need more insight before you can recreate a bug. Maybe it is not even a request you can recreate easily (or at all), like anything to do with upload images as a <code class="calibre15">PUT</code> after getting them from the camera, or multiple requests that the iPhone app is executing in order using data from the previous requests.</p>

<p class="calibre3">Whatever the reason, sometimes you need to debug network activity to find out what is <em class="calibre19">actually</em> happening by spying on the request and getting the response.</p>

<h4 id="calibre_link-140" class="calibre4">Charles</h4>

<p class="calibre3">If these are non-production errors that you want to debug against your local API and development iOS devices (aka the old iPhone you have not sold on eBay yet), then a great application is <a href="http://www.charlesproxy.com/">Charles</a>.</p>

<p class="calibre3">Charles essentially acts as an HTTP proxy, which means stuff comes in, stuff goes out, and Charles can show you what that was. Beyond that, it can rewrite headers and even let you modify the content of the request or response if you want.</p>

<p class="calibre3">To set the basics of this up, you first need to know the internal network of your machine.</p>


<figure class="image">
  <img src="images/000018.png" alt="Network Settings on Mac OS X, showing local IP" class="calibre30" />
  <figcaption class="calibre31">Network Settings on Mac OS X, showing local IP</figcaption>
</figure>


<p class="calibre3">On your mobile device you will need to enable an HTTP Proxy. Enter your computer’s local IP in the Proxy Server Address field, and select port 8888 - the default Charles port.</p>


<figure class="image">
  <img src="images/000004.png" alt="Sample Charles HTTP Proxy settings on iOS7" class="calibre30" />
  <figcaption class="calibre31">Sample Charles HTTP Proxy settings on iOS7</figcaption>
</figure>


<p class="calibre3">This will forward all web traffic to Charles, which (if it is running) will forward it on to its location.</p>

<p class="calibre3">As pointless as that might sound, the power comes in the options Charles has to offer. If we are intending to allow web traffic from our mobile device to the API on our development environment, at this point, we are half way.</p>

<aside class="warning">
    <h3 id="calibre_link-141" class="calibre23">Local vs. “Remote”</h3>

  <p class="calibre3">To allow Laravel (PHP’s) built in server to access this connection on OS X, you must start the server using the network address shown in the sharing section of system preferences.<br class="calibre6" />
Choose Apple menu &gt; System Preferences, and then click Sharing.
Below “Computer Name” you will see an address followed by “.local”.<br class="calibre6" />
To start the server simply use:<br class="calibre6" />
<code class="calibre15">$ php artisan serve --host="Phils-MacBook-Air.local"</code><br class="calibre6" />
I personally have Charles pointing to a Vagrant box, running on its own IP address with its own virtual host
enabled. This is not something that the book will cover, but is certainly something you should look into doing.</p>

</aside>

<p class="calibre3">In order to make <code class="calibre15">dev-api.example.com</code> mean something on your mobile device, you need to enter a “Map Remote” rule in Charles.</p>


<figure class="image">
  <img src="images/000014.png" alt="Screenshot of Charles on OS X mapping dev-api.example.com" class="calibre30" />
  <figcaption class="calibre31">Screenshot of Charles on OS X mapping dev-api.example.com</figcaption>
</figure>


<p class="calibre3">As explained above, Charles acts as a “man-in-the-middle”, rerouting traffic based on your rules. By saying <code class="calibre15">dev-api.example.com</code> should be routed to <code class="calibre15">dev-api.example.com</code> on your machine, you have given that hostname, meaning on your mobile devices (or anything else talking to Charles on that port).</p>

<p class="calibre3">Now &mdash; so long as you are able to get a build of your mobile application pointing to <code class="calibre15">dev-api.example.com</code> &mdash; you will be able to click around the application, seeing requests and responses with all of the headers and values as you go.</p>


<figure class="image">
  <img src="images/000000.png" alt="Charles showing results for Kapture" class="calibre30" />
  <figcaption class="calibre31">Charles showing results for Kapture</figcaption>
</figure>


<p class="calibre3">You might not find yourself using Charles every day, or for a long time. At the start your HTTP Clients may be enough to debug problems, but having it available is certainly going to help you out at some point. Keep it in mind.</p>

<p class="calibre3"><a href="https://www.wireshark.org/">Wireshark</a> is also handy for Linux/OS X users, and <a href="http://www.telerik.com/fiddler">Fiddler</a> is fun for Windows users.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-97">
<div class="calibre6">
<h2 id="calibre_link-56" class="calibre1">
<span class="section-number">9. </span>Authentication</h2>

<h3 id="calibre_link-57" class="calibre2">
<span class="section-number">9.1 </span>Introduction</h3>

<p class="calibre3">Understanding authentication for an API can be one of the largest hurdles for many developers, partially because
there are a lot of different methods, but mostly because none of them are anything like authentication in an
average web app.</p>

<p class="calibre3">When building an admin dashboard, CMS, blog, etc., it is widely accepted as standard behavior to use sessions
with a data store such as cookies, Memcache, Redis, Mongo, or some SQL platform. Regardless of the data store,
sessions are used so that once logged in, the browser remembers who the user is. To log in, the user is
presented with a form in HTML showing two fields: one for the username and/or email address of the user, and one
for the password. Once the end-user closes the browser or is inactive for a certain period of time, they
will be forgotten.</p>

<p class="calibre3">This is the standard way to handle logins for the vast majority of sites built with a server-side language, but
it is not how you handle authentication for an API at all.</p>

<p class="calibre3">In this chapter, we will look at some of the most popular authentication methods, and explain some pros and cons
of each.</p>

<h3 id="calibre_link-58" class="calibre2">
<span class="section-number">9.2 </span>When is Authentication Useful?</h3>

<p class="calibre3">Authentication allows APIs to track users, give endpoints user context (“find all of <em class="calibre19">my</em> posts”), limit users’
access to various endpoints, filter data, or even throttle and deactivate accounts. This is all very useful for
many APIs, but some may never need to implement authentication.</p>

<h4 id="calibre_link-142" class="calibre4">Read-only APIs</h4>

<p class="calibre3">If your API is entirely read-only and the data is not sensitive, then you can just make it available and not
worry about authentication. This is perfectly acceptable.</p>

<p class="calibre3">There is the concern that people could be attacking your API with DDoS attacks (flooding your API with an
unreasonable number of requests with malicious intent). Using some form of authentication would limit the
vectors of attack. To get a response from the API, they would need to be a valid user, and therefore the user’s
account could be throttled or deactivated if malicious activity was detected.</p>

<p class="calibre3">This does not entirely negate DDoS attacks, but it can help your API do less work as the request will terminate
much sooner if an invalid user is found. So if DDoS issues are still a concern, with or without authentication,
then use a self-improving firewall or implement other security barriers.
Generally speaking, having anyone spamming any of your servers is not ideal, so this may certainly be a stronger
move than implementing authentication purely to avoid these attacks.</p>

<p class="calibre3">Either way, you could quite easily release your API without authentication then implement piecemeal later on.</p>

<h4 id="calibre_link-143" class="calibre4">Internal APIs</h4>

<p class="calibre3">If your API runs over a private network or is locked down with firewall rules and you do not require
user context for your API, then you could probably skip authentication.</p>

<p class="calibre3">One concern with just leaving all the security up to the network is that, if the network is breached, then hackers
would be able to do rather a lot of damage. However, if hackers are ‘all up in your networks’, then you probably have
a lot of security issues already.</p>

<p class="calibre3">Keep it in mind.</p>

<h3 id="calibre_link-59" class="calibre2">
<span class="section-number">9.3 </span>Different Approaches to Authentication</h3>

<h4 id="calibre_link-144" class="calibre4">Approach #1: Basic Authentication</h4>

<p class="calibre3">The first approach that many developers go to is HTTP Basic, which is most like the standard
username/password approach they have grown to know and love, but instead implemented on the HTTP Request level and respected by the browser.</p>

<p class="calibre3">Here is what Wikipedia has to say:</p>

<blockquote class="calibre17">
  <p class="calibre3">HTTP Basic authentication (BA) implementation is the simplest technique for enforcing access controls to web
resources because it doesn’t require cookies, session identifier and login pages. Rather, HTTP Basic
authentication uses static, standard HTTP headers which means that no handshakes have to be done in
anticipation.
&ndash; <strong class="calibre22">Source:</strong> <a href="http://en.wikipedia.org/wiki/Basic_access_authentication">Wikipedia</a></p>
</blockquote>

<p class="calibre3">
  <strong class="calibre22">Pros</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Easy to implement</li>
  <li class="calibre14">Easy to understand</li>
  <li class="calibre14">Works in the browser and any other HTTP client</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Cons</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Is ludicrously insecure over HTTP</li>
  <li class="calibre14">Is fairly insecure over HTTPS</li>
  <li class="calibre14">Passwords can be stored by the browser, meaning a honeypot of user data is sitting around waiting to be gobbled up</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Browsers Storing Passwords</strong>
</p>

<p class="calibre3">With Chrome not even protecting these plain text passwords with a master password, you really are leaving your
users wide open to attack if you let HTTP Basic be an option.</p>

<p class="calibre3">Elliott Kember publicly <a href="http://blog.elliottkember.com/chromes-insane-password-security-strategy">outed Chrome on this</a>. <a href="http://www.theguardian.com/technology/2013/aug/07/google-chrome-password-security-flaw?INTCMP=SRCH">The Guardian cared</a>. <a href="https://twitter.com/timberners_lee/status/364839351651274752">Sir Tim Berners-Lee cared</a>. <a href="https://news.ycombinator.com/item?id=6166886">Google didn’t</a>.</p>

<p class="calibre3">
  <strong class="calibre22">More plain text Woe</strong>
</p>

<p class="calibre3">Another security issue with Basic authentication is that it is ludicrously insecure when running over HTTP.</p>

<p class="calibre3">In the example provided by Wikipedia, a header will be placed in the HTTP request that looks like this:</p>

<blockquote class="calibre17">
  <p class="calibre3">Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==</p>
</blockquote>

<p class="calibre3">If a request is made that goes over the wire (such as a JS based API request from a user sitting in a coffee shop),
then that request could easily be intercepted. Taking that header as an example, it is insanely simple to find
the username and password.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code>php -a
<code class="lineno">2</code> php &gt; <code class="nb">echo </code>base64_decode<code class="o">(</code><code class="s">'QWxhZGRpbjpvcGVuIHNlc2FtZQ=='</code><code class="o">)</code><code class="calibre15">;</code>
<code class="lineno">3</code> Aladdin:open sesame
</pre></div>

</figure>

<p class="calibre3">This is no more or less secure than a HTML login form, but is certainly not secure enough for any API with
sensitive data.</p>

<p class="calibre3">Using SSL improves the concerns greatly, but as the password is sent in every single HTTP request, there is still
the potential for cracking it. At this point, though, somebody has to <em class="calibre19">really</em> want to get in.</p>

<p class="calibre3">HTTP Basic Auth may be a good fit for a relatively unimportant internal API, which needs some basic protection
and needs to be implemented quickly, but certainly is not any good for anything that handles money, air traffic,
or nuclear weapons.</p>

<h4 id="calibre_link-145" class="calibre4">Approach #2: Digest Authentication</h4>

<p class="calibre3">Digest is an approach to authentication similar to Basic, but is designed to improve on the security concerns.</p>

<p class="calibre3">Instead of transmitting passwords in plain text, it will calculate a MD5 hash and send that. Unlike the
Base64-based passwords used in the basic auth, MD5 is a one-way hash meaning you cannot simply take the hash
and calculate the original password without trying out a lot of different combinations.</p>

<blockquote class="calibre17">
  <p class="calibre3">HA1 = MD5(A1) = MD5(username:realm:password)
HA2 = MD5(A2) = MD5(method:digestURI)
response = MD5(HA1:nonce:HA2)</p>
</blockquote>

<p class="calibre3">The <code class="calibre15">nonce</code> is a unique number, which can contain (but should not be only) a timestamp. This helps to avoid
replay attacks as the same hash will not be usable later on.</p>

<p class="calibre3">
  <strong class="calibre22">Pros</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Password is not transmitted in plain text</li>
  <li class="calibre14">The use of <code class="calibre15">nonce</code> helps negate rainbow table attacks</li>
  <li class="calibre14">Generally speaking, more secure than basic auth</li>
  <li class="calibre14">Easier to implement than some approaches</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Cons</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Harder than basic auth to implement <strong class="calibre22">well</strong>
</li>
  <li class="calibre14">Easy to implement badly</li>
  <li class="calibre14">Still insecure over HTTP</li>
  <li class="calibre14">Just like basic auth, passwords can still be stored by the browser</li>
  <li class="calibre14">Uses MD5</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">MD5… 4… 3… 2… 1… HACKED</strong>
</p>

<p class="calibre3">MD5 is well accepted by many people today to be extremely crackable in most scenarios. Digest authentication has
not improved since its creation in 1993. While the calculation process should help negate many of
these issues, a lousy implementation of digest authentication will be open to some weird attack vectors that will
remain unknown until after the fact.</p>

<p class="calibre3">Digest is certainly more secure than basic. It is great over SSL - definitely a good choice for an internal API
if you have more time to spend implementing - but it still requires the username and password to be sent repeatedly,
meaning it <em class="calibre19">is</em> potentially hackable if the hacker has enough encrypted requests available to process.</p>

<h4 id="calibre_link-146" class="calibre4">Approach #3: OAuth 1.0a</h4>

<p class="calibre3">Not quite as popular these days, OAuth 1.0a was a big player on the web-based authentication scene and used by
services such as Dropbox, Flickr, Twitter, Google, LinkedIn and Tumblr. Since then, most have moved over to OAuth 2,
which we will discuss next. The two are very different beasts and should not be conflated.</p>

<blockquote class="calibre17">
  <p class="calibre3">OAuth provides a method for clients to access server resources on
behalf of a resource owner (such as a different client or an end-user).
It also provides a process for end-users to authorize third-party access
to their server resources without sharing their
credentials (typically, a username and password pair), using user-agent redirections.
&ndash; <strong class="calibre22">Source:</strong> <a href="http://en.wikipedia.org/wiki/OAuth">Wikipedia</a></p>
</blockquote>

<p class="calibre3">Previously, we looked at authentication technologies that were essentially built into the browser, and were
not particularly flexible in their usages. OAuth 1.0 was a great way for services such as social networks to
implement web-based HTML login forms that looked the same as any other login form (were branded with logos,
color schemes, etc) but could then send you back to the third party website for all sorts of awesome
integration purposes.</p>

<p class="calibre3">For example, when Twitter swapped from HTTP Basic integration to OAuth 1.0 it meant that instead of
third-parties (iPhone apps, other websites, CMSs, whatever) asking end-users to enter their username and
password (which would be saved somewhere in plain text), the third party could redirect the user to the Twitter
website, get them to log in, and have them come back to their service to save a special token, instead of saving a
password. OAuth 1.0a called these tokens an ‘OAuth Token’ and an ‘OAuth Token Secret’.</p>

<p class="calibre3">OAuth 1.0a was built to be very secure even when not running over SSL. That meant, of course, that it was
incredibly complicated, having to set up signatures of which there were a few different algorithms, including
HMAC-SHA1 and RSA-SHA1, or just plaintext. That got a bit tricky when trying to write client code, as you had to
make sure you supported the right signature algorithm, and most of the PHP implementations out there (including
my old CodeIgniter library) did not support them all.</p>

<p class="calibre3">An average OAuth 1.0a signed HTTP request would look a little something like this:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">POST</code> <code class="o">/</code><code class="calibre15">moments</code><code class="o">/</code><code class="o">1</code><code class="o">/</code><code class="calibre15">gift</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno"> 2</code> <code class="nl">Host:</code> <code class="calibre15">api</code><code class="calibre15">.</code><code class="calibre15">example</code><code class="calibre15">.</code><code class="calibre15">com</code>
<code class="lineno"> 3</code> <code class="nl">Authorization:</code> <code class="calibre15">OAuth</code> <code class="calibre15">realm</code><code class="o">=</code><code class="s">"http://sp.example.com/"</code><code class="calibre15">,</code>
<code class="lineno"> 4</code> <code class="calibre15">oauth_consumer_key</code><code class="o">=</code><code class="s">"0685bd9184jfhq22"</code><code class="calibre15">,</code>
<code class="lineno"> 5</code> <code class="calibre15">oauth_token</code><code class="o">=</code><code class="s">"ad180jjd733klru7"</code><code class="calibre15">,</code>
<code class="lineno"> 6</code> <code class="calibre15">oauth_signature_method</code><code class="o">=</code><code class="s">"HMAC-SHA1"</code><code class="calibre15">,</code>
<code class="lineno"> 7</code> <code class="calibre15">oauth_signature</code><code class="o">=</code><code class="s">"wOJIO9A2W5mFwDgiDvZbTSMK%2FPY%3D"</code><code class="calibre15">,</code>
<code class="lineno"> 8</code> <code class="calibre15">oauth_timestamp</code><code class="o">=</code><code class="s">"137131200"</code><code class="calibre15">,</code>
<code class="lineno"> 9</code> <code class="calibre15">oauth_nonce</code><code class="o">=</code><code class="s">"4572616e48616d6d65724c61686176"</code><code class="calibre15">,</code>
<code class="lineno">10</code> <code class="calibre15">oauth_version</code><code class="o">=</code><code class="s">"1.0"</code>
<code class="lineno">11</code> <code class="calibre15">Content</code><code class="o">-</code><code class="calibre15">Type</code><code class="o">:</code> <code class="calibre15">application</code><code class="o">/</code><code class="calibre15">json</code>
<code class="lineno">12</code> 
<code class="lineno">13</code> <code class="calibre15">{</code> <code class="s">"user_id"</code> <code class="o">:</code> <code class="o">2</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Ouch.</p>

<p class="calibre3">Another complication was that there were different implementations: two-legged (“proper” and “not proper”) and
three-legged. This is incredibly confusing, so I will let Mashape explain in the <a href="https://github.com/Mashape/mashape-oauth/blob/028860c/FLOWS.md#oauth-10a-one-legged">OAuth Bible: OAuth Flows</a>.</p>

<p class="calibre3">There was also xAuth (which is still OAuth 1.0a), designed for mobile and desktop applications that do
not have easy access to a browser. It is much easier for a web application to spawn a popup with JavaScript, or to
redirect a user, than it is for a mobile app. This made it a much handier way to get OAuth Tokens than the other
implementations.</p>

<p class="calibre3">In the end, if you got the OAuth Token and Secret, you would place the OAuth Token in the request as a
header and use the secret to sign the signature, which would encrypt the request and make the whole thing nice
and secure. If you can shove SSL on top of that, then you have got yourself a very secure setup - except for the
fact that tokens would stay the same once created, so over time their security could be compromised. Somebody
could recover the data from a laptop you sold them on eBay, or a potential hacker could packet sniff enough
traffic signed with your signature to eventually programmatically guess the token and secret.</p>

<p class="calibre3">
  <strong class="calibre22">Pros</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Super secure, even without SSL</li>
  <li class="calibre14">Does not send username/password in every request (plain text or hashed)</li>
  <li class="calibre14">Stops third party applications wanting or storing your username and password</li>
  <li class="calibre14">An attacker gaining an OAuth Token and even a Secret should still never be able to change your password, meaning you should be safe from account hijack</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Cons</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Rather complicated to interact with, even if you have a well built client library. PHP never really had one, but <a href="http://thephpleague.com/">The League of Extraordinary Packages</a> has recently <a href="https://github.com/thephpleague/oauth1-client">built a decent one</a>
</li>
  <li class="calibre14">Limited number of ways to grant access. xAuth and Two/Three-legged flows ended up being rather restrictive</li>
  <li class="calibre14">Tokens never changed, so security was essentially just a matter of how long and how much you used the service</li>
</ul>

<p class="calibre3">OAuth 1.0a would be a great technology to implement if you were building a website with a public user-based API… and you were building it in 2009-2010. Now, probably not.</p>

<h4 id="calibre_link-147" class="calibre4">Approach #4: OAuth 2.0</h4>

<p class="calibre3">OAuth 2 dropped the secret token, so users are simply getting an <em class="calibre19">access token</em> now. It also dropped signature
encryption. This was seen by many as a massive step backwards in security, but it was actually rather a wise
move. The OAuth 1.0a spec made SSL optional, but OAuth 2.0 requires it. Relying on SSL to handle the encryption
of the request is logical and drastically improves the implementation.</p>

<p class="calibre3">Even a basic GET request in OAuth 1.0a was horrendous as you would always need to set up your consumers,
signatures, etc., but with OAuth 2.0 you can simply do this:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nb">file_get_contents</code><code class="calibre15">(</code><code class="s">'https://graph.facebook.com/me?access_token=vr5HmMkzlxKE70W1y4Mi'</code><code class="calibre15">);</code>
</pre></div>

</figure>

<p class="calibre3">Or, as we saw back in <a href="#calibre_link-14">chapter 3</a>, you can usually pass access tokens to the server as an HTTP
request header:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">POST</code> <code class="o">/</code><code class="calibre15">moments</code><code class="o">/</code><code class="o">1</code><code class="o">/</code><code class="calibre15">gift</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="nl">Host:</code> <code class="calibre15">api</code><code class="calibre15">.</code><code class="calibre15">example</code><code class="calibre15">.</code><code class="calibre15">com</code>
<code class="lineno">3</code> <code class="nl">Authorization:</code> <code class="calibre15">Bearer</code> <code class="calibre15">vr5HmMkzlxKE70W1y4Mi</code>
<code class="lineno">4</code> <code class="calibre15">Content</code><code class="o">-</code><code class="calibre15">Type</code><code class="o">:</code> <code class="calibre15">application</code><code class="o">/</code><code class="calibre15">json</code>
<code class="lineno">5</code> 
<code class="lineno">6</code> <code class="calibre15">{</code> <code class="s">"user_id"</code> <code class="o">:</code> <code class="o">2</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">That looks a little easier to work with than OAuth 1.0a, right?</p>

<aside class="warning">
    <h4 id="calibre_link-148" class="calibre21">Headers vs. URL</h4>
  <p class="calibre3">You should always try to use the <code class="calibre15">Authorization</code> header to send your tokens whenever possible. The query-string is
secured when using SSL, but unless they are intentionally blocked then access tokens could start turning up in server
logs and various other places. Also, browsers will store the full URL (including query-string) in history. This could
easily compromise the integrity of users security if their computer is stolen or if a sibling decides to play a prank.</p>

</aside>

<p class="calibre3">
  <strong class="calibre22">“Short”-life Tokens</strong>
</p>

<p class="calibre3">As discussed, OAuth 1.0a also uses the same tokens essentially forever. OAuth 2.0’s access tokens will (can)
expire after an arbitrary period of time, which is defined by the OAuth server. When you request an access token, you will
usually be provided with a <em class="calibre19">refresh token</em> and an <em class="calibre19">expiry offset</em>, which is the number of seconds until the token
expires. Some servers send you a unix time at which it expires. Folks like to do things different for some
reason, but if you know what to look out for it is not so bad.</p>

<p class="calibre3">Using the expire time you know when your access token will not be valid, so you can proactively create a CRON
job that refreshes the access tokens, or you can wrap your HTTP requests in an exception handler that looks for
a ‘Not Authorized’ error and then refreshes them as the OAuth 2.0 spec recommends.</p>

<p class="calibre3">This extra “access tokens expire and you have to refresh them” step initially seems confusing and annoying,
especially when you are used to “once I have this token it works forever”. However, it is much more secure. OAuth 1.0a
stopped you handing out your username and password by essentially giving you another username and password (the
token and the secret), which worked for one specific client. Any good network admin will tell you that you should
regularly change your password (at least once every month), and OAuth is no different as the more you use the same
password/token the greater your chance of somebody finding out what it is.</p>

<p class="calibre3">
  <strong class="calibre22">Grant Types</strong>
</p>

<p class="calibre3">One further massive benefit OAuth 2.0 provides over OAuth 1.0a is the ability to have multiple (even custom) grant
types. Grant types are essentially a “mode” in which the OAuth 2.0 server will run, expecting different inputs and
maybe providing different outputs. With this flexibility, you can create some amazing implementations.</p>

<p class="calibre3">The most common OAuth 2.0 Grant Type that a user will be familiar with is <code class="calibre15">authorization_code</code>, which is a very OAuth
1.0a-like flow.</p>

<p class="calibre3">A client web app creates a link to the OAuth Server of the service they would like to log into (e.g. Facebook), and the
user logs in. Facebook redirects the user back to the client web app’s ‘Callback URL’ with a <code class="calibre15">?code=FOO</code> variable in
the query string. The web app then takes that code and makes a second request to Facebook (usually a <code class="calibre15">POST</code>, but sometimes
a <code class="calibre15">GET</code> depending on which popular API you look at) and Facebook then offers up an access token in the response.
Some other popular APIs, like Google Apps, then provide <code class="calibre15">expires</code> and a refresh token too.</p>

<p class="calibre3">This is just one approach and there are more. Due to this flexibility, OAuth 2.0 is good for pretty much any
scenario when authenticating an API, be it a basic username password login on a single-page JavaScript app, a
CRON job that has no database access, or a full blown user-redirect flow between different websites. The flexibility
of custom grant types allows absolutely anything to be done.</p>

<p class="calibre3">More on this in the ‘Understanding OAuth 2.0 Grant Types’ section below.</p>

<p class="calibre3">
  <strong class="calibre22">Erin Hammer</strong>
</p>

<p class="calibre3">Often, I am asked why anyone would still use OAuth 2.0 after Erin Hammer (lead author and editor of the OAuth 2.0
standard) <a href="http://hueniverse.com/2012/07/26/oauth-2-0-and-the-road-to-hell/">withdrew his name from the specification</a>. It certainly sent a ripple through the Internet, but I
personally disagree wholeheartedly with the issues he raised.</p>

<ol class="calibre13">
  <li class="calibre14">OAuth 2.0 is less secure if you do not use SSL/TSL. Correct. So use them.</li>
  <li class="calibre14">People have implemented OAuth 2.0 badly (looking at you Facebook/Google/most providers), but when implemented well it is lovely. Use a pre-built standard compliant implementation.</li>
  <li class="calibre14">He thinks refresh tokens are annoying, but I think they are great.</li>
</ol>

<p class="calibre3">His departure from the project is no major loss. I am sure the IETF are bikeshedding hard,
but after using both for years, I am much happier with OAuth 2.0 and really wish <a href="https://dev.twitter.com/discussions/397">Twitter would get on with a
full upgrade</a> so I never have to use OAuth 1.0a again.</p>

<p class="calibre3"><em class="calibre19">Generally speaking,</em> OAuth 2.0 is a good fit for a huge majority of situations, provided you <strong class="calibre22">use SSL</strong> and
implement a <strong class="calibre22">well-tested</strong> existing solution for your OAuth 2.0 Server. Trying to do this yourself can be
incredibly hard and may well lead to you getting super-hacked. Even Facebook
have trouble here to this day because they rolled their own solution based on a really early draft of the
specification.</p>

<h4 id="calibre_link-149" class="calibre4">Other Approaches</h4>

<ul class="calibre18">
  <li class="calibre14">
<strong class="calibre22">OpenID</strong> - https://openid.net/</li>
  <li class="calibre14">
<strong class="calibre22">Hawk</strong> - https://github.com/hueniverse/hawk</li>
  <li class="calibre14">
<strong class="calibre22">Oz</strong> - https://github.com/hueniverse/oz</li>
</ul>

<h3 id="calibre_link-60" class="calibre2">
<span class="section-number">9.4 </span>Implementing an OAuth 2.0 Server</h3>

<p class="calibre3">Implementation by hand of an OAuth 2.0 server - or any of these authentication methods for that matter - can be
very difficult. This chapter, aimed to explain the pros, cons, and use cases for each, and implementation, is sadly
out of its scope. Here are a few existing implementations that you could look into using.</p>

<h4 id="calibre_link-150" class="calibre4">PHP Implementations</h4>

<p class="calibre3">One implementation stands out above the rest in PHP land, and not just because it is written by a friend of
mine, <a href="http://alexbilbie.com/">Alex Bilbie</a>. He has studied both OAuth specs religiously and over the years has built some great
tools for them, which I have used many times.</p>

<p class="calibre3">In his last job at the University of Lincoln, he was using OAuth for all sorts of cool things.
He then received a huge amount of funding for a research project to build awesome open-source code
for improving authentication and interoperability. That project resulted in a few great packages,
including the <a href="http://oauth2.thephpleague.com/">PHP OAuth 2.0 Server</a>. It has a bridge-package for Laravel, which makes it trivial to implement.</p>

<p class="calibre3">There is another <a href="http://bshaffer.github.io/oauth2-server-php-docs/">PHP OAuth 2.0 server implementation</a> that has been around for roughly the same amount of time and is also of great quality. The two approaches are a little different but both implement the full spec, so have a click around and see which you prefer.</p>

<h4 id="calibre_link-151" class="calibre4">Python Implementations</h4>

<p class="calibre3">There are two implementations for Python that look fairly good. One is <a href="https://github.com/NateFerrero/oauth2lib">oauth2lib</a>, which is a fork of <a href="https://github.com/StartTheShift/pyoauth2">pyoauth2</a>.
The original authors gave up, then the new ones had to rename it, or something like that.</p>

<p class="calibre3">Another is <a href="https://github.com/simplegeo/python-oauth2">python-oauth2</a>, which was developed by SimpleGeo, a great geo-location/place SaaS. This has since been
bought out and shut down and was last committed to around two years ago. Maybe somebody needs to take that one over too.</p>

<h4 id="calibre_link-152" class="calibre4">Ruby Implementations</h4>

<p class="calibre3">For an API I worked on after Kapture, we had a Rails codebase and implemented <a href="https://github.com/doorkeeper-gem/doorkeeper">Doorkeeper</a> with great success. Doorkeeper
supports the main grant types, has great documentation and is being actively developed by a very responsive team of
contributors. It also documents some simple integration for Devise - a popular user / authentication system for Rails.</p>

<p class="calibre3">There is also a Rack module named <a href="https://github.com/assaf/rack-oauth2-server">Rack::OAuth2::Server</a>. I have no experience using it, but it
seems actively developed and has documentation to implement into Rails, Sinatra and Padrino.</p>

<h3 id="calibre_link-61" class="calibre2">
<span class="section-number">9.5 </span>Where the OAuth 2.0 Server Lives</h3>

<p class="calibre3">Many assume that the OAuth 2.0 server should be part of their API server. While it certainly could, it
definitely does not need to be.</p>

<p class="calibre3">An OAuth server usually has a web interface, which has HTML forms, form validation, and all sorts of static
resources like images, CSS, JavaScript, etc. That makes it more fitting with a general website. If your API
and web-site are different servers, then the OAuth server would be more suitably placed on the website.</p>

<p class="calibre3">That said, it is better to keep all of these things seperate and autonomous, since if you decide to build a new
version of your website in AngularJS instead of server-side code it would be a pain to have to switch your OAuth
server implementation too. If the OAuth server is on its own server, or at very least its own code base, then
you do not have this concern.</p>

<p class="calibre3">The only thing your API needs to do is look for an access token (as a header or query string parameter), then hit
whichever data store (SQL database, Mongo, etc.) contains the access tokens. Check it is valid (in the DB
and not expired), then grab whichever user is tied to it, and pull that record for use throughout the API code.</p>

<p class="calibre3">None of that is complicated, so trying to tie the API server and OAuth server together in the same application
code base out of some misplaced perception of belonging is just not required.</p>

<h3 id="calibre_link-62" class="calibre2">
<span class="section-number">9.6 </span>Understanding OAuth 2.0 Grant Types</h3>

<p class="calibre3">The four grant types discussed in the specification are:</p>

<h4 id="calibre_link-153" class="calibre4">Authorization Code</h4>

<p class="calibre3">“Authorization code” is the full user flow with redirects discussed earlier in the chapter.</p>

<p class="calibre3">This is most useful if you have multiple sites (like a network of sites for games, movies, books, etc.), or just
want to share logins with other partners. This is also the grant type you will most likely use to log users into
Facebook or Google.</p>

<p class="calibre3">
  <a href="http://tools.ietf.org/html/rfc6749#section-4.1">Section 4.1 in the spec</a>
</p>

<h4 id="calibre_link-154" class="calibre4">Refresh Token</h4>

<p class="calibre3">“Refresh tokens” are supported by most popular OAuth 2.0 providers. Basically, you notice that your old access
token does not work anymore when you receive an HTTP <code class="calibre15">401</code> status code, so you request a new one using your
refresh token. The OAuth 2.0 server will then either give you a new access token, or the server will refuse. At
that point, you will have to send your user an email saying, “your account is no longer connected to Example.com,
please click here to reconnect”. This is not common, and usually means that the user has disconnected access for
that account anyway, so a manual request is literally the only option.</p>

<p class="calibre3">This sounds like a bit of a runaround, but it is quite simple and has a few advantages.</p>

<p class="calibre3">Basically, if you are using the same access token over and over again forever then there is a fairly strong chance of
somebody finding it. There are an array of reasons for this, from the site not implementing SSL, the site
getting hacked, the sys admins accidentally exposing some of their access logs, or, more likely, the access
token being stored in the browser.</p>

<p class="calibre3">Storing the access token in the browser is fine if the access token is going to expire soon, as it means the
hacker has a very short window of opportunity to do anything if they find it. If they get the current access
token then fine, but if there is a five minute expiry then getting that token would be much more difficult, and would
probably require the hacker to be physically on the device you were using, or SSHing in - at which point you
have much greater concerns.</p>

<p class="calibre3">Not all APIs will expire their access tokens, so some do live forever. Normally they either last forever, or
they will give you an expiry time and expect you to refresh them. One exception to that is Facebook, who do
neither. Facebook’s whole approach is that they <em class="calibre19">want</em> you to be forced to send a user back to <code class="calibre15">facebook.com</code> on
a login.</p>

<p class="calibre3">It is frustrating that once again Facebook have decided to flagrantly disregard the OAuth 2.0 spec to suit their
own needs, hurting the user flow and confusing developers in the process. Working with these popular APIs you
will notice a lot of things like this that wind you up, but the differences are much less problematic if they
are not even slightly OAuth 2.0 based. At least they have <em class="calibre19">some</em> common ground.</p>

<p class="calibre3">
  <a href="http://tools.ietf.org/html/rfc6749#section-6">Section 6 in the spec</a>
</p>

<h4 id="calibre_link-155" class="calibre4">Client Credentials</h4>

<p class="calibre3">Client credentials can be useful for saying:</p>

<blockquote class="calibre17">
  <p class="calibre3">I am an application, you know that I am an application because here are my client_id and client_secret values. 
Let me in now please.</p>
</blockquote>

<p class="calibre3">This is useful for CRON jobs, worker processes, daemons or any other sort of background process. The application
will not have any context of a user, but it will be able to interact with your API. They have an access token
which they will keep on using, and if it happens to expire then the background process will know how to refresh
it.</p>

<p class="calibre3">Twitter, as mentioned, have been OAuth 1.0a only for years, but they added an OAuth 2.0 endpoint which would
accept <code class="calibre15">client_credentials</code> as the only grant type. Their <a href="https://dev.twitter.com/docs/auth/application-only-auth">documentation</a> explains further.</p>

<p class="calibre3">This is handy for public crawling of tags or public tweets, but is not able to handle posting statuses or
anything that relates to a user. This is a handy compromise for now, and hopefully is a sign that they intend to
roll out support for more grant types in the future.</p>

<p class="calibre3">
  <a href="http://tools.ietf.org/html/rfc6749#section-2.3.1">Section 2.3.1 in the spec</a>
</p>

<h4 id="calibre_link-156" class="calibre4">Password (user credentials)</h4>

<p class="calibre3">User Credentials are possibly the easiest way to get an access token for a user. This skips the whole
redirect flow that ‘Authentication Code’ provides, and the user peace-of-mind that comes with it, but does
offer simplicity. If Twitter had offered User Credentials OAuth 2.0 login as a replacement for HTTP Basic, then
the ‘Twitter Authpocolypse’ a few years ago would have been far less drastic.</p>

<p class="calibre3">All you need to do is provide a username and password to the OAuth 2.0 server, and it gives you back an access
token (and of course maybe a refresh token). Simple.</p>

<p class="calibre3">An example of this being extremely useful is creating a single page application with
AngularJS/EmberJS/WhateverJS and wanting to provide a login. Clearly redirecting users around would be
unnecessary because they are already on “your site”, and the login box can be already styled however you like.</p>

<p class="calibre3">The trouble is, if you try to do all of this in JavaScript code, you run into a problem. You need to send the
<code class="calibre15">client_id</code> and <code class="calibre15">client_secret</code> along with the <code class="calibre15">username</code> and <code class="calibre15">password</code>, but if you are using JavaScript then
putting your <code class="calibre15">client_secret</code> into the JavaScript means it is readable in the browser.</p>

<p class="calibre3">HACK HACK HACK!</p>

<p class="calibre3">Do not do that.</p>

<p class="calibre3">It is easily avoidable; simply make a proxy script that will take a username and password as POST items, then
pass them onto the OAuth 2.0 server with the <code class="calibre15">client_id</code> and <code class="calibre15">client_secret</code> too, both of which probably come from
some secret config file on the server.</p>

<figure class="code">
  <figcaption class="calibre20">Basic access token proxy script written in Python using Flask</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="k">import</code> <code class="nc">requests</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="k">from</code> <code class="nc">flask</code> <code class="k">import</code> <code class="calibre15">Flask</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code> <code class="calibre15">app</code> <code class="o">=</code> <code class="calibre15">Flask</code><code class="calibre15">(</code><code class="calibre15">__name__</code><code class="calibre15">)</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> <code class="nd">@app.route</code><code class="calibre15">(</code><code class="s">'/proxy/access_token'</code><code class="calibre15">,</code> <code class="calibre15">methods</code><code class="o">=</code><code class="calibre15">[</code><code class="s">'POST'</code><code class="calibre15">])</code>
<code class="lineno"> 8</code> <code class="k">def</code> <code class="nf">access_token</code><code class="calibre15">():</code>
<code class="lineno"> 9</code> 
<code class="lineno">10</code>     <code class="calibre15">payload</code> <code class="o">=</code> <code class="calibre15">{</code>
<code class="lineno">11</code>         <code class="s">'grant_type'</code><code class="calibre15">:</code> <code class="s">'password'</code><code class="calibre15">,</code>
<code class="lineno">12</code>         <code class="s">'client_id'</code><code class="calibre15">:</code> <code class="s">'foo'</code><code class="calibre15">,</code>
<code class="lineno">13</code>         <code class="s">'client_secret'</code><code class="calibre15">:</code> <code class="s">'bar'</code><code class="calibre15">,</code>
<code class="lineno">14</code>         <code class="s">'username'</code><code class="calibre15">:</code> <code class="calibre15">request</code><code class="o">.</code><code class="calibre15">form</code><code class="calibre15">[</code><code class="s">'username'</code><code class="calibre15">],</code>
<code class="lineno">15</code>         <code class="s">'password'</code><code class="calibre15">:</code> <code class="calibre15">request</code><code class="o">.</code><code class="calibre15">form</code><code class="calibre15">[</code><code class="s">'password'</code><code class="calibre15">]</code>
<code class="lineno">16</code>     <code class="calibre15">}</code>
<code class="lineno">17</code> 
<code class="lineno">18</code>     <code class="calibre15">r</code> <code class="o">=</code> <code class="calibre15">requests</code><code class="o">.</code><code class="calibre15">post</code><code class="calibre15">(</code><code class="s">'https://oauth.example.com/'</code><code class="calibre15">,</code> <code class="calibre15">data</code><code class="o">=</code><code class="calibre15">payload</code><code class="calibre15">)</code>
<code class="lineno">19</code> 
<code class="lineno">20</code>     <code class="k">return</code> <code class="calibre15">r</code><code class="o">.</code><code class="calibre15">json</code><code class="calibre15">(),</code> <code class="calibre15">r</code><code class="o">.</code><code class="calibre15">status_code</code>
</pre></div>

</figure>

<p class="calibre3">That is all that needs to be done. Take whatever it gives you, pass it onto the server, and pass the response
back. This keeps the secret information secret and still lets you do everything else in the browser.</p>

<p class="calibre3">
  <a href="http://tools.ietf.org/html/rfc6749#section-4.3">Section 4.3 in the spec</a>
</p>

<h4 id="calibre_link-157" class="calibre4">Custom Grant Types</h4>

<p class="calibre3">At Kapture, we created a <code class="calibre15">social</code> grant, where a user would provide a string matching <code class="calibre15">"facebook"</code> or <code class="calibre15">"twitter"</code> and an <code class="calibre15">access_token</code> (with maybe a <code class="calibre15">access_token_secret</code> for OAuth 1.0a providers like Twitter) and that would do the following:</p>

<ol class="calibre13">
  <li class="calibre14">Grab the user’s data</li>
  <li class="calibre14">Find out if they are a Kapture user, and if not create a Kapture user record</li>
  <li class="calibre14">Create an access token, refresh token, etc. to give that user access</li>
</ol>

<p class="calibre3">That gave us a completely seamless instant sign-up or log in experience for our iPhone application, and let our
admin panel AND merchant dashboard use the exact same OAuth 2.0 server to handle logins for everyone. Very
handy for our iPhone app and meant that we could roll the same functionality out to a potential Android app
and web-based versions too.</p>

<p class="calibre3">If you can think of it, you can make a custom grant type for it. Grant access to any users that provide you with
a URL of an image, which contains a photograph of a car which happens to be yellow. Whatever.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-93">
<div class="calibre6">
<h2 id="calibre_link-63" class="calibre1">
<span class="section-number">10. </span>Pagination</h2>

<h3 id="calibre_link-64" class="calibre2">
<span class="section-number">10.1 </span>Introduction</h3>

<p class="calibre3">Pagination is one of those words that means something very specific to many developers, but it generally means:</p>

<blockquote class="calibre17">
  <p class="calibre3">The sequence of numbers assigned to pages in a book or periodical.</p>
</blockquote>

<p class="calibre3">There are a few ways to achieve pagination, but when talking in terms of an API it means:</p>

<blockquote class="calibre17">
  <p class="calibre3">Any way you want to go about splitting up your data into multiple HTTP requests, for the sake of limiting HTTP Response size.</p>
</blockquote>

<p class="calibre3">There are a few reasons for doing this:</p>

<ol class="calibre13">
  <li class="calibre14">Downloading more stuff takes longer</li>
  <li class="calibre14">Your database might not be happy about trying to return 100,000 records in one go</li>
  <li class="calibre14">Presentation logic iterating over 100,000 records is no fun</li>
</ol>

<p class="calibre3">As you can probably tell, 100,000 is an arbitrary number. An API could have endpoints like <code class="calibre15">/places</code> with over a million
records, or check-ins which could be unlimited. While developing an API, many people forget about this, and
while ten or a hundred records will display quite quickly during development, infinity is considerably slower. Data grows exponentially.</p>

<p class="calibre3">A good API will allow the client to request the number of items it would like returned per HTTP request. Some developers
try to be smart and use custom HTTP headers for this, but this is literally what the query string is for.</p>

<blockquote class="calibre17">
  <p class="calibre3">/places?number=12</p>
</blockquote>

<p class="calibre3">Some use <code class="calibre15">number</code>, <code class="calibre15">limit</code>, <code class="calibre15">per_page</code> or whatever. I always think <code class="calibre15">limit</code> only really makes sense because SQL users are
used to it and an API is not SQL, so personally I use <code class="calibre15">number</code>.</p>

<aside class="warning">
    <h4 id="calibre_link-158" class="calibre21">Define a Maximum</h4>
  <p class="calibre3">When you take the limit/number parameter from the client, you absolutely have to set an upper bound on that number,
make sure it is over 0 and depending on the data source you might want to make sure it is an integer as decimal places
could have some interesting effects.</p>

</aside>

<h3 id="calibre_link-65" class="calibre2">
<span class="section-number">10.2 </span>Paginators</h3>

<p class="calibre3">I stole the word “paginator” from Laravel, which uses a <code class="calibre15">Paginator</code> class for a very specific type of pagination. It
is not the most efficient form of pagination by any means, but it is rather easy to understand and works fine on
relatively small data sets.</p>

<h4 id="calibre_link-159" class="calibre4">How do Paginators Work</h4>

<p class="calibre3">One approach to pagination is to count how many records there are for a specific item. So, if we count how many <code class="calibre15">places</code>
there are, there will probably be some sort of SQL query like this:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">SELECT</code> <code class="calibre15">count</code><code class="calibre15">(</code><code class="o">*</code><code class="calibre15">)</code> <code class="calibre15">as</code> <code class="err">`</code><code class="calibre15">total</code><code class="err">`</code> <code class="calibre15">FROM</code> <code class="err">`</code><code class="calibre15">places</code><code class="err">`</code>
</pre></div>

</figure>

<p class="calibre3">When the answer to that query comes back as <code class="calibre15">1000</code>, the following code will be executed:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="cp">&lt;?php</code>
<code class="lineno">2</code> <code class="nv">$total</code> <code class="o">=</code> <code class="calibre15">count_all_the_places</code><code class="calibre15">();</code>
<code class="lineno">3</code> <code class="nv">$page</code> <code class="o">=</code> <code class="nb">isset</code><code class="calibre15">(</code><code class="nv">$_GET</code><code class="calibre15">[</code><code class="s">'page'</code><code class="calibre15">])</code> <code class="o">?</code> <code class="calibre15">(</code><code class="calibre15">int</code><code class="calibre15">)</code> <code class="nv">$_GET</code><code class="calibre15">[</code><code class="s">'page'</code><code class="calibre15">]</code> <code class="o">:</code> <code class="o">1</code><code class="calibre15">;</code>
<code class="lineno">4</code> <code class="nv">$per_page</code> <code class="o">=</code> <code class="nb">isset</code><code class="calibre15">(</code><code class="nv">$_GET</code><code class="calibre15">[</code><code class="s">'number'</code><code class="calibre15">])</code> <code class="o">?</code> <code class="calibre15">(</code><code class="calibre15">int</code><code class="calibre15">)</code> <code class="nv">$_GET</code><code class="calibre15">[</code><code class="s">'number'</code><code class="calibre15">]</code> <code class="o">:</code> <code class="o">20</code><code class="calibre15">;</code>
<code class="lineno">5</code> <code class="nv">$page_count</code> <code class="o">=</code> <code class="nb">ceil</code><code class="calibre15">(</code><code class="nv">$total</code> <code class="o">/</code> <code class="nv">$per_page</code><code class="calibre15">);</code>
</pre></div>

</figure>

<p class="calibre3">With that basic maths taken care of, we know how many pages there are in total, and have rounded it up with <code class="calibre15">ceil()</code>.
This is a PHP function equivalent of <code class="calibre15">Math.round()</code>, which rounds it up to the nearest integer. If <code class="calibre15">$total</code> is 1000, 
then <code class="calibre15">$page_count</code> will be 83.333. Obviously nobody wants to go to page 83.333, so round that up to page 84. </p>

<p class="calibre3">Using these variables, an API can output some simple metadata that goes next to the main <code class="calibre15">data</code> namespace:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>     <code class="s">"data"</code><code class="o">:</code><code class="calibre15">[</code>
<code class="lineno"> 3</code>       <code class="calibre15">...</code>
<code class="lineno"> 4</code>     <code class="calibre15">],</code>
<code class="lineno"> 5</code>     <code class="s">"pagination"</code><code class="o">:</code><code class="calibre15">{</code>
<code class="lineno"> 6</code>         <code class="s">"total"</code><code class="o">:</code><code class="o">1000</code><code class="calibre15">,</code>
<code class="lineno"> 7</code>         <code class="s">"count"</code><code class="o">:</code><code class="o">12</code><code class="calibre15">,</code>
<code class="lineno"> 8</code>         <code class="s">"per_page"</code><code class="o">:</code><code class="o">12</code><code class="calibre15">,</code>
<code class="lineno"> 9</code>         <code class="s">"current_page"</code><code class="o">:</code><code class="o">1</code><code class="calibre15">,</code>
<code class="lineno">10</code>         <code class="s">"total_pages"</code><code class="o">:</code><code class="o">84</code><code class="calibre15">,</code>
<code class="lineno">11</code>         <code class="s">"next_url"</code><code class="o">:</code><code class="s">"/places?page=2&amp;number=12"</code>
<code class="lineno">12</code>     <code class="calibre15">}</code>
<code class="lineno">13</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">The names of items in this pagination example are purely based on what Kapture’s iPhone developer suggested at the
time, but should portray the intent.</p>

<p class="calibre3">You basically give the client enough information to do maths itself, if that is something it wants to do, or you let them
ingest basic HTTP links too.</p>

<h4 id="calibre_link-160" class="calibre4">Counting lots of Data is Hard</h4>

<p class="calibre3">The main trouble with this method is the <code class="calibre15">SELECT count(*)</code> that is required to find out the total, which can be a very
expensive request.</p>

<p class="calibre3">The first thing to mind will be caching. Sure, you can cache the count, or even prepopulate the request. In many cases
you certainly could, but you have to consider that most endpoints will have multiple query string parameters
to customise the data returned.</p>

<blockquote class="calibre17">
  <p class="calibre3">/places?merchant=X</p>
</blockquote>

<p class="calibre3">That means you will now have a single cache for every count of places by each specific merchant. That could also be
cached or prepopulated, but when it comes to geo data you have no chance:</p>

<blockquote class="calibre17">
  <p class="calibre3">/places?lat=42.2345&amp;lon=1.234</p>
</blockquote>

<p class="calibre3">Unfortuntately, the chances of having multiple people request the exact same set of coordinates regularly enough to make a
cache worthwhile is unlikely, especially as those coordinates point to a remote, mountainous region of Spain.</p>

<p class="calibre3">Prepopulation for those results also seems highly unlikely. If you have literally millions of places then trying to
count all places for somebody in Spain is just silly. Indexes can help. Slicing your data into geographic buckets and
pulling it together with some clever trickery can help. Generally speaking though, using this sort of pagination
introduces big data problems to what can be potentially small data setups, especially when you have filtering options.</p>

<p class="calibre3">This is not bad (and I have used it myself for plenty of APIs), but you definitely need to keep this sort of thing in
mind.</p>

<h4 id="calibre_link-161" class="calibre4">Moving Goal Posts</h4>

<p class="calibre3">Another tricky issue with the count-everything-then-pick-which-page-number approach is that if a new item is
added between HTTP requests, the same content can show up twice.</p>

<p class="calibre3">Imagine the scenario, where the <code class="calibre15">number</code> per page is set to 2, <code class="calibre15">places</code> are ordered by name, and the values are hip bars
in Brooklyn, NY:</p>

<ul class="calibre18">
  <li class="calibre14">Page 1
    <ul class="calibre32">
      <li class="calibre14">Barcade</li>
      <li class="calibre14">Pickle Shack</li>
    </ul>
  </li>
  <li class="calibre14">Page 2
    <ul class="calibre32">
      <li class="calibre14">Videology</li>
    </ul>
  </li>
</ul>

<p class="calibre3">If the client requests Page 1, then they will see the first two results. While the results for Page 1 are being
displayed to the end user, some hip new bar opens up with the name “Lucky Dog” and joins the platform.</p>

<p class="calibre3">Now the data set looks like this:</p>

<ul class="calibre18">
  <li class="calibre14">Page 1
    <ul class="calibre32">
      <li class="calibre14">Barcade</li>
      <li class="calibre14">Lucky Dog</li>
    </ul>
  </li>
  <li class="calibre14">Page 2
    <ul class="calibre32">
      <li class="calibre14">Pickle Shack</li>
      <li class="calibre14">Videology</li>
    </ul>
  </li>
</ul>

<p class="calibre3">If the client does not refresh Page 1 (which most would not do for the sake of speed) then “Pickle Shack” is going to
show up twice, and “Lucky Dog” will not be on the list at all.</p>

<h4 id="calibre_link-162" class="calibre4">Using Paginators with Fractal</h4>

<p class="calibre3">This is a rather specific example, requiring Laravel’s Eloquent and Pagination packages, and <a href="http://fractal.thephpleague.com/">Fractal</a>. If you are not using any of those things then you can skip it and just use some simple maths like the
example JSON above. Otherwise, follow on:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="cp">&lt;?php</code>
<code class="lineno"> 2</code> <code class="k">use</code> <code class="calibre15">Acme\Model\Place</code><code class="calibre15">;</code>
<code class="lineno"> 3</code> <code class="k">use</code> <code class="calibre15">Acme\Transformer\PlaceTransformer</code><code class="calibre15">;</code>
<code class="lineno"> 4</code> <code class="k">use</code> <code class="calibre15">League\Fractal\Resource\Collection</code><code class="calibre15">;</code>
<code class="lineno"> 5</code> <code class="k">use</code> <code class="calibre15">League\Fractal\Pagination\IlluminatePaginatorAdapter</code><code class="calibre15">;</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> <code class="nv">$paginator</code> <code class="o">=</code> <code class="calibre15">Place</code><code class="o">::</code><code class="na">findNearbyPlaces</code><code class="calibre15">(</code><code class="nv">$lat</code><code class="calibre15">,</code> <code class="nv">$lon</code><code class="calibre15">)</code><code class="o">-&gt;</code><code class="na">paginate</code><code class="calibre15">();</code>
<code class="lineno"> 8</code> <code class="nv">$places</code> <code class="o">=</code> <code class="nv">$paginator</code><code class="o">-&gt;</code><code class="na">getCollection</code><code class="calibre15">();</code>
<code class="lineno"> 9</code> 
<code class="lineno">10</code> <code class="nv">$resource</code> <code class="o">=</code> <code class="k">new</code> <code class="calibre15">Collection</code><code class="calibre15">(</code><code class="nv">$places</code><code class="calibre15">,</code> <code class="k">new</code> <code class="calibre15">PlaceTransformer</code><code class="calibre15">);</code>
<code class="lineno">11</code> <code class="nv">$resource</code><code class="o">-&gt;</code><code class="na">setPaginator</code><code class="calibre15">(</code><code class="k">new</code> <code class="calibre15">IlluminatePaginatorAdapter</code><code class="calibre15">(</code><code class="nv">$paginator</code><code class="calibre15">));</code>
</pre></div>

</figure>

<h3 id="calibre_link-66" class="calibre2">
<span class="section-number">10.3 </span>Offsets and Cursors</h3>

<p class="calibre3">Another common pagination method the use of “cursors”, sometimes called “markers”. A cursor is usually a unique
identifier, or an offset, so that the API can just request more data.</p>

<p class="calibre3">If there is more data to be found, the API will return that data. If there is not more data, then either an error (404)
or an empty collection will be returned.</p>

<aside class="information">
    <h4 id="calibre_link-163" class="calibre21">Empty is not Missing</h4>
  <p class="calibre3">I personally advise against a 404 because the URL is not technically wrong,
there is simply no data to be returned in the collection so an empty collection makes more sense.</p>

</aside>

<p class="calibre3">To try the same example:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>     <code class="s">"data"</code><code class="o">:</code><code class="calibre15">[</code>
<code class="lineno"> 3</code>       <code class="calibre15">...</code>
<code class="lineno"> 4</code>     <code class="calibre15">],</code>
<code class="lineno"> 5</code>     <code class="s">"pagination"</code><code class="o">:</code><code class="calibre15">{</code>
<code class="lineno"> 6</code>         <code class="s">"cursors"</code><code class="o">:</code><code class="calibre15">{</code>
<code class="lineno"> 7</code>             <code class="s">"after"</code><code class="o">:</code><code class="o">12</code><code class="calibre15">,</code>
<code class="lineno"> 8</code>             <code class="s">"next_url"</code><code class="o">:</code><code class="s">"/places?cursor=12&amp;number=12"</code>
<code class="lineno"> 9</code>         <code class="calibre15">}</code>
<code class="lineno">10</code>     <code class="calibre15">}</code>
<code class="lineno">11</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">This JSON has been returned <code class="calibre15">after</code> requesting the first 12 records. 1-12 were all available and, for the sake of example, were all
auto-increment integers. Therefore, in this example, if we would like the content that is <em class="calibre19">after</em> 12, then the records having ID from 13 to 24 would be on the
next page.</p>

<p class="calibre3">While this provides a very simplified explanation, generally speaking using IDs is a tricky idea. A specific
record can move from one category to another, or could be deactivated, or all sorts of things. You <em class="calibre19">can</em> use IDs, but
it is generally considered best practice to use an offset instead.</p>

<p class="calibre3">Using an offset is simple. Regardless of your IDs &mdash; auto-incrementing, UUID, etc. &mdash; you simply put 12 in there and say “I would like 12 records, with an offset of 12”, instead of saying “I would like records after id=12”.</p>

<h4 id="calibre_link-164" class="calibre4">Obscuring Cursors</h4>

<p class="calibre3">Facebook sometimes use cursors to obscure actual IDs, but sometimes use them for “cursor based offsets”. Regardless of what the cursor actually is, your user should never really care, so obfuscating it seems like a good idea.</p>


<figure class="image">
  <img src="images/000007.png" alt="Facebook Graph API using Cursors" class="calibre30" />
  <figcaption class="calibre31">Facebook Graph API using Cursors</figcaption>
</figure>


<p class="calibre3">How did Facebook get <code class="calibre15">"NQ="</code> and <code class="calibre15">"MQ=="</code> as values? Well, they are intentionally odd looking as you are not meant to know what they are. A cursor is an opaque value which you can pass to the pagination system to get more information, so it could be 1, 6, 10, 120332435 or Tuesday and it would not matter.</p>

<p class="calibre3"><a href="http://dongilbert.net/">Don Gilbert</a> let me know that in the example of Facebook they just Base64 encode their cursors:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">php</code> <code class="o">&gt;</code> <code class="calibre15">var_dump</code><code class="calibre15">(</code><code class="calibre15">base64_decode</code><code class="calibre15">(</code><code class="err">'</code><code class="calibre15">NQ</code><code class="o">=</code><code class="err">'</code><code class="calibre15">));</code>
<code class="lineno">2</code> <code class="calibre15">string</code><code class="calibre15">(</code><code class="o">2</code><code class="calibre15">)</code> <code class="s">"5"</code>
<code class="lineno">3</code> 
<code class="lineno">4</code> <code class="calibre15">php</code> <code class="o">&gt;</code> <code class="calibre15">var_dump</code><code class="calibre15">(</code><code class="calibre15">base64_decode</code><code class="calibre15">(</code><code class="err">'</code><code class="calibre15">MQ</code><code class="o">==</code><code class="err">'</code><code class="calibre15">));</code>
<code class="lineno">5</code> <code class="calibre15">string</code><code class="calibre15">(</code><code class="o">1</code><code class="calibre15">)</code> <code class="s">"1"</code>
</pre></div>

</figure>

<p class="calibre3">Obfuscating the values is not done for security but, I assume, to avoid people trying to do maths on the values. Ignorance is bliss in this scenario, as somebody doing maths on an offset-based paginated result might end up using the same calculation on a primary key integer. If everything is an opaque cursor or marker then nobody can do that.</p>

<h4 id="calibre_link-165" class="calibre4">Extra Requests = Sadness</h4>

<p class="calibre3">This approach is not favoured by some client developers, as they do not like the idea of having to make extra HTTP
requests to find out that there is no data. However, this seems like the only realistic way to achieve a performant pagination system for large data. Even with a “pages” system, if there is only one record on the last page and that
record (or any other in any page) is removed, then the last page will be empty anyway. Every pagination system
needs to respond to an empty collection.</p>

<h4 id="calibre_link-166" class="calibre4">Using Cursors with Fractal</h4>

<p class="calibre3">Again this is a rather specific example, but should portray the concept.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="cp">&lt;?php</code>
<code class="lineno"> 2</code> <code class="k">use</code> <code class="calibre15">Acme\Model\Place</code><code class="calibre15">;</code>
<code class="lineno"> 3</code> <code class="k">use</code> <code class="calibre15">Acme\Transformer\PlaceTransformer</code><code class="calibre15">;</code>
<code class="lineno"> 4</code> <code class="k">use</code> <code class="calibre15">League\Fractal\Cursor\Cursor</code><code class="calibre15">;</code>
<code class="lineno"> 5</code> <code class="k">use</code> <code class="calibre15">League\Fractal\Resource\Collection</code><code class="calibre15">;</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> <code class="nv">$current</code> <code class="o">=</code> <code class="nb">isset</code><code class="calibre15">(</code><code class="nv">$_GET</code><code class="calibre15">[</code><code class="s">'cursor'</code><code class="calibre15">])</code> <code class="o">?</code> <code class="calibre15">(</code><code class="calibre15">int</code><code class="calibre15">)</code> <code class="nb">base64_decode</code><code class="calibre15">(</code><code class="nv">$_GET</code><code class="calibre15">[</code><code class="s">'cursor'</code><code class="calibre15">])</code> <code class="o">:</code> <code class="o">0</code><code class="calibre15">;</code>
<code class="lineno"> 8</code> <code class="nv">$per_page</code> <code class="o">=</code> <code class="nb">isset</code><code class="calibre15">(</code><code class="nv">$_GET</code><code class="calibre15">[</code><code class="s">'number'</code><code class="calibre15">])</code> <code class="o">?</code> <code class="calibre15">(</code><code class="calibre15">int</code><code class="calibre15">)</code> <code class="nv">$_GET</code><code class="calibre15">[</code><code class="s">'number'</code><code class="calibre15">]</code> <code class="o">:</code> <code class="o">20</code><code class="calibre15">;</code>
<code class="lineno"> 9</code> 
<code class="lineno">10</code> <code class="nv">$places</code> <code class="o">=</code> <code class="calibre15">Place</code><code class="o">::</code><code class="na">findNearbyPlaces</code><code class="calibre15">(</code><code class="nv">$lat</code><code class="calibre15">,</code> <code class="nv">$lon</code><code class="calibre15">)</code>
<code class="lineno">11</code>   <code class="o">-&gt;</code><code class="na">limit</code><code class="calibre15">(</code><code class="nv">$per_page</code><code class="calibre15">)</code>
<code class="lineno">12</code>   <code class="o">-&gt;</code><code class="na">skip</code><code class="calibre15">(</code><code class="nv">$current</code><code class="calibre15">)</code>
<code class="lineno">13</code>   <code class="o">-&gt;</code><code class="na">get</code><code class="calibre15">();</code>
<code class="lineno">14</code> 
<code class="lineno">15</code> <code class="nv">$next</code> <code class="o">=</code> <code class="nb">base64_encode</code><code class="calibre15">((</code><code class="calibre15">string</code><code class="calibre15">)</code> <code class="calibre15">(</code><code class="nv">$current</code> <code class="o">+</code> <code class="nv">$per_page</code><code class="calibre15">));</code>
<code class="lineno">16</code> 
<code class="lineno">17</code> <code class="nv">$cursor</code> <code class="o">=</code> <code class="k">new</code> <code class="calibre15">Cursor</code><code class="calibre15">(</code><code class="nv">$current</code><code class="calibre15">,</code> <code class="nv">$next</code><code class="calibre15">,</code> <code class="nv">$places</code><code class="o">-&gt;</code><code class="na">count</code><code class="calibre15">());</code>
<code class="lineno">18</code> 
<code class="lineno">19</code> <code class="nv">$resource</code> <code class="o">=</code> <code class="k">new</code> <code class="calibre15">Collection</code><code class="calibre15">(</code><code class="nv">$places</code><code class="calibre15">,</code> <code class="k">new</code> <code class="calibre15">PlaceTransformer</code><code class="calibre15">);</code>
<code class="lineno">20</code> <code class="nv">$resource</code><code class="o">-&gt;</code><code class="na">setCursor</code><code class="calibre15">(</code><code class="nv">$cursor</code><code class="calibre15">);</code>
</pre></div>

</figure>

<p class="calibre3">This will take the current cursor, use it as an offset, then work out the base64 version and convert it. There is a
bit of work to do in this example because the Cursor class is intentionally vague. Instead of using an offset it could
be a specific ID and you use it for an SQL <code class="calibre15">WHERE id &gt; X</code> clause, but better not.</p>

<h4 id="calibre_link-167" class="calibre4">Pagination with the Link Header</h4>

<p class="calibre3">The <code class="calibre15">Link</code> header is one not often used, but was introduced in <a href="http://tools.ietf.org/html/rfc5988#page-6">RFC 5988</a> for just this sort of
thing. </p>

<figure class="code">
  <figcaption class="calibre20">Example showing GitHub’s use of the Link header in an HTTP response</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno">1</code> <code class="nl">Link:</code> <code class="o">&lt;</code><code class="calibre15">https</code><code class="o">:</code><code class="c">//api.github.com/user/repos?page=3&amp;per_page=100&gt;; rel="next",</code>
<code class="lineno">2</code> <code class="o">&lt;</code><code class="calibre15">https</code><code class="o">:</code><code class="c">//api.github.com/user/repos?page=50&amp;per_page=100&gt;; rel="last"</code>
</pre></div>

</figure>

<p class="calibre3">I have never used this and am dubious. Some argue that pagination is metadata, and metadata should be kept out of the response. </p>

<p class="calibre3">Inserting pagination data into the API response in a <code class="calibre15">'pagination'</code> namespace is very common and 
has been my go-to solution for years. I would slot it next to the <code class="calibre15">'data'</code> namespace, and that makes
it very easy for clients who a) cannot read those HTTP headers and b) do not know to look there.</p>

<p class="calibre3">That said, using the <code class="calibre15">Link</code> header can help you avoid the need to wrap your collections in a
namespace at all. This might be something that interests you, as through developing Fractal I ran
into many developers who <em class="calibre19">hate</em> using a namespace for their collections.</p>

<p class="calibre3">The final advantage to mention would be that the <code class="calibre15">Link</code> is standard. Parsing it is going to be 100% 
the same for each API, and will not expect the client to work out if the link is contained in <code class="calibre15">uri</code>, <code class="calibre15">url</code>, <code class="calibre15">href</code> or something else.</p>

<p class="calibre3">Every API should choose its approach to pagination itself. Using this specific header does not make 
it “more RESTful” regardless of how many people seem to think that is the case. It just makes it
more “HTTPish” than defining your own pagination metadata.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-88">
<div class="calibre6">
<h2 id="calibre_link-67" class="calibre1">
<span class="section-number">11. </span>Documentation</h2>

<h3 id="calibre_link-68" class="calibre2">
<span class="section-number">11.1 </span>Introduction</h3>

<p class="calibre3">Regardless of whether you decide to keep an API private or release it to the
general public, documentation is incredibly important.</p>

<p class="calibre3">In the very early stages of development, some API developers will rely solely on a Postman collection (discussed in <a href="#calibre_link-51">Chapter 8: Debugging</a>) to be a sufficient source of documentation for their API. This may be the case, but as soon as the API is in use by more people than just the one developer with their one collection, this quickly becomes a nightmare.</p>

<p class="calibre3">Even if the API is in use internally, without a single source of regularly updated documentation for your API, you will be answering nonstop questions from anyone using it.</p>

<p class="calibre3">If the API is public then… well, without documentation nobody will use your API at all, which could drastically affect the successes of your company. Integration with services via an API is a very important factor for many companies these days, from startups to huge corporations, so do not go through the trouble of building something amazing only to have it completely ignored due to a lack of documentation.</p>

<h3 id="calibre_link-69" class="calibre2">
<span class="section-number">11.2 </span>Types of Documentation</h3>

<p class="calibre3">There should be a few different types of documentation:</p>

<h4 id="calibre_link-168" class="calibre4">API Reference</h4>

<p class="calibre3">The “API Reference” is sometimes referred to as “Endpoint Reference”. This is essentially a list of all endpoints (and their associated HTTP Methods), descriptions of what they do and a list of all arguments that can be passed, with descriptions about what values work and in what format those values could be. That is a lot of work, but it can be made easier with some tools. More on that later.</p>

<h4 id="calibre_link-169" class="calibre4">Sample Code</h4>

<p class="calibre3">“Sample Code” is generally just a case of building one or two libraries or code packages in different languages, documenting <em class="calibre19">their</em> API with tools like <a href="http://phpdoc.org/">phpDocumentor</a>, and showing lots of common scenarios covering the basics of how that code works. Examples could include “Search venues by name” and “Create a check-in with a photograph”. These examples reduce the mental barrier for a developer because they can see concrete examples in a language familiar to them, instead of being forced to think in terms of HTTP requests.</p>

<p class="calibre3">Despite your own personal preferences, please, for the love of every god in the world, make your sample code look as good as you can in each language. Words cannot express how frustrating it is when some Ruby developer smashes out some <em class="calibre19">awful</em> PHP code - because they are bad with PHP - and passes that off as a finished product.</p>

<p class="calibre3">Regardless of the language, most sample code should look very similar. This has the benefit of letting users switch between languages without having to learn a new code package from scratch. PHP, Ruby and Python all have blocks or callbacks, objects and hashes, support variadics and have some concept of namespaces. One day, PHP will also support named parameters. One day.</p>

<h4 id="calibre_link-170" class="calibre4">Guides or Tutorials</h4>

<p class="calibre3">This is the easiest of the lot. Take a subject like “Authentication” and talk through it like a blog post. Images, diagrams, code examples of the libraries handling various situations in one or multiple languages using tabs, etc. Some people show examples using command line curl, but that can get pretty nasty as curl is not exactly known for being an interface full of sugar.</p>

<p class="calibre3">A great example of a set of tutorials is the <a href="http://developers.soundcloud.com/docs/api/guide">SoundCloud API</a>. Their “Using the API” page is a central resource which links to the API Reference, for those who want to get their hands dirty; it also contains simple scenarios like ‘Uploading Audio Files’ in multiple languages.</p>


<figure class="image">
  <img src="images/000017.png" alt="SoundCloud API Documentation - &quot;Using the API&quot;" class="calibre30" />
  <figcaption class="calibre31">SoundCloud API Documentation - “Using the API”</figcaption>
</figure>


<p class="calibre3">If you check out the examples here, Ruby, Python and PHP all look nearly identical (although I am not sure what happened to JavaScript).</p>

<p class="calibre3">Writing these guides takes a bit of time, but that time will be given back in buckets, saving you answering the same questions over and over again. The other time saver is for when future you forgets how things work in three months, or you come back from a holiday rather frazzled and need a tutorial to guide you through how things work. The amount of times I have Google searched a problem and found a blog I have written a few months ago answering it… it happens.</p>

<p class="calibre3">There are plenty of great tools around for static text-based documentation like this. Generally any Markdown -&gt; HTML static
site generator works well; <a href="https://sculpin.io">Sculpin</a> (PHP), <a href="https://github.com/jekyll/jekyll">Jekyll</a> (Ruby) and <a href="http://ringce.com/hyde">Hyde</a> (Python) all do this as well as each other.</p>

<h3 id="calibre_link-70" class="calibre2">
<span class="section-number">11.3 </span>Picking a Tool</h3>

<p class="calibre3">There are no doubt multiple tools out there for generating your API/Endpoint documentation. Some recommend a system called <a href="https://helloreverb.com/developers/swagger">Swagger</a>, which is a great looking tool and works with a <em class="calibre19">huge</em> array of languages. Sadly, to me it seems to be somewhat of a black art.</p>

<p class="calibre3">Swagger defines a specification and various language or framework specific implementations come up with their own solution. For PHP, the way you go about this is through a rather confusing (and poorly documented) set of annotations with strange names. Furthermore, it requires you to distribute these annotations throughout a large chunk of your application, including data mapper style models, which you might not even have. It wanted property level annotations, and neither my models or Fractal transformers have properties, so this was a wild and wacky way to try and work.</p>

<p class="calibre3">Another tool called <a href="http://apiary.io/blueprint">API Blueprint</a> takes care of this nicely. A company called <a href="http://apiary.io">Apiary</a> released this tool as 
open-source, and as their entire company is about API generation, it seems like rather a good fit.</p>

<h3 id="calibre_link-71" class="calibre2">
<span class="section-number">11.4 </span>Setting up API Blueprint and Aglio</h3>

<p class="calibre3">API Blueprint has a very easy to understand set of <a href="http://apiblueprint.org/#get-started">Getting Started instructions</a>, which
has a series of approaches to creating your documentation with various languages and tool combinations. They are working on a
Ruby utility and .NET seems to be covered. Sublime Text has <a href="https://github.com/apiaryio/api-blueprint-sublime-plugin">a plugin</a>, but by far the easiest is the command-line executable
called <a href="https://github.com/danielgtaylor/aglio">Aglio</a>.</p>

<p class="calibre3">There is one caveat &mdash; this tool uses NodeJS. That sounds like a blocker to some but it should not be. Only the command-line utility
requires NodeJS, much like some command-line tools require Ruby or Python. Install NodeJS and move along to the next bit.</p>

<p class="calibre3">
  <strong class="calibre22">Step 1: Install NodeJS</strong>
</p>

<p class="calibre3">If you are using OSX then <a href="http://brew.sh">Homebrew</a> makes this very easy:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code>brew install node
</pre></div>

</figure>

<p class="calibre3">Otherwise the <a href="http://nodejs.org">NodeJS</a> website has instructions for your operating system.</p>

<p class="calibre3">
  <strong class="calibre22">Step 2: Install Aglio</strong>
</p>

<p class="calibre3">Install this utility as a command-line executable:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code>npm install -g aglio
</pre></div>

</figure>

<p class="calibre3">The <code class="calibre15">-g</code> switch installs the utility globally, instead of just into the current folder.</p>

<p class="calibre3">
  <strong class="calibre22">Step 3: Generate Example Docs with Aglio</strong>
</p>

<p class="calibre3">The sample code for the book includes the Aglio example Markdown file that will help to illustrate how easy it is to generate
documentation HTML:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code><code class="nb">cd</code> ~/apisyouwonthate/chapter11/aglio-example
<code class="lineno">2</code> <code class="nv">$ </code>aglio -i example.md -o index.html
</pre></div>

</figure>

<p class="calibre3">
  <strong class="calibre22">Step 4: Generate HTML and Open in Browser</strong>
</p>

<p class="calibre3">Create some sort of web server (XAMPP, WAMP, MAMP, Pow, shove it on FTP or whatever) and view the contents. This book has used
PHP as an example before, so let us continue that trend:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code>php -S localhost:8001
</pre></div>

</figure>

<p class="calibre3">Now browse to that address in your favourite browser and you should see some very attractive sample output.</p>


<figure class="image">
  <img src="images/000003.png" alt="Example output of Aglio generated HTML" class="calibre30" />
  <figcaption class="calibre31">Example output of Aglio generated HTML</figcaption>
</figure>


<p class="calibre3">Looks amazing, right?</p>

<p class="calibre3">
  <strong class="calibre22">Step 5: Find a Plugin</strong>
</p>

<p class="calibre3">Writing Markdown then switching over to the terminal and running a command can be a tricky workflow, so try
and find a plugin for an editor you like which can help. If you use <a href="https://atom.io/">Atom</a> then there is <a href="https://atom.io/packages/api-blueprint-preview">an Atom plugin</a>
you can use, but there are doubtless other options available.</p>

<h3 id="calibre_link-72" class="calibre2">
<span class="section-number">11.5 </span>Learning API Blueprint Syntax</h3>

<p class="calibre3">To make the output reflect your API documentation, the Markdown source files will need updating. While
they are generally just Markdown, there is a specific format to this, known as “API Blueprint
format 1A”.</p>

<p class="calibre3">Go to the following location and open up <code class="calibre15">example.md</code>:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code><code class="nb">cd</code> ~/apisyouwonthate/chapter11/place-example
</pre></div>

</figure>

<p class="calibre3">The rest of this section will walk through this <code class="calibre15">example.md</code> and explain what various parts mean.</p>

<h4 id="calibre_link-171" class="calibre4">Metadata</h4>

<p class="calibre3">This is simple. The API title, URL, introduction, etc. is just some Markdown:</p>

<figure class="code">
  <figcaption class="calibre20">Very start of an API Blueprint markdown file, showing metadata</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">FORMAT</code><code class="o">:</code> <code class="o">1</code><code class="calibre15">A</code>
<code class="lineno"> 2</code> <code class="calibre15">HOST</code><code class="o">:</code> <code class="calibre15">https</code><code class="o">://</code><code class="calibre15">api</code><code class="o">.</code><code class="na">example</code><code class="o">.</code><code class="na">com</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code> <code class="err">#</code> <code class="calibre15">FakeSquare</code> <code class="calibre15">API</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code> <code class="calibre15">This</code> <code class="k">is</code> <code class="calibre15">documentation</code> <code class="k">for</code> <code class="calibre15">the</code> <code class="calibre15">theoretical</code> <code class="calibre15">check</code><code class="o">-</code><code class="k">in</code> <code class="calibre15">app</code> <code class="calibre15">API</code> <code class="calibre15">that</code> <code class="calibre15">has</code> <code class="calibre15">been</code> <code class="calibre15">built</code>
<code class="lineno"> 7</code> <code class="calibre15">throughout</code> <code class="calibre15">the</code> <code class="calibre15">book</code> <code class="o">[</code><code class="calibre15">Build</code> <code class="calibre15">APIs</code> <code class="calibre15">You</code> <code class="calibre15">Won</code><code class="s">'t Hate].</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code> <code class="s">[Build APIs You Won'</code><code class="calibre15">t</code> <code class="calibre15">Hate</code><code class="o">]:</code> <code class="calibre15">https</code><code class="o">://</code><code class="calibre15">leanpub</code><code class="o">.</code><code class="na">com</code><code class="o">/</code><code class="calibre15">build</code><code class="o">-</code><code class="calibre15">apis</code><code class="o">-</code><code class="calibre15">you</code><code class="o">-</code><code class="calibre15">wont</code><code class="o">-</code><code class="calibre15">hate</code>
<code class="lineno">10</code> 
<code class="lineno">11</code> <code class="err">##</code> <code class="calibre15">Authorization</code>
<code class="lineno">12</code> 
<code class="lineno">13</code> <code class="calibre15">This</code> <code class="calibre15">could</code> <code class="calibre15">be</code> <code class="calibre15">anything</code><code class="o">,</code> <code class="calibre15">but</code> <code class="calibre15">it</code> <code class="calibre15">seems</code> <code class="calibre15">like</code> <code class="calibre15">a</code> <code class="calibre15">good</code> <code class="calibre15">place</code>
<code class="lineno">14</code> <code class="calibre15">to</code> <code class="calibre15">explain</code> <code class="calibre15">how</code> <code class="calibre15">access</code> <code class="calibre15">tokens</code> <code class="calibre15">work</code><code class="o">.</code>
<code class="lineno">15</code> 
<code class="lineno">16</code> <code class="calibre15">Most</code> <code class="calibre15">endpoints</code> <code class="k">in</code> <code class="calibre15">the</code> <code class="calibre15">FakeSquare</code> <code class="calibre15">API</code> <code class="calibre15">will</code> <code class="calibre15">require</code> <code class="calibre15">the</code> <code class="err">`</code><code class="calibre15">Authorization</code><code class="err">`</code> <code class="calibre15">HTTP</code> <code class="calibre15">header</code><code class="o">.</code>
<code class="lineno">17</code> 
<code class="lineno">18</code> <code class="err">```</code><code class="calibre15">http</code>
<code class="lineno">19</code> <code class="calibre15">Authorization</code><code class="o">:</code> <code class="calibre15">bearer</code> <code class="calibre15">vr5HmMkzlxKE70W1y4MibiJUusZwZC25NOVBEx3BD1</code>
<code class="lineno">20</code> <code class="err">```</code>
<code class="lineno">21</code> 
<code class="lineno">22</code> <code class="calibre15">Failing</code> <code class="calibre15">to</code> <code class="k">do</code> <code class="calibre15">so</code> <code class="calibre15">will</code> <code class="calibre15">cause</code> <code class="calibre15">the</code> <code class="calibre15">following</code> <code class="calibre15">error</code><code class="o">:</code>
<code class="lineno">23</code> 
<code class="lineno">24</code> <code class="err">```</code><code class="calibre15">json</code>
<code class="lineno">25</code> <code class="o">{</code>
<code class="lineno">26</code>   <code class="s">"error"</code> <code class="o">:</code> <code class="o">{</code>
<code class="lineno">27</code>     <code class="s">"code"</code> <code class="o">:</code> <code class="s">"GEN-MAYBGTFO"</code><code class="o">,</code>
<code class="lineno">28</code>     <code class="s">"http_code"</code> <code class="o">:</code> <code class="o">401</code><code class="o">,</code>
<code class="lineno">29</code>     <code class="s">"message"</code> <code class="o">:</code> <code class="s">"Unauthorized"</code>
<code class="lineno">30</code>   <code class="o">}</code>
<code class="lineno">31</code> <code class="o">}</code>
<code class="lineno">32</code> <code class="err">```</code>
<code class="lineno">33</code> 
<code class="lineno">34</code> <code class="calibre15">Or</code> <code class="calibre15">something</code><code class="o">.</code> <code class="calibre15">This</code> <code class="k">is</code> <code class="calibre15">mostly</code> <code class="calibre15">just</code> <code class="calibre15">an</code> <code class="calibre15">introduction</code><code class="o">,</code> <code class="calibre15">so</code> <code class="calibre15">provide</code> <code class="calibre15">links</code> <code class="calibre15">to</code> <code class="calibre15">tutorial</code>
<code class="lineno">35</code> <code class="calibre15">sections</code> <code class="calibre15">elsewhere</code> <code class="calibre15">on</code> <code class="calibre15">your</code> <code class="calibre15">site</code><code class="o">.</code>
</pre></div>

</figure>

<p class="calibre3">A very quick and easy introduction showing the name of the API (<code class="calibre15">FakeSquare API</code>) and a
basic example of how to authenticate a request with our API.</p>

<h4 id="calibre_link-172" class="calibre4">Resource Groups</h4>

<p class="calibre3">To keep this simple but also cover a lot of different usages, we will take examples from the action
plan in <a href="#calibre_link-10">Chapter 2: Planning and Creating Endpoints</a> for Places, and document them in
API Blueprint syntax.</p>

<blockquote class="calibre17">
  <p class="calibre3">Places<br class="calibre6" />
- Create<br class="calibre6" />
- Read<br class="calibre6" />
- Update<br class="calibre6" />
- Delete<br class="calibre6" />
- List (lat, lon, distance or box)<br class="calibre6" />
- Image</p>
</blockquote>

<p class="calibre3">Using the same logic in chapter 2 as we used to outline the <code class="calibre15">user</code> endpoints, we can assume these endpoints:</p>

<table class="calibre24">
  <thead class="calibre25">
    <tr class="calibre26">
      <th class="calibre27">Action</th>
      <th class="calibre27">Endpoint</th>
    </tr>
  </thead>
  <tbody class="calibre28">
    <tr class="calibre26">
      <td class="calibre29">Create</td>
      <td class="calibre29"><code class="calibre15">POST /places</code></td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Read</td>
      <td class="calibre29"><code class="calibre15">GET /places/X</code></td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Update</td>
      <td class="calibre29"><code class="calibre15">PUT /places/X</code></td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Delete</td>
      <td class="calibre29"><code class="calibre15">DELETE /places/X</code></td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">List</td>
      <td class="calibre29"><code class="calibre15">GET /places</code></td>
    </tr>
    <tr class="calibre26">
      <td class="calibre29">Image</td>
      <td class="calibre29"><code class="calibre15">PUT /places/X/image</code></td>
    </tr>
  </tbody>

</table>

<p class="calibre3">Everything at or below the <code class="calibre15">/places</code> level is considered a “Resource Group” by API Blueprint, so our new example
will only have one group.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="cp"># Group Places</code>
<code class="lineno">2</code> <code class="calibre15">Search</code> <code class="calibre15">and</code> <code class="calibre15">manage</code> <code class="calibre15">places</code><code class="calibre15">.</code>
</pre></div>

</figure>

<p class="calibre3">That first line has the reserved keyword <code class="calibre15">Group</code> that will be removed from output. The <code class="calibre15">Places</code> is
the name of the group. The line below is an optional description for humans.</p>

<p class="calibre3">In a real API you would have more groups. <code class="calibre15">Users</code>, <code class="calibre15">Check-ins</code>, <code class="calibre15">Posts</code>, etc.</p>

<h4 id="calibre_link-173" class="calibre4">Resources</h4>

<p class="calibre3">API Blueprint accepts multiple resource sections per group section, and considers <code class="calibre15">/places</code>, <code class="calibre15">/places/X</code> and
<code class="calibre15">/places/X/image</code> to be different resources. You probably consider <code class="calibre15">/places</code> to be more of a collection
of resources, and consider <code class="calibre15">/places/X/image</code> to be a subresource, but API Blueprint considers them all
“Resources”.</p>

<p class="calibre3">Not a problem. Simply make some h2 tags using the <code class="calibre15">##</code> prefix:</p>

<figure class="code">
  <figcaption class="calibre20">Example outline of multiple ‘Resource Sections’.</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="cp">## Place List [/places{?lat}{&amp;lon}{&amp;distance}{&amp;box}{&amp;number}{&amp;page}]</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code> <code class="cp">## Create new place [/places]</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> <code class="cp">## Places [/places/{id}]</code>
<code class="lineno"> 8</code> <code class="calibre15">Manage</code> <code class="calibre15">an</code> <code class="calibre15">existing</code> <code class="calibre15">place</code><code class="calibre15">.</code>
<code class="lineno"> 9</code> 
<code class="lineno">10</code> 
<code class="lineno">11</code> <code class="cp">## Place Images [/places/{id}/image]</code>
<code class="lineno">12</code> <code class="calibre15">Places</code> <code class="calibre15">can</code> <code class="calibre15">have</code> <code class="calibre15">an</code> <code class="calibre15">image</code> <code class="calibre15">associated</code> <code class="calibre15">with</code> <code class="calibre15">them</code><code class="calibre15">,</code> <code class="calibre15">which</code> <code class="calibre15">will</code> <code class="calibre15">act</code> <code class="calibre15">as</code> <code class="calibre15">a</code> <code class="calibre15">cover</code> <code class="calibre15">photo</code> 
<code class="lineno">13</code> <code class="calibre15">or</code> <code class="calibre15">photograph</code><code class="calibre15">.</code>
</pre></div>

</figure>

<p class="calibre3">Here we have four “Resource Sections”, each for a different resource. The one oddity here
is that there are two entries for <code class="calibre15">/places</code>. The reasoning here is that each “Resource
Group” has its own “URI Template”. No two groups can have the same template (two with <code class="calibre15">/places</code>
would error) and if you want to document parameters then you need to put them in the template.</p>

<p class="calibre3">It seems odd, but just go with it.</p>

<ol class="calibre13">
  <li class="calibre14">One resource section for listing (with the filter/query/search parameters listed)</li>
  <li class="calibre14">One resource section for creating a new item on a collection</li>
  <li class="calibre14">One resource section for a single item</li>
  <li class="calibre14">One resource section for each and every subresource your API may have on an item</li>
</ol>

<h4 id="calibre_link-174" class="calibre4">Resource Actions</h4>

<p class="calibre3">Actions are what you would expect them to be - the actions outlined in the action plan.</p>

<p class="calibre3">You can spot an action in two ways. Firstly due to the h3 header (<code class="calibre15">###</code>) and secondly by the
trailing <code class="calibre15">[GET]</code> HTTP verb notation.</p>

<figure class="code">
  <figcaption class="calibre20">Example of the ‘Place List’ resource using API Blueprint Markdown</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="cp">## Place List [/places{?lat}{&amp;lon}{&amp;distance}{&amp;box}{&amp;number}{&amp;page}]</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="cp">### Get places [GET]</code>
<code class="lineno"> 4</code> <code class="calibre15">Locate</code> <code class="calibre15">places</code> <code class="calibre15">close</code> <code class="calibre15">to</code> <code class="calibre15">a</code> <code class="calibre15">certain</code> <code class="calibre15">set</code> <code class="calibre15">of</code> <code class="calibre15">coordinates</code><code class="calibre15">,</code> <code class="calibre15">or</code> <code class="calibre15">provide</code> <code class="calibre15">a</code> <code class="calibre15">box</code> <code class="calibre15">of</code> <code class="calibre15">coordinates</code> \
<code class="lineno"> 5</code> <code class="calibre15">to</code> <code class="calibre15">search</code> <code class="calibre15">within</code><code class="calibre15">.</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> <code class="o">+</code> <code class="calibre15">Parameters</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>     <code class="o">+</code> <code class="calibre15">lat</code> <code class="calibre15">(</code><code class="calibre15">optional</code><code class="calibre15">,</code> <code class="calibre15">number</code><code class="calibre15">,</code> <code class="err">`</code><code class="o">40.7641</code><code class="err">`</code><code class="calibre15">)</code> <code class="calibre15">...</code> <code class="calibre15">Latitude</code> <code class="calibre15">to</code> <code class="calibre15">search</code> <code class="calibre15">near</code><code class="calibre15">,</code> <code class="calibre15">with</code> <code class="calibre15">any</code> <code class="calibre15">accuracy</code>
<code class="lineno">10</code>     <code class="o">+</code> <code class="calibre15">lon</code> <code class="calibre15">(</code><code class="calibre15">optional</code><code class="calibre15">,</code> <code class="calibre15">number</code><code class="calibre15">,</code> <code class="err">`</code><code class="o">-</code><code class="o">73.9866</code><code class="err">`</code><code class="calibre15">)</code> <code class="calibre15">...</code> <code class="calibre15">Longitude</code> <code class="calibre15">to</code> <code class="calibre15">search</code> <code class="calibre15">near</code><code class="calibre15">,</code> <code class="calibre15">with</code> <code class="calibre15">any</code> <code class="calibre15">accur</code>\
<code class="lineno">11</code> <code class="calibre15">acy</code>
<code class="lineno">12</code>     <code class="o">+</code> <code class="calibre15">distance</code> <code class="o">=</code> <code class="err">`</code><code class="o">10</code><code class="err">`</code> <code class="calibre15">(</code><code class="calibre15">optional</code><code class="calibre15">,</code> <code class="calibre15">number</code><code class="calibre15">,</code> <code class="err">`</code><code class="o">20</code><code class="err">`</code><code class="calibre15">)</code> <code class="calibre15">...</code> <code class="calibre15">The</code> <code class="calibre15">radius</code> <code class="calibre15">size</code> <code class="calibre15">in</code> <code class="calibre15">miles</code> <code class="calibre15">to</code> <code class="calibre15">search</code>\
<code class="lineno">13</code>  <code class="k">for</code> <code class="calibre15">from</code> <code class="calibre15">lat</code> <code class="calibre15">and</code> <code class="calibre15">lon</code> <code class="calibre15">coordinates</code>
<code class="lineno">14</code>     <code class="o">+</code> <code class="calibre15">box</code> <code class="calibre15">(</code><code class="calibre15">optional</code><code class="calibre15">,</code> <code class="calibre15">string</code><code class="calibre15">,</code> <code class="err">`</code><code class="o">40.7641</code><code class="calibre15">,</code><code class="o">-</code><code class="o">73.9866</code><code class="calibre15">,</code><code class="o">40.7243</code><code class="calibre15">,</code><code class="o">-</code><code class="o">73.9841</code><code class="err">`</code><code class="calibre15">)</code> <code class="calibre15">...</code> <code class="calibre15">Top</code> <code class="calibre15">left</code> <code class="calibre15">latitu</code>\
<code class="lineno">15</code> <code class="calibre15">de</code><code class="calibre15">,</code> <code class="calibre15">top</code> <code class="calibre15">left</code> <code class="calibre15">longitude</code><code class="calibre15">,</code> <code class="calibre15">bottom</code> <code class="calibre15">right</code> <code class="calibre15">latitude</code><code class="calibre15">,</code> <code class="calibre15">bottom</code> <code class="calibre15">right</code> <code class="calibre15">longitude</code>
<code class="lineno">16</code>     <code class="o">+</code> <code class="calibre15">number</code> <code class="calibre15">(</code><code class="calibre15">optional</code><code class="calibre15">,</code> <code class="calibre15">integer</code><code class="calibre15">,</code> <code class="err">`</code><code class="o">15</code><code class="err">`</code><code class="calibre15">)</code> <code class="calibre15">...</code> <code class="calibre15">The</code> <code class="calibre15">number</code> <code class="calibre15">of</code> <code class="calibre15">results</code> <code class="calibre15">to</code> <code class="k">return</code> <code class="calibre15">per</code> <code class="calibre15">page</code>
<code class="lineno">17</code>     <code class="o">+</code> <code class="calibre15">page</code> <code class="o">=</code> <code class="err">`</code><code class="o">1</code><code class="err">`</code> <code class="calibre15">(</code><code class="calibre15">optional</code><code class="calibre15">,</code> <code class="calibre15">integer</code><code class="calibre15">,</code> <code class="err">`</code><code class="o">15</code><code class="err">`</code><code class="calibre15">)</code> <code class="calibre15">...</code> <code class="calibre15">Which</code> <code class="calibre15">page</code> <code class="calibre15">of</code> <code class="calibre15">the</code> <code class="calibre15">result</code> <code class="calibre15">data</code> <code class="calibre15">to</code> <code class="k">return</code>
<code class="lineno">18</code> 
<code class="lineno">19</code> <code class="o">+</code> <code class="calibre15">Response</code> <code class="o">200</code> <code class="calibre15">(</code><code class="calibre15">application</code><code class="o">/</code><code class="calibre15">json</code><code class="calibre15">)</code>
<code class="lineno">20</code> 
<code class="lineno">21</code>         <code class="calibre15">{</code>
<code class="lineno">22</code>             <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno">23</code>                 <code class="calibre15">{</code>
<code class="lineno">24</code>                     <code class="s">"id"</code><code class="o">:</code> <code class="o">2</code><code class="calibre15">,</code>
<code class="lineno">25</code>                     <code class="s">"name"</code><code class="o">:</code> <code class="s">"Videology"</code><code class="calibre15">,</code>
<code class="lineno">26</code>                     <code class="s">"lat"</code><code class="o">:</code> <code class="o">40.713857</code><code class="calibre15">,</code>
<code class="lineno">27</code>                     <code class="s">"lon"</code><code class="o">:</code> <code class="o">-</code><code class="o">73.961936</code><code class="calibre15">,</code>
<code class="lineno">28</code>                     <code class="s">"created_at"</code><code class="o">:</code> <code class="s">"2013-04-02"</code>
<code class="lineno">29</code>                 <code class="calibre15">},</code>
<code class="lineno">30</code>                 <code class="calibre15">{</code>
<code class="lineno">31</code>                     <code class="s">"id"</code><code class="o">:</code> <code class="o">1</code><code class="calibre15">,</code>
<code class="lineno">32</code>                     <code class="s">"name"</code><code class="o">:</code> <code class="s">"Barcade"</code><code class="calibre15">,</code>
<code class="lineno">33</code>                     <code class="s">"lat"</code><code class="o">:</code> <code class="o">40.712017</code><code class="calibre15">,</code>
<code class="lineno">34</code>                     <code class="s">"lon"</code><code class="o">:</code> <code class="o">-</code><code class="o">73.950995</code><code class="calibre15">,</code>
<code class="lineno">35</code>                     <code class="s">"created_at"</code><code class="o">:</code> <code class="s">"2012-09-23"</code>
<code class="lineno">36</code>                 <code class="calibre15">}</code>
<code class="lineno">37</code>             <code class="calibre15">]</code>
<code class="lineno">38</code>         <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">This is the first resource section, now filled out. It lists the available
parameters for the URL with a very special syntax:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">+</code> <code class="o">&lt;</code><code class="calibre15">parameter</code> <code class="calibre15">name</code><code class="o">&gt;</code><code class="calibre15">:</code> <code class="s">`&lt;example value&gt;`</code> <code class="calibre15">(</code><code class="o">&lt;</code><code class="k">type</code><code class="o">&gt;</code> <code class="o">|</code> <code class="calibre15">enum</code><code class="err">[</code><code class="o">&lt;</code><code class="k">type</code><code class="o">&gt;</code><code class="cp">]</code>, required | optional) 
<code class="lineno"> 2</code>   - <code class="k">&lt;description&gt;</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code>     <code class="k">&lt;additional</code> <code class="na">description</code><code class="k">&gt;</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code>     + Default: `<code class="k">&lt;default</code> <code class="na">value</code><code class="k">&gt;</code>`
<code class="lineno"> 7</code> 
<code class="lineno"> 8</code>     + Members
<code class="lineno"> 9</code>         + `<code class="k">&lt;enumeration</code> <code class="na">value</code> <code class="na">1</code><code class="k">&gt;</code>` - <code class="k">&lt;enumeration</code> <code class="na">description</code> <code class="na">1</code><code class="k">&gt;</code>
<code class="lineno">10</code>         + `<code class="k">&lt;enumeration</code> <code class="na">value</code> <code class="na">2</code><code class="k">&gt;</code>` - <code class="k">&lt;enumeration</code> <code class="na">description</code> <code class="na">2</code><code class="k">&gt;</code>
<code class="lineno">11</code>         ...
<code class="lineno">12</code>         + `<code class="k">&lt;enumeration</code> <code class="na">value</code> <code class="na">N</code><code class="k">&gt;</code>` - <code class="k">&lt;enumeration</code> <code class="na">description</code> <code class="na">N</code><code class="k">&gt;</code>
</pre></div>

</figure>

<p class="calibre3">Our example has used slightly shorter syntax and skipped the additional description and enum values, but it takes advantage
of much of the first line.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="o">+</code> <code class="calibre15">lat</code><code class="o">:</code> <code class="err">`</code><code class="o">40.7641</code><code class="err">`</code> <code class="calibre15">(</code><code class="calibre15">number</code><code class="calibre15">,</code> <code class="calibre15">optional</code><code class="calibre15">)</code> <code class="o">-</code> <code class="calibre15">Latitude</code> <code class="calibre15">to</code> <code class="calibre15">search</code> <code class="calibre15">near</code><code class="calibre15">,</code> <code class="calibre15">with</code> <code class="calibre15">any</code> <code class="calibre15">accuracy</code>
</pre></div>

</figure>

<p class="calibre3">This explains that the field is numeric, it is optional, and shows an example value of <code class="calibre15">40.7641</code>.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="o">+</code> <code class="calibre15">page</code><code class="o">:</code> <code class="err">`</code><code class="o">1</code><code class="err">`</code> <code class="calibre15">(</code><code class="calibre15">integer</code><code class="calibre15">,</code> <code class="calibre15">optional</code><code class="calibre15">)</code> <code class="o">-</code> <code class="calibre15">Which</code> <code class="calibre15">page</code> <code class="calibre15">of</code> <code class="calibre15">the</code> <code class="calibre15">result</code> <code class="calibre15">data</code> <code class="calibre15">to</code> <code class="k">return</code>
<code class="lineno">2</code>     <code class="o">+</code> <code class="calibre15">Default</code><code class="o">:</code> <code class="err">`</code><code class="o">15</code><code class="err">`</code>
</pre></div>

</figure>

<p class="calibre3">Similar, but this time a default value has been added which in the case of pagination will probably be <code class="calibre15">1</code>.</p>

<p class="calibre3">The rest of this action section is responses.</p>

<figure class="code">
  <figcaption class="calibre20">Show an example response for a specific content type.</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno">1</code> <code class="o">+</code> <code class="calibre15">Response</code> <code class="o">200</code> <code class="calibre15">(</code><code class="calibre15">application</code><code class="o">/</code><code class="calibre15">json</code><code class="calibre15">)</code>
<code class="lineno">2</code> 
<code class="lineno">3</code>         <code class="calibre15">{</code> <code class="calibre15">...</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">This says that you can expect a <code class="calibre15">200</code> status, which will be <code class="calibre15">Content-Type: application/json</code> and shows an example of the body content.</p>

<p class="calibre3">Now if we run Aglio again and serve it up through a web server:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="nv">$ </code>aglio -i example.md -o index.html
<code class="lineno">2</code> <code class="nv">$ </code>php -S localhost:8001
</pre></div>

</figure>


<figure class="image">
  <img src="images/000012.png" alt="Example output of Aglio generated HTML" class="calibre30" />
  <figcaption class="calibre31">Example output of Aglio generated HTML</figcaption>
</figure>


<p class="calibre3">How amazing is that for such a little amount of Markdown? Doing all of that manually would certainly not be any fun.</p>

<h4 id="calibre_link-175" class="calibre4">Requests</h4>

<p class="calibre3">Documenting the request content and offering examples is, of course, one of the most important parts of any
API documentation and API Blueprint does not disappoint.</p>

<p class="calibre3">API Blueprint will allow you to create multiple request examples for an action. Looking at the <code class="calibre15">Place Images</code> resource
will outline how this is done:</p>

<figure class="code">
  <figcaption class="calibre20">Example of the ‘Place Images’ resource.</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="cp">## Place Images [/places/{id}/image]</code>
<code class="lineno"> 2</code> <code class="calibre15">Places</code> <code class="calibre15">can</code> <code class="calibre15">have</code> <code class="calibre15">an</code> <code class="calibre15">image</code> <code class="calibre15">associated</code> <code class="calibre15">with</code> <code class="calibre15">them</code><code class="calibre15">,</code> <code class="calibre15">which</code> <code class="calibre15">will</code> <code class="calibre15">act</code> <code class="calibre15">as</code> <code class="calibre15">a</code> <code class="calibre15">cover</code> <code class="calibre15">photo</code>
<code class="lineno"> 3</code> <code class="calibre15">or</code> <code class="calibre15">photograph</code><code class="calibre15">.</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code> <code class="o">+</code> <code class="calibre15">Parameters</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code>     <code class="o">+</code> <code class="calibre15">id</code> <code class="calibre15">(</code><code class="calibre15">integer</code><code class="calibre15">,</code> <code class="calibre15">required</code><code class="calibre15">)</code> <code class="o">-</code> <code class="calibre15">The</code> <code class="calibre15">unique</code> <code class="calibre15">identifier</code> <code class="calibre15">of</code> <code class="calibre15">a</code> <code class="calibre15">place</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code> <code class="cp">### Set place image [PUT]</code>
<code class="lineno">10</code> <code class="calibre15">Assign</code> <code class="calibre15">a</code> <code class="calibre15">new</code> <code class="calibre15">image</code> <code class="calibre15">or</code> <code class="calibre15">replace</code> <code class="calibre15">the</code> <code class="calibre15">existing</code> <code class="calibre15">image</code> <code class="k">for</code> <code class="calibre15">a</code> <code class="calibre15">place</code><code class="calibre15">.</code>
<code class="lineno">11</code> 
<code class="lineno">12</code> <code class="o">+</code> <code class="calibre15">Request</code> <code class="calibre15">(</code><code class="calibre15">image</code><code class="o">/</code><code class="calibre15">gif</code><code class="calibre15">)</code>
<code class="lineno">13</code> 
<code class="lineno">14</code>     <code class="o">+</code> <code class="calibre15">Headers</code>
<code class="lineno">15</code>             <code class="nl">Authorization:</code> <code class="calibre15">Bearer</code> <code class="calibre15">{</code><code class="calibre15">access</code> <code class="calibre15">token</code><code class="calibre15">}</code>
<code class="lineno">16</code>     <code class="o">+</code> <code class="calibre15">Body</code>
<code class="lineno">17</code>             <code class="o">&lt;</code><code class="calibre15">raw</code> <code class="calibre15">source</code> <code class="calibre15">of</code> <code class="calibre15">gif</code> <code class="calibre15">file</code><code class="o">&gt;</code>
<code class="lineno">18</code> 
<code class="lineno">19</code> <code class="o">+</code> <code class="calibre15">Request</code> <code class="calibre15">(</code><code class="calibre15">image</code><code class="o">/</code><code class="calibre15">jpeg</code><code class="calibre15">)</code>
<code class="lineno">20</code> 
<code class="lineno">21</code>     <code class="o">+</code> <code class="calibre15">Headers</code>
<code class="lineno">22</code>             <code class="nl">Authorization:</code> <code class="calibre15">Bearer</code> <code class="calibre15">{</code><code class="calibre15">access</code> <code class="calibre15">token</code><code class="calibre15">}</code>
<code class="lineno">23</code>     <code class="o">+</code> <code class="calibre15">Body</code>
<code class="lineno">24</code>             <code class="o">&lt;</code><code class="calibre15">raw</code> <code class="calibre15">source</code> <code class="calibre15">of</code> <code class="calibre15">jpeg</code> <code class="calibre15">file</code><code class="o">&gt;</code>
<code class="lineno">25</code> 
<code class="lineno">26</code> <code class="o">+</code> <code class="calibre15">Request</code> <code class="calibre15">(</code><code class="calibre15">image</code><code class="o">/</code><code class="calibre15">png</code><code class="calibre15">)</code>
<code class="lineno">27</code> 
<code class="lineno">28</code>     <code class="o">+</code> <code class="calibre15">Headers</code>
<code class="lineno">29</code> 
<code class="lineno">30</code>             <code class="nl">Authorization:</code> <code class="calibre15">Bearer</code> <code class="calibre15">{</code><code class="calibre15">access</code> <code class="calibre15">token</code><code class="calibre15">}</code>
<code class="lineno">31</code>     <code class="o">+</code> <code class="calibre15">Body</code>
<code class="lineno">32</code> 
<code class="lineno">33</code>             <code class="o">&lt;</code><code class="calibre15">raw</code> <code class="calibre15">source</code> <code class="calibre15">of</code> <code class="calibre15">png</code> <code class="calibre15">file</code><code class="o">&gt;</code>
</pre></div>

</figure>

<p class="calibre3">Here the <code class="calibre15">&lt;raw source of png file&gt;</code> stuff is just plain-text - because pasting in the contents
of an actual PNG file would not look great - but you can use JSON or anything else.</p>

<p class="calibre3">Having multiple request examples can be very important if you are unfortunate enough to be documenting
an API which supports more than one input format, like JSON and XML for instance.</p>

<h4 id="calibre_link-176" class="calibre4">Responses</h4>

<p class="calibre3">Each endpoint in your API will have one or more different responses. There will probably be one
or more 20xs, some 40xs, and maybe a few 50xs too.</p>

<figure class="code">
  <figcaption class="calibre20">An action response section with multiple error responses.</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="o">+</code> <code class="calibre15">Response</code> <code class="o">400</code> <code class="calibre15">(</code><code class="calibre15">application</code><code class="o">/</code><code class="calibre15">json</code><code class="calibre15">)</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code>         <code class="calibre15">{</code>
<code class="lineno"> 4</code>           <code class="s">"error"</code> <code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno"> 5</code>             <code class="s">"code"</code><code class="o">:</code> <code class="s">"GEN-FUBARGS"</code><code class="calibre15">,</code>
<code class="lineno"> 6</code>             <code class="s">"http_code"</code> <code class="o">:</code> <code class="o">400</code><code class="calibre15">,</code>
<code class="lineno"> 7</code>             <code class="s">"message"</code><code class="o">:</code> <code class="s">"Content-Type must be image/png, image/jpg or image/gif"</code>
<code class="lineno"> 8</code>           <code class="calibre15">}</code>
<code class="lineno"> 9</code>         <code class="calibre15">}</code>
<code class="lineno">10</code> 
<code class="lineno">11</code> <code class="o">+</code> <code class="calibre15">Response</code> <code class="o">404</code> <code class="calibre15">(</code><code class="calibre15">application</code><code class="o">/</code><code class="calibre15">json</code><code class="calibre15">)</code>
<code class="lineno">12</code> 
<code class="lineno">13</code>         <code class="calibre15">{</code>
<code class="lineno">14</code>           <code class="s">"error"</code> <code class="o">:</code> <code class="calibre15">{</code>
<code class="lineno">15</code>             <code class="s">"code"</code> <code class="o">:</code> <code class="s">"GEN-LIKETHEWIND"</code><code class="calibre15">,</code>
<code class="lineno">16</code>             <code class="s">"http_code"</code> <code class="o">:</code> <code class="o">404</code><code class="calibre15">,</code>
<code class="lineno">17</code>             <code class="s">"message"</code> <code class="o">:</code> <code class="s">"Resource Not Found"</code>
<code class="lineno">18</code>           <code class="calibre15">}</code>
<code class="lineno">19</code>         <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">A tricky thing here is that while your API might return a <code class="calibre15">400</code> code for multiple reasons, API
Blueprint will not be happy about having multiple responses listed with the same HTTP code.</p>

<p class="calibre3">This is only thrown in as a warning, and may only be related to Aglio and not API Blueprint itself, as
the documentation seems to display fine. Either put multiple body examples next to each other or
add multiple response items with the same code and ignore the warnings.</p>

<h3 id="calibre_link-73" class="calibre2">
<span class="section-number">11.6 </span>Further Reading</h3>

<p class="calibre3">The <code class="calibre15">example.md</code> file provided contains more examples than highlighted in this chapter.</p>

<p class="calibre3">There is more to learn on the <a href="https://github.com/apiaryio/api-blueprint">API Blueprint repository</a>, including <a href="https://github.com/apiaryio/api-blueprint/tree/master/examples">more examples</a>. Their wiki
has extensive documentation of the <a href="https://github.com/apiaryio/api-blueprint/wiki/API-Blueprint-Roadmap">API Blueprint Format syntax</a> too.</p>

<p class="calibre3">Between this chapter and those articles, you should be documenting your own APIs within no time.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-90">
<div class="calibre6">
<h2 id="calibre_link-74" class="calibre1">
<span class="section-number">12. </span>HATEOAS</h2>

<h3 id="calibre_link-75" class="calibre2">
<span class="section-number">12.1 </span>Introduction</h3>

<p class="calibre3">HATEOAS is a tricky subject to explain, but it is actually rather simple. It stands for Hypermedia as the
Engine of Application State, and is pronounced as either <em class="calibre19">hat-ee-os</em>, <em class="calibre19">hate O-A-S</em> or <em class="calibre19">hate-ee-ohs</em>; the latter of which
sounds a little like a cereal for API developers.</p>

<p class="calibre3">However you want to try and say it, it basically means two things for your API:</p>

<ol class="calibre13">
  <li class="calibre14">Content negotiation</li>
  <li class="calibre14">Hypermedia controls</li>
</ol>

<p class="calibre3">In my experience, content negotiation is one of the first things many API developers implement. When building
my CodeIgniter Rest-Server extension, it was the first feature I added, because hey, it is fun! Changing the
<code class="calibre15">Accept</code> header and seeing the <code class="calibre15">Content-Type</code> header in the response switch from JSON to XML or CSV is
great, and also super easy to do.</p>

<h3 id="calibre_link-76" class="calibre2">
<span class="section-number">12.2 </span>Content Negotiation</h3>

<p class="calibre3">Some self-proclaimed RESTful APIs (Twitter, you are to blame for this) handle content negotiation with file
extensions. Their URLs often look like:</p>

<ul class="calibre18">
  <li class="calibre14"><code class="calibre15">/statuses/show.json?id=210462857140252672</code></li>
  <li class="calibre14">
<code class="calibre15">/statuses/show.xml?id=210462857140252672</code> </li>
</ul>

<p class="calibre3">This is a bit of a misuse of the concept of a resource and forces users to know not only that the endpoint show exists, but that they must pick a content type extension and that the <code class="calibre15">id</code> parameter must be used.</p>

<p class="calibre3">A good API would simply have <code class="calibre15">/statuses/210462857140252672</code>. This has the dual benefit of letting the API respond with a default content type, or respecting the <code class="calibre15">Accept</code> header and either outputting the request content type or spitting out a <code class="calibre15">415</code> status code if the API does not support it. The second benefit is that the consumer does not need to know about <code class="calibre15">?id=</code>.</p>

<p class="calibre3">URIs are not supposed to be a bunch of folders and file names and an API is not a list of JSON files or XML files. They are a list of resources that can be represented in different formats depending on the <code class="calibre15">Accept</code> header, <strong class="calibre22">and nothing else</strong>.</p>

<figure class="code">
  <figcaption class="calibre20">A simple example of content negotiation requesting JSON</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">GET</code> <code class="o">/</code><code class="calibre15">places</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="nl">Host:</code> <code class="calibre15">localhost</code><code class="o">:</code><code class="o">8000</code>
<code class="lineno">3</code> <code class="nl">Accept:</code> <code class="calibre15">application</code><code class="o">/</code><code class="calibre15">json</code>
</pre></div>

</figure>

<p class="calibre3">A response would then contain JSON if the API supports JSON as an output format.</p>

<figure class="code">
  <figcaption class="calibre20">A shortened example of the HTTP response with JSON data</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code> <code class="o">200</code> <code class="calibre15">OK</code>
<code class="lineno"> 2</code> <code class="nl">Host:</code> <code class="calibre15">localhost</code><code class="o">:</code><code class="o">8000</code>
<code class="lineno"> 3</code> <code class="nl">Connection:</code> <code class="calibre15">close</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code> <code class="calibre15">{</code>
<code class="lineno"> 6</code>     <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno"> 7</code>         <code class="calibre15">{</code>
<code class="lineno"> 8</code>             <code class="s">"id"</code><code class="o">:</code> <code class="o">1</code><code class="calibre15">,</code>
<code class="lineno"> 9</code>             <code class="s">"name"</code><code class="o">:</code> <code class="s">"Mireille Rodriguez"</code><code class="calibre15">,</code>
<code class="lineno">10</code>             <code class="s">"lat"</code><code class="o">:</code> <code class="o">-</code><code class="o">84.147236</code><code class="calibre15">,</code>
<code class="lineno">11</code>             <code class="s">"lon"</code><code class="o">:</code> <code class="o">49.254065</code><code class="calibre15">,</code>
<code class="lineno">12</code>             <code class="s">"address1"</code><code class="o">:</code> <code class="s">"12106 Omari Wells Apt. 801"</code><code class="calibre15">,</code>
<code class="lineno">13</code>             <code class="s">"address2"</code><code class="o">:</code> <code class="s">""</code><code class="calibre15">,</code>
<code class="lineno">14</code>             <code class="s">"city"</code><code class="o">:</code> <code class="s">"East Romanberg"</code><code class="calibre15">,</code>
<code class="lineno">15</code>             <code class="s">"state"</code><code class="o">:</code> <code class="s">"VT"</code><code class="calibre15">,</code>
<code class="lineno">16</code>             <code class="s">"zip"</code><code class="o">:</code> <code class="o">20129</code><code class="calibre15">,</code>
<code class="lineno">17</code>             <code class="s">"website"</code><code class="o">:</code> <code class="s">"http://www.torpdibbert.com/"</code><code class="calibre15">,</code>
<code class="lineno">18</code>             <code class="s">"phone"</code><code class="o">:</code> <code class="s">"(029)331-0729x4259"</code>
<code class="lineno">19</code>         <code class="calibre15">},</code>
<code class="lineno">20</code>         <code class="calibre15">...</code>
<code class="lineno">21</code>     <code class="calibre15">]</code>
<code class="lineno">22</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Most popular APIs will support JSON by default, or maybe <em class="calibre19">only</em> JSON as our sample app has done so far.
This is not realistic, but has been done throughout the book so far, mainly for the sake of simplicity.</p>

<p class="calibre3">XML is still a tricky one to do as you need to require view files, and that is out of scope of this chapter.</p>

<p class="calibre3">YAML, however, is rather easy to achieve, so we can see how content negotiation works with a little change to
our app.</p>

<p class="calibre3">Check <code class="calibre15">~/apisyouwonthate/chapter12/</code> for the updated sample app.</p>

<p class="calibre3">The main change other than including the <a href="http://symfony.com/doc/current/components/yaml/introduction.html">Symfony YAML component</a> was to simply update the
<code class="calibre15">respondWithArray()</code> method to check the <code class="calibre15">Accept</code> header and react accordingly.</p>

<figure class="code">
  <figcaption class="calibre20">Updated respondWithArray() method with accept header detection</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="k">protected</code> <code class="k">function</code> <code class="nf">respondWithArray</code><code class="calibre15">(</code><code class="k">array</code> <code class="nv">$array</code><code class="calibre15">,</code> <code class="k">array</code> <code class="nv">$headers</code> <code class="o">=</code> <code class="calibre15">[])</code>
<code class="lineno"> 2</code> <code class="calibre15">{</code>
<code class="lineno"> 3</code>     <code class="c">// You will probably want to do something intelligent with charset if provided.</code>
<code class="lineno"> 4</code>     <code class="c">// This chapter just ignores everything and takes the main MIME type value</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code>     <code class="nv">$mimeParts</code> <code class="o">=</code> <code class="calibre15">(</code><code class="k">array</code><code class="calibre15">)</code> <code class="nb">explode</code><code class="calibre15">(</code><code class="s">';'</code><code class="calibre15">,</code> <code class="calibre15">Input</code><code class="o">::</code><code class="na">server</code><code class="calibre15">(</code><code class="s">'HTTP_ACCEPT'</code><code class="calibre15">));</code>
<code class="lineno"> 7</code>     <code class="nv">$mimeType</code> <code class="o">=</code> <code class="calibre15">strtolower</code><code class="calibre15">(</code><code class="nv">$mimeParts</code><code class="calibre15">[</code><code class="o">0</code><code class="calibre15">]);</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>     <code class="k">switch</code> <code class="calibre15">(</code><code class="nv">$mimeType</code><code class="calibre15">)</code> <code class="calibre15">{</code>
<code class="lineno">10</code>         <code class="k">case</code> <code class="s">'application/json'</code><code class="o">:</code>
<code class="lineno">11</code>             <code class="nv">$contentType</code> <code class="o">=</code> <code class="s">'application/json'</code><code class="calibre15">;</code>
<code class="lineno">12</code>             <code class="nv">$content</code> <code class="o">=</code> <code class="nb">json_encode</code><code class="calibre15">(</code><code class="nv">$array</code><code class="calibre15">);</code>
<code class="lineno">13</code>             <code class="k">break</code><code class="calibre15">;</code>
<code class="lineno">14</code> 
<code class="lineno">15</code>         <code class="k">case</code> <code class="s">'application/x-yaml'</code><code class="o">:</code>
<code class="lineno">16</code>             <code class="nv">$contentType</code> <code class="o">=</code> <code class="s">'application/x-yaml'</code><code class="calibre15">;</code>
<code class="lineno">17</code>             <code class="nv">$dumper</code> <code class="o">=</code> <code class="k">new</code> <code class="calibre15">YamlDumper</code><code class="calibre15">();</code>
<code class="lineno">18</code>             <code class="nv">$content</code> <code class="o">=</code> <code class="nv">$dumper</code><code class="o">-&gt;</code><code class="na">dump</code><code class="calibre15">(</code><code class="nv">$array</code><code class="calibre15">,</code> <code class="o">2</code><code class="calibre15">);</code>
<code class="lineno">19</code>             <code class="k">break</code><code class="calibre15">;</code>
<code class="lineno">20</code> 
<code class="lineno">21</code>         <code class="k">default</code><code class="o">:</code>
<code class="lineno">22</code>             <code class="nv">$contentType</code> <code class="o">=</code> <code class="s">'application/json'</code><code class="calibre15">;</code>
<code class="lineno">23</code>             <code class="nv">$content</code> <code class="o">=</code> <code class="nb">json_encode</code><code class="calibre15">([</code>
<code class="lineno">24</code>                 <code class="s">'error'</code> <code class="o">=&gt;</code> <code class="calibre15">[</code>
<code class="lineno">25</code>                     <code class="s">'code'</code> <code class="o">=&gt;</code> <code class="k">static</code><code class="o">::</code><code class="na">CODE_INVALID_MIME_TYPE</code><code class="calibre15">,</code>
<code class="lineno">26</code>                     <code class="s">'http_code'</code> <code class="o">=&gt;</code> <code class="o">406</code><code class="calibre15">,</code>
<code class="lineno">27</code>                     <code class="s">'message'</code> <code class="o">=&gt;</code> <code class="nb">sprintf</code><code class="calibre15">(</code><code class="s">'Content of type %s is not supported.'</code><code class="calibre15">,</code> <code class="nv">$mim</code><code class="calibre15">\</code>
<code class="lineno">28</code> <code class="calibre15">eType</code><code class="calibre15">),</code>
<code class="lineno">29</code>                 <code class="calibre15">]</code>
<code class="lineno">30</code>             <code class="calibre15">]);</code>
<code class="lineno">31</code>     <code class="calibre15">}</code>
<code class="lineno">32</code> 
<code class="lineno">33</code>     <code class="nv">$response</code> <code class="o">=</code> <code class="calibre15">Response</code><code class="o">::</code><code class="na">make</code><code class="calibre15">(</code><code class="nv">$content</code><code class="calibre15">,</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">statusCode</code><code class="calibre15">,</code> <code class="nv">$headers</code><code class="calibre15">);</code>
<code class="lineno">34</code>     <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">header</code><code class="calibre15">(</code><code class="s">'Content-Type'</code><code class="calibre15">,</code> <code class="nv">$contentType</code><code class="calibre15">);</code>
<code class="lineno">35</code> 
<code class="lineno">36</code>     <code class="k">return</code> <code class="nv">$response</code><code class="calibre15">;</code>
<code class="lineno">37</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Very basic, but now if we try a different MIME type we can expect a different result:</p>

<figure class="code">
  <figcaption class="calibre20">An HTTP request specifying the preferred response MIME type</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">GET</code> <code class="o">/</code><code class="calibre15">places</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="nl">Host:</code> <code class="calibre15">localhost</code><code class="o">:</code><code class="o">8000</code>
<code class="lineno">3</code> <code class="nl">Accept:</code> <code class="calibre15">application</code><code class="o">/</code><code class="calibre15">x</code><code class="o">-</code><code class="calibre15">yaml</code>
</pre></div>

</figure>

<p class="calibre3">The response will be in YAML.</p>

<figure class="code">
  <figcaption class="calibre20">A shortened example of the HTTP response with YAML data</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code> <code class="o">200</code> <code class="calibre15">OK</code>
<code class="lineno">2</code> <code class="nl">Host:</code> <code class="calibre15">localhost</code><code class="o">:</code><code class="o">8000</code>
<code class="lineno">3</code> <code class="nl">Connection:</code> <code class="calibre15">close</code>
<code class="lineno">4</code> 
<code class="lineno">5</code> <code class="nl">data:</code>
<code class="lineno">6</code>     <code class="o">-</code> <code class="calibre15">{</code> <code class="calibre15">id</code><code class="o">:</code> <code class="o">1</code><code class="calibre15">,</code> <code class="calibre15">name</code><code class="o">:</code> <code class="err">'</code><code class="calibre15">Mireille</code> <code class="calibre15">Rodriguez</code><code class="err">'</code><code class="calibre15">,</code> <code class="calibre15">lat</code><code class="o">:</code> <code class="o">-</code><code class="o">84.147236</code><code class="calibre15">,</code> <code class="calibre15">lon</code><code class="o">:</code> <code class="o">49.254065</code><code class="calibre15">,</code> <code class="calibre15">address1</code><code class="o">:</code>\
<code class="lineno">7</code>  <code class="err">'</code><code class="o">12106</code> <code class="calibre15">Omari</code> <code class="calibre15">Wells</code> <code class="calibre15">Apt</code><code class="calibre15">.</code> <code class="o">801</code><code class="err">'</code><code class="calibre15">,</code> <code class="calibre15">address2</code><code class="o">:</code> <code class="err">''</code><code class="calibre15">,</code> <code class="calibre15">city</code><code class="o">:</code> <code class="err">'</code><code class="calibre15">East</code> <code class="calibre15">Romanberg</code><code class="err">'</code><code class="calibre15">,</code> <code class="calibre15">state</code><code class="o">:</code> <code class="calibre15">VT</code><code class="calibre15">,</code> <code class="calibre15">zip</code><code class="o">:</code> \
<code class="lineno">8</code> <code class="o">20129</code><code class="calibre15">,</code> <code class="calibre15">website</code><code class="o">:</code> <code class="err">'</code><code class="calibre15">http</code><code class="o">:</code><code class="c">//www.torpdibbert.com/', phone: (029)331-0729x4259 }</code>
<code class="lineno">9</code>     <code class="calibre15">...</code>
</pre></div>

</figure>

<p class="calibre3">Making these requests programmatically is simple.</p>

<figure class="code">
  <figcaption class="calibre20">Using PHP and the Guzzle package to request a different response type</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno">1</code> <code class="k">use</code> <code class="calibre15">GuzzleHttp\Client</code><code class="calibre15">;</code>
<code class="lineno">2</code> 
<code class="lineno">3</code> <code class="nv">$client</code> <code class="o">=</code> <code class="k">new</code> <code class="calibre15">Client</code><code class="calibre15">([</code><code class="s">'base_url'</code> <code class="o">=&gt;</code> <code class="s">'http://localhost:8000'</code><code class="calibre15">]);</code>
<code class="lineno">4</code> 
<code class="lineno">5</code> <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$client</code><code class="o">-&gt;</code><code class="na">get</code><code class="calibre15">(</code><code class="s">'/places'</code><code class="calibre15">,</code> <code class="calibre15">[</code>
<code class="lineno">6</code> 	<code class="s">'headers'</code> <code class="o">=&gt;</code> <code class="calibre15">[</code><code class="s">'Accept'</code> <code class="o">=&gt;</code> <code class="s">'application/x-yaml'</code><code class="calibre15">]</code>
<code class="lineno">7</code> <code class="calibre15">]);</code>
<code class="lineno">8</code> 
<code class="lineno">9</code> <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">getBody</code><code class="calibre15">();</code> <code class="c">// YAML, ready to be parsed</code>
</pre></div>

</figure>

<p class="calibre3">This is not the end of the conversation for content negotiation as there is more to talk about
with vendor-based MIME types for resources, which can also be versioned. To keep this chapter on point, that
discussion will happen in <a href="#calibre_link-78">Chapter 13: API Versioning</a>.</p>

<h3 id="calibre_link-77" class="calibre2">
<span class="section-number">12.3 </span>Hypermedia Controls</h3>

<p class="calibre3">The second part of HATEOAS, however, is drastically underused, and is the last step in making your API
technically a RESTful API.</p>


<figure class="image">
  <img src="images/000019.png" alt="Batman provides a standard response to often futile bucket remark &quot;But it&apos;s not RESTful if you...&quot; Credit to Troy Hunt (@troyhunt)" class="calibre30" />
  <figcaption class="calibre31">Batman provides a standard response to often futile bucket remark “But it’s not RESTful if you…” Credit to Troy Hunt (@troyhunt)</figcaption>
</figure>


<p class="calibre3">While you often hear complaints like “but that is not RESTful!” from people about silly things, this is one
instance where they are completely right. Roy Fielding says that <a href="http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven">without hypermedia controls an API
is not RESTful</a>, writing 
back in 2008. People have been ignoring that ever since, and the last estimate was that 74% of APIs 
claiming to be “RESTful” do not actually use hypermedia.</p>

<h4 id="calibre_link-177" class="calibre4">RESTful Nirvana</h4>

<p class="calibre3">There is something floating around the REST/Hypermedia community called the <a href="http://martinfowler.com/articles/richardsonMaturityModel.html">Richardson Maturity Model</a>, written about here by <a href="http://martinfowler.com/">Martin Fowler</a> but originally invented by <a href="http://www.crummy.com/">Leonard Richardson</a>. It covers what he considers to be ‘the four levels of REST’:</p>

<blockquote class="calibre17">
  <ol class="calibre13">
    <li class="calibre14">
<strong class="calibre22">“The Swamp of POX.”</strong> You’re using HTTP to make RPC calls. HTTP is only really used as a tunnel.</li>
    <li class="calibre14">
<strong class="calibre22">Resources.</strong> Rather than making every call to a service endpoint, you have multiple endpoints that are used to represent resources, and you’re talking to them. This is the very beginnings of supporting REST.</li>
    <li class="calibre14">
<strong class="calibre22">HTTP Verbs.</strong> This is the level that something like Rails gives you out of the box: You interact with these Resources using HTTP verbs, rather than always using POST.</li>
    <li class="calibre14">
<strong class="calibre22">Hypermedia Controls.</strong> HATEOAS. You’re 100% REST compliant.<br class="calibre6" />
&ndash; <strong class="calibre22">Source:</strong> <a href="http://timelessrepo.com/haters-gonna-hateoas">Steve Klabnik, “Haters gonna HATEOAS”</a>
</li>
  </ol>
</blockquote>

<p class="calibre3">Some dispute this model because, as Roy says, unless you have hypermedia then it is not REST. 
The model is good as long as you understand that steps 1, 2 and 3 are still “not REST” and step 4
is “REST”.</p>

<p class="calibre3">So, what are hypermedia controls? They are just links to other content, relationships, and further actions. These allow a consumer to browse around the API, discovering actions as it goes.</p>

<p class="calibre3">Basically, your data needs to have “hyperlinks”, which you have probably been using in your HTML
output for years. I said early on in the book that REST is just using the same conventions as the
actual Internet, instead of inventing new ones, so it makes sense that linking to other resources 
should be the same in an API as it is in a web page.</p>

<p class="calibre3">The general underlying theme of hypermedia is that an API should be able to make perfect sense
to an API client application and the human looking at the responses, entirely without having to 
hunt through documentation to work out what is going on.</p>

<p class="calibre3">Small HATEOAS concepts have been sneakily sprinkled throughout this book, from suggesting error codes be
combined with human readable error messages and documentation links, to helping the client application avoid
maths when interacting with pagination. The underlying theme is always to make controls such as next, previous (or any other sort of related interaction) clearly obvious to either a human or a computer.</p>

<h4 id="calibre_link-178" class="calibre4">Understanding Hypermedia Controls</h4>

<p class="calibre3">This is the easiest part of building a RESTful API, so I am going to try really hard not to leave this
section at “just add links mate” (my normal advice for anyone asking about HATEOAS).</p>

<p class="calibre3">Our usual data is output in such a way that only represents one or more resources. By itself, this one piece
of data is an island, completely cut off from the rest of the API. The only way to continue interacting
with the API is for the developer to read the documentation and understand what data can be related, and to discover where that data might live. This is far from ideal.</p>

<p class="calibre3">To tie one <code class="calibre15">place</code> to the related resources, subresources or collections is easy.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>     <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno"> 3</code>         <code class="s">"id"</code><code class="o">:</code> <code class="o">1</code><code class="calibre15">,</code>
<code class="lineno"> 4</code>         <code class="s">"name"</code><code class="o">:</code> <code class="s">"Mireille Rodriguez"</code><code class="calibre15">,</code>
<code class="lineno"> 5</code>         <code class="s">"lat"</code><code class="o">:</code> <code class="o">-</code><code class="o">84.147236</code><code class="calibre15">,</code>
<code class="lineno"> 6</code>         <code class="s">"lon"</code><code class="o">:</code> <code class="o">49.254065</code><code class="calibre15">,</code>
<code class="lineno"> 7</code>         <code class="s">"address1"</code><code class="o">:</code> <code class="s">"12106 Omari Wells Apt. 801"</code><code class="calibre15">,</code>
<code class="lineno"> 8</code>         <code class="s">"address2"</code><code class="o">:</code> <code class="s">""</code><code class="calibre15">,</code>
<code class="lineno"> 9</code>         <code class="s">"city"</code><code class="o">:</code> <code class="s">"East Romanberg"</code><code class="calibre15">,</code>
<code class="lineno">10</code>         <code class="s">"state"</code><code class="o">:</code> <code class="s">"VT"</code><code class="calibre15">,</code>
<code class="lineno">11</code>         <code class="s">"zip"</code><code class="o">:</code> <code class="o">20129</code><code class="calibre15">,</code>
<code class="lineno">12</code>         <code class="s">"website"</code><code class="o">:</code> <code class="s">"http://www.torpdibbert.com/"</code><code class="calibre15">,</code>
<code class="lineno">13</code>         <code class="s">"phone"</code><code class="o">:</code> <code class="s">"(029)331-0729x4259"</code><code class="calibre15">,</code>
<code class="lineno">14</code>         <code class="s">"links"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno">15</code>         	<code class="calibre15">{</code>
<code class="lineno">16</code>         		<code class="s">"rel"</code><code class="o">:</code> <code class="s">"self"</code><code class="calibre15">,</code>
<code class="lineno">17</code>         		<code class="s">"uri"</code><code class="o">:</code> <code class="s">"/places/2"</code>
<code class="lineno">18</code>         	<code class="calibre15">},</code>
<code class="lineno">19</code>         	<code class="calibre15">{</code>
<code class="lineno">20</code>         		<code class="s">"rel"</code><code class="o">:</code> <code class="s">"place.checkins"</code><code class="calibre15">,</code>
<code class="lineno">21</code>         		<code class="s">"uri"</code><code class="o">:</code> <code class="s">"/places/2/checkins"</code>
<code class="lineno">22</code>         	<code class="calibre15">},</code>
<code class="lineno">23</code>         	<code class="calibre15">{</code>
<code class="lineno">24</code>         		<code class="s">"rel"</code><code class="o">:</code> <code class="s">"place.image"</code><code class="calibre15">,</code>
<code class="lineno">25</code>         		<code class="s">"uri"</code><code class="o">:</code> <code class="s">"/places/2/image"</code>
<code class="lineno">26</code>         	<code class="calibre15">}</code>
<code class="lineno">27</code>         <code class="calibre15">]</code>
<code class="lineno">28</code>     <code class="calibre15">]</code>
<code class="lineno">29</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">Here are three simple entries, with the first linking to itself. They all contain a <code class="calibre15">uri</code> (Universal
Resource Indicator) and a <code class="calibre15">rel</code> (Relationship).</p>

<aside class="information">
    <h4 id="calibre_link-179" class="calibre21">URI vs. URL</h4>
  <p class="calibre3">The acronym “URI” is often used to refer to only content after the protocol, hostname and port
(meaning URI is the path, extension and query string), whilst “URL” is used to describe the full address.
While this is not strictly true, it is perpetuated by many software projects such as CodeIgniter.
<a href="http://wikipedia.org/wiki/Uniform_Resource_Identifier">Wikipedia</a> and the <a href="http://www.w3.org/TR/uri-clarification/">W3</a> say a bunch of conflicting things, but I feel like a
URI is easily described as being simply any sort of identifier for the location of a resource on the
Internet.</p>

  <p class="calibre3">A URI can be partial, or absolute. URL is considered by some to be a completely non-existent term, but
this book uses URL to describe an absolute URI, which is what you see in the address bar. Rightly or
wrongly. Got it?</p>

</aside>

<p class="calibre3">Some people scoff at the <code class="calibre15">self</code> relationship suggesting that it is pointless. While you certainly know what
URL you just called, that URL is not always going to match up with the <code class="calibre15">self</code> URI. For example, if you just
created a <code class="calibre15">place</code> resource, you will have called <code class="calibre15">POST /places</code>, and that is not what you would want to
call again to get updated information on the same resource. Regardless of the context, outputting a <code class="calibre15">place</code>
always needs to have a <code class="calibre15">self</code> relationship, and that <code class="calibre15">self</code> should not just output whatever is in the
address bar. Basically put, the <code class="calibre15">self</code> relationship points to where the resource lives, not the current
address.</p>

<p class="calibre3">As for the other <code class="calibre15">rel</code> items, they are links to subresources that contain related information. The content
of the tags can be anything you like, just keep it consistent throughout. The convention used in this
example is to namespace relationships so that they are unique. Two different types of resources could have
a <code class="calibre15">checkins</code> relationship (eg: <code class="calibre15">users</code> and <code class="calibre15">places</code>), so keeping them unique could be of benefit for the sake
of documentation at least. Maybe you would prefer to remove the namespace, but that is up to you.</p>

<p class="calibre3">Those custom relationships have fairly unique names, but for more generic relationships you can consider
using the <a href="http://www.iana.org/assignments/link-relations/link-relations.xhtml">Registry of Link Relations</a> defined by the IANA, which is used by Atom (<a href="http://atompub.org/rfc4287.html">RFC 4287</a>) and plenty of
other things.</p>

<h4 id="calibre_link-180" class="calibre4">Creating Hypermedia Controls</h4>

<p class="calibre3">This is literally a case of shoving some links into your data output. However you chose to do that, it
can be part of your “transformation” or “presentation” layer.</p>

<p class="calibre3">If you are using the PHP component Fractal - which has been used as an example throughout the book - then
you can simply do the following:</p>

<figure class="code">
  <figcaption class="calibre20">PlaceTransformer with links included in the response data.</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno"> 1</code> <code class="k">public</code> <code class="k">function</code> <code class="nf">transform</code><code class="calibre15">(</code><code class="calibre15">Place</code> <code class="nv">$place</code><code class="calibre15">)</code>
<code class="lineno"> 2</code> <code class="calibre15">{</code>
<code class="lineno"> 3</code>     <code class="k">return</code> <code class="calibre15">[</code>
<code class="lineno"> 4</code>         <code class="s">'id'</code>           <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">int</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">id</code><code class="calibre15">,</code>
<code class="lineno"> 5</code>         <code class="s">'name'</code>         <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">name</code><code class="calibre15">,</code>
<code class="lineno"> 6</code>         <code class="s">'lat'</code>          <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">float</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">lat</code><code class="calibre15">,</code>
<code class="lineno"> 7</code>         <code class="s">'lon'</code>          <code class="o">=&gt;</code> <code class="calibre15">(</code><code class="calibre15">float</code><code class="calibre15">)</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">lon</code><code class="calibre15">,</code>
<code class="lineno"> 8</code>         <code class="s">'address1'</code>     <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">address1</code><code class="calibre15">,</code>
<code class="lineno"> 9</code>         <code class="s">'address2'</code>     <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">address2</code><code class="calibre15">,</code>
<code class="lineno">10</code>         <code class="s">'city'</code>         <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">city</code><code class="calibre15">,</code>
<code class="lineno">11</code>         <code class="s">'state'</code>        <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">state</code><code class="calibre15">,</code>
<code class="lineno">12</code>         <code class="s">'zip'</code>          <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">zip</code><code class="calibre15">,</code>
<code class="lineno">13</code>         <code class="s">'website'</code>      <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">website</code><code class="calibre15">,</code>
<code class="lineno">14</code>         <code class="s">'phone'</code>        <code class="o">=&gt;</code> <code class="nv">$place</code><code class="o">-&gt;</code><code class="na">phone</code><code class="calibre15">,</code>
<code class="lineno">15</code> 
<code class="lineno">16</code>         <code class="s">'links'</code>        <code class="o">=&gt;</code> <code class="calibre15">[</code>
<code class="lineno">17</code>             <code class="calibre15">[</code>
<code class="lineno">18</code>                 <code class="s">'rel'</code> <code class="o">=&gt;</code> <code class="s">'self'</code><code class="calibre15">,</code>
<code class="lineno">19</code>                 <code class="s">'uri'</code> <code class="o">=&gt;</code> <code class="s">'/places/'</code><code class="o">.</code><code class="nv">$place</code><code class="o">-&gt;</code><code class="na">id</code><code class="calibre15">,</code>
<code class="lineno">20</code>             <code class="calibre15">],</code>
<code class="lineno">21</code>             <code class="calibre15">[</code>
<code class="lineno">22</code>                 <code class="s">'rel'</code> <code class="o">=&gt;</code> <code class="s">'place.checkins'</code><code class="calibre15">,</code>
<code class="lineno">23</code>                 <code class="s">'uri'</code> <code class="o">=&gt;</code> <code class="s">'/places/'</code><code class="o">.</code><code class="nv">$place</code><code class="o">-&gt;</code><code class="na">id</code><code class="o">.</code><code class="s">'/checkins'</code><code class="calibre15">,</code>
<code class="lineno">24</code>             <code class="calibre15">],</code>
<code class="lineno">25</code>             <code class="calibre15">[</code>
<code class="lineno">26</code>                 <code class="s">'rel'</code> <code class="o">=&gt;</code> <code class="s">'place.image'</code><code class="calibre15">,</code>
<code class="lineno">27</code>                 <code class="s">'uri'</code> <code class="o">=&gt;</code> <code class="s">'/places/'</code><code class="o">.</code><code class="nv">$place</code><code class="o">-&gt;</code><code class="na">id</code><code class="o">.</code><code class="s">'/image'</code><code class="calibre15">,</code>
<code class="lineno">28</code>             <code class="calibre15">]</code>
<code class="lineno">29</code>         <code class="calibre15">],</code>
<code class="lineno">30</code>     <code class="calibre15">];</code>
<code class="lineno">31</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">People try to get smarter and have various relationships based on their <code class="calibre15">$_SERVER</code> settings or based
on their ORM relationships, but all of that is just going to cause you problems. If you have these
transformers then you only need to write this lot out once. This then avoids exposing any database logic and
keeps your code readable and understandable.</p>

<p class="calibre3">Once you have input these links, other people need to know how to interact with them. You might think, “surely I should put <code class="calibre15">GET</code> or <code class="calibre15">PUT</code> in there so people know what to do”. Wrong. They are links to resources,
not actions. An image exists for a place, and we can either blindly assume we can make certain actions on it,
or we can ask our API what actions are available and cache the result.</p>

<h4 id="calibre_link-181" class="calibre4">Discovering Resources Programmatically</h4>

<p class="calibre3">Taking a shortened example from earlier on in this chapter, we can expect to see output like this:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno"> 1</code> <code class="calibre15">{</code>
<code class="lineno"> 2</code>     <code class="s">"data"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno"> 3</code>     	<code class="calibre15">...</code>
<code class="lineno"> 4</code>         <code class="s">"links"</code><code class="o">:</code> <code class="calibre15">[</code>
<code class="lineno"> 5</code>         	<code class="calibre15">{</code>
<code class="lineno"> 6</code>         		<code class="s">"rel"</code><code class="o">:</code> <code class="s">"self"</code><code class="calibre15">,</code>
<code class="lineno"> 7</code>         		<code class="s">"uri"</code><code class="o">:</code> <code class="s">"/places/2"</code>
<code class="lineno"> 8</code>         	<code class="calibre15">},</code>
<code class="lineno"> 9</code>         	<code class="calibre15">{</code>
<code class="lineno">10</code>         		<code class="s">"rel"</code><code class="o">:</code> <code class="s">"place.checkins"</code><code class="calibre15">,</code>
<code class="lineno">11</code>         		<code class="s">"uri"</code><code class="o">:</code> <code class="s">"/places/2/checkins"</code>
<code class="lineno">12</code>         	<code class="calibre15">},</code>
<code class="lineno">13</code>         	<code class="calibre15">{</code>
<code class="lineno">14</code>         		<code class="s">"rel"</code><code class="o">:</code> <code class="s">"place.image"</code><code class="calibre15">,</code>
<code class="lineno">15</code>         		<code class="s">"uri"</code><code class="o">:</code> <code class="s">"/places/2/image"</code>
<code class="lineno">16</code>         	<code class="calibre15">}</code>
<code class="lineno">17</code>         <code class="calibre15">]</code>
<code class="lineno">18</code>     <code class="calibre15">]</code>
<code class="lineno">19</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">We can assume that a <code class="calibre15">GET</code> will work on both the <code class="calibre15">self</code> and the <code class="calibre15">place.checkins</code> endpoints, but
what else can we do with them? Beyond that, what on Earth do we do with the <code class="calibre15">place.image</code> endpoint?</p>

<p class="calibre3">HTTP has us covered here with a simple and effective verb that has so far not been discussed: <code class="calibre15">OPTIONS</code>.</p>

<figure class="code">
  <figcaption class="calibre20">An HTTP request using the OPTIONS verb</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">OPTIONS</code> <code class="o">/</code><code class="calibre15">places</code><code class="o">/</code><code class="o">2</code><code class="o">/</code><code class="calibre15">checkins</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="nl">Host:</code> <code class="calibre15">localhost</code><code class="o">:</code><code class="o">8000</code>
</pre></div>

</figure>

<figure class="code">
  <figcaption class="calibre20">The response to the previous HTTP request</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code> <code class="o">200</code> <code class="calibre15">OK</code>
<code class="lineno">2</code> <code class="nl">Host:</code> <code class="calibre15">localhost</code><code class="o">:</code><code class="o">8000</code>
<code class="lineno">3</code> <code class="nl">Connection:</code> <code class="calibre15">close</code>
<code class="lineno">4</code> <code class="nl">Allow:</code> <code class="calibre15">GET</code><code class="calibre15">,</code><code class="calibre15">HEAD</code><code class="calibre15">,</code><code class="calibre15">POST</code>
</pre></div>

</figure>

<p class="calibre3">By inspecting the <code class="calibre15">Allow</code> header, we as humans (or programmatically as an API client application), can work
out what options are available to us on any given endpoint. This is what JavaScript is often doing in your
browser for AJAX requests and you might not even know it.</p>

<p class="calibre3">Doing this programmatically is pretty easy too, and most HTTP clients in any given language will let you make
an <code class="calibre15">OPTIONS</code> call just as easily as making a <code class="calibre15">GET</code> or <code class="calibre15">POST</code> call. If your HTTP client does not let you do
this, then change your HTTP client.</p>

<figure class="code">
  <figcaption class="calibre20">Making an OPTIONS HTTP request using PHP and the Guzzle package</figcaption>

<div class="highlight1"><pre class="calibre16"><code class="lineno">1</code> <code class="k">use</code> <code class="calibre15">GuzzleHttp\Client</code><code class="calibre15">;</code>
<code class="lineno">2</code> 
<code class="lineno">3</code> <code class="nv">$client</code> <code class="o">=</code> <code class="k">new</code> <code class="calibre15">Client</code><code class="calibre15">([</code><code class="s">'base_url'</code> <code class="o">=&gt;</code> <code class="s">'http://localhost:8000'</code><code class="calibre15">]);</code>
<code class="lineno">4</code> <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$client</code><code class="o">-&gt;</code><code class="na">options</code><code class="calibre15">(</code><code class="s">'/places/2/checkins'</code><code class="calibre15">);</code>
<code class="lineno">5</code> <code class="nv">$methods</code> <code class="o">=</code> <code class="nb">array_walk</code><code class="calibre15">(</code><code class="s">'trim'</code><code class="calibre15">,</code> <code class="nb">explode</code><code class="calibre15">(</code><code class="s">','</code><code class="calibre15">,</code> <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">getHeader</code><code class="calibre15">(</code><code class="s">'Accept'</code><code class="calibre15">));</code>
<code class="lineno">6</code> <code class="nb">var_dump</code><code class="calibre15">(</code><code class="nv">$methods</code><code class="calibre15">);</code> <code class="c">// Outputs: ['GET', 'HEAD', 'POST']</code>
</pre></div>

</figure>

<p class="calibre3">So in this instance, we know that we can get a list of check-ins for a place using <code class="calibre15">GET</code> and we can add to
them by making a <code class="calibre15">POST</code> HTTP request to that URL. We can also do a <code class="calibre15">HEAD</code> check, which is the same as a
<code class="calibre15">GET</code> but skips the HTTP body. You will probably need to handle this differently in your application, but
this is handy for checking if a resource or collection exists without having to download the entire body
content (i.e: just look for a <code class="calibre15">200</code> or a <code class="calibre15">404</code>).</p>

<p class="calibre3">It might seem a little nuts to take this extra step to interact with an API, but really it should be
considered much easier than hunting for documentation. Think about it: trying to find that little
“Developers” link on the website, then navigating to the documentation for the correct API (because they are
so cool they have about three), then wondering if you have the right version… not fun. Compare that to a
programmatically self-documenting API, which can grow, change and expand over time, rename URLs and… well that is a real win. Trust me.</p>

<p class="calibre3">If you know that an API follows RESTful principles then you <em class="calibre19">should</em> be confident that it follows HATEOAS
because advertising it as RESTful without following HATEOAS is a big stinking lie. Sadly, most of the
popular APIs out there are big stinking liars.</p>

<blockquote class="calibre17">
  <p class="calibre3">GitHub responds with a 500, Reddit with 501 Not Implemented, Google maps with 405 Method Not Allowed. You get the idea. I’ve tried many others, and the results are usually similar. Sometimes it yields something identical to a GET response. None of these are right.<br class="calibre6" />
&ndash; <strong class="calibre22">Source:</strong> <a href="http://zacstewart.com/2012/04/14/http-options-method.html">Zac Stewart, “The HTTP OPTIONS method and potential for self-describing RESTful APIs”</a></p>
</blockquote>

<p class="calibre3">If you are building your own API, then you can easily do this yourself and your clients know that you know
how to build a decent API.</p>

<p class="calibre3">And that, is about all there is for HATEOAS. You should now know enough to go out and build up an API that
in theory you won’t hate. Sadly, you will probably need to build a new version within a few months regardless,
so for that we will now take a look at API versioning.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-104">
<div class="calibre6">
<h2 id="calibre_link-78" class="calibre1">
<span class="section-number">13. </span>API Versioning</h2>

<h3 id="calibre_link-79" class="calibre2">
<span class="section-number">13.1 </span>Introduction</h3>

<p class="calibre3">Once you have built your wonderful new API, at some point it will need to be replaced or have new features
added. Sadly, there is no real consensus on what approach is the best, but instead there are pros and cons to each approach.</p>

<p class="calibre3">The general advice you will find most experts giving is this: try to limit change as much as possible. That is
a very fair statement to make, but also seems like a bit of a cop out. Regardless of how well planned
your API is, your business requirements will likely be what forces you to make substantial changes
eventually.</p>

<p class="calibre3">This can be a killer in the startup world, where things are considerably less structured. Kapture
started off with “opportunities” which became “photo opps” and ended up being called “campaigns”. You
can laugh at that and say it will never happen to you, but it will. When you are least expecting it,
business requirements will come at you like a wet mackerel to the face. When that happens, API
versioning is often the only solution.</p>

<blockquote class="calibre17">
  <p class="calibre3">Sure, you could say that your API needs to maintain backward compatibility, but that is not very realistic when you are reusing your API properly across your product line. To demonstrate further, let us say you have 30 applications (and maybe a handful of external companies using the API), all of which are relying on the “customer” REST resource. Your choices now are:  </p>

  <ol class="calibre13">
    <li class="calibre14">Keep it backward compatible (and lose the million dollar sale because you could not implement cool feature X)  </li>
    <li class="calibre14">Change all 30 applications simultaneously to handle the new data (you likely do not have enough resource to do this and deliver on time)  </li>
    <li class="calibre14">Make the change, breaking the apps you do not have time to upgrade, but get the sale. (Of course, you will fix the remaining apps in the future, right?)<br class="calibre6" />
&ndash; <strong class="calibre22">Source:</strong> <a href="http://thereisnorightway.blogspot.com.tr/2011/02/versioning-and-types-in-resthttp-api.html">Jeremy Highley, “Versioning and Types in REST/HTTP API Resources”</a>
</li>
  </ol>
</blockquote>

<h3 id="calibre_link-80" class="calibre2">
<span class="section-number">13.2 </span>Different Approaches to API Versioning</h3>

<p class="calibre3">As has been done in several other chapters, this chapter will outline several different approaches and list their pros and cons. In other chapters, the final suggestion is generally implied to be a “better” solution,
but in this chapter they are all compromises. Some are technically RESTful but incredibly complicated to
implement; they are also complicated for your users. This means you have to put some real thought into
the approach.</p>

<p class="calibre3">Throughout this chapter will be references to various popular services with public APIs and the type of API
versioning they use. Credit goes to Tim Wood for compiling an extensive list in <a href="http://www.lexicalscope.com/blog/2012/03/12/how-are-rest-apis-versioned/">“How are REST APIs versioned?”</a>, which will be used for reference in this chapter.</p>

<h4 id="calibre_link-182" class="calibre4">Approach #1: URI</h4>

<p class="calibre3">Throwing a version number in the URI is a very common practice amongst popular public APIs.</p>

<p class="calibre3">Essentially, all you do here is put a ‘v1’ or ‘1’ in the URL, so that the next version can be easily changed.</p>

<blockquote class="calibre17">
  <p class="calibre3">https://api.example.com/v1/places</p>
</blockquote>

<p class="calibre3">Due to being so prolific throughout various public APIs, this is often the first approach API developers take
when building their own. It is by far the easiest and it does the job.</p>

<p class="calibre3">Twitter has two versions, ‘/1/’ and ‘/1.1/’, both of which were live at the time of writing. This
gives developers a chance to update any code that is referencing the old endpoints, so they can use the new
ones. Most APIs would have called it ‘/2/’, but since it was not a drastic change, perhaps they wanted a more
subtle number.</p>

<p class="calibre3">Some say that URI versioning allows for a more copy-and-paste-friendly URL than other approaches (many of 
which involve HTTP headers) and this is supposedly better for support.</p>

<p class="calibre3">That might be true in some ways but is not totally accurate. No REST/Hypermedia API is ever going to be entirely copy-and-paste-friendly because there will always be headers involved: <code class="calibre15">Cache-Control</code>, <code class="calibre15">Accept</code>, <code class="calibre15">Content-Type</code>, <code class="calibre15">Authorization</code>, etc. Trying to make an entire API request fit in a URL just seems like a fool’s errand.</p>

<p class="calibre3">While the copy-paste argument is simply a lack of a positive, this versioning approach does have some 
potentially frustrating downsides.</p>

<p class="calibre3">The first thing people will say is that it is not technically RESTful. If you care about breaking this REST rule or not is up to you, but Roy Fielding says that placing the version in the URL like this basically makes your API into a RPC API instead.</p>


<figure class="image">
  <img src="images/000005.png" alt="Roy says: &quot;v1 is a middle finger to your API customers, indicating RPC/HTTP (not REST)&quot;" class="calibre30" />
  <figcaption class="calibre31">Roy says: “v1 is a middle finger to your API customers, indicating RPC/HTTP (not REST)”</figcaption>
</figure>


<p class="calibre3">His mention of “evolvability” is fundamental to the concept of REST. A resource is meant to be more like
a permalink. This permalink (the URL) should never change. Over time you can hit that permalink with different version headers, or request different representations of JSON, or XML, or whatever you like, but
it will always be the same URL.</p>

<p class="calibre3">If the Internet is built around linking together and those links are changing all the time then, well,
things break. This might not be something you are too concerned about - especially if the API is
internal - but it can be hugely annoying for others.</p>

<p class="calibre3">For example, if you store the URL of an endpoint in your database for later reference, it might look like
this:</p>

<blockquote class="calibre17">
  <p class="calibre3">https://api.example.com/v1/places/213</p>
</blockquote>

<p class="calibre3">One day, you get an email from <code class="calibre15">example.com</code> stating that their v1 API is going to be deprecated in three months, and you need to start using the v2 API as soon as you can.</p>

<p class="calibre3">If you update your code to match the updated format with whatever new or renamed fields the
new version may contain, then great, your new code will be ready to work with the new API version and you can
start saving the new URL when you enter the record in your database. That works for new records, but you cannot leave the old records in there referencing the old API v1 URL.</p>

<p class="calibre3">So what do you do? One solution would be to string replace the old URL and hope the new URL is right:</p>

<blockquote class="calibre17">
  <p class="calibre3">https://api.example.com/<strong class="calibre22">v2</strong>/places/213</p>
</blockquote>

<p class="calibre3">That might have worked, if it was not for the fact that you missed the note in the email that says they no
longer use auto-increment IDs in their URLs (they read that it was a bad idea somewhere) and have decided
to use slugs instead:</p>

<blockquote class="calibre17">
  <p class="calibre3">https://api.example.com/<strong class="calibre22">v2</strong>/places/taksim-bunk-hostel</p>
</blockquote>

<p class="calibre3">Now what? The only solution here is to create a script that goes through each and every record in your
database, hits their v1 API and gets information (hopefully that slug is available) and then constructs
a ‘v2’ compatible URL to store.</p>

<p class="calibre3">If you do that with a few million records then you will probably hit some API limits fairly quickly. Twitter,
for example, limits applications to 15 requests per endpoint per 15 minutes in some situations, so this would
take about two weeks to update one million records.</p>

<p class="calibre3">Maybe that sounds like an edge case, but putting the API version in the URL is asking for all sorts
of obscure problems down the line, and asking your developers to manually construct resource URLs with string replacement is just rude. Peter Williams pointed this out in an article titled <a href="http://barelyenough.org/blog/2008/05/versioning-rest-web-services/">“Versioning REST Web Services”</a> back in 2008, but everyone has been consistently ignoring him it seems.</p>

<p class="calibre3">Another downside to this approach is that pointing v1 and v2 to different servers can be difficult, unless you use some sort of Apache Proxy feature or nginx-as-a-proxy trickery. Generally speaking, most systems expect the same path to be on the same server (doing otherwise can lead to overhead), so if v1 is PHP and v2 is Scala, you can run into some trouble having them all set up on the same server.</p>

<p class="calibre3">The opposite of the putting-them-on-the-same-server-can-be-hard problem, is when API developers try to let one single code base take care of this versioning internally in their web app. They simply make routes
with the prefix <code class="calibre15">/v1/places</code>, then when they want to make v2 they copy the routes, copy the controllers and
tweak things. This <em class="calibre19">can</em> be done if you also version your transformers (to maintain structure and data
types), and you are confident that all shared code (libraries, packages, etc.) will maintain a consistent output throughout. This is rarely the case, and people putting v1 in their URLs are just doing it because it is the only solution they know.</p>

<p class="calibre3">Instead, consider making each version its own code base. This means the code is totally separate, executed 
separately, with different web server vhosts or maybe even on different servers. </p>

<p class="calibre3">If the APIs are very similar (same language, same framework, etc), then you can simply share a Git history &mdash; be it different branch in the same <code class="calibre15">api</code> repository, or a different branch. Some people take the <a href="http://nvie.com/posts/a-successful-git-branching-model/">Git Flow</a>
model and prepends version numbers, so one repository may have the following branches:</p>

<ul class="calibre18">
  <li class="calibre14">1.0/master</li>
  <li class="calibre14">1.0/develop</li>
  <li class="calibre14">2.0/master</li>
  <li class="calibre14">2.0/develop</li>
</ul>

<p class="calibre3">As long as you share a Git history, you can pull from the other repository or branch and merge changes from older versions to newer versions. This lets you fix bugs in multiple versions easily instead of copying and pasting between all of your controllers in the the same code base.</p>

<p class="calibre3">
  <strong class="calibre22">Popular APIs</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Bitly</li>
  <li class="calibre14">Disqus</li>
  <li class="calibre14">Dropbox</li>
  <li class="calibre14">Bing (lol)</li>
  <li class="calibre14">Etsy</li>
  <li class="calibre14">Foursquare</li>
  <li class="calibre14">Tumblr</li>
  <li class="calibre14">Twitter</li>
  <li class="calibre14">Yammer</li>
  <li class="calibre14">YouTube</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Pros</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Incredibly simple for API developers</li>
  <li class="calibre14">Incredibly simple for API consumers</li>
  <li class="calibre14">Copy-and-pasteable URLs</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Cons</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Not technically RESTful</li>
  <li class="calibre14">Tricky to separate onto different servers</li>
  <li class="calibre14">Forces API consumers to do weird stuff to keep links up-to-date</li>
</ul>

<h4 id="calibre_link-183" class="calibre4">Approach #2: Hostname</h4>

<p class="calibre3">Some API developers try to avoid the issues with server setup found with putting the version in the URI
and simply put the version number in the hostname (or subdomain) instead:</p>

<blockquote class="calibre17">
  <p class="calibre3">https://api-v1.example.com/places</p>
</blockquote>

<p class="calibre3">This does not really solve any of the other problems. Having it in the URL in general (URI or subdomain)
shares all the same problems for API consumers, but it does at least reduce the chances of API developers
trying to let one code base handle it all.</p>

<p class="calibre3">
  <strong class="calibre22">Pros</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Incredibly simple for API developers</li>
  <li class="calibre14">Incredibly simple for API consumers</li>
  <li class="calibre14">“Copy-and-paste-able” URLs</li>
  <li class="calibre14">Easy to use DNS to split versions over multiple servers</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Cons</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Not technically RESTful</li>
  <li class="calibre14">Forces API consumers to do weird stuff to keep links up-to-date</li>
</ul>

<h4 id="calibre_link-184" class="calibre4">Approach #3: Body and Query Params</h4>

<p class="calibre3">If you are going to take the URI version out of the URL, then one of the two other places to put it is
the HTTP body itself:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">POST</code> <code class="o">/</code><code class="calibre15">places</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="nl">Host:</code> <code class="calibre15">api</code><code class="calibre15">.</code><code class="calibre15">example</code><code class="calibre15">.</code><code class="calibre15">com</code>
<code class="lineno">3</code> <code class="calibre15">Content</code><code class="o">-</code><code class="calibre15">Type</code><code class="o">:</code> <code class="calibre15">application</code><code class="o">/</code><code class="calibre15">json</code>
<code class="lineno">4</code> 
<code class="lineno">5</code> <code class="calibre15">{</code>
<code class="lineno">6</code>     <code class="s">"version"</code> <code class="o">:</code> <code class="s">"1.0"</code>
<code class="lineno">7</code> <code class="calibre15">}</code>
</pre></div>

</figure>

<p class="calibre3">This solves the problem of URLs changing over time, but can lead to inconsistent experiences. If the API
developer is posting JSON, or a similar data structure, then it is easy, but if they are posting with a <code class="calibre15">Content-Type</code> of <code class="calibre15">image/png</code> or even <code class="calibre15">text/csv</code> then this becomes very complicated very quickly.</p>

<p class="calibre3">Some suggest the solution to that problem is to move the parameter to the query string, but now the API version is in the URL again! Immediately, many of the problems of the first two approaches are back.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">POST</code> <code class="o">/</code><code class="calibre15">places</code><code class="o">?</code><code class="calibre15">version</code><code class="o">=</code><code class="o">1.0</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="nl">Host:</code> <code class="calibre15">api</code><code class="calibre15">.</code><code class="calibre15">example</code><code class="calibre15">.</code><code class="calibre15">com</code>
<code class="lineno">3</code> 
<code class="lineno">4</code> <code class="calibre15">header1</code><code class="calibre15">,</code><code class="calibre15">header2</code>
<code class="lineno">5</code> <code class="calibre15">value1</code><code class="calibre15">,</code><code class="calibre15">value2</code>
</pre></div>

</figure>

<p class="calibre3">This… just do something else. Many PHP frameworks ignore the query string under anything other than a <code class="calibre15">GET</code>
request, which goes against the HTTP specification but is still common. Having this parameter that moves around inside different content types in the body or sometimes in the URL or even always in the URL,
regardless of the HTTP Verb being used, is just confusing.</p>

<p class="calibre3">
  <strong class="calibre22">Popular APIs</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Netflix</li>
  <li class="calibre14">Google Data</li>
  <li class="calibre14">PayPal</li>
  <li class="calibre14">Amazon SQS</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Pros</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Simple for API developers</li>
  <li class="calibre14">Simple for API consumers</li>
  <li class="calibre14">Keeps URLs the same when param is in the body</li>
  <li class="calibre14">Technically a bit more RESTful than putting version in the URI</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Cons</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Different content types require different params, and some (like CSV) just do not fit</li>
  <li class="calibre14">Forces API consumers to do weird stuff to keep links up-to-date when the param is in the query string</li>
</ul>

<h4 id="calibre_link-185" class="calibre4">Approach #4: Custom Request Header</h4>

<p class="calibre3">So if the URL and the HTTP body is a bad place to put API version information, where else is left? Well, 
headers of course!</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">GET</code> <code class="o">/</code><code class="calibre15">places</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code>
<code class="lineno">2</code> <code class="nl">Host:</code> <code class="calibre15">api</code><code class="calibre15">.</code><code class="calibre15">example</code><code class="calibre15">.</code><code class="calibre15">com</code>
<code class="lineno">3</code> <code class="nl">BadApiVersion:</code> <code class="o">1.0</code>
</pre></div>

</figure>

<p class="calibre3">This example was lifted from <a href="http://www.mnot.net/">Mark Nottingham</a>, who is the chair of the <a href="http://trac.tools.ietf.org/wg/httpbis/trac/wiki">IEFT HTTPbis Working Group</a> at the time of writing. That group is in charge of revising HTTP 1.1 and working on HTTP 2.0. He has this to say about custom version headers:</p>

<blockquote class="calibre17">
  <p class="calibre3">This is broken and wrong for a whole mess of reasons. Why?</p>

  <p class="calibre3">First, because the server’s response depends on the version in the request header, it means that the response really needs to be:</p>

  <figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">HTTP</code><code class="o">/</code><code class="o">1.1</code> <code class="o">200</code> <code class="calibre15">OK</code>  
<code class="lineno">2</code> <code class="nl">BadAPIVersion:</code> <code class="o">1.1</code>  
<code class="lineno">3</code> <code class="nl">Vary:</code> <code class="calibre15">BadAPIVersion</code>  
</pre></div>

  </figure>
  <p class="calibre3">Otherwise, intervening caches can give clients the wrong response (e.g. a 1.2 response to a 1.1 client, or vice versa).<br class="calibre6" />
&ndash; <strong class="calibre22">Source:</strong> <a href="http://www.mnot.net/blog/2012/07/11/header_versioning">Mark Nottingham, “Bad HTTP API Smells: Version Headers”</a></p>
</blockquote>

<p class="calibre3">Without specifying the <code class="calibre15">Vary</code> header, it is hard for a cache system like Varnish to know that somebody
is asking for 1.0 because the URL is not any different than somebody asking for 1.1 or 2.0. That can be a big problem as
API consumers asking for a specific version need to get that version, not a different one.</p>

<p class="calibre3">Beyond that rather tricky caching issue, it is generally just annoying. If you use a custom header, then
API consumers need to go and look at your documentation to remember which it is. Maybe it is <code class="calibre15">API-Version</code>
or <code class="calibre15">Foursquare-Version</code> or <code class="calibre15">X-Api-Version</code> or <code class="calibre15">Dave</code>. Who knows, and who can remember?</p>

<p class="calibre3">
  <strong class="calibre22">Popular APIs</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Azure</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Pros</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Simple for API consumers (if they know about headers)</li>
  <li class="calibre14">Keeps URLs the same</li>
  <li class="calibre14">Technically a bit more RESTful than putting version in the URI</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Cons</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Cache systems can get confused</li>
  <li class="calibre14">API developers can get confused (if they do not know about headers)</li>
</ul>

<h4 id="calibre_link-186" class="calibre4">Approach #5: Content Negotiation</h4>

<p class="calibre3">The <code class="calibre15">Accept</code> header is designed to ask the server to respond with a specific resource in a different format.
Traditionally, many developers think of this in terms of only (X)HTML, JSON, Images, etc., but it can be more
generic than that. If we can RESTfully ask for our data to come back with different content types having
different syntax, then why not reuse exactly the same header for versions too.</p>

<p class="calibre3">GitHub follows the advice of many of the people named in this chapter so far, and uses the <code class="calibre15">Accept</code> header to
return different Media Types.</p>

<blockquote class="calibre17">
  <p class="calibre3">All GitHub media types look like this:</p>

  <p class="calibre3"><code class="calibre15">application/vnd.github[.version].param[+json]</code></p>

  <p class="calibre3">The most basic media types the API supports are:</p>

  <p class="calibre3"><code class="calibre15">application/json</code><br class="calibre6" />
<code class="calibre15">application/vnd.github+json</code>  </p>

  <p class="calibre3">&ndash; <strong class="calibre22">Source:</strong> <a href="https://developer.github.com/v3/media/">GitHub, “Media Types”</a></p>
</blockquote>

<p class="calibre3">Basically if you ask for either of the following two MIME types, the result will be returned as JSON:</p>

<ul class="calibre18">
  <li class="calibre14"><code class="calibre15">application/json</code></li>
  <li class="calibre14"><code class="calibre15">application/vnd.github+json</code></li>
</ul>

<p class="calibre3">Without specifying further, they will show you the current default response, which at the time of writing is v3 but could at any time change to v4. They warn that if you do not specify the version then your apps
will break; fair enough.</p>

<p class="calibre3">To specify the version, you must use the following:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">Accept</code><code class="o">:</code> <code class="calibre15">application</code><code class="o">/</code><code class="calibre15">vnd</code><code class="o">.</code><code class="na">github</code><code class="o">.</code><code class="na">v3</code><code class="o">+</code><code class="calibre15">json</code>
</pre></div>

</figure>

<p class="calibre3">If the default switches to v4 at some point in the future, your application will continue to use v3.</p>

<p class="calibre3">This solves the caching problem, solves the URL manipulation problems of the URL-based versioning approaches, and
is considered rather RESTful, but it can confuse some developers. You could train them to get used to it, or perhaps stick with URL-based versioning, but it is semantically more correct and generally works very well. This was done at Kapture for the internal API and it worked without problems.</p>

<p class="calibre3">The only downside is one that is found with all the approaches mentioned so far: if you version
the entire API as a whole, it becomes very hard for API developers to upgrade their applications. It could
be that only 10% of the API has changed between versions, but changing the version of the entire API
can scare developers. Even with a changelog, it is hard for the developer to know if their entire 
application is going to break completely when they switch over. Even an extensive test suite is not going to 
catch every issue with a third party service like this, because most developers use hardcoded JSON responses 
in their unit tests to mock interactions. </p>

<p class="calibre3">If changing the version of the whole API is too much, the only other option is to version parts of the API.</p>

<p class="calibre3">
  <strong class="calibre22">Popular APIs</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">GitHub</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Pros</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">Simple for API consumers (if they know about headers)</li>
  <li class="calibre14">Keeps URLs the same</li>
  <li class="calibre14">HATEOAS-friendly</li>
  <li class="calibre14">Cache-friendly</li>
  <li class="calibre14">Sturgeon-approved</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Cons</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">API developers can get confused (if they do not know about headers)</li>
  <li class="calibre14">Versioning the WHOLE thing can confuse users (but this is the same with all previous approaches)</li>
</ul>

<h4 id="calibre_link-187" class="calibre4">Approach #6: Content Negotiation for Resources</h4>

<p class="calibre3">Generally accepted to be the proper HATEOAS approach, content negotiation for specific resources using
media types is one of the most complex solutions, but is a very scalable way to approach things. It solves
the all-or-nothing approach of versioning the entire API, but still lets breaking changes be made to the API
in a manageable way.</p>

<p class="calibre3">Basically, if GitHub were to do this, they would take their current media-type and add an extra item:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">Accept</code><code class="o">:</code> <code class="calibre15">application</code><code class="o">/</code><code class="calibre15">vnd</code><code class="o">.</code><code class="na">github</code><code class="o">.</code><code class="na">user</code><code class="o">.</code><code class="na">v4</code><code class="o">+</code><code class="calibre15">json</code>
</pre></div>

</figure>

<p class="calibre3">Alternatively, the <code class="calibre15">Accept</code> header is capable of containing arbitrary parameters.</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="calibre15">Accept</code><code class="o">:</code> <code class="calibre15">application</code><code class="o">/</code><code class="calibre15">vnd</code><code class="o">.</code><code class="na">github</code><code class="o">.</code><code class="na">user</code><code class="o">+</code><code class="calibre15">json</code><code class="o">;</code> <code class="calibre15">version</code><code class="o">=</code><code class="o">4.0</code>
</pre></div>

</figure>

<p class="calibre3">This was suggested by <a href="http://about.avdi.org/">Avdi Grimm</a> and written about in an article by <a href="http://blog.steveklabnik.com/">Steve Klabnik</a> called 
<a href="http://blog.steveklabnik.com/posts/2011-07-03-nobody-understands-rest-or-http#i_want_my_api_to_be_versioned">“Nobody Understands REST or HTTP”</a>. That whole article, written in 2011, is a great rant containing 
lots of useful advice. Again, most API developers seem to have ignored the advice or have simply not
known about it.</p>

<p class="calibre3">Picking between those two specific formats will no doubt have pros and cons. Apparently, Rails is not
able to pick up the latter (or at least could not in 2011), but that should not be considered much of 
a reason.</p>

<p class="calibre3">The other argument for using the latter media type is that arbitrary parameter names can have the same
confusion as arbitrary version header names, but developers can all just agree to just call it “version”. 
Right?</p>

<p class="calibre3">Whichever way you end up specifying the header, the advantage is not just specifying “I want the v4 API” 
but instead saying “I would like the v4 version of a place(s)”. Services that provide an API can email
their API consumers saying “We are updating the way ‘places’ work. Here is an example of the resource, 
here is what you need to change; specify the new version when you are ready”. </p>

<p class="calibre3">Partial updates like this ease third party efforts to upgrade applications, and the chances of leaving 
developers stranded on an older version becomes far less likely.</p>

<p class="calibre3">
  <strong class="calibre22">Popular APIs</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">GitHub</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Pros</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">HATEOAS-friendly</li>
  <li class="calibre14">Cache-friendly</li>
  <li class="calibre14">Keeps URLs the same</li>
  <li class="calibre14">Easier upgrades for API consumers</li>
  <li class="calibre14">Can be one code base or multiple</li>
</ul>

<p class="calibre3">
  <strong class="calibre22">Cons</strong>
</p>

<ul class="calibre18">
  <li class="calibre14">API consumers need to pay attention to versions</li>
  <li class="calibre14">Splitting across multiple code bases is not impossible, but it is hard</li>
  <li class="calibre14">Putting it in the same code base leads to accidental breakage, if transformers are not versioned</li>
</ul>

<h4 id="calibre_link-188" class="calibre4">Approach #7: Feature Flagging</h4>

<p class="calibre3">This approach is something that so far I have only seen done by Facebook and its Graph API. Their approach
is interesting, but not as common as some of these other approaches.</p>

<p class="calibre3">Facebook do not version their entire API with simple numbers like anybody else does. They do not
version their resources, and they do not allow you to request different versions with headers, parameters or
anything else.</p>

<p class="calibre3">They essentially make a custom version for each single client application. The way this works is there are various feature flags, which they call “migrations”. They put out a migration every few months, write a blog,
email API developers about it, and ask those developers to log into the developer area on the Facebook platform to manage their application.</p>

<p class="calibre3">Basically, they warn you that things are going to break in a few months. They list all the changes and give
you the chance to see if this will affect your application. If your application does not use an endpoint that is 
being changed, or they are removing a field your application does not use, then you can click “Enable” for 
the migration. From that point on, any interaction your application has with the Facebook Graph API will use 
the new format.</p>

<p class="calibre3">If you wait, eventually they will flip that switch regardless. This is considered a fair warning, and means 
they do not have to support an old version for years. Facebook simply maintain one version with a few feature 
flags and those flags exist for a few months before that old code is removed. If your application still uses 
the old format then it is just tough.</p>

<p class="calibre3">To me, this system has the most benefits. One tricky part is that getting the timing right for the 
changeover is hard on API consumers. If your code is live looking at the old style, then you cannot push new code for the new style, because it will be broken until you flip the switch. That might only be seconds, but if you have multiple applications then you have to update and deploy all of them within minutes (or seconds) and then flip the switch.</p>

<p class="calibre3">Realistically speaking, that is very hard to do, so you will end up with code having a lot of if statements
ready to look for fields that may or may not be there depending on the version. That leads to lots of extra
code which you have to remember to remove afterwards by shoving comment blocks throughout your code:</p>

<figure class="code">
<div class="highlight"><pre class="calibre16"><code class="lineno">1</code> <code class="c"># @TODO Kill this when Facebook September 13 Migration is confirmed working</code>
</pre></div>

</figure>

<p class="calibre3">This is not insanely hard, but it can be complicated sometimes.</p>

<p class="calibre3">Generally speaking, the Feature Flag solution is the easiest for API consumers if the changes happen to hit a part of the API they do not care about. They do not need to be scared of changing to an entirely new version of the API, they know their code will work, and things seem safer. If they <em class="calibre19">do</em> require changes then… well a few if statements never really hurt anyone.</p>

<h3 id="calibre_link-81" class="calibre2">
<span class="section-number">13.3 </span>Ask Your Users</h3>

<p class="calibre3">None of these will have a drastic impact on your business, especially if your API is internal. If you are
creating a platform as big as Facebook, then maybe you need a solution as complex as theirs, but that is
probably not the case.</p>

<p class="calibre3">My advice with versioning (as with most aspects of your API) is to know your audience. Twitter gets away
with flagrant disregard for almost every single concept or principle that ever makes something RESTful whilst still calling it a REST API, so you can probably break a few rules too.</p>

<blockquote class="calibre17">
  <p class="calibre3">If I may leave others considering how to version their APIs with a final thought: nobody will use your API until you’ve built it. Stop procrastinating. None of these are “bad” in any tangible sense, they’re just different.  </p>

  <p class="calibre3">They are all easily consumable, they all return the same result and none of them are likely to have any real impact on the success of your project.  </p>

  <p class="calibre3">&ndash; <strong class="calibre22">Source:</strong> <a href="http://www.troyhunt.com/2014/02/your-api-versioning-is-wrong-which-is.html">Troy Hunt, “Your API versioning is wrong, which is why I decided to do it 3 different 
wrong ways”</a></p>
</blockquote>

<p class="calibre3">The real truth is that all of the approaches are annoying in some ways, or technically ‘unRESTful’ in
some respects, or difficult, or a combination of it all. You have to pick what is realistic for your project
in both the difficulty of the implementation and the skill/knowledge level of your target audience.</p>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-96">
<div class="calibre6">
<h2 id="calibre_link-82" class="calibre1">Conclusion</h2>

<p class="calibre3">Thank you for reading the whole way through this book. This was a large and complex topic I
tried to turn into an interesting read with a little humour. </p>

<p class="calibre3">It has been a really enjoyable experience, and I have been blown away with the positive feedback.
I have also received plenty of constructive criticism, which was mostly begging me to hire 
an editor. The PHP Editor at SitePoint gave the book a 4/5 star rating, saying: </p>

<blockquote class="calibre17">
  <p class="calibre3">The one downside is that Phil can’t spell to save his life. </p>
</blockquote>

<p class="calibre3">This is true. I’ve been writing blogs for years, and that has not helped me. This experience very 
much has. I hired a good friend of mine as an editor and she has done an amazing job.</p>

<p class="calibre3">Now that this book is in paperback form as well as eBook, I do plan to change it less. I do,
however, have some ideas for a second edition which may be released in early 2016.</p>

<p class="calibre3">A dilemma I am currently having is that any further explanation of RESTful / Hypermedia API development is 
just going to be paraphrasing content in the various HTTP 1.1 Specification RFCs. Hypermedia APIs respect
as many aspects of the HTTP spec as possible, so headers like <code class="calibre15">Accept-Language</code>, <code class="calibre15">Expires</code>, <code class="calibre15">Etag</code>,
<code class="calibre15">Retry-After</code>, etc., could be catered for. A whole book could be written about the HTTP specification itself,
so it seems somewhat outside the scope of this book, but it has been commonly requested.</p>

<p class="calibre3">No matter what happens next with this book, this has been a great project. Not only was it a much needed
break from writing code nonstop 24/7, but it has ended up helping me out substantially with my US visa!
It has also helped me out a few times, when I forgot how something worked and looked back in here. </p>

<p class="calibre3">If this book has helped you out, please pass it on. Hand the paperback to somebody, or give them a link
to apisyouwonthate.com, and help me continue to update the project. Part of the joys of this project are
the extra income of course, but I really enjoy helping to educate people. </p>

<p class="calibre3">I am always happy to hand out coupon codes for people who want to give away cheap copies of the eBook at 
their usergroups, conferences, etc, so find me on twitter for that: @philsturgeon.</p>

<p class="calibre3">Thanks again for reading!</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-101">
<div class="calibre6">
<h2 id="calibre_link-83" class="calibre1">Further Reading</h2>

<p class="calibre3">Here are some resources you should look into reading.</p>

<h3 id="calibre_link-84" class="calibre2">API Web Resources</h3>

<p class="calibre3"><em class="calibre19"><a href="https://github.com/interagent/http-api-design">Interagent: HTTP API Design</a></em> - HTTP API design guide extracted from work on the Heroku Platform API. They have some good tips for making a HTTP API. I don’t agree with all of it entirely, but a lot of it it. Either way it gives you a lot of things to think about.</p>

<p class="calibre3"><em class="calibre19"><a href="http://nordicapis.com/">Nordic APIs</a></em> - Online API advice, with articles about new technologies in the world of APIs, opinion pieces and the occasional article about why SOAP is great sometimes.</p>

<h3 id="calibre_link-85" class="calibre2">Non-API Books</h3>

<p class="calibre3">While these books are not directly about API development, they are about related subjects. APIs must be secure. APIs need 
to be tested. APIs need virtual machines to run on locally, servers to live on in production, and that all needs to be provisioned using fancy devops tooling.</p>

<p class="calibre3"><em class="calibre19"><a href="https://leanpub.com/buildingsecurephpapps">Building Secure PHP Apps</a></em> - Is your PHP app truly secure? Let’s make sure you get home on time and sleep 
well at night.</p>

<p class="calibre3"><em class="calibre19"><a href="https://leanpub.com/grumpy-phpunit">The Grumpy Programmer’s PHPUnit Cookbook</a></em> - Learning how to use PHPUnit doesn’t have to suck. Your code is 
untested and fixing bugs is tedious. You know you need something better, but time just doesn’t seem to be on 
your side. Making things “right” is costly and you need to deliver working code NOW.</p>

<p class="calibre3"><em class="calibre19"><a href="https://leanpub.com/scalingphp">Scaling PHP Apps</a></em> - Steve Corona’s book about scaling not just PHP, but Nginx and various data stores helped 
me out a lot over the course of the Kapture API development.</p>

<p class="calibre3"><em class="calibre19"><a href="https://serversforhackers.com/">Servers for Hackers</a></em> - Your API has to go somewhere, and unless you’re literally made of money, and have some way to get that money through Heroku’s payment gateway, then you need to know how to manage a server.</p>

<p class="calibre3"><em class="calibre19"><a href="https://leanpub.com/vagrantcookbook">Vagrant Cookbook</a></em> - Learn how to create effective Vagrant development environments. This book will cover
from basic to advanced concepts on Vagrant, including important ProTips to improve your Vagrant projects and
avoid common mistakes. The book was updated to cover the new features on Vagrant 1.5, which are substantial
compared to previous versions.</p>


</div>
</div>


</body></html>